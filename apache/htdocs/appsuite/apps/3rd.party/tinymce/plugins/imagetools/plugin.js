!function(t){"use strict";function e(e,n){return r(t.document.createElement("canvas"),e,n)}function n(t){return t.getContext("2d")}function r(t,e,n){return t.width=e,t.height=n,t}function o(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=e.concat(n);return t.apply(null,o)}}function i(t,e){return new(nt.getOrDie("Blob"))(t,e)}function a(){return new(nt.getOrDie("FileReader"))}function u(t){return new(nt.getOrDie("Uint8Array"))(t)}function c(e){return new V(function(n,r){function o(){c(),n(u)}function i(){c(),r("Unable to load data of type "+e.type+": "+a)}var a=t.URL.createObjectURL(e),u=new t.Image,c=function(){u.removeEventListener("load",o),u.removeEventListener("error",i)};u.addEventListener("load",o),u.addEventListener("error",i),u.src=a,u.complete&&o()})}function l(e){return new V(function(n,r){var o=new t.XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200==this.status&&n(this.response)},o.onerror=function(){var t=this;r(0===this.status?function(){var t=new Error("No access to download image");return t.code=18,t.name="SecurityError",t}():new Error("Error "+t.status+" downloading image"))},o.send()})}function s(t){var e=t.split(","),n=/data:([^;]+)/.exec(e[0]);if(!n)return K.none();for(var r=n[1],o=e[1],a=rt.atob(o),c=a.length,l=Math.ceil(c/1024),s=new Array(l),f=0;f<l;++f){for(var d=1024*f,h=Math.min(d+1024,c),p=new Array(h-d),g=d,m=0;g<h;++m,++g)p[m]=a[g].charCodeAt(0);s[f]=u(p)}return K.some(i(s,{type:r}))}function f(t){return new V(function(e,n){s(t).fold(function(){n("uri is not base64: "+t)},e)})}function d(t){return new V(function(e){var n=a();n.onloadend=function(){e(n.result)},n.readAsDataURL(t)})}function h(e){t.URL.revokeObjectURL(e.src)}function p(t,e,n){function r(e,n){return t.then(function(t){return ot.canvasToDataURL(t,e,n)})}var o=e.type;return{getType:W(o),toBlob:function(){return V.resolve(e)},toDataURL:function(){return n},toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return ot.canvasToBlob(t,e,n)})},toAdjustedDataURL:r,toAdjustedBase64:function(t,e){return r(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(G.clone)}}}function g(t){return ot.blobToDataUri(t).then(function(e){return p(ot.blobToCanvas(t),t,e)})}function m(t,e,n){return(t=parseFloat(t))>n?t=n:t<e&&(t=e),t}function y(t,e){var n,r,o,i,a=[],u=new Array(10);for(n=0;n<5;n++){for(r=0;r<5;r++)a[r]=e[r+5*n];for(r=0;r<5;r++){for(i=0,o=0;o<5;o++)i+=t[r+5*o]*a[o];u[r+5*n]=i}}return u}function v(t,e){return e=m(e,0,1),t.map(function(t,n){return n%6==0?t=1-(1-t)*e:t*=e,m(t,0,1)})}function b(t,e){return t.toCanvas().then(function(n){return w(n,t.getType(),e)})}function w(t,e,n){var r,o=G.get2dContext(t);return r=function(t,e){var n,r,o,i,a,u=t.data,c=e[0],l=e[1],s=e[2],f=e[3],d=e[4],h=e[5],p=e[6],g=e[7],m=e[8],y=e[9],v=e[10],b=e[11],w=e[12],x=e[13],I=e[14],T=e[15],R=e[16],S=e[17],E=e[18],F=e[19];for(a=0;a<u.length;a+=4)n=u[a],r=u[a+1],o=u[a+2],i=u[a+3],u[a]=n*c+r*l+o*s+i*f+d,u[a+1]=n*h+r*p+o*g+i*m+y,u[a+2]=n*v+r*b+o*w+i*x+I,u[a+3]=n*T+r*R+o*S+i*E+F;return t}(o.getImageData(0,0,t.width,t.height),n),o.putImageData(r,0,0),at.fromCanvas(t,e)}function x(t,e){return t.toCanvas().then(function(n){return I(n,t.getType(),e)})}function I(t,e,n){var r,o,i=G.get2dContext(t);return r=i.getImageData(0,0,t.width,t.height),o=i.getImageData(0,0,t.width,t.height),o=function(t,e,n){function r(t,e,n){return t>n?t=n:t<e&&(t=e),t}var o,i,a,u,c,l,s,f,d,h,p,g,m,y,v,b;for(a=Math.round(Math.sqrt(n.length)),u=Math.floor(a/2),o=t.data,i=e.data,v=t.width,b=t.height,l=0;l<b;l++)for(c=0;c<v;c++){for(s=f=d=0,p=0;p<a;p++)for(h=0;h<a;h++)g=r(c+h-u,0,v-1),m=4*(r(l+p-u,0,b-1)*v+g),y=n[p*a+h],s+=o[m]*y,f+=o[m+1]*y,d+=o[m+2]*y;i[m=4*(l*v+c)]=r(s,0,255),i[m+1]=r(f,0,255),i[m+2]=r(d,0,255)}return e}(r,o,n),i.putImageData(o,0,0),at.fromCanvas(t,e)}function T(t){var e=function(e,n,r){var o,i,a=G.get2dContext(e),u=new Array(256);for(i=0;i<u.length;i++)u[i]=t(i,r);return o=function(t,e){var n,r=t.data;for(n=0;n<r.length;n+=4)r[n]=e[r[n]],r[n+1]=e[r[n+1]],r[n+2]=e[r[n+2]];return t}(a.getImageData(0,0,e.width,e.height),u),a.putImageData(o,0,0),at.fromCanvas(e,n)};return function(t,n){return t.toCanvas().then(function(r){return e(r,t.getType(),n)})}}function R(t){return function(e,n){return b(e,t(ct.identity(),n))}}function S(t){return function(e){return x(e,t)}}function E(t,e,n){var r=z.getWidth(t),o=z.getHeight(t),i=e/r,a=n/o,u=!1;(i<.5||i>2)&&(i=i<.5?.5:2,u=!0),(a<.5||a>2)&&(a=a<.5?.5:2,u=!0);var c=F(t,i,a);return u?c.then(function(t){return E(t,e,n)}):c}function F(t,e,n){return new V(function(r){var o=z.getWidth(t),i=z.getHeight(t),a=Math.floor(o*e),u=Math.floor(i*n),c=G.create(a,u);G.get2dContext(c).drawImage(t,0,0,o,i,0,0,a,u),r(c)})}function D(t,e,n){var r=G.create(t.width,t.height),o=G.get2dContext(r),i=0,a=0;return 90!=(n=n<0?360+n:n)&&270!=n||G.resize(r,r.height,r.width),90!=n&&180!=n||(i=r.width),270!=n&&180!=n||(a=r.height),o.translate(i,a),o.rotate(n*Math.PI/180),o.drawImage(t,0,0),at.fromCanvas(r,e)}function O(t,e,n){var r=G.create(t.width,t.height),o=G.get2dContext(r);return"v"==n?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0)),at.fromCanvas(r,e)}function C(t,e,n,r,o,i){var a=G.create(o,i);return G.get2dContext(a).drawImage(t,-n,-r),at.fromCanvas(a,e)}function A(){function t(){return r>0}function e(){return-1!==r&&r<n.length-1}var n=[],r=-1;return{data:n,add:function(t){var e;return e=n.splice(++r),n.push(t),{state:t,removed:e}},undo:function(){if(t())return n[--r]},redo:function(){if(e())return n[++r]},canUndo:t,canRedo:e}}function _(t,e,n,r,o){function i(t,e){return{x:e.x+t.x,y:e.y+t.y,w:e.w,h:e.h}}function a(t,e){return{x:e.x-t.x,y:e.y-t.y,w:e.w,h:e.h}}function u(e,r,o,i){var u,c,l,d,h;u=r.x,c=r.y,l=r.w,d=r.h,u+=o*e.deltaX,c+=i*e.deltaY,l+=o*e.deltaW,d+=i*e.deltaH,l<20&&(l=20),d<20&&(d=20),h=t=Ut.clamp({x:u,y:c,w:l,h:d},n,"move"===e.name),h=a(n,h),f.fire("updateRect",{rect:h}),s(h)}function c(t){function n(t,e){e.h<0&&(e.h=0),e.w<0&&(e.w=0),Mt("#"+m+"-"+t,r).css({left:e.x,top:e.y,width:e.w,height:e.h})}j.each(d,function(e){Mt("#"+m+"-"+e.name,r).css({left:t.w*e.xMul+t.x,top:t.h*e.yMul+t.y})}),n("top",{x:e.x,y:e.y,w:e.w,h:t.y-e.y}),n("right",{x:t.x+t.w,y:t.y,w:e.w-t.x-t.w+e.x,h:t.h}),n("bottom",{x:e.x,y:t.y+t.h,w:e.w,h:e.h-t.y-t.h+e.y}),n("left",{x:e.x,y:t.y,w:t.x-e.x,h:t.h}),n("move",t)}function l(e){c(t=e)}function s(t){l(i(n,t))}var f,d,h,p,g="mce-",m=g+"crid-"+jt++;return d=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],p=["top","right","bottom","left"],function(){Mt('<div id="'+m+'" class="'+g+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(r),j.each(p,function(t){Mt("#"+m,r).append('<div id="'+m+"-"+t+'"class="'+g+'croprect-block" style="display: none" data-mce-bogus="all">')}),j.each(d,function(t){Mt("#"+m,r).append('<div id="'+m+"-"+t.name+'" class="'+g+"croprect-handle "+g+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')}),h=j.map(d,function(e){var n;return new(Lt.get("DragHelper"))(m,{document:r.ownerDocument,handle:m+"-"+e.name,start:function(){n=t},drag:function(t){u(e,n,t.deltaX,t.deltaY)}})}),c(t),Mt(r).on("focusin focusout",function(t){Mt(t.target).attr("aria-grabbed","focus"===t.type)}),Mt(r).on("keydown",function(e){function n(t,e,n,o,i){t.stopPropagation(),t.preventDefault(),u(r,n,o,i)}var r;switch(j.each(d,function(t){if(e.target.id===m+"-"+t.name)return r=t,!1}),e.keyCode){case Nt.LEFT:n(e,0,t,-10,0);break;case Nt.RIGHT:n(e,0,t,10,0);break;case Nt.UP:n(e,0,t,0,-10);break;case Nt.DOWN:n(e,0,t,0,10);break;case Nt.ENTER:case Nt.SPACEBAR:e.preventDefault(),o()}})}(),f=j.extend({toggleVisibility:function(t){var e;e=j.map(d,function(t){return"#"+m+"-"+t.name}).concat(j.map(p,function(t){return"#"+m+"-"+t})).join(","),t?Mt(e,r).show():Mt(e,r).hide()},setClampRect:function(e){n=e,c(t)},setRect:l,getInnerRect:function(){return a(n,t)},setInnerRect:s,setViewPortRect:function(n){e=n,c(t)},destroy:function(){j.each(h,function(t){t.destroy()}),h=[]}},Pt)}function k(t){return{blob:t,url:Tt.createObjectURL(t)}}function B(t){t&&Tt.revokeObjectURL(t.url)}function L(t){j.each(t,B)}function U(t,e,n,r){function o(t){var e,n,r,o;e=w.find("#w")[0],n=w.find("#h")[0],r=parseInt(e.value(),10),o=parseInt(n.value(),10),w.find("#constrain")[0].checked()&&X&&$&&r&&o&&("w"===t.control.settings.name?(o=Math.round(r*J),n.value(o)):(r=Math.round(o*K),e.value(r))),X=r,$=o}function i(t){return Math.round(100*t)+"%"}function a(){w.find("#undo").disabled(!Z.canUndo()),w.find("#redo").disabled(!Z.canRedo()),w.statusbar.find("#save").disabled(!Z.canUndo())}function u(){w.find("#undo").disabled(!0),w.find("#redo").disabled(!0)}function c(t){t&&F.imageSrc(t.url)}function l(t){return function(){var e=j.grep(Y,function(e){return e.settings.name!==t});j.each(e,function(t){t.hide()}),t.show(),t.focus()}}function s(t){c(T=k(t))}function f(t){c(e=k(t)),L(Z.add(e).removed),a()}function d(){var t=F.selection();xt.blobToImageResult(e.blob).then(function(e){bt.crop(e,t.x,t.y,t.w,t.h).then(et).then(function(t){f(t),p()})})}function h(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=[].slice.call(arguments,1);return function(){xt.blobToImageResult(e.blob).then(function(e){t.apply(this,[e].concat(o)).then(et).then(f)})}}function p(){c(e),B(T),l(x)(),a()}function g(e,n){T?n():setTimeout(function(){e-- >0?g(e,n):t.windowManager.alert("Error: failed to apply image operation.")},10)}function m(){T?(f(T.blob),p()):g(100,m)}function y(t){return Lt.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:t})}function v(t,n){return y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:m}])).hide().on("show",function(){u(),xt.blobToImageResult(e.blob).then(function(t){return n(t)}).then(et).then(function(t){var e=k(t);c(e),B(T),T=e})})}function b(n,r,o,a,l){function s(t){xt.blobToImageResult(e.blob).then(function(e){return r(e,t)}).then(et).then(function(t){var e=k(t);c(e),B(T),T=e})}return y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(t){s(t.value)},minValue:t.rtl?l:a,maxValue:t.rtl?a:l,value:o,previewFilter:i},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:m}])).hide().on("show",function(){this.find("slider").value(o),u()})}var w,x,I,T,R,S,E,F,D,O,C,_,U,H,M,P,N,G,z,V,W,q,Y,X,$,J,K,Z=A(),Q=function(e){return t.rtl?e.reverse():e},tt=function(t){var n=[].slice.call(arguments,1);return function(){var r=T||e;xt.blobToImageResult(r.blob).then(function(e){t.apply(this,[e].concat(n)).then(et).then(s)})}},et=function(t){return t.toBlob()};R=y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:d}])).hide().on("show hide",function(t){F.toggleCropRect("show"===t.type)}).on("show",u),S=y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:o},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:o},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(t){!0===t.control.value()&&(J=$/X,K=X/$)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(t){var e=parseInt(w.find("#w").value(),10),n=parseInt(w.find("#h").value(),10);t.preventDefault(),h(bt.resize,e,n)(),p()}).on("show",u),E=y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:tt(bt.flip,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:tt(bt.flip,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:tt(bt.rotate,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:tt(bt.rotate,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:m}])).hide().on("show",u),C=v(0,bt.invert),z=v(0,bt.sharpen),V=v(0,bt.emboss),_=b(0,bt.brightness,0,-1,1),U=b(0,bt.hue,180,0,360),H=b(0,bt.saturate,0,-1,1),M=b(0,bt.contrast,0,-1,1),P=b(0,bt.grayscale,0,0,1),N=b(0,bt.sepia,0,0,1),G=function(n,r){function o(){var t,n,o;t=w.find("#r")[0].value(),n=w.find("#g")[0].value(),o=w.find("#b")[0].value(),xt.blobToImageResult(e.blob).then(function(e){return r(e,t,n,o)}).then(et).then(function(t){var e=k(t);c(e),B(T),T=e})}var a=t.rtl?2:0,l=t.rtl?0:2;return y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:a,value:1,maxValue:l,ondragend:o,previewFilter:i},{type:"slider",label:"G",name:"g",minValue:a,value:1,maxValue:l,ondragend:o,previewFilter:i},{type:"slider",label:"B",name:"b",minValue:a,value:1,maxValue:l,ondragend:o,previewFilter:i},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:m}])).hide().on("show",function(){w.find("#r,#g,#b").value(1),u()})}(0,bt.colorize),W=b(0,bt.gamma,0,-1,1),q=b(0,bt.exposure,1,0,2),I=y(Q([{text:"Back",onclick:p},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:l(U)},{text:"saturate",icon:"saturate",onclick:l(H)},{text:"sepia",icon:"sepia",onclick:l(N)},{text:"emboss",icon:"emboss",onclick:l(V)},{text:"exposure",icon:"exposure",onclick:l(q)},{type:"spacer",flex:1}])).hide(),x=y(Q([{tooltip:"Crop",icon:"crop",onclick:l(R)},{tooltip:"Resize",icon:"resize2",onclick:l(S)},{tooltip:"Orientation",icon:"orientation",onclick:l(E)},{tooltip:"Brightness",icon:"sun",onclick:l(_)},{tooltip:"Sharpen",icon:"sharpen",onclick:l(z)},{tooltip:"Contrast",icon:"contrast",onclick:l(M)},{tooltip:"Color levels",icon:"drop",onclick:l(G)},{tooltip:"Gamma",icon:"gamma",onclick:l(W)},{tooltip:"Invert",icon:"invert",onclick:l(C)}])),F=Gt.create({flex:1,imageSrc:e.url}),D=Lt.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){c(e=Z.undo()),a()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){c(e=Z.redo()),a()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var t=F.zoom();t<2&&(t+=.1),F.zoom(t)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var t=F.zoom();t>.1&&(t-=.1),F.zoom(t)}}]}),O=Lt.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:Q([D,F])}),Y=[x,R,S,E,I,C,_,U,H,M,P,N,G,z,V,W,q],(w=t.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(Bt.DOM.getViewPort().w,800),minHeight:Math.min(Bt.DOM.getViewPort().h,650),title:"Edit image",items:Y.concat([O]),buttons:Q([{text:"Save",name:"save",subtype:"primary",onclick:function(){n(e.blob),w.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){r(),L(Z.data),Z=null,T=null}),Z.add(e),a(),F.on("load",function(){X=F.imageSize().w,$=F.imageSize().h,J=$/X,K=X/$,w.find("#w").value(X),w.find("#h").value($)}),F.on("crop",d)}function H(){return new(nt.getOrDie("XMLHttpRequest"))}function M(t,e){return Jt.requestUrlAsBlob(t,{},e).then(function(t){return t.status<200||t.status>=300?ie.handleHttpError(t.status):St.resolve(t.blob)})}var P=function(t){var e=t,n=function(){return e};return{get:n,set:function(t){e=t},clone:function(){return P(n())}}},N=tinymce.util.Tools.resolve("tinymce.PluginManager"),j=tinymce.util.Tools.resolve("tinymce.util.Tools"),G={create:e,clone:function(t){var r;return r=e(t.width,t.height),n(r).drawImage(t,0,0),r},resize:r,get2dContext:n,get3dContext:function(t){var e=null;try{e=t.getContext("webgl")||t.getContext("experimental-webgl")}catch(t){}return e||(e=null),e}},z={getWidth:function(t){return t.naturalWidth||t.width},getHeight:function(t){return t.naturalHeight||t.height}},V=window.Promise?window.Promise:function(){function e(t,e){return function(){t.apply(e,arguments)}}function n(t){var e=this;null!==this._state?l(function(){var n=e._state?t.onFulfilled:t.onRejected;if(null!==n){var r;try{r=n(e._value)}catch(e){return void t.reject(e)}t.resolve(r)}else(e._state?t.resolve:t.reject)(e._value)}):this._deferreds.push(t)}function r(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void u(e(n,t),e(r,this),e(o,this))}this._state=!0,this._value=t,i.call(this)}catch(t){o.call(this,t)}}function o(t){this._state=!1,this._value=t,i.call(this)}function i(){for(var t=0,e=this._deferreds.length;t<e;t++)n.call(this,this._deferreds[t]);this._deferreds=null}function a(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function u(t,e,n){var r=!1;try{t(function(t){r||(r=!0,e(t))},function(t){r||(r=!0,n(t))})}catch(t){if(r)return;r=!0,n(t)}}var c=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],u(t,e(r,this),e(o,this))},l=c.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(e){t.setTimeout(e,1)},s=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};return c.prototype.catch=function(t){return this.then(null,t)},c.prototype.then=function(t,e){var r=this;return new c(function(o,i){n.call(r,new a(t,e,o,i))})},c.all=function(){var t=Array.prototype.slice.call(1===arguments.length&&s(arguments[0])?arguments[0]:arguments);return new c(function(e,n){function r(i,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var u=a.then;if("function"==typeof u)return void u.call(a,function(t){r(i,t)},n)}t[i]=a,0==--o&&e(t)}catch(t){n(t)}}if(0===t.length)return e([]);for(var o=t.length,i=0;i<t.length;i++)r(i,t[i])})},c.resolve=function(t){return t&&"object"==typeof t&&t.constructor===c?t:new c(function(e){e(t)})},c.reject=function(t){return new c(function(e,n){n(t)})},c.race=function(t){return new c(function(e,n){for(var r=0,o=t.length;r<o;r++)t[r].then(e,n)})},c}(),W=function(t){return function(){return t}},q=W(!1),Y=W(!0),X=function(){return $},$=function(){var t=function(t){return t.isNone()},e=function(t){return t()},n=function(t){return t},r={fold:function(t,e){return t()},is:q,isSome:q,isNone:Y,getOr:n,getOrThunk:e,getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:function(){return null},getOrUndefined:function(){},or:n,orThunk:e,map:X,ap:X,each:function(){},bind:X,flatten:X,exists:q,forall:Y,filter:X,equals:t,equals_:t,toArray:function(){return[]},toString:W("none()")};return Object.freeze&&Object.freeze(r),r}(),J=function(t){var e=function(){return t},n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:Y,isNone:q,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:n,orThunk:n,map:function(e){return J(e(t))},ap:function(e){return e.fold(X,function(e){return J(e(t))})},each:function(e){e(t)},bind:r,flatten:e,exists:r,forall:r,filter:function(e){return e(t)?o:$},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(q,function(e){return n(t,e)})},toArray:function(){return[t]},toString:function(){return"some("+t+")"}};return o},K={some:J,none:X,from:function(t){return null===t||void 0===t?$:J(t)}},Z=void 0!==t.window?t.window:Function("return this;")(),Q=function(t,e){for(var n=void 0!==e&&null!==e?e:Z,r=0;r<t.length&&void 0!==n&&null!==n;++r)n=n[t[r]];return n},tt=function(t,e){var n=t.split(".");return Q(n,e)},et=function(t,e){return tt(t,e)},nt={getOrDie:function(t,e){var n=et(t,e);if(void 0===n||null===n)throw t+" not available on this browser";return n}},rt={atob:function(t){return nt.getOrDie("atob")(t)},requestAnimationFrame:function(t){nt.getOrDie("requestAnimationFrame")(t)}},ot={blobToImage:c,imageToBlob:function(t){var e=t.src;return 0===e.indexOf("data:")?f(e):l(e)},blobToArrayBuffer:function(t){return new V(function(e){var n=a();n.onloadend=function(){e(n.result)},n.readAsArrayBuffer(t)})},blobToDataUri:d,blobToBase64:function(t){return d(t).then(function(t){return t.split(",")[1]})},dataUriToBlobSync:s,canvasToBlob:function(e,n,r){return n=n||"image/png",t.HTMLCanvasElement.prototype.toBlob?new V(function(t){e.toBlob(function(e){t(e)},n,r)}):f(e.toDataURL(n,r))},canvasToDataURL:function(t,e,n){return e=e||"image/png",t.then(function(t){return t.toDataURL(e,n)})},blobToCanvas:function(t){return c(t).then(function(t){h(t);var e;return e=G.create(z.getWidth(t),z.getHeight(t)),G.get2dContext(e).drawImage(t,0,0),e})},uriToBlob:function(t){return 0===t.indexOf("blob:")?l(t):0===t.indexOf("data:")?f(t):null}},it={blobToImage:function(t){return ot.blobToImage(t)},imageToBlob:function(t){return ot.imageToBlob(t)},blobToDataUri:function(t){return ot.blobToDataUri(t)},blobToBase64:function(t){return ot.blobToBase64(t)},dataUriToBlobSync:function(t){return ot.dataUriToBlobSync(t)},uriToBlob:function(t){return K.from(ot.uriToBlob(t))}},at={fromBlob:g,fromCanvas:function(t,e){return ot.canvasToBlob(t,e).then(function(e){return p(V.resolve(t),e,t.toDataURL())})},fromImage:function(t){return ot.imageToBlob(t).then(function(t){return g(t)})},fromBlobAndUrlSync:function(t,e){return p(ot.blobToCanvas(t),t,e)}},ut=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],ct={identity:function(){return[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]},adjust:v,multiply:y,adjustContrast:function(t,e){var n;return e=m(e,-1,1),e*=100,n=e<0?127+e/100*127:127*(n=0==(n=e%1)?ut[e]:ut[Math.floor(e)]*(1-n)+ut[Math.floor(e)+1]*n)+127,y(t,[n/127,0,0,0,.5*(127-n),0,n/127,0,0,.5*(127-n),0,0,n/127,0,.5*(127-n),0,0,0,1,0,0,0,0,0,1])},adjustBrightness:function(t,e){return e=m(255*e,-255,255),y(t,[1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])},adjustSaturation:function(t,e){var n;return e=m(e,-1,1),n=1+(e>0?3*e:e),y(t,[.3086*(1-n)+n,.6094*(1-n),.082*(1-n),0,0,.3086*(1-n),.6094*(1-n)+n,.082*(1-n),0,0,.3086*(1-n),.6094*(1-n),.082*(1-n)+n,0,0,0,0,0,1,0,0,0,0,0,1])},adjustHue:function(t,e){var n,r;return e=m(e,-180,180)/180*Math.PI,n=Math.cos(e),r=Math.sin(e),y(t,[.213+.787*n+-.213*r,.715+-.715*n+-.715*r,.072+-.072*n+.928*r,0,0,.213+-.213*n+.143*r,.715+n*(1-.715)+.14*r,.072+-.072*n+-.283*r,0,0,.213+-.213*n+-.787*r,.715+-.715*n+.715*r,.072+.928*n+.072*r,0,0,0,0,0,1,0,0,0,0,0,1])},adjustColors:function(t,e,n,r){return e=m(e,0,2),n=m(n,0,2),r=m(r,0,2),y(t,[e,0,0,0,0,0,n,0,0,0,0,0,r,0,0,0,0,0,1,0,0,0,0,0,1])},adjustSepia:function(t,e){return e=m(e,0,1),y(t,v([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],e))},adjustGrayscale:function(t,e){return e=m(e,0,1),y(t,v([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],e))}},lt={invert:function(t){return function(e){return b(e,t)}}([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0]),brightness:R(ct.adjustBrightness),hue:R(ct.adjustHue),saturate:R(ct.adjustSaturation),contrast:R(ct.adjustContrast),grayscale:R(ct.adjustGrayscale),sepia:R(ct.adjustSepia),colorize:function(t,e,n,r){return b(t,ct.adjustColors(ct.identity(),e,n,r))},sharpen:S([0,-1,0,-1,5,-1,0,-1,0]),emboss:S([-2,-1,0,-1,1,1,0,1,2]),gamma:T(function(t,e){return 255*Math.pow(t/255,1-e)}),exposure:T(function(t,e){return 255*(1-Math.exp(-t/255*e))}),colorFilter:b,convoluteFilter:x},st={scale:E},ft={rotate:function(t,e){return t.toCanvas().then(function(n){return D(n,t.getType(),e)})},flip:function(t,e){return t.toCanvas().then(function(n){return O(n,t.getType(),e)})},crop:function(t,e,n,r,o){return t.toCanvas().then(function(i){return C(i,t.getType(),e,n,r,o)})},resize:function(t,e,n){return t.toCanvas().then(function(r){return st.scale(r,e,n).then(function(e){return at.fromCanvas(e,t.getType())})})}},dt=function(){function t(t){this.littleEndian=!1,this._dv=new DataView(t)}return t.prototype.readByteAt=function(t){return this._dv.getUint8(t)},t.prototype.read=function(t,e){if(t+e>this.length())return null;for(var n=this.littleEndian?0:-8*(e-1),r=0,o=0;r<e;r++)o|=this.readByteAt(t+r)<<Math.abs(n+8*r);return o},t.prototype.BYTE=function(t){return this.read(t,1)},t.prototype.SHORT=function(t){return this.read(t,2)},t.prototype.LONG=function(t){return this.read(t,4)},t.prototype.SLONG=function(t){var e=this.read(t,4);return e>2147483647?e-4294967296:e},t.prototype.CHAR=function(t){return String.fromCharCode(this.read(t,1))},t.prototype.STRING=function(t,e){return this.asArray("CHAR",t,e).join("")},t.prototype.SEGMENT=function(t,e){var n=this._dv.buffer;switch(arguments.length){case 2:return n.slice(t,t+e);case 1:return n.slice(t);default:return n}},t.prototype.asArray=function(t,e,n){for(var r=[],o=0;o<n;o++)r[o]=this[t](e+o);return r},t.prototype.length=function(){return this._dv?this._dv.byteLength:0},t}(),ht={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"},thumb:{513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength"}},pt={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}},gt=function(){function t(t){this._offsets={tiffHeader:10,IFD0:null,IFD1:null,exifIFD:null,gpsIFD:null},this._tiffTags={};var e=this;if(e._reader=new dt(t),e._idx=e._offsets.tiffHeader,65505!==e.SHORT(0)||"EXIF\0"!==e.STRING(4,5).toUpperCase())throw new Error("Exif data cannot be read or not available.");if(e._reader.littleEndian=18761==e.SHORT(e._idx),42!==e.SHORT(e._idx+=2))throw new Error("Invalid Exif data.");e._offsets.IFD0=e._offsets.tiffHeader+e.LONG(e._idx+=2),e._tiffTags=e.extractTags(e._offsets.IFD0,ht.tiff),"ExifIFDPointer"in e._tiffTags&&(e._offsets.exifIFD=e._offsets.tiffHeader+e._tiffTags.ExifIFDPointer,delete e._tiffTags.ExifIFDPointer),"GPSInfoIFDPointer"in e._tiffTags&&(e._offsets.gpsIFD=e._offsets.tiffHeader+e._tiffTags.GPSInfoIFDPointer,delete e._tiffTags.GPSInfoIFDPointer);var n=e.LONG(e._offsets.IFD0+12*e.SHORT(e._offsets.IFD0)+2);n&&(e._offsets.IFD1=e._offsets.tiffHeader+n)}return t.prototype.BYTE=function(t){return this._reader.BYTE(t)},t.prototype.SHORT=function(t){return this._reader.SHORT(t)},t.prototype.LONG=function(t){return this._reader.LONG(t)},t.prototype.SLONG=function(t){return this._reader.SLONG(t)},t.prototype.CHAR=function(t){return this._reader.CHAR(t)},t.prototype.STRING=function(t,e){return this._reader.STRING(t,e)},t.prototype.SEGMENT=function(t,e){return this._reader.SEGMENT(t,e)},t.prototype.asArray=function(t,e,n){for(var r=[],o=0;o<n;o++)r[o]=this[t](e+o);return r},t.prototype.length=function(){return this._reader.length()},t.prototype.UNDEFINED=function(){return this.BYTE.apply(this,arguments)},t.prototype.RATIONAL=function(t){return this.LONG(t)/this.LONG(t+4)},t.prototype.SRATIONAL=function(t){return this.SLONG(t)/this.SLONG(t+4)},t.prototype.ASCII=function(t){return this.CHAR(t)},t.prototype.TIFF=function(){return this._tiffTags},t.prototype.EXIF=function(){var t=this,e=null;if(t._offsets.exifIFD){try{e=t.extractTags(t._offsets.exifIFD,ht.exif)}catch(t){return null}if(e.ExifVersion&&Array.isArray(e.ExifVersion)){for(var n=0,r="";n<e.ExifVersion.length;n++)r+=String.fromCharCode(e.ExifVersion[n]);e.ExifVersion=r}}return e},t.prototype.GPS=function(){var t=this,e=null;if(t._offsets.gpsIFD){try{e=t.extractTags(t._offsets.gpsIFD,ht.gps)}catch(t){return null}e.GPSVersionID&&Array.isArray(e.GPSVersionID)&&(e.GPSVersionID=e.GPSVersionID.join("."))}return e},t.prototype.thumb=function(){var t=this;if(t._offsets.IFD1)try{var e=t.extractTags(t._offsets.IFD1,ht.thumb);if("JPEGInterchangeFormat"in e)return t.SEGMENT(t._offsets.tiffHeader+e.JPEGInterchangeFormat,e.JPEGInterchangeFormatLength)}catch(t){}return null},t.prototype.extractTags=function(t,e){var n,r,o,i,a,u,c,l,s=this,f=[],d={},h={1:"BYTE",7:"UNDEFINED",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",9:"SLONG",10:"SRATIONAL"},p={BYTE:1,UNDEFINED:1,ASCII:1,SHORT:2,LONG:4,RATIONAL:8,SLONG:4,SRATIONAL:8};for(n=s.SHORT(t),r=0;r<n;r++)if(f=[],c=t+2+12*r,void 0!==(o=e[s.SHORT(c)])){if(i=h[s.SHORT(c+=2)],a=s.LONG(c+=2),!(u=p[i]))throw new Error("Invalid Exif data.");if(c+=4,u*a>4&&(c=s.LONG(c)+s._offsets.tiffHeader),c+u*a>=s.length())throw new Error("Invalid Exif data.");"ASCII"!==i?(f=s.asArray(i,c,a),l=1==a?f[0]:f,pt.hasOwnProperty(o)&&"object"!=typeof l?d[o]=pt[o][l]:d[o]=l):d[o]=s.STRING(c,a).replace(/\0$/,"").trim()}return d},t}(),mt=function(t){var e,n,r=[],o=0;for(e=2;e<=t.length();)if((n=t.SHORT(e))>=65488&&n<=65495)e+=2;else{if(65498===n||65497===n)break;o=t.SHORT(e+2)+2,n>=65505&&n<=65519&&r.push({hex:n,name:"APP"+(15&n),start:e,length:o,segment:t.SEGMENT(e,o)}),e+=o}return r},yt={extractFrom:function(t){return ot.blobToArrayBuffer(t).then(function(e){try{var n=new dt(e);if(65496===n.SHORT(0)){var r=mt(n),o=r.filter(function(t){return"APP1"===t.name}),i={};if(!o.length)return V.reject("Headers did not include required information");var a=new gt(o[0].segment);return i={tiff:a.TIFF(),exif:a.EXIF(),gps:a.GPS(),thumb:a.thumb()},i.rawHeaders=r,i}return V.reject("Image was not a jpeg")}catch(e){return V.reject("Unsupported format or not an image: "+t.type+" (Exception: "+e.message+")")}})}},vt=function(t,e){return ft.rotate(t,e)},bt={invert:function(t){return lt.invert(t)},sharpen:function(t){return lt.sharpen(t)},emboss:function(t){return lt.emboss(t)},brightness:function(t,e){return lt.brightness(t,e)},hue:function(t,e){return lt.hue(t,e)},saturate:function(t,e){return lt.saturate(t,e)},contrast:function(t,e){return lt.contrast(t,e)},grayscale:function(t,e){return lt.grayscale(t,e)},sepia:function(t,e){return lt.sepia(t,e)},colorize:function(t,e,n,r){return lt.colorize(t,e,n,r)},gamma:function(t,e){return lt.gamma(t,e)},exposure:function(t,e){return lt.exposure(t,e)},flip:function(t,e){return ft.flip(t,e)},crop:function(t,e,n,r,o){return ft.crop(t,e,n,r,o)},resize:function(t,e,n){return ft.resize(t,e,n)},rotate:vt,exifRotate:function(t){return t.toBlob().then(yt.extractFrom).then(function(e){switch(e.tiff.Orientation){case 6:return vt(t,90);case 3:return vt(t,180);case 8:return vt(t,270);default:return t}},function(){return t})}},wt=function(t){return t.toBlob()},xt={blobToImageResult:function(t){return at.fromBlob(t)},fromBlobAndUrlSync:function(t,e){return at.fromBlobAndUrlSync(t,e)},imageToImageResult:function(t){return at.fromImage(t)},imageResultToBlob:function(t,e,n){return void 0===e&&void 0===n?wt(t):t.toAdjustedBlob(e,n)},imageResultToOriginalBlob:wt,imageResultToDataURL:function(t){return t.toDataURL()}},It=function(){return nt.getOrDie("URL")},Tt={createObjectURL:function(t){return It().createObjectURL(t)},revokeObjectURL:function(t){It().revokeObjectURL(t)}},Rt=tinymce.util.Tools.resolve("tinymce.util.Delay"),St=tinymce.util.Tools.resolve("tinymce.util.Promise"),Et=tinymce.util.Tools.resolve("tinymce.util.URI"),Ft=function(t){return t.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions")},Dt=function(t){return t.getParam("imagetools_proxy")},Ot=function(t){return t.getParam("imagetools_cors_hosts",[],"string[]")},Ct=function(t){return t.getParam("imagetools_credentials_hosts",[],"string[]")},At=function(t){return t.getParam("api_key",t.getParam("imagetools_api_key","","string"),"string")},_t=function(t){return t.getParam("images_upload_timeout",3e4,"number")},kt=function(t){return t.getParam("images_reuse_filename",!1,"boolean")},Bt=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),Lt=tinymce.util.Tools.resolve("tinymce.ui.Factory"),Ut=tinymce.util.Tools.resolve("tinymce.geom.Rect"),Ht={loadImage:function(t){return new St(function(e){var n=function(){t.removeEventListener("load",n),e(t)};t.complete?e(t):t.addEventListener("load",n)})}},Mt=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),Pt=tinymce.util.Tools.resolve("tinymce.util.Observable"),Nt=tinymce.util.Tools.resolve("tinymce.util.VK"),jt=0,Gt={create:function(e){return new(Lt.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(t){return arguments.length?(this.state.set("rect",t),this):this.state.get("rect")},imageSize:function(){var t=this.state.get("viewRect");return{w:t.w,h:t.h}},toggleCropRect:function(t){this.state.set("cropEnabled",t)},imageSrc:function(e){var n=this,r=new t.Image;r.src=e,Ht.loadImage(r).then(function(){var e,o,i=n.state.get("viewRect");if((o=n.$el.find("img"))[0])o.replaceWith(r);else{var a=t.document.createElement("div");a.className="mce-imagepanel-bg",n.getEl().appendChild(a),n.getEl().appendChild(r)}e={x:0,y:0,w:r.naturalWidth,h:r.naturalHeight},n.state.set("viewRect",e),n.state.set("rect",Ut.inflate(e,-20,-20)),i&&i.w===e.w&&i.h===e.h||n.zoomFit(),n.repaintImage(),n.fire("load")})},zoom:function(t){return arguments.length?(this.state.set("zoom",t),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var t,e,n,r,o,i,a=this;t=a.$el.find("img"),e=a.getEl().clientWidth,n=a.getEl().clientHeight,r=t[0].naturalWidth,o=t[0].naturalHeight,(i=Math.min((e-10)/r,(n-10)/o))>=1&&(i=1),a.zoom(i)},repaintImage:function(){var t,e,n,r,o,i,a,u,c,l,s;s=this.getEl(),c=this.zoom(),l=this.state.get("rect"),a=this.$el.find("img"),u=this.$el.find(".mce-imagepanel-bg"),o=s.offsetWidth,i=s.offsetHeight,n=a[0].naturalWidth*c,r=a[0].naturalHeight*c,t=Math.max(0,o/2-n/2),e=Math.max(0,i/2-r/2),a.css({left:t,top:e,width:n,height:r}),u.css({left:t,top:e,width:n,height:r}),this.cropRect&&(this.cropRect.setRect({x:l.x*c+t,y:l.y*c+e,w:l.w*c,h:l.h*c}),this.cropRect.setClampRect({x:t,y:e,w:n,h:r}),this.cropRect.setViewPortRect({x:0,y:0,w:o,h:i}))},bindStates:function(){function t(t){e.cropRect=_(t,e.state.get("viewRect"),e.state.get("viewRect"),e.getEl(),function(){e.fire("crop")}),e.cropRect.on("updateRect",function(t){var n=t.rect,r=e.zoom();n={x:Math.round(n.x/r),y:Math.round(n.y/r),w:Math.round(n.w/r),h:Math.round(n.h/r)},e.state.set("rect",n)}),e.on("remove",e.cropRect.destroy)}var e=this;e.state.on("change:cropEnabled",function(t){e.cropRect.toggleVisibility(t.value),e.repaintImage()}),e.state.on("change:zoom",function(){e.repaintImage()}),e.state.on("change:rect",function(n){var r=n.value;e.cropRect||t(r),e.cropRect.setRect(r)})}}))(e)}},zt={edit:function(t,e){return new St(function(n,r){return e.toBlob().then(function(e){U(t,k(e),n,r)})})}},Vt={getImageSize:function(t){function e(t){return/^[0-9\.]+px$/.test(t)}var n,r;return n=t.style.width,r=t.style.height,n||r?e(n)&&e(r)?{w:parseInt(n,10),h:parseInt(r,10)}:null:(n=t.width,r=t.height,n&&r?{w:parseInt(n,10),h:parseInt(r,10)}:null)},setImageSize:function(t,e){var n,r;e&&(n=t.style.width,r=t.style.height,(n||r)&&(t.style.width=e.w+"px",t.style.height=e.h+"px",t.removeAttribute("data-mce-style")),n=t.width,r=t.height,(n||r)&&(t.setAttribute("width",e.w),t.setAttribute("height",e.h)))},getNaturalImageSize:function(t){return{w:t.naturalWidth,h:t.naturalHeight}}},Wt=function(t){if(null===t)return"null";var e=typeof t;return"object"===e&&Array.prototype.isPrototypeOf(t)?"array":"object"===e&&String.prototype.isPrototypeOf(t)?"string":e},qt=function(t){return function(e){return Wt(e)===t}}("function"),Yt=function(t,e){for(var n=0,r=t.length;n<r;n++){var o=t[n];if(e(o,n,t))return K.some(o)}return K.none()},Xt=Array.prototype.slice,$t=(qt(Array.from)&&Array.from,function(t){return null!==t&&void 0!==t}),Jt={traverse:function(t,e){var n;return n=e.reduce(function(t,e){return $t(t)?t[e]:void 0},t),$t(n)?n:null},readBlob:function(t){return new St(function(e){var n=a();n.onload=function(t){var n=t.target;e(n.result)},n.readAsText(t)})},requestUrlAsBlob:function(t,e,n){return new St(function(r){var o;(o=H()).onreadystatechange=function(){4===o.readyState&&r({status:o.status,blob:this.response})},o.open("GET",t,!0),o.withCredentials=n,j.each(e,function(t,e){o.setRequestHeader(e,t)}),o.responseType="blob",o.send()})},parseJson:function(t){var e;try{e=JSON.parse(t)}catch(t){}return e}},Kt=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],Zt=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Qt=function(t){return 400===t||403===t||500===t},te=function(t){return"ImageProxy HTTP error: "+Yt(Kt,function(e){return t===e.code}).fold(W("Unknown ImageProxy error"),function(t){return t.message})},ee=function(t){var e=te(t);return St.reject(e)},ne=function(t){return Yt(Zt,function(e){return e.type===t}).fold(W("Unknown service error"),function(t){return t.message})},re=function(t){var e=Jt.parseJson(t),n=Jt.traverse(e,["error","type"]);return"ImageProxy Service error: "+(n?ne(n):"Invalid JSON in service error message")},oe=function(t,e){return Jt.readBlob(e).then(function(t){var e=re(t);return St.reject(e)})},ie={handleServiceErrorResponse:function(t,e){return Qt(t)?oe(0,e):ee(t)},handleHttpError:ee,getHttpErrorMsg:te,getServiceErrorMsg:ne},ae=function(t,e){var n=-1===t.indexOf("?")?"?":"&";return/[?&]apiKey=/.test(t)||!e?t:t+n+"apiKey="+encodeURIComponent(e)},ue=function(t,e){var n={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return Jt.requestUrlAsBlob(ae(t,e),n,!1).then(function(t){return t.status<200||t.status>=300?ie.handleServiceErrorResponse(t.status,t.blob):St.resolve(t.blob)})},ce={getUrl:function(t,e,n){return e?ue(t,e):M(t,n)}},le=0,se=function(t,e){t.notificationManager.open({text:e,type:"error"})},fe=function(t){return t.selection.getNode()},de=function(t,e){var n=e.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return n?t.dom.encode(n[1]):null},he=function(){return"imagetools"+le++},pe=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new Et(n).host===t.documentBaseURI.host},ge=function(t,e){return-1!==j.inArray(Ot(t),new Et(e.src).host)},me=function(t,e){return-1!==j.inArray(Ct(t),new Et(e.src).host)},ye=function(t,e){var n,r=e.src;return ge(t,e)?ce.getUrl(e.src,null,me(t,e)):pe(t,e)?it.imageToBlob(e):(r=Dt(t),r+=(-1===r.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),n=At(t),ce.getUrl(r,n,!1))},ve=function(t){var e;return(e=t.editorUpload.blobCache.getByUri(fe(t).src))?St.resolve(e.blob()):ye(t,fe(t))},be=function(t,e){var n=Rt.setEditorTimeout(t,function(){t.editorUpload.uploadImagesAuto()},_t(t));e.set(n)},we=function(t){clearTimeout(t.get())},xe=function(t,e,n,r,o){return e.toBlob().then(function(i){var a,u,c,l,s;return c=t.editorUpload.blobCache,s=fe(t),a=s.src,kt(t)&&((l=c.getByUri(a))?(a=l.uri(),u=l.name()):u=de(t,a)),l=c.create({id:he(),blob:i,base64:e.toBase64(),uri:a,name:u}),c.add(l),t.undoManager.transact(function(){function e(){t.$(s).off("load",e),t.nodeChanged(),n?t.editorUpload.uploadImagesAuto():(we(r),be(t,r))}t.$(s).on("load",e),o&&t.$(s).attr({width:o.w,height:o.h}),t.$(s).attr({src:l.blobUri()}).removeAttr("data-mce-src")}),l})},Ie=function(t,e,n,r){return function(){return t._scanForImages().then(o(ve,t)).then(xt.blobToImageResult).then(n).then(function(n){return xe(t,n,!1,e,r)},function(e){se(t,e)})}},Te={rotate:function(t,e,n){return function(){var r=Vt.getImageSize(fe(t)),o=r?{w:r.h,h:r.w}:null;return Ie(t,e,function(t){return bt.rotate(t,n)},o)()}},flip:function(t,e,n){return function(){return Ie(t,e,function(t){return bt.flip(t,n)})()}},editImageDialog:function(t,e){return function(){var n=fe(t),r=Vt.getNaturalImageSize(n),i=function(t){return new St(function(e){it.blobToImage(t).then(function(o){var i=Vt.getNaturalImageSize(o);r.w===i.w&&r.h===i.h||Vt.getImageSize(n)&&Vt.setImageSize(n,i),Tt.revokeObjectURL(o.src),e(t)})})};ve(t).then(xt.blobToImageResult).then(o(function(t,n){return zt.edit(t,n).then(i).then(xt.blobToImageResult).then(function(n){return xe(t,n,!0,e)},function(){})},t),function(e){se(t,e)})}},isEditableImage:function(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")&&(pe(t,e)||ge(t,e)||t.settings.imagetools_proxy)},cancelTimedUpload:we},Re={register:function(t,e){j.each({mceImageRotateLeft:Te.rotate(t,e,-90),mceImageRotateRight:Te.rotate(t,e,90),mceImageFlipVertical:Te.flip(t,e,"v"),mceImageFlipHorizontal:Te.flip(t,e,"h"),mceEditImage:Te.editImageDialog(t,e)},function(e,n){t.addCommand(n,e)})}},Se={setup:function(t,e,n){t.on("NodeChange",function(r){var o=n.get();o&&o.src!==r.element.src&&(Te.cancelTimedUpload(e),t.editorUpload.uploadImagesAuto(),n.set(null)),Te.isEditableImage(t,r.element)&&n.set(r.element)})}},Ee={register:function(t){t.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),t.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),t.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),t.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),t.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),t.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})}},Fe={register:function(t){t.addContextToolbar(o(Te.isEditableImage,t),Ft(t))}};N.add("imagetools",function(t){var e=P(0),n=P(null);Re.register(t,e),Ee.register(t),Fe.register(t),Se.setup(t,e,n)})}(window);