define("plugins/notifications/calendar/register",["io.ox/calendar/api","io.ox/core/yell","io.ox/core/extensions","io.ox/core/notifications/subview","gettext!plugins/notifications","io.ox/calendar/util","settings!io.ox/core","settings!io.ox/calendar","io.ox/core/tk/sounds-util","io.ox/core/notifications"],function(e,t,i,n,o,a,r,c,s,d){"use strict";function l(e){if(_.device("smartphone"))return"week:day";var t=/(0|6)/.test(a.getMoment(e.get("startDate")).day()),i=c.get("viewView")||"week:week";return"week:workweek"===i&&t&&(i="week:week"),/(year|list)/.test(i)&&(i="week:week"),i}var u=r.get("autoOpenNotification",!0);return"always"===u||"noEmail"===u?(u=!0,r.set("autoOpenNotification",!0),r.save()):"Never"===u&&(u=!1,r.set("autoOpenNotification",!1),r.save()),i.point("io.ox/core/notifications/invites/item").extend({draw:function(i){var n=i.model,r=this,c=_.cid(n.attributes),s=a.getDateTimeIntervalMarkup(n.attributes,{output:"strings",zone:moment().tz()}),u=a.getRecurrenceString(n.attributes);r.attr({"data-cid":c,"focus-id":"calendar-invite-"+c,"aria-label":o("Invitation for %1$s.",n.get("title"))}).append($('<a class="notification-info" role="button">').append($('<span class="span-to-div time">').text(s.timeStr).attr("aria-label",a.getTimeIntervalA11y(n.attributes,moment().tz())),$('<span class="span-to-div date">').text(s.dateStr).attr("aria-label",a.getDateIntervalA11y(n.attributes,moment().tz())),""===u?[]:$('<span class="span-to-div recurrence">').text(u),$('<span class="span-to-div title">').text(n.get("summary")),$('<span class="span-to-div location">').text(n.get("location")),$('<span class="span-to-div organizer">').text(n.get("organizer").cn),$('<button type="button" class="btn btn-link open-in-calendar">').text(o("Open in calendar")).on("click",function(e){"click"!==e.type&&13!==e.which||(_.device("smartphone")&&d.dropdown.close(),a.openDeeplink(n,{perspective:l(n),showDetails:!0}))}),$('<span class="sr-only">').text(o("Press to open Details"))),$('<div class="actions">').append($('<button type="button" class="refocus btn btn-default" data-action="accept_decline">').attr({"focus-id":"calendar-invite-"+c+"-accept-decline","aria-label":o("Accept/Decline")+" "+n.get("summary")}).css("margin-right","14px").text(o("Accept / Decline")).on("click",function(t){t.stopPropagation(),require(["io.ox/calendar/actions/acceptdeny"]).done(function(t){e.get(e.reduce(n.attributes)).then(function(e){t(e.attributes,{noFolderCheck:!0})})})}),$('<button type="button" class="refocus btn btn-success" data-action="accept">').attr({"aria-label":o("Accept invitation")+" "+n.get("summary"),"focus-id":"calendar-invite-"+c+"-accept"}).on("click",function(i){i.stopPropagation(),require(["io.ox/calendar/util"],function(i){e.get(e.reduce(n.attributes)).done(function(n){var a={alarms:i.getDefaultAlarms(n),attendee:_(n.get("attendees")).findWhere({entity:ox.user_id}),id:n.get("id"),folder:n.get("folder")};if(a.attendee){a.attendee.partStat="ACCEPTED";var r=i.getCurrentRangeOptions();e.confirm(a,_.extend({checkConflicts:!0},r)).done(function(t){t&&t.conflicts&&ox.load(["io.ox/calendar/conflicts/conflictList"]).done(function(i){i.dialog(t.conflicts).on("ignore",function(){e.confirm(a,_.extend({checkConflicts:!1},r))})})}).fail(t)}else t("error",o("Participant not found"))}).fail(t)})}).append($('<i class="fa fa-check" aria-hidden="true">'))))}}),i.point("io.ox/core/notifications/calendar-reminder/item").extend({draw:function(t){for(var i=[5,10,15,45],n=[],a=this,r=0;r<i.length;r++)n.push([i[r],o.format(o.npgettext("in","in %d minute","in %d minutes",i[r]),i[r])]);require(["io.ox/core/tk/reminder-util"],function(i){i.draw(a,t.model,n),a.attr("model-cid",String(_.cid(t.requestedModel.attributes))),a.on("click",'[data-action="ok"]',function(i){i.stopPropagation();var n=a.find('[data-action="selector"]').val();"0"!==n?e.remindMeAgain(_(t.requestedModel.attributes).extend({time:6e4*n})).done(function(){e.getAlarms()}):e.acknowledgeAlarm(t.requestedModel.attributes),t.view.removeNotifications([t.requestedModel.attributes])})})}}),i.point("io.ox/core/notifications/calendar-reminder/footer").extend({draw:function(t){t.view.collection.length>1&&this.append($('<button class="btn btn-link">').text(o("Remove all reminders")).on("click",function(){e.acknowledgeAlarm(t.view.collection.toJSON()),t.view.resetNotifications()}))}}),i.point("io.ox/core/notifications/register").extend({id:"appointmentReminder",index:100,register:function(){var i,c={id:"io.ox/calendarreminder",api:e,useListRequest:!0,useApiCid:!0,smartRemove:!0,apiEvents:{remove:"failedToFetchEvent acknowledgedAlarm"},title:o("Appointment reminders"),extensionPoints:{item:"io.ox/core/notifications/calendar-reminder/item",footer:"io.ox/core/notifications/calendar-reminder/footer"},detailview:"io.ox/calendar/view-detail",autoOpen:u,genericDesktopNotification:{title:o("New appointment reminders"),body:o("You have new appointment reminders"),icon:""},specificDesktopNotification:function(e){var t=e.get("summary"),i=", "+a.getDateInterval(e.attributes),n=", "+a.getTimeInterval(e.attributes);return{title:o("New appointment reminder"),body:t+i+n,icon:""}},hideAllLabel:o("Hide all appointment reminders.")},d=[],l=new n(c),f=[],p=!1,m=function(i){if(i&&f.push(i),!p&&f.length){p=!0;var n=f.shift();e.get(n).done(function(i){t("info",i?i.get("summary"):o("Appointment reminder")),s.playSound(),e.acknowledgeAlarm(n),setTimeout(function(){p=!1,m()},5e3)}).fail(function(){p=!1,m()})}};e.on("resetChronosAlarms",function(t){var n,o=[],r=(new moment).utc().format(a.ZULU_FORMAT),c=function(){var e=[];return l.collection.forEach(function(t){e.push(a.cid({folder:t.get("folder"),id:t.get("eventId"),recurrenceId:t.get("recurrenceId")}))}),e},s=function(){var t=c();n=void 0,r=(new moment).utc().format(a.ZULU_FORMAT);var o=[];_(d).each(function(i){i.time<=r?"AUDIO"===i.action?m(i):_(t).indexOf(a.cid({folder:i.folder,id:i.eventId,recurrenceId:i.recurrenceId}))>-1?e.acknowledgeAlarm(i):(l.addNotifications(i),t=c()):((!n||n>i.time)&&(n=i.time),o.push(i))}),d=o,n&&(i=setTimeout(s,new moment(n).utc().valueOf()-new moment(r).utc().valueOf()))};d=[],i&&(clearTimeout(i),i=void 0),_(t).each(function(e){e.time>r?((void 0===n||n>e.time)&&(n=e.time),d.push(e)):"AUDIO"===e.action?m(e):o.push(e)}),void 0!==n&&(i=setTimeout(s,new moment(n).valueOf()-new moment(r).valueOf()));var u=c();o=_(o).uniq(function(e){return a.cid({folder:e.folder,id:e.eventId,recurrenceId:e.recurrenceId})}),o=o.filter(function(t){return!(_(u).indexOf(a.cid({folder:t.folder,id:t.eventId,recurrenceId:t.recurrenceId}))>-1&&!l.collection.get(t.id))||(e.acknowledgeAlarm(t),!1)}),l.resetNotifications(o)}),r.on("change:autoOpenNotification",function(e){u=e,l.model.set("autoOpen",e)}),e.getAlarms()}}),i.point("io.ox/core/notifications/register").extend({id:"appointmentInvitations",index:300,register:function(){var t={id:"io.ox/calendarinvitations",api:e,smartRemove:!0,useApiCid:!0,apiEvents:{reset:"new-invites",remove:"delete:appointment mark:invite:confirmed"},fullModel:!0,title:o("Appointment invitations"),extensionPoints:{item:"io.ox/core/notifications/invites/item"},detailview:"io.ox/calendar/view-detail",detailviewOptions:{noFolderCheck:!0},autoOpen:u,genericDesktopNotification:{title:o("New appointment invitation"),body:o("You have new appointment invitations"),icon:""},specificDesktopNotification:function(e){var t=e.get("summary"),i=", "+a.getDateInterval(e.attributes),n=", "+a.getTimeInterval(e.attributes);return{title:o("New appointment invitation"),body:t+i+n,icon:""}},hideAllLabel:o("Hide all appointment invitations.")},i=new n(t);ox.on("socket:calendar:updates",function(t){var n=!1;_(t.needsAction).each(function(e){e.folder=e.folderId}),t.folders&&_(i.collection.models).chain().filter(function(e){return t.folders.indexOf(e.get("folder"))>-1}).map(function(e){return e.pick("folder","id","recurrenceId")}).valueOf().length&&(n=!0,e.getInvites()),t.needsAction&&!n&&i.addNotifications(t.needsAction)}),r.on("change:autoOpenNotification",function(e){i.model.set("autoOpen",e)}),e.getInvites()}}),!0});