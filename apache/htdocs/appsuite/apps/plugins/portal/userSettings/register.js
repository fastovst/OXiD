define("plugins/portal/userSettings/register",["io.ox/core/extensions","io.ox/core/main","gettext!io.ox/core","settings!io.ox/core","io.ox/core/capabilities","less!plugins/portal/userSettings/style"],function(e,t,a,s,o){"use strict";function r(e){13!==e.which&&"click"!==e.type||_.isFunction(e.data.fn)&&e.data.fn()}function n(){require(["io.ox/core/settings/user"],function(e){e.openModalDialog()})}function l(){require(["io.ox/backbone/views/modal","io.ox/core/http","io.ox/core/yell"],function(e,r,n){function l(e){if(e.length>=f&&(e.length<=v||0===v)){var t=2+/[a-z]/.test(e)+/[A-Z]/.test(e)+/[0-9]/.test(e)+new RegExp(y,"i").test(e),a=2+Math.floor(Math.max(0,e.length-4)/2)+(e.length>=6?1:0);return 6===t&&e.length>99&&(t=7),t=Math.min(t,a),c!==t&&n("screenreader",L[t].label),c=t,L[t]}return 0===v?(0!==c&&n("screenreader",L[0].label),c=0,L[0]):(1!==c&&n("screenreader",L[1].label),c=1,L[1])}function i(){if(""===p.val())h.slideUp();else{var e=l(p.val());w.text(e.label),u.removeClass("bar-weak bar-good bar-strong bar-legendary").addClass(e.color).css("width",e.barLength),h.slideDown()}}var d,c,p,g,u,w,h,b=o.has("guest"),f=s.get("password/minLength",4),v=s.get("password/maxLength",0),m=s.get("password/showStrength",!0),y=s.get("password/regexp","[^a-z0-9]"),x=s.get("password/special","$, _, %"),k=a("Change password and sign out"),L=[{label:a("Password strength: Too short"),color:"bar-weak",barLength:"20%"},{label:a("Password strength: Wrong length"),color:"bar-weak",barLength:"20%"},{label:a("Password strength: Very weak"),color:"bar-weak",barLength:"20%"},{label:a("Password strength: Weak"),color:"bar-weak",barLength:"40%"},{label:a("Password strength: Good"),color:"bar-good",barLength:"60%"},{label:a("Password strength: Strong"),color:"bar-strong",barLength:"80%"},{label:a("Password strength: Very strong"),color:"bar-strong",barLength:"100%"},{label:a("Password strength: Legendary!"),color:"bar-legendary",barLength:"100%"}];b&&(k=a(s.get("password/emptyCurrent")?"Add login password":"Change login password")),new e({async:!0,width:500,title:b?k:a("Change password")}).build(function(){var e=a("Your password is more secure if it also contains capital letters, numbers, and special characters like %1$s",x);e=v?a("Password length must be between %1$d and %2$d characters.",f,v)+"<br>"+e:a("Minimum password length is %1$d.",f)+"<br>"+e;var t=[];m&&(t=[h=$("<div>").hide().append(w=$('<label class="password-change-label">'),$('<div class="progress">').append(u=$('<div class="progress-bar password-strength-bar">'))),$("<div class=password-hint-container>").append(e)]);var o=a("Your current password"),r=_.uniqueId("form-control-label-");this.$body.append($('<label class="password-change-label">').attr("for",r).text(o).toggle(!(b&&s.get("password/emptyCurrent"))),d=$('<input type="password" class="form-control current-password">').attr({id:r,autocomplete:"new-password"}).toggle(!(b&&s.get("password/emptyCurrent"))),$('<label class="password-change-label">').attr("for",r=_.uniqueId("form-control-label-")).text(a("New password")),p=$('<input type="password" class="form-control new-password">').attr({id:r,autocomplete:"new-password"}),$('<label class="password-change-label">').attr("for",r=_.uniqueId("form-control-label-")).text(a("Repeat new password")),g=$('<input type="password" class="form-control repeat-new-password">').attr({id:r,autocomplete:"new-password"}),t,$('<div class="alert alert-info">').css("margin","14px 0").css("max-height","500px").text(a("If you change the password, you will be signed out. Please ensure that everything is closed and saved.")).toggle(!b)),m&&p.on("keyup",i)}).addCancelButton().addButton({label:k,action:"change"}).on("change",function(){var e=this,s=e.$body,o=""===p.val()?null:p.val(),l=""===g.val()?null:g.val(),i=""===d.val()?null:d.val();return b||null!==o?o!==l?(n("warning",a("The two newly entered passwords do not match.")),e.idle(),g.focus(),void(e=null)):void r.PUT({module:"passwordchange",params:{action:"update"},appendColumns:!1,data:{old_password:i,new_password:o}}).done(function(){s.find('input[type="password"]').val(""),e.close(),e=null,b||t.logout()}).fail(function(t){n(t),e.idle(),d.focus(),e=null}):(n("warning",a("Your new password may not be empty.")),e.idle(),p.focus(),void(e=null))}).on("show",function(){d.focus()}).open()})}var i=s.get("user/internalUserEdit",!0),d=o.has("edit_password");return!(!i&&!d)&&(e.point("io.ox/portal/widget/userSettings").extend({title:a("User data"),preview:function(){var e=$('<div class="content">');i&&e.append($('<button class="action" type="button">').text(a("My contact data")).on("click keypress",{fn:n},r)),d&&e.append($('<button class="action" type="button">').text(a("My password")).on("click keypress",{fn:l},r)),this.append(e)}}),e.point("io.ox/portal/widget/userSettings/settings").extend({title:a("User data"),type:"userSettings",editable:!1,unique:!0}),{changePassword:function(e){e&&e.preventDefault&&e.preventDefault(),require(["io.ox/core/capabilities"],function(e){e.has("edit_password")&&l()})}})});