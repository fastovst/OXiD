define("plugins/portal/tumblr/register",["io.ox/core/extensions","io.ox/portal/feed","gettext!io.ox/portal","io.ox/backbone/views/modal","settings!io.ox/portal"],function(t,e,a,n,r){"use strict";var o=r.get("apiKeys/tumblr"),l=["https://api.tumblr.com/v2/blog/","/posts/?api_key="+o+"&notes_info=&filter="];_.isUndefined(o)||(ox.debug&&console.warn("Tumblr portal plugin is DEPRECATED with 7.10.3 and will be removed with 7.10.4 or at any random date later"),t.point("io.ox/portal/widget/tumblr").extend({title:"Tumblr",stopLoadingOnError:!0,initialize:function(t){function a(){var a=t.model.get("props").url;t.feed=new e({url:String(l.join(a)+"&jsonp=")})}t.model.on("change:props",a),a()},load:function(t){return t.feed?t.feed.load().done(function(e){t.data=e.response}):$.when()},summary:function(){var t=this;this.addClass("with-summary show-summary"),this.on("click","h2",function(){t.toggleClass("show-summary")})},preview:function(t){var e,n=t.data,r=n.blog?n.blog.name:"",o="",l=0,i=_.first(n.posts,8),s=_(i).first();if(r&&this.find("h2 span.title").text(r),s&&_.isArray(s.photos)&&s.photos.length&&(e=s.photos[0].alt_sizes))_(e).each(function(t){(0===l||t.width>250&&t.width<1e3)&&(o=t.url.replace(/https?:\/\//,"//"),l=t.width)}),this.addClass("photo-stream").append($('<div class="content pointer" tabindex="0" role="button">').css("backgroundImage","url("+o+")").attr({"aria-label":a("Press [enter] to jump to the tumblr feed.")}));else{var p=[];_(i).each(function(t){t.title&&p.push($('<li class="paragraph">').append($('<span class="bold">').html(t.title),$.txt("")))}),p.length>0&&this.append($('<ul class="content pointer" tabindex="0" role="button">').attr({"aria-label":a("Press [enter] to jump to the tumblr feed.")}).append(p))}},draw:function(){function t(t){var e,n="",r=0,o=$('<div class="post">').attr("data-post-type",t.type),l=function(){return $('<span class="post-date">').text(" "+moment.unix(t.timestamp).format("lll"))},i=function(){var e=[],a="//"+t.blog_name+".tumblr.com/tagged/";return t.tags&&t.tags.length>0&&_(t.tags).each(function(t){e.push($('<a target="_blank" rel="noopener">').attr("href",a+t).addClass("tag").text(t).prepend($('<i class="fa fa-tag" aria-hidden="true">')))}),e},s=function(){return $('<a target="_blank" rel="noopener">').attr({href:t.post_url,title:a("Read article on tumblr.com")}).append($('<i class="icon-tumblr-sign">'))},p=function(){return $('<a target="_blank" rel="noopener">').attr({href:t.url,title:a("Open external link")}).append($('<i class="fa fa-external-link-square" aria-hidden="true">'))};"photo"===t.type?o.append(function(){var a;if(_.isArray(t.photos)&&t.photos.length&&(e=t.photos[0].alt_sizes))return _(e).each(function(t){(0===r||t.width>500&&t.width<1200)&&(n=t.url,r=t.width)}),n=n.replace(/https?:\/\//,"//"),a=$("<img>").attr({src:n}).css({width:"100%","max-width":r,"margin-bottom":"13px"}),t.post_url||t.link_url?$('<a target="_blank" rel="noopener">').attr("href",t.post_url||t.link_url).append(a):a}()):(t.title&&o.append(function(){var e=$("<h2>").text(t.title);return t.url||t.post_url?$('<a target="_blank" rel="noopener">',{href:t.url||t.post_url}).append(e):e}()),t.body&&o.append(function(){var e=t.body.replace(/<(?!img\s*\/?)[^>]+>/g,"\n").replace(/<img.+?src=['"]([^'"]+)['"].*?>/i,'<img src="$1">');return"chat"===t.type&&(e=e.replace(/\n/g,"<br />")),$('<div class="post-body">').html(e)}()),t.text&&o.append($("<blockquote>").append(_.escape($.trim(t.text))).append($("<em>").text(_.escape($.trim(t.source))))),o.append(function(){var e=$('<div class="post-bar">');return t.tags&&e.append(i()),t.timestamp&&e.append(l()),t.url&&e.append(p()),t.post_url&&e.append(s()),e}())),this.append(o)}return function(e){var a=e.data,n=a.blog?a.blog.name:"",r=$('<div class="portal-feed tumblr">');n&&r.append($("<h1>").text(n)),_(e.data.posts).each(t,r),this.append(r)}}()}),t.point("io.ox/portal/widget/tumblr/settings").extend({title:a("Tumblr"),type:"tumblr",editable:!0,edit:function(t,e){t.set("candidate",!0,{silent:!0,validate:!0});var r=new n({title:a("Edit Tumblr feed"),async:!0,width:400}),l=$('<input id="tumblr_url" type="text" class="form-control" placeholder=".tumblr.com">'),i=$('<input id="tumblr_desc" type="text" class="form-control">'),s=$('<div class="alert alert-danger" style="margin-top:15px;">').hide(),p=t.get("props")||{};r.build(function(){this.$body.append($('<div class="row">').append($('<div class="col-sm-12">').append($('<label for="tumblr_url">').text(a("Feed URL")),l.val(p.url))),$('<div class="row">').append($('<div class="col-sm-12">').append($('<label for="tumblr_desc">').text(a("Description")),i.val(p.description))),s)}).addCancelButton().addButton({label:a("Save"),action:"save"}).on("cancel",function(){t.has("candidate")&&_.isEmpty(t.attributes.props)&&e.removeWidget()}).on("save",function(){s.hide();var e=$.trim(l.val()),n=$.trim(i.val()),p=$.Deferred();return-1!==e.indexOf(".")||e.match(/\.tumblr\.com$/)||(e+=".tumblr.com"),e.match(/http:\/\//)&&(e=e.substring("http://".length)),0===e.length?(s.text(a("Please enter an blog url.")),p.reject()):0===n.length?(s.text(a("Please enter a description.")),p.reject()):$.ajax({url:"https://api.tumblr.com/v2/blog/"+e+"/posts/?api_key="+o+"&notes_info=&filter=&jsonp=testcallback",type:"HEAD",dataType:"jsonp",jsonp:!1,jsonpCallback:"testcallback",success:function(t){t.meta&&t.meta.status&&200===t.meta.status?p.resolve():(s.text(a("Unknown error while checking tumblr-blog.")),p.reject())},error:function(){s.text(a("Unknown error while checking tumblr-blog.")),p.reject()}}),p.done(function(){r.close(),t.set({title:n,props:{url:e,description:n}},{validate:!0}),t.unset("candidate")}),p.fail(function(){s.show(),r.idle()}),p}).open()}}))});