define("plugins/portal/xing/register",["io.ox/core/extensions","plugins/portal/xing/actions","plugins/portal/xing/activities","io.ox/xing/api","io.ox/core/api/user","io.ox/core/notifications","io.ox/backbone/views/modal","io.ox/keychain/api","gettext!plugins/portal","less!plugins/portal/xing/xing"],function(t,e,n,a,i,o,r,s,l){"use strict";var c,u,d,p,f=l("XING"),g=l("XING"),h=t.point("io.ox/portal/widget/xing");p=function(){var t=s.getStandardAccount("xing");s.submodules.xing.reauthorize(t).done(function(){o.yell("success",l("Successfully reauthorized your %s account",g)),ox.trigger("refresh^")}).fail(function(t){o.yell("error",l('There was a problem with %s. The error message was: "%s"',g,t.error))})},c=function(t){t.preventDefault(),(new r).build(function(){var t,e="de en es fr it nl pl pt ru tr zh".split(" "),n=this;this.$body.append($('<div class="io-ox-xing submitted-data">').append($("<p>").text(l("Please select which of the following data we may use to create your %s account:",g)),$("<label>").text(l("Mail address")).attr("for",t=_.uniqueId("form-control-label-")).append(this.$email=$('<input type="text" name="email">').attr("id",t)),$("<label>").text(l("First name")).attr("for",t=_.uniqueId("form-control-label-")).append(this.$firstname=$('<input type="text" name="firstname">').attr("id",t)),$("<label>").text(l("Last name")).attr("for",t=_.uniqueId("form-control-label-")).append(this.$lastname=$('<input type="text" name="lastname">').attr("id",t)),$("<label>").text(l("Language")).attr("for",t=_.uniqueId("form-control-label-")).append(this.$language=$('<select name="language">').attr("id",t).append(_(e).map(function(t){return $("<option>").val(t).text(t)}))))),i.getCurrentUser().done(function(t){var e=t.attributes.locale;n.$email.val(t.attributes.email1||t.attributes.email2||t.attributes.email3),n.$firstname.val(t.attributes.first_name),n.$lastname.val(t.attributes.last_name),n.$language.val(e.indexOf("_")>-1?e.split("_")[0]:e)})}).addCancelButton().addButton({label:l("Accept"),action:"accepted"}).on("accepted",function(){a.createProfile({tandc_check:!0,email:this.$email.val(),first_name:this.$firstname.val(),last_name:this.$lastname.val(),language:this.$language.val()}).fail(function(t){o.yell("error",l('There was a problem with %s. The error message was: "%s"',g,t.error))}).done(function(){o.yell({type:"success",duration:6e4,message:l("Please check your inbox for a confirmation email.\n\nFollow the instructions in the email and then return to the widget to complete account setup.")})})}).open()},d=function(){var t=$('<div class="xing comment">').append($('<textarea rows="3" cols "40">'),$('<button type="button" class="btn btn-primary">').text(l("Post a status update")));return t.on("click",".btn",function(t){var e=$(t.target).parent(),n=e.children("textarea");a.changeStatus({message:n.val()}).fail(function(t){o.yell("error",l('Your status update could not be posted on %s. The error message was: "%s"',g,t.error))}).done(function(){e.remove(),o.yell("success",l("Your status update has been successfully posted on %s",g))})}),t},u=function(e,n){var a=(n=n||{}).maxCount,i=$('<div class="networkActivities">'),o=0;return 0===e.length&&i.text(l("There is no recent activity in your Xing network.")),_(e).each(function(e){if(!("activity"!==e.type||a&&o>=a)){var r,s=$('<div class="activity">').appendTo(i),l=$('<div class="reactions">'),c=$('<div class="date">'),u=!1;if((r=e.ids[0])&&s.attr("data-activity-id",r),t.point("io.ox/portal/widget/xing/activityhandler").each(function(t){t.accepts(e,n)&&(u=!0,t.handle(e,n).appendTo(s))}),u){if(e.created_at){var d=moment(e.created_at);c.text(d.format("l LT")).appendTo(s)}_(e.possible_actions).each(function(n){t.point("io.ox/portal/widget/xing/reaction").each(function(t){t.accepts(n)&&l.append(t.handle(e))})}),l.appendTo(s),o++}else console.log("Could not find a handler for the following activity: "+e.verb+". Please let us know about this. Here is some data that would help us: ",JSON.stringify(e))}}),0===o.length&&i.text(l("There is no recent activity in your Xing network.")),i};var x=function(){require(["io.ox/portal/main"],function(t){var e=t.getApp(),n=e.getWidgetCollection().filter(function(t){return/^xing_\d*/.test(t.id)});n.length>0&&e.refreshWidget(n[0],0)})};h.extend({title:f,stopLoadingOnError:!0,isEnabled:function(){return s.isEnabled("xing")},requiresSetUp:function(){return s.isEnabled("xing")&&!s.hasStandardAccount("xing")},drawDefaultSetup:function(t){s.submodules.xing.off("create",null,this),s.submodules.xing.on("create",function(){a.createSubscription(),t.model.node.find("h2 .fa-xing").replaceWith($('<span class="title">').text(f)),t.model.node.removeClass("requires-setup widget-color-custom color-xing"),x()},this);var e=this.find(".content");this.hasClass("widget-color-custom")||(this.find("h2:first").prepend($('<i class="fa fa-xing" aria-hidden="true">')),this.find("h2 .title").removeClass("title").addClass("sr-only"),this.addClass("widget-color-custom color-xing"),e.find(".paragraph").empty().text(l("Get news from your XING network delivered to you. Stay in touch and find out about new business opportunities.")),e.append($('<a href="#" class="action" role="button">').text(l("Create new %1$s account",g)).on("click",{baton:t},c)))},performSetUp:function(){var t=window.open(ox.base+"/busy.html","_blank","height=400, width=600");return s.createInteractively("xing",t)},load:function(t){var e=$.Deferred();return a.getUserfeed({user_fields:"0,1,2,3,4,8,23"}).then(function(n){t.data=n,e.resolve(n)}).fail(function(n){if(n.params&&"Invalid OAuth token"===n.error_params[0]&&s.getStandardAccount("xing"))return t.reauthorize=!0,void e.resolve();e.reject(n)}),e},preview:function(t){this.find(".setup-questions").remove(),t.reauthorize?this.append($('<div class="content">').append($('<a href="#">').text(l("Click here to reconnect to your xing account to see activities.")).on("click",function(){return p(),!1}))):this.append($('<div class="content preview io-ox-xing pointer">').append(u(t.data.network_activities,{maxCount:6,limitLength:!0})).on("click","a.external.xing",function(t){t.stopPropagation()}))},draw:function(t){this.append($('<div class="content io-ox-xing fullview">').append(d(),$("<h2>").text(l("Your %s newsfeed",g)),u(t.data.network_activities)))}}),t.point("io.ox/portal/widget/xing/settings").extend({title:f,type:"xing",editable:!1,unique:!0})});