define("io.ox/find/view-tokenfield",["io.ox/find/extensions-tokenfield","io.ox/core/extensions","settings!io.ox/contacts","io.ox/core/tk/tokenfield","io.ox/find/view-token","gettext!io.ox/core"],function(e,i,t,n,o,d){"use strict";var a="io.ox/find/tokenfield";return i.point(a+"/item").extend({index:100,draw:e.item}),i.point(a+"/name").extend({index:100,draw:e.name}),i.point(a+"/detail").extend({index:100,draw:e.detail}),i.point(a+"/image").extend({index:100,draw:e.image}),i.point(a+"/handler/click").extend({index:"last",flow:e.click}),i.point(a+"/token").extend({id:"token",index:100,draw:function(e,i){i.attrs.view||(i.attrs.view=new o({model:e,el:i.relatedTarget})),i.attrs.view.render()}}),Backbone.View.extend({api:$.noop,initialize:function(e){return _.extend(this,e),this.ui={container:void 0,field:void 0,view:void 0},this},render:function(){var e,o=this.app,s=this.baton,r=s.app.view.$el.find(".search-field"),u=s.app.view.$el.find(".action-show"),l=_.uniqueId("form-control-label-"),c=s.model,h=r.is(":focus")||u.is(":focus"),f=this;return this.ui.view=new n({extPoint:a,id:l,placeholder:d("Search")+"...",className:"search-field",delayedautoselect:!0,inputtype:"search",dnd:!1,hint:!1,allowEditing:!1,createTokensOnBlur:!1,customDefaultModel:!0,delimiter:"",maxResults:20,minLength:Math.max(1,t.get("search/minimumQueryLength",1)),autoselect:!0,source:o.getSuggestions,reduce:function(e){var i=c.manager,t=[];return i.update(e,{keep:"folder"}),e=i.filter(function(e){return e.is("tokenfield")&&!e.is("hidden")}),_.each(e,function(e){t=t.concat(e.get("values").filter(function(e){return!e.isActive()}))}),t},suggestion:function(e){var t=$('<div class="autocomplete-item">'),n=e.model;return function(e){var t=e.get("facet"),n=t.get("data").id;s.data={value:e,facet:t};var o=i.point(a+"/item/"+n);o.list().length?o.invoke("draw",this,s):i.point(a+"/item").invoke("draw",this,s)}.call(t,n),t},harmonize:function(e){return _(e).map(function(e){return{label:e.getDisplayName(),value:e.getDisplayName(),model:e}})},click:function(e,t){var n=i.Baton.ensure({deferred:$.Deferred().resolve(t.model),model:c});i.point(a+"/handler/click").invoke("flow",this,n)}}),this.ui.field=this.ui.view.$el,this.api=_.bind(this.ui.field.tokenfield,this.ui.field),e=r.val(),r.replaceWith(this.ui.field),this.register(),this.ui.view.render(),this.instance=this.ui.field.data("bs.tokenfield"),this.hiddenapi=this.ui.view.hiddenapi,this.ui.container=this.ui.field.parent(),this.ui.tokeninput=this.ui.container.find(".token-input"),h&&this.setFocus(),e&&this.app.on("change:state",function(i,t){"launched"===t&&f.hiddenapi.input.setInputValue(e,!1)}),this.ui.tokeninput.on({"typeahead:cursorchange typeahead:cursorchanged":_.bind(this.updateSelection,this,"add"),"typeahead:close typeahead:closed":_.bind(this.updateSelection,this,"remove"),"typeahead:select typeahead:selected":_.bind(this.updateSelection,this,"remove")}),this},retrigger:function(e,i){this.trigger(e.type,e,i)},reopenDropdown:function(){var e=this.hiddenapi;e.dropdown.isOpen||this.getQuery()&&e.input.trigger("queryChanged",e.input.query)},disable:function(){this.api("disable")},enable:function(){this.api("enable")},register:function(){var e=this;this.ui.field.on(["tokenfield:initialize","tokenfield:clickedtoken","tokenfield:createtoken","tokenfield:createdtoken","tokenfield:removetoken","tokenfield:removedtoken","aria-live-update"].join(" "),_.bind(this.retrigger,this)),this.on({"tokenfield:createtoken":function(e){$(document.activeElement).is("body")&&e.preventDefault()},"tokenfield:createdtoken tokenfield:removedtoken":_.bind(this.setPlaceholder,this),"tokenfield:removedtoken":_.bind(this.removedToken,this),"aria-live-update":_.bind(this.updateAriaLive,this)}),this.ui.view.on({"typeahead-custom:dropdown-rendered":_.bind(this.restoreSelection,this)}),this.app.view.on({focusin:_.bind(e.reopenDropdown,e)}),this.app.on({"view:disable":_.bind(e.disable,e),"view:enable":_.bind(e.enable,e)})},updateAriaLive:function(e,i){$(".io-ox-find .arialive").text(i)},updateSelection:function(e,i,t){if("add"!==e||!t)return this.ui.selected=void 0;this.ui.selected=t.model.get("id")},restoreSelection:function(){if(this.ui.selected){var e=$('.tt-suggestion> [data-id="'+this.ui.selected+'"]');if(!e.length)return this.ui.selected=void 0;e.parent().addClass("tt-cursor")}},removedToken:function(e){_([].concat(e.attrs)).each(function(e){e.model.deactivate()}),this.setFocus()},getField:function(){return this.ui.field},getQuery:function(){return this.ui.tokeninput.val().trim()},isEmpty:function(){var e=this.model.manager.getActive();return!_.filter(e,function(e){return!e.is("mandatory")}).length&&0===this.api("getTokens").length&&""===this.getQuery()},empty:function(){var e=this,i=this.api("getTokens");_.each(i,function(i){e.ui.field.trigger($.Event("tokenfield:removetoken",{attrs:i}))}),this.api("setTokens",[],!1,!1),_.each(i,function(i){e.ui.field.trigger($.Event("tokenfield:removedtoken",{attrs:i}))})},reset:function(){this.hiddenapi.setVal(""),this.empty(),this.setPlaceholder(),this.ui.tokeninput.css("width","auto")},setFocus:function(){this.ui.tokeninput.focus()},setPlaceholder:function(){this.ui.container.find("input.tt-input").attr({placeholder:this.isEmpty()?this.ui.view.options.placeholder||"":""})}})});