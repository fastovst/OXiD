define("io.ox/find/main",["io.ox/find/view-placeholder","io.ox/core/folder/api","io.ox/core/extensions","settings!io.ox/core","gettext!io.ox/core"],function(e,t,n,i,o){"use strict";var r=$.Deferred().reject("please launch app first"),a=function(e){var t=[e.getName(),e.get("inplace")?"inplace":"standalone",e.getModule()];return _.compact(t).join(":")},c=function(c){function l(){var e=d.model.manager,t="files"===d.getModuleParam();d.listenTo(e,{active:_.debounce(function(e){d.model.manager.isFolderOnly()&&(e=0),t&&d.model.manager.isAccountOnly()&&(e=0),d.trigger(e?"find:query":"find:idle")},10)}),d.listenTo(e,{"change:list-of-actives":_.debounce(function(e,t,n){require(["io.ox/metrics/main"],function(t){var i=d.get("parent").get("name")||"unknown",o=_.last(i.split("/")),r=n.get("facet").get("id").split(":")[0],a="deactivate"===e||n.get("facet")&&"disabled"===n.get("facet").getValue().getOption().id;t.trackEvent({app:o,target:"search/filter/"+r,action:a?"remove":"add"})})},10)}),d.listenTo(d.view,{cancel:function(){d.trigger("find:cancel")},show:function(){d.updateConfig()}})}function s(){var e=d.get("parent");return $.when(e.folder.getData(),e.folder.isDefault()).then(function(e,t){var n=[],i=d.model.manager;if(t&&!d.isMandatory("folder")||n.push({facet:"folder",filter:null,value:e.id}),!d.isMandatory("account")||i.findWhere({id:"account"})&&i.findWhere({id:"account"}).getActive().length||n.push({facet:"account",filter:null,value:e.account_id}),n.length)return{data:{facets:n}}})}var d;return c=_.extend({},{inplace:!0},c),(d=ox.ui.createApp(_.extend({name:"io.ox/find",title:o("Search"),state:"created"},c))).mediator({props:function(e){e.props=new Backbone.Model},"props-mandatory":function(e){var t=i.get("search/mandatory",{});t.account=t.account||[],t.account.push("drive"),e.props.set("mandatory",t)},"props-default":function(e){e.props.set("default",i.get("search/default","io.ox/mail"))},"props-mapping":function(e){var t=e.props.get("default-app");e.props.set("mapping",{"io.ox/mail/compose":"io.ox/mail","com.voiceworks/ox-messenger":t,"io.ox/drive":"io.ox/files","io.ox/office/text":"io.ox/files","io.ox/office/portal":"io.ox/files","io.ox/office/spreadsheet":"io.ox/files","io.ox/office/presentation":"io.ox/files","io.ox/office/portal/text":"io.ox/files","io.ox/office/portal/spreadsheet":"io.ox/files","io.ox/office/portal/presentation":"io.ox/files","io.ox/portal":t,"io.ox/settings":t})},cid:function(e){e.cid=a(e)},"window-inplace":function(e){e.get("inplace")&&e.set("window",e.get("parent").getWindow())},state:function(e){if(e.get("inplace")){var t=e.get("parent");e.on({"find:query:result":function(){!0===e.isActive()&&t.props.set("find-result",!0)},"find:idle":function(){t.props.set("find-result",!1)}})}},reset:function(e){e.get("inplace")&&(e.listenTo(e.get("parent"),"folder:change folder-virtual:change",e.cancel),e.listenTo(e.get("parent").props,"change:folderview",e.cancel))},"enable-disable-toggle":function(e){e.get("inplace")&&e.listenTo(e.get("parent").treeView,"selection:action",function(t,n){var i=$(t[n]);i.hasClass("selected")||e.updateState(i.attr("data-id"))})},vgrid:function(e){if(e.get("inplace")){var t,n=e.get("parent").grid;n&&n.addTemplate&&(n.setAllRequest("search",function(){var t={sort:n.prop("sort"),order:n.prop("order")};return e.getSearchResult(t,!0).then(function(e){return e&&e.results?e.results:[]})}),n.setListRequest("search",function(t){var n=[t];return $.Deferred().resolveWith(e,n)}),e.on({"find:query":function(){n.setMode("search"),t=n.getEmptyMessage(),n.setEmptyMessage(function(){return o("No matching items found.")})},"find:idle":function(){"all"!==n.getMode()&&(n.setMode("all"),n.setEmptyMessage(t))}}))}},"listview-empty-message":function(e){if(e.get("parent").listView){var t=e.get("parent").listView.ref;n.point(t+"/notification/empty").extend({id:"search",index:100,draw:function(e){e.app.props.get("find-result")&&this.text(o("No matching items found."))}})}},"listview-empty-message-action":function(e){if(e.get("parent").listView&&!e.isMandatory("folder")){var t=e.get("parent").listView.ref;n.point(t+"/notification/empty").extend({id:"search-action",index:200,draw:function(e){if(e.app.props.get("find-result")){var t=e.app.get("find").model.manager;t.get("folder")&&"disabled"===t.get("folder").get("values").get("custom").getOption().id||this.append($('<button type="button" class="btn btn-link" data-action="search-button">').text(o("Search in all folders")).on("click",function(){t.activate("folder","custom","disabled"),require(["io.ox/metrics/main"],function(t){var n=e.app.get("name")||"unknown",i=_.last(n.split("/"));t.trackEvent({app:i,target:"list/empty/search/filter/folder",action:"remove"})})}))}}})}},listview:function(e){e.get("inplace")&&e.on("change:state",function(t,n){if("launched"===n){var i=e.get("parent");i.listView&&require(["io.ox/core/api/collection-loader"],function(t){var n=e.view.model.manager,o=_.bind(n.getResponseCid,n),r=i.listView.loader,a="default",c=new t({module:"calendar"===e.getModuleParam()?"chronos":e.getModuleParam(),mode:"search",PRIMARY_PAGE_SIZE:r.PRIMARY_SEARCH_PAGE_SIZE||r.PRIMARY_PAGE_SIZE,SECONDARY_PAGE_SIZE:r.SECONDARY_SEARCH_PAGE_SIZE||r.SECONDARY_PAGE_SIZE,isBad:$.noop,fetch:function(t){var n=this,i=t.limit.split(","),o=parseInt(i[0],10),r=parseInt(i[1],10)-o;e.model.set({start:o,size:r,extra:1},{silent:!0});var a={sort:e.props.get("sort"),order:e.props.get("order")};return e.getSearchResult(a,!0).then(function(e){var t=(e=e||{}).results||[],i=e.request||{};if(n.collection.search={next:0!==t.length&&t.length===i.data.size},!t.length)return t;var o=t[0];return o.original_folder_id?o.original_folder_id===o.folder_id?t:(t.forEach(function(e){_.extend(e,{id:e.original_id||e.id,folder_id:e.original_folder_id||e.folder_id})}),t):t})},cid:o});i.listView.on("collection:load",function(){"search"===this.loader.mode&&c.collection&&(c.collection.expired=!0)}),e.trigger("collectionLoader:created",c);var l=function(){i.listView.connect(c),a="search"};e.on({"find:idle":function(){"search"===a&&(i.listView.connect(r),i.listView.load()),a="default"},"find:query":_.debounce(function(){"search"!==i.listView.loader.mode&&l(),i.listView.load()},10)})})}})},quit:function(e){e.get("inplace")&&e.listenTo(e.get("parent"),"quit",e.quit)},"window-standalone":function(e){if(!e.get("inplace")){var t;e.setWindow(t=ox.ui.createWindow({name:"io.ox/find",chromeless:!0})),t.show()}},"file-storages":function(e){if(!("files"===e.getModuleParam()))return e.set("storages",[]);require(["io.ox/core/api/filestorage"],function(t){t.rampup().then(function(){e.set("storages",t.getAccountsCache()),e.get("storages").on({change:$.noop,add:$.noop,remove:$.noop})})})}}),d.cancel=function(){this.view&&this.view.cancel()},d.updateState=function(e){d.trigger(t.isVirtual(e)?"view:disable":"view:enable")},d.getModule=function(){return d.get("parent").get("name")},d.getModuleParam=function(){return d.getModule().split("/")[1]},d.isActive=function(){return!!d.view&&d.view.isActive()},d.isMandatory=function(e){var t=d.props.get("mandatory"),n=d.getModuleParam();return"files"===n&&(n="drive"),(t[e]||[]).indexOf(n)>=0},d.getFolderFacetValue=function(){if(d.isActive())return(_(d.model.manager.getRequest()).findWhere({facet:"folder"})||{}).value},d.prepare=function(){d.set("state","preparing"),d.mediate(),d.placeholder=new e({app:d});var t=d.get("parent").folder.get();d.updateState(t),d.listenToOnce(d.placeholder,"launch",d.launch),d.set("state","prepared")},d.getProxy=function(){var e;return function(){var t=$.Deferred();return e||(require(["io.ox/find/apiproxy"],function(n){e=t.resolve(n.init(d))}),t)}}(),d.getConfig=function(e){return d.getProxy().then(function(t){return t.config(e)})},d.getSuggestions=function(e){return"launched"!==d.get("state")?r:$.when(d.getProxy(),d.configReady).then(function(t){return t.search(e)})},d.getSearchResult=function(e,t){return"launched"!==d.get("state")?r:d.getProxy().then(function(n){return n.query(e,t)})},d.configReady=$.Deferred(),d.updateConfig=function(){s().then(d.getConfig).then(function(e){e=_.reject(e,function(e){return"contact"===e.id}),d.model.manager.update(e),d.trigger("find:config-updated"),d.configReady.resolve()},function(e){require(["io.ox/core/yell"],function(t){t(e)}),d.cancel()})},d.launch=function(){"prepared"===d.get("state")&&(d.set("state","launching"),d.placeholder&&(d.placeholder.destroy(),delete d.placeholder),require(["io.ox/find/bundle"],function(){require(["io.ox/find/model","io.ox/find/view"],function(e,t){d.model=new e({app:d}),d.view=new t({app:d,model:d.model}),l(),d.view.render(),d.set("state","launched"),ox.trigger("search:load",d)}),require(["io.ox/contacts/api"],function(e){e.on("refresh.all",function(){d.getProxy().done(function(e){e.resetCache()})})})}))},d};return{getApp:c,reuse:function(e){return ox.ui.App.reuse(a(e))||c(e)}}});