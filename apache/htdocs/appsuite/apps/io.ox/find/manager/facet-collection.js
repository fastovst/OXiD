define("io.ox/find/manager/facet-collection",["io.ox/find/manager/facet-model","io.ox/find/date/facet-model","io.ox/core/extensions"],function(e,t,n){"use strict";function i(e,t){return e.get?e.get(t):e[t]}function o(e){var t=i(e,"id");return"simple"===i(e,"style")&&(t=t+":"+(i(e,"name")||i(e,"item").name)),t}var c=n.point("io.ox/find/manager/facet");return c.extend({index:100,customize:function(e){var n=$.Deferred();return _.extend(e||{},{"date.custom":t}),n}}),Backbone.Collection.extend({model:e,type:"facet-collection",comparator:"index",initialize:function(){var e=this;this.on("change:list-of-actives",_.debounce(function(){e.trigger("active",this.getActive().length)},10)),this.facetmodels={},c.invoke("customize",this,this.facetmodels)},isFolderOnly:function(){var e=this.getActive();if(1===e.length)return _.where(e,{id:"folder"}).length},isAccountOnly:function(){var e=this.getActive();if(1===e.length)return _.where(e,{id:"account"}).length},_createModel:function(t){return new(this.facetmodels[t.id]||e)(t)},add:function(e,t){var n=this,i=_.map([].concat(e),function(e){return n._createModel(e)});return this.set(i,_.extend({merge:!1},t,{add:!0,remove:!1}))},update:function(e,t){var n=this,i=[],c=[],r={},a=_.extend({keep:[]},t);e=[].concat(e),_.each(e,function(e,t){var c=o(e),u=n.get(c);u?a.keep.indexOf(c)<0&&u.update(e):u||(e.cid=c,e.index=e.index||100*t,i.push(e)),r[c]=u?"update":"add"}),n.add(i),c=this.filter(function(e){var t=e.get("id"),n=!!e.getActive().length;return!(r[t]||n)}),n.remove(c)},activate:function(e,t,n){n=(n||{}).option||n,this.get(e).getValue(t).activate(n)},getActive:function(){return this.filter(function(e){return e.getActive().length})},reset:function(){this.filter(function(e){_.each(e.getActive(),function(e){e.deactivate()})})},getRequest:function(){var e=[];return this.each(function(t){t.get("values").each(function(t){var n=t.getRequest();n&&e.push(n)})}),e},getResponseCid:function(){return"search/"+moment().format("YYYY-MM-DD")+"/"+_(this.getRequest()).chain().map(function(e){var t=e.filter;return e.facet+(t&&_.isArray(t.fields)?"("+t.fields.join(",")+")":"")+"="+(t&&_.isArray(t.queries)?t.queries.join(","):e.value)}).value().sort().join("&")}})});