define("io.ox/settings/main",["io.ox/core/tk/vgrid","io.ox/core/api/apps","io.ox/core/extensions","io.ox/core/commons","gettext!io.ox/core","settings!io.ox/settings/configjump","settings!io.ox/core","io.ox/core/capabilities","io.ox/core/folder/tree","io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/folder/util","io.ox/core/api/mailfilter","io.ox/core/yell","io.ox/keychain/api","io.ox/core/settings/errorlog/settings/pane","io.ox/core/settings/downloads/pane","io.ox/settings/personalData/settings/pane","io.ox/settings/apps/settings/pane","less!io.ox/settings/style"],function(e,t,i,n,s,o,a,r,l,d,c,u,p,g,x){"use strict";var f,m,v,h,b=ox.ui.createApp({name:"io.ox/settings"}),w=null,y=null,k=c.pool,S=[];return i.point("io.ox/settings/help/mapping").extend({id:"core",index:100,list:function(){_.extend(this,{"virtual/settings/io.ox/vacation":"ox.appsuite.user.sect.email.send.vacationnotice.html","virtual/settings/io.ox/autoforward":"ox.appsuite.user.sect.email.send.autoforward.html","virtual/settings/io.ox/core":"ox.appsuite.user.sect.settings.globalsettings.html","virtual/settings/io.ox/settings/accounts":"ox.appsuite.user.sect.dataorganisation.accounts.html","virtual/settings/security":"ox.appsuite.user.chap.security.html","virtual/settings/sessions":"ox.appsuite.user.sect.security.sessions.html","virtual/settings/io.ox/mail":"ox.appsuite.user.sect.email.settings.receive.html","virtual/settings/io.ox/mail/settings/compose":"ox.appsuite.user.sect.email.settings.compose.html","virtual/settings/io.ox/mail/settings/signatures":"ox.appsuite.user.sect.email.send.signatures.html","virtual/settings/io.ox/mailfilter":"ox.appsuite.user.sect.email.mailfilter.html","virtual/settings/io.ox/calendar":"ox.appsuite.user.sect.calendar.settings.html","virtual/settings/io.ox/timezones":"ox.appsuite.user.sect.calendar.manage.timezones.html","virtual/settings/io.ox/contacts":"ox.appsuite.user.sect.contacts.settings.html","virtual/settings/io.ox/files":"ox.appsuite.user.sect.drive.settings.html","virtual/settings/io.ox/portal":"ox.appsuite.user.sect.portal.settings.html","virtual/settings/io.ox/tasks":"ox.appsuite.user.sect.tasks.settings.html","virtual/settings/io.ox/office":"ox.documents.user.sect.documents.settings.html","virtual/settings/io.ox/core/sub":"ox.appsuite.user.sect.contacts.folder.managesubscribed.html","virtual/settings/io.ox/core/downloads":"ox.appsuite.user.sect.settings.clients.html","virtual/settings/administration/groups":"ox.appsuite.user.sect.calendar.groups.html","virtual/settings/administration/resources":"ox.appsuite.user.sect.calendar.resources.html"})}}),b.getContextualHelp=function(){var e=this.folder.get(),t={};return i.point("io.ox/settings/help/mapping").invoke("list",t),t[e]?t[e]:"ox.appsuite.user.chap.settings.html"},b.setLauncher(function(e){function C(e){_.each(i.point(e).list(),function(t){_.indexOf(h,t.id)>=0&&i.point(e).disable(t.id)})}function P(e,t,i,n){if("virtual/settings"!==e){var s=_.extend({focus:!1,focusPane:!!i,refresh:i&&i.options&&i.options.refresh},n);E.selection.uncheck().preselect(e),b.folder.set(e);var o=(t=E.selection.byId(e)).closest("li").data("view");o&&(u.open(o.options.parent),s.focus&&t.focus(),o.hasSubFolders()&&"open"!==o.options.open&&o.toggle("open",!0),y=w,w=k.getModel(e).get("meta"),(null===y||y.id!==w.id||s.refresh)&&N(i||w,s.focusPane),m.trigger("select"))}}function D(e){function t(e,n){C(n=n+"/"+e.id);var o=_(i.point(n).list()).map(function(e){return t(e,n),k.addModel({id:"virtual/settings/"+e.id,module:"settings",own_rights:134225984,title:s.pgettext("app",e.title),meta:e})});o.length>0&&(c.virtual.add("virtual/settings/"+e.id,M),k.addCollection("virtual/settings/"+e.id,o,{reset:!0}))}var n=[];_.each(e,function(e){if(e.subgroup){S.push({id:"virtual/settings/"+e.id,folderOptions:e.folderOptions}),C(e.subgroup);var o=_(i.point(e.subgroup).list()).map(function(i){return t(i,e.subgroup),k.addModel({id:"virtual/settings/"+i.id,module:"settings",own_rights:134225984,title:s.pgettext("app",i.title),meta:i})});o=_(o).compact(),k.addCollection("virtual/settings/"+e.id,o,{reset:!0})}else n.push(k.addModel({id:"virtual/settings/"+e.id,module:"settings",own_rights:134225984,title:s.pgettext("app",e.title),meta:e}).toJSON())}),k.getCollection("virtual/settings/external").add(n)}b.setWindow(f=ox.ui.createWindow({name:"io.ox/settings",title:"Settings",chromeless:!0})),f.addClass("io-ox-settings-main");var O=n.vsplit(f.nodes.main,b);(m=O.left.addClass("leftside border-right")).attr({"aria-label":s("Settings")}),v=O.right.addClass("default-content-padding settings-detail-pane f6-target").attr({tabindex:0,role:"main"}).scrollable();var q=$.when(t.where({settings:!0})).done(function(e){i.point("io.ox/settings/pane").extend({id:"main",index:200,subgroup:"io.ox/settings/pane/main"});var t=100;_(e).each(function(e){r.has(e.get("requires"))&&(i.point("io.ox/settings/pane/main").extend(_.extend({},{title:e.get("description"),ref:e.id,index:t},e.toJSON())),t+=100)})}),A=function(){function e(e){return-1===_.indexOf(h,e.id)}var t=$.Deferred(),n={redirect:"auto-forward",vacation:"vacation-notice"};return h=a.get("disabledSettingsPanes")?a.get("disabledSettingsPanes").split(","):[],r.has("mailfilter_v2")?p.getConfig().done(function(e){_.each(n,function(t,n){-1===_.findIndex(e.actioncmds,function(e){return e.id===n})&&i.point("io.ox/mail/settings/detail/view/buttons").disable(t)})}).fail(function(e){g("error",e.error_desc)}).always(function(){q.done(function(){t.resolve(_.filter(i.point("io.ox/settings/pane").list(),e))}).fail(t.reject)}):q.done(function(){t.resolve(_.filter(i.point("io.ox/settings/pane").list(),e))}).fail(t.reject),t},j={id:"standard-folders",index:100,draw:function(e){var t={headless:!0,count:0,empty:!1,indent:!1,open:!0,tree:e,parent:e,folder:"virtual/settings",className:"folder selectable"};this.append(S.map(function(e){var i=_.extend({},t,e.folderOptions||{},{model_id:e.id});return new d(i).render().$el.addClass("standard-folders").attr("role","presentation")}))}};i.point("io.ox/core/foldertree/settings/app").extend(_.extend({},j));var M=function(){var e=$.Deferred();return e.resolve(k.getCollection(this.id).models),e},E=new l({root:"1",all:!1,app:b,contextmenu:!1,flat:!1,indent:!0,module:"settings"});E.preselect(_.url.hash("folder")),E.on("open",function(e,t){t||_.device("smartphone")||P(e,void 0,void 0,{focus:!0,focusPane:!0})}),E.on("virtual",P),E.on("virtual",function(e){require(["io.ox/metrics/main"],function(t){t.isEnabled()&&t.trackEvent({app:"settings",target:"folder",type:"click",action:"select",detail:e.substr(e.lastIndexOf("/")+1)})})}),_.device("smartphone")&&E.$container.on("click",".folder.selectable.selected .folder-label",function(){m.trigger("select")}),_(o.get()).chain().keys().each(function(e){var t=o.get(e);if(!t.requires||r.has(t.requires)){var n=t["title_"+ox.language]||s(t.title)||"";i.point("io.ox/settings/pane/"+(t.group||"tools")).extend(_.extend({id:e,ref:"io.ox/configjump/"+e,loadSettingPane:!1},t,{title:n})),i.point("io.ox/configjump/"+e+"/settings/detail").extend({id:"iframe",index:100,draw:function(){var e=this;e.css({height:"100%"});var i=$.Deferred();t.url.indexOf("[token]")>0?(e.busy(),require(["io.ox/core/http"],function(e){e.GET({module:"token",params:{action:"acquireToken"}}).done(function(e){i.resolve(t.url.replace("[token]",e.token))}).fail(g)})):i.resolve(t.url),i.done(function(t){e.idle(),e.append($("<iframe>",{src:t,frameborder:0}).css({width:"100%",minHeight:"90%"}))})}})}}),require(["io.ox/metrics/main"],function(e){if(e.isEnabled()){var t=b.getWindow().nodes.outer;e.watch({node:t,selector:'.io-ox-accounts-settings [data-actionname="mailaccount"]',type:"click"},{app:"mail",target:"settings/account",type:"click",action:"add"})}}),i.point("io.ox/settings/pane").extend({id:"general",index:100,subgroup:"io.ox/settings/pane/general"}),i.point("io.ox/settings/pane/general").extend({title:s("Basic settings"),index:100,id:"io.ox/core"}),i.point("io.ox/settings/pane/general").extend({id:"security",title:s("Security"),ref:"io.ox/settings/security",index:300}),i.point("io.ox/settings/pane/general/security").extend({id:"sessions",title:s("Active clients"),ref:"io.ox/settings/security/sessions",index:100}),!a.get("security/manageCertificates")||a.get("security/acceptUntrustedCertificates")||r.has("guest")||i.point("io.ox/settings/pane/general/security").extend({id:"certificates",title:s("Certificates"),ref:"io.ox/settings/security/certificates",index:150});var I=_(x.submodules).filter(function(e){return!e.canAdd||e.canAdd.apply(this)});!r.has("guest")&&(r.has("webmail")||I.length>0)&&i.point("io.ox/settings/pane/general").extend({title:s("Accounts"),index:200,id:"io.ox/settings/accounts"}),i.point("io.ox/settings/pane").extend({id:"tools",index:400,subgroup:"io.ox/settings/pane/tools"}),i.point("io.ox/settings/pane").extend({id:"external",index:500,subgroup:"io.ox/settings/pane/external"}),i.point("io.ox/settings/pane").extend({id:"personalData",index:600,subgroup:"io.ox/settings/pane/personalData"});var B=function(){var e;return function(t){return e&&(e.cancelled=!0),e=t,t.then(function(){return this.cancelled?$.Deferred().reject():(e=null,$.Deferred().resolve())}.bind(e))}}(),N=function(e,t){(e=i.Baton.ensure(e)).tree=E,b.get("window").setTitle(s("%1$s %2$s",s("Settings"),s.pgettext("app",e.data.title)));var n=e.data,o=n.pane||(n.ref||n.id)+"/settings/pane",a=n.pane||(n.ref||n.id)+"/settings/detail",r=$.Deferred();return v.empty().busy(),n.loadSettingPane||_.isUndefined(n.loadSettingPane)?r=require([o]):r.resolve(),B(r).then(function(){O.right.attr("aria-label",s.pgettext("app",e.data.title)),i.point(a).invoke("draw",v,e),t&&O.right.focus(),v.idle()})};b.setSettingsPane=function(e){return A().done(function(t){if(D(t),0===O.left.find(".folder-tree").length&&O.left.append(E.render().$el),e&&(e.id||e.folder)){var n=e.folder||"virtual/settings/"+e.id,s=new i.Baton({data:k.getModel(n).get("meta"),options:e||{}});E.trigger("virtual",n,{},s)}_.device("smartphone")||void 0===E.selection.get()&&E.selection.uncheck().pick(0)}),$.when()},n.addFolderSupport(b,null,"settings",e.folder||"virtual/settings/io.ox/core").always(function(){f.show(function(){b.setSettingsPane(e)})}).fail(function(e){var t=e&&e.error?e.error+" ":"";t+=s("Application may not work as expected until this problem is solved."),g("error",t)})}),{getApp:b.getInstance}});