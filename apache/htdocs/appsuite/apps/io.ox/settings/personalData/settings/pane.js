define("io.ox/settings/personalData/settings/pane",["io.ox/backbone/views/disposable","gettext!io.ox/core","io.ox/backbone/views/modal","io.ox/core/extensions","io.ox/backbone/mini-views/common","io.ox/backbone/mini-views/dropdown","io.ox/settings/personalData/api","io.ox/core/yell","io.ox/core/capabilities","io.ox/core/strings","less!io.ox/settings/personalData/settings/style"],function(e,a,t,l,n,s,o,i,d,r){"use strict";var c={mail:{label:a("Email"),description:a("Includes all emails from your primary mail account as eml files."),includeTrash:{header:a("Included folders"),label:a("Trash folder")},includePublic:{label:a("Public folders")},includeShared:{label:a("Shared folders")},includeUnsubscribed:{label:a("Unsubscribed folders")}},calendar:{label:a("Calendar"),description:a("Includes all appointments from your calendars as ical files."),includePublic:{header:a("Included calendars"),label:a("Public calendars")},includeShared:{label:a("Shared calendars")},includeUnsubscribed:{label:a("Unsubscribed calendars")}},contacts:{label:a("Address book"),description:a("Includes all contact data from your address books as vcard files."),includePublic:{header:a("Included address books"),label:a("Public address books")},includeShared:{label:a("Shared address books")}},infostore:{label:a.pgettext("app","Drive"),description:a("Includes all files from %1$s.",a.pgettext("app","Drive")),includeTrash:{header:a("Included folders"),label:a("Trash folder")},includePublic:{label:a("Public folders")},includeShared:{label:a("Shared folders")},includeAllVersions:{header:a("Additional options"),divider:!0,label:a("Include all file versions")}},tasks:{label:a("Tasks"),description:a("Includes all tasks as ical files."),includePublic:{header:a("Included folders"),label:a("Public folders")},includeShared:{label:a("Shared folders")}}},u=[536870912,1073741824,2147483648],b=["GDPR-EXPORT-0013","GDPR-EXPORT-0009"],p=function(e){return((e=_.isArray(e)?e[0]:e).error||"FAILED"===e.status||"ABORTED"===e.status)&&(_(b).contains(e.code)||i(e),e={status:"NONE"}),e},h=function(e){var a=$.Deferred();return new t({title:e.title}).build(function(){this.$body.append($("<div>").text(e.text))}).addCancelButton({left:!0}).addButton({className:"btn-primary",action:e.action,label:e.label}).on("action",a.resolve).open(),a},f=e.extend({className:"personal-data-view",initialize:function(e){var a=this;this.status=e.status,this.status.on("change:status",this.render.bind(this)),this.models={},_(_(c).keys()).each(function(e){a.model.get(e)&&(a.models[e]=new Backbone.Model(a.model.get(e)),a.models[e].on("change:enabled",function(t){a.$el.find("."+e+"-sub-option").toggleClass("disabled",!t.get("enabled")).find("input").attr("aria-disabled",!0).prop("disabled",t.get("enabled")?"":"disabled")}))})},render:function(){this.$el.removeClass("disabled").empty();var e,t=this,l=_(u).filter(function(e){return e<=t.model.get("maxFileSize")});switch(this.$el.append($("<h1>").text(a("Download your personal data")),e=$('<div class="form-group">').append($("<div>").text(a("You can download a copy of your personal data from your account, if you want to save it or transfer it to another provider.")))),_(c).each(function(l,o){if(t.model.get(o)){var i=new s({caret:!0,model:t.models[o],label:a("Options")});t.models[o].on("change:enabled",function(){i.$toggle.attr("aria-disabled",!t.models[o].get("enabled")).toggleClass("disabled",!t.models[o].get("enabled"))}),_(_(l).keys()).each(function(e){"label"!==e&&"description"!==e&&(c[o][e].divider&&i.divider(),c[o][e].header&&i.header(c[o][e].header),void 0!==t.model.get(o)[e]&&i.option(e,!0,c[o][e].label))}),e.append(new n.CustomCheckboxView({name:"enabled",nodeName:o,label:c[o].label,model:t.models[o]}).render().$el.addClass("main-option "),$('<div class="description">').text(c[o].description),i.$ul.find("a").length>0?i.render().$el:"")}}),l.length&&this.$el.append($('<div class="form-group row">').append($('<div class="col-xs-12">').append($("<label>").attr("for","personaldata-filesizepicker").text(a("Maximum file size")),$('<div class="filepicker-description">').text(a("Archives larger than the selected size will be split into multiple files."))),$('<div class="col-xs-12 col-md-6">').append(new n.SelectView({name:"maxFileSize",id:"personaldata-filesizepicker",model:t.model,list:_(l).map(function(e){return{label:r.fileSize(e),value:e}})}).render().$el.val(l[l.length-1])))),this.status.get("status")){case"NONE":this.$el.append($('<button type="button" class="btn btn-primary">').text(a("Request download")).on("click",function(){o.requestDownload(t.getDownloadConfig(),!0).done(function(){i("success",a("Download requested"))}).fail(i)}));break;case"PENDING":case"RUNNING":case"PAUSED":this.$el.addClass("disabled").find(".checkbox,a").addClass("disabled"),this.$el.find("input,select").attr("aria-disabled",!0).prop("disabled","disabled"),this.$el.append($('<button type="button" class="btn btn-primary">').prop("disabled","disabled").text(a("Request download")));break;case"DONE":this.$el.append($('<button type="button" class="btn btn-primary">').text(a("Request new download")).on("click",function(){h({title:a("Request new download"),text:a("There is currently an archive download available. By requesting a new download the current archive will be deleted and is no longer available."),action:"delete",label:a("Request new download")}).then(function(e){"delete"===e&&o.requestDownload(t.getDownloadConfig(),!0).done(function(){i("success",a("Download requested"))}).fail(i)})}))}return this},getDownloadConfig:function(){var e=this;return _(_(this.models).keys()).each(function(a){e.model.set(a,e.models[a].toJSON())}),this.model.toJSON()}}),m=e.extend({className:"personal-data-download-view row",initialize:function(){var e=this;this.listenTo(o,"updateStatus",function(){o.getAvailableDownloads().always(function(a){a=p(a),e.model.set(a),_(e.model.keys()).each(function(t){_(a).has(t)||e.model.unset(t)}),e.render()})})},render:function(){return this.$el.empty().toggle("NONE"!==this.model.get("status")),this.$el.append($('<h1 class="col-xs-12">').text(a("Your archive"))),"PENDING"!==this.model.get("status")&&"RUNNING"!==this.model.get("status")&&"PAUSED"!==this.model.get("status")||this.$el.append($('<div class="col-xs-12">').text(a("Your requested archive is currently being created. Depending on the size of the requested data this may take hours or days. You will be informed via email when your download is ready.")),$('<button type="button" class="cancel-button btn btn-primary">').text(a("Cancel download request")).on("click",function(){h({title:a("Cancel download request"),text:a("Do you really want to cancel the current download request?"),action:"delete",label:a("Cancel download request")}).then(function(e){"delete"===e&&o.cancelDownloadRequest().fail(i)})})),"DONE"===this.model.get("status")&&this.model.get("results")&&this.model.get("results").length&&this.$el.append($('<label class="col-xs-12">').text(a("Your data archive from %2$s is ready for download. The download is available until %1$s.",moment(this.model.get("availableUntil")).format("L"),moment(this.model.get("creationTime")).format("L"))),$('<ul class="col-xs-12 col-md-8 list-unstyled downloads">').append(_(this.model.get("results")).map(function(e){return $('<li class="file">').append($("<span>").text(e.fileInfo),$('<button type="button" class="btn fa fa-download">').attr("title",a("Download %1$s.",e.fileInfo)).on("click",function(){o.downloadFile(e.taskId,e.number).fail(i)}))}))),this}});return d.has("dataexport")?(l.point("io.ox/settings/pane/personalData").extend({id:"personaldata",title:a("Download personal data"),ref:"io.ox/settings/personalData",index:100}),l.point("io.ox/settings/personalData/settings/detail").extend({id:"select-view",index:100,draw:function(){this.addClass("io-ox-personal-data-settings");var e=this;o.getAvailableModules().then(function(a){o.getAvailableDownloads().always(function(t){t=p(t);var l=l||new Backbone.Model(a),n=new Backbone.Model(t),s=new f({model:l,status:n}),o=new m({model:n});e.append(o.render().$el,s.render().$el)})},i)}}),{handleApiResult:p,downloadView:m,selectDataView:f}):{handleApiResult:p,downloadView:m,selectDataView:f}});