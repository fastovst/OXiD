define("io.ox/files/share/model",["io.ox/files/share/api","io.ox/core/api/group","io.ox/core/yell","gettext!io.ox/core"],function(e,t,i,s){"use strict";return{WizardShare:Backbone.Model.extend({defaults:function(){return{files:[],recipients:[],message:"",edit:!1,secured:!1,password:"",temporary:!1,expires:2,url:"",is_new:!1,includeSubfolders:!0}},idAttribute:"entity",initialize:function(){this.setOriginal()},setOriginal:function(e){this.originalAttributes=e||_.clone(this.attributes)},getChanges:function(){var e=this.originalAttributes,t={};return _(this.attributes).each(function(i,s){_.isEqual(i,e[s])||(t[s]=i)}),_(t).pick("expiry_date","includeSubfolders","password","temporary","secured")},hasChanges:function(){return!_.isEmpty(this.getChanges())},getExpiryDate:function(){var e=moment();switch(this.get("expires")){case 0:return e.add(1,"day").valueOf();case 1:return e.add(1,"week").valueOf();case 2:return e.add(1,"month").valueOf();case 3:return e.add(3,"months").valueOf();case 4:return e.add(6,"months").valueOf();case 5:return e.add(1,"year").valueOf();default:return e.add(1,"month").valueOf()}},toJSON:function(){var e=[],t={};return _(this.get("files")).each(function(t){var i={module:t.get("module")||"infostore"};t.isFolder()&&(i.folder=t.get("id")),t.isFile()&&(i.folder=t.get("folder_id"),i.item=t.get("id")),e.push(i)}),t=e[0],t.includeSubfolders=this.get("includeSubfolders"),this.get("secured")&&""!==this.get("password")?t.password=this.get("password"):t.password=null,t.recipients=[],_(this.get("recipients")).each(function(e){t.recipients.push([e.get("token").label||e.getDisplayName(),e.get("token").value||e.getTarget()])}),0===t.recipients.length&&delete t.recipients,this.get("message")&&""!==this.get("message")&&(t.message=this.get("message")),this.has("url")?(this.get("temporary")?t.expiry_date=this.getExpiryDate():t.expiry_date=null,t):t},sync:function(s,r){var n=this;switch(s){case"read":return e.getLink(this.toJSON()).then(function(e){t.refreshGroup(2147483647);var i=e.data,s=e.timestamp;return n.set(_.extend(i,{lastModified:s}),{_inital:!0}),n.setOriginal(),"includeSubfolders"in i&&(n.originalAttributes.includeSubfolders=i.includeSubfolders),i.url}).fail(function(e){i(e),n.trigger("error:sync","read",e)});case"update":case"create":var a=n.getChanges(),o=r.toJSON();return!1===a.secured?o.password=null:"password"in a||delete o.password,(_.isEmpty(a)?$.when():e.updateLink(o,r.get("lastModified"))).done(function(){t.refreshGroup(2147483647)}).done(this.send.bind(this)).fail(function(e){i(e),n.trigger("error:sync","update",e)})}},send:function(){_.isEmpty(this.get("recipients"))||e.sendLink(this.toJSON()).fail(i)},validate:function(e,t){if("change"!==t._event)return!0===e.secured&&_.isEmpty(e.password)?s("Please set password"):void 0}})}});