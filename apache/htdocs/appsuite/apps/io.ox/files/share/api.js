define("io.ox/files/share/api",["io.ox/core/http","io.ox/core/event","io.ox/files/api","io.ox/core/folder/api"],function(e,t,i,n){"use strict";var s=Backbone.Model.extend({initialize:function(){this.cid=this.isFolder()?"folder."+this.get("id"):_.cid(this.attributes)},isFile:function(){return this.has("folder_id")},isFolder:function(){return!this.has("folder_id")},getFolderModel:function(){var e=this.isFile()?this.get("folder_id"):this.get("id");return n.pool.getModel(e)},isAdmin:function(){return this.isFile()?!!this.get("shareable"):!!("mail"!==this.get("module")||1&this.get("capabilities"))&&(("infostore"!==this.get("module")||-1!==_(this.get("supported_capabilities")).indexOf("permissions"))&&n.Bitmask(this.get("own_rights")).get("admin")>=1)},isExtendedPermission:function(){return this.has("com.openexchange.share.extended"+(this.isFolder()?"Permissions":"ObjectPermissions"))},getOwner:function(){return this.get("created_by")||(n.is("insideDefaultfolder",this.attributes)?ox.user_id:null)},getDisplayName:function(){return this.get("com.openexchange.file.sanitizedFilename")||this.get("filename")||this.get("title")||""},getFolderID:function(){return this.isFolder()?this.get("id"):this.get("folder_id")},getFileType:i.Model.prototype.getFileType,types:i.Model.prototype.types,getExtension:function(){var e=String(this.get("title")||"").split(".");return 1===e.length?"":e.pop().toLowerCase()},getPermissions:function(){return this.isFolder()?this.get("com.openexchange.share.extendedPermissions")||this.get("permissions"):this.get("com.openexchange.share.extendedObjectPermissions")||this.get("object_permissions")},setPermissions:function(e){var t=this.attributes;return this.isFolder()?"com.openexchange.share.extendedPermissions"in t?this.attributes["com.openexchange.share.extendedPermissions"]=e:"permissions"in t&&(this.attributes.permissions=e):"com.openexchange.share.extendedObjectPermissions"in t?this.attributes["com.openexchange.share.extendedObjectPermissions"]=e:"object_permissions"in t&&(this.attributes.object_permissions=e),this},loadExtendedPermissions:function(){function e(e,t){return o.getFileShare(e.pick("id","folder_id"),t).done(function(t){e.set(t)})}function t(e,t){return t.cache&&e.has("com.openexchange.share.extendedPermissions")?$.when():n.get(e.id,{cache:!1}).done(function(t){t=_(t).omit("folder_id"),e.set(t)})}return function(i){return i=_.extend({cache:!0},i),this.isFolder()?t(this,i):e(this,i)}}(),reload:function(){return this.loadExtendedPermissions({cache:!1})}}),o={Model:s,collection:new(Backbone.Collection.extend({model:s})),getLink:function(t){return e.PUT({module:"share/management",params:{action:"getLink",timezone:"UTC"},data:_(t).pick("module","folder","item")}).then(function(e,t){return o.trigger("new:link"),ox.trigger("please:refresh"),{data:e,timestamp:t}})},updateLink:function(t,i){return e.PUT({module:"share/management",params:{action:"updateLink",timezone:"UTC",timestamp:i||_.now()},data:_(t).pick("module","folder","item","expiry_date","includeSubfolders","password")})},sendLink:function(t){return e.PUT({module:"share/management",params:{action:"sendLink"},data:_(t).pick("module","folder","item","recipients","message")})},deleteLink:function(t,i){return e.PUT({module:"share/management",params:{action:"deleteLink",timezone:"UTC",timestamp:i||_.now()},data:_(t).pick("module","folder","item")}).then(function(e){return o.trigger("remove:link",t),o.trigger("remove:link:"+t.module+":"+t.folder+(t.item?":"+t.item:"")),ox.trigger("please:refresh"),e})},all:function(){return $.when(this.allFolderShares(),this.allFileShares()).then(function(e,t){return[].concat(e[0],t[0])})},allFolderShares:function(){return e.GET({module:"folders",params:{action:"shares",content_type:"infostore",tree:0,all:0,altNames:!0,columns:"1,2,5,300,301,302,305,317,3060",timezone:"UTC"}})},allFileShares:function(){return e.GET({module:"files",params:{action:"shares",content_type:"infostore",tree:0,all:0,altNames:!0,columns:"1,2,5,20,109,700,7010",timezone:"UTC"}})},getFolderShare:function(t){var i=["id","created_by","last_modified","title","module","type","own_rights","com.openexchange.share.extendedPermissions"];return e.GET({module:"folders",params:{action:"get",id:t,tree:0}}).then(function(e){return _(e).pick(function(e,t){return i.indexOf(t)>=0})})},getFileShare:function(t,n){return n=_.extend({cache:!0},n),i.get(t).then(function(s){return n.cache&&s["com.openexchange.share.extendedObjectPermissions"]?s:e.PUT({module:"files",params:{action:"list",columns:"7010"},data:[{id:t.id,folder:t.folder_id}]}).then(function(e){var n=i.pool.get("detail").get(_.cid(t));return n.set(e[0]),n.toJSON()})})},get:function(t){return e.GET({module:"share/management",params:{action:"get",timezone:"UTC",token:t}})},revoke:function(e,t){var s;return t.isFolder()?(e.reset(_(t.getPermissions()).where({entity:ox.user_id})),s={permissions:e.toJSON()},n.update(t.get("id"),s)):(s={object_permissions:[],"com.openexchange.share.extendedObjectPermissions":[]},i.update(t.pick("folder_id","id"),s))},resend:function(t,i,n){var s="file"===t?"infostore":"folders",o={action:"notify",id:i};return"folders"===s&&(o.tree=1),e.PUT({module:s,params:o,data:{entities:[n]},appendColumns:!1})}};return t.extend(o),o});