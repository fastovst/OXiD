define("io.ox/files/filepicker",["io.ox/core/cache","io.ox/core/extensions","io.ox/core/tk/selection","io.ox/core/tk/dialogs","io.ox/core/tk/upload","io.ox/core/folder/api","io.ox/core/folder/picker","io.ox/core/viewer/views/sidebar/fileinfoview","io.ox/files/api","io.ox/files/common-extensions","io.ox/core/notifications","io.ox/core/page-controller","io.ox/core/toolbars-mobile","settings!io.ox/core","gettext!io.ox/files","io.ox/files/mobile-navbar-extensions"],function(e,t,i,o,n,l,a,r,s,d,c,f,p,u,v){"use strict";function h(e,t){return s.Model.prototype.isWordprocessing.call(t||null,e)}function g(e,t){return s.Model.prototype.isSpreadsheet.call(t||null,e)}function b(e,t){return s.Model.prototype.isPresentation.call(t||null,e)}function m(e,t){return s.Model.prototype.isPDF.call(t||null,e)}function y(e,t){return s.Model.prototype.isText.call(t||null,e)}function x(e,t){return s.Model.prototype.isZIP.call(t||null,e)}function w(e,t){return s.Model.prototype.isAudio.call(t||null,e)}function k(e,t){return s.Model.prototype.isVideo.call(t||null,e)}function B(e,t){return s.Model.prototype.isEncrypted.call(t||null,e)}function F(e,t){return s.Model.prototype.isSVG.call(t||null,e)}function T(e,t){return s.Model.prototype.isImage.call(t||null,e)}function L(e){var t=e.file_mimetype,i=new s.Model(e);return h(t,i)&&N.doc||g(t,i)&&N.xls||b(t,i)&&N.ppt||m(t,i)&&N.pdf||y(t,i)&&N.txt||F(t,i)&&N.svg||x(t,i)&&N.zip||w(t,i)&&N.audio||k(t,i)&&N.video||B(t,i)&&N.guard||""}function M(e){var t=$('<div class="preview-pane"></div>');return t.insertAfter(e),t}function z(e,i,o){if(o){var n=o.toJSON(),l=t.Baton({model:o,data:n,options:{disableFolderInfo:!0,disableSharesInfo:!0,disableLink:!0}});t.point("io.ox/core/viewer/sidebar/fileinfo").invoke("draw",i,l)}e.append(i)}function A(e,t,i){var o=$('<div class="preview"></div>'),n=$('<div class="fileinfo"><div class="sidebar-panel-body"></div></div>'),l=s.getUrl(t,"thumbnail",{scaleType:"contain",height:140,width:250,version:!1});o.css("background-image","url("+l+")"),e.empty(),e.append(o),z(e,n,i)}function P(e,t,i){var o=$('<div class="preview"></div>'),n=$('<div class="fileinfo"><div class="sidebar-panel-body"></div></div>'),l=$('<div><i class="fa file-type-icon" aria-hidden="true"></i></div>');o.append(l.addClass(L(t))),e.empty(),e.append(o),z(e,n,i)}var N={doc:"file-type-doc",xls:"file-type-xls",ppt:"file-type-ppt",pdf:"file-type-pdf",txt:"file-type-txt",svg:"file-type-svg",zip:"file-type-zip",audio:"file-type-audio",video:"file-type-video",guard:"file-type-guard"};return function(o){function r(e){$('[data-action="ok"]',L.closest(".add-infostore-file")).prop("disabled",!e)}function d(e,t,i){F||(F=M(L));var o=i.file_mimetype,n=new s.Model(i);T(o,n)?A(F,i,n):P(F,i,n)}function h(t){if("virtual/favorites/infostore"===t)return B===t?void j.trigger("folder:changed"):(o.uploadButton&&$('[data-action="alternative"]',L.closest(".add-infostore-file")).prop("disabled",!0),_.device("smartphone")&&E.getNavbar("fileList").setTitle(v("Favorites")),r(!1),L.empty(),s.getList(u.get("favoriteFiles/infostore",[]),{errors:!0,cache:e,onlyAttributes:!0}).then(function(e){b(t,e)}))}function g(e){B!==e?(o.uploadButton&&l.get(e).done(function(e){$('[data-action="alternative"]',L.closest(".add-infostore-file")).prop("disabled",!l.can("create",e))}),_.device("smartphone")&&l.get(e).done(function(e){E.getNavbar("fileList").setTitle(e.title)}).fail(function(){E.getNavbar("fileList").setTitle(v("Files"))}),r(!1),L.empty(),s.getAll(e,{cache:!1,params:{sort:702}}).done(function(t){b(e,t)})):j.trigger("folder:changed")}function b(e,i){if((i=_.chain(i).filter(o.filter).sortBy(o.sorter).value()).length<=0)y();else{var n=i.map(function(e){var i=_.uniqueId("form-control-label-"),n=e["com.openexchange.file.sanitizedFilename"]||e.filename||e.title,l=$('<li class="file selectable">').attr("data-obj-id",_.cid(e)).append($('<label class="checkbox-inline sr-only">').attr({title:n,for:i}).append($('<input type="checkbox" tabindex="-1">').attr("id",i).val(e.id).data("file",e)),$('<div class="name">').text(n));return o.point&&t.point(o.point+"/filelist/filePicker/customizer").invoke("customize",l,e),l});L.append(n)}N.selection.clear(),N.selection.init(i),o.multiselect&&void 0===o.wasLoaded?(N.selection.selectFirst(!0),o.wasLoaded=!0):N.selection.selectFirst(),B=e,j.trigger("folder:changed")}function m(e){var t,i=e.data.dialog,l=e.data.tree;t=n.createQueue({start:function(){i.busy()},progress:function(e){var t=e.options;return s.upload({file:e.file,filename:t.filename,folder:t.folder,timestamp:_.now()}).then(function(t){e.data=t},function(e){throw e&&e.data&&e.data.custom&&c.yell(e.data.custom.type,e.data.custom.text),e})},stop:function(e,t,n){var l=_(n).map(function(e){return s.get(e.data)});$.when.apply(this,l).then(function(){var e=_(arguments).filter(o.filter);e.length>0?(z.resolve(e),i.close()):(c.yell("error",v.ngettext("The uploaded file does not match the requested file type.","None of the uploaded files matches the requested file type.",n.length)),i.idle())},c.yell)}}),_(e.target.files).each(function(e){t.offer(e,{folder:l.selection.get(),filename:e.name})})}function y(){F&&(F.remove(),F=null)}function x(){this.$footer.find("button").first().focus()}function w(){var e=$(window).height()-200;C.css("height",e).find(".modal-body").css("height",e)}o=_.extend({filter:function(){return!0},sorter:function(){},header:v("Add files"),primaryButtonText:v("Save"),multiselect:!0,width:.8*window.innerWidth>1300?1300:Math.round(.8*window.innerWidth),uploadButton:!1,uploadButtonText:v("Upload local file"),tree:{filter:$.noop},acceptLocalFileType:"",cancel:$.noop,close:$.noop,initialize:$.noop,createFolderButton:!0,extension:"io.ox/files/mobile/navbar"},o);var k,B,F,L=$('<ul class="io-ox-fileselection list-unstyled">'),z=$.Deferred(),N=this,I=$('<div class="mobile-toolbar">'),S=$('<div class="mobile-navbar">'),C=$('<div class="picker-pc-container">'),E=new f({appname:"filepicker",toolbar:I,navbar:S,container:C,disableAnimations:!0}),V=$(window).height()-200,j=_.extend({},Backbone.Events),q=!_.device("smartphone");return E.addPage({name:"folderTree",navbar:new p.NavbarView({title:v("Folders"),extension:o.extension}),startPage:!0}),E.addPage({name:"fileList",navbar:new p.NavbarView({title:v("Files"),extension:o.extension})}),E.setBackbuttonRules({fileList:"folderTree"}),E.getNavbar("fileList").setLeft(v("Folders")),E.getNavbar("fileList").on("leftAction",function(){E.goBack({disableAnimations:!0})}),i.extend(this,L,{markable:!0}),this.selection.keyboard(L,!0),this.selection.setMultiple(o.multiselect),o.multiselect?(this.selection.setEditable(!0,".checkbox-inline"),L.addClass("multiselect")):L.addClass("singleselect"),r(!1),this.selection.on("change",function(e,t){r(t.length>0),L.find("input[type=checkbox]").prop("checked",!1),t.forEach(function(e){L.find('li.file[data-obj-id="'+_.cid(e)+'"] input').prop("checked",!0)})}),q&&(this.selection.on("mark",d),this.selection.on("select",d)),a({addClass:"zero-padding add-infostore-file",button:o.primaryButtonText,alternativeButton:o.uploadButton?o.uploadButtonText:null,height:_.device("desktop")?350:V,module:"infostore",persistent:"folderpopup/filepicker",root:"9",settings:u,title:o.header,width:o.width,async:!0,abs:!1,folder:o.folder||void 0,hideTrashfolder:o.hideTrashfolder||void 0,createFolderButton:o.createFolderButton,disable:function(e){return!!/^virtual\//.test(e.id)&&"virtual/favorites/infostore"!==e.id},done:function(e,t){z.resolve(_(L.find("li.selected input")).map(function(e){return $(e).data("file")})),t.close()},filter:o.tree.filter,initialize:function(e,t){if(o.uploadButton&&(k=$('<input name="file" type="file" class="file-input">').attr("multiple",o.multiselect).attr("accept",o.acceptLocalFileType).hide().on("change",{dialog:e,tree:t},m)),_.device("desktop"))e.$body.append(L),L.on("dblclick",".file",function(){var t=$("input",this).data("file");t&&(z.resolve([t]),e.close())});else if(_.device("!smartphone"))e.$body.append(L),e.$body.css({overflowY:"hidden"}),L.on("dblclick",".file",function(){var t=$("input",this).data("file");t&&(z.resolve([t]),e.close())});else{var i=e.$body.parent();E.getPage("fileList").append(L),E.getPage("folderTree").append(e.$body),C.css("height",V+"px"),C.append(S,I),C.insertAfter(e.$header,i),$(window).on("resize",w),e.on("close",function(){$(window).off("resize",w)}),e.$body.on("click","li .folder.selectable.open, li.folder.selectable.favorites",function(e){$(e.target).closest(".folder-arrow").length||E.changePage("fileList",{disableAnimations:!0})})}x.call(e),t.once("change",x.bind(e)),t.on("change",g),t.on("virtual",h),o.initialize(e)},alternative:function(e){e.idle(),k&&k.trigger("click")},cancel:o.cancel,close:function(){_.isFunction(o.close)&&o.close(),"pending"===z.state()&&z.reject()}}),z.promise()}});