define("io.ox/files/upload/main",["io.ox/files/api","io.ox/core/extensions","io.ox/core/notifications","io.ox/core/tk/upload","gettext!io.ox/files"],function(e,t,o,i,a){"use strict";var n=[{limit:1e3,message:function(e){return a.format(a.ngettext("%1$d second","%1$d seconds",e),e)}},{limit:60,message:function(e){return a.format(a.ngettext("%1$d minute","%1$d minutes",e),e)}},{limit:60,message:function(e){return a.format(a.ngettext("%1$d hour","%1$d hours",e),e)}},{limit:24,message:function(e){return a.format(a.ngettext("%1$d day","%1$d days",e),e)}},{limit:7,message:function(e){return a.format(a.ngettext("%1$d week","%1$d weeks",e),e)}}],s=Backbone.Model.extend({defaults:{file:null,progress:0,request:null,loaded:0,abort:!1}}),r=Backbone.Collection.extend({model:s});return t.point("io.ox/files/upload/toolbar").extend({draw:function(e){this.append($('<div class="upload-title">').append($('<div class="estimated-time">'),$('<div class="file-name">')),$('<div class="upload-details">').append($("<a href=#>").text(a("Details")).click(function(e){e.preventDefault(),require(["io.ox/files/upload/view"],function(e){e.show()})})),$('<div class="upload-cancel">').append($("<a href=#>").text(a("Cancel")).click(function(t){t.preventDefault(),e.fileupload.abort()})),$('<div class="progress">').append($('<div class="progress-bar progress-bar-striped active">').attr({role:"progressbar","aria-valuenow":"0","aria-valuemin":"0","aria-valuemax":"100"}).css({width:"0%"}).append($('<span class="sr-only">').text(a("%1$s completed","0%")))))}}),new function(){function l(){var e=(new Date).getTime()-u,t=e/Math.min(1,v/g)-e||0,o=0;do{t=Math.round(t/n[o].limit),o++}while(o<n.length&&n[o].limit<t);return n[o-1].message(t)||0}function d(e){v-=e.get("loaded"),g-=e.get("file").size,h.remove(e)}var u,p,c,f,m=0,g=0,v=0,h=new r,b=this,x=e;x.on("add:imp_version",function(e){o.yell("info",a('A new version for "%1$s" has been added.',e))}),this.calculateTotalSíze=function(){h.each(function(e){g+=e.get("file").size})},this.changed=function(e,t,o){var i=o.slice(h.length,o.length).map(function(e){var t={file:e.file,progress:0};return e.options&&e.options.id&&(t.id=e.options.id),new s(t)});0===h.length&&(u=(new Date).getTime()),h.add(i),this.calculateTotalSíze()},this.progress=function(e,t,i){var a=h.at(t),n=x.upload(_.extend({file:e.file},e.options)).progress(function(e){var o=e.loaded/e.total;if(a){var n=a.get("loaded");a.set({progress:o,loaded:e.loaded}),v+=e.loaded-n}m=(t+o)/i.length,h.trigger("progress",{progress:m,estimatedTime:l()})}).fail(function(e){a.set({abort:!0}),d(a),e&&e.data&&e.data.custom&&"0 abort"!==e.error&&o.yell(e.data.custom.type,e.data.custom.text)});return h.at(t).set({request:n}),n},this.stop=function(){var e=h.pluck("request");g=0,x.trigger("stop:upload",e),x.trigger("refresh.all"),m=0,v=0,h.each(function(e){1!==e.get("progress")&&e.set("abort",!0)}),h.reset()},this.getTotalProgress=function(){return m},this.getEstimatedTime=l,this.abort=function(e){h.filter(function(t){return void 0!==t&&(void 0===e||t.cid===e)}).forEach(function(e){var t=e.get("request");null===t?(e.set({abort:!0}),d(e)):"pending"===t.state()&&t.abort()})},this.collection=h,h.on("progress",function(e){var t=$(".upload-wrapper"),o=t.find(".progress-bar"),i=t.find(".sr-only"),n=Math.round(100*e.progress);o.attr({"aria-valuenow":n}).css({width:n+"%"}),i.text(a("%1$s completed",n+"%")),t.find(".estimated-time").text(a("Remaining time: %1$s",e.estimatedTime))}).on("remove",function(e,t,o){b.create.remove(o.index)}),this.setWindowNode=function(e){c=e.find(".toolbar.bottom"),0===(f=e.find(".list-view-control")).length&&(f=e)},this.setAPI=function(e){x=e},this.create=i.createQueue(this).on("start",function(){f.addClass("toolbar-bottom-visible"),p=$('<div class="upload-wrapper">'),t.point("io.ox/files/upload/toolbar").invoke("draw",p,t.Baton({fileupload:this})),c.append(p)}.bind(this)).on("progress",function(e,t,o){$(".upload-wrapper").find(".file-name").text(a('Uploading "%1$s"',o.file.name))}).on("stop",function(){f.removeClass("toolbar-bottom-visible"),p&&p.remove()}),this.update=i.createQueue(_.extend({},this,{progress:function(e,t,i){var a=h.at(t),n=x.versions.upload({file:e.file,id:e.options.id,folder:e.options.folder,timestamp:_.then(),params:e.options.params,version_comment:e.options.version_comment}).progress(function(e){var o=e.loaded/e.total;if(a){var n=a.get("loaded");a.set({progress:o,loaded:e.loaded}),v+=e.loaded-n}m=(t+o)/i.length,h.trigger("progress",{progress:m,estimatedTime:l()})}).fail(function(e){a.set({abort:!0}),d(a),e&&e.data&&e.data.custom&&"0 abort"!==e.error&&o.yell(e.data.custom.type,e.data.custom.text)});return h.at(t).set({request:n}),n}})).on("start",function(){f.addClass("toolbar-bottom-visible"),p=$('<div class="upload-wrapper">'),t.point("io.ox/files/upload/toolbar").invoke("draw",p,t.Baton({fileupload:this})),c.append(p)}.bind(this)).on("progress",function(e,t,o){$(".upload-wrapper").find(".file-name").text(a('Uploading "%1$s"',o.file.name))}).on("stop",function(){f.removeClass("toolbar-bottom-visible"),p&&p.remove()})}});