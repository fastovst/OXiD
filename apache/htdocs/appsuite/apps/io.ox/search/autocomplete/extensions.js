define("io.ox/search/autocomplete/extensions",["io.ox/core/extensions","io.ox/contacts/api","io.ox/core/util","settings!io.ox/contacts","gettext!io.ox/core","io.ox/core/tk/tokenfield","less!io.ox/search/style","less!io.ox/find/style"],function(e,t,a,i,n,o){"use strict";var l="io.ox/search/autocomplete";return{searchfield:function(){_.device("smartphone")&&this.append($('<input type="text" class="form-control search-field">'))},tokenfield:function(t){var a,r=t.model,d=t.app.view,c=this.parent(),s=new o({extPoint:l,id:"search-field-mobile",placeholder:n("Search")+"...",className:"search-field",delayedautoselect:!0,inputtype:"search",dnd:!1,hint:!1,allowEditing:!1,createTokensOnBlur:!1,customDefaultModel:!0,delimiter:"",maxResults:20,minLength:Math.max(1,i.get("search/minimumQueryLength",1)),autoselect:!0,source:t.app.apiproxy.search,reduce:function(e){return e.list},suggestion:function(a){var i=$('<div class="autocomplete-item">'),n=a.model;t=e.Baton.ensure({data:n.get("value")}),i.addClass(t.data.facet);var o=e.point(l+"/item/"+t.data.facet);return o.list().length?o.invoke("draw",i,t):e.point(l+"/item").invoke("draw",i,t),i},harmonize:function(e){var t=[],a=Backbone.Model.extend({getDisplayName:function(){var e=this.get("value");return e.item&&e.item.name?e.item.name:e.name||" "}});return _.each(e,function(e){e.hasPersons=function(){return["contacts","contact","participant","task_participants"].indexOf(this.id)>-1},_.each(e.values||[e],function(i){var n=$.extend({},i,{facet:e.id}),o=new a({facet:e,value:n,data:{value:e.item}});t.push({label:o.getDisplayName(),value:n.id,model:o})})}),t},click:function(t,a){var i=e.Baton.ensure({deferred:$.Deferred().resolve(),view:d,model:r,token:{label:a.label,value:a.value,model:a.model}});e.point(l+"/handler/click").invoke("flow",this,i)}});this.find(".search-field").replaceWith(s.$el),s.render();var p=function(e){var t=$(".token-input.tt-input"),i=t.closest(".io-ox-search");if(!(e&&"input"!==e.type||t.val()))return i.addClass("empty"),$(".tokenfield > .twitter-typeahead").show(),void a.copyhelper.prop("disabled",!1);"tokenfield:createdtoken"===e.type&&($(".tokenfield > .twitter-typeahead").hide(),a.copyhelper.prop("disabled",!0)),i.removeClass("empty")};(a={copyhelper:s.$el.data("bs.tokenfield").$copyHelper||$(),field:s.input.prop("autofocus",!0)}).field.on({"change input":p}),s.$el.on("tokenfield:createdtoken tokenfield:removedtoken",p),s.$el.on("tokenfield:removedtoken",function(e){var t=e.attrs.model,a=t.get("facet")._compact||t.get("value");r.remove(a.facet,a.value||a.id)});var u=function(e){e&&e.preventDefault(),a.field.parent().find(".token-input").val(""),a.field.typeahead("close");var t=s.$el.tokenfield("getTokens");_.each(t,function(e){s.$el.trigger($.Event("tokenfield:removetoken",{attrs:e}))}),s.$el.tokenfield("setTokens",[],!1,!1),_.each(t,function(e){s.$el.trigger($.Event("tokenfield:removedtoken",{attrs:e}))}),p()};return t.model.on("reset",u),c.find(".btn-clear").on("click",u),c.find(".btn-search").on("click",function(e){return e.preventDefault(),$(".token-input.tt-input").focus(),!1}),this},styleContainer:function(e){e.$.container&&"width: 100%;"!==e.$.container.attr("style")&&e.$.container.attr("style","width: 100%;")},image:function(e){if(this.is(".contacts, .contact, .participant, .task_participants")){var i=t.getFallbackImage();this.removeClass("indent"),i=(e.data.item&&e.data.item.image_url?e.data.item.image_url+"&height=42&scaleType=contain":i).replace(/^https?:\/\/[^/]+/i,""),i=a.replacePrefix(i,ox.apiRoot),this.append($('<div class="image">').css("background-image","url("+i+")"))}},name:function(e){var t=(e.data.item&&e.data.item.name?e.data.item.name:e.data.name)||" ";this.data(e.data).append($('<div class="name">').text(t))},detail:function(e){var t=e.data.item&&e.data.item.detail&&e.data.item.detail.length?e.data.item.detail:void 0;this.is(".contacts, .contact, .participant, .task_participants")?(this.removeClass("indent"),this.append($('<div class="detail">').text(t||" "))):t&&this.find(".name").append($("<i>").text(" "+t))},a11y:function(){var e=this.find(".name").text()+" "+this.find(".detail").text();this.attr("aria-label",e)},select:function(e){e.data.deferred.done(function(){var t,a=e.data.token.model.get("value");t=_.find(a.options,function(e){return e.id===a.id}),e.data.model.add(a.facet,a.id,(t||{}).id)})}}});