define("io.ox/editor/main",["io.ox/files/api","io.ox/core/folder/api","io.ox/core/notifications","gettext!io.ox/editor","less!io.ox/editor/style"],function(e,t,i,n){"use strict";var o=Backbone.View.extend({className:"io-ox-editor container default-content-padding abs",events:{"submit form":"onSubmit","keydown .title":"onTitleKeydown","keyup .title":"onTitleKeyup","keydown .content":"onContentKeydown"},onSubmit:function(e){e.preventDefault()},onTitleKeydown:function(e){13===e.which&&(e.preventDefault(),this.focus())},onTitleKeyup:function(){this.trigger("keyup:title",this.getTitle())},onContentKeydown:function(e){13===e.which&&e.ctrlKey&&(e.preventDefault(),this.app.save())},onSave:function(e){e.preventDefault(),this.app.save()},onQuit:function(e){e.preventDefault(),this.app.quit()},initialize:function(e){this.app=e.app,this.data={saved:{filename:null}},this.model.on("change:title",this.updateTitle,this),this.model.on("change:content",this.updateContent,this)},updateTitle:function(){this.data.saved.filename=this.model.get("filename"),this.$el.find("input.title").val(this.model.get("filename"))},updateContent:function(){this.$el.find("textarea").val(this.model.get("content"))},updateModel:function(){var e=this.getFilename();this.model.set({title:e,filename:e,content:this.getContent()})},getTitle:function(){return $.trim(this.$el.find("input.title").val())},getFilename:function(){var e=this.getTitle(),t=this.app.options.params&&this.app.options.params.allowedFileExtensions?new RegExp("\\.("+this.app.options.params.allowedFileExtensions.join("|")+"?)$","i"):new RegExp("\\.\\w{1,4}$"),i=String(e||this.getContent().substr(0,20).split(".")[0].replace(/(\r\n|\n|\r)/gm,"").replace(/[%&#/$*!`Â´'"=:@+^\\.+?{}|]/g,"_")||"unnamed");return t.test(i)||(i+=".txt"),i},getContent:function(){return this.$el.find("textarea").val()},focus:function(){this.$el.find("textarea").focus()},busy:function(){this.$el.find("input.title").prop("disabled",!0),this.app.getWindow().nodes.outer.find("button.save").prop("disabled",!0).empty().append($('<i class="fa fa-refresh fa-spin" aria-hidden="true">'))},idle:function(){this.$el.find("input.title").prop("disabled",!1),this.app.getWindow().nodes.outer.find("button.save").prop("disabled",!1).text(n("Save"))},render:function(){var e=_.uniqueId("editor_title-"),t=_.uniqueId("editor_body-"),i=this;return this.$el.append($("<form>").append($('<div class="row">').append($('<div class="form-group col-xs-12">').append($('<label class="sr-only">').attr("for",e).text(n("Title")),$('<input type="text" maxlength="350" class="title form-control">').attr({id:e,placeholder:n("Enter document title here")}))),$('<div class="body row">').append($('<div class="col-md-12">').append($('<label class="sr-only">').attr("for",t).text(n("Note")),$('<textarea class="content form-control">').attr("id",t).val("").attr("placeholder",_.device("ios || android")?"":n("You can quick-save your changes via Ctrl+Enter.")))))),this.app.getWindow().setHeader($("<div>").append($('<button type="button" class="save btn btn-primary">').text(n("Save")).on("click",i.onSave.bind(i)),$('<button type="button" class="quit btn btn-default">').text(n("Close")).on("click",i.onQuit.bind(i)))),this}});return{getApp:function(){var a,l,d,r=new e.Model,s={};return(a=ox.ui.createApp({name:"io.ox/editor",title:"Editor",closable:!0,floating:!1})).setLauncher(function(e){a.setWindow(l=ox.ui.createWindow({name:"io.ox/editor",title:n("Editor"),chromeless:!0,floating:_.device("!smartphone"),closable:!0})),a.view=d=new o({model:r,app:a}),l.nodes.main.append(a.view.render().$el),window.view=d,"id"in e?a.load({folder_id:e.folder,id:e.id,params:e.params}):_.url.hash("id")?a.load({folder_id:_.url.hash("folder"),id:_.url.hash("id"),params:e.params}):a.create(),l.setTitle(n("Editor")),d.on("keyup:title",function(e){a.setTitle(e||n("Editor"))})}),a.create=function(e){var i=e||{};i.folder=i.folder||i.folder_id||t.getDefaultFolder("infostore"),r.set(s={filename:"",folder_id:i.folder,title:"",content:""}),_.extend(s,{filename:"unnamed.txt",title:"unnamed.txt"}),l.on("show",function(){a.setState({folder:i.folder,id:null})}),l.show(function(){_.device("!smartphone")&&d.focus()}),i.params&&(this.options.params=i.params)},a.save=function(){var o=function(){return r.hasWritePermissions().then(function(e){return e?$.when():t.get(r.get("folder_id")).done(function(e){if(r.has("id")&&!t.can("write",e)||!r.has("id")&&!t.can("create",e)||_.contains(["14","15"],e.id)){var o=t.getDefaultFolder("infostore");o&&(r.set("folder_id",o),r.unset("id"),i.yell("info",n("This file will be written in your default folder to allow editing")))}})})};return require(["io.ox/files/util"]).then(function(e){return $.when(e.confirmDialog(a.view.getFilename(),a.view.data.saved.filename),o())}).then(function(){var t,n;if(d.updateModel(),n=r.toJSON(),t=new window.Blob([n.content],{type:"text/plain"}),delete n.content,d.busy(),r.has("id")){var o={};return(n.meta&&n.meta.Encrypted||n.filename.lastIndexOf(".pgp")===n.filename.length-4)&&(o={cryptoAction:"Encrypt"}),e.versions.upload({id:n.id,folder:n.folder_id,file:t,filename:n.filename,params:o}).done(function(){s=r.toJSON()}).always(function(){d.idle()}).fail(i.yell).fail(function(e){"IFO-0300"===e.code&&r.unset("id")})}return e.upload({folder:n.folder_id,file:t,filename:n.filename}).done(function(e){delete e.content,a.setState({folder:e.folder_id,id:e.id}),r.set(e),s=r.toJSON(),d.idle()}).always(function(){d.idle()}).fail(i.yell)},function(){throw d.idle.apply(a.view),arguments})},a.setData=function(e){a.setState({folder:e.folder_id,id:e.id});var t=e.title||n("Editor");l.setTitle(t),a.setTitle(t),r.set(e)},a.load=function(t){var n=$.Deferred();return a.cid="io.ox/editor:edit."+_.cid(t),l.on("show",function(){a.setState({folder:t.folder_id,id:t.id})}),l.show(function(){l.busy(),$.when(e.get(t).fail(i.yell),$.ajax({type:"GET",url:e.getUrl(t,"view",t)+"&"+_.now(),dataType:"text"})).done(function(e,i){l.idle(),_.extend(e,_(t).pick("id","folder_id"),{content:i[0]}),a.setData(s=e),d.$el.find("textarea").prop("selectionEnd",0),_.device("!smartphone")&&d.focus(),n.resolve()}).fail(l.idle).fail(n.reject)}),n},a.destroy=function(){d.remove(),a=l=a.view=d=d.app=r=s=null},a.isDirty=function(){return d.updateModel(),!_.isEqual(r.toJSON(),s)},a.setQuit(function(){var e=$.Deferred();return a.isDirty()?require(["io.ox/backbone/views/modal"],function(t){a.getWindow().floating?a.getWindow().floating.toggle(!0):_.device("smartphone")&&a.getWindow().resume(),new t({title:n("Do you really want to discard your changes?")}).addCancelButton().addButton({label:n.pgettext("dialog","Discard changes"),action:"quit"}).on("quit",e.resolve).on("cancel",e.reject).open()}):e.resolve(),e.done(function(){a.destroy()})}),a.failSave=function(){if(!a||!a.view)return!1;var e=a.view.getTitle();r.set({title:e,filename:e,content:a.view.getContent()});var t=r.toJSON();return{description:n("File")+(e?": "+e:""),module:"io.ox/editor",point:t}},a.failRestore=function(e){return l.show(function(){a.setData(e)})},a},reuse:function(e){return ox.ui.App.reuse("io.ox/editor:edit."+_.cid(e))}}});