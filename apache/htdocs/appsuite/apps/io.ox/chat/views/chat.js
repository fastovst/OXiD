define("io.ox/chat/views/chat",["io.ox/backbone/views/disposable","io.ox/chat/views/avatar","io.ox/chat/views/chatAvatar","io.ox/chat/views/chatMember","io.ox/chat/events","io.ox/chat/data"],function(e,t,s,i,n,a){"use strict";return e.extend({className:"chat",events:{"keydown textarea":"onEditorKeydown","input textarea":"onEditorInput"},initialize:function(e){this.room=e.room,this.model=a.chats.get(this.room),this.listenTo(this.model,{"change:title":this.onChangeTitle}),this.listenTo(this.model.messages,{add:this.onAdd,remove:this.onRemove,"change:body":this.onChangeBody,"change:time":this.onChangeTime,"change:delivery":this.onChangeDelivery}),this.model.messages.fetch(),this.typing={$el:$('<div class="typing">'),timer:{},show:function(e){var t=a.users.get(e);t&&!t.isMyself()&&(this.reset(e),this.span(e).length||this.add(e,t.getName()),this.timer[e]=setTimeout(this.hide.bind(this),5e3,e))},span:function(e){return this.$el.find('[data-user-id="'+e+'"]')},reset:function(e){this.timer[e]&&(window.clearTimeout(this.timer[e]),delete this.timer[e])},add:function(e,t){this.$el.append($('<div class="name">').attr("data-user-id",e).text(t+" is typing"))},hide:function(e){this.reset(e),this.span(e).remove()},toggle:function(e,t){t?this.show(e):this.hide(e)}},this.listenTo(n,"typing:"+this.model.id,function(e,t){this.typing.toggle(e,t)}),this.$messages=$(),this.$editor=$()},render:function(){return this.$el.append($('<div class="header abs">').append(new s({model:this.model}).render().$el,this.model.isPrivate()?this.renderTitle().addClass("flex-grow"):$('<div class="flex-grow">').append(this.renderTitle().addClass("small-line"),new i({collection:this.model.members}).render().$el),$('<div class="dropdown pull-right">').append($('<button type="button" class="btn btn-default btn-circle dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">').append('<i class="fa fa-bars" aria-hidden="true">'),this.renderDropdown())),$('<div class="scrollpane abs">').append($('<div class="conversation">').append(this.$messages=$('<div class="messages">').append(this.model.messages.last(20).map(this.renderMessage,this)),this.typing.$el)),$('<div class="controls abs">').append(this.$editor=$('<textarea class="form-control" placeholder="Enter message here">'))),this},renderDropdown:function(){function e(e,t){return $("<li>").append($('<a href="#" role="button">').attr(t).text(e))}var t=$('<ul class="dropdown-menu">');return this.model.isGroup()&&t.append(e("Add member",{"data-cmd":"add-member","data-id":this.model.id})),t.append(e("Close chat",{"data-cmd":"close-chat","data-id":this.model.id})),t},renderTitle:function(){return $('<h2 class="title">').append(this.model.getTitle()||" ")},renderMessage:function(e){return $('<div class="message">').attr("data-cid",e.cid).addClass(e.isSystem()?"system":e.get("type")).toggleClass("myself",e.isMyself()).append(this.renderSender(e),$('<div class="body">').addClass().html(e.getBody()),$('<div class="time">').text(e.getTime()),$('<div class="fa delivery">').addClass(e.get("delivery")))},renderSender:function(e){if(e.isSystem()||e.isMyself()||e.hasSameSender())return $();var s=a.users.get(e.get("senderId"));return[new t({model:s}).render().$el,$('<div class="sender">').text(s.getName())]},scrollToBottom:function(){this.$(".scrollpane").scrollTop(65535),this.model.set("unseen",0)},onEditorKeydown:function(e){13===e.which&&(e.preventDefault(),this.onPostMessage(this.$editor.val()),this.$editor.val("").focus())},onEditorInput:function(){var e=""!==this.$editor.val();a.socket.emit("typing",{roomId:this.model.id,state:e})},onPostMessage:function(e){this.model.postMessage({body:e})},onChangeTitle:function(e){this.$(".title").text(e.getTitle()||" ")},onAdd:_.debounce(function(e,t,s){this.$messages.append(s.changes.added.map(this.renderMessage.bind(this)));var i=this.$messages.children();i.length>20&&i.slice(0,i.length-20).remove(),this.scrollToBottom()},1),getMessageNode:function(e,t){return this.$('.message[data-cid="'+e.cid+'"] '+(t||""))},onRemove:function(e){this.getMessageNode(e).remove()},onChangeBody:function(e){this.getMessageNode(e,".body").html(e.getBody())},onChangeTime:function(e){this.getMessageNode(e,".time").text(e.getTime())},onChangeDelivery:function(e){this.getMessageNode(e,".delivery").attr("class","fa delivery "+e.get("delivery"))}})});