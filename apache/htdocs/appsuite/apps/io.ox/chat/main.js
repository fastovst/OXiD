define("io.ox/chat/main",["io.ox/chat/data","io.ox/chat/events","io.ox/backbone/views/window","io.ox/chat/views/empty","io.ox/chat/views/chat","io.ox/chat/views/chatList","io.ox/chat/views/channelList","io.ox/chat/views/history","io.ox/chat/views/fileList","io.ox/chat/views/search","io.ox/chat/views/searchResult","io.ox/contacts/api","io.ox/chat/socket","less!io.ox/chat/style"],function(e,t,a,i,n,s,o,c,h,l,r,d){"use strict";function u(){return $('<div class="overlay abs" tabindex="-1">').append($('<button type="button" data-cmd="prev-file"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>'),$('<button type="button" data-cmd="next-file"><i class="fa fa-chevron-right" aria-hidden="true"></i></button>'),$('<button type="button" data-cmd="close-file"><i class="fa fa-close" aria-hidden="true"></i></button>'))}var p=a.View.extend({events:function(){return _.extend(a.View.prototype.events,{"keydown .left-navigation":"onLeftNavigationKeydown","keydown .overlay":"onOverlayEvent","click .overlay":"onOverlayEvent"})},initialize:function(){a.View.prototype.initialize.apply(this,arguments),this.listenTo(e.chats,"unseen",function(e){this.setCount(e)}),this.listenTo(t,"cmd",this.onCommand)},setCount:function(e){this.model.set("count",e)},onCommand:function(e){switch(e.cmd){case"start-chat":this.startChat(e);break;case"start-private-chat":this.startPrivateChat(e);break;case"join-channel":this.joinChannel(e);break;case"show-chat":this.showChat(e.id||e.cid);break;case"show-recent-conversations":this.showRecentConversations();break;case"show-channels":this.showChannels();break;case"show-all-files":this.showAllFiles();break;case"show-file":this.showFile(e);break;case"prev-file":this.moveFile(-1);break;case"next-file":this.moveFile(1);break;case"close-file":this.closeFile();break;case"open-chat":this.toggleChat(e.id,!0);break;case"close-chat":this.toggleChat(e.id,!1);break;case"add-member":this.addMember(e.id)}},startChat:function(){require(["io.ox/contacts/addressbook/popup"],function(t){t.open(function(t){var a=_(t).pluck("user_id");e.chats.create({type:"group",members:a})},{help:!1,build:function(){this.$el.addClass("ox-chat-popup")},useGABOnly:!0,title:"Start new conversation",button:"Start conversation"})})},startPrivateChat:function(t){e.chats.create({type:"private",members:[t.id]}).done(function(e){this.showChat(e.id)}.bind(this))},joinChannel:function(t){e.chats.joinChannel(t.id),this.showChat(t.id)},showChat:function(e){var t=new n({room:e});this.$rightside.empty().append(t.render().$el),t.scrollToBottom()},showRecentConversations:function(){this.$rightside.empty().append((new c).render().$el)},showChannels:function(){this.$rightside.empty().append((new o).render().$el)},showAllFiles:function(){this.$rightside.empty().append((new h).render().$el)},showFile:function(e){u().appendTo(this.$body).focus(),this.updateFile(e.index)},moveFile:function(t){var a=parseInt(this.$(".overlay").attr("data-index"),10)+t,i=e.files.length;a<0?a=i-1:a>=i&&(a=0),this.updateFile(a)},updateFile:function(t){this.$(".overlay").attr("data-index",t).find("img").remove().end().append($("<img>",{alt:"",src:e.files.at(t).getPreviewUrl()}))},closeFile:function(){this.$(".overlay").remove(),this.$el.focus()},onLeftNavigationKeydown:function(e){if(38===e.which||40===e.which){e.preventDefault();var t=this.$(".left-navigation [data-cmd]"),a=t.index(document.activeElement)+(38===e.which?-1:1);a=Math.max(0,Math.min(a,t.length-1)),t.eq(a).focus().click()}},onOverlayEvent:function(e){if("click"===e.type&&$(e.target).is(".overlay")||27===e.which)return this.closeFile();37!==e.which&&39!==e.which||this.moveFile(37===e.which?-1:1)},toggleChat:function(t,a){var i=e.chats.get(t);i&&(i.toggle(a),a?this.showChat(t):this.$rightside.empty())},addMember:function(t){var a=e.chats.get(t);a&&require(["io.ox/contacts/addressbook/popup"],function(e){e.open(function(e){var t=_(e).pluck("user_id");a.addMembers(t)},{help:!1,build:function(){this.$el.addClass("ox-chat-popup")},useGABOnly:!0,title:"Add members",button:"Add"})})}});e.fetchUsers().done(function(){var t=new p({title:"OX Chat"}).render().open(),a=e.users.get(e.user_id);t.$body.addClass("ox-chat").append($('<div class="leftside abs">').append($('<div class="header">').append(d.pictureHalo($('<div class="picture" aria-hidden="true">'),{internal_userid:e.user_id},{width:40,height:40}),$('<button type="button" class="btn btn-default btn-circle" data-cmd="start-chat"><i class="fa fa-plus"></i></button>'),$('<i class="fa state online fa-check-circle">'),$('<div class="name">').text(a.getName())),(new l).render().$el,$('<div class="left-navigation abs">').append((new r).render().$el,new s({collection:e.chats}).render().$el,$('<div class="navigation">').append($('<button type="button" class="btn-nav" data-cmd="show-recent-conversations">').append($('<i class="fa fa-clock-o btn-icon">'),$.txt("Recent conversations")),$('<button type="button" class="btn-nav" data-cmd="show-channels">').append($('<i class="fa fa-hashtag btn-icon">'),$.txt("All channels")),$('<button type="button" class="btn-nav" data-cmd="show-all-files">').append($('<i class="fa fa-paperclip btn-icon">'),$.txt("All files"))))),t.$rightside=$('<div class="rightside abs">').append((new i).render().$el))}),ox.chat={data:e}});