define("io.ox/chat/data",["io.ox/chat/events","io.ox/contacts/api","static/3rd.party/socket.io.slim.js"],function(e,t,n){"use strict";function s(e){return i([e])}function i(e){return r(_(e).map(function(e){var t=u.users.get(e);return'<span class="name">'+(t?t.getName():"Unknown user")+"</span>"}).sort())}function r(e){return e.length<=2?e.join(" and "):e.slice(0,-1).join(", ")+", and "+e[e.length-1]}var o=parseInt(_.url.hash("chatUser"),10)||ox.user_id,a=_.url.hash("chatHost"),u={API_ROOT:"https://"+a+"/api/"+o,SOCKET:"https://"+a,user_id:o},c=Backbone.Model.extend({isSystem:function(){return 0===this.get("id")},isMyself:function(){return this.get("id")===u.user_id},getName:function(){var e=$.trim(this.get("first_name")),t=$.trim(this.get("last_name"));return e&&t?e+" "+t:e||t||" "},getState:function(){return this.get("state")||"offline"},fetchState:function(){this.has("state")||$.get({url:u.API_ROOT+"/users/"+this.get("id")+"/state"}).done(function(e){this.set("state",e)}.bind(this))}}),m=Backbone.Collection.extend({model:c});u.users=new m([]),u.fetchUsers=function(){return t.getAll({folder:6,columns:"501,502,524,570"},!1).then(function(e){return e=_(e).map(function(e){return{id:e.internal_userid,first_name:e.first_name,last_name:e.last_name,image:!!e[570]}}),u.users.reset(e)})};var d=Backbone.Collection.extend({model:c,initialize:function(e,t){this.roomId=t.roomId},url:function(){return u.API_ROOT+"/rooms/"+this.roomId+"/members"},parse:function(e){return _(e).map(function(e){return _.isNumber(e)?u.users.get(e):e})},toArray:function(){return this.pluck("id").sort()}}),h=Backbone.Model.extend({defaults:function(){return{body:"",senderId:u.user_id,sent:+moment(),type:"text"}},getBody:function(){return this.isSystem()?this.getSystemMessage():this.isImage()?this.getImage():this.getFormattedBody()},getFormattedBody:function(){return _.escape(this.get("body")).replace(/(https?:\/\/\S+)/g,'<a href="$1" target="_blank">$1</a>')},getSystemMessage:function(){var e=JSON.parse(this.get("body"));switch(e.type){case"joinMember":return _.printf("%1$s joined the conversation",s(e.member));case"addMember":return _.printf("%1$s added %2$s to the conversation",s(e.originator),i(e.members));case"me":return _.printf("%1$s %2$s",s(e.originator),e.message);case"text":return e.message;default:return _.printf("Unknown system message %1$s",e.type)}},getImage:function(){return'<img src="'+this.get("body")+'" alt="">'},getTime:function(){return moment(this.get("sent")).format("LT")},getTextBody:function(){return _.escape(this.get("body"))},isSystem:function(){return 0===this.get("senderId")},isMyself:function(){return this.get("senderId")===u.user_id},isImage:function(){return"image"===this.get("type")},hasSameSender:function(){var e=this.collection.indexOf(this);return!(e<=0)&&this.collection.at(e-1).get("senderId")===this.get("senderId")}}),g=Backbone.Collection.extend({model:h,comparator:"sent",initialize:function(e,t){this.roomId=t.roomId},url:function(){return u.API_ROOT+"/rooms/"+this.roomId+"/messages"}}),f=Backbone.Model.extend({defaults:{open:!0,type:"group",unseen:0},initialize:function(e){this.set("modified",+moment()),this.unset("messages",{silent:!0}),this.members=new d(e.members,{parse:!0,roomId:e.id}),this.messages=new g([],{roomId:e.id}),this.listenTo(this.members,"all",function(e){/^(add|change|remove)$/.test(e)&&this.trigger("member:"+e),this.set("members",this.members.toArray())}),this.listenTo(this.messages,"all",function(e){/^(add|change|remove)$/.test(e)&&this.trigger("message:"+e)})},getTitle:function(){return this.get("title")||_(this.members.reject({id:u.user_id})).invoke("getName").sort().join("; ")},getLastMessage:function(){var e=this.get("lastMessage");return e?new h(e).getTextBody():" "},getLastMessageDate:function(){var e=this.get("lastMessage");return e?moment(new h(e).get("sent")).format("LT"):" "},getFirstMember:function(){return this.members.reject({id:u.user_id})[0]},isOpen:function(){return this.get("open")},isPrivate:function(){return"private"===this.get("type")},isGroup:function(){return"group"===this.get("type")},isChannel:function(){return"channel"===this.get("type")},postMessage:function(e){this.messages.add(e).save(),this.set("modified",+moment())},addMembers:function(e){return this.members.add(e,{parse:!0}),$.post(this.members.url(),{members:e})},toggle:function(e){this.set("open",!!e).save({open:!!e},{patch:!0})}}),l=Backbone.Collection.extend({model:f,comparator:"modified",url:function(){return u.API_ROOT+"/rooms"},initialize:function(){this.on("change:unseen",this.onChangeUnseen)},create:function(e){var t=this,n={open:!0,members:e.members,title:"",type:e.type||"group"};return $.post(this.url(),n).done(function(e){t.add(e)})},onChangeUnseen:function(){this.trigger("unseen",this.reduce(function(e,t){return e+(t.get("unseen")>0?1:0)},0))},getOpen:function(){return this.filter({open:!0})},getHistory:function(){return this.filter({open:!1,joined:!0}).slice(0,100)},getChannels:function(){return this.filter({type:"channel"})},getChannelsUnjoined:function(){return this.filter({type:"channel",joined:!1})},fetchUnlessExists:function(e){var t=this.get(e);return t?$.when(t):$.get({url:this.url()+"/"+e}).then(this.add.bind(this))},joinChannel:function(e){var t=this.get(e);t&&t.isChannel()&&(t.addMembers([o]),t.set({joined:!0,open:!0}))}});u.chats=new l;var p=Backbone.Model.extend({getThumbnailUrl:function(){return u.API_ROOT+"/files/"+this.get("id")+"/thumbnail"},getPreviewUrl:function(){return u.API_ROOT+"/files/"+this.get("id")+"/thumbnail"}}),b=Backbone.Collection.extend({model:p,url:function(){return u.API_ROOT+"/files"}});u.files=new b;var y=u.socket=n.connect(u.SOCKET,{query:"userId="+u.user_id});return y.on("alive",function(){console.log("Connected socket to server")}),y.on("message:change",function(e,t,n){var s=u.chats.get(e);if(s){var i=s.messages.get(t);i&&i.set(n)}}),y.on("message:new",function(t,n){e.trigger("typing:"+t,n.senderId,!1),u.chats.fetchUnlessExists(t).done(function(e){e.messages.add(n),e.set({modified:+moment(),unseen:e.get("unseen")+1})})}),y.on("user:change:state",function(e,t){var n=u.users.get(e);n&&n.set("state",t)}),y.on("typing",function(t,n,s){e.trigger("typing:"+t,n,s)}),setInterval(function(){y.emit("heartbeat")},6e4),u});