define.async("io.ox/oauth/keychain",["io.ox/core/extensions","io.ox/core/http","io.ox/core/event","io.ox/core/notifications","io.ox/core/api/filestorage","io.ox/oauth/backbone","gettext!io.ox/core"],function(e,t,n,r,o,i,c){"use strict";function a(e){return e.substring(e.lastIndexOf(".")+1)}function u(e){e.toJSON&&(e=e.toJSON());var t,n={},r=0;for(_(l.forService(e.id)).each(function(e){n[e.get("displayName")]=1}),t=c("My %1$s account",e.displayName);n[t];)r++,t=c("My %1$s account (%2$d)",e.displayName,r);return t}function s(e){function t(e){return e?(e.accountType=s.id,e):e}var s=this;n.extend(this),this.id=a(e.id),this.displayName=e.displayName,this.getAll=function(){return _(l.forService(e.id)).chain().map(function(e){return e.toJSON()}).sortBy(function(e){return e.id}).map(t).value()},this.get=function(e){return t(l.get(e).toJSON())},this.getStandardAccount=function(){return t(_(this.getAll()).first())},this.hasStandardAccount=function(){return this.getAll().length>0},this.createInteractively=function(t,n){n=[].concat(n||[]);var o=$.Deferred(),a=this;if(!t)return o.reject();var s=new i.Account.Model({displayName:u(e),serviceId:e.id,popup:t});return s.enableScopes(n),s.save().then(function(e){return a.trigger("create",e),ox.trigger("refresh-portal"),r.yell("success",c("Account added successfully")),e},function(e){throw r.yell("error",c("Account could not be added")),e})},this.remove=function(e){return(e=l.get(e.id)).destroy().then(function(){var t;o.rampupDone&&(t=o.getAccountForOauth(e.toJSON()))&&o.deleteAccount(t,{softDelete:!0})})},this.update=function(e){var t=l.get(e.id);return t.set(e),t.save().then(function(){var e;if(o.rampupDone&&(e=o.getAccountForOauth(t.toJSON())),e){var n=e.attributes;return n.displayName=t.get("displayName"),$.when(t.toJSON(),o.updateAccount(n))}return t.toJSON()}).done(function(){s.trigger("refresh.list",t.toJSON())})},this.reauthorize=function(e){return(e=l.get(e.id))?e.reauthorize().then(function(){return ox.trigger("refresh-portal"),e.toJSON()},function(e){throw r.yell("error",e.error),e}):$.Deferred().reject()}}function d(){l.listenTo(l,"add remove",function(e){f.forAccount(e).keychainAPI.trigger("refresh.all refresh.list",e.toJSON()),require(["plugins/halo/api"],function(e){e.halo.refreshServices()})}),l.listenTo(require("io.ox/core/folder/api"),"remove update",function(e){var t=l.filter(function(t){return t.get("associations").map(function(e){return e.folder}).indexOf(e)>=0})[0];t&&t.fetch()})}var f,l=new i.Account.Collection,h=e.point("io.ox/keychain/api"),p=Backbone.Model.extend({initialize:function(){var e=new s(this.toJSON());e.one("initialized",function(){l.length>0&&e.trigger("refresh.all")}),h.extend(e),this.keychainAPI=e},canAdd:function(e){if(_.isFunction(this.keychainAPI.canAdd))return this.keychainAPI.canAdd(e);var t=this;return[].concat(e.scopes||[]).reduce(function(e,n){return e&&_(t.get("availableScopes")).contains(n)},!0)}}),v=Backbone.Collection.extend({model:p,forAccount:function(e){return this.get(e.get("serviceId"))},withShortId:function(e){return this.filter(function(t){return a(t.id)===e})[0]}}),g=function(){return g.id=g.id+1,g.id};g.id=1;var m=$.Deferred(),y={accounts:l,chooseDisplayName:u};return ox.rampup&&ox.rampup.oauth&&ox.rampup.oauth.services?((f=y.services=new v).add(ox.rampup.oauth.services),l.add(ox.rampup.oauth.accounts),d(),y.serviceIDs=f.map(function(e){return a(e.id)}),m.resolve(y)):(t.pause(),t.GET({module:"oauth/services",params:{action:"all"}}),t.GET({module:"oauth/accounts",params:{action:"all"}}),t.resume().then(function(e){f=y.services=new v,e[0]&&f.add(e[0].data),e[1]&&l.add(e[1].data),d(),y.serviceIDs=f.map(function(e){return a(e.id)}),m.resolve(y)})),o.rampup().then(function(){_.delay(o.consistencyCheck,5e3)}),m});