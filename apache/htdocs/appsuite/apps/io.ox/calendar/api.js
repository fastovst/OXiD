define("io.ox/calendar/api",["io.ox/core/http","io.ox/core/api/collection-pool","io.ox/core/api/collection-loader","io.ox/core/folder/api","io.ox/calendar/util","io.ox/calendar/model","io.ox/core/capabilities"],function(e,t,n,r,o,a,i){"use strict";function d(e){var t={};return e.split("&").forEach(function(e){var n=e.split("=");t[n[0]]=n[1]}),t}var c=function(e){return!(!e.rrule||e.recurrenceId)},l=function(e,t){if(e){e=e.data||e,_(e.created).each(function(e){c(e)||s.pool.propagateAdd(e),s.trigger("process:create",e),s.trigger("process:create:"+o.cid(e),e)}),_(e.deleted).each(function(e){var t=s.pool.getModel(o.cid(e));(t=t?[t]:s.pool.findRecurrenceModels(e)).forEach(function(e){e.collection.remove(e),s.trigger("delete",e.attributes),s.trigger("delete:"+o.cid(e),e.attributes)})}),_(e.updated).each(function(e){if(c(e)){var n=s.pool.findRecurrenceModels(e),r=_(e).pick("attendees","alarms","flags","timestamp");n.forEach(function(e){e.set(r),s.trigger("update",e.attributes),s.trigger("update:"+o.cid(e),e.attributes,{updateData:{showRecurrenceInfo:t&&t.showRecurrenceInfo}})})}else{var a=s.pool.getModel(o.cid(e));a&&_.difference(_(a.attributes).keys(),_(e).keys(),["index","cid"]).forEach(function(t){e[t]=void 0}),s.pool.propagateUpdate(e)}s.trigger("update",e),s.trigger("update:"+o.cid(e),e,{updateData:{showRecurrenceInfo:t&&t.showRecurrenceInfo}})});var n=(e.failed||[]).concat(e.error);return _(n).each(function(e){require(["io.ox/core/notifications"],function(t){t.yell(e)})}),e}},u=["lastModified","color","createdBy","endDate","flags","folder","id","location","recurrenceId","rrule","seriesId","startDate","summary","timestamp","transp"].join(","),s={updatePoolData:l,cid:o.cid,defaultFields:u,request:function(){function t(e,t,n){return e=_.clone(e),e.params=_.extend({},e.params,{rangeStart:t.format(o.ZULU_FORMAT),rangeEnd:n.format(o.ZULU_FORMAT)}),e}function n(e,t){return _(e).chain().union(t).uniq(function(e){return o.cid(e)}).compact().value()}return function r(o,a){return a=a||"GET",e[a](o).then(function(e){if(_.isArray(e)){var t;if(e.forEach(function(e){e.error&&(ox.trigger("http:error:"+e.error.code,e.error),t=e.error)}),t&&"CAL-5072"===t.code)throw t}return e}).catch(function(e){if("CAL-5072"!==e.code)throw e;var i=moment(o.params.rangeStart).utc(),d=moment(o.params.rangeEnd).utc(),c=moment(i).add(d.diff(i,"ms")/2,"ms");return r(t(o,i,c),a).then(function(e){return r(t(o,c,d),a).then(function(t){return _.isArray(e)?(e.forEach(function(e,r){e.events=n(e.events,t[r].events)}),e):n(e,t)})})})}}(),get:function(t,n){if(t=t instanceof Backbone.Model?t.attributes:t,!1!==n){var r=s.pool.getModel(o.cid(t));if(r&&r.get("attendees"))return $.when(r)}return t.eventId&&(t.id=t.eventId),e.GET({module:"chronos",params:{action:"get",id:t.id,recurrenceId:t.recurrenceId,folder:t.folder,extendedEntities:!0}}).then(function(e){return c(e)?s.pool.get("detail").add(e):(s.pool.propagateAdd(e),s.pool.getModel(e))})},resolve:function(t,n){var r;if(_.isObject(t)&&(r=t.sequence,t=t.id),!1!==n){var o,a=s.pool.getCollections();if(_(a).find(function(e){var n=e.collection;return!!(o=n.find(function(e){return e.get("id")===t&&!e.has("recurrenceId")&&(void 0===r||e.get("sequence")===r)}))}),o)return $.when(o)}var i={action:"resolve",id:t,fields:s.defaultFields};return void 0!==r&&(i.sequence=r),e.GET({module:"chronos",params:i}).then(function(e){return c(e)?s.pool.get("detail").add(e):(s.pool.propagateAdd(e),s.pool.getModel(e))})},getList:function(){function t(n){return e.PUT({module:"chronos",params:{action:"list",fields:u},data:n}).catch(function(e){if("CAL-5072"!==e.code)throw e;var r=_(n).first(Math.ceil(n.length/2)),o=_(n).last(Math.floor(n.length/2));return t(r).then(function(e){return t(o).then(function(t){return[].concat(e).concat(t)})})})}return function(e,n){var r=[],a=e=_(e).map(function(e){return e.eventId?(r.push(e),{id:e.eventId,folder:e.folder,recurrenceId:e.recurrenceId}):e});return!1!==n&&(a=e.filter(function(e){return!s.pool.getModel(o.cid(e))})),(a.length>0?t(a):$.when()).then(function(t){return t&&t.forEach(function(e,t){if(null===e){var n={eventId:a[t].id,folder:a[t].folder};return a[t].recurrenceId&&(n.recurrenceId=a[t].recurrenceId),s.trigger("failedToFetchEvent",_(r).findWhere(n)),s.trigger("delete:appointment",a[t]),void l({deleted:[a[t]]})}if(!c(e)){var i=s.pool.getModel(o.cid(e));i&&i.get("attendees")&&i.get("lastModified")>=e.lastModified||s.pool.propagateAdd(e)}}),e.map(function(e){if(t){var n=_(a).findIndex(function(t){return t.id===e.id&&t.folder===e.folder&&(!t.recurrenceId||t.recurrenceId===e.recurrenceId)});if(-1!==n&&t[n])e=t[n];else if(-1!==n&&null===t[n])return null}if(c(e))return s.pool.get("detail").add(e);var r=o.cid(e);return s.pool.getModel(r)})})}}(),create:function(t,n){n=n||{};var r,o={action:"new",folder:(t=t instanceof Backbone.Model?t.attributes:t).folder,checkConflicts:!!n.checkConflicts,sendInternalNotifications:!0,fields:s.defaultFields};if(ox.socketConnectionId&&(o.pushToken=ox.socketConnectionId),n.expand&&(o.expand=!0,o.rangeStart=n.rangeStart,o.rangeEnd=n.rangeEnd),n.usedGroups&&(o.usedGroups=_(n.usedGroups).isArray()?n.usedGroups.join(","):n.usedGroups),n.attachments&&n.attachments.length){var a=new FormData;a.append("json_0",JSON.stringify(t));for(var i=0;i<n.attachments.length;i++)a.append("file_"+n.attachments[i].cid,n.attachments[i].file);r=e.UPLOAD({module:"chronos",params:o,data:a,fixPost:!0})}else r=e.PUT({module:"chronos",params:o,data:t});return r.then(l).then(function(e){return e=e.data||e,s.getAlarms(),e.conflicts?e:(e.created.length>0&&s.trigger("create",e.created[0]),e.created.length>0&&c(e.created[0])?s.pool.get("detail").add(e):e.created.length>0?s.pool.getModel(e.created[0]):void 0)})},update:function(t,n){n=n||{};var r,a={action:"update",folder:(t=t instanceof Backbone.Model?t.attributes:t).folder,id:t.id,timestamp:_.then(),checkConflicts:!!n.checkConflicts,sendInternalNotifications:!0,recurrenceRange:n.recurrenceRange,fields:s.defaultFields};ox.socketConnectionId&&(a.pushToken=ox.socketConnectionId),t.recurrenceId&&(a.recurrenceId=t.recurrenceId),n.expand&&(a.expand=!0,a.rangeStart=n.rangeStart,a.rangeEnd=n.rangeEnd),n.usedGroups&&(a.usedGroups=_(n.usedGroups).isArray()?n.usedGroups.join(","):n.usedGroups);var i={event:t};if(n.comment&&(i.comment=n.comment),n.attachments&&n.attachments.length){var d=new FormData;d.append("json_0",JSON.stringify(i));for(var u=0;u<n.attachments.length;u++)d.append("file_"+n.attachments[u].cid,n.attachments[u].file);r=e.UPLOAD({module:"chronos",params:a,data:d,fixPost:!0})}else r=e.PUT({module:"chronos",params:a,data:i});return r.then(function(e){return l(e,n),e}).then(function(e){if(e=e.data||e,s.getAlarms(),e.conflicts)return e;var n=e.updated?e.updated[0]:void 0;return n?c(n)?s.pool.get("detail").add(e):s.pool.getModel(n):s.pool.getModel(o.cid(t))})},remove:function(t,n){n=_.extend({},n),s.trigger("beforedelete",t),t=_.isArray(t)?t:[t];var r={action:"delete",timestamp:_.then(),fields:s.defaultFields},o={events:_(t).map(function(e){var t={id:(e=e instanceof Backbone.Model?e.attributes:e).id,folder:e.folder};return e.recurrenceId&&(t.recurrenceId=e.recurrenceId),e.recurrenceRange&&(t.recurrenceRange=e.recurrenceRange),t})};return ox.socketConnectionId&&(r.pushToken=ox.socketConnectionId),n.expand&&(r.expand=!0,r.rangeStart=n.rangeStart,r.rangeEnd=n.rangeEnd),n.comment&&(o.comment=n.comment),e.PUT({module:"chronos",params:r,data:o}).then(function(e){return e.forEach(l),e}).then(function(e){return s.getAlarms(),e})},confirm:function(t,n){n=n||{},""===t.attendee.comment&&delete t.attendee.comment,"DECLINED"===t.attendee.partStat&&(t.alarms=null);var r={action:"updateAttendee",id:t.id,folder:t.folder,checkConflicts:n.checkConflicts,sendInternalNotifications:!0,timestamp:_.then(),fields:s.defaultFields},o={attendee:t.attendee};return ox.socketConnectionId&&(r.pushToken=ox.socketConnectionId),t.recurrenceId&&(r.recurrenceId=t.recurrenceId),(t.alarms||null===t.alarms)&&(o.alarms=t.alarms),n.expand&&(r.expand=!0,r.rangeStart=n.rangeStart,r.rangeEnd=n.rangeEnd),e.PUT({module:"chronos",params:r,data:o}).then(l).then(function(e){return e.conflicts||(e.updated&&e.updated.length?s.trigger("mark:invite:confirmed",e.updated[0]):e.updated&&0===e.updated.length&&s.getInvites()),e})},updateAlarms:function(t,n){var r={action:"updateAlarms",id:t.id,folder:t.folder,timestamp:_.now(),fields:s.defaultFields+",alarms,rrule"};return t.recurrenceId&&(r.recurrenceId=t.recurrenceId),n.expand&&(r.expand=!0,r.rangeStart=n.rangeStart,r.rangeEnd=n.rangeEnd),e.PUT({module:"chronos/alarm",params:r,data:t.alarms}).then(function(e){0!==t.alarms.length||t.recurrenceId||(e.updated[0].alarms=[]),l(e)})},freebusy:function(t,n){if(0===t.length)return $.Deferred().resolve([]);n=_.extend({from:moment().startOf("day").utc().format(o.ZULU_FORMAT),until:moment().startOf("day").utc().add(1,"day").format(o.ZULU_FORMAT)},n);var r=_(t).map(function(e){return e.entity||e.uri}),a=$.Deferred();return e.PUT({module:"chronos",params:{action:"freeBusy",from:n.from,until:n.until},data:{attendees:t}}).then(function(e){e.sort(function(e,t){return r.indexOf(e.attendee.entity||e.attendee.uri)-r.indexOf(t.attendee.entity||t.attendee.uri)}),a.resolve(e)},function(r){"CAL-5072"!==r.code&&a.reject(r),e.pause(),_(t).each(function(t){e.PUT({module:"chronos",params:{action:"freeBusy",from:n.from,until:n.until},data:{attendees:[t]}})}),e.resume().then(function(e){e=e.map(function(e){return e.error?{freeBusyTime:[]}:e.data[0]}),a.resolve(e)})}),a},reduce:function(e){return(e=e instanceof Backbone.Model?e:_(e)).pick("id","folder","recurrenceId")},move:function(t,n,r){r=r||{},t=[].concat(t);var a=_(t).map(function(e){var t=o.cid(e),n=s.pool.getCollectionsByModel(e)[0],r=n.get(t);return n.remove(r),r});return e.pause(),_(a).map(function(t){var o={action:"move",id:t.get("id"),folder:t.get("folder"),targetFolder:n,recurrenceId:t.get("recurrenceId"),sendInternalNotifications:!0,timestamp:_.then(),fields:s.defaultFields};return ox.socketConnectionId&&(o.pushToken=ox.socketConnectionId),r.expand&&(o.expand=!0,o.rangeStart=r.rangeStart,o.rangeEnd=r.rangeEnd),e.PUT({module:"chronos",params:o})}),e.resume().then(function(e){var t=$.Deferred(),n=_(e).find(function(e){return!!e.error});return n?(t.reject(n.error),_(a).each(function(e){s.pool.propagateAdd(e.toJSON())})):t.resolve(e),t}).then(function(e){return e.forEach(l),e}).done(function(e){_(e).each(function(e){s.trigger("move:"+o.cid(e),n),s.trigger("move",e.data.created[0])}),s.trigger("refresh.all")})},getInvites:function(){return e.GET({module:"chronos",params:{action:"needsAction",folder:r.getDefaultFolder("calendar"),rangeStart:moment().subtract(2,"hours").utc().format(o.ZULU_FORMAT),rangeEnd:moment().add(1,"years").utc().format(o.ZULU_FORMAT),fields:"folder,id,recurrenceId,organizer,endDate,startDate,summary,location,rrule",sort:"startDate"}}).then(function(e){return s.trigger("new-invites",e),e})},getAlarms:function(){return e.GET({module:"chronos/alarm",params:{action:"pending",rangeEnd:moment.utc().add(10,"hours").format(o.ZULU_FORMAT),actions:"DISPLAY,AUDIO"}}).then(function(e){e=_(e).map(function(e){return e.id=e.alarmId,e}),s.trigger("resetChronosAlarms",e)})},acknowledgeAlarm:function(t){if(!t)return $.Deferred().reject();if(_(t).isArray())return e.pause(),_(t).each(function(e){s.acknowledgeAlarm(e)}),e.resume();var n={action:"ack",folder:t.folder,id:t.eventId,alarmId:t.alarmId,fields:s.defaultFields};return ox.socketConnectionId&&(n.pushToken=ox.socketConnectionId),e.PUT({module:"chronos/alarm",params:n}).then(function(e){return s.trigger("acknowledgedAlarm",t),l(e),e})},remindMeAgain:function(t){if(!t)return $.Deferred().reject();var n={action:"snooze",folder:t.folder,id:t.eventId,alarmId:t.alarmId,snoozeTime:t.time||3e5,fields:s.defaultFields};return ox.socketConnectionId&&(n.pushToken=ox.socketConnectionId),e.PUT({module:"chronos/alarm",params:n}).then(l)},changeOrganizer:function(t,n){n=n||{};var r={action:"changeOrganizer",folder:(t=t instanceof Backbone.Model?t.attributes:t).folder,id:t.id,timestamp:_.then(),fields:s.defaultFields};n.recurrenceRange&&(r.recurrenceRange=n.recurrenceRange),ox.socketConnectionId&&(r.pushToken=ox.socketConnectionId),t.recurrenceId&&(r.recurrenceId=t.recurrenceId),n.expand&&(r.expand=!0,r.rangeStart=n.rangeStart,r.rangeEnd=n.rangeEnd);var a={organizer:t.organizer};return n.comment&&(a.comment=n.comment),e.PUT({module:"chronos",params:r,data:a}).then(l).then(function(e){var n=e.updated?e.updated[0]:void 0;return n?c(n)?s.pool.get("detail").add(e):s.pool.getModel(n):s.pool.getModel(o.cid(t))})},refresh:function(){i.has("calendar")&&(s.getInvites(),s.getAlarms(),s.trigger("refresh.all"))},refreshCalendar:function(t){var n=this;return e.GET({module:"chronos",params:{action:"all",rangeStart:moment(_.now()).format(o.ZULU_FORMAT),rangeEnd:moment(_.now()+1).format(o.ZULU_FORMAT),fields:["folder","id"],updateCache:!0,folder:t}}).then(function(){n.trigger("refresh.all")})},removeRecurrenceInformation:function(e){var t=e instanceof Backbone.Model?e.toJSON():_(e).clone();return delete t.rrule,delete t.recurrenceId,delete t.seriesId,e instanceof Backbone.Model?new a.Model(t):t},getCollection:function(e){var t=_(e).map(function(e,t){return e=_.isString(e)?e:JSON.stringify(e),t+"="+e}).join("&"),n=s.pool.get(t);return n.setOptions(e),n}};return ox.on("refresh^",function(){s.refresh()}),ox.on("socket:calendar:updates",function(e){_(e.folders).each(function(e){_(s.pool.getByFolder(e)).each(function(e){e.expired=!0,e.sync()})}),s.getAlarms()}),s.pool=t.create("chronos",{Collection:a.Collection}),s.pool.get=_.wrap(s.pool.get,function(e,t){var n=!!this.getCollections()[t],r=d(t),o=e.call(this,t);if(n||"detail"===t||!r.folders||0===r.folders.length)return 0===t.indexOf("search/")&&(o.comparator=null),o;var a=this.grep("start="+r.start,"end="+r.end),i=_(a).chain().pluck("models").flatten().uniq(function(e){return e.cid}).filter(function(e){return r.folders.indexOf(e.get("folder"))>=0}).invoke("toJSON").value();return o.add(i,{silent:!0}),o.length>0&&(o.expired=!0),o}),_.extend(s.pool,{map:function(e){return e.cid=o.cid(e),e},getByFolder:function(e){var t=new RegExp("(folders=[^&]*"+e+"|folder="+e+"&)");return _(this.getCollections()).chain().filter(function(e,n){return t.test(n)}).pluck("collection").value()},getCollectionsByCID:function(e){var t=o.cid(e).folder,n=this.getByFolder(t).filter(function(t){return!!t.get(e)});return 0===n.length?[this.get("detail")]:n},getCollectionsByModel:function(){function e(e){var t=d(e.cid),n=t.start,r=t.end;return"list"===t.view&&(n=moment().startOf("day").valueOf(),r=moment().startOf("day").add(e.range,"month").valueOf()),!(this.getTimestamp("endDate")<=n)&&!(this.getTimestamp("startDate")>=r)}return function(t){var n=t instanceof Backbone.Model?t:new a.Model(t),o=this.getByFolder(n.get("folder")).filter(e.bind(n)),i=r.pool.getModel(n.get("folder"));return i&&i.is("public")&&n.hasFlag("attendee")&&o.push.apply(o,this.getByFolder("cal://0/allPublic").filter(e.bind(n))),0===o.length?[this.get("detail")]:o}}(),propagateAdd:function(e){e.cid=o.cid(e),s.pool.getCollectionsByModel(e).forEach(function(t){s.pool.add(t.cid,e)})},propagateUpdate:function(e){var t=_.cid(e),n=this.getModel(t);if(!n||_.isEqual(e.startDate,n.get("startDate"))&&_.isEqual(e.endDate,n.get("endDate"))&&e.folder===n.get("folder"))return this.propagateAdd(e);var r=this.getCollectionsByModel(n),o=this.getCollectionsByModel(e);_.difference(r,o).forEach(function(e){e.remove(t)}),o.forEach(function(t){s.pool.add(t.cid,e)})},getModel:function(e){var t=e;_.isString(e)||(t=o.cid(e));var n=s.pool.getCollectionsByCID(t);if(0!==n.length){var r=n[0].get(t);return!r&&_.isObject(e)&&(r=n[0].add(e)),r}},findRecurrenceModels:function(e){e=e instanceof Backbone.Model?e.attributes:e;var t=s.pool.getByFolder(e.folder),n=_([].concat(e.changeExceptionDates).concat(e.deleteExceptionDates)).compact(),r=function(t){return t.get("seriesId")===e.id&&!(n.indexOf(t.get("recurrenceId"))>=0)},o=t.map(function(e){return e.filter(r)});return _(o).chain().flatten().uniq(function(e){return e.cid}).value()}}),s.collectionLoader={PRIMARY_SEARCH_PAGE_SIZE:100,SECONDARY_SEARCH_PAGE_SIZE:200,getDefaultCollection:function(){return new a.Collection},load:function(e){e=e||{};var t=this.collection=s.getCollection(e);return t.originalStart=t.originalStart||moment().startOf("day"),t.range=t.range||1,t.setOptions({start:t.originalStart.valueOf()+1,end:t.originalStart.clone().add(t.range,"months").valueOf(),folders:e.folders||[]}),t.sync().then(function(e){e&&0!==e.length||t.trigger("reset")}),t},reload:function(e){var t=this.collection=s.getCollection(e);return t.expired=!0,t.setOptions({start:t.originalStart.valueOf()+1,end:t.originalStart.clone().add(t.range,"months").valueOf(),folders:e.folders||[]}),t.sync(),t},paginate:function(){var e=this.collection;if(e)return e.range++,e.expired=!0,e.setOptions({start:e.originalStart.clone().add(e.range-1,"months").valueOf()+1,end:e.originalStart.clone().add(e.range,"months").valueOf(),folders:e.folders||[]}),e.sync({paginate:!0}),e}},_.extend(s,Backbone.Events),s});