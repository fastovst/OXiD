define("io.ox/calendar/perspective",["io.ox/core/extensions","io.ox/calendar/api","io.ox/calendar/model","io.ox/calendar/util","io.ox/calendar/view-detail","io.ox/core/tk/dialogs","io.ox/core/yell","gettext!io.ox/calendar","io.ox/core/capabilities","settings!io.ox/calendar","io.ox/core/folder/api","io.ox/backbone/views/disposable"],function(e,t,i,n,o,a,s,r,c,l,d,p){"use strict";return p.extend({clickTimer:null,clicks:0,events:function(){var e={"click .appointment":"onClickAppointment"};return _.device("touch")&&_.extend(e,{swipeleft:"onNext",swiperight:"onPrevious"}),e},initialize:function(e){this.listenTo(this.model,"change:date",this.onChangeDate),this.listenTo(t,"refresh.all",this.refresh.bind(this,!0)),this.listenTo(this.app,"folders:change",this.refresh),this.listenTo(this.app.props,"change:date",this.getCallback("onChangeDate")),this.app.getWindow().on("show",this.onWindowShow.bind(this)),this.listenTo(l,"change:showDeclinedAppointments",this.getCallback("onResetAppointments")),this.listenTo(d,"before:update",this.beforeUpdateFolder),_.defer(this.followDeepLink.bind(this,e.deepLink))},render:$.noop,refresh:$.noop,onWindowShow:$.noop,onChangeDate:$.noop,setCollection:function(e){this.collection!==e&&(this.collection&&this.stopListening(this.collection),this.collection=e,this.onResetAppointments(),this.listenTo(this.collection,"add",this.onAddAppointment).listenTo(this.collection,"change",this.onChangeAppointment).listenTo(this.collection,"remove",this.onRemoveAppointment).listenTo(this.collection,"reset",this.onResetAppointments))},onAddAppointment:$.noop,onChangeAppointment:$.noop,onRemoveAppointment:$.noop,onResetAppointments:$.noop,getName:$.noop,showAppointment:function(){function i(e){e&&"CAL-4040"===e.code?s(e):s("error",r("An error occurred. Please try again.")),this.dialog.close(),this.$(".appointment").removeClass("opac current"),this.trigger("show:appointment:fail"),_.device("smartphone")&&(this.app.pages.getPage("detailView").idle(),this.app.pages.goBack())}return function(n,a){var s=this,c=this.getDialog();if(_.device("smartphone")&&(s.app.pages.changePage("detailView"),s.app.pages.getPage("detailView").busy()),s.detailCID=t.cid(a),_.device("smartphone")){var l=s.app.pages.getPage("detailView");t.get(a).then(function(t){var i=new e.Baton({data:t.toJSON(),model:t});l.idle().empty().append(o.draw(i)),s.app.pages.getToolbar("detailView").setBaton(i)},i.bind(s))}else c.show(n,function(n){n.busy().attr({role:"complementary","aria-label":r("Appointment Details")}),t.get(a).then(function(t){t.cid===s.detailCID&&n.idle().append(o.draw(new e.Baton({model:t})))},i.bind(s))})}}(),closeAppointment:function(){this.$(".appointment").removeClass("opac current")},getDialog:function(){return this.dialog||(this.dialog=new a.SidePopup({tabTrap:!0,preserveOnAppchange:!0}).on("close",this.closeAppointment.bind(this))),this.dialog},onClickAppointment:function(i){var o=$(i["keydown"===i.type?"target":"currentTarget"]);if(o.hasClass("appointment")&&!this.model.get("lasso")&&!o.hasClass("disabled")){var a=this,s=n.cid(String(o.data("cid")));!o.hasClass("current")||_.device("smartphone")?(this.$(".appointment").removeClass("current opac").not(this.$('[data-master-id="'+s.folder+"."+s.id+'"]')).addClass(this.collection.length>this.limit||_.device("smartphone")?"":"opac"),this.$('[data-master-id="'+s.folder+"."+s.id+'"]').addClass("current"),this.showAppointment(i,s)):this.$(".appointment").removeClass("opac"),null===this.clickTimer&&0===this.clicks&&(this.clickTimer=setTimeout(function(){clearTimeout(a.clickTimer),a.clicks=0,a.clickTimer=null},300)),this.clicks++,null!==this.clickTimer&&2===this.clicks&&o.hasClass("modify")&&"click"===i.type&&(clearTimeout(this.clickTimer),this.clicks=0,this.clickTimer=null,t.get(s).done(function(t){a.dialog&&a.dialog.close(),e.point("io.ox/calendar/detail/actions/edit").invoke("action",a,new e.Baton({data:t.toJSON()}))}))}},createAppointment:function(t){c.has("guest")||e.point("io.ox/calendar/detail/actions/create").invoke("action",this,{app:this.app},t)},updateAppointment:function(e,o){function a(){e.set({startDate:e.previous("startDate"),endDate:e.previous("endDate"),folder:d}),p.idle()}function r(e,i){var n=_(e.toJSON()).pick("id","folder","recurrenceId","seriesId","rrule","startDate","endDate","timestamp");t.update(n,i).then(function(t){if(!t||!t.conflicts)return p.idle();ox.load(["io.ox/calendar/conflicts/conflictList"]).done(function(n){n.dialog(t.conflicts).on("cancel",a).on("ignore",function(){r(e,_.extend(i||{},{checkConflicts:!1}))})})},function(e){a(),s(e)})}var c=e.getMoment("startDate"),l=e.getMoment("endDate"),d=e.get("folder");if(_(o).reduce(function(t,i,n){return t||!_.isEqual(e.get(n),i)},!1)){e.set(o);var p=this.$('[data-master-id="'+t.cid({id:e.get("id"),folder:e.get("folder")})+'"]').busy();n.showRecurrenceDialog(e).done(function(t,o){switch(t){case"series":var s=o.getMoment("startDate");if(e.hasFlag("overridden"))o.set({startDate:e.get("startDate"),endDate:e.get("endDate")});else{var d=o.getMoment("startDate").add(e.getMoment("startDate").diff(c,"ms"),"ms"),p=o.getMoment("endDate").add(e.getMoment("endDate").diff(l,"ms"),"ms"),h=n.isAllday(e)?"YYYYMMDD":"YYYYMMDD[T]HHmmss";o.set({startDate:{value:d.format(h),tzid:o.get("startDate").tzid},endDate:{value:p.format(h),tzid:o.get("endDate").tzid}})}n.updateRecurrenceDate(o,s),r(o,_.extend(n.getCurrentRangeOptions(),{checkConflicts:!0}));break;case"thisandfuture":var g=new i.Model(n.createUpdateData(o,e));g.set({startDate:e.get("startDate"),endDate:e.get("endDate")}),e.get("rrule")&&g.set("rrule",e.get("rrule")),n.updateRecurrenceDate(g,c),r(g,_.extend(n.getCurrentRangeOptions(),{checkConflicts:!0,recurrenceRange:"THISANDFUTURE"}));break;case"appointment":r(e,_.extend(n.getCurrentRangeOptions(),{checkConflicts:!0}));break;default:return void a()}})}},getCallback:function(e){var t;return function(){var i=this[e],n=_(arguments).toArray();if(t&&this.off("show",t),t=void 0,this.$el.is(":visible"))return i.apply(this,n);this.once("show",t=function(){i.apply(this,n)})}.bind(this)},beforeUpdateFolder:function(e,t){if("calendar"===t.get("module")&&t.changed["com.openexchange.calendar.extendedProperties"]){var i=n.getFolderColor(t.attributes);this.$('.appointment[data-folder="'+t.get("id")+'"]').css({"background-color":i,color:n.getForegroundColor(i)}).data("background-color",i).removeClass("black white").addClass("white"===n.getForegroundColor(i)?"white":"black")}},followDeepLink:function(e){if(e){var i,o=this;t.get(t.cid(e)).done(function(t){o.setStartDate&&o.setStartDate(t.getMoment("startDate")),_.device("smartphone")?ox.launch("io.ox/calendar/detail/main",{cid:e}):(i=$.Event("click",{target:o.$el}),o.showAppointment(i,n.cid(e),{arrow:!1}))})}}})});