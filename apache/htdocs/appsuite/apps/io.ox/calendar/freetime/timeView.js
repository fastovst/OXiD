define("io.ox/calendar/freetime/timeView",["io.ox/backbone/views/disposable","io.ox/core/extensions","gettext!io.ox/calendar","io.ox/calendar/api","io.ox/backbone/mini-views/dropdown","settings!io.ox/calendar","io.ox/calendar/util","io.ox/backbone/views/datepicker"],function(e,t,o,a,s,i,n,d){"use strict";var r=t.point("io.ox/calendar/freetime/time-view-header"),l=t.point("io.ox/calendar/freetime/time-view-body"),m={OPAQUE:"reserved",TRANSPARENT:"free"},h={free:0,reserved:1e3},p=[10,25,50,100,200,400,1e3];return r.extend({id:"toolbar",index:100,draw:function(e){var t=$('<a href="#" class="info">').on("click",$.preventDefault).attr({"aria-label":o("Use cursor keys to change the date. Press ctrl-key at the same time to change year or shift-key to change month. Close date-picker by pressing ESC key.")}),a=function(){t.empty().append($("<span>").text("week"===e.model.get("dateRange")?e.model.get("startDate").formatInterval(moment(e.model.get("startDate")).add(6,"days")):e.model.get("startDate").format("MMMM YYYY")),$.txt(" "),$('<span class="cw">').text(o("CW %1$d",moment(e.model.get("startDate")).isoWeek())).toggle("week"===e.model.get("dateRange")),$('<i class="fa fa-caret-down fa-fw" aria-hidden="true">'))};a(),e.model.on("change:startDate change:dateRange",a),new d({parent:this.closest(".modal,#io-ox-core")}).attachTo(t).on("select",function(t){e.view.setDate(t.valueOf())}).on("before:open",function(){this.setDate(e.model.get("startDate"))}),this.append($('<span class="controls-container">').append($('<a href="#" role="button" class="control prev">').attr({title:o("week"===e.model.get("dateRange")?"Previous week":"Previous month"),"aria-label":o("week"===e.model.get("dateRange")?"Previous week":"Previous month")}).append($('<i class="fa fa-chevron-left" aria-hidden="true">')),$('<a href="#" role="button" class="control next">').attr({title:o("week"===e.model.get("dateRange")?"Next week":"Next month"),"aria-label":o("week"===e.model.get("dateRange")?"Next week":"Next month")}).append($('<i class="fa fa-chevron-right" aria-hidden="true">'))),t)}}),r.extend({id:"zoomlevels",index:200,draw:function(e){var t=$('<input type="text" readonly="readonly" aria-live="polite" class="form-control">').val(e.model.get("zoom")+"%"),a=$('<span class="input-group-btn">').append($('<button class="btn btn-default" type="button">').attr("aria-label",o("Zoom in")).append($('<i aria-hidden="true" class="fa fa-plus">').attr("title",o("Zoom in")))),s=$('<span class="input-group-btn">').append($('<button class="btn btn-default" type="button">').attr("aria-label",o("Zoom out")).append($('<i aria-hidden="true" class="fa fa-minus">').attr("title",o("Zoom out")))),i=function(o){var a=_(p).indexOf(parseInt(e.model.get("zoom"),10));"plus"===o.data.direction&&a+1<p.length?e.model.set("zoom",p[a+1]):"minus"===o.data.direction&&a>0&&e.model.set("zoom",p[a-1]),t.val(e.model.get("zoom")+"%")};a.on("click",{direction:"plus"},i),s.on("click",{direction:"minus"},i),e.view.headerNodeRow1.append($('<div class="right-controls pull-right">').append($('<span class="zoomlevel-selector">').append($('<div class="input-group">').append(s,t,a))))}}),r.extend({id:"options",index:300,draw:function(e){var t=new s({keep:!0,caret:!0,model:e.model,label:o("Options"),tagName:"span"}).header(o("Rows")).option("compact",!0,o("Compact")).option("showFineGrid",!0,o("Show fine grid")).divider().header(o("Appointment types")).option("showFree",!0,o("Free")).divider().header(o("Date range")).option("dateRange","week",o("Week"),{radio:!0}).option("dateRange","month",o("Month"),{radio:!0}).divider().option("onlyWorkingHours",!0,o("Hide non-working time"));e.view.headerNodeRow1.find(".right-controls").append(t.render().$el.addClass("options pull-right").attr("data-dropdown","options"))}}),r.extend({id:"timeline",index:400,draw:function(e){var t,o=moment(e.model.get("startDate")).startOf("day"),a=moment().startOf("day"),s="week"===e.model.get("dateRange")?7:moment(e.model.get("startDate")).daysInMonth();e.view.headerNodeRow2.append(t=$('<div class="freetime-timeline">'));for(var n=0;n<s;n++){var d,r=moment().startOf("hour"),l=parseInt(i.get("startTime",8),10),m=parseInt(i.get("endTime",18),10),h=e.model.get("onlyWorkingHours")?e.model.get("startHour"):0,p=e.model.get("onlyWorkingHours")?e.model.get("endHour"):23,u=[],g=$('<div class="day-label-wrapper">').append($('<div class="day-label">').addClass(0===o.day()||6===o.day()?"weekend":"").text(o.format("ddd")).append($('<span class="number">').text(o.format("D"))));t.append($("<div class=timeline-day>").addClass(a.valueOf()===o.valueOf()?"today":"").append($('<div class="daylabel-container">').addClass(0===n?"first":"").append(g,g.clone().addClass("level-2"),g.clone().addClass("level-1"),g.clone().addClass("level-2")),d=$('<div class="day-hours">')));for(var f=h;f<=p;f++){r.hours(f);var c=r.format("LT").replace("AM","a").replace("PM","p"),v=parseInt(e.model.get("zoom"),10)/100*60+"px";u.push($('<span class="freetime-hour">').css({width:v,"min-width":v,"max-width":v}).text(c).val(n*(p-h+1)+(e.model.get("onlyWorkingHours")?f-e.model.get("startHour"):f)).addClass(f===h?"day-start":"").addClass(f===h&&0===n?"first":"").addClass(f===m||f===l?"working-hour-start-end":""))}d.append(u),o.add(1,"days")}e.model.on("change:startDate",function(){for(var o=t.find(".timeline-day"),a=moment(e.model.get("startDate")).startOf("day"),s=moment().startOf("day"),i=0;i<=o.length;i++)$(o[i]).toggleClass("today",a.valueOf()===s.valueOf()).find(".day-label").text(a.format("ddd")).append($('<span class="number">').text(a.format("D"))),a.add(1,"days")})}}),l.extend({id:"timetable",index:100,draw:function(e){var t,o,a="week"===e.model.get("dateRange")?7:moment(e.model.get("startDate")).daysInMonth(),s=parseInt(e.model.get("zoom"),10)/100*60,n=parseInt(i.get("startTime",8),10),d=parseInt(i.get("endTime",18),10),r=e.model.get("onlyWorkingHours")?e.model.get("startHour"):0,l=e.model.get("onlyWorkingHours")?e.model.get("endHour"):23,m=moment(e.model.get("startDate")).startOf("day"),h=moment().startOf("day");h.hours(r),this.append(o=$('<div class="freetime-table" draggable="false">').append(t=$('<div class="freetime-time-table">')));for(var p=0;p<a;p++){for(var u=[],g=r;g<=l;g++)m.hours(g),u.push($('<span class="freetime-table-cell">').css("width",s+"px").val(p*(l-r+1)+(e.model.get("onlyWorkingHours")?g-e.model.get("startHour"):g)).addClass(g===d||g===n?"working-hour-start-end":"").addClass(g===r?"day-start":"").addClass(m.valueOf()===h.valueOf()?"today":"").addClass(g===r&&0===p?"first":"").addClass(g<=e.model.get("startHour")||g>=e.model.get("endHour")?"non-working-hour":""));t.append(u),m.add(1,"days")}if(s=t.children().length*s,o.css("width",s+"px"),"today"===e.view.keepScrollpos)if(e.view.headerNodeRow2.find(".today").length){var f=e.model.get("onlyWorkingHours")?e.model.get("startHour"):0;e.view.keepScrollpos=moment().hours(f).startOf("hour").valueOf()}else delete e.view.keepScrollpos;if(e.view.keepScrollpos){var c=e.view.timeToPosition(e.view.keepScrollpos)/100*s;o.parent().scrollLeft(c),e.view.center&&(o.parent().scrollLeft(c-this.width()/2),e.view.popupClosed||delete e.view.center),e.view.popupClosed||delete e.view.keepScrollpos}e.view.parentView.participantsSubview.bodyNode.css("margin-bottom",e.view.bodyNode[0].offsetHeight-e.view.bodyNode[0].clientHeight+"px")}}),l.extend({id:"lasso",index:200,draw:function(e){var t=this.find(".freetime-table");e.view.lassoNode||(e.view.lassoNode=$('<div class="freetime-lasso" draggable="false">').hide()),t.append(e.view.lassoNode),e.view.updateLasso()}}),l.extend({id:"appointments",index:300,draw:function(e){var t=$('<div class="appointments">').appendTo(this.find(".freetime-table")),s=e.view.headerNodeRow1.parent().parent().parent();_(e.model.get("attendees").models).each(function(d){var r=$('<div class="appointment-table">').attr("data-value",d.get("entity")||d.get("uri")).appendTo(t);_(e.model.get("timeSlots")[d.get("entity")||d.get("uri")]).each(function(t,d){var l;t.event?(l=t.event,n.isAllday(l)&&(l.startDate={value:new moment.utc(t.startTime).format(n.ZULU_FORMAT)},l.endDate={value:new moment.utc(t.endTime).format(n.ZULU_FORMAT)})):l={summary:o("Blocked time frame"),startDate:{value:new moment.utc(t.startTime).format(n.ZULU_FORMAT)},endDate:{value:new moment.utc(t.endTime).format(n.ZULU_FORMAT)},transp:"BUSY"===t.fbType?"OPAQUE":"TRANSPARENT",isTimeslot:!0};var p=moment.tz(l.startDate.value,l.startDate.tzid).valueOf(),u=moment.tz(l.endDate.value,l.endDate.tzid).valueOf(),g=e.view.timeToPosition(p),f=100-e.view.timeToPosition(u),c=$('<div class="appointment" draggable="false">').addClass(m[l.transp]).css({left:g+"%",right:f+"%"});100-g-f!=0&&(c.css("z-index",1+h[m[l.transp]]+d+(n.isAllday(l)?0:2e3)),l.summary&&(l.isTimeslot||c.addClass(100-f-g<4*e.view.grid?"under-one-hour":"").append($('<div class="title">').text(l.summary).append($('<span class="appointment-time">').text(n.isAllday(l)?n.getDateInterval(l):n.getTimeInterval(l)))),c.attr("aria-label",l.summary)),(l.summary||l.location||l.createdBy&&!1===i.get("freeBusyStrict",!0))&&c.attr({title:((l.summary||"")+(l.location?" "+l.location:"")+(l.createdBy&&!1===i.get("freeBusyStrict",!0)?" "+o("Created by: %1$s",l.createdBy.cn):"")).trim(),"data-toggle":"tooltip"}).tooltip({container:s}),l.location&&""!==l.location&&c.addClass("has-location").append($('<div class="location">').text(l.location)),l.isTimeslot||!e.view.parentView.options.isApp||!l.folder&&!1!==i.get("freeBusyStrict",!0)||c.addClass("has-detailview").on("click",function(t){e.view.lassoEnd===e.view.lassoStart&&require(["io.ox/core/tk/dialogs","io.ox/calendar/view-detail"],function(e,o){new e.SidePopup({tabTrap:!0}).show(t,function(e){if(void 0!==l.folder_id){e.busy();var t=this;a.get(l).then(function(t){e.idle().append(o.draw(t))},function(e){t.close(),require(["io.ox/core/yell"],function(t){t(e)})})}else e.append(o.draw(l))})})}),r.append(c))})}),e.view.onResize()}}),l.extend({id:"currentime",index:400,draw:function(e){var t=this.find(".freetime-table"),o=function(){var t=e.view.timeToPosition(_.now());e.view.currentTimeNode.css("left",t+"%").toggle(0!==t&&100!==t)};if(!e.view.currentTimeNode){e.view.currentTimeNode=$('<div class="current-time" draggable="false">');var a=setInterval(o,3e4);e.view.on("dispose",function(){clearInterval(a)})}o(),t.append(e.view.currentTimeNode)}}),e.extend({className:"freetime-time-view",initialize:function(e){var t=this;this.pointHeader=r,this.pointBody=l,this.headerNodeRow1=$('<div class="freetime-time-view-header row1">').on("click",".control.next,.control.prev,.control.today",t.onControlView.bind(this)),this.headerNodeRow2=$('<div class="freetime-time-view-header row2">').on("click",".freetime-hour",t.onSelectHour.bind(this)),this.bodyNode=$('<div class="freetime-time-view-body">').on("mousedown",".freetime-table",t.onMouseDown.bind(this)).on("mouseup",".freetime-table",t.onMouseUp.bind(this)).on("mousemove",".freetime-table",t.onMouseMove.bind(this)).on("dblclick",".freetime-table-cell",t.onSelectHour.bind(this)).on("scroll",t.onScroll.bind(this)),this.model.get("attendees").on("add reset",t.getAppointments.bind(this)),this.model.get("attendees").on("remove",t.removeParticipant.bind(this)),this.model.on("change:onlyWorkingHours",t.onChangeWorkingHours.bind(this)),this.model.on("change:startDate",function(){"month"===t.model.get("dateRange")&&t.renderHeader(!0),t.getAppointmentsInstant()}),this.model.on("change:dateRange",t.onChangeDateRange.bind(this)),this.model.on("change:timeSlots",t.renderBody.bind(this)),this.model.on("change:zoom",t.updateZoom.bind(this)),this.model.on("change:showFree",t.updateVisibility.bind(this)),this.onResize=this.onResize.bind(this),this.parentView=e.parentView,this.parentView.options.popup&&(this.popupClosed=!0,this.parentView.options.popup.on("open",function(){t.popupClosed=!1,t.renderBody()}));var o="week"===this.model.get("dateRange")?7:this.model.get("startDate").daysInMonth();if(this.grid=100/(4*(this.model.get("onlyWorkingHours")?this.model.get("endHour")-this.model.get("startHour")+1:24)*o),e.parentModel&&void 0!==e.parentModel.get("startDate")&&void 0!==e.parentModel.get("endDate")){var a=n.isAllday(e.parentModel)?moment(e.parentModel.get("startDate").value).startOf("day").valueOf():moment.tz(e.parentModel.get("startDate").value,e.parentModel.get("startDate").tzid).valueOf(),s=n.isAllday(e.parentModel)?moment(e.parentModel.get("endDate").value).add(1,"days").startOf("day").valueOf():moment.tz(e.parentModel.get("endDate").value,e.parentModel.get("endDate").tzid).valueOf();this.lassoStart=this.timeToPosition(a),this.lassoEnd=this.timeToPosition(s),this.keepScrollpos=a,this.center=!0}e.parentModel||moment().startOf(this.model.get("dateRange")).isoWeek()!==this.model.get("startDate").isoWeek()||(this.keepScrollpos="today"),this.updateVisibility(),this.listenToDOM(window,"resize",this.onResize)},updateZoom:function(){var e=this.bodyNode.find(".freetime-table");if(e.length){var t=e.find(".freetime-time-table").children().length,o=e.width(),a=e.parent().scrollLeft(),s=parseInt(this.model.get("zoom"),10)/100*60;this.headerNodeRow2.find(".freetime-hour").css({"min-width":s+"px",width:s+"px","max-width":s+"px"}),e.find(".freetime-table-cell").css("width",s+"px"),e.css("width",t*s+"px").parent().scrollLeft(a/o*t*s)}},updateVisibility:function(){this.bodyNode.addClass("showReserved").toggleClass("showFree",this.model.get("showFree"))},onScroll:function(){this.headerNodeRow2.scrollLeft(this.bodyNode.scrollLeft())},onChangeDateRange:function(e,t){this.model.set("startDate",moment(this.model.get("viewStartedWith")).startOf(t),{silent:!0}),this.onChangeWorkingHours()},onChangeWorkingHours:function(){var e="week"===this.model.get("dateRange")?7:this.model.get("startDate").daysInMonth();this.grid=100/(4*(this.model.get("onlyWorkingHours")?this.model.get("endHour")-this.model.get("startHour")+1:24)*e),this.lassoNode&&this.lassoStart&&(this.lassoStart=this.timeToPosition(this.lassoStartTime),this.lassoEnd=this.timeToPosition(this.lassoEndTime),this.updateLasso());var t=this.bodyNode.find(".freetime-table");if(t.length){var o=t.width(),a=t.parent().scrollLeft();this.keepScrollpos=this.positionToTime(a/o*100,!0)}this.renderHeader(!0),this.getAppointmentsInstant()},renderHeader:function(e){var o=new t.Baton({view:this,model:this.model});this.headerNodeRow2.empty(),e?_(this.pointHeader.list()).findWhere({id:"timeline"}).invoke("draw",this.headerNodeRow1,o):(this.headerNodeRow1.empty(),this.pointHeader.invoke("draw",this.headerNodeRow1,o))},renderBody:function(){var e=!1,o=this;if(_(this.model.get("attendees").toJSON()).each(function(t){e||_(o.model.get("timeSlots")).has([t.entity||t.uri])||(e=!0)}),e)this.getAppointmentsInstant();else{var a=new t.Baton({view:this,model:this.model});this.bodyNode.empty(),this.pointBody.invoke("draw",this.bodyNode,a)}},getAppointments:_.debounce(function(){this.getAppointmentsInstant(!0)},10),getAppointmentsInstant:function(e){var t=this.bodyNode.find(".freetime-table").width(),s=this.bodyNode.scrollLeft();!this.keepScrollpos&&t&&(this.keepScrollpos=this.positionToTime(s/t*100)),this.bodyNode.busy(!0);var i,d,r=this,l=l=this.model.get("attendees").toJSON(),m={};if(0===l.length)return $.when();if(!0===e){var h=_(r.model.get("timeSlots")).keys();l=_(l).filter(function(e){return-1===_(h).indexOf(String(e.entity||e.uri))})}return this.model.get("onlyWorkingHours")?(i=moment(this.model.get("startDate")).add(this.model.get("startHour"),"hours").utc(),d=moment(i).add("week"===this.model.get("dateRange")?7:this.model.get("startDate").daysInMonth()-1,"days").add(this.model.get("endHour")-this.model.get("startHour"),"hours").utc()):(i=moment(this.model.get("startDate")).startOf("day").utc(),d=moment(i).add(1,this.model.get("dateRange")+"s").utc()),a.freebusy(l,{from:i.format(n.ZULU_FORMAT),until:d.format(n.ZULU_FORMAT)}).done(function(t){if(0===t.length&&0!==l.length)return r.bodyNode.idle(),void require(["io.ox/core/yell"],function(e){e("error",o("Could not get appointment information"))});!0===e&&(m=r.model.get("timeSlots"));for(var a=0;a<l.length;a++)m[l[a].entity||l[a].uri]=_.compact(t[a].freeBusyTime);r.bodyNode.idle(),r.model.set("timeSlots",m,{silent:!0}).trigger("change:timeSlots")}).fail(function(e){r.bodyNode.idle(),require(["io.ox/core/yell"],function(t){t(e)})})},removeParticipant:function(e){var t=this.bodyNode.find('.appointment-table[data-value="'+(e.get("entity")||e.get("uri"))+'"]'),o=this.model.get("timeSlots");t.length&&(t.remove(),this.onResize(),this.parentView.participantsSubview.bodyNode.trigger("scroll")),delete o[e.get("entity")||e.get("uri")],this.model.set("timeSlots",o,{silent:!0})},onResize:function(){this.headerNodeRow2.css("margin-right",Math.max(0,this.bodyNode[0].offsetWidth-this.bodyNode[0].clientWidth-1)+"px")},onSelectHour:function(e){var t=parseInt($(e.target).val(),10),o=100/(("week"===this.model.get("dateRange")?7:this.model.get("startDate").daysInMonth())*(this.model.get("onlyWorkingHours")?this.model.get("endHour")-this.model.get("startHour")+1:24));this.lassoStart=t*o,this.lassoEnd=(t+1)*o,this.updateLasso(!0),e.altKey&&this.lassoEnd&&this.lassoStart&&this.lassoStart!==this.lassoEnd&&this.parentView.save()},timeToPosition:function(e){var t,o=moment(this.model.get("startDate")).startOf("day"),a=moment(o).add(1,"days"),s=0,i=this.model.get("onlyWorkingHours")?24-a.diff(o,"hours"):0,n="week"===this.model.get("dateRange")?7:this.model.get("startDate").daysInMonth(),d=100/(n*(this.model.get("endHour")-this.model.get("startHour")+1)),r=100/n,l=!1;for(this.model.get("onlyWorkingHours")?(o=moment(this.model.get("startDate")).add(this.model.get("startHour"),"hours"),a=moment(o).add(this.model.get("endHour")-this.model.get("startHour")+1,"hours")):(o=moment(this.model.get("startDate")).startOf("day"),a=moment(o).add(1,"days"));s<n;s++){if(e<o.valueOf()){l=!0;break}if(e<a.valueOf())break;if(s===n-1&&e>a.valueOf()){l=!0,s++;break}t=o.clone(),o.add(1,"days"),this.model.get("onlyWorkingHours")&&0===i&&(i=24-o.diff(t,"hours")),a.add(1,"days")}return s*r+(l?0:(e-o.valueOf())/(a.valueOf()-o.valueOf())*r+i*d)},positionToTime:function(e,t){var o=100/("week"===this.model.get("dateRange")?7:this.model.get("startDate").daysInMonth()),a=Math.floor(e/o),s=e-o*a,i=36e5*((t?!this.model.get("onlyWorkingHours"):this.model.get("onlyWorkingHours"))?this.model.get("endHour")-this.model.get("startHour")+1:24),n=Math.round(s/o*i),d=moment(this.model.get("startDate")).add(a,"days");return(t?!this.model.get("onlyWorkingHours"):this.model.get("onlyWorkingHours"))&&d.add(this.model.get("startHour"),"hours"),d.add(n,"milliseconds").add(moment(d).startOf("day")._offset-d._offset,"minutes").valueOf()},setToGrid:function(e){var t=!this.model.get("showFineGrid")||"1000"!==this.model.get("zoom")&&1e3!==this.model.get("zoom")?this.grid:this.grid/3;return t*Math.round(e/t)},updateLasso:function(e){if(this.lassoNode)if(void 0!==this.lassoStart){var t,o;this.lassoStart===this.lassoEnd||void 0===this.lassoEnd?(o=void 0===this.lassoEnd||this.lassoStart<this.lassoEnd?this.lassoStart:this.lassoEnd,t=2,this.lassoNode.css({left:o+"%",width:t+"px"})):(this.lassoStart<this.lassoEnd?(o=this.lassoStart,t=this.lassoEnd-o):(o=this.lassoEnd,t=this.lassoStart-o),this.lassoNode.css({left:o+"%",width:t+"%"})),e&&(this.lassoStartTime=this.positionToTime(this.lassoStart),this.lassoEndTime=this.positionToTime(this.lassoEnd)),this.lassoEndTime<moment(this.model.get("startDate")).startOf("day").valueOf()||this.lassoStartTime>moment(this.model.get("startDate")).endOf(this.model.get("dateRange")).valueOf()?this.lassoNode.hide():this.lassoNode.show()}else this.lassoNode.hide()},onMouseMove:function(e){if(this.lasso){if(_.device("safari")){if(0===e.which)return void this.onMouseUp(e)}else if(!e.buttons)return void this.onMouseUp(e);var t=$(e.currentTarget);this.lassoEnd=this.setToGrid((e.pageX-t.offset().left)/t.outerWidth()*100),this.updateLasso(!0)}},onMouseDown:function(e){this.lasso=!0;var t=$(e.currentTarget);this.lassoStart=this.setToGrid((e.pageX-t.offset().left)/t.outerWidth()*100),this.lassoEnd=void 0,this.updateLasso(!0)},onMouseUp:function(e){if(this.lasso){var t=$(e.currentTarget);this.lassoEnd=this.setToGrid((e.pageX-t.offset().left)/t.outerWidth()*100),this.lassoEnd===this.lassoStart&&(this.lassoEnd=this.lassoStart=void 0),this.updateLasso(!0),this.lasso=!1,e.altKey&&this.lassoEnd&&this.lassoStart&&this.lassoStart!==this.lassoEnd&&this.parentView.save()}},createAppointment:function(){if(this.lassoStart!==this.lassoEnd&&void 0!==this.lassoStart&&void 0!==this.lassoEnd){this.lassoStartTime&&this.lassoEndTime||this.updateLasso(!0);var e=Math.min(this.lassoStartTime,this.lassoEndTime),t=Math.max(this.lassoStartTime,this.lassoEndTime),o=this.model.get("attendees").toJSON();return e=this.parentView.parentModel?moment.tz(e,this.parentView.parentModel.get("startDate").tzid):moment(e),t=this.parentView.parentModel?moment.tz(t,this.parentView.parentModel.get("startDate").tzid):moment(t),e.startOf("minute"),t.startOf("minute"),e.valueOf()!==t.valueOf()&&e.valueOf()===moment(e).startOf("day").valueOf()&&t.valueOf()===moment(t).startOf("day").valueOf()?{startDate:{value:e.format("YYYYMMDD")},endDate:{value:t.subtract(1,"days").format("YYYYMMDD")},attendees:o}:(this.parentView.parentModel&&t.tz(this.parentView.parentModel.get("endDate").tzid),{startDate:{value:e.format("YYYYMMDD[T]HHmmss"),tzid:e.tz()},endDate:{value:t.format("YYYYMMDD[T]HHmmss"),tzid:t.tz()},attendees:o})}},setDate:function(e){var t=moment(this.model.get("startDate"));if(_.isString(e))switch(e){case"prev":t.subtract(1,this.model.get("dateRange")+"s");break;case"next":t.add(1,this.model.get("dateRange")+"s");break;case"today":t=moment().startOf(this.model.get("dateRange"))}else if(_.isNumber(e)){var o=this.model.get("onlyWorkingHours")?this.model.get("startHour"):0;this.keepScrollpos=moment(e).hours(o).valueOf(),t=moment(e).startOf(this.model.get("dateRange"))}t.startOf("day"),this.model.set("startDate",t)},onControlView:function(e){e.preventDefault();var t=$(e.currentTarget);t.hasClass("next")&&this.setDate("next"),t.hasClass("prev")&&this.setDate("prev"),t.hasClass("today")&&this.setDate("today"),this.trigger("onRefresh")}})});