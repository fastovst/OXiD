define("io.ox/calendar/freetime/main",["io.ox/backbone/views/disposable","io.ox/calendar/freetime/model","io.ox/calendar/freetime/participantsView","io.ox/calendar/freetime/timeView","io.ox/calendar/api","gettext!io.ox/calendar","settings!io.ox/calendar","io.ox/calendar/util","io.ox/core/folder/api","less!io.ox/calendar/freetime/style","less!io.ox/calendar/style"],function(e,t,i,o,s,n,a,d,r){"use strict";var l=["zoom","onlyWorkingHours","showFree","showReserved","compact","dateRange","showFineGrid"],p=_([10,25,50,100,200,400,1e3]).map(function(e){return"zoomlevel-"+e}).join(" "),u=e.extend({className:"freetime-view",initialize:function(e){var t=this,n=t.refresh.bind(this);this.options=e||{},this.parentModel=e.parentModel,this.app=e.app;var a,r=[];return e.parentModel?(r=e.parentModel.get("attendees"),a=d.isAllday(e.parentModel)?moment(e.parentModel.get("startDate").value):d.getMoment(e.parentModel.get("startDate")),this.model.set("startDate",a.startOf(this.model.get("dateRange")))):(e.startDate&&(a=e.startDate,this.model.set("startDate",moment(e.startDate).startOf(this.model.get("dateRange")))),e.attendees&&(r=e.attendees)),this.model.set("viewStartedWith",moment(a)),this.participantsSubview=new i({model:this.model,parentView:this}),this.timeSubview=new o({model:this.model,parentModel:e.parentModel,parentView:this}),this.model.on("change:zoom",t.updateZoom.bind(this)),this.model.on("change:compact",t.updateClasses.bind(this,"compact")),this.model.on("change:onlyWorkingHours",t.updateClasses.bind(this,"onlyWorkingHours")),this.model.on("change:showFineGrid",t.updateClasses.bind(this,"showFineGrid")),this.model.on(_(l).map(function(e){return"change:"+e}).join(" "),t.updateSettings.bind(this)),s.on("refresh.all update",n),this.on("dispose",function(){t.timeSubview.dispose(),t.participantsSubview.dispose(),s.off("refresh.all update",n)}),this.timeSubview.bodyNode.on("scroll",function(){0===t.participantsSubview.bodyNode[0].scrollTop&&0===this.scrollTop||(t.participantsSubview.bodyNode[0].scrollTop=this.scrollTop)}),this.participantsSubview.bodyNode.on("wheel",function(e){t.timeSubview.bodyNode[0].scrollTop=t.timeSubview.bodyNode[0].scrollTop+e.originalEvent.deltaY*(_.device("firefox")?4:1)}),this.header=$('<div class="freetime-view freetime-view-header">').addClass("zoomlevel-"+this.model.get("zoom")),this.body=$('<div class="freetime-view freetime-view-body">').addClass("zoomlevel-"+this.model.get("zoom")),this.updateClasses("onlyWorkingHours"),this.updateClasses("showFineGrid"),this.updateClasses("compact"),this.model.get("attendees").add(r)},updateClasses:function(e){this.header.toggleClass(e,this.model.get(e)),this.body.toggleClass(e,this.model.get(e))},updateSettings:function(){var e=this;_(l).each(function(t){a.set("scheduling/"+t,e.model.get(t))}),a.save()},updateZoom:function(){this.header.removeClass(p).addClass("zoomlevel-"+this.model.get("zoom")),this.body.removeClass(p).addClass("zoomlevel-"+this.model.get("zoom"))},renderHeader:function(){return this.header.empty(),this.header.append($('<div class="header-row2">').append(this.participantsSubview.headerNodeRow,this.timeSubview.headerNodeRow2)),this.participantsSubview.renderHeader(),this.timeSubview.renderHeader(),this.header},renderBody:function(){return this.body.empty(),this.body.append(this.participantsSubview.bodyNode,this.timeSubview.bodyNode),this.participantsSubview.renderBody(),this.timeSubview.renderBody(),this.body},refresh:_.debounce(function(){this.timeSubview.getAppointmentsInstant()},200),render:function(){return this.renderHeader(),this.renderBody(),this},createDistributionlistButton:function(){var e=this,t=$('<button type="button" class="btn btn-link scheduling-distributionlist-button">').text(n("Save as distribution list"));return t.on("click",function(){d.resolveAttendees({attendees:e.model.get("attendees").toJSON()}).done(function(e){require(["settings!io.ox/core"],function(t){ox.launch("io.ox/contacts/distrib/main").done(function(){this.create(t.get("folder/contacts"),{distribution_list:e})})})})}),t},save:function(){if(this.options.isApp&&this.app){var e=this.createAppointment();e?(e.folder=r.getDefaultFolder("calendar"),ox.load(["io.ox/calendar/edit/main"]).done(function(t){t.getApp().launch().done(function(){this.create(e)})}),this.app.quit()):require(["io.ox/core/yell"],function(e){e("info",n("Please select a time for the appointment"))})}else this.options.popup.invokeAction("save")},createFooter:function(){var e=$('<button type="button" class="btn btn-primary pull-right scheduling-save-button">').text(n("Create appointment")),t=this.createDistributionlistButton(),i=$('<div class="scheduling-app-footer clearfix">').append(t,e);return e.on("click",this.save.bind(this)),i},createAppointment:function(){return this.timeSubview.createAppointment()}});return{FreetimeView:u,showDialog:function(e){return e=e||{},e.model=new t,require(["io.ox/backbone/views/modal"]).then(function(t){var i,o;return i=new t({async:!0,focus:"a.control.prev",maximize:!0,title:e.title||n.pgettext("app","Scheduling"),width:"100%"}).build(function(){e.popup=this,o=new u(e),this.$el.addClass("freetime-popup"),this.$el.find(".modal-header").append(o.timeSubview.headerNodeRow1).after(o.header),this.$body.append(o.body),this.$el.find(".modal-footer").prepend(o.createDistributionlistButton().addClass("pull-left")),o.render()}).addCancelButton().addButton({action:"save",label:e.label||n("Create appointment")}).on("close",function(){o.dispose()}).open(),{dialog:i,view:o}})},FreetimeModel:t,getApp:function(){var e,i=ox.ui.createApp({name:"io.ox/calendar/scheduling",title:n.pgettext("app","Scheduling"),userContent:!0,closable:!0});return i.setLauncher(function(o){(o=o||{}).model=new t,o.isApp=!0,o.app=i;var s=$('<button type="button" class="btn btn-link scheduling-app-close">').attr("title",n("Close")).append($('<i class="fa fa-close" aria-hidden="true">')).on("click",function(){i.quit()});e=ox.ui.createWindow({name:"io.ox/calendar/scheduling",chromeless:!0}),i.setWindow(e),i.view=new u(o),e.nodes.main.append($('<div class="scheduling-app-header">').append($('<h4 class="app-title">').text(n.pgettext("app","Scheduling")),i.view.timeSubview.headerNodeRow1,s),i.view.header,$('<div class="scheduling-app-body" draggable="false">').append(i.view.body),i.view.createFooter()),e.show(),i.view.render(),e.nodes.outer.find("a.control.prev").focus()}),i.setQuit(function(){return i.view.dispose(),$.when()}),i.failSave=function(){return!!this.view.model&&{description:n.pgettext("app","Scheduling"),module:"io.ox/calendar/freetime",point:{attendees:this.view.model.get("attendees"),startDate:this.view.model.get("startDate").valueOf(),lassoStart:this.view.timeSubview.lassoStart,lassoEnd:this.view.timeSubview.lassoEnd}}},i.failRestore=function(e){return this.view.timeSubview.lassoStart=e.lassoStart,this.view.timeSubview.lassoEnd=e.lassoEnd,this.view.timeSubview.setDate(e.startDate),this.view.model.set("viewStartedWith",moment(e.startDate)),this.view.timeSubview.updateLasso(!0),e.lassoStart?this.view.timeSubview.keepScrollpos=this.view.timeSubview.lassoStartTime:this.view.timeSubview.keepScrollpos="today",this.view.model.get("attendees").add(e.attendees)},i.getContextualHelp=function(){return"ox.appsuite.user.sect.calendar.add.scheduling.html"},i}}});