define("io.ox/calendar/actions",["io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/calendar/api","io.ox/calendar/util","io.ox/core/print","gettext!io.ox/calendar","io.ox/core/capabilities","io.ox/core/folder/api","io.ox/core/yell","io.ox/backbone/views/modal","settings!io.ox/calendar"],function(e,i,t,n,a,o,c,r,l,d,s){"use strict";function p(e,i){if(!$(e.e.target).hasClass("disabled")){var a=e.first(),c=t.reduce(a);(e.noFolderCheck?$.when():r.get(c.folder)).always(function(s){c.attendee={entity:s.error||e.noFolderCheck||!r.is("shared",s)?ox.user_id:s.created_by,partStat:i?"ACCEPTED":"DECLINED"},i&&(c.alarms=n.getDefaultAlarms(a)),a.seriesId===a.id&&c.recurrenceId?new d({title:o("Change appointment status"),width:600}).build(function(){this.$body.append(o(i?"This appointment is part of a series. Do you want to confirm the whole series or just one appointment within the series?":"This appointment is part of a series. Do you want to decline the whole series or just one appointment within the series?"))}).addCancelButton({left:!0}).addButton({label:o(i?"Accept appointment":"Decline appointment"),action:"appointment",className:"btn-default"}).addButton({label:o(i?"Accept series":"Decline series"),action:"series"}).on("action",function(i){"cancel"!==i&&("series"===i&&delete c.recurrenceId,$(e.e.target).addClass("disabled"),t.confirm(c,n.getCurrentRangeOptions()).fail(function(i){l(i),$(e.e.target).removeClass("disabled")}))}).open():($(e.e.target).addClass("disabled"),t.confirm(c).fail(function(i){l(i),$(e.e.target).removeClass("disabled")}))})}}function u(e){var i={};return _(e.flags).values().forEach(function(e){i[e]=!0}),i}function f(e,i){return!!(e.accepted||e.declined||e.tentative||e.needs_action)&&(!(!e.attendee&&!e.organizer)||(!e.attendee_on_behalf&&!e.organizer_on_behalf||i.collection.has("modify")))}var m=i.Action;new m("io.ox/calendar/actions/switch-to-list-view",{action:function(e){e.app.pages.changePage("list",{disableAnimations:!0})}}),new m("io.ox/calendar/actions/switch-to-month-view",{action:function(e){e.app.pages.changePage("month",{disableAnimations:!0})}}),new m("io.ox/calendar/actions/switch-to-fullweek-view",{toggle:_.device("!smartphone"),action:function(e){e.app.pages.changePage(e.app,"week:week")}}),new m("io.ox/calendar/actions/switch-to-week-view",{toggle:_.device("!smartphone"),action:function(e){e.app.pages.changePage(e.app,"week:workweek")}}),new m("io.ox/calendar/actions/switch-to-day-view",{action:function(e){e.app.pages.changePage(e.app,"week:day")}}),new m("io.ox/calendar/detail/actions/sendmail",{capabilities:"webmail",collection:"one",every:"attendees !== undefined",action:function(e){var i=e.first();n.resolveAttendees(i,{filterSelf:!0}).done(function(e){var t={};e=_(e).chain().filter(function(e){return!(e.mail in t)&&(t[e.mail]=!0)}).map(function(e){return[e.display_name,e.mail]}).value(),ox.registry.call("mail-compose","open",{to:e,subject:i.summary})})}}),new m("io.ox/calendar/detail/actions/invite",{capabilities:"calendar",device:"!guest",collection:"one",every:"attendees !== undefined",action:function(e){ox.load(["io.ox/calendar/actions/invite"]).done(function(i){i(e.first())})}}),new m("io.ox/calendar/detail/actions/save-as-distlist",{capabilities:"contacts",collection:"one",matches:function(e){var i=e.first();return _.isArray(i.attendees)&&i.attendees.length>1},action:function(e){var i=e.first();n.resolveAttendees(i).done(function(e){require(["settings!io.ox/core"],function(t){ox.launch("io.ox/contacts/distrib/main").done(function(){this.create(t.get("folder/contacts"),{distribution_list:e,display_name:i.summary})})})})}}),new m("io.ox/calendar/detail/actions/edit",{collection:"one && modify",every:"id !== undefined",matches:function(e){var i=e.first(),t=r.pool.getModel(i.folder);return n.allowedToEdit(i,t)},action:function(e){ox.load(["io.ox/calendar/actions/edit"]).done(function(i){i(e.first())})}}),new m("io.ox/calendar/detail/actions/delete",{collection:"some && delete",matches:function(e){var i=u(e.first());return!(!i.organizer&&!i.organizer_on_behalf)||!(!i.attendee&&!i.attendee_on_behalf)},action:function(e){ox.load(["io.ox/calendar/actions/delete"]).done(function(i){i(e.array())})}}),new m("io.ox/calendar/detail/actions/create",{capabilities:"!guest",action:_.debounce(function(e,i){ox.load(["io.ox/calendar/actions/create"]).done(function(t){t(e,i)})},500,!0)}),new m("io.ox/calendar/detail/actions/changeAlarms",{collection:"one",matches:function(e){var i=e.first(),t=u(i);if(!i.id||!i.folder)return!1;var n=r.pool.getModel(i.folder).toJSON();return-1!==n.supported_capabilities.indexOf("alarms")&&!(r.is("public",n)&&!t.attendee&&!t.organizer)},action:function(e){ox.load(["io.ox/calendar/actions/change-alarms"]).done(function(i){i(e.first())})}}),new m("io.ox/calendar/detail/actions/changestatus",{collection:"one",matches:function(e){var i=e.first(),t=u(i);return!!i.id&&f(t,e)},action:function(e){var i=e.first();ox.load(["io.ox/calendar/actions/acceptdeny"]).done(function(n){t.get(i).then(function(i){n(i.toJSON(),{noFolderCheck:e.noFolderCheck})},function(){n(i,{noFolderCheck:e.noFolderCheck})})})}}),new m("io.ox/calendar/detail/actions/follow-up",{collection:"one && create && read",action:function(e){ox.load(["io.ox/calendar/actions/follow-up"]).done(function(i){i(e.model)})}}),new m("io.ox/calendar/detail/actions/print-appointment",{device:"!smartphone",capabilities:"calendar-printing",collection:"some && read",action:function(e){var i=e.array();1!==i.length?new d({title:o("Do you want the appointments printed in detail or as a compact list?"),previousFocus:$('.io-ox-calendar-main .classic-toolbar [data-action="more"]')}).addCancelButton().addButton({label:o("Compact"),action:"compact",className:"btn-default"}).addButton({label:o("Detailed"),action:"detailed"}).on("detailed",function(){a.request("io.ox/calendar/print",i)}).on("compact",function(){a.request("io.ox/calendar/print-compact",i)}).open():a.request("io.ox/calendar/print",i)}}),new m("io.ox/calendar/detail/actions/export",{collection:"some && read",action:function(e){require(["io.ox/core/download"],function(i){i.exported({list:[].concat(e.data),format:"ical"})})}}),new m("io.ox/calendar/detail/actions/print",{capabilities:"calendar-printing",action:function(e){var i=e.app.perspective;i.print&&i.print()}}),new m("io.ox/calendar/detail/actions/move",{collection:"some && delete",every:"recurrenceId === undefined",action:function(e){var i=e.array();ox.load(["io.ox/core/folder/actions/move","settings!io.ox/calendar"]).done(function(a,c){r.get(i[0].folder).done(function(l){var d;n.hasFlag(i[0],"attendee")||n.hasFlag(i[0],"organizer")?d=ox.user_id:n.hasFlag(i[0],"attendee_on_behalf")?d=l.created_by:n.hasFlag(i[0],"organizer_on_behalf")&&(d=i[0].organizer.entity),a.item({api:t,button:o("Move"),flat:!0,indent:!1,list:i,module:"calendar",root:"1",settings:c,success:{single:"Appointment has been moved",multiple:"Appointments have been moved"},target:e.target,title:o("Move"),type:"move",all:n.getCurrentRangeOptions(),disable:function(e,t){var a=e.id===i[0].folder,o=e.created_by===d,c=r.is("public",e),s=r.is("public",l),p=n.hasFlag(i[0],"scheduled"),u=r.can("create",e),f=n.hasFlag(i[0],"organizer")||n.hasFlag(i[0],"organizer_on_behalf");return a||!(!s&&!p||o||c&&f)||!u||t&&/^virtual/.test(t.folder)}})})})}}),new m("io.ox/calendar/detail/actions/change-organizer",{toggle:s.get("chronos/allowChangeOfOrganizer",!1),collection:"one && modify",matches:function(e){var i=e.first();return!(!i||!i.flags)&&(!_(i.attendees).some(function(e){return!_(e).has("entity")})&&((n.hasFlag(i,"organizer")||n.hasFlag(i,"organizer_on_behalf")||(n.hasFlag(i,"attendee")||n.hasFlag(i,"attendee_on_behalf"))&&"MODIFY"===i.attendeePrivileges)&&n.hasFlag(i,"scheduled")))},action:function(e){require(["io.ox/calendar/actions/change-organizer"],function(i){i.openDialog(e.first())})}}),new m("io.ox/calendar/actions/today",{matches:function(e){var i=e.app.perspective;return!!i&&("month"===i.getName()||"week"===i.getName())},action:function(e){var i=e.app.perspective;i.setStartDate?i.setStartDate():i.gotoMonth&&i.gotoMonth("today")}}),new m("io.ox/calendar/actions/freebusy",{device:"desktop",capabilities:"freebusy !alone !guest",action:function(e){require(["io.ox/calendar/freetime/main","io.ox/core/api/user"],function(i,t){t.get().done(function(t){var a=e.app.perspective,o=_.now(),c=a&&a.model&&a.model.get("date")?a.model.get("date").valueOf():o,r=a?a.app.props.get("layout"):"";c<o&&0===r.indexOf("week:")&&o<c+864e5*("week:workweek"===r?s.get("numDaysWorkweek"):7)&&(c=o),i.getApp().launch({startDate:c,attendees:[n.createAttendee(t,{partStat:"ACCEPTED"})]})})})}}),new m("io.ox/calendar/actions/showNext",{requires:!0,action:function(e){var i=e.app.perspective;i&&i.setStartDate("next")}}),new m("io.ox/calendar/actions/showPrevious",{requires:!0,action:function(e){var i=e.app.perspective;i&&i.setStartDate("prev")}}),new m("io.ox/calendar/actions/showToday",{requires:!0,action:function(e){var i=e.app.perspective;i&&i.setStartDate(moment())}}),new m("io.ox/calendar/premium/actions/share",{capabilities:"caldav",requires:function(){return c.has("client-onboarding")},action:function(){require(["io.ox/onboarding/clients/wizard"],function(e){e.run()})}}),new m("io.ox/calendar/actions/accept-appointment",{collection:"one",matches:function(e){var i=u(e.first());return!i.accepted&&f(i,e)},action:_.partial(p,_,!0)}),new m("io.ox/calendar/actions/decline-appointment",{collection:"one",matches:function(e){var i=u(e.first());return!i.declined&&f(i,e)},action:p});var x=[{index:100,prio:"hi",id:"edit",title:o("Edit"),ref:"io.ox/calendar/detail/actions/edit"},{index:110,prio:"hi",mobile:"hi",id:"accept",title:o("Accept"),ref:"io.ox/calendar/actions/accept-appointment"},{index:120,prio:"hi",mobile:"hi",id:"decline",title:o("Decline"),ref:"io.ox/calendar/actions/decline-appointment"},{index:150,prio:"hi",mobile:"lo",id:"changestatus",title:o("Change status"),ref:"io.ox/calendar/detail/actions/changestatus"},{index:155,prio:"hi",mobile:"lo",id:"changereminder",title:o("Change reminders"),ref:"io.ox/calendar/detail/actions/changeAlarms"},{index:300,prio:"hi",mobile:"lo",id:"delete",title:o("Delete"),ref:"io.ox/calendar/detail/actions/delete"},{index:400,prio:"hi",mobile:"lo",id:"follow-up",title:o("Follow-up"),ref:"io.ox/calendar/detail/actions/follow-up"},{index:500,prio:"lo",mobile:"lo",id:"move",title:o("Move"),drawDisabled:!0,ref:"io.ox/calendar/detail/actions/move"},{index:550,prio:"lo",id:"export",title:o("Export"),ref:"io.ox/calendar/detail/actions/export"},{index:600,prio:"lo",id:"print",title:o("Print"),ref:"io.ox/calendar/detail/actions/print-appointment"},{index:700,prio:"lo",mobile:"lo",id:"send mail",section:"participants",sectionTitle:o("Participant related actions"),title:o("Send email to all participants"),ref:"io.ox/calendar/detail/actions/sendmail"},{index:800,prio:"lo",mobile:"lo",id:"invite",section:"participants",sectionTitle:o("Participant related actions"),title:o("Invite to new appointment"),ref:"io.ox/calendar/detail/actions/invite"},{index:900,prio:"lo",mobile:"lo",id:"save as distlist",section:"participants",sectionTitle:o("Participant related actions"),title:o("Save as distribution list"),ref:"io.ox/calendar/detail/actions/save-as-distlist"},{index:1e3,prio:"lo",mobile:"lo",id:"change-organizer",section:"participants",sectionTitle:o("Participant related actions"),title:o("Change organizer"),ref:"io.ox/calendar/detail/actions/change-organizer"}];e.point("io.ox/calendar/links/inline").extend(x),e.point("io.ox/calendar/folderview/premium-area").extend({index:100,id:"inline-premium-links",draw:function(e){this.append(e.renderActions("io.ox/calendar/links/premium-links",e))}}),e.point("io.ox/calendar/links/premium-links").extend({index:100,id:"share-calendar",action:"io.ox/calendar/premium/actions/share",title:o("Synchronize calendar")})});