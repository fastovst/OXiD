define("io.ox/calendar/actions/subscribe-ical",["io.ox/core/notifications","io.ox/core/extensions","io.ox/backbone/views/modal","io.ox/backbone/mini-views/common","io.ox/core/http","io.ox/core/folder/api","gettext!io.ox/calendar","settings!io.ox/calendar"],function(e,o,a,t,i,n,d,r){"use strict";function c(e){var o={uri:e.get("uri")};return e.get("ical-user")&&(o.login=e.get("ical-user")),e.get("ical-pw")&&(o.password=e.get("ical-pw")),i.PUT({module:"chronos/account",params:{action:"probe"},data:{"com.openexchange.calendar.provider":"ical","com.openexchange.calendar.config":o}})}return o.point("io.ox/calendar/subscribe/ical").extend({id:"input",index:100,render:function(){this.$body.append($('<div class="form-group">').append(t.getInputWithLabel("uri",d("iCal URL"),this.model)))}}),o.point("io.ox/calendar/subscribe/ical").extend({id:"alert",index:300,render:function(e){e.data.type&&e.data.text&&this.$body.append($('<div class="alert">').addClass("alert-"+e.data.type).text(e.data.text))}}),o.point("io.ox/calendar/subscribe/ical").extend({id:"login",index:400,render:function(e){if(e.data.showLogin){var o=_.uniqueId("form-control-label-");this.$body.append($('<div class="form-group">').append($("<label>").attr("for",o).text(d("Login")),new t.InputView({name:"ical-user",model:this.model,id:o,autocomplete:!1}).render().$el))}}}),o.point("io.ox/calendar/subscribe/ical").extend({id:"password",index:500,render:function(e){if(e.data.showPassword){var o=_.uniqueId("form-control-label-");this.$body.append($('<div class="form-group">').append($("<label>").attr("for",o).text(d("Password")),new t.PasswordView({name:"ical-pw",model:this.model,id:o,autocomplete:!1}).render().$el))}}}),o.point("io.ox/calendar/subscribe/ical").extend({id:"alarms",index:600,render:function(){this.$body.append($('<div class="alert alert-info">').text(d("Your default reminders will be applied to this calendar.")))}}),function(){new a({title:d("Subscribe to iCal feed"),point:"io.ox/calendar/subscribe/ical",help:"ox.appsuite.user.sect.calendar.folder.subscribe.html",model:new Backbone.Model,focus:"input",async:!0,width:500}).addCancelButton().addButton({label:d("Subscribe"),action:"subscribe"}).on("subscribe",function(){var a=this;c(this.model).then(function(e){return e.module="event",e["com.openexchange.calendar.config"]=_.extend({},e["com.openexchange.calendar.config"],{defaultAlarmDate:r.get("chronos/defaultAlarmDate",[]),defaultAlarmDateTime:r.get("chronos/defaultAlarmDateTime",[])}),n.create("1",e)}).then(function(){e.yell("success",d("iCal feed has been imported successfully")),a.close()}).catch(function(t){if(/^ICAL-PROV-401(0|1|2|3)$/.test(t.code)){var i={text:t.error,type:/^ICAL-PROV-401(0|2)$/.test(t.code)?"warning":"danger",showLogin:/^ICAL-PROV-401(0|1)$/.test(t.code),showPassword:!0},n=new o.Baton({view:a,model:a.model,data:i});a.$body.empty(),a.point.invoke("render",a,n)}else e.yell(t);a.idle()})}).open()}});