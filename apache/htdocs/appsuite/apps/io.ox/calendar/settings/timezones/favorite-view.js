define("io.ox/calendar/settings/timezones/favorite-view",["io.ox/backbone/mini-views/timezonepicker","settings!io.ox/core","gettext!io.ox/calendar","io.ox/backbone/views/modal","io.ox/backbone/mini-views/settings-list-view","io.ox/backbone/mini-views/listutils"],function(e,t,i,n,o,s){"use strict";var a=Backbone.Model.extend({initialize:function(){this.onChangeTimezone(),this.on("change:timezone",this.onChangeTimezone.bind(this))},defaults:{timezone:t.get("timezone")},onChangeTimezone:function(){this.tz=moment.tz(this.get("timezone")),this.set("utcOffset",this.tz.utcOffset()),this.set("title",this.get("timezone").replace(/_/g," ")),this.set("id",this.cid)}}),l=Backbone.Collection.extend({model:a,comparator:"utcOffset"});return Backbone.View.extend({tagName:"div",className:"favorite-view",events:{"click button":"openDialog",'click a[data-action="delete"]':"removeFavorite"},initialize:function(){this.collection=new l(_(this.model.get("favoriteTimezones")).map(function(e){return{timezone:e}})),this.listenTo(this.collection,"add remove",this.sync.bind(this)),this.listView=new o({tagName:"ul",collection:this.collection,childOptions:{customize:function(e){this.$(".list-item-title").before($('<span class="offset">').text(e.tz.format("Z")),$('<span class="timezone-abbr">').text(e.tz.zoneAbbr())),this.$(".list-item-controls").append(s.controlsDelete())}}})},render:function(){return this.$el.append($('<div class="form-group buttons">').append($('<button type="button" class="btn btn-primary">').append($('<i class="fa fa-plus" aria-hidden="true">'),$.txt(i("Add timezone")))),$('<div class="form-group">').append(this.listView.render().$el)),this},openDialog:function(){var t=this,o=new a;new n({title:i("Select favorite timezone")}).addCancelButton().addButton({label:i("Add"),action:"add"}).build(function(){this.$body.append($('<label for="settings-timezone">').text(i("Time zone")),new e({id:"settings-timezone",name:"timezone",model:o,className:"form-control"}).render().$el)}).on("add",function(){t.collection.findWhere({timezone:o.get("timezone")})?require(["io.ox/core/notifications"],function(e){e.yell("error",i("The selected timezone is already a favorite."))}):t.collection.add(o)}).open()},removeFavorite:function(e){var t=$(e.currentTarget).closest("li").attr("data-id");this.collection.remove(t),e.preventDefault()},sync:function(){var e=this.collection.pluck("timezone");this.model.set("favoriteTimezones",e),this.model.set("renderTimezones",_.intersection(e,this.model.get("renderTimezones",[]))),this.model.save()}})});