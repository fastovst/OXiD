define("io.ox/tasks/main",["io.ox/tasks/api","io.ox/core/extensions","gettext!io.ox/tasks","io.ox/core/tk/vgrid","io.ox/tasks/view-grid-template","io.ox/core/commons","io.ox/tasks/util","io.ox/tasks/view-detail","settings!io.ox/tasks","io.ox/core/folder/api","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/core/capabilities","io.ox/backbone/views/actions/util","io.ox/backbone/mini-views/dropdown","io.ox/tasks/toolbar","io.ox/tasks/mobile-navbar-extensions","io.ox/tasks/mobile-toolbar-actions"],function(e,t,o,i,n,a,r,s,d,l,c,p,g,f,u,v,b){"use strict";var w=ox.ui.createApp({name:"io.ox/tasks",id:"io.ox/tasks",title:"Tasks"});return w.mediator({"pages-mobile":function(e){if(!_.device("!smartphone")){var o=e.getWindow(),i=$('<div class="mobile-navbar">'),n=$('<div class="mobile-toolbar">').on("hide",function(){o.nodes.body.removeClass("mobile-toolbar-visible")}).on("show",function(){o.nodes.body.addClass("mobile-toolbar-visible")}),a=t.Baton({app:e});e.navbar=i,e.toolbar=n,e.pages=new f({appname:e.options.name,toolbar:n,navbar:i,container:o.nodes.main}),o.nodes.body.addClass("classic-toolbar-visible").append(i,n),e.pages.addPage({name:"folderTree",navbar:new g.NavbarView({baton:a,extension:"io.ox/tasks/mobile/navbar"})}),e.pages.addPage({name:"listView",startPage:!0,navbar:new g.NavbarView({baton:a,extension:"io.ox/tasks/mobile/navbar"}),toolbar:new g.ToolbarView({baton:a,page:"listView",extension:"io.ox/tasks/mobile/toolbar"}),secondaryToolbar:new g.ToolbarView({baton:a,page:"detailView",extension:"io.ox/tasks/mobile/toolbar"})}),e.pages.addPage({name:"detailView",navbar:new g.NavbarView({baton:a,extension:"io.ox/tasks/mobile/navbar"}),toolbar:new g.ToolbarView({baton:a,page:"detailView",extension:"io.ox/tasks/mobile/toolbar"})}),e.pages.setBackbuttonRules({listView:"folderTree"})}},"pages-desktop":function(e){_.device("smartphone")||(e.pages=new f(e),e.getWindow().nodes.main.addClass("vsplit"),e.pages.addPage({name:"listView",container:e.getWindow().nodes.main,classes:"leftside border-right"}),e.pages.addPage({name:"detailView",container:e.getWindow().nodes.main,classes:"rightside"}))},"navbars-mobile":function(e){_.device("smartphone")&&(e.pages.getNavbar("listView").setLeft(o("Folders")).setRight(o("Edit")),e.pages.getNavbar("folderTree").setTitle(o("Folders")).setLeft(!1).setRight(o("Edit")),e.pages.getNavbar("detailView").setTitle("").setLeft(o("Back")),e.pages.showPage("listView"))},"toolbars-mobile":function(e){_.device("smartphone")&&(e.pages.getNavbar("listView").on("leftAction",function(){e.pages.goBack()}),e.pages.getNavbar("detailView").on("leftAction",function(){e.pages.goBack()}),e.pages.getNavbar("listView").on("rightAction",function(){!0===e.props.get("checkboxes")?(e.grid.selection.clear(),e.grid.showTopbar(!1),e.grid.showToolbar(!1),e.pages.getNavbar("listView").setRight(o("Edit")).show(".left")):(e.grid.showTopbar(!0),e.grid.showToolbar(!0),e.pages.getNavbar("listView").setRight(o("Cancel")).hide(".left")),e.props.set("checkboxes",!e.props.get("checkboxes"))}))},"toggle-folder-editmode":function(e){if(!_.device("!smartphone")){e.toggleFolders=function(){var t=e.pages.getPage("folderTree"),i=e.props.get("mobileFolderSelectMode"),n=o(i?"Edit":"Cancel");e.props.set("mobileFolderSelectMode",!i),e.pages.getNavbar("folderTree").setRight(n),t.toggleClass("mobile-edit-mode",!i)}}},vsplit:function(e){var t=e.pages.getPage("listView"),i=e.pages.getPage("detailView");e.left=t,e.right=i.addClass("default-content-padding f6-target task-detail-container").attr({tabindex:-1,"aria-label":o("Task Details")}).scrollable()},vgrid:function(t){var o,i,s=t.grid,d=t.settings.get("vgrid/width/"+_.display());!_.device("touch")&&d&&(t.right.parent().css("left",d+"px"),t.left.css("width",d+"px")),t.left.append(t.gridContainer),t.left.attr({role:"navigation","aria-label":"Task list"}),s.addTemplate(n.main),a.wireGridAndAPI(s,e),a.wireGridAndWindow(s,t.getWindow()),a.wireFirstRefresh(t,e),a.wireGridAndRefresh(s,e,t.getWindow()),_.device("smartphone")&&t.grid.one("meta:update",function(){t.grid.getToolbar().find(".select-all-toggle, .grid-info").hide()}),o=function(){var t,o,i=s.prop("done"),n=s.prop("sort"),a=s.prop("order");return o="urgency"!==n?n:317,e.getAll({folder:this.prop("folder"),sort:o,order:a}).then(function(e){return t="urgency"!==n?_.copy(e,!0):r.sortTasks(e,a),i||(t=_(t).filter(function(e){return 3!==e.status})),t})},i=function(t){return e.getList(t).then(function(e){return _.copy(_.compact(e),!0)})},s.setAllRequest(o),s.setListRequest(i)},"restore-grid-options":function(e){function t(t){var o=e.getGridOptions(t);e.grid.props.set(o)}e.getGridOptions=function(t){var o=e.settings.get(["viewOptions",t],{});return _.extend({done:!0,sort:"urgency",order:"asc"},o)},e.on("folder:change",t),t(e.folder.get())},"store-grid-options":function(e){e.grid.props.on("change",_.debounce(function(){if(!e.props.get("find-result")){var t=e.folder.get(),o=e.grid.props.toJSON();e.settings.set(["viewOptions",t],{done:o.done,sort:o.sort,order:o.order}).save()}},500))},"grid-options":function(t){function o(){var t=i.getToolbar().find(".grid-options"),o=i.props;"desc"===o.get("order")?t.find(".fa-arrow-down").css("opacity",1).end().find(".fa-arrow-up").css("opacity",.4):t.find(".fa-arrow-up").css("opacity",1).end().find(".fa-arrow-down").css("opacity",.4),e.options.requests.all.sort="urgency"!==o.get("sort")?o.get("sort"):317,e.options.requests.all.order=o.get("order")}var i=t.grid;i.selection.on("change",t.removeButton),i.on("change:prop",function(){o()}),a.addGridToolbarFolder(t,i),o()},"show-task":function(i){var n,r,d;(n=function(t){i.right.busy(!0),_.isString(t)&&(t=_.cid(t)),t={folder:t.folder||t.folder_id,id:t.id},e.get(t).done(_.lfo(r)).fail(_.lfo(d,t))}).cancel=function(){_.lfo(r),_.lfo(d)},r=function(e){var o=t.Baton({data:e});o.disable("io.ox/tasks/detail-inline","inline-links"),i.right.idle().empty().append(s.draw(o))},d=function(e){i.right.idle().empty().append($.fail(o("Couldn't load that task."),function(){n(e)}))},a.wireGridAndSelectionChange(i.grid,"io.ox/tasks",n,i.right,e)},"select:task-mobile":function(e){_.device("!smartphone")||e.grid.getContainer().on("click",".vgrid-cell.selectable",function(){!0!==e.props.get("checkboxes")&&(e.grid.selection.trigger("pagechange:detailView"),e.pages.changePage("detailView"))})},"folder-view":function(e){_.device("smartphone")||(e.treeView=new c({app:e,contextmenu:!0,flat:!0,indent:!1,module:"tasks"}),p.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable())},"folder-view-mobile":function(e){if(!_.device("!smartphone")){var t=e.pages.getNavbar("folderTree"),o=e.pages.getPage("folderTree");t.on("rightAction",function(){e.toggleFolders()});var i=new c({app:e,contextmenu:!0,flat:!0,indent:!1,module:"tasks"});p.initialize({app:e,tree:i}),o.append(i.render().$el)}},props:function(e){e.props=new Backbone.Model({checkboxes:!_.device("smartphone")&&e.settings.get("showCheckboxes",!1),folderEditMode:!1})},"vgrid-checkboxes":function(e){_.device("smartphone")||e.getGrid().setEditable(e.props.get("checkboxes"))},"prop-folderview":function(e){e.props.set("folderview",!_.device("smartphone")&&e.settings.get("folderview/visible/"+_.display(),!0))},"store-view-options":function(e){_.device("smartphone")||e.props.on("change",_.debounce(function(){if(!e.props.get("find-result")){var t=e.props.toJSON();e.settings.set("showCheckboxes",t.checkboxes).save()}},500))},"change:folderview":function(e){_.device("smartphone")||(e.props.on("change:folderview",function(t,o){e.folderView.toggle(o)}),e.on("folderview:close",function(){e.props.set("folderview",!1)}),e.on("folderview:open",function(){e.props.set("folderview",!0)}))},"change:folder-mobile":function(){if(!_.device("!smartphone")){var e=_.throttle(function(){var e;e=0!==w.grid.meta.total?w.grid.meta.title+" ("+w.grid.meta.total+")":w.grid.meta.title,w.pages.getNavbar("listView").setTitle(e)},500);w.grid.on("meta:update",e)}},"change:checkboxes":function(e){e.props.on("change:checkboxes",function(t,o){e.getGrid().setEditable(o)})},"folderview-toolbar":function(e){_.device("smartphone")||a.mediateFolderView(e)},"no-permission":function(t){var o=_.debounce(function(e){if(e&&!e.error){if(!arguments[1]||!arguments[1].error)return;e=arguments[1]}e.error_params[0]&&String(t.folder.get())!==String(e.error_params[0])||require(["io.ox/core/yell"],function(o){o(e),t.folder.setDefault()})},300);l.on("error:FLD-0008",o),e.on("error:FLD-0008",o),e.on("error:TSK-0023",function(e,i){String(t.folder.get())===String(i.error_params[1])&&l.get(t.folder.get(),{cache:!1}).fail(function(e){"FLD-0003"===e.code&&o(e)})})},"drag-n-drop":function(e){_.device("touch")||e.getWindow().nodes.outer.on("selection:drop",function(e,t){v.invoke("io.ox/tasks/actions/move",t)})},"create:task":function(t){e.on("create",function(e,o){t.grid.selection.set(o)})},move:function(t){_.device("smartphone")&&e.on("move",function(){"detailView"===t.pages.getCurrentPage().name&&t.pages.goBack(),t.grid.selection.clear()})},"selection-doubleclick":function(e){_.device("smartphone")||e.grid.selection.on("selection:doubleclick",function(e,t){ox.launch("io.ox/tasks/detail/main",{cid:t})})},"selection-delete":function(e){e.grid.selection.on("selection:delete",function(e,o){var i=t.Baton({data:o});v.invoke("io.ox/tasks/actions/delete",i)})},"delete-mobile":function(t){_.device("!smartphone")||e.on("delete",function(){"detailView"===t.pages.getCurrentPage().name&&t.pages.goBack()})},"api-events":function(t){e.on("create update delete refresh.all",function(){l.reload(t.folder.get())})},"inplace-find":function(e){function t(t,o){o.on({"find:query":function(){e.grid.getToolbar().find(".grid-options:first").hide()},"find:cancel":function(){e.grid.getToolbar().find(".grid-options:first").show()}})}if(!_.device("smartphone")&&u.has("search")&&e.isFindSupported())return e.initFind(),e.get("find")?t(0,e.get("find")):e.once("change:find",t)},"contextual-help":function(e){e.getContextualHelp=function(){return"ox.appsuite.user.sect.tasks.gui.html"}},sidepanel:function(e){if(!_.device("smartphone")){t.point("io.ox/tasks/sidepanel").extend({id:"tree",index:100,draw:function(e){this.addClass("border-right").append(e.app.treeView.$el)}});var o=e.getWindow().nodes.sidepanel;t.point("io.ox/tasks/sidepanel").invoke("draw",o,t.Baton({app:e}))}},metrics:function(e){require(["io.ox/metrics/main"],function(t){function o(e,o){var i=!!(o=$(o)).attr("data-name"),n=(o.attr("data-action")||"").replace(/^io\.ox\/tasks\/(detail\/)?/,"");t.trackEvent({app:"tasks",target:e,type:"click",action:i?o.attr("data-name"):n,detail:i?o.attr("data-value"):""})}if(t.isEnabled()){var i=e.getWindow().nodes,n=i.sidepanel;i.body.on("track",".classic-toolbar-container",function(e,t){o("toolbar",t)}),i.main.find(".vgrid-toolbar").on("mousedown","a[data-name], a[data-action]",function(e){var o=$(e.currentTarget),i=o.attr("data-name")||o.attr("data-action");i&&t.trackEvent({app:"tasks",target:"list/toolbar",type:"click",action:i})}),_.defer(function(){n.find(".context-dropdown").on("mousedown","a",function(e){t.trackEvent({app:"tasks",target:"folder/context-menu",type:"click",action:$(e.currentTarget).attr("data-action")})})}),n.find(".bottom").on("mousedown","a[data-action]",function(e){$(e.currentTarget).attr("data-action")&&t.trackEvent({app:"tasks",target:"folder/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})}),e.on("folder:change folder-virtual:change",function(e){t.getFolderFlags(e).then(function(e){t.trackEvent({app:"tasks",target:"folder",type:"click",action:"select",detail:e.join("/")})})}),e.grid.selection.on({change:function(e,o){o.length&&t.trackEvent({app:"tasks",target:"list",type:"click",action:"select",detail:o.length>1?"multiple":"one"})}})}})}}),w.setLauncher(function(e){var n,r,s,c=!1;(n=ox.ui.createWindow({name:"io.ox/tasks",title:"Tasks",chromeless:!0,find:u.has("search")})).addClass("io-ox-tasks-main"),w.setWindow(n),w.settings=d;var p=function(){if(c){var e=r.getContainer();$(".swipeDelete",e).remove(),c=!1}};w.removeButton=p,t.point("io.ox/tasks/swipeDelete").extend({index:666,id:"deleteButton",draw:function(e){c&&p();var t=$('<div class="swipeDelete fadein fast"><i class="fa fa-trash-o trashicon" aria-hidden="true"/></div>');this.append(t.on("mousedown",function(e){e.stopImmediatePropagation()}).on("tap",function(t){t.preventDefault(),p(),c=!1,v.invoke("io.ox/tasks/actions/delete",e)})),c=!0}});w.gridContainer=$('<div class="border-right">'),r=new i(w.gridContainer,{settings:d,swipeLeftHandler:function(e,o,i){var n=_.cid(o);void 0===s?l.get(n.folder_id).done(function(e){l.can("delete",e)&&(s=!0,t.point("io.ox/tasks/swipeDelete").invoke("draw",i,n))}):s&&t.point("io.ox/tasks/swipeDelete").invoke("draw",i,n)},showToggle:_.device("smartphone"),hideTopbar:_.device("smartphone"),hideToolbar:_.device("smartphone"),toolbarPlacement:"top",templateOptions:{tagName:"li",defaultClassName:"vgrid-cell list-unstyled"}}),w.gridContainer.find(".vgrid-toolbar").attr("aria-label",o("Tasks toolbar")),w.grid=r,ox.ui.screens.current()||ox.ui.screens.one("show-windowmanager",r.paint.bind(r)),w.getGrid=function(){return r},window.tasks=w,a.addFolderSupport(w,r,"tasks",e.folder).always(function(){w.mediate(),n.show()})}),w.setResume(function(e){if(e&&e.folder&&e.folder!==this.folder.get()){var t=this.getWindow();return t.busy(),this.folder.set(e.folder).always(function(){t.idle()})}return $.when()}),t.point("io.ox/tasks/vgrid/toolbar").extend({id:"dropdown",index:1e12,draw:function(){var e=new b({model:w.grid.props,tagName:"div",caret:!1,label:function(){return[$('<i class="fa fa-arrow-down" aria-hidden="true">'),$('<i class="fa fa-arrow-up" aria-hidden="true">'),$('<span class="sr-only">').text(o("Sort options"))]}}).header(o("Sort options")).option("sort","urgency",o("Urgency")).option("sort","300",o("Status")).option("sort","317",o("Due date")).option("sort","200",o("Subject")).option("sort","309",o("Priority")).divider().header(o("Order")).option("order","asc",o("Ascending")).option("order","desc",o("Descending")).divider().option("done",!0,o("Show done tasks")).listenTo(w.grid.props,"change:sort change:order change:done",function(){w.grid.refresh()});this.append($('<div class="grid-options dropdown">').append(e.render().$el.attr("data-dropdown","sort")))}}),{getApp:w.getInstance}});