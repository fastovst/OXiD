define("io.ox/tasks/edit/view",["gettext!io.ox/tasks/edit","io.ox/tasks/edit/view-template","io.ox/tasks/model","io.ox/core/extensions","io.ox/backbone/views","io.ox/core/capabilities","settings!io.ox/core"],function(t,e,i,a,n,o,s){"use strict";var d=n.point("io.ox/tasks/edit/view").createView({tagName:"div",className:"io-ox-tasks-edit container",init:function(){this.collapsed=!0,this.detailsCollapsed=!0,this.model.on("change:recurrence_type",function(t,e){e&&(t.get("start_time")||0===t.get("start_time")||(void 0!==t.get("end_time")&&null!==t.get("end_time")?t.set("start_time",moment(t.get("end_time")).subtract(1,"day").valueOf(),{validate:!0}):t.set("start_time",_.now(),{validate:!0})),t.get("end_time")||0===t.get("end_time")||t.set("end_time",moment(t.get("start_time")).add(1,"day").valueOf(),{validate:!0}))}),this.model.on("invalid:quota_exceeded",function(t){this.saving||require(["io.ox/core/yell"],function(e){e("error",t[0])})})},autoOpen:function(t){t=t||this.model.attributes;var e=this.$el.find(".expand-link"),i=this.$el.find(".expand-details-link");if(0!==e.length&&this.collapsed){var a=_(_(t).pick(["actual_duration","target_duration","actual_costs","target_costs","currency","trip_meter","billing_information","companies"])).filter(function(t){return t}),n=_(_(t).pick(["start_time","end_time","alarm","recurrence_type","percent_completed","private_flag","number_of_attachments","priority"])).filter(function(t){return t});this.collapsed&&(a.length||n.length||1!==this.model.get("status")||t.participants&&t.participants.length)&&(e.click(),a.length&&this.detailsCollapsed&&i.click())}},render:function(e){function i(t){e.getWindow().nodes.outer.find('.btn[data-action="save"]').prop("disabled",""===t)}var n=this,d={};return n.baton.app=e,s.get("features/PIMAttachments",o.has("filestore"))||(a.point("io.ox/tasks/edit/view").disable("attachment_list"),a.point("io.ox/tasks/edit/view").disable("attachment_upload"),a.point("io.ox/tasks/edit/view").disable("attachments_legend")),o.has("delegate_tasks")||(a.point("io.ox/tasks/edit/view").disable("participants_list"),a.point("io.ox/tasks/edit/view").disable("add_participant"),a.point("io.ox/tasks/edit/view").disable("participants_legend")),_(this.point.list()).each(function(t){t.row?(d[t.row]||(d[t.row]=[]),d[t.row].push(t)):(d.rest||(d.rest=[]),d.rest.push(t))}),_(d).each(function(t,e){if("rest"!==e)for(var i=$('<div class="row">').appendTo(n.$el),a=0;a<t.length;a++)t[a].invoke("draw",i,n.baton)}),_(d.rest).each(function(t){t.invoke("draw",n.$el,n.baton)}),n.model.get("title")&&e.setTitle(n.model.get("title")),n.$el.find("input.title-field").val()||e.getWindow().nodes.outer.find('.btn[data-action="save"]').prop("disabled",!0),n.model.get("id")&&n.autoOpen(),n.$el.on("keyup blur",".title-field",function(){var a=$(this).val(),o=a;o||(o=t(n.model.get("id")?"Edit task":"Create task")),e.setTitle(o),i(a)}),this}});return{TaskEditView:d,getView:function(t,e,a){t=t?i.factory.wrap(t):i.factory.create();var n=new d({model:t});return e.append(n.render(a).$el),n}}});