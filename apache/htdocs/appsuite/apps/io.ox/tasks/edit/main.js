define("io.ox/tasks/edit/main",["gettext!io.ox/tasks","io.ox/core/extensions","io.ox/tasks/model","io.ox/tasks/edit/view","io.ox/tasks/api","less!io.ox/tasks/edit/style"],function(t,e,i,o,a){"use strict";return{getApp:function(){var e,s,n,r,d,l=ox.ui.createApp({name:"io.ox/tasks/edit",title:t("Create task"),userContent:!0,closable:!0,floating:!_.device("smartphone")});return l.edit=!1,l.STATES={CLEAN:1,DIRTY:2},l.getState=function(){return n},l.markDirty=function(){n=l.STATES.DIRTY},l.markClean=function(){n=l.STATES.CLEAN},l.isDirty=function(){var t=!0;if(n===l.STATES.CLEAN)return!1;if(this.edit)t=r.isDirty();else{var e=r.changedSinceLoading(),o=_.copy(i.defaults);o.folder_id=e.folder_id,t=!_.isEqual(e,o)}var a=d.baton.attachmentList;return a&&(a.attachmentsToAdd.length>0||a.attachmentsToDelete.length>0)&&(t=!0),t},l.setLauncher(function(n){require(["io.ox/core/notifications"],function(t){t.dropdown.close()});var c=_.isArray(n.taskData)&&1===n.taskData.length?n.taskData[0]:n.taskData,u=function(){l.view=d=o.getView(r,e.nodes.main,l),e.show()};(s=this).markDirty(),(e=ox.ui.createWindow({name:"io.ox/tasks/edit",chromeless:!0,floating:!_.device("smartphone"),closable:!0,title:t(c&&c.id?"Edit task":"Create task")})).addClass("io-ox-tasks-edit-main"),l.setWindow(e),e.nodes.main.addClass("scrollable"),e.on("show",function(){d&&_.device("!smartphone && !iOS")&&d.$el.find(".title-field").focus(),r.get("id")?s.setState({folder:r.attributes.folder_id,id:r.attributes.id}):s.setState({folder:r.attributes.folder_id,id:null})}),c&&c.id?(this.edit=!0,l.cid="io.ox/tasks:edit."+_.cid(c),a.get({id:c.id,folder_id:c.folder_id||c.folder},!1).done(function(t){if(c.last_modified!==t.last_modified){var e=_.cid(c);a.removeFromCache(e).then(function(){a.caches.all.clear(),l.model=r=i.factory.create(t),r.getParticipants(),u()})}else l.model=r=i.factory.create(t),r.getParticipants(),u()})):(l.attributes.title=t("Create task"),l.model=r=i.factory.create(),n.folderid&&(n.folderid=parseInt(n.folderid,10),r.set("folder_id",n.folderid,{validate:!0})),u())}),l.setQuit(function(){var o=$.Deferred(),a=function(){d.trigger("dispose"),r.off(),l=e=r=d=null};return l.isDirty()?require(["io.ox/backbone/views/modal"],function(e){l.getWindow().floating?l.getWindow().floating.toggle(!0):_.device("smartphone")&&l.getWindow().resume(),new e({title:t("Do you really want to discard your changes?")}).addCancelButton().addButton({label:t.pgettext("dialog","Discard changes"),action:"delete"}).on("delete",function(){a(),i.factory.realm("edit").release(),o.resolve()}).on("cancel",function(){o.reject()}).open()}):(l.edit,a(),o.resolve()),o}),l.failSave=function(){if(this.model){var e=this.attributes.title;return{description:t("Task")+(e?": "+e:""),module:"io.ox/tasks/edit",point:this.model.attributes}}return!1},l.failRestore=function(t){this.markDirty(),this.view.autoOpen(t);var e=t.participants||[];return delete t.participants,this.model.set(t),this.model.set("participants",e,{silent:!0}),this.model.getParticipants().addUniquely(e),_.isUndefined(t.id)||(this.edit=!0,this.view.trigger("changeMode","edit"),this.cid="io.ox/tasks:edit."+_.cid(t)),this.view.$el.find(".title-field").trigger("blur"),$.when()},l.getContextualHelp=function(){return"ox.appsuite.user.sect.tasks.gui.create.html"},l},reuse:function(t,e){if("edit"===t)return ox.ui.App.reuse("io.ox/tasks:edit."+_.cid(e))}}});