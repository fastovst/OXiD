define("io.ox/tasks/edit/view-template",["gettext!io.ox/tasks/edit","io.ox/backbone/views","io.ox/core/tk/upload","io.ox/core/yell","io.ox/backbone/mini-views","io.ox/backbone/mini-views/datepicker","io.ox/tasks/edit/util","io.ox/backbone/views/recurrence-view","io.ox/participants/add","io.ox/participants/views","io.ox/core/tk/attachments","io.ox/tasks/api","io.ox/core/extensions","io.ox/tasks/util","io.ox/core/folder/api","settings!io.ox/tasks"],function(e,t,a,l,n,i,o,d,r,s,c,p,m,u,f,x){"use strict";var b=t.point("io.ox/tasks/edit/view");b.basicExtend({index:100,id:"dnd",draw:function(e){this.append(new a.dnd.FloatingDropzone({app:e.app,point:"io.ox/tasks/edit/dnd/actions"}).render().$el)}}),b.basicExtend({id:"headline",index:100,row:"0",draw:function(t){var a,n,i,d=e("Create"),r=e("Create task"),s=t.app;t.model.attributes.id&&(d=e("Save"),r=e("Edit task")),i=$('<div class="header">').append(a=$('<h1 class="sr-only">').text(r),n=$('<button type="button" data-action="save" class="btn btn-primary task-edit-save">').text(d).on("click",function(){s.getWindow().busy(),o.sanitizeBeforeSave(t),t.model.saving=!0,t.model.save().done(function(){delete t.model.saving,s.markClean(),s.quit()}).fail(function(e){setTimeout(function(){delete t.model.saving,s.getWindow().idle(),l(e)},300)})}),$('<button type="button" data-action="discard" class="btn btn-default cancel task-edit-cancel">').text(e("Discard")).on("click",function(e){e.stopPropagation(),s.quit()})),s.getWindow().setHeader(i),t.parentView.on("changeMode",function(t,l){"edit"===l?(a.text(e("Edit task")),n.text(e("Save"))):(a.text(e("Create task")),n.text(e("Create")))})}}),b.extend({id:"title",index:200,className:"col-sm-12",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Subject")).attr({for:t}),new n.InputView({name:"title",model:this.model,mandatory:!0}).render().$el.attr({id:t}).addClass("title-field"))}},{row:"1"}),b.extend({id:"note",index:300,className:"col-sm-12",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Description")).attr({for:t}),new n.TextView({name:"note",model:this.model}).render().$el.attr({id:t}).addClass("note-field"))}},{row:"2"}),b.basicExtend({id:"expand_link",index:400,row:"3",draw:function(t){var a=e("Collapse form");t.parentView.collapsed&&(a=e("Expand form")),this.append($('<div class="col-lg-12">').append($('<button type="button" class="btn btn-link expand-link">').attr("aria-expanded",!t.parentView.collapsed).text(a).on("click",function(){t.parentView.collapsed=!t.parentView.collapsed,t.parentView.$el.toggleClass("expanded",!t.parentView.collapsed),$(this).attr("aria-expanded",!t.parentView.collapsed).text(e(t.parentView.collapsed?"Expand form":"Collapse form"))})))}}),b.basicExtend({id:"start_date",index:500,row:"4",draw:function(t){this.append(new i({model:t.model,className:"col-sm-6 col-xs-12 collapsible",attribute:"start_time",label:e("Start date"),clearButton:!0,display:t.model.get("full_time")?"DATE":"DATETIME"}).listenTo(t.model,"change:full_time",function(e,a){this.toggleTimeInput(!a),_.device("smartphone")&&t.model.trigger("change:start_time change:end_time")}).on("click:time",function(){var e=this.$el.find(".dropdown-menu.calendaredit"),t=e.scrollParent(),a=e.offset().top-t.offset().top;(a<0||a+e.height()>t.height())&&t.scrollTop(t.scrollTop()+a-16)}).render().$el.attr("data-extension-id","start_time"))}}),b.basicExtend({id:"end_date",index:600,row:"4",draw:function(t){this.append(new i({model:t.model,className:"col-sm-6 col-xs-12 collapsible",attribute:"end_time",label:e("Due date"),clearButton:!0,display:t.model.get("full_time")?"DATE":"DATETIME"}).listenTo(t.model,"change:full_time",function(e,a){this.toggleTimeInput(!a),_.device("smartphone")&&t.model.trigger("change:start_time change:end_time")}).on("click:time",function(){var e=this.$el.find(".dropdown-menu.calendaredit"),t=e.scrollParent(),a=e.offset().top-t.offset().top;(a<0||a+e.height()>t.height())&&t.scrollTop(t.scrollTop()+a-16)}).render().$el.attr("data-extension-id","end_time"))}}),b.extend({id:"full_time",index:700,className:"col-md-6 collapsible",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append(new n.CustomCheckboxView({id:t,name:"full_time",label:e("All day"),model:this.model}).render().$el)}},{row:"5"}),b.extend({id:"recurrence",className:"col-xs-12 collapsible",tabindex:0,index:800,render:function(){this.$el.append(new d({model:this.model}).render().$el),this.$el.find(".recurrence-view checkbox").attr("tabindex",0)}},{row:6}),b.basicExtend({id:"alarm_select",index:900,row:"7",draw:function(t){var a;this.append($('<div class="col-sm-6 collapsible">').append($('<label for="task-edit-reminder-select">').text(e("Reminder")),a=$('<select id="task-edit-reminder-select" class="form-control">').append($("<option>").text(e("Manual input")),u.buildDropdownMenu(),$("<option>").text(e("No reminder"))).on("change",function(){0!==a.prop("selectedIndex")&&(a.prop("selectedIndex")===a.prop("length")-1?t.model.set("alarm",null,{validate:!0,setBy:"selectbox"}):t.model.set("alarm",u.computePopupTime(a.val()).alarmDate,{validate:!0,setBy:"selectbox"}))}))),t.model.on("change:alarm",function(e,t,l){"selectbox"!==l.setBy&&(_.isNull(t)?a.prop("selectedIndex",a.prop("length")-1):a.prop("selectedIndex",0))}),t.model.get("alarm")||a.prop("selectedIndex",a.prop("length")-1)}}),b.basicExtend({id:"alarm",index:1e3,row:"7",draw:function(t){this.append(new i({model:t.model,display:"DATETIME",ignoreToggle:!0,className:"col-xs-12 col-sm-6 collapsible",attribute:"alarm",label:e("Reminder date"),clearButton:!0}).on("click:time",function(){var e=this.$el.find(".dropdown-menu.calendaredit"),t=e.scrollParent(),a=e.offset().top-t.offset().top;(a<0||a+e.height()>t.height())&&t.scrollTop(t.scrollTop()+a-16)}).render().$el.attr("data-extension-id","alarm"))}}),b.extend({id:"status",index:1100,className:"col-sm-3 collapsible",render:function(){var t,a=_.uniqueId("form-control-label-"),l=this,i=[{label:e("Not started"),value:1},{label:e("In progress"),value:2},{label:e("Done"),value:3},{label:e("Waiting"),value:4},{label:e("Deferred"),value:5}];this.$el.append($('<label class="control-label">').attr("for",a).text(e("Status")),$("<div>").append(t=new n.SelectView({list:i,name:"status",model:this.baton.model,id:a,className:"form-control"}).render().$el)),t.on("change",function(){0===$(this).prop("selectedIndex")?l.model.set("percent_completed",0,{validate:!0}):2===$(this).prop("selectedIndex")?l.model.set("percent_completed",100,{validate:!0}):1!==$(this).prop("selectedIndex")||0!==l.model.get("percent_completed")&&100!==l.model.get("percent_completed")||l.model.set("percent_completed",25,{validate:!0})})}},{row:"8"}),b.basicExtend({id:"progress",index:1200,row:"8",draw:function(t){var a=o.buildProgress(t.model.get("percent_completed"));this.append($('<div class="col-sm-3 collapsible">').append($('<label for="task-edit-progress-field">').text(e("Progress in %")),$(a.wrapper).val(t.model.get("percent_completed")).on("change",function(){var n=$.trim(a.progress.val()).replace(/\s*%$/,""),i=/^\d+$/.test(n),o=parseInt(n,10);i&&o>=0&&o<=100?(0===o&&2===t.model.get("status")?t.model.set("status",1,{validate:!0}):100===o&&3!==t.model.get("status")?t.model.set("status",3,{validate:!0}):3===t.model.get("status")?t.model.set("status",2,{validate:!0}):1===t.model.get("status")&&t.model.set("status",2,{validate:!0}),t.model.set("percent_completed",o,{validate:!0})):(l("error",e("Please enter value between 0 and 100.")),t.model.trigger("change:percent_completed"))}))),t.model.on("change:percent_completed",function(){a.progress.val(t.model.get("percent_completed"))})}}),b.extend({id:"priority",index:1300,className:"col-sm-3 collapsible",render:function(){var t,a=_.uniqueId("form-control-label-"),l=[{label:e.pgettext("Tasks priority","None"),value:"null"},{label:e.pgettext("Tasks priority","Low"),value:1},{label:e.pgettext("Tasks priority","Medium"),value:2},{label:e.pgettext("Tasks priority","High"),value:3}];this.$el.append($("<label>").attr({class:"control-label",for:a}).text(e.pgettext("Tasks","Priority")),$("<div>").append(t=new n.SelectView({list:l,name:"priority",model:this.baton.model,id:a,className:"form-control"}).render().$el)),this.baton.model.get("priority")||t.find("option").first().attr("selected","selected")}},{row:"8"}),b.extend({id:"private_flag",index:1400,className:"col-sm-3 collapsible",render:function(){var t=this.model.get("folder_id");if(f.pool.getModel(t).is("private")){var a=_.uniqueId("form-control-label-");this.$el.append($("<fieldset>").append($('<legend class="simple">').text(e("Type")),new n.CustomCheckboxView({id:a,name:"private_flag",label:e("Private"),model:this.model}).render().$el))}}},{row:"8"}),b.basicExtend({id:"participants_list",index:1600,row:"10",draw:function(t){this.append(new s.UserContainer({collection:t.model.getParticipants(),baton:t,empty:e("This task has no participants yet")}).render().$el.addClass("collapsible"))}}),b.basicExtend({id:"add_participant",index:1700,className:"row",row:"11",draw:function(t){var a=new r({apiOptions:{contacts:!0,users:!0,groups:!0,resources:!1,distributionlists:!0},placeholder:e("Add contact")+" â€¦",label:e("Add contact"),collection:t.model.getParticipants()});this.append(a.$el),a.render().$el.addClass("col-md-6 collapsible"),a.$el.find("input.add-participant").addClass("task-participant-input-field"),a.typeahead.on("typeahead-custom:dropdown-rendered",function(){var e=a.$el.find(".tt-dropdown-menu"),t=e.scrollParent(),l=e.offset().top-t.offset().top;e.is(":visible")&&(l<0||l+e.height()>t.height())&&t.scrollTop(t.scrollTop()+l-16)})}}),b.extend({id:"attachments_legend",index:1800,className:"col-md-12 collapsible",render:function(){this.$el.append($("<fieldset>").append($("<legend>").text(e("Attachments"))))}},{row:"12"}),b.extend(new c.EditableAttachmentList({id:"attachment_list",registerAs:"attachmentList",index:1900,module:4,className:"collapsible",finishedCallback:function(e,t,a){var n={};n.id=e.attributes.id||t,n.folder_id=e.attributes.folder_id||e.attributes.folder,_(a).each(function(e){l("error",e.error)}),p.uploadInProgress(_.ecid(n))&&p.get(n,!1).done(function(e){$.when(p.caches.get.add(e),p.caches.list.merge(e).done(function(e){e&&p.trigger("refresh.list")})).done(function(){p.removeFromUploadList(_.ecid(n))})})}}),{row:"13"}),b.basicExtend({id:"attachment_upload",index:2e3,row:"14",draw:function(e){var t=_.uniqueId("form-control-label-"),a=$('<form class="attachments-form">').appendTo(this).attr("id",t).addClass("col-sm-12 collapsible"),l=c.fileUploadWidget(),n=l.find('input[type="file"]'),i=function(t){if(t.preventDefault(),9!==_.browser.IE)_(n[0].files).each(function(t){e.attachmentList.addFile(t)}),n[0].value="",n.trigger("reset.fileupload");else if(n.val()){var a={name:n.val().match(/[^/\\]+$/),size:0,hiddenField:n};e.attachmentList.addFile(a),n.addClass("add-attachment").hide(),n=$('<input type="file" name="file">').on("change",i).appendTo(n.parent())}e.model.validate()};n.on("change",i),l.on("change.fileupload",function(){$(this).find('div[data-provides="fileupload"]').addClass("fileupload-new").removeClass("fileupload-exists")}),a.append($("<div>").append(l))}}),b.basicExtend({id:"expand_detail_link",index:2100,row:"15",draw:function(t){var a=e("Hide details");t.parentView.detailsCollapsed&&(a=e("Show details")),this.append($('<div class="col-lg-12 collapsible">').append($('<button type="button" class="btn btn-link expand-details-link">').attr("aria-expanded",!t.parentView.detailsCollapsed).text(a).on("click",function(){t.parentView.detailsCollapsed=!t.parentView.detailsCollapsed,t.parentView.$el.toggleClass("details-expanded",!t.parentView.detailsCollapsed),$(this).attr("aria-expanded",!t.parentView.detailsCollapsed).text(e(t.parentView.detailsCollapsed?"Show details":"Hide details"))})))}}),b.extend({id:"target_duration",index:2200,className:"col-sm-6 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Estimated duration in minutes")).attr({for:t}),new n.InputView({name:"target_duration",model:this.model}).render().$el.attr({id:t}),new n.ErrorView({name:"target_duration",model:this.model}).render().$el)}},{row:"16"}),b.extend({id:"actual_duration",index:2300,className:"col-sm-6 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Actual duration in minutes")).attr({for:t}),new n.InputView({name:"actual_duration",model:this.model}).render().$el.attr({id:t}),new n.ErrorView({name:"actual_duration",model:this.model}).render().$el)}},{row:"16"}),b.extend({id:"target_costs",index:2400,className:"col-sm-6 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Estimated costs")).attr({for:t}),new n.InputView({name:"target_costs",model:this.model}).render().$el.attr({id:t}),new n.ErrorView({name:"target_costs",model:this.model}).render().$el)}},{row:"17"}),b.extend({id:"actual_costs",index:2500,className:"col-sm-4 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Actual costs")).attr({for:t}),new n.InputView({name:"actual_costs",model:this.model}).render().$el.attr({id:t}),new n.ErrorView({name:"actual_costs",model:this.model}).render().$el)}},{row:"17"}),b.extend({id:"currency",index:2600,className:"col-sm-2 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-"),a=x.get("currencies",["CAD","CHF","DKK","EUR","GBP","JPY","PLN","RMB","RUB","SEK","USD"]);a.unshift(""),this.$el.append($("<label>").attr({class:"control-label",for:t}).text(e("Currency")),$("<div>").append(new n.SelectView({list:_.map(a,function(e){return{label:e,value:e}}),name:"currency",model:this.baton.model,id:t,className:"form-control"}).render().$el))}},{row:"17"}),b.extend({id:"trip_meter",index:2700,className:"col-sm-12 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Distance")).attr({for:t}),new n.InputView({name:"trip_meter",model:this.model}).render().$el.attr({id:t}))}},{row:"18"}),b.extend({id:"billing_information",index:2800,className:"col-sm-12 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Billing information")).attr({for:t}),new n.InputView({name:"billing_information",model:this.model}).render().$el.attr({id:t}))}},{row:"19"}),b.extend({id:"companies",index:2900,className:"col-sm-12 task-edit-details",render:function(){var t=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(e("Companies")).attr({for:t}),new n.InputView({name:"companies",model:this.model}).render().$el.attr({id:t}))}},{row:"20"}),b.extend({id:"metrics",index:3e3,render:function(){var e=this;require(["io.ox/metrics/main"],function(t){t.isEnabled()&&(e.baton.app.getWindow().nodes.footer.on("mousedown","[data-action]",function(e){var a=$(e.target);t.trackEvent({app:"tasks",target:"edit/toolbar",type:"click",action:a.attr("data-action")||a.attr("data-name"),detail:a.attr("data-value")})}),e.baton.app.getWindow().nodes.main.find(".file-input").on("change",function(){require(["io.ox/metrics/main"],function(e){e.trackEvent({app:"tasks",target:"edit",type:"click",action:"add-attachment"})})}))})}}),m.point("io.ox/tasks/edit/dnd/actions").extend({id:"attachment",index:100,label:e('Drop here to upload a <b class="dndignore">new attachment</b>'),multiple:function(e,t){_(e).each(function(e){t.view.baton.attachmentList.baton.attachmentList.addFile(e)}),t.view.$(".expand-link").trigger("click")}})});