define("io.ox/tasks/view-detail",["io.ox/tasks/util","io.ox/calendar/util","gettext!io.ox/tasks","io.ox/core/extensions","io.ox/tasks/api","io.ox/participants/detail","io.ox/core/tk/attachments","io.ox/backbone/views/toolbar","io.ox/backbone/views/action-dropdown","io.ox/core/locale","io.ox/tasks/actions","less!io.ox/tasks/style"],function(t,e,a,i,n,s,o,d,r,l){"use strict";var c={draw:function(e){var a=(e=i.Baton.ensure(e)).data;if(!a)return $("<div>");var s=t.interpretTask(a),o=this,d=$.createViewContainer(a,n).on("redraw",function(t,a){e.data=a,d.replaceWith(o.draw(e))}).addClass("tasks-detailview");return e.interpretedData=s,i.point("io.ox/tasks/detail-inline").invoke("draw",d,e),i.point("io.ox/tasks/detail-view").invoke("draw",d,e),d}};i.point("io.ox/tasks/detail-inline").extend({index:10,id:"inline-links",draw:function(t){new d({el:this,point:"io.ox/tasks/links/inline",inline:!0}).setSelection(t.array(),{data:t.array()})}}),i.point("io.ox/tasks/detail-view").extend({index:100,id:"header",draw:function(e){var n=$('<div class="info-panel">'),s=e.interpretedData,o=$('<h1 class="title clear-title">').append(e.data.private_flag?$('<i class="fa fa-lock private-flag" aria-hidden="true">').attr({title:a("Private"),"data-placement":"bottom","data-animation":"false"}).tooltip():[],$('<span class="priority">').append(t.getPriority(s)),$.txt(s.title));this.append($('<div class="task-header">').append(_.device("smartphone")?[o,n]:[n,o])),i.point("io.ox/tasks/detail-view/infopanel").invoke("draw",n,s)}}),i.point("io.ox/tasks/detail-view").extend({index:200,id:"attachments",draw:function(t){var e=t.interpretedData;if(n.uploadInProgress(_.ecid(t.data))){var a=new o.progressView({cid:_.ecid(e)});this.append($('<div class="attachments-container">').append(a.render().$el))}else e.number_of_attachments>0&&i.point("io.ox/tasks/detail-attach").invoke("draw",this,e)}}),i.point("io.ox/tasks/detail-view").extend({index:300,id:"note",draw:function(a){var i=e.getNote(a.interpretedData,"note");(i=t.checkMailLinks(i))&&this.append($('<div class="note">').html(i))}}),i.point("io.ox/tasks/detail-view").extend({index:400,id:"details",draw:function(t){var i=t.interpretedData,n={start_time:a("Start date"),target_duration:a("Estimated duration in minutes"),actual_duration:a("Actual duration in minutes"),target_costs:a("Estimated costs"),actual_costs:a("Actual costs"),trip_meter:a("Distance"),billing_information:a("Billing information"),companies:a("Companies"),date_completed:a("Date completed")},s=$('<dl class="task-details dl-horizontal">');i.recurrence_type&&s.append($('<dt class="detail-label">').text(a("This task recurs")),$('<dd class="detail-value">').text(e.getRecurrenceString(t.data))),_(n).each(function(t,e){var a=i[e];(a||0===a)&&("target_costs"!==e&&"actual_costs"!==e||(a=i.currency?l.currency(a,i.currency):l.number(a,2)),s.append($('<dt class="detail-label">').text(t),$('<dd class="detail-value">').text(a)))}),s.children().length&&this.append($('<fieldset class="details">').append(s))}}),i.point("io.ox/tasks/detail-view").extend({index:500,id:"participants",draw:function(t){var e=new s(t);this.append(e.draw())}}),i.point("io.ox/tasks/detail-view/infopanel").extend({index:100,id:"infopanel",draw:function(t){t.end_time&&this.append($("<div>").addClass("end-date").text(a("Due %1$s",t.end_time))),t.alarm&&this.append($("<div>").addClass("alarm-date").text(a("Reminder date %1$s",t.alarm))),t.percent_completed&&0!==t.percent_completed&&this.append($("<div>").addClass("task-progress").text(a("Progress %1$s %",t.percent_completed))),this.append($("<div>").text(t.status).addClass("state "+t.badge))}}),i.point("io.ox/tasks/detail-attach").extend({index:100,id:"attachments",draw:function(t){var e;e=this.hasClass("attachments-container")?this:$('<div class="attachments-container">').appendTo(this),$('<span class="attachments">').text(a("Attachments")).appendTo(e),require(["io.ox/core/api/attachment"],function(i){i.getAll({folder_id:t.folder_id,id:t.id,module:4}).done(function(t){_(t).each(function(t){x(e,t.filename,t)}),t.length>1&&x(e,a("All attachments"),t),e.on("click","a",function(t){t.preventDefault()})}).fail(function(){p(e,t)})})}});var p=function(t,e){t.empty().append($.fail(a("Could not load attachments for this task."),function(){i.point("io.ox/tasks/detail-attach").invoke("draw",t,e)}))},x=function(t,e,a){var i=new r({point:"io.ox/core/tk/attachment/links",data:a,title:e});t.append(i.$el),_.device("smartphone")&&i.$el.css("display","block")};return c});