define("io.ox/portal/widgets",["io.ox/core/extensions","io.ox/core/manifests","io.ox/core/upsell","io.ox/core/notifications","settings!io.ox/portal","gettext!io.ox/portal"],function(e,t,n,i,r,o){"use strict";var l=[],u=_(t.manager.pluginsFor("portal")).uniq().concat(l),s=new Backbone.Collection([]),a=r.get("widgetSet",""),g=Number(r.get("generation",0));s.comparator=function(t,n){return e.indexSorter({index:t.get("index")},{index:n.get("index")})};var d=function(){var e={},t=r.get("settings"+a,{}),n=r.get("widgets/user");_(n||{}).each(function(t,n){e[n]=_.extend({},t,{userWidget:!0})});for(var i=0;i<=g;i++)_(r.get("widgets/eager"+a+"/gen_"+i)).each(function(n){var i={};return _(r.get("widgets/deleted"+a+"/gen_"+n,[])).each(function(e){i[e]=!0}),function(n,r){i[r]||(e[r]=_.extend({},e[r],n,t[r],{eagerWidget:!0}))}}(i));return _(r.get("widgets/protected"+a)).each(function(n,i){n.protectedWidget=!0,e[i]=_.extend({},e[i],n,{protectedWidget:!0}),e[i].userWidget=!1,n.userWidget=!1;var r=!1;if(n.changeable){var o=t[i]||{};_(n.changeable).each(function(t,n){t&&(e[i][n]=o[n]||e[i][n],"index"===n&&(r=!0))})}n.draggable=r,e[i].draggable=r}),_.isEmpty(e)&&!n&&(e={mail_0:{plugin:"plugins/portal/mail/register",color:"default",userWidget:!0,index:1,props:{name:o("Inbox")}},birthdays_0:{plugin:"plugins/portal/birthdays/register",color:"default",userWidget:!0,index:4},calendar_0:{plugin:"plugins/portal/calendar/register",color:"default",userWidget:!0,index:2},tasks_0:{plugin:"plugins/portal/tasks/register",color:"default",userWidget:!0,index:3},myfiles_0:{plugin:"plugins/portal/recentfiles/register",color:"default",userWidget:!0,index:4},twitter_0:{plugin:"plugins/portal/twitter/register",color:"default",userWidget:!0,index:5},linkedin_0:{plugin:"plugins/portal/linkedin/register",color:"default",userWidget:!0,index:6}},r.set("widgets/user",e).save()),e}(),c={addPlugin:function(e){u=u.concat(e)},getAvailablePlugins:function(){return _(u).uniq()},getCollection:function(){return s},getEnabled:function(){return s.filter(function(e){return!(e.has("candidate")||e.has("enabled")&&!0!==e.get("enabled"))})},getSettings:function(){var t=e.point("io.ox/portal/widget").pluck("id");return _(d).chain().map(function(e,t){return e.id=t,e.type=t.substr(0,t.lastIndexOf("_")),e.props=e.props||{},e.inverse=!_.isUndefined(e.inverse)&&e.inverse,e.enabled=!!_.isUndefined(e.enabled)||e.enabled,e}).filter(function(e){return _(c.getAvailablePlugins()).contains(e.plugin)||_(t).contains(e.type)}).value()},getSettingsSorted:function(){return _(c.getSettings()).chain().sortBy(function(e){return e.index}).map(function(e){return delete e.candidate,e}).value()},loadAllPlugins:function(){return require(c.getAvailablePlugins())},loadUsedPlugins:function(){var e=_.intersection(s.pluck("plugin"),c.getAvailablePlugins());return require(e).then(function(){return c.removeDisabled()}).fail(function(){console.error("Could not load portal plugin in loadUsedPlugins.")})},getOptions:function(t){return e.point("io.ox/portal/widget/"+t+"/settings").options()},getAllTypes:function(){var t=e.point("io.ox/portal/widget").pluck("id");return _.chain(c.getAvailablePlugins().concat(t)).map(function(e){return e.replace(/^plugins\/portal\/(\w+)\/register$/,"$1")}).uniq().map(function(e){var t=c.getOptions(e);return t.requires=c.requires(e),t}).filter(function(e){return void 0!==e.type}).value().sort(function(e,t){return e.title<t.title?-1:1})},getUsedTypes:function(){return _(s.pluck("type")).uniq().sort()},containsType:function(e){return _(this.getUsedTypes()).contains(e)},getColors:function(){return"default black red orange lightgreen green lightblue blue purple pink gray".split(" ")},getTitle:function(e,t){return _.isFunction(t)?t(e):e.title||(e.props?e.props.description||e.props.title:"")||t||""},getPluginByType:function(t){var n=e.point("io.ox/portal/widget/"+t).prop("plugin");return n||"plugins/portal/"+(e.point("io.ox/portal/widget/"+t).prop("type")||t)+"/register"},add:function(e,t){var n,i=r.get("widgets/defaults",{}),o=0,l=e+"_0";for(t=_.extend({color:"default",enabled:!0,inverse:!1,plugin:e,props:{}},i[e]||{},t||{});l in d;)l=e+"_"+ ++o;n={color:t.color,enabled:t.enabled,inverse:t.inverse,id:l,index:0,plugin:this.getPluginByType(t.plugin),props:t.props,type:e,userWidget:!0},r.set("widgets/user/"+l,n).saveAndYell(),d[l]=n,s.unshift(n)},remove:function(e){s.remove(e)},removeDisabled:function(){return s.remove(s.filter(function(t){return!1===e.point("io.ox/portal/widget/"+t.get("type")).invoke("isEnabled").reduce(function(e,t){return e&&t},!0).value()})),c.getEnabled()},toJSON:function(){var e={};return s.each(function(t){if(t.get("userWidget")){var n=t.get("id");e[n]=t.toJSON(),delete e[n].baton}}),e},extraSettingsToJSON:function(){var e={};return s.each(function(t){if(!t.get("userWidget")){var n=t.get("id");e[n]={color:t.get("color"),index:t.get("index"),enabled:!!t.get("protectedWidget")||t.get("enabled")}}}),e},update:function(e){s.each(function(t){var n=t.get("id");n in e&&t.set(e[n],{silent:!0,validate:!0})})},save:function(e){function t(e){return e}var n=this,l=_.extend({},d),u=l,g=0;return e.children().each(function(){var e=$(this).attr("data-widget-id");e in l&&(l[e].draggable||_.isUndefined(l[e].draggable)||_.isNull(l[e].draggable))&&(g++,l[e].index=t(g))}),n.update(l),s.sort(),r.set("widgets/user",n.toJSON()).set("settings"+a,n.extraSettingsToJSON()).save().fail(function(){n.update(u),s.trigger("sort"),e.sortable("cancel"),i.yell("error",o("Could not save settings."))})},requires:function(e){var n=this.getPluginByType(e);return t.manager.getRequirements(n)},visible:function(e){var t=this.requires(e);return n.has(t)},getModel:function(e){return s.get(e)},edit:function(e){var t,n=this.getModel(e);return!(!n||(t=this.getOptions(n.get("type")),!_.isFunction(t.edit)))&&(t.edit(n),!0)}};return s.reset(c.getSettingsSorted()),s.on("change",_.debounce(function(e){d[e.get("id")]=e.attributes,r.set("widgets/user",c.toJSON()).set("settings"+a,c.extraSettingsToJSON()).saveAndYell()},100)).on("remove",function(e){if(!e.get("protectedWidget"))if(e.get("eagerWidget")){var t=r.get("widgets/deleted"+a+"/gen_"+g,[]);t.push(e.get("id")),r.get("widgets/deleted")||r.set("widgets/deleted",{}),r.get("widgets/deleted"+a)||r.set("widgets/deleted"+a,{}),r.set("widgets/deleted"+a+"/gen_"+g,t).saveAndYell()}else e.get("userWidget")&&r.remove("widgets/user/"+e.get("id")).saveAndYell()}),require(["io.ox/core/upsell","settings!io.ox/core"],function(e,t){var n=_.extend({enabled:!0,requires:"active_sync || caldav || carddav"},t.get("features/upsell/portal-widget")),i=c.containsType("upsell");i!==(n.enabled&&!e.has(n.requires)&&e.enabled(n.requires))&&(i?c.remove("upsell_0"):(c.addPlugin("plugins/portal/upsell/register"),c.add("upsell")))}),c});