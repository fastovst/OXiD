define("io.ox/participants/chronos-views",["io.ox/contacts/api","io.ox/core/util","io.ox/contacts/util","io.ox/calendar/util","io.ox/core/folder/api","gettext!io.ox/core","io.ox/core/capabilities","less!io.ox/participants/style"],function(t,e,i,s,o,n,a){"use strict";var l={INDIVIDUAL:"",GROUP:n("Group"),RESOURCE:n("Resource")},r=Backbone.View.extend({tagName:"div",className:"participant-wrapper",events:{"click .remove":"onRemove",keydown:"fnKey"},options:{halo:!1,closeButton:!1,field:!1,customize:$.noop},nodes:{},initialize:function(t){this.options=$.extend({},this.options,t||{}),this.listenTo(this.model,"change",function(t){t&&t.changed&&(this.$el.empty(),this.render())}),this.listenTo(this.model,"remove",function(){this.remove()})},getDisplayName:function(t,e){return e=e||{},(t.get("contact")?i.getFullName(t.get("contact"),e.asHtml):_.escape(t.get("cn")))||_.escape(t.get("cn"))},render:function(){return this.$el.append(this.nodes.$img=$("<div>"),this.nodes.$text=$('<div class="participant-name">'),this.options.hideMail?"":$('<div class="participant-email">').append(this.nodes.$mail=this.options.halo?$("<a>"):$("<span>")),this.options.hideMail?"":$('<div class="extra-decorator">').append(this.nodes.$extra=$("<span>")),$('<a href="#" class="remove" role="button">').append($('<div class="icon">').append($('<i class="fa fa-trash-o" aria-hidden="true">').attr("title",n("Remove contact")+" "+this.getDisplayName(this.model)),$('<span class="sr-only">').text(n("Remove contact")+" "+this.getDisplayName(this.model))))).attr({"data-cid":this.model.cid}).toggleClass("removable",this.options.closeButton),this.setCustomImage(),this.setDisplayName(),this.setTypeStyle(),this.options.customize.call(this),this.trigger("render"),this},setDisplayName:function(){var t={$el:this.nodes.$text};this.options.asHtml?t.html=this.getDisplayName(this.model,{asHtml:!0}):t.name=this.getDisplayName(this.model),e.renderPersonalName(t,this.model.toJSON())},setCustomImage:function(){var e=this.model.toJSON(),i=this.model.get("cuType")||"INDIVIDUAL";t.pictureHalo(this.nodes.$img,e,{width:54,height:54}),this.nodes.$img.attr("aria-hidden",!0).addClass("participant-image "+i.toLowerCase()+"-image")},setRows:function(t,e){this.options.hideMail||(e=e||"INDIVIDUAL"!==this.model.get("cuType")&&this.model.get("cuType")||this.model.get("entity")||!a.has("gab")?e||l[this.model.get("cuType")]||"":n("External contact"),this.nodes.$mail.text(t),this.nodes.$extra.text(e),t&&e&&this.$el.addClass("three-rows"))},isOrganizer:function(){if(!this.options.baton)return!1;var t=this.options.baton.model.toJSON();return!(!t.organizer||!t.organizer.entity)&&this.model.get("entity")===t.organizer.entity},isRemovable:function(){if(!this.options.baton)return!1;var t=this.options.baton.model.toJSON();return t.organizer&&this.model.get("entity")===t.organizer.entity?o.pool.getModel(t.folder).is("public"):!(t.id&&this.model.get("entity")===ox.user_id&&!s.hasFlag(t,"organizer_on_behalf"))},setTypeStyle:function(){var t=this.model.get("email"),e=null;switch(this.model.get("cuType")){case void 0:case"INDIVIDUAL":this.isOrganizer()&&(e=n("Organizer")),this.isRemovable()||this.$el.removeClass("removable"),t&&this.options.halo&&this.nodes.$mail.attr({href:"mailto:"+t}).data({email1:t}).addClass("halo-link");break;case"RESOURCE":if(this.options.halo&&!this.options.hideMail){var i=this.model.toJSON();i.resource&&(i=i.resource),i.callbacks={},this.options.baton&&this.options.baton.callbacks&&(i.callbacks=this.options.baton.callbacks);var s=$('<a href="#">').data(i).addClass("halo-resource-link");this.nodes.$extra.replaceWith(s),this.nodes.$extra=s}}this.setRows(t,e)},fnKey:function(t){46!==t.which&&8!==t.which||this.onRemove(t)},onRemove:function(t){t.preventDefault(),this.model.collection.remove(this.model)}}),h=Backbone.View.extend({tagName:"div",className:"participantsrow col-xs-12",initialize:function(t){this.options=_.extend({empty:n("This list has no participants yet")},t),this.listenTo(this.collection,"add",function(t){this.renderLabel(),this.renderEmptyLabel(),this.renderParticipant(t)}),this.listenTo(this.collection,"remove",function(){this.renderLabel(),this.renderEmptyLabel()}),this.listenTo(this.collection,"reset",function(){this.$ul.empty(),this.renderAll()}),this.$empty=$("<li>").text(this.options.empty)},render:function(){return this.$el.append($("<fieldset>").append($("<legend>").addClass(this.options.labelClass||""),this.$ul=$('<ul class="list-unstyled">'))),this.renderAll(),this},renderLabel:function(){var t=this.collection.length-(this.options.hideInternalGroups?this.collection.filter(function(t){return"GROUP"===t.get("cuType")&&t.get("entity")}).length:0),e=this.options.label||(this.isDistributionList?n("Members (%1$d)",t):n("Participants (%1$d)",t));this.$("fieldset > legend").text(e)},renderParticipant:function(t){if(!this.options.hideInternalGroups||"GROUP"!==t.get("cuType")||!t.get("entity")){var e=new r({tagName:"li",model:t,baton:this.options.baton,halo:void 0===this.options.halo||this.options.halo,closeButton:!0,asHtml:this.options.asHtml,hideMail:this.options.hideMail});e.on("render",function(){this.collection.trigger("render")}.bind(this)),e.render().$el.addClass(this.options.entryClass||"col-xs-12 col-sm-6"),this.options.baton.model.get("organizer")&&t.get("entity")===this.options.baton.model.get("organizer").entity?this.$ul.prepend(e.$el):this.$ul.append(e.$el)}},renderAll:function(){var t=this;return this.renderLabel(),this.renderEmptyLabel(),this.collection.each(function(e){t.renderParticipant(e)}),this},renderEmptyLabel:function(){if(!this.options.noEmptyLabel)return 0===this.collection.length?this.$ul.append(this.$empty):this.$empty.remove(),this.$ul.toggleClass("empty",0===this.collection.length)}});return{ParticipantEntryView:r,UserContainer:h}});