define("io.ox/core/tk/vgrid",["io.ox/core/extensions","io.ox/core/tk/selection","io.ox/core/event","gettext!io.ox/core"],function(e,t,n,i){"use strict";function o(e){function t(e){this.node=e,this.fields={},this.set=[],this.detached=!0}e=_.extend({tagName:"div",defaultClassName:"vgrid-cell",tempDrawContainer:document.body},e);var n=[],i=function(t){t.css("visibility","hidden").show().appendTo(e.tempDrawContainer);var n=Math.max(1,t.outerHeight(!0));return t.remove(),n},o=!0;this.node=$("<"+e.tagName+">").addClass(e.defaultClassName),this.add=function(e){e&&e.build&&(n.push(e),o=!1)},this.isEmpty=function(){return o},this.getHeight=function(){return o?0:n[0].getHeight?n[0].getHeight():i(this.getClone().node)},this.getDefaultClassName=function(){return e.defaultClassName},t.prototype.update=function(e,t,n,i,o){for(var r=0,l=this.set,a=l.length,c=[];r<a;r++)c.push(l[r].call(this.node,e,this.fields,t,i,o)||s);return void 0!==n&&this.node.attr("data-obj-id",n),c},t.prototype.appendTo=function(e){return this.detached&&(this.node.appendTo(e),this.detached=!1),this},t.prototype.detach=function(){return this.node.detach(),this.node.removeAttr("data-obj-id"),this.detached=!0,this},this.getClone=function(i){var o,s=0,r=n.length,l=new t(this.node.clone());for(i&&_.extend(l.fields,i.call(l.node)||{});s<r;s++)o=n[s],_.extend(l.fields,o.build.call(l.node)||{}),l.set.push(o.set||$.noop);return l.node.add(l.node.find("div, span, p, td")).not(".ignoreheight").each(function(){var e=$(this);0===e.children().length&&""===e.text()&&e.text("Â ")}),l.node.find("img").each(function(){""!==this.style.width&&""!==this.style.height||(console.error("Image has no width/height. Set to (0, 0):",this),this.style.width=this.style.height="0px")}),e.defaultClassName=l.node[0].className,l}}var s=$.when(),r=200,l=40,a=function(e){function t(){var t=-1;this.load=function(n,i){return n=n&&Math.max(0,Math.floor(n/l)*l)||0,0===i.length||n===t?$.Deferred().resolve(null):(t=n,e(i.slice(n,n+r)).then(function(e){try{return t===n?{data:e,offset:n,length:e.length}:null}finally{e=i=null}}))},this.reset=function(){t=-1}}var n=null;this.load=function(){return n.load.apply(n,arguments)},this.reset=function(){n&&n.reset(),n=new t},this.reset()},c=function(e){e.preventDefault();var t,n=$(this).closest(".leftside"),i=n.siblings(".rightside"),o=e.pageX-n.width(),s=$(document).width()-250;$(document).on({"mousemove.resize":function(e){t=Math.max(250,Math.min(e.pageX,s)-o),n.css("width",t),i.css("left",t)},"mouseup.resize":function(){$(this).off("mousemove.resize mouseup.resize"),e.data.updateSettings("width/"+_.display(),t),$(document).trigger("resize")}})},d=function(e,l){function d(e,t){B[e].detach(),B[e].node[0].className=t||V.getDefaultClassName()}function h(){for(var e=0,t=B.length,n=V.getDefaultClassName();e<t;e++)d(e,n)}function u(){return E(),A().done(function(e){y.css({height:e+te.length*G+"px"})})}function f(e,t){if(te=e,ae=null,g.selection.init(te),u(),w.find(".io-ox-center").remove().end(),0===e.length&&b){h(),g.selection.trigger("change",[]);var n=g.getEmptyMessage();w.append($.fail(n?n(g.getMode()):i.pgettext("vgrid","Empty")))}t||g.trigger("change:ids",te);var o,s,r;return o=w.scrollTop(),s=j(o),r=s-(U>>1),z(r)}(l=_.extend({simple:!0,editable:!0,multiple:!0,draggable:!0,dragType:"",selectFirst:!0,toolbarPlacement:"top",secondToolbar:!1,swipeLeftHandler:!1,swipeRightHandler:!1,containerLabel:i("Multiselect"),dividerThreshold:0},l||{})).settings&&(l.editable=!_.device("smartphone")&&l.settings.get("vgrid/editable",!0));var p=$(e).empty().addClass("vgrid"),g=this,v=!1,b=!1,m=!0,x=!0,w=$('<div class="abs vgrid-scrollpane">').appendTo(p),y=$('<div class="vgrid-scrollpane-container f6-target" role="listbox" tabindex="0">').attr(function(){var e={};return l.multiple&&(e["aria-multiselectable"]="true"),e["aria-label"]=l.containerLabel,e}()).css({position:"relative",top:"0px"}).appendTo(w),T=function(e,t){e.toggleClass("fa-check-square-o",t).toggleClass("fa-square-o",!t).parent().attr("title",i(t?"Deselect all":"Select all"))},C=function(e){var t=e.length>=1&&e.length>=te.length;T(p.find(".select-all i.fa"),t)},M=$('<div class="vgrid-toolbar generic-toolbar">').addClass("top"===l.toolbarPlacement?"bottom border-top":"top border-bottom").appendTo(p),k=$('<div role="toolbar" class="vgrid-toolbar generic-toolbar">').addClass("top"===l.toolbarPlacement?"top border-bottom":"bottom border-top").attr("aria-label",i("Item list options")).append(!1===l.showCheckbox?[]:$('<button type="button" class="btn btn-link select-all" data-name="select-all">').append($('<i class="fa fa-square-o" aria-hidden="true">')).attr("title",i("Select all")).on("click",{grid:this},function(e){var t=e.data.grid;$(this).find("i").hasClass("fa-square-o")?(t.selection.selectAll(),_.defer(function(){y.children('[tabindex="0"]:first').focus()}),C(t.selection.get())):(t.selection.clear(),_.device("smartphone")&&g.selection.trigger("_m_change",[]))})).prependTo(p),D={tempDrawContainer:y};l.templateOptions&&(D=_.extend(D,l.templateOptions)),y.on("keydown",function(e){switch(e.which){case 65:case 97:(e.ctrlKey||e.metaKey)&&(e.preventDefault(),g.selection.selectLast(),_.defer(function(){g.selection.selectAll(),C(g.selection.get())}));break;case 68:case 100:(e.ctrlKey||e.metaKey)&&(e.preventDefault(),g.selection.clear())}});var I,N,A,E,L,z,H,S,q,P,F,j,O,R,K,J,V=new o(D),X=new o({tempDrawContainer:y}),B=[],G=0,Q=0,U=0,W=0,Y="all",Z={all:function(){return $.Deferred().resolve([])}},ee={all:function(e){return $.Deferred().resolve(e)}},te=[],ne={nodes:$()},ie=$(),oe={top:0,bottom:0},se=new Backbone.Model({editable:l.editable||!1}),re=_.isArray,le=!1,ae=null,ce=new a(function(e){return(ee[Y]||ee.all).call(g,e)});se.on("change",function(e){var t=e.changedAttributes(),n=_.keys(t)[0],i=_.values(t)[0];g.trigger("beforechange:prop",n,e.previousAttributes()[n],i),g.trigger("beforechange:prop:"+n,e.previousAttributes()[n],i),g.trigger("change:prop",n,i,e.previousAttributes()[n]),g.trigger("change:prop:"+n,i,e.previousAttributes()[n]),m=!0}),_.device("touch")||p.append($('<div class="resizebar">').on("mousedown",this,c)),this.multiselectId=_.uniqueId("multi-selection-message-"),V.node.addClass("selectable"),X.node.addClass("vgrid-label").attr({tabindex:-1,"aria-hidden":"true"}),_.device("IE")&&y.on("click",function(){var e=w.scrollTop();w.css("overflow-y","hidden"),y.css("top",e+"px"),y.focus(),y.css("top",0),w.css("overflow-y","auto"),w.scrollTop(e)}),n.extend(this),t.extend(this,w,{draggable:l.draggable,dragType:l.dragType}),_.device("touch")&&(l.swipeLeftHandler&&$(e).on("swipeleft",".selectable",function(e){if("search"!==Y){var t=$(this),n=t.attr("data-obj-id");l.swipeLeftHandler(e,n,t)}}),l.swipeRightHandler&&$(e).on("swiperight",".selectable",function(e){if("search"!==Y){var t=$(this),n=t.attr("data-obj-id");l.swipeRightHandler(e,n,t)}})),I=function(e,t){var n=ne.list[e];void 0!==n&&(w.scrollTop(n.top),!0!==t&&g.selection.set(te[n.pos]).setLastIndex(te[n.pos]))},N=function(e){var t=$(this).data("label-index")||0,n="dblclick"===e.type?1:0;I(t+n,!0)},A=function(){for(var e,t=0,n=ne.list.length,i=null,o=0,s="",r=[];t<n;t++)e=ne.list[t],(i=X.getClone()).node.addClass("vgrid-label").data("label-index",t),r=r.concat(i.update(te[e.pos],e.pos,"",te[e.pos-1]||{},g)),s=i.node.text(),ne.nodes=ne.nodes.add(i.node.appendTo(y)),ne.index[e.pos]=t,ne.textIndex[s]=t;return $.when.apply($,r).then(function(){var e,t,s,a,c,d=n>0?y.show().is(":visible"):void 0;for(e=0;e<n;e++)(t=ne.list[e]).top=o+t.pos*G,(s=ne.nodes.eq(e)).css({top:t.top+"px"}),c=le?0:d&&s.outerHeight(!0)||Q,o+=t.height=c;return l.tail&&(ie=l.tail.call(g,te.slice())||$(),a=te.length*G+o,y.append(ie.css({top:a+"px"})),o+=ie.outerHeight(!0)),s=i=r=null,o})},L=function(){var e=function(){var e={};return this.prepend(e.div=$('<div class="vgrid-cell-checkbox">').append(e.icon=$('<i class="fa fa-check" aria-hidden="true">'))),{checkbox:e}};return function(t){return t.getClone(function(){if(!l.checkboxDisabled)return e.call(this)})}}(),E=function(){ne.nodes.remove(),ie.remove(),ne={nodes:$(),list:[],index:{},textIndex:{}},le=l.dividerThreshold&&te.length<l.dividerThreshold,p.toggleClass("invisible-labels",le);for(var e=0,t=te.length+1,n="",i="";e<t;e++)!1!==(i=g.requiresLabel(e,te[e],n,t))&&(ne.list.push({top:0,pos:e}),n=i)},z=function(){function e(e){var t,n,i,o,s,r=e.data,l=e.offset,a=0,c="",h=V.getDefaultClassName(),u=new Array(r.length);for(c in ne.index)l>c&&(s=ne.index[c],a+=ne.list[s].height||Q);for(t=0,n=r.length;t<n;)r[t]?t++:(r.splice(t,1),n--);for(t=0,n=r.length;t<n;t++)void 0===(s=ne.index[l+t])||le||(a+=ne.list[s].height||Q),(i=B[t]).appendTo(y),i.node.attr({role:"option","aria-posinset":l+t+1,"aria-setsize":r.length}),(o=i.node[0]).className=h+" "+((l+t)%2?"odd":"even"),i.update(r[t],l+t,g.selection.serialize(r[t]),r[t-1]||{},g),o.style.top=a+(l+t)*G+"px",u[t]=i.node;if(n<W)for(;t<W;t++)d(t,h);g.selection.update(),u=null,oe.top=l,oe.bottom=l+e.length}function t(t){e({data:new Array(W),offset:t,length:W})}return function(n){if(v)return(n=Math.max(n>>0,0))===ae?s:(ae=n,ce.load(n,te).then(function(t){t&&t.data&&(e(t),J&&(g.selection.set(J),J=void 0))},function(){t(n)}))}}(),H=function(){U=Math.max(1,2+(p.height()/G>>0)),W=r;for(var e,t=0,n=document.createDocumentFragment();t<W;t++)t>=B.length?(e=L(V),n.appendChild(e.node[0]),B.push(e)):n.appendChild(B[t].node[0]);for(;t<B.length;t++)B[t].node.detach();y[0].appendChild(n),n=null},R=function(e){return _.cid(e)};var de=function(){function e(){var e=_.url.hash("id");return void 0!==e?e.split(/,/):[]}function t(e,t){e=_(e).map(R);var n,i,o=!g.selection.equals(e);o&&!g.selection.getMobileSelectMode()&&g.selection.set(e),(o||t)&&(n=_(e).first(),i=g.selection.getIndex(n)||0,P(i)||F(i-2))}function n(){return $(document).width()>700}return function(i){if(te.length){var o=g.selection.get(),s=o.length?_(o).map(g.selection.serialize):e();if(s.length){if(g.selection.contains(s))return void t(s,i);_.url.hash("id",null)}if(n()){var r=g.select();_.isNumber(r)?(g.selection.set(te[r]),P(r)||F(r-2)):_.isArray(r)?g.selection.contains(r)?g.selection.set(r):g.selection.clear():l.selectFirst?g.selection.selectFirst():g.selection.clear()}}else g.selection.clear()}}();S=function(){function e(e){e="PERMISSION_DENIED"===e.categories?e:{},e=re(e)?_.first(e):e,f([]),y.hide().parent().idle().find(".io-ox-fail").parent().remove().end().end().append($.fail(e.error||i("Could not load this list"),function(){y.show(),S()}))}function t(e){return b=!0,m=!1,ce.reset(),_.isArray(e)?f(e).always(function(){g.idle()}).done(function(){var t=!_.isEqual(te,e);de(t),ox.trigger("grid:stop",_.clone(se.toJSON()),e)}):(console.warn("VGrid.all() must provide an array!"),$.Deferred().reject())}return function(){return ox.trigger("grid:start",_.clone(se.toJSON())),(m||0===te.length)&&g.busy(),(Z[Y]||Z.all).call(g).then(_.lfo(t),_.lfo(e))}}(),q=function(){return G=V.getHeight(),Q=X.getHeight(),H(),ae=null,v=!0,$(document).trigger("resize"),S()},P=function(e){var t=w.scrollTop(),n=w.height();return e>=j(t)&&e<j(t+n)-1},F=function(e){for(var t,n=0,i=Math.min(Math.max(0,e),te.length),o=0,s=0;n<i;n++)(t=ne.list[o])&&t.pos===n&&(s+=t.height||Q,o++),s+=G;w.scrollTop(s)},j=function(e){for(var t,n=0,i=te.length,o=0,s=0;n<i&&s<e;n++)(t=ne.list[o])&&t.pos===n&&(s+=t.height||Q,o++),s+=G;return n},O=_.throttle(function(){var e=w.scrollTop(),t=j(e);t>=oe.bottom-U-2?z(t-(U>>1)):t<oe.top+2&&0!==oe.top&&z(t-1.5*U,"above")},50),this.selection.on("change",function(e,t){C(t);var n=_(t.length>50?t.slice(0,1):t).map(function(e){return g.selection.serialize(e)}).join(",");_.url.hash("id",""!==n?n:null),t.length>=1&&p.trigger("select",[t])}).on("select:first",function(){F(0)}).on("select:last",function(){F(te.length-1)}),this.setApp=function(e){return this.app=e,this.app},this.getApp=function(){return this.app},this.setAllRequest=function(e,t){_.isFunction(e)&&(t=e,e="all"),Z[e]=t},this.setListRequest=function(e,t){_.isFunction(e)&&(t=e,e="all"),ee[e]=t},this.updateSettings=function(e,t){l.settings&&l.settings.set("vgrid/"+e,t).save()},this.addTemplate=function(e){V.add(e)},this.addLabelTemplate=function(e){X.add(e)},this.requiresLabel=function(){return!1},this.busy=function(){return w.find(".io-ox-center").remove(),y.css({visibility:"hidden"}).parent().busy(),this},this.setPreSelection=function(e){J=e},this.idle=function(){return _.defer(function(){y.show().css({visibility:""}).parent().idle()}),this},this.paint=function(){return x&&(w.on("selectstart",!1).on("scroll",O).on("click dblclick",".vgrid-label",N),x=!1),q()},this.repaintLabels=function(){return u()},this.repaint=_.mythrottle(function(){var e=ae||0;ae=null,ce.reset(),z(e)},100),this.clear=function(){return f([],!0)},this.refresh=function(e){return x?!0===e?this.paint():s:S()},this.pending=function(){return m=!0,this.busy(),this},this.getMode=function(){return Y},this.setMode=function(e){var t=Y;return Y=e,_.url.hash("id",null),m=!0,this.trigger("change:mode",Y,t),this.refresh()},this.getId=function(e){return{folder_id:e.folder_id,id:e.id}},this.getData=function(e){return void 0!==e?te[e]:te},this.contains=function(e){for(var t=this.selection,n=t.serialize(e),i=0,o=(te||[]).length;i<o;i++)if(n===t.serialize(te[i]))return!0;return!1},this.getLabels=function(){return ne},this.scrollToLabelText=function(e,t){var n=e.data?e.data.text:e,i=ne.textIndex[n];void 0!==i&&I(i,t)},this.scrollTop=function(){return w.scrollTop()},this.keyboard=function(e){this.selection.keyboard(w,e)},this.getToolbar=function(){return k},this.getTopbar=function(){return M},this.getEditable=function(){return this.prop("editable")},this.getMobileSelectMode=function(){return!1},this.setEditable=function(e){!0===l.multiple&&(e?(p.addClass("editable"),this.selection.setEditable(!0,l.simple?".vgrid-cell-checkbox":".vgrid-cell")):(p.removeClass("editable"),this.selection.setEditable(!1)),this.prop("editable",e),this.updateSettings("editable",e))},this.setMultiple=function(e){console.warn("deprecated",e)},this.option=function(e,t){if(void 0!==e){if(void 0!==t){var n=l[e];return t!==n&&(this.trigger("beforechange:option",e,t,n),this.trigger("beforechange:option:"+e,t,n),l[e]=t,this.trigger("change:option",e,t,n),this.trigger("change:option:"+e,t,n),m=!0),this}return l[e]}return l},this.props=se,this.prop=function(e,t){if(void 0!==e){if(void 0!==t){var n=se.get(e);return t!==n&&(this.trigger("beforechange:prop",e,t,n),this.trigger("beforechange:prop:"+e,t,n),se.set(e,t,{silent:!0}),this.trigger("change:prop",e,t,n),this.trigger("change:prop:"+e,t,n),m=!0),this}return se.get(e)}return se.toJSON()},this.scrollTop=function(e){return void 0!==e?w.scrollTop(e):w.scrollTop()},this.getContainer=function(){return y},this.setDeserialize=function(e){_.isFunction(e)&&(R=e)},this.getIds=function(){return te.slice()},this.isVisible=P,this.setIndex=F,this.getIndex=j,this.setEmptyMessage=function(e){K=e},this.getEmptyMessage=function(){return K},this.updateTemplates=function(){_(B).each(function(e){e.detach()}),B=[],v&&(q(),this.repaint())},this.getToolbar=function(){return k},this.showToolbar=function(e){!0===e?k.show():k.hide()},this.showTopbar=function(e){!0===e?(M.show(),p.addClass("top"===l.toolbarPlacement?"top-toolbar":"bottom-toolbar")):(M.hide(),p.removeClass("top-toolbar bottom-toolbar"))},l.multiple?(l.editable&&this.setEditable(!0),this.selection.setMultiple(!0),k.show()):this.selection.setMultiple(!1),"none"!==l.toolbarPlacement&&(p.addClass("top"===l.toolbarPlacement?"top-toolbar":"bottom-toolbar"),l.secondToolbar&&_.device("!smartphone")&&p.addClass("top"===l.toolbarPlacement?"bottom-toolbar":"top-toolbar")),l.hideTopbar&&this.showTopbar(!1),l.hideToolbar&&this.showToolbar(!1),this.on("change:prop:folder",function(e,t,n){ce.reset(),void 0!==n&&(this.scrollTop(0),g.selection.resetLastIndex())}),this.on("change:mode",function(){ce.reset(),this.scrollTop(0),g.selection.clear(),g.selection.resetLastIndex()}),_.device("smartphone")||y.on("focus",function(){var e=y.children(),t=e.filter('[tabindex="0"]:first');_.device("IE")&&!t.length||(t.length?t.focus():e.first().click())}).on("focus",".vgrid-cell",function(){y.removeAttr("tabindex")}).on("blur",".vgrid-cell",function(){y.attr("tabindex",0)}),this.select=function(){var e={};return l.settings&&_(l.settings.get("vgrid/previous",{})).each(function(t,n){e[n]=[_.cid(t)]}),g.selection.on("change",function(t,n){var i=g.prop("folder");l.settings&&n.length<=1&&(l.settings.set(["vgrid","previous",i],_.cid(n[0])).save(),e[i]=n)}),g.on("beforechange:prop:folder",function(t,n,i){void 0!==i&&(e[i]=g.selection.get())}),g.selection.on("clear",function(){var t=g.prop("folder");delete e[t]}),function(){var t=g.prop("folder");return"all"===Y&&e[t]||null}}(),this.focus=function(){y.focus()}};return d.Template=o,d});