define("io.ox/core/tk/text-editor",["io.ox/core/tk/textproc","settings!io.ox/mail"],function(t,e){"use strict";var n=$.original.val;return function(i,o){function s(){if(null!==i){var t=r.closest(".io-ox-mail-compose-window").hasClass("header-top")?0:$('[data-extension-id="header"]').parent().outerHeight();r.css("minHeight",Math.max(300,$(window).height()-r.offset().top-t))}}o=_.extend({useFixedWithFont:!1},o);var r=$('<textarea class="plain-text">').toggleClass("monospace",o.useFixedWidthFont);_.extend(this,Backbone.Events),r.on("change",this.trigger.bind(this,"change")),r.on("input",_.throttle(this.trigger.bind(this,"change"),100)),$(i).append(r),_.device("tablet && iOS >= 6")&&r.on("click",function(){r.get(0).selectionStart<100&&_.defer(function(){window.scrollTo(0,0),document.body.scrollTop=0})});var c=$.when(this),a=function(t){return(t=String(t||"")).replace(/[\s\xA0]+$/,"")},h=function(t){return t=a(t),t=t.replace(/^\n{2,}/,"\n\n"),/^\n{0,2}[ \t\xA0]*\S/.test(t)?t:(t=t.replace(/^[\s\xA0]*\n([\s\xA0]*\S)/,"$1"),t=t.replace(/(\s|&nbsp;|\0x20|<br\/?>|<p( class="io-ox-signature")>(&nbsp;|\s|<br\/?>)*<\/p>)*$/g,""))},l=function(t){n.call(r,a(t)),this.setCaretPosition()},u=function(){return h(n.call(r))};this.content_type="text/plain",this.getMode=function(){return"text"},this.done=function(t){return c.done(t)},this.focus=function(){_.device("!smartphone && !iOS")&&r.focus()},this.clear=function(){n.call(r,"")},this.getContent=u,this.getPlainText=u,this.setContent=l,this.setPlainText=l,this.paste=$.noop,this.scrollTop=function(t){if(void 0===t)return r.scrollTop();"top"===t?r.scrollTop(0):"bottom"===t&&r.scrollTop(r.get(0).scrollHeight)},this.setCaretPosition=function(){function t(){if(r&&r.is(":visible"))if(e.setSelectionRange)e.setSelectionRange(0,0);else if(e.createTextRange){var t=e.createTextRange();t.moveStart("character",0),t.select()}}if(r){var e=r.get(0);t(),_.browser.Chrome&&_.defer(t),r.scrollTop(0)}},this.appendContent=function(t){var e=this.getContent();e=this.getContent().replace(/\n+$/,"").replace(/^\n+/,""),this.setContent(e+"\n\n"+t)},this.prependContent=function(t){var e=this.getContent().replace(/^\n+/,"").replace(/\n+$/,"");this.setContent("\n"+t+"\n\n"+e)},this.setContentParts=function(t,e){var n="";(t=_.isString(t)?{content:t}:t).content&&(n+=t.content),"above"===e&&t.cite&&(n+="\n\n"+t.cite),t.quote&&(n+="\n\n"+t.quote||""),"below"===e&&t.cite&&(n+="\n\n"+t.cite),this.setContent(n)},this.getContentParts=function(){var t=this.getContent(),n="forward"===o.view.model.get("mode")&&e.get("forwardunquoted",!1),i=t.indexOf(n?"----":"\n> ");return i>=0&&i++,"> "===t.substring(0,2)&&(i=0),i<0?{content:t}:{content:t.substring(0,i-1).replace(/\s+$/g,""),quote:t.substring(i),cite:void 0}},this.insertPrevCite=function(t){var e=this.getContentParts();e.cite=t,this.setContentParts(e,"above")},this.insertPostCite=function(t){var e=this.getContentParts();e.cite=t,this.setContentParts(e,"below")},this.replaceParagraph=function(e,n){var i,o=this.getContent(),s=o.length,r=t.htmltotext(e),c=new RegExp("("+e+"|"+r+")");return(o=o.replace(c,n||"")).length!==s&&(i=this.scrollTop(),this.setContent(o),this.scrollTop(i),!0)},this.show=function(){r.prop("disabled",!1).show(),$(window).on("resize.text-editor",s),s()},this.hide=function(){r.prop("disabled",!0).hide(),$(window).off("resize.text-editor",s)},this.getContainer=function(){return r},this.destroy=function(){this.hide(),this.setContent(""),r=c=null}}});