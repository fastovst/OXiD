define("io.ox/core/tk/typeahead",["io.ox/core/extensions","io.ox/core/api/autocomplete","settings!io.ox/contacts","settings!io.ox/core","static/3rd.party/typeahead.jquery.js","css!3rd.party/bootstrap-tokenfield/css/tokenfield-typeahead.css"],function(t,e,i,o){"use strict";function n(t,e){return this.model.set({source:t}),e}return Backbone.View.extend({el:'<input type="text" class="form-control">',options:{apiOptions:{contacts:!1,users:!1,groups:!1,resources:!1,distributionlists:!1},source:function(t){return this.api.search(t)},click:$.noop,autoselect:!0,hint:!0,reduce:_.identity,harmonize:_.identity,init:!0,extPoint:"io.ox/core/tk/typeahead"},initialize:function(s){var a=this;if(this.model=new Backbone.Model({source:"idle",query:void 0,dropdown:"closed"}),s.apiOptions){var r=void 0!==s.apiOptions.limit?s.apiOptions.limit:o.get("autocompleteApiLimit",10);s.apiOptions.limit=r,s.maxResults||(s.maxResults=o.get("autocompleteDrawLimit",r*_(s.apiOptions).filter(function(t){return!0===t}).length))}else s.maxResults=o.get("autocompleteDrawLimit",25);s=this.options=$.extend({},this.options,s||{}),this.api=new e(_.extend({extPoint:/^io\.ox\/core\/tk\/(typeahead|tokenfield)$/.test(s.extPoint)?void 0:s.extPoint},s.apiOptions)),this.listenTo(ox,"refresh^",function(){this.api.cache={}}),this.process=function(t,e,i){$.when(i).then(n.bind(a,"processing")).then(s.reduce).then(function(t){return s.maxResults&&(t=t.slice(0,s.maxResults)),"top"===s.placement?t.reverse():t}).then(s.harmonize).then(n.bind(a,"finished")).then(n.bind(a,"idle")).then(e)},this.typeaheadOptions=[{autoselect:s.autoselect,minLength:Math.max(1,i.get("search/minimumQueryLength",2)),highlight:!0,hint:s.hint},{source:function(t,e){if(n.call(a,"requesting"),s.source.call(a,t).then(_.lfo(a.process,t,e)),!a.registered){var i=this;i.onSync("rendered",function(){var t=i.$el.closest(".twitter-typeahead").find(".tt-dropdown-menu"),e=t.find(".tt-dataset-0").is(":empty"),o=t.find("span.info").attr("data-query");e||a.model.set("query",o),t.is(":visible")&&a.model.set("dropdown","opened"),o&&a.trigger("typeahead-custom:dropdown-rendered",t)}),a.registered=!0}},templates:{suggestion:s.suggestion||function(e){var i=$('<div class="autocomplete-item">');return t.point(s.extPoint+"/autoCompleteItem").invoke("draw",i,e,s),i},header:function(t){return $('<span class="info hidden">').attr("data-query",t.query)}}}],t.point(s.extPoint+"/typeahead/customize").invoke("customize",this)},render:function(){function t(t){if(!t||!t.originalEvent)return!0;var e=t.originalEvent.movementX,i=t.originalEvent.movementY;return 0!==e||0!==i||void 0}var e=this.options,i=this;this.$el.attr({placeholder:this.options.placeholder,"aria-label":this.options.ariaLabel}).on({"typeahead:closed":function(){i.$el.closest(".twitter-typeahead").find(".tt-dropdown-menu").is(":visible")||i.model.set("dropdown","closed")},"typeahead:selected typeahead:autocompleted":function(t,o){e.click.call(this,t,o),i.$el.trigger("select",o),i.$el.typeahead("val","")}}),this.$el.on({"typeahead:cursorchanged":function(){var t=i.$el.closest(".twitter-typeahead").find(".tt-cursor").attr("id");i.$el.attr("aria-activedescendant",t)}}),this.model.on("change:dropdown",function(t,e){if("closed"===e)return i.$el.removeAttr("aria-activedescendant");var o=i.$el.closest(".twitter-typeahead").find(".tt-dropdown-menu"),n=$('<div class="tt-suggestions" role="listbox">'),s=o.find(".tt-suggestions").children();n.append(s.each(function(){$(this).attr({id:_.uniqueId("option_"),role:"option"})})),o.find(".tt-suggestions").replaceWith(n),o.scrollTop(0)}),this.options.init&&(this.$el.typeahead.apply(this.$el,this.typeaheadOptions),this.$el.data("ttTypeahead").input._callbacks.enterKeyed.sync[0]=function(t,e){var i=this.dropdown.getDatumForCursor(),o=this.dropdown.getDatumForTopSuggestion(),n=this.input.getHint();i&&_.isEmpty(n)?(this._select(i),e.preventDefault()):this.autoselect&&o&&(this._select(o),e.preventDefault())}.bind(this.$el.data("ttTypeahead"))),ox.debug&&ox.debug_typeahead&&(this.$el.data("ttTypeahead").dropdown.close=$.noop,this.$el.data("ttTypeahead").dropdown.empty=$.noop);var o=_.extend(this.$el.data("ttTypeahead").dropdown,{_onSuggestionMouseEnter:function(e){t(e)&&(this._removeCursor(),this._setCursor($(e.currentTarget),!0))},_onSuggestionMouseLeave:function(e){t(e)&&this._removeCursor()}});return this.options.keepInComposeWindow&&_.extend(o,{_show:function(){this.$menu.css({left:0,display:"block"}),this.$menu.css("left",Math.min(0,this.$menu.closest(".io-ox-mail-compose").offset().left+this.$menu.closest(".io-ox-mail-compose").outerWidth()-(this.$menu.offset().left+this.$menu.outerWidth()+15)))}}),o.$menu.off("mouseenter.tt mouseleave.tt").on("mouseenter.tt mousemove.tt",".tt-suggestion",o._onSuggestionMouseEnter.bind(o)).on("mouseleave.tt",".tt-suggestion",o._onSuggestionMouseLeave.bind(o)),this}})});