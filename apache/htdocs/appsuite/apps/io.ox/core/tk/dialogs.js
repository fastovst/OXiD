define("io.ox/core/tk/dialogs",["io.ox/core/event","io.ox/core/extensions","io.ox/core/a11y","io.ox/backbone/mini-views/helplink","gettext!io.ox/core"],function(e,t,o,i,n){"use strict";function s(){return $('<div class="modal-backdrop in" aria-hidden="true">').hide()}function a(){return $('<div class="io-ox-dialog-popup" role="dialog" aria-labelledby="dialog-title">').hide().append($('<div role="document">').append($('<div class="modal-header" id="dialog-title">'),$('<div class="modal-body">'),$('<div class="clearfix">'),$('<div class="modal-footer">')))}var r=function(n){var r=_.extend({width:500,underlayAction:null,defaultAction:null,easyOut:!0,center:!0,async:!1,noBusy:!1,maximize:!1,top:"50%",container:$("body>.io-ox-sidepopup-overlay").length?$("body"):$("#io-ox-core"),tabTrap:!0,focus:!0},n),d={buttons:[],underlay:s(),popup:a(),wrapper:$('<div class="abs io-ox-dialog-wrapper">')},p=$(),l=$(),c=$.Deferred(),u=!1,h=this,f={},g=function(e){$(e.target).closest(".io-ox-dialog-popup, .io-ox-sidepopup, .mce-window, .date-picker, .addressbook-popup").length>0||$("body > .smart-dropdown-container").length>0||d.popup.is(":visible")&&(e.stopPropagation(),d.popup.focus())},b=function(){if(h){r.container.removeClass("blockscroll"),h.trigger("close"),document.removeEventListener("focus",g,!0),d.popup.empty().remove(),d.underlay.remove(),d.wrapper.remove(),p=p.closest(":visible"),r.focus&&(p.hasClass("dropdown")?p.children().first().focus():p.focus()),h.events.destroy();for(var e in h)delete h[e];$(window).off("resize.mobile-dialog"),h.close=h.idle=$.noop,d.header=d.body=d.footer=d.underlay=d.wrapper=null,d.buttons=p=l=null,d=c=h=f=r=null}},v=function(){d.footer.find("input, select, button").add(d.body.css("opacity",.5).find("input, select, button, textarea")).each(function(e,t){t=$(t),_.isUndefined(t.data("wasDisabled"))&&(t.data("wasDisabled",t.prop("disabled")),t.prop("disabled",!0))}),l=$(document.activeElement),d.popup.focus(),u=!0},m=function(){d.footer.find("input, select, button").add(d.body.css("opacity","").find("input, select, button, textarea")).each(function(e,t){t=$(t),_.isUndefined(t.data("wasDisabled"))||(t.prop("disabled",t.data("wasDisabled")),t.removeData("wasDisabled"))}),l.focus(),u=!1},y=function(e){var t=e.data?e.data.action:e,o=r.async&&"cancel"!==t;o&&!r.noBusy&&v(),h.trigger("action "+t,f,h),!o&&h&&(c.resolveWith(d.popup,[t,f,h.getContentNode().get(0)]),b()),_.isObject(e)&&!_.browser.Safari&&(e.processed=!0)},w=function(e){switch(e.which){case 27:u||0!==h.getBody().find(".open > .dropdown-menu").length||(e.stopPropagation(),r.easyOut&&y("cancel"));break;case 13:if(!u&&$(e.target).is("input:text, input:password"))return!!r.enter&&(_.isFunction(r.enter)?r.enter.call(h):(y(r.enter),!1));break;case 9:r.tabTrap&&o.trapFocus(this,e)}},x=function(){$(d.wrapper).parentsUntil("body").add(d.wrapper).siblings(":not(script,noscript)").each(function(){var e=$(this);e.data("ox-restore-aria-hidden",e.attr("aria-hidden"))}).attr("aria-hidden",!0),h.on("close",function(){$(d.wrapper).parentsUntil("body").add(d.wrapper).siblings(":not(script,noscript)").removeAttr("aria-hidden").each(function(){var e=$(this);e.data("ox-restore-aria-hidden")&&e.attr("aria-hidden",e.data("ox-restore-aria-hidden")),e.removeData("ox-restore-aria-hidden")})})};t.point("io.ox/core/dialogs").invoke("customize",this,r),r.container.append(d.wrapper.append(d.popup,d.underlay)),_(["header","body","footer"]).each(function(e){d[e]=d.popup.find(".modal-"+e)}),r.addClass&&d.popup.addClass(r.addClass),e.extend(this),this.resizeBody=function(){var e=h.getPopup().position().top,t=$(document).height(),o=h.getBody().height(),i=h.getPopup().height(),n=h.getBody().find(".vgrid-cell").eq(0).outerHeight(),s=i+e+30;if(s>=t){var a=o+(t-s);a>=n?h.getBody().css("height",a+"px"):h.getBody().css("height",n+"px")}},this.data=function(e){return f=void 0!==e?e:{},this},this.header=function(){return d.header.append.apply(d.header,arguments),this},this.getHeader=function(){return d.header},this.getPopup=function(){return d.popup},this.getContentNode=this.getBody=function(){return d.body},this.getContentControls=this.getFooter=function(){return d.footer},this.text=function(e){var t=d.body,o=_.uniqueId("label-");return t.find(".plain-text").remove(),t.append($('<h4 class="plain-text">').attr("id",o).text(e||"")),d.popup.attr({"aria-labelledby":o,role:"alertdialog"}),this},this.build=function(e){return _.isFunction(e)&&e.call(this),this},this.append=function(){return d.body.append.apply(d.body,arguments),this},this.prepend=function(e){return d.body.prepend(e),this};var C=function(e,t,o,i){var n={label:t,data:{action:e},click:(i=i||{}).click||y,dataaction:o,purelink:i.purelink,inverse:i.inverse};i.type&&(n[i.type]=!0);var s=$.button(n);return d.buttons.push(s),s.addClass(i.classes).attr({type:"button"})};this.addButton=function(e,t,o,i){return d.footer.prepend(C(e,t,o,i).addClass("btn-default")),this},this.addDangerButton=function(e,t,o,i){return d.footer.prepend(C(e,t,o,i).addClass("btn-danger")),this},this.addSuccessButton=function(e,t,o,i){return d.footer.prepend(C(e,t,o,i).addClass("btn-success")),this},this.addWarningButton=function(e,t,o,i){return d.footer.prepend(C(e,t,o,i).addClass("btn-warning")),this},this.addPrimaryButton=function(e,t,o,i){return d.footer.prepend(C(e,t,o,i).addClass("btn-primary")),this},this.addAlternativeButton=function(e,t,o,i){return d.footer.prepend(C(e,t,o,i).addClass("btn-default").css({float:"left",marginLeft:0})),this},this.addButtonMobile=function(e,t,o,i){return C(e,t,o,i)},this.addCheckbox=function(e,t,o){var i=_.uniqueId("form-control-label-");return d.footer.prepend($('<div class="checkbox">').append($('<div class="controls">'),$("<label>").attr("for",i).text(e).prepend($('<input type="checkbox">').attr({id:i,"data-action":t}).prop("checked",o)))),this},this.close=function(){!r||r.async?b():y("cancel")},this.invoke=function(e){return y(e),this},this.idle=function(){return m(),this},this.busy=function(){return v(),this},this.show=function(e){function t(){d.body.css("max-height",$("#io-ox-core").height()-40-d.header.outerHeight()-d.footer.outerHeight())}r.container.addClass("blockscroll"),r.focus&&(p=$(document.activeElement),document.addEventListener("focus",g,!0)),0===d.header.children().length&&d.header.remove(),r.help&&d.header.addClass("help").append(new i({href:r.help,modal:!0}).render().$el),d.underlay.show().addClass("in"),d.popup.addClass("invisible").show();var o=function(){var e={width:parseInt(r.width||1.1*d.popup.width(),10),height:parseInt(r.height||d.popup.height(),10)};return _(["width","height"]).each(function(t){var o=r[$.camelCase("max-"+t)];r[o]&&e[t]>r[o]&&(e[t]=r[o]);var i=$(document)[t]();e[t]&&e[t]>i&&(e[t]=i)}),e},n=function(){if(d){var e=o();d.popup.css({"max-width":e.width,top:r.top||0});var t=$("#io-ox-core").height()-2*r.top-d.header.outerHeight()-d.footer.outerHeight();d.body.css({height:t,"max-height":t})}},s=o();if(_.device("!smartphone")){var a={"max-width":s.width+"px"};if(r.center){a.top="50%";var l=function(){if(d){var e=d.popup.height(),t=$(window).height();t<d.popup.height()&&(e=t,a.overflow="auto",a.maxHeight="100%"),a.marginTop=0-(e/2>>0)+"px",d.popup.css(a)}};$(window).off("resize.checkTop").on("resize.checkTop",l),l()}else d.popup.css("top",r.top||"0px"),r.maximize&&(n(),$(window).off("resize.maximizedpopup").on("resize.maximizedpopup",n))}return _.device("smartphone")&&(d.popup.addClass("mobile-dialog"),d.footer.rowfluid=$('<div class="row">'),d.footer.append(d.footer.rowfluid),_.each(d.buttons,function(e){d.footer.rowfluid.prepend(e.addClass("btn-medium")),e.wrap('<div class="col-xs-12 col-md-3">')})),this.trigger("beforeshow"),d.popup.removeClass("invisible"),_.device("smartphone")&&(t(),$(window).on("resize.mobile-dialog",t)),_.device("!smartphone")&&(d.popup.find(".btn-primary").first().focus().length||d.popup.find(".btn").not(".btn-danger").first().focus()),d.popup.on("keydown",w),e&&e.call(d.popup,this),x(),this.trigger("show"),c},d.underlay.click(function(){r&&r.underlayAction&&y(r.underlayAction)}),d.popup.click(function(){r&&r.defaultAction&&y(r.defaultAction)}),this.setUnderlayAction=function(e){return r.underlayAction=e,this},this.topmost=function(){return d.underlay.addClass("topmost"),d.popup.addClass("topmost"),this},this.setUnderlayStyle=function(e){return d.underlay.css(e||{}),this},this.setDefaultAction=function(e){return r.defaultAction=e,this}};$(document).on("click",function(e){var t,o=$(e.target);if(0!==(t=o.hasClass("apptitle")?$(".io-ox-sidepopup:not(.preserve-on-appchange)"):$(".io-ox-sidepopup:not(.preserve-on-appchange), .preserve-on-appchange:visible")).length&&!function(e){var t=[".io-ox-dialog-popup",".modal.in",".modal-backdrop.in",".modal-footer",".floating-window",".participant-wrapper.removable",".autocomplete-item",".io-ox-dialog-sidepopup-toggle"].join(", ");return e.closest(t).length>0}(o)){var i=$(e.target).closest(".io-ox-sidepopup"),n=t.index(i);t.slice(n+1).trigger("close")}}),$(document).on("keydown",function(e){27===e.which&&$(".io-ox-sidepopup:not(.preserve-on-appchange), .preserve-on-appchange:visible").last().trigger("close")});return{ModalDialog:r,CreateDialog:function(e){e=$.extend({top:"50px",center:!1},e||{}),r.call(this,e)},SidePopup:function(t){function i(e){var t=e/$("body").width()*100>>0;return Math.max(0,Math.min(100,t))}t=_.extend({modal:!1,arrow:!0,closely:!1,tabTrap:!0,focus:!0},t||{});var s,a,r,d,p,l=null,c=$(),u=$('<div class="io-ox-sidepopup-pane f6-target default-content-padding abs">'),h=_.uniqueId("sidepopup-"),f=$('<div class="io-ox-sidepopup-close">').append($('<a href="#" class="close" data-action="close" role="button">').attr({"aria-label":n("Close"),"aria-controls":h}).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",n("Close")))),g=$('<div class="io-ox-sidepopup abs" role="dialog">').attr("id",h).append($('<div role="document">').append(f,u)),b=!1===t.arrow?$():$('<div class="io-ox-sidepopup-arrow">').append($('<div class="border">'),$('<div class="triangle">')),v=null,m=this,y=u.scrollable();e.extend(this),t.modal&&(p=$('<div class="io-ox-sidepopup-overlay abs">').append(g,b)),t.preserveOnAppchange&&g.addClass("preserve-on-appchange"),this.nodes={},this.lastTrigger=null,r=function(e){a(e)},a=function(){m.nodes.closest&&(t.saveOnClose&&y.find(".settings-detail-pane").trigger("save"),m.nodes.closest.prop("sidepopup",d),g.off("view:remove remove close",r),m.lastTrigger=d=null,l=setTimeout(function(){if(m.nodes.simple.length){var e,o=m.nodes.simple.find(".io-ox-sidepopup");o.length>1?((e=o.eq(-2)).show(),$("body").scrollTop(e.attr("data-scrolltop")||0)):(m.nodes.simple.find("[data-hidden-by-sidepopup]").removeAttr("data-hidden-by-sidepopup").show(),$("body").scrollTop(m.lastSimpleScrollPos||0)),m.nodes.simple=null}t.modal?p.detach():(b.detach(),g.detach()),y.empty(),t.focus&&(c=c.closest(":visible")).focus(),m.trigger("close")},100))},g.on("close",a),g.on("keydown",function(e){9===e.which&&t.tabTrap&&o.trapFocus(this,e)}),f.find(".close").on("click",function(e){return y.trigger("click"),a(e),!1}).on("keydown",function(e){13===e.which&&$(this).trigger("click")}),s=function(e,o){var n,s,u=$(this);if(c=$(document.activeElement),m.nodes={closest:v||u.parents(".io-ox-sidepopup-pane, .window-content, .window-container-center, .io-ox-dialog-popup, .notifications-overlay, body").first(),click:u.parents(".io-ox-sidepopup-pane, .io-ox-dialog-popup, .notifications-overlay, body").first(),target:v||u.parents(".simple-window, .window-container-center, .notifications-overlay, #io-ox-notifications-sidepopup, body").first(),simple:u.closest(".simple-window")},s=m.nodes.closest.prop("sidepopup")||null,m.lastTrigger=s?s.lastTrigger:null,n=u.parents(".io-ox-sidepopup, .window-content, .io-ox-dialog-popup, .window-container-center, .notifications-overlay, body").css("zIndex"),n=parseInt(n,10),n=_.isNumber(n)?n+2:100,m.lastTrigger===this)a(e);else{s&&s.close(),e&&e.stopPropagation(),m.lastTrigger=this,d=s,m.nodes.closest.prop("sidepopup",m),clearTimeout(l),g.on("view:remove remove",r);var h,w,x,C=$("body").width(),k=u.parents(".io-ox-sidepopup").first(),T=0===k.length;/^(left|right)$/.test(t.side)?h=t.side:m.nodes.target.is(".notifications-overlay")?h=k.hasClass("right")?"left":"right":(h=e.pageX>C/2?"left":"right",T&&(t.closely=!0,g.add(b).addClass("first"))),g.add(b).removeClass("left right").addClass(h).css("z-index",n),b.css("zIndex",n+1),t.closely&&_.device("!smartphone")&&("left"===h?(w="",x=Math.min(54,100-i(e.pageX-100))+"%"):(w=Math.min(54,i(e.pageX+100))+"%",x=""),g.add(b).css({left:w,right:x})),m.nodes.simple.length&&(m.lastSimpleScrollPos=$("body").scrollTop(),m.nodes.simple.find(".window-content:visible").attr("data-hidden-by-sidepopup","true").hide(),m.nodes.simple.find(".io-ox-sidepopup:visible").each(function(){$(this).attr("data-scrolltop",$("body").scrollTop()).hide()}),$("body").scrollTop(0)),_.defer(function(){m.nodes.target.append((t.modal?p:g).css("visibility","hidden")),(o||$.noop).call(m,y.empty(),e,u);var i=u.outerHeight(!0)/2>>0,n=m.nodes.target.offset()?m.nodes.target.offset().top:0,s=u.offset().top+i-n;b.css("top",s),(t.modal?p:g).css("visibility",""),t.modal||m.nodes.target.append(b),f.find(".close").focus(),m.trigger("show")})}},this.delegate=function(e,t,o){return $(e).on("click.sidepopup",t,function(e){!0!==(e.originalEvent||e).processed&&s.call(this,e,o)}),$(e).on("keypress.sidepopup",t,function(e){13===e.which&&!0!==(e.originalEvent||e).processed&&(s.call(this,e,o),e.preventDefault())}),this},this.undelegate=function(e){return $(e).off(".sidepopup"),this},this.setTarget=function(e){return v=$(e),this},this.show=function(e,t){return setTimeout(function(){s.call(e.target,e,t)},0),this},this.close=function(e){a(e)},this.destroy=function(){return a(),this.nodes=p=y=f=g=b=null,this}},busy:function(e){e.find("button, input").each(function(e,t){(t=$(t)).prop("disabled")?t.data("disabled",!0):t.prop("disabled",!0)})},idle:function(e){e.find("button, input").each(function(e,t){(t=$(t)).data("disabled")?t.removeData("disabled"):t.prop("disabled",!1)})}}});