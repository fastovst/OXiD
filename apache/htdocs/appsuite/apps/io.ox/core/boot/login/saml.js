define("io.ox/core/boot/login/saml",["io.ox/core/extensions"],function(o){"use strict";function e(o){function e(o){_.defer(function(){window.location.href===o&&window.location.reload()})}o=o||{},_.extend(this,o,{id:"saml_redirect",handle:function(o){var n=o.data.redirect_uri;if(n)if(o.handled=$.Deferred(),/^http/i.test(n))window.location=n,e(n);else{var i="/"===n[0]?"":"/";i+=n,n=window.location.protocol+"//"+window.location.host+i,window.location=n,e(n)}}})}if(ox.serverConfig.samlLogin){o.point("io.ox.saml/relogin").extend(new e),o.point("io.ox.saml/logout").extend(new e),o.point("io.ox.saml/login").extend(new e),ox.off("login:fail:session-based");var n="/saml";ox.serverConfig.samlPath&&(n="/saml/"+ox.serverConfig.samlPath),o.point("io.ox/core/boot/login").extend({id:"saml",after:"autologin",login:function(){return!0===ox.serverConfig.samlLoginErrorPage&&setTimeout(function(){ox.trigger("server:down"),$("body").addClass("down"),$("#io-ox-login-container").empty().append($('<div class="alert alert-info">').append($('<div><b>Connection error</b></div> The service is not available right now. <a href="#">Retry</a>')).on("click",function(o){o.preventDefault(),location.reload()})),$("#background-loader").fadeOut(250),console.warn("Server is down.")},250),$.get(ox.apiRoot+n+"/init?flow=login").then(function(e){var n=new o.Baton({data:e});if(o.point("io.ox.saml/login").invoke("handle",n,n),n.handled&&n.handled.catch)return n.handled.catch(_.noop)},function(o,e,n){ox.serverConfig.samlLoginErrorRedirect&&_.url.redirect(ox.serverConfig.samlLoginErrorRedirectURL+"#&"+_.serialize({language:ox.locale,statusCode:o.status||"undefined",statusText:e,error:n}))})},relogin:function(){return $.get(ox.apiRoot+n+"/init?flow=relogin").then(function(e){var n=new o.Baton({data:e});return o.point("io.ox.saml/relogin").invoke("handle",n,n),$.Deferred()})}});var i=$.Deferred();ox.once("boot:done",i.resolve),i.then(function(){return require(["io.ox/core/capabilities"])}).then(function(e){(e.has("saml-single-logout")||ox.serverConfig.samlSingleLogout)&&o.point("io.ox/core/logout").extend({id:"saml_logout",index:"last",logout:function(){var e=$.Deferred();return $.get(ox.apiRoot+n+"/init?flow=logout&session="+ox.session).done(function(e){var n=new o.Baton({data:e});o.point("io.ox.saml/logout").invoke("handle",n,n)}).fail(e.reject),e}})})}});