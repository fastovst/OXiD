define("io.ox/core/boot/login/openid",["io.ox/core/boot/util","io.ox/core/session","io.ox/core/extensions"],function(e,o,n){"use strict";function i(e){return[ox.apiRoot,ox.serverConfig.oidcPath,"/init?",$.param(e)].join("")}function t(){function e(n){n.origin===ox.abs&&(ox.session=n.data,o.resolve(n.data),window.removeEventListener("message",e))}var o=new $.Deferred;return window.addEventListener("message",e,!1),window.setTimeout(function(){"pending"===o.state()&&o.reject({reason:"timeout",oidc_session_listener:e})},1e4),o}function r(){var e=i({flow:"login",redirect:!1,client:o.client(),version:o.version(),uriFragment:"#login_type=propagateSession"}),n=$("<iframe>").appendTo("body");return $.ajax(e).then(function(e){var o=$.Deferred();return n.one("load",_.debounce(function(){try{0===n[0].contentDocument.body.innerHTML.length&&o.reject({reason:"relogin:failed"})}catch(e){o.reject(e)}},500)),n.attr("src",e.redirect),t().then(o.resolve,o.reject).always(function(){n.remove()}),o})}function s(n){e.debug("Open ID Login ...");var t={flow:(n=_.extend({flow:"login"},n)).flow,redirect:!0,client:o.client(),version:o.version()};return _.isEmpty(location.hash)||(t.uriFragment=location.hash),location.href=i(t),$.Deferred()}return n.point("io.ox/core/logout").extend({id:"OIDC",index:"last",logout:function(){var e=$.Deferred();return!0!==ox.serverConfig.oidcLogin?e.resolve():(location.href=[ox.apiRoot,ox.serverConfig.oidcPath,"/init?",$.param({flow:"logout",redirect:!0,client:o.client(),version:o.version(),deeplink:window.location.href,session:ox.session})].join(""),e)}}),!0===ox.serverConfig.oidcLogin&&(n.point("io.ox/core/relogin").extend({id:"openid_connect_retry",after:"default",render:function(){var e=this;this.off("ok"),this.on("ok",function(){r().then(function(){e.trigger("relogin:success")},function(){e.trigger("relogin:continue")})})}}),n.point("io.ox/core/boot/login").extend({id:"openid_connect",after:"autologin",login:function(){return s({flow:"login"})},relogin:function(e){return r().then(function(){return e.stopPropagation(),e.preventDefault(),e.data.reloginState="success",{reason:"relogin:success"}},function(e){if("timeout"===e.reason){var o=n.point("io.ox/core/relogin"),i=o.extend;o.has("oidc_waitForSessionPropagation")&&(i=o.replace),i.call(o,{id:"oidc_waitForSessionPropagation",index:"200",render:function(){function o(e){e.origin===ox.abs&&(ox.session=e.data,n.trigger("relogin:success"),n.close())}var n=this;window.addEventListener("message",o,!1),_.isFunction(e.oidc_session_listener)&&(window.removeEventListener("message",e.oidc_session_listener),delete e.oidc_session_listener),n.on("close",function(){window.removeEventListener("message",o)})}})}return $.when({reason:"relogin:continue"})})}})),s});