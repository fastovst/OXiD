define("io.ox/core/cache/localstorage",["io.ox/core/extensions"],function(e){"use strict";function t(e,t){try{localStorage.removeItem(e),localStorage.setItem(e,t)}catch(e){"QUOTA_EXCEEDED_ERR"===e.name&&(console.warn("localStorage: Exceeded quota!",e,"Object size",Math.round(t.length/1024)+"Kb"),r.gc())}}function o(e,o){null===l.timer?l.timer=setTimeout(function(){_(l.list).each(function(e){t(e.cid,e.json)}),l={timer:null,list:[]}},c):l.list.push({cid:e,json:o})}function n(e){var n=new RegExp("^"+e.replace(/\./g,"\\.")+"\\.");_.extend(this,{clear:function(){for(var e,t=0,o=localStorage.length,r=[];t<o;t++)n.test(e=localStorage.key(t))&&r.push(e);_(r).each(function(e){localStorage.removeItem(e)});for(e in i)n.test(e)&&delete i[e];return $.when()},get:function(t){var o,n=e+"."+t,r=n in i,a=$.Deferred();return r?(o=JSON.parse(i[n]),a.resolve(o),s[n]=_.now()):setTimeout(function(){var e=localStorage.getItem(n);null!==e?(s[n]=_.now(),o=JSON.parse(i[n]=e),a.resolve(o)):a.resolve(null)},0),a},set:function(n,r){var c=e+"."+n;return r=JSON.stringify(r),i[c]=r,s[c]=_.now(),r.length<=a&&(/app-cache\.index\.savepoints$/.test(c)?t(c,r):o(c,r)),$.Deferred().resolve(n)},remove:function(t){var o=e+"."+t;return delete i[o],localStorage.removeItem(o),$.when()},keys:function(){var t,o,r,a=[];for(t=0,o=localStorage.length;t<o;t++)r=localStorage.key(t),n.test(r)&&a.push(r.substr(e.length+1));for(r in i)n.test(r)&&a.push(r.substr(e.length+1));return $.Deferred().resolve(_(a).uniq())}})}var r,a=1048576,c=5e3,l={timer:null,list:[]},i={},s={},u={};return r={id:"localstorage",index:200,dump:function(){console.debug("fluent",i,"access",s)},getStorageLayerName:function(){return"cache/localstorage"},isUsable:function(){return!window.cordova&&Modernizr.localstorage},gc:function(){var e,t,o=[],n=0,r=0;for(e in s)o.push([e,s[e]]);for(o.sort(function(e,t){return e[1]-t[1]}),t=Math.floor(o.length/3);r<t;r++)localStorage.removeItem(o[r][0]),n++;console.warn("GC. items",o.length,"removed",n),o=null},getInstance:function(){function e(){if(JSON.parse(localStorage.getItem("appsuite-ui")||"{}").version!==ox.version&&"true"!==_.url.hash("keep-data")){!0===ox.debug&&console.warn("LocalStorage: Clearing persistent caches due to UI update");var e=[_(["appsuite.cache",ox.user,ox.locale,"app-cache.index.savepoints"]).compact().join("."),"openpgp-private-keys","appsuite.office-fonts","appsuite.window-handling","appsuite.office-debug"].map(function(e){return{key:e,value:localStorage.getItem(e)}});localStorage.clear(),localStorage.setItem("appsuite-ui",JSON.stringify({version:ox.version})),e&&e.forEach(function(e){try{localStorage.setItem(e.key,e.value)}catch(t){console.warn('cannot restore item "'+e.key+'" in local storage',t)}})}t=!1}var t=!0;return function(o){return t&&e(),u[o]?u[o]:u[o]=new n(o)}}(),clear:function(){i={},u={};var e,t=_.toArray(JSON.parse(localStorage.getItem("file-toc"))),o=_(localStorage).keys();t.push("file-toc"),t.push("appsuite.office-fonts"),t.push("appsuite.window-handling"),t.push("appsuite.office-debug"),e=_.difference(o,t),_(e).each(function(e){localStorage.removeItem(e)})}},e.point("io.ox/core/cache/storage").extend(r),r});