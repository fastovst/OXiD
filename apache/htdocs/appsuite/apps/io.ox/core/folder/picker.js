define("io.ox/core/folder/picker",["io.ox/core/folder/tree","io.ox/mail/api","io.ox/core/folder/api","io.ox/core/tk/dialogs","io.ox/backbone/views/modal","gettext!io.ox/core","io.ox/core/capabilities"],function(e,t,o,n,i,a,l){"use strict";return function(n){function r(e,n){return u.flat?n?o.getDefaultFolder(u.module):e:"virtual/myfolders"===e?o.altnamespace?"default0":"default0"+t.separator+"INBOX":e}var s=_.extend({all:!1,async:!1,addClass:"zero-padding",button:a("Ok"),context:"popup",flat:!1,height:250,indent:!0,module:"mail",persistent:!1,hideTrashfolder:!1,root:"1",open:[],selection:!0,title:a("Select folder"),width:500,always:$.noop,done:$.noop,filter:$.noop,customize:$.noop,disable:function(e){return/^virtual\//.test(e.id)},initialize:$.noop,close:$.noop,show:$.noop,alternative:$.noop,cancel:$.noop,create:$.noop,createFolderButton:!0,realNames:!1},n),d=new i({async:s.async,width:s.width,title:s.title,point:"io.ox/core/folder/picker",help:s.help}).build(function(){this.$el.addClass("folder-picker-dialog "+s.addClass)}).addCancelButton().addButton({action:"ok",label:s.button?s.button:a("Ok")});l.has("guest")&&s.flat||!s.createFolderButton||d.addAlternativeButton({action:"create",label:s.createFolderText||a("Create folder")}),s.alternativeButton&&d.addAlternativeButton({action:"alternative",label:s.alternativeButton}),d.$body.css({height:s.height});var c=s.folder||o.getDefaultFolder(s.module);void 0===c&&s.settings&&_.isString(s.persistent)&&(c=s.settings.get(s.persistent+"/last"));var f=s.settings&&_.isString(s.persistent)?s.settings.get(s.persistent+"/open",[]):[],u=new e({folderBase:s.folderBase,all:s.all,context:s.context,filter:s.filter,flat:!!s.flat,noLinks:!0,indent:s.indent,module:s.module,abs:s.abs,open:["1"].concat(s.open,f),root:s.root,customize:s.customize,disable:s.disable,hideTrashfolder:s.hideTrashfolder,highlight:!0,realNames:n.realNames,highlightclass:_.device("smartphone")?"visible-selection-smartphone":"visible-selection"});return s.settings&&_.isString(s.persistent)&&(u.on("open close",function(){var e=this.getOpenFolders();s.settings.set(s.persistent+"/open",e).save()}),u.on("change",function(e){s.settings.set(s.persistent+"/last",e).save()}),u.on("afterAppear",function(){_.defer(function(){u.$(".tree-container .selectable.selected").focus().trigger("click")})})),s.selection&&(u.on("change virtual",function(e){e=r(e);var t=o.pool.getModel(e),n=t.toJSON();d.$footer.find('.btn-primary[data-action="ok"]').prop("disabled",!!s.disable(n));var i="default0"===n.id&&o.altnamespace;i=this.flat||(i||t.can("create:folder"))&&!t.is("trash"),d.$footer.find('.btn-default[data-action="create"]').prop("disabled",!i)}),d.$footer.find('.btn-primary[data-action="ok"],.btn-default[data-action="create"]').prop("disabled",!0)),s.initialize(d,u),d.inject({renderTree:function(){return(c?o.path(c):$.Deferred().reject()).then(function(e){u.open=_.union(u.open,_(e).pluck("id")),c&&u.preselect(c)},function(){s.settings&&_.isString(s.persistent)&&s.settings.set(s.persistent+"/last",void 0).save()}).always(function(){d.idle(),d.$body.prepend(u.render().$el),s.show(d,u)}),this}}).on("ok",function(){var e=u.selection.get();e&&s.done(e,d,u),s.always(d,u),s.close(d,u)}).on("alternative",function(){s.alternative(d,u)}).on("cancel",s.cancel).on("close",s.close).on("create",function(){var e=u.getNodeView(u.selection.get()||u.root);require(["io.ox/core/folder/actions/add"],function(t){t(r(e.folder,!0),{module:"calendar"===s.module?"event":s.module}).then(function(e){_.delay(function(){u.selection.set(e.id);var t=u.getNodeView(e.folder_id),o=u.getNodeView(e.id);t&&t.toggle(!0),o&&o.$el.focus()},300)})})}).renderTree().open()}});