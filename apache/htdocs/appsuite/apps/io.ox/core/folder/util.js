define("io.ox/core/folder/util",["io.ox/core/api/account","settings!io.ox/mail","settings!io.ox/core","settings!io.ox/calendar"],function(e,r,t,s){"use strict";function i(e,r){return e>>r&(r>=28?1:127)}function n(e){return"calendar"===(e=e||"mail")?s.get("chronos/defaultFolderId"):"mail"===e?r.get("folder/inbox"):t.get("folder/"+e)}function a(e,r){return!!f&&(r=r||[],!(!e||-1!==_(e).indexOf(r))&&(e.id.toString()===n("infostore").toString()||!(!e.folder_id||!f.models[e.folder_id])&&(r.push(e.id),a(f.models[e.folder_id].attributes,r))))}function o(s,i){var n,d,c,u=0,l="";if(!i||!s)return!1;if(_.isArray(i))return _(i).reduce(function(e,r){return e&&o(s,r)},!0);if(s.search(/\|/)>-1){var f=s.split(/\|/);for(d=f.length,n=!1;u<d;u++)if(o(f[u],i)){n=!0;break}return n}switch(s){case"private":return 1===i.type;case"public":return"infostore"!==i.module||2!==i.type||/^(10|14|15)$/.test(i.id)?2===i.type||/^(10|14|15)$/.test(i.id):!a(i);case"shared":return 3===i.type;case"system":return 5===i.type||"system"===i.module;case"trash":return 16===i.type||12===i.standard_folder_type;case"mail":return"mail"===i.module;case"messaging":return"messaging"===i.module;case"calendar":return"calendar"===i.module;case"contacts":return"contacts"===i.module;case"tasks":return"tasks"===i.module;case"infostore":case"files":case"drive":return"infostore"===i.module;case"account":return"system"===i.module&&/^default(\d+)?/.test(String(i.id));case"unifiedfolder":return i&&(l=void 0!==i.id?i.id:i),e.isUnifiedFolder(l);case"external":return/^(default[1-9]|\w+:\/\/)/.test(String(i.id))&&!o("unifiedmail",i);case"defaultfolder":if(e.getType(i.id))return!0;c=r.get("folder");for(l in c)if(c[l]===i.id)return!0;return!1;case"insideDefaultfolder":c=r.get("folder");for(l in c)if(0===i.id.indexOf(c[l]))return!0;return!1;case"published":return!!i["com.openexchange.publish.publicationFlag"];case"subscribed":return!!i["com.openexchange.subscribe.subscriptionFlag"];case"unlocked":case"shared-by-me":var p;if(i.permissions&&i.permissions.length>=1&&(p=_(i.permissions).filter(function(e){if(1===e.bits)return!0})),!i.permissions||i.permissions.length<=1||p.length>0)return;return 1===i.type||7===i.type||"infostore"===i.module&&i.created_by===ox.user_id;case"hidden":var m=t.get(["folder/hidden"],{});return l=_.isObject(i)?i.id:i,!0===m[l];case"attachmentView":var g=t.get("folder/mailattachments",{});return!_.isEmpty(g)&&_.values(g).indexOf(i.id)>-1;default:return!1}}function d(e,r){var t=o("external",e)&&e.virtual_parents[0];return _.isEmpty(r)&&!t?c("remove:folder",e):e.folder_id!==r.id&&(e.id!==r.id&&(3!==e.type&&3!==r.type&&(5!==e.type&&(!o("defaultfolder",e)&&((1!==e.type||1===r.type||1===r.id||7===r.type)&&((2!==e.type||2===r.type||r.id in{2:1,10:1,15:1})&&(e.module===r.module&&!(!c("create:folder",e)||!c("create:folder",r)))))))))}function c(e,r,t){if(_.isArray(r))return _(r).reduce(function(r,s){return r&&c(e,s,t)},!0);var s,n=r.own_rights,a=r.standard_folder||o("system",r),l=1===i(n,28),f="mail"===r.module,p=t?_.firstOf(t.created_by,t.createdBy?t.createdBy.entity:void 0,0):void 0,m=t&&ox.user_id!==p?1:0;switch(e){case"read":return"9"===r.id||i(n,7)>0&&1!==n;case"create":return!o("system",r)&&(!o("subscribed",r)&&(!(f&&!c("read",r))&&i(n,0)>1));case"write":return!o("subscribed",r)&&i(n,14)>m;case"delete":return!o("subscribed",r)&&i(n,21)>m;case"rename":case"rename:folder":return f?1===i(n,30):l&&!a;case"create:folder":return 4==(4&(s=i(n,0)))||64==(64&s);case"delete:folder":case"remove:folder":case"restore:folder":return l&&!a&&!o("defaultfolder",r);case"move:folder":return d(r,t);case"import":return(127&n)>=2&&o("calendar|contacts|tasks",r);case"export":return!o("shared",r)&&o("contacts|calendar|tasks",r);case"empty":return n>>21&127&&o("mail",r);case"changepermissions":case"change:permissions":return l&&!!(1&r.capabilities);case"viewproperties":return!f&&!o("account",r)&&1&r.capabilities;case"publish":return!!u("publication",r)&&("contacts"===r.module||"infostore"===r.module&&c("create",r)&&1!==n&&4!==n);case"subscribe":return!!u("subscription",r)&&(/^(contacts|calendar|infostore)$/.test(r.module)&&c("write",r));case"subscribe:imap":return!!f&&(0!==n&&((!r.standard_folder||!/^(7|9|10|11|12)$/.test(r.standard_folder_type))&&Boolean(r.capabilities&Math.pow(2,4))));case"change:seen":return u("STORE_SEEN",r);case"add:version":return u("file_versions",r);case"sync:cache":return u("cached",r);default:return!1}}function u(e,r){return r instanceof Backbone.Model?_(r.get("supported_capabilities")).indexOf(e)>-1:_(r.supported_capabilities).indexOf(e)>-1}function l(e){e&&e.toggle&&(e.toggle("open",!0),e.options&&l(e.options.parent))}var f;return{registerPool:function(e){f=e},perm:i,bits:function(e,r){return i(_.firstOf(e.own_rights,e,0),r||0)},supports:u,is:o,can:c,getDefaultFolder:n,open:l}});