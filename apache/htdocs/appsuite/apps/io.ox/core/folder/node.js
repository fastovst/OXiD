define("io.ox/core/folder/node",["io.ox/backbone/views/disposable","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/api/account","settings!io.ox/core","settings!io.ox/contacts","gettext!io.ox/core"],function(t,e,i,s,o,n,r){"use strict";var l=t.extend({tagName:"li",className:"folder selectable",indentation:_.device("smartphone")?15:30,events:{"click .folder-options":"onOptions","click .folder-arrow":"onArrowClick","dblclick .folder-label":"onToggle","mousedown .folder-arrow":"onArrowMousedown",keydown:"onKeydown"},addA11yDescription:function(t){this.options.a11yDescription.push(t),this.options.a11yDescription=_.uniq(this.options.a11yDescription),this.renderTooltip()},getA11yDescription:function(){return _.isEmpty(this.options.a11yDescription)?"":". "+this.options.a11yDescription.join(".")},list:function(){var t=this.options;return e.list(t.model_id,{all:t.tree.all})},reset:function(){if(this.isReset)return this.trigger("reset");this.collection.fetched?this.onReset():this.list()},getFilter:function(){var t=this.options,e=t.filter?this:t.tree;return(t.filter||t.tree.filter).bind(e,t.model_id)},onReset:function(){var t=this.options,e=this.collection.filter(this.getFilter()),i={};this.$.subfolders.children().each(function(){i[$(this).attr("data-id")]=$(this).detach().data("view")}),this.$.subfolders.append(e.map(function(t){return(i[t.id]||this.getTreeNode(t).render()).$el},this)),"1"!==this.folder&&"default0"!==this.folder&&this.modelSetSubfolders(e.length>0),this.renderEmpty(),this.$.subfolders.children().each(function(){var e=$(this).data("view");e&&!i[e.folder]&&t.tree.appear(e)}),this.isReset=!0,this.trigger("reset")},onAdd:function(t){if(this.getFilter()(t)){var e=this.getTreeNode(t);this.$.subfolders.append(e.render().$el),this.options.tree.appear(e),this.modelSetSubfolders(!0),this.renderEmpty()}else this.renderEmpty()},onRemove:function(t){this.$.subfolders.children('[data-id="'+$.escape(t.attributes&&t.attributes.id?t.attributes.id:t.id)+'"]').remove(),this.renderEmpty()},onChangeId:function(t){var i=String(t.get("id")),s=String(t.previous("id")),o=this.options.tree.selection.get();this.folder===s&&(this.folder=i),this.options.model_id===s&&(this.options.model_id=i),this.options.contextmenu_id===s&&(this.options.contextmenu_id=i),this.renderAttributes(),s===o&&this.options.tree.trigger("change",i),this.options.open=!1,this.collection&&(this.collection=e.pool.getCollection(i),this.isReset=!1,this.reset()),this.onChangeSubFolders()},onChange:function(t){void 0!==t.changed.title&&this.renderFolderLabel(),void 0!==t.changed.id&&this.onChangeId(t),t.changed.subfolders&&(t.changed.subfolders||(this.open=!1),this.onChangeSubFolders()),this.repaint()},toggle:function(t,e){if(null!==this.options){var i=this.options.open!==t;this.options.open=t,this.onChangeSubFolders(),this.renderCounter(),i&&this.options.tree.trigger(t?"open":"close",this.folder,e)}},onToggle:function(t){t.isDefaultPrevented()||(t.preventDefault(),this.toggle(!this.options.open))},isOpen:function(){return this.options.open&&this.hasSubFolders()},hasArrow:function(){return 0===this.$.arrow.find("i.fa-fw").length},onArrowClick:function(t){$(t.target).closest(this.$.arrow).length&&this.hasArrow()?this.onToggle(t):t.preventDefault()},onArrowMousedown:function(t){$(t.target).closest(this.$.arrow).length&&this.hasArrow()&&t.preventDefault()},onOptions:function(t){t.preventDefault()},hasSubFolders:function(){var t=/^virtual\/flat/.test(this.folder);return this.options.subfolders&&(t||!0===this.modelGetSubfolders())},modelGetSubfolders:function(){return this.model.get(this.options.tree.all?"subfolders":"subscr_subflds")},modelSetSubfolders:function(t){return this.model.set(this.options.tree.all?"subfolders":"subscr_subflds",t)},onChangeSubFolders:function(){var t=this.hasSubFolders(),e=this.isOpen(),i="fa-fw";t&&(i=e?"fa-caret-down":"fa-caret-right"),this.$.arrow.toggleClass("invisible",!t).html($('<i class="fa" aria-hidden="true">').addClass(i)),t&&!this.options.headless?this.$el.attr("aria-expanded",e):this.$el.removeAttr("aria-expanded"),this.$el.toggleClass("open",e),this.renderEmpty(),e&&this.reset()},onKeydown:function(t){if(!t.isDefaultPrevented()&&/^(13|32|37|39)$/.test(t.which)&&(t.preventDefault(),this.hasSubFolders()||!/^(13|32|39)$/.test(t.which))){var e=this.options;/^(13|32)$/.test(t.which)&&this.isVirtual?this.toggle(!e.open):39===t.which?e.open||39!==t.which?this.$el.find("ul.subfolders:first > li:first-child").trigger("click"):this.toggle(!0):37===t.which&&(e.open?this.toggle(!1):e.indent&&e.level>=0&&e.parent.$el.trigger("click"))}},getTreeNode:function(t){var e=t.id||t.attributes.id,i=this.options,s=i.headless||!1===i.indent?i.level:i.level+1,o=i.namespace||0===i.folder.indexOf("virtual/favorites")?"favorite":"",n={folder:e,icons:this.options.icons,iconClass:this.options.iconClass,level:s,tree:i.tree,parent:this,namespace:o};return new l(i.tree.getTreeNodeOptions(n,t))},functions:function(){this.onSort=_.debounce(function(){if(this.$){var t={};this.$.subfolders.children().each(function(){t[$(this).attr("data-id")]=$(this)}),this.$.subfolders.append(this.collection.map(function(e){return t[e.id]}))}},10),this.repaint=_.throttle(function(){null!==this.model&&this.render()},10)},initialize:function(t){this.functions(),this.folder=String(t.folder);var s=this.options=_.extend({arrow:!0,count:void 0,empty:!0,headless:!1,icons:!1,iconClass:void 0,indent:!0,level:0,model_id:this.folder,namespace:"",contextmenu_id:this.folder,open:!1,sortable:!1,subfolders:!0,title:"",a11yDescription:[]},t);this.model=e.pool.getModel(s.model_id),this.noSelect=!this.model.can("read"),this.isVirtual=this.options.virtual||/^virtual/.test(this.folder)||"cal://0/allPublic"===this.folder,this.collection=e.pool.getCollection(s.model_id,s.tree.all),this.isReset=!1,this.realNames=t.tree.realNames,this.id=_.uniqueId(s.tree.id+"-node-"),this.$={},this.$el.data("view",this),_(s.tree.open).contains((s.namespace?s.namespace+":":"")+this.folder)&&(s.open=!0),s.subfolders&&(this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,"change:subscribed":this.onReset,reset:this.onReset,sort:this.onSort}),this.listenTo(e,"create:"+String(s.model_id).replace(/\s/g,"_"),function(){this.open=!0,this.onChangeSubFolders()})),this.listenTo(this.model,{change:this.onChange,"change:subfolders":this.onChangeSubFolders,destroy:this.destroy.bind(this)});var o=0;"visible-selection-smartphone"===s.tree.options.highlightclass&&(o=22),this.$el.attr({id:this.id,"data-id":this.folder,"data-model":s.model_id,"data-contextmenu-id":s.contextmenu_id,"data-namespace":s.namespace,"aria-label":this.getTitle()}).append(this.$.selectable=$('<div class="folder-node" aria-hidden="true">').css("padding-left",s.level*this.indentation+o).append(this.$.arrow=s.arrow?$('<div class="folder-arrow invisible"><i class="fa fa-fw" aria-hidden="true"></i></div>'):[],this.$.icon=$('<div class="folder-icon"><i class="fa fa-fw" aria-hidden="true"></i></div>'),$('<div class="folder-label">').append(this.$.label=$('<div role="presentation">').text(this.getTitle())),this.$.counter=$('<div class="folder-counter">'),this.$.buttons=$('<div class="folder-buttons">')),this.$.subfolders=$('<ul class="subfolders" role="group">')),s.headless?(this.$el.removeClass("selectable"),this.$.selectable.remove(),this.$.subfolders.attr("role","presentation")):this.$el.attr({"aria-selected":!1,role:"treeitem",tabindex:"-1"}),s.sortable&&this.$el.attr("data-sortable",!0),this.noSelect&&s.level>0&&this.$el.addClass("no-select"),this.isVirtual&&this.$el.addClass("virtual"),(!this.isVirtual||s.contextmenu)&&s.tree.options.contextmenu&&s.tree.app&&this.renderContextControl(),this.isVirtual||e.get(s.model_id),(!1===s.empty&&!1===s.open||this.isVirtual)&&this.reset();var n=this.model.toJSON(),r=i.Baton({view:this,data:n});i.point("io.ox/core/foldertree/node").invoke("initialize",this.$el,r),s.tree.options.customize.call(this.$el,r),s.tree.options.disable(n,s)&&this.$el.addClass("disabled"),this.$el.on("dispose",this.remove.bind(this))},getCounter:function(){var t=0;return!this.options.open&&this.options.subfolders&&this.model.get("subtotal")&&(t=this.model.get("subtotal")),void 0!==this.options.count?this.options.count:(this.model.get("unread")||0)+t},showStatusIcon:function(t,e,i){var s=this;this.$.accountLink?t&&this.$.accountLink.attr("title",t):(this.$.selectable.append(this.$.accountLink=$('<a href="#" class="account-link">').attr("data-id",this.options.model_id).append('<i class="fa fa-exclamation-triangle">')),this.$.accountLink.on("click",function(t){t.preventDefault(),s.options.tree.trigger(e,i)}),t&&this.$.accountLink.attr("title",t))},hideStatusIcon:function(){this.$.accountLink&&(this.$.accountLink.remove(),this.$.accountLink=null)},renderCounter:function(){var t=this.getCounter();this.$.selectable.toggleClass("show-counter",t>0),t>999&&(t="999+"),this.$.counter.text(0===t?"":t)},getTitle:function(){var t=this.model.get("display_title")||this.options.title||this.model.get("title")||"";return!0===this.realNames?this.model.get("folder_name")||t:t},renderTooltip:function(){if(!this.options.title&&this.model.has("title")){var t=[],i=[];if(this.model.supports("count_total")){var o=this.model.toJSON();s.isUnifiedRoot(this.model.get("id"))&&(o=_.pick(o,"title")),_.isNumber(o.total)&&o.total>=0&&(e.is("contacts",o)&&"6"===o.id&&!n.get("showAdmin",!1)&&(o.total=o.total-1),t.push(r("Total: %1$d",o.total)),o.total>0&&i.push(r("%1$d total",o.total))),_.isNumber(o.unread)&&o.unread>=0&&(t.push(r("Unread: %1$d",o.unread)),o.unread>0&&i.push(r("%1$d unread",o.unread))),t=t.join(", "),i=i.reverse().join(", "),t&&(t=" ("+t+")"),i&&(i=", "+i+". "+r("Right click for more options."))}this.$el.attr("aria-label",this.getTitle()+i+this.getA11yDescription()),this.$.selectable.attr("title",this.getTitle()+t)}},renderContextControl:function(){if(_.device("smartphone"))return this.$el.attr("data-contextmenu",this.options.contextmenu||"default");var t=this.getTitle();this.$el.attr("aria-haspopup",!0),this.$.selectable.append($('<a tabindex="-1" href="#" role="button" class="folder-options contextmenu-control" data-toggle="dropdown">').attr({"data-contextmenu":this.options.contextmenu||"default",title:t?r("Actions for %1$s",t):r("Folder-specific actions")}).append($('<i class="fa fa-bars" aria-hidden="true">')))},renderFolderLabel:function(){this.$.label.text(this.getTitle())},renderAttributes:function(){this.$el.attr({"data-id":this.folder,"data-model":this.options.model_id,"data-contextmenu-id":this.options.contextmenu_id,"data-favorite":this.options.inFavorites})},isEmpty:function(){return 0===this.$.subfolders.children().length},renderEmpty:function(){!1===this.options.empty&&(this.$el.toggleClass("empty",this.isEmpty()),"virtual/favorites/infostore"===this.model.get("id")&&this.$el.toggleClass("show-anyway",!!this.collection.length))},renderIcon:function(){var t,i,n,r,l=this.options,a=l.iconClass;if(("infostore"===l.tree.module||l.icons)&&/^(mail|infostore|notes)$/.test(l.tree.module)){if("mail"===l.tree.module)return t=s.getType(this.folder)||"default",void this.$.icon.addClass("visible "+t);if(a)a="visible "+a;else{switch(i=String(e.getDefaultFolder("infostore")),n=o.get("folder/mailattachments",{}),r=String(n.all),this.folder){case"virtual/myshares":a="visible myshares";break;case"virtual/favorites/infostore":a="visible myfavorites";break;case r:a="visible attachments";break;case i:a="visible myfiles"}!a&&e.is("trash",this.model.attributes)&&this.model.get("standard_folder")&&(a="visible trash")}this.$.icon.addClass(a)}},render:function(){if(this.renderAttributes(),this.renderEmpty(),this.renderTooltip(),this.renderCounter(),this.renderIcon(),this.onChangeSubFolders(),this.model)return i.point("io.ox/core/foldertree/node").invoke("draw",this.$el,i.Baton({view:this,data:this.model.toJSON()})),this},destroy:function(){var t=this.options.parent;this.$el.remove(),t.renderEmpty&&t.renderEmpty()},remove:function(){this.stopListening(),this.collection=this.model=this.options=this.$=null}});return l});