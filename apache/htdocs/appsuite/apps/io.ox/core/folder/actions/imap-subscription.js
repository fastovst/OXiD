define("io.ox/core/folder/actions/imap-subscription",["io.ox/core/folder/api","io.ox/core/folder/picker","io.ox/core/http","gettext!io.ox/core"],function(e,o,t,i){"use strict";return function(){function c(e,o){o!==s[e]?u[e]=o:delete u[e]}function r(e,o){var t=e.find('ul input[type="checkbox"]');t.prop("disabled",!o),o||t.filter(":checked").each(function(e,o){$(o).prop("checked",!1)})}function n(){var e=$(this),o=e.prop("checked");r(e.closest(".folder"),o),c(e.val(),o)}function l(e){if(32===e.which&&!e.isDefaultPrevented()){e.preventDefault();var o=$(this).find("input:checkbox").first(),t=o.prop("checked");o.prop("disabled")||o.prop("checked",!t)}}function a(o){var t=o.get("id");if(o.get("subscr_subflds")){var i=e.pool.getCollection(t,!0).models,c=_.filter(i,function(e){return e.get("subscribed")});return _.map(c,function(e){return e.get("id")})}}var s={},u={};_(e.pool.collections).each(function(o,t){0===t.indexOf("all/")&&delete e.pool.collections[t]}),o({async:!0,all:!0,addClass:"zero-padding subscribe-imap-folder",button:i("Save"),context:"subscribe",height:300,module:"mail",selection:!1,title:i("Subscribe to IMAP folders"),help:"ox.appsuite.user.sect.dataorganisation.sharing.subscribe.html",createFolderButton:!1,always:function(o){t.pause();for(var i=Object.keys(u),c=0;c<i.length;c++){var r=i[c];if(!u[r]){var n=e.pool.getModel(r);_.each(a(n),function(e){u[e]=!1,i.push(e)})}}var l=_(u).map(function(o,t){return e.update(t,{subscribed:o},{silent:!0}),e.pool.getModel(t).get("folder_id")});_(l).chain().uniq().each(function(o){e.list(o,{cache:!1})}),t.resume().done(function(){e.virtual.refresh(),o.close()})},customize:function(o){var t=o.data,i=/^virtual/.test(t.id)||"default0/virtual"===t.id||!e.can("read",t)||!e.can("subscribe:imap",t);s[t.id]=t.subscribed;var c=_.uniqueId("form-control-label-");this.find(".folder-label").before($('<label class="folder-checkbox">').attr("for",c).append($('<input type="checkbox">').attr("id",c).prop({checked:t.subscribed,disabled:i}).on("change",n).val(t.id))),this.on("keypress",l)},close:function(){s=u=null}})}});