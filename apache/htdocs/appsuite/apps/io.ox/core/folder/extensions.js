define("io.ox/core/folder/extensions",["io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/api/account","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/upsell","io.ox/contacts/util","io.ox/core/api/user","io.ox/mail/api","gettext!io.ox/core","io.ox/backbone/mini-views/upsell","io.ox/backbone/mini-views/dropdown","io.ox/core/folder/blacklist","settings!io.ox/core","settings!io.ox/mail","io.ox/core/http","io.ox/core/folder/favorites","io.ox/files/favorites"],function(e,t,r,o,i,n,a,d,l,s,c,u,f,p,h,x){"use strict";function v(){var e=p.get("folder/infostore");return e?t.get(e):null}function m(){if(!i.has("guest")&&i.has("gab || share_links"))return $.when({id:"virtual/myshares",folder_id:"9",module:"infostore",own_rights:403710016,permissions:[{bits:403710016,entity:ox.user_id,group:!1}],standard_folder:!0,supported_capabilities:[],title:s("My shares")})}function b(){var e=P.all;return e?t.get(e):null}function g(e){e.preventDefault(),ox.launch("io.ox/files/main",{folder:P.all}).done(function(){this.folder.set(P.all)})}function w(){return t.list("9").then(function(e){return _(e).filter(function(e){return t.is("trash",e)})})}function k(e){e.preventDefault(),require(["io.ox/mail/accounts/settings"],function(t){t.mailAutoconfigDialog(e)})}function y(e){e.preventDefault(),require(["io.ox/core/settings/user"],function(e){e.openModalDialog()})}function F(){var e=["google","dropbox","boxcom","graph"];return o.point("io.ox/core/folder/storage-accounts/list").invoke("customize",e),require(["io.ox/core/api/filestorage"]).then(function(e){var t=e.rampup().then(function(){return _(e.isStorageAvailable()).map(function(e){return e.match(/\w*?$/)[0]})});return $.when(require(["io.ox/keychain/api"]),t)}).then(function(t,r){return _(t.submodules).filter(function(t){return!(e.indexOf(t.id)<0)&&((!t.canAdd||t.canAdd.apply(this))&&r.indexOf(t.id)>=0)})})}function S(e){e.preventDefault(),require(["io.ox/files/actions/add-storage-account"],function(e){e()})}function A(e){if(e.preventDefault(),i.has("subscription"))"calendar"===e.data.baton.module?require(["io.ox/calendar/actions/subscribe-calendar"],function(t){t(e.data.baton)}):require(["io.ox/core/sub/subscriptions"],function(t){t.buildSubscribeDialog({module:e.data.baton.module,app:e.data.baton.view.app})});else{if(!n.enabled(["subscription"]))return;n.trigger({type:"inline-action",id:"io.ox/core/foldertree/contextmenu/default/subscribe",missing:n.missing(["subscription"])})}}function C(e){e.preventDefault(),ox.load(["io.ox/core/folder/actions/add"]).done(function(t){t(e.data.folder,{module:e.data.module})})}function D(e){require(["io.ox/files/share/permissions"],function(t){t.showFolderPermissions(e.data.id)})}function q(e){var t={id:"io.ox/core/sub",data:e.data.folder,refresh:!0};ox.launch("io.ox/settings/main",t).done(function(){this.setSettingsPane(t)})}function M(e){if("keydown"===e.type){if(32!==e.which)return;e.stopImmediatePropagation()}var t=e.data.target,r=e.data.app,o=e.data.folder;t.closest(".single-selection").length>0||(e.preventDefault(),r.folders.isSelected(o.id)?r.folders.remove(o.id):r.folders.add(o.id),t.toggleClass("selected",r.folders.isSelected(o.id)),t.closest(".folder").attr("aria-checked",r.folders.isSelected(o.id)))}var N="default0"+l.separator+"INBOX";i.has("webmail")&&(t.virtual.add("virtual/standard",function(){var e=h.get("defaultFolder")||{},r=[],o={};return x.pause(),r.push(t.get(N)),o[N]=!0,h.get("features/unseenFolder",!1)&&r.push(t.get("virtual/all-unseen")),["drafts","sent","spam","trash","archive"].forEach(function(n){var a=e[n];a&&!o[a]&&("archive"!==n||i.has("archive_emails"))&&(r.push(t.get(a)),o[a]=!0)}),x.resume(),this.concat.apply(this,r)}),t.virtual.add("virtual/myfolders",function(){var e=t.altnamespace?"default0":N;return t.list(e).then(function(e){return _(e).filter(function(e){return 0!==e.id.indexOf("default0/External accounts")&&(!r.isStandardFolder(e.id)&&!t.is("public|shared",e))})})}),t.on("after:rename",function(e,r){r.folder_id===N&&t.virtual.reload("virtual/myfolders")}),t.virtual.add("virtual/remote",function(){return t.list("1").then(function(e){return _(e).filter(function(e){return r.isExternal(e.id)})})})),i.has("filestore")&&t.virtual.add("virtual/filestorage",function(){return t.list("1").then(function(e){return _(e).filter(function(e){return t.isExternalFileStorage(e)})})});var P=p.get("folder/mailattachments",{});P.all&&f.add(P.all),i.has("infostore")&&(t.virtual.add("virtual/drive/private",function(){return this.concat(v(),m(),b(),w())}),t.virtual.add("virtual/drive/private-without-myshares",function(){return this.concat(v(),b(),w())}),t.virtual.add("virtual/drive/public",function(){return t.list("9").then(function(e){return _(e).filter(function(e){return String(e.id)!==String(p.get("folder/infostore"))&&(!t.is("trash",e)&&!t.isExternalFileStorage(e))})})}));var E={unifiedFolders:function(t){this.append(new e({empty:!1,filter:function(e,t){return/^default/.test(t.id)&&r.isUnified(t.id)},folder:"1",headless:!0,open:!0,tree:t,parent:t}).render().$el.addClass("unified-folders"))},standardFolders:function(t){var o=new e({filter:function(e,t){return!("virtual/all-unseen"!==t.id||!h.get("unseenMessagesFolder"))||r.isStandardFolder(t.id)},folder:"virtual/standard",headless:!0,open:!0,tree:t,parent:t});this.append(o.render().$el.addClass("standard-folders").attr("role","presentation")),o.listenTo(h,"change:unseenMessagesFolder",function(){o.onReset()})},getLocalFolderName:function(){return h.get("features/usePrimaryAccountNameInTree",!0)?r.getPrimaryName()||s("My folders"):s("My folders")},localFolders:function(o){if(!i.has("guest")){var n=t.altnamespace?"default0":N,a=new e({contextmenu:"myfolders",empty:!!t.altnamespace,folder:"virtual/myfolders",icons:o.options.icons,contextmenu_id:n,parent:o,title:E.getLocalFolderName(),tree:o});r.on("update",function(e,t){0===t.id&&(a.options.title=E.getLocalFolderName(),a.renderFolderLabel())}),t.on("create:"+n,function(){a.toggle(!0)}),this.append(a.render().$el)}},remoteAccounts:function(t){this.append(new e({folder:"virtual/remote",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t,isRemote:!0,empty:!1}).render().$el.addClass("remote-folders").attr("role","presentation"))},fileStorageAccounts:function(t){this.append(new e({folder:"virtual/filestorage",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("filestorage-folders").attr("role","presentation"))},addStorageAccount:function(){function e(){F().done(function(e){e.length>0?t.empty().show().append($('<a href="#" data-action="add-storage-account" role="treeitem">').text(s("Add storage account")).on("click",S)):t.hide()})}var t=$('<li class="links" role="presentation">');return function(){this.append(t),require(["io.ox/core/api/filestorage"],function(t){t.off("create delete update",e),t.on("create delete update",e),e()})}}(),subscribe:function(e){if(!e.extension.capabilities||n.visible(e.extension.capabilities)){var t,r=this;require(["io.ox/core/sub/subscriptions"],function(o){"contacts"===e.module&&o.availableServices.contacts&&(t=s("Subscribe to address book"),r.append($('<li role="presentation">').append($('<a href="#" data-action="subscribe-external-account" role="treeitem">').text(t).on("click",{baton:e},A))))})}},treeLinks:function(){if(0!==o.point("io.ox/core/foldertree/mail/treelinks").list().length){var e=$('<ul class="list-unstyled" role="group">');o.point("io.ox/core/foldertree/mail/treelinks").invoke("draw",e),this.append($('<li class="links list-unstyled" role="treeitem">').append(e))}},allAttachments:function(){P.all&&this.append($('<li role="presentation">').append($('<a href="#" data-action="all-attachments" role="treeitem">').text(s("View all attachments")).on("click",g)))},addRemoteAccount:function(){i.has("multiple_mail_accounts")&&this.append($('<li role="presentation">').append($('<a href="#" data-action="add-mail-account" role="treeitem">').text(s("Add mail account")).on("click",k)))},synchronizeAccount:function(){this.append(new c({id:"folderview/mail",className:"links",requires:"active_sync",title:s("Synchronize with your tablet or smartphone")}).render().$el)},otherFolders:function(o){this.append(new e({empty:!1,filter:function(e,o){return!r.isStandardFolder(o.id)&&("default0/virtual"!==o.id&&(!t.altnamespace||t.is("public|shared",o.toJSON())))},folder:"default0",headless:!0,open:!0,icons:o.options.icons,tree:o,parent:o}).render().$el.addClass("other-folders").attr("role","treeitem"))},myContactData:function(){!1!==p.get("user/internalUserEdit",!0)&&this.append($('<li role="presentation">').append($('<a href="#" data-action="my-contact-data" role="treeitem">').text(s("My contact data")).on("click",y)))},rootFolders:function(r){var o={folder:r.root,headless:!0,open:!0,tree:r,parent:r};if(r.options.hideTrashfolder&&(o.filter=function(e,r){return!t.is("trash",r.attributes)}),"infostore"===r.module){var i=o.filter;o.filter=function(e,r){return(!i||i.apply(this,arguments))&&!t.isExternalFileStorage(r)}}this.append(new e(o).render().$el.addClass("root-folders"))},privateDriveFolders:function(t){this.append(new e({folder:"virtual/drive/private",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("private-drive-folders").attr("role","presentation"))},privateDriveFoldersWithoutMyShares:function(t){this.append(new e({folder:"virtual/drive/private-without-myshares",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("private-drive-folders").attr("role","presentation"))},publicDriveFolders:function(t){this.append(new e({folder:"virtual/drive/public",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("public-drive-folders").attr("role","presentation"))}},L=100;return o.point("io.ox/core/foldertree/mail/app").extend({id:"unified-folders",index:L+=100,draw:E.unifiedFolders},{id:"standard-folders",index:L+=100,draw:E.standardFolders},{id:"local-folders",index:L+=100,draw:E.localFolders},{id:"other",index:L+=100,draw:E.otherFolders},{id:"remote-accounts",index:L+=100,draw:E.remoteAccounts},{id:"tree-links",index:L+=100,draw:E.treeLinks},{id:"upsell-mail",index:L+=100,draw:E.synchronizeAccount}),o.point("io.ox/core/foldertree/mail/treelinks").extend({id:"all-attachments",index:L+=100,draw:E.allAttachments},{id:"add-account",index:L+=100,draw:E.addRemoteAccount}),o.point("io.ox/core/foldertree/mail/popup").extend({id:"standard-folders",draw:E.standardFolders},{id:"local-folders",draw:E.localFolders},{id:"other",draw:E.otherFolders},{id:"remote-accounts",draw:E.remoteAccounts}),o.point("io.ox/core/foldertree/mail/subscribe").extend({id:"root-folders",draw:E.rootFolders}),o.point("io.ox/core/foldertree/mail/account").extend({id:"root-folders",draw:E.rootFolders}),o.point("io.ox/core/foldertree/mail/filter").extend({id:"standard-folders",draw:E.standardFolders},{id:"local-folders",draw:E.localFolders},{id:"other",draw:E.otherFolders}),o.point("io.ox/core/foldertree/infostore/app").extend({id:"private-folders",index:100,draw:E.privateDriveFolders},{id:"public-folders",index:200,draw:E.publicDriveFolders},{id:"remote-accounts",index:300,draw:E.fileStorageAccounts},{id:"add-external-account",index:400,draw:E.addStorageAccount}),o.point("io.ox/core/foldertree/infostore/popup").extend({id:"private-folders",index:100,draw:E.privateDriveFoldersWithoutMyShares},{id:"public-folders",index:200,draw:E.publicDriveFolders},{id:"remote-accounts",index:300,draw:E.fileStorageAccounts}),o.point("io.ox/core/foldertree/contacts/links").extend({id:"subscribe",index:300,capabilities:["subscription"],draw:E.subscribe},{id:"my-contact-data",index:400,draw:E.myContactData}),_("contacts calendar tasks".split(" ")).each(function(r){function i(e,t){return n[e][t]}var n={contacts:{private:s("My address books"),public:s("Public address books"),shared:s("Shared address books"),hidden:s("Hidden address books")},calendar:{private:s("My calendars"),public:s("Public calendars"),shared:s("Shared calendars"),hidden:s("Hidden calendars")},tasks:{private:s("My tasks"),public:s("Public tasks"),shared:s("Shared tasks"),hidden:s("Hidden tasks")}},a={id:"standard-folders",index:100,draw:function(n){var a,d,l="calendar"===r?"event":r,s=$('<ul class="list-unstyled" role="group">'),c=o.Baton({module:r,view:n,context:n.context}),u="virtual/flat/"+l,f="flat/"+l,p={count:0,empty:!1,indent:!1,open:!1,tree:n,parent:n,filter:function(e,t){return!!t.get("subscribed")}},h=$('<li role="treeitem">');n.options.noLinks||o.point("io.ox/core/foldertree/"+r+"/links").invoke("draw",s,c),this.append(h),t.flat({module:l,all:"event"===l}).always(function(){a=new e(_.extend({},p,{folder:u+"/private",model_id:f+"/private",title:i(r,"private"),filter:function(e,t){return!!t.get("subscribed")}})),t.pool.getCollection("flat/"+l+"/private").on("add",function(){a.toggle(!0)}),t.pool.getCollection("flat/"+l+"/public").on("add",function(){a.toggle(!0)}),d=new e(_.extend({},p,{folder:u+"/public",model_id:f+"/public",title:i(r,"public")})),h.replaceWith(a.render().$el.addClass("section"),$('<li class="links list-unstyled" role="treeitem">').append(s),d.render().$el.addClass("section"),new e(_.extend({},p,{folder:u+"/shared",model_id:f+"/shared",title:i(r,"shared")})).render().$el.addClass("section"),new e(_.extend({},p,{folder:u+"/hidden",model_id:f+"/hidden",title:i(r,"hidden")})).render().$el.addClass("section"))})}};o.point("io.ox/core/foldertree/"+r+"/app").extend(_.extend({},a)),o.point("io.ox/core/foldertree/"+r+"/popup").extend(_.extend({},a)),"calendar"!==r&&o.point("io.ox/core/foldertree/"+r+"/links").extend({index:200,id:"private",draw:function(e){if("app"===e.context){var r=e.module,o=t.getDefaultFolder(r),i=s("Add new folder");"contacts"===r&&(i=s("Add new address book")),o&&this.append($('<li role="presentation">').append($('<a href="#" data-action="add-subfolder" role="treeitem">').text(i).on("click",{folder:o,module:r},C)))}}})}),o.point("io.ox/core/foldertree/calendar/links/subscribe").extend({id:"default",index:100,draw:function(){var e=t.getDefaultFolder("calendar");e&&this.link("folder",s("Personal calendar"),function(t){t.data={folder:e,module:"event"},C(t)})}},{id:"divider-1",index:200,draw:function(){(i.has("calendar_schedjoules")||i.has("calendar_google")||i.has("calendar_ical"))&&(this.divider(),this.header(s("Subscribe to calendar")))}},{id:"schedjoules",index:300,draw:function(){i.has("calendar_schedjoules")&&this.link("schedjoules",s("Browse calendars of interest"),function(){require(["io.ox/calendar/settings/schedjoules/schedjoules"],function(e){e.open()})})}},{id:"google",index:400,draw:function(){if(i.has("calendar_google")){var e,t;require(["io.ox/calendar/actions/subscribe-google"],function(r){e=r,t.removeClass("hidden")}),this.link("google",s("Google calendar"),function(){e()}),t=this.$ul.find("li").last().addClass("hidden")}}},{id:"ical",index:500,draw:function(){i.has("calendar_ical")&&this.link("ical",s("Subscribe via URL (iCal)"),function(){require(["io.ox/calendar/actions/subscribe-ical"],function(e){e()})})}},{id:"shared",index:500,draw:function(){this.link("shared",s("Subscribe shared Calendar"),function(){require(["io.ox/calendar/actions/subscribe-shared"],function(e){e.open()})})}},{id:"import",index:600,draw:function(){_.device("ios || android")||(this.divider(),this.header(s("Import calendar")),this.link("import",s("Upload file"),function(){require(["io.ox/core/import/import"],function(e){e.show("calendar")})}))}}),o.point("io.ox/core/foldertree/calendar/links").extend({index:200,id:"private",draw:function(e){if("app"===e.context&&!i.has("guest")){var t=new u({attributes:{role:"presentation"},tagName:"li",className:"dropdown",$toggle:$('<a href="#" data-action="add-subfolder" data-toggle="dropdown">').append(s("Add new calendar"),$('<i class="fa fa-caret-down" aria-hidden="true">'))});o.point("io.ox/core/foldertree/calendar/links/subscribe").invoke("draw",t),0!==t.$ul.children().length&&(this.append(t.render().$el),t.$toggle.attr("role","treeitem"))}}}),o.point("io.ox/core/foldertree/contacts/links").extend({index:1e3,id:"upsell-contacts",draw:function(e){"app"===e.context&&this.append(new c({id:"folderview/contacts",requires:"carddav",title:s("Synchronize with your tablet or smartphone")}).render().$el)}}),o.point("io.ox/core/foldertree/calendar/links").extend({index:1e3,id:"upsell-calendar",draw:function(e){"app"===e.context&&this.append(new c({id:"folderview/calendar",requires:"caldav",title:s("Synchronize with your tablet or smartphone")}).render().$el)}}),o.point("io.ox/core/foldertree/node").extend({id:"shared-by",index:100,draw:function(e){var r=e.view.model.toJSON();/^(contacts|calendar|tasks)$/.test(r.module)&&t.is("shared",r)&&e.view.addA11yDescription(s("Shared by other users"))}},{id:"shared",index:200,draw:function(e){this.find(".folder-node:first .folder-shared:first").remove(),_.device("smartphone")||"infostore"!==e.data.module&&t.is("unlocked",e.data)&&(e.view.$.buttons.append($('<i class="fa folder-shared" aria-hidden="true">').attr("title",s("You share this folder with other users")).on("click",{id:e.data.id},D)),e.view.addA11yDescription(s("You share this folder with other users")))}},{id:"sub",index:300,draw:function(e){t.isVirtual(e.view.folder)||this.find(".folder-sub:first").remove(),t.is("shared",e.data)||t.is("subscribed",e.data)&&(e.view.$.buttons.append($('<i class="fa folder-sub">').attr("title",s("This folder has subscriptions")).on("click",{folder:e.data},q)),e.view.addA11yDescription(s("This folder has subscriptions")))}},{id:"is-selected",index:400,draw:function(e){if(/^calendar$/.test(e.data.module)){var t=this,r=this.find(".folder-label"),o=ox.ui.apps.get("io.ox/calendar");o&&(this.attr("aria-checked",o.folders.isSelected(e.data.id)),require(["io.ox/calendar/util"],function(i){var n=i.getFolderColor(e.data),a=r.find(".color-label"),d=i.getColorName(n);d&&e.view.addA11yDescription(s("Category")+": "+d),0===a.length&&(a=$('<div class="color-label" aria-hidden="true">')),a.toggleClass("selected",o.folders.isSelected(e.data.id)),a.css({"background-color":n,color:i.getForegroundColor(n)}),a.off("click",M).on("click",{folder:e.data,app:o,target:a},M),t.off("keydown",M).on("keydown",{folder:e.data,app:o,target:a},M),r.prepend(a)}))}}},{id:"account-errors",index:500,draw:function(e){if(/^calendar$/.test(e.data.module)){var t=e.data["com.openexchange.calendar.accountError"];t?(e.view.showStatusIcon(t.error,"click:account-error",e.data),ox.trigger("http:error:"+t.code,t)):e.view.hideStatusIcon()}}}),E});