define("io.ox/core/folder/selection",[],function(){"use strict";function e(e){this.view=e,this.view.$el.on("click contextmenu",".selectable",$.proxy(this.onClick,this)).on("keydown",".selectable",$.proxy(this.onKeydown,this)).on("mousedown contextmenu",".selectable",function(e){e.preventDefault()}),e.options.dblclick&&this.view.$el.on("dblclick",$.proxy(this.onDblClick,this)),this.view.$el.addClass("dropzone").attr("data-dropzones",".selectable").on("drop",function(t,i){i&&(i.dropType=e.module,e.selection.trigger("selection:drop",i))}),this.selectableVirtualFolders={},this.unselectableFolders={}}return _.extend(e.prototype,{byId:function(e,t,i){var s=(t=t||this.getItems()).filter('[data-id="'+$.escape(e)+'"]'),n=s.first();return 1!==s.length&&s.each(function(){i&&$(this).parentsUntil(".tree-container",".folder.favorites").length?n=$(this):i||$(this).parentsUntil(".tree-container",".folder.favorites").length||(n=$(this))}),n},get:function(e){return this.view.$el.find(".selectable.selected").attr(e||"data-id")},set:function(e,t){var i=this.getItems(),s=this.byId(e,i,t),n=i.index(s);-1!==n&&this.get()!==e&&(this.uncheck(i),this.pick(n,i,{focus:!1}))},preselect:function(e){var t=this.check(this.byId(e));return t.length>0&&(this.view.$container.attr("aria-activedescendant",t.attr("id")),!0)},scrollIntoView:function(e){var t=this.byId(e);t.length&&(t[0].scrollIntoView(!0),this.view.trigger("scrollIntoView",e))},onClick:function(e){if(!$(e.target).is(":checkbox")&&!e.isDefaultPrevented()&&(e.preventDefault(),(!this.view.app||!this.view.app.props||!0!==this.view.app.props.get("mobileFolderSelectMode")||$(e.target).parent().hasClass("folder-label"))&&("contextmenu"===e.type&&e.stopPropagation(),"contextmenu"!==e.type||0!==e.which))){var t=this.getItems(),i=$(e.currentTarget),s=t.index(i)||0;this.view.trigger("selection:action",t,s),this.view.app&&"io.ox/files"===this.view.app.get("name")&&"9"===this.view.app.folder.get()&&i.removeClass("selected"),i.hasClass("selected")||(this.resetTabIndex(t,t.eq(s)),this.uncheck(t),this.pick(s,t))}},onDblClick:function(e){if(!($(e.target).is(":checkbox")||$(e.target).closest(".contextmenu-control").length>0)){var t=$(e.target).closest(".folder").attr("data-id");this.triggerEvent("dblclick",e,t)}},onKeydown:function(e){if(/38|40/.test(e.which))return $(e.target).hasClass("contextmenu-control")?e.preventDefault():void($(e.target).hasClass("selectable")&&this.onCursorUpDown(e))},onCursorUpDown:function(e){var t=this.getItems().filter(":visible"),i=$(document.activeElement),s=38===e.which,n=(t.index(i)||0)+(s?-1:1);if(!(n>=t.length||n<0||e.isDefaultPrevented())){if(e.preventDefault(),this.view.trigger("selection:action",t,n),e.altKey&&"true"===i.parent().parent().attr("data-sortable"))return this.move(i,s);this.resetTabIndex(t,t.eq(n)),this.uncheck(t),this.pick(n,t)}},move:function(e,t){t?e.insertBefore(e.prev()):e.insertAfter(e.next()),e.focus();var i=e.parent().parent().attr("data-id"),s=_(e.parent().children(".selectable")).map(function(e){return $(e).attr("data-id")});this.view.trigger("sort sort:"+i,s)},pick:function(e,t,i){var s=_.extend({focus:!0},i).focus?this.focus(e,t):(t||this.getItems()).eq(e);this.check(s),this.view.$container.attr("aria-activedescendant",s.attr("id")),this.triggerEvent("change",t)},resetTabIndex:function(e,t){(e=e.filter('[tabindex="0"]')).not(t).attr("tabindex",-1)},focus:function(e,t){var i=(t=t||this.getItems()).eq(e).attr("tabindex","0").focus();return _.device("chrome")&&i.hide(0,function(){$(this).css("display","")}),i},check:function(e){if(this.view.disposed)return $();var t=this.view.$el.width();return e.addClass("selected").attr({"aria-selected":!0,tabindex:0}).find(".folder-label:first").each(function(){if(1!==e.length||!e.first().attr("data-id")||0!==e.first().attr("data-id").indexOf("virtual/settings")){var i=$(this).position().left,s=t-i-76;$(this).css("max-width",Math.max(s,80))}}).end()},uncheck:function(e){return(e=e||this.getItems()).filter(".selected").removeClass("selected").attr({"aria-selected":!1,tabindex:-1}).find(".folder-label").css("max-width","initial"),this},getItems:function(){return this.view.disposed?$():this.view.$(".selectable")},addSelectableVirtualFolder:function(e){this.selectableVirtualFolders[e]=!0},addUnselectableFolder:function(e){this.unselectableFolders[e]=!0},triggerEvent:_.debounce(function(e){"change"===e?this.triggerChange.apply(this,_(arguments).toArray().splice(1)):this.view.trigger.apply(this.view,arguments)},300),triggerChange:function(e){var t=this,i=(e||this.getItems()).filter(".selected").first(),s=i.attr("data-id"),n=i.attr("data-show-in-drive"),r=/^virtual/.test(s);n?require(["io.ox/core/extensions","io.ox/files/api","io.ox/backbone/views/actions/util"]).then(function(e,i,n){var r=i.pool.get("detail").get(s);n.invoke("io.ox/files/actions/show-in-folder",e.Baton({models:[r],app:t.view.app,alwaysChange:!0}))}):t.view&&!t.unselectableFolders[s]&&t.view.trigger(r&&!t.selectableVirtualFolders[s]?"virtual":"change",s,i)}}),e});