define("io.ox/core/main/logout",["io.ox/core/session","io.ox/core/http","io.ox/core/extensions","io.ox/core/capabilities","io.ox/backbone/views/modal","settings!io.ox/core","gettext!io.ox/core"],function(o,e,t,n,i,r,u){function a(){var o=n.has("guest")?r.get("customLocations/guestLogout")||ox.serverConfig.guestLogoutLocation:r.get("customLocations/logout")||ox.serverConfig.logoutLocation;return _.url.vars(o||ox.logoutLocation||"")}function c(o){if(/#autologout=true/.test(o)){var e=document.createElement("a");return e.href=o,location.host===e.host&&location.pathname===e.pathname}}function l(o){var e=a();o.autologout&&(e=e+(e.indexOf("#")>-1?"&":"#")+"autologout=true"),_.url.redirect(_.url.vars(e)),c(e)&&_.defer(function(){location.reload(!0)})}t.point("io.ox/core/logout").extend({id:"tabLogoutFollower",index:"first",logout:function(o){function t(o,e){try{l(e)}finally{o.reject()}}if(!ox.tabHandlingEnabled)return $.when();var n=$.Deferred();return o.skipSessionLogout?require(["io.ox/core/api/tab"],function(i){try{i.setLoggingOutState(i.LOGGING_OUT_STATE.FOLLOWER),ox.trigger("logout"),e.disconnect(),ox.cache.clear().always(function(){t(n,o)})}catch(e){ox.debug&&console.warn("clear storage at logout did not work",e),t(n,o)}}):n.resolve(),n}}),t.point("io.ox/core/logout").extend({id:"confirmLogout",index:100,logout:function(o){if(!ox.tabHandlingEnabled||!o.manualLogout)return $.when();var e=$.Deferred();return require(["io.ox/core/api/tab"],function(o){o.otherTabsLiving().then(function(){require(["io.ox/backbone/views/modal"],function(o){var t=new o({async:!0,title:u("Sign out"),backdrop:!0}).build(function(){this.$body.append($("<div>").text(u("Are you sure you want to sign out from all related browser tabs?")))}).addCancelButton().addButton({action:"force",label:u("Sign out")}).open();t.on("close",function(){t=null,e.reject()}),t.on("force",function(){e.resolve()})})},function(){e.resolve()})}),e.promise()}}),t.point("io.ox/core/logout").extend({id:"tabLogoutLeader",index:150,logout:function(o){if(!ox.tabHandlingEnabled)return $.when();var e=$.Deferred();return require(["io.ox/core/api/tab"],function(t){try{t.setLoggingOutState(t.LOGGING_OUT_STATE.LEADER),t.propagate("propagateLogout",{autologout:o.autologout,exceptWindow:t.getWindowName(),storageKey:t.DEFAULT_STORAGE_KEYS.SESSION})}catch(o){ox.debug&&console.warn("propagate logout did not work",o)}finally{e.resolve()}}),e}}),t.point("io.ox/core/logout").extend({id:"hideUI",index:200,logout:function(){var o=$.Deferred();return $("#background-loader").fadeIn(250,function(){$("#io-ox-core").hide(),o.resolve()}),o}}),t.point("io.ox/core/logout").extend({id:"saveRestorePoint",index:300,logout:function(o){e.pause();var t=$.Deferred();return o.autologout||ox.online?$.when.apply($,ox.ui.apps.map(function(o){return o.saveRestorePoint()})).always(t.resolve):ox.ui.App.canRestore().then(function(o){o?($("#io-ox-core").show(),$("#background-loader").hide(),new i({title:u("Unsaved documents will be lost. Do you want to sign out now?")}).addButton({label:u("No"),action:"No"}).addButton({label:u("Yes"),action:"Yes"}).on("No",function(){t.reject()}).on("Yes",function(){$("#io-ox-core").hide(),$("#background-loader").show(),t.resolve()}).open()):t.resolve()}),r.save(),e.resume(),t}}),t.point("io.ox/core/logout").extend({id:"clearCache",logout:function(){return ox.cache.clear()}}),t.point("io.ox/core/logout").extend({id:"logout-button-hint",logout:function(){return e.pause(),r.set("features/logoutButtonHint/active",!1).save(),e.resume()}}),t.point("io.ox/core/logout").extend({id:"savePendingSettings",index:1e12,logout:function(){e.pause();var o=$.Deferred();return $.when.apply($,_(r.getAllPendingSettings()).map(function(o){return o.save(void 0,{force:!0})})).always(o.resolve),e.resume(),o}});return function(e){e=_.extend({autologout:!1},e||{});var n=t.point("io.ox/core/logout").list(),i=_.stepwiseInvoke(n,"logout",this,new t.Baton(e)).always(function(){if("rejected"===i.state()&&!e.force)return $("#io-ox-core").show(),$("#background-loader").fadeOut(250),ox.trigger("logout:failed",arguments);ox.tabHandlingEnabled&&e.skipSessionLogout||o.logout().always(function(){l(e)})})}});