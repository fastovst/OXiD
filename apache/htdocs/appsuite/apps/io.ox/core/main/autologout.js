define("io.ox/core/main/autologout",["io.ox/core/main/logout","settings!io.ox/core","gettext!io.ox/core"],function(o,t,n){!function(){var e,i=10,a=30,u=0,c=null,l=null,r=null,s=!1,d=!1,g=!1,f=function(){return Math.ceil((e+u-_.now())/1e3)},m=function(){return parseInt(t.get("autoLogout",0),10)},p=function(){clearTimeout(c),c=setTimeout(function(){o({autologout:!0})},u),e=_.now(),s=!1},v=function(){return null!==c&&null!==l},x=$.noop,w=function(){if(ox.tabHandlingEnabled&&g&&x(),s&&null===r)p();else{var t=f();t<=a&&null===r&&require(["io.ox/backbone/views/modal"],function(e){var i=t,a=function(o){return n.format(n.ngettext("You will be automatically signed out in %1$d second","You will be automatically signed out in %1$d seconds",o),o)},u=$("<span>").text(a(i)),l=setInterval(function(){i<=0?(clearInterval(l),o({autologout:!0})):(i--,u.text(a(i)))},1e3);clearTimeout(c),r&&(ox.off("logout:failed",r.logoutFailed),r.close()),(r=new e({async:!0,title:n("Automatic sign out"),backdrop:!0}).build(function(){this.$body.append(u),this.$el.addClass("auto-logout-dialog")}).addCancelButton().addButton({action:"retry",label:n("Retry"),className:"btn-default"}).addButton({action:"force",label:n("Sign out now")}).open()).on("close",function(){p(),clearInterval(l),r=null,ox.handleLogoutError=!1}),r.on("force",function(){if(p(),clearInterval(l),r.$el.hasClass("logout-failed")){r.pause();var t=new e({async:!0,title:n("Are you sure?"),backdrop:!0}).build(function(){this.$body.append($('<div class="alert alert-danger">').text(n("Forcing logout may cause data loss.")))}).addCancelButton().addButton({action:"force",label:n("Force sign out")}).open();t.on("cancel",function(){r.resume()}),t.on("force",function(){o({force:!0}),r.close(),this.close()})}else o()}),r.on("retry",function(){p(),clearInterval(l),o()}),r.logoutFailed=function(o){if(r){ox.handleLogoutError=!0;var t=o[0]&&o[0].error?o[0].error:o[0];r.idle(),r.$el.toggleClass("logout-failed",!0),r.$el.find('[data-action="force"]').text(n("Force sign out")),r.$body.empty().append($('<div class="alert alert-danger">').append($("<div>").text(n("Logout failed.")),_.isString(t)?$("<div>").text(t):""))}},ox.on("logout:failed",r.logoutFailed)})}},b=function(){s=!0},E=function(){(u=m())>0&&null===c&&($(document).on("mousedown mousemove scroll touchstart touchmove keydown",b),p(),l=setInterval(w,1e3*i))},h=function(){l&&c&&(clearTimeout(c),clearInterval(l),c=l=null,ox.tabHandlingEnabled&&(u=0),$(document).off("mousedown mousemove scroll touchstart touchmove keydown",b))},y=function(){h(),E()};ox.autoLogout={start:E,stop:h,restart:y,debug:function(){i=1,a=10,m=function(){return 12e3},y()},logout:o.bind(null,{autologout:!0})},ox.tabHandlingEnabled&&require(["io.ox/core/api/tab"],function(n){function i(){n.propagate("propagateLeaderChanged",{exceptWindow:n.getWindowName()})}function a(){n.propagate("propagateResetAutoLogoutTimeout",{exceptWindow:n.getWindowName()})}function l(){var o=_.first(_.filter(n.getWindowList(),function(o){return o.windowName!==n.getWindowName()}));return o?o.windowName:""}x=function(){n.propagate("propagatePause",{})},p=function(){clearTimeout(c),u<=0||(c=setTimeout(function(){o({autologout:!0})},u),e=_.now(),s=!1,d||(e=_.now()+1e3),d&&a())},t.on("change:autoLogout",function(o){n.propagate("propagateSettingsAutoLogout",{val:o,exceptWindow:n.getWindowName()})}),n.communicationEvents.listenTo(n.communicationEvents,"propagateResetAutoLogoutTimeout",function(){d=!1,r&&r.close(),v()&&p()}),n.communicationEvents.listenTo(n.communicationEvents,"propagateSettingsAutoLogout",function(o){var n=parseInt(o.val,10);t.set("autoLogout",n,{silent:!0}),0===n?h():E()}),n.communicationEvents.listenTo(n.communicationEvents,"nextWindowActive",function(){d=!0,i()}),n.communicationEvents.listenTo(n.communicationEvents,"propagatePause",function(){d&&p()}),n.communicationEvents.listenTo(n.communicationEvents,"propagateLeaderChanged",function(){d=!1,v()&&p()}),n.sessionEvents.listenTo(n.sessionEvents,"before:propagatedLogout",function(){r&&r.close(),h()}),require(["io.ox/core/tk/visibility-api-util"]).done(function(o){$(o).on("visibility-changed",function(o,t){!1===t.currentHiddenState&&(d=!0,i(),v()&&p())})}),n.communicationEvents.listenTo(n.communicationEvents,"beforeunload",function(o){if(!o){var t=l();t&&n.propagate("nextWindowActive",{targetWindow:t})}}),_.extend(ox.autoLogout,{start:function(){g=!1},stop:function(){g=!0}}),d=!0,i()}),t.on("change:autoLogout",function(o){if(0===parseInt(o,10))return h();E()}),E()}()});