define("io.ox/core/main/appcontrol",["io.ox/core/http","io.ox/core/upsell","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/main/icons","io.ox/backbone/mini-views/dropdown","settings!io.ox/core","gettext!io.ox/core","io.ox/core/main/autologout"],function(e,t,i,o,n,a,s,l){function r(e){$("#io-ox-appcontrol").toggleClass("open",e),$("#io-ox-launchgrid-overlay, #io-ox-launchgrid-overlay-inner").toggle(e)}function c(){function t(){if(0===i&&null===o)if($("#io-ox-refresh-icon .apptitle").attr("aria-label",l("Refresh")),n){if((s=s||$("#io-ox-refresh-icon").find("i")).hasClass("fa-spin")){s.addClass("fa-spin-paused");var e=!1;setTimeout(function(){e=!0},2546),s.on("animationiteration",function(t){e&&$(t.target).removeClass("fa-spin")})}}else $("#io-ox-refresh-icon").removeClass("io-ox-progress")}var i=0,o=null,n=_.device("webkit || firefox || ie > 9"),a=n?500:1500,s=null;e.on("start",function(e,r,c){0===i&&(null!==o||c.silent||($("#io-ox-refresh-icon .apptitle").attr("aria-label",l("Currently refreshing")),n?(s=s||$("#io-ox-refresh-icon").find("i")).hasClass("fa-spin")||s.addClass("fa-spin").removeClass("fa-spin-paused"):$("#io-ox-refresh-icon").addClass("io-ox-progress")),clearTimeout(o),o=setTimeout(function(){o=null,t()},a)),i++}),e.on("stop",function(){i=Math.max(0,i-1),t()})}var d=Backbone.View.extend({tagName:"a",className:"btn btn-link lcell",attributes:{href:"#",role:"menuitem",tabindex:-1},events:{click:"onClick","click .closer":"quitApp"},initialize:function(e){this.pos=e.pos,this.quicklaunch=e.quicklaunch,this.listenTo(this.model,"change:hasBadge",this.toggleBadge),this.listenTo(this.model,"change:tooltip",this.updateTooltip),this.listenTo(this.model,"change:title",this.updateTitle),this.listenTo(s,"change:coloredIcons",this.render)},addAccessKey:function(){this.pos<=9&&0!==this.pos&&this.$el.attr("accesskey",this.pos)},checkUpsell:function(){var e=this.model.get("requires");return!t.has(e)},drawUpsellIcon:function(e){this.checkUpsell()&&e.addClass("upsell").append(_(s.get("upsell/defaultIcon","fa-star").split(/ /)).map(function(e){return $('<i class="fa" aria-hidden="true">').addClass(e)}))},onClick:function(){if(this.checkUpsell()){var e=this.model.get("requires");t.trigger({type:"app",id:this.model.get("id"),missing:t.missing(e)})}else{if("running"===this.model.get("state")&&this.model.get("closable"))return void this.model.launch();if(ox.tabHandlingEnabled&&this.model.get("openInTab"))return void require("io.ox/core/api/tab").openChildTab(this.model.get("tabUrl"));ox.launch(this.model.get("path"))}},quitApp:function(e){e.preventDefault(),e.stopPropagation(),this.model.quit()},drawCloser:function(){var e=$('<a href="#" type="button" class="btn btn-link closer">').append($('<i class="fa fa-times" aria-hidden="true">'));this.$el.append(e),this.closer=e},drawDate:function(){this.$icon.find("tspan:first").text(moment().format("D"))},drawIcon:function(){var e=this.model.get("icon"),t=this.model.get("id"),i=this.model.get("title"),o=_.isString(i)?i[0]:"?";return e=/^<.*>$/.test(e)?e:"",this.model.get("closable")&&_.device("smartphone")&&(e=ox.ui.appIcons[this.model.options.name]),this.$icon=e?$(e):$(n.fallback).find("text > tspan").text(o).end(),this.$icon.attr("aria-hidden",!0),s.get("coloredIcons",!1)&&this.$icon.addClass("colored"),("io.ox/calendar"===t||/calendar/.test(this.model.getName()))&&this.drawDate(),this.$cell=$('<div class="lcell">').append(this.badge=$('<svg height="8" width="8" class="indicator" focusable="false"><circle cx="4" cy="4" r="4"></svg>').toggleClass("hidden",!this.model.get("hasBadge")),$('<div class="icon">').append(this.$icon),$('<div class="title">').text(this.model.get("title"))),this.drawUpsellIcon(this.$cell.find(".title")),this.$cell},toggleBadge:function(){this.badge.toggleClass("hidden",!this.model.get("hasBadge"))},updateTooltip:function(){if(this.quicklaunch){var e=this.model.get("tooltip");e=this.model.get("title")+(e?" ("+e+")":""),this.$el.attr("aria-label",e),this.$cell.attr({"aria-hidden":!0,title:e})}},updateTitle:function(e,t){var i=this.icon.find(".title");i.text(t),this.drawUpsellIcon(i)},render:function(){return this.$el.empty().attr({"data-id":this.model.get("id"),"data-app-name":this.model.get("name")}).toggleClass("active",ox.ui.App.isCurrent(this)).append(this.icon=this.drawIcon()),this.updateTooltip(),this.addAccessKey(),this}}),u={quickLaunchLimit:5,getQuickLauncherCount:function(){var e=s.get("apps/quickLaunchCount",3);return _.isNumber(e)?Math.min(this.quickLaunchLimit,ox.ui.apps.forLauncher().length,e):0},getQuickLauncherDefaults:function(){return"io.ox/mail/main,io.ox/calendar/main,io.ox/files/main"},getQuickLauncherItems:function(){var e=this.getQuickLauncherCount(),t=String(s.get("apps/quickLaunch",this.getQuickLauncherDefaults())).trim().split(/,\s*/);return(_.chain(t).filter(function(e){return ox.ui.apps.get(e.replace(/\/main$/,""))}).value().join(",")+new Array(e).join(",none")).split(",").slice(0,e)}},p=Backbone.Collection.extend({initialize:function(){this.reload(),s.on("change:apps/quickLaunch change:apps/quickLaunchCount",this.reload.bind(this)),this.listenTo(ox.ui.apps,"add reset",this.reload)},reload:function(){this.reset(this.fetch())},fetch:function(){var e=u.getQuickLauncherItems().map(function(e){return ox.ui.apps.get(e.replace(/\/main$/,""))});return _(e).compact()}}),h=Backbone.View.extend({attributes:{id:"io-ox-quicklaunch",role:"toolbar"},events:{"click button":"onClick",contextmenu:"onContextmenu"},initialize:function(){this.collection=new p,this.listenTo(this.collection,{reset:this.render})},onClick:function(){r(!1)},onContextmenu:function(e){e.preventDefault(),require(["io.ox/core/settings/dialogs/quickLauncherDialog"],function(e){e.openDialog()})},render:function(){return this.$el.empty().append(this.collection.map(function(e){return new d({tagName:"button",attributes:{tabindex:-1,type:"button"},model:e,quicklaunch:!0}).render().$el.attr("tabindex",-1)})),this.$el.find("button").first().removeAttr("tabindex"),this}}),f=a.extend({attributes:{role:"presentation",dontprocessonmobile:"true"},tagName:"li",options:{dontProcessOnMobile:!0},className:"launcher dropdown",id:"io-ox-launcher",$ul:$('<ul class="launcher-dropdown dropdown-menu dropdown-menu-right" role="menu">'),$toggle:$('<a href="#" class="launcher-btn btn btn-link dropdown-toggle" dontprocessonmobile="true">').attr("aria-label",l("Navigate to:")).append($(n.launcher).attr("title",l("All Applications"))),initialize:function(){a.prototype.initialize.apply(this,arguments),this.listenTo(this.collection,"add remove launcher:update launcher:sort",this.update),this.update()},update:function(){this.$ul.empty(),this.collection.forLauncher().forEach(function(e,t){this.append(new d({model:e,pos:t+1}).render().$el)}.bind(this)),_.device("smartphone")&&this.collection.where({closable:!0}).forEach(function(e){this.append(new d({model:e}).render().$el)}.bind(this))}});return ox.once("core:load",function(){ox.manifests.loadPluginsFor("io.ox/core/notifications").done(function(){i.point("io.ox/core/notifications/badge").invoke("register",self,{})})}),i.point("io.ox/core/appcontrol").extend({id:"init",index:100,draw:function(){var e;$("#io-ox-core").append(e=$('<div id="io-ox-launchgrid-overlay">').on("click",r)),_.device("smartphone")&&e.on("touchstart",function(e){e.preventDefault(),r()}),c(),ox.ui.apps.on("launch resume",function(e){e.get("floating")||($(".launcher-dropdown").find(".lcell[data-app-name]").removeClass("active").end().find('.lcell[data-app-name="'+e.get("name")+'"]').addClass("active"),$("#io-ox-quicklaunch").find(".lcell[data-id]").removeClass("active").end().find('.lcell[data-id="'+e.get("name")+'"]').addClass("active"),_.defer(function(){$(document).trigger("resize")}))})}}),i.point("io.ox/core/appcontrol").extend({id:"skiplinks",index:150,draw:function(){this.append($('<a class="skip-links sr-only sr-only-focusable" href="#">').append($("<span>").text(l("Skip to main content"))))}}),i.point("io.ox/core/appcontrol").extend({id:"logo",index:300,draw:function(){var e,t=s.get("logoFileName","logo.png"),i=s.get("logoAction",!1);if(this.append(e=$('<div id="io-ox-top-logo">').append($("<img>").attr({alt:ox.serverConfig.productName,src:ox.base+"/apps/themes/"+ox.theme+"/"+t}))),/^https?:/.test(i))e.wrap($('<a class="btn btn-link logo-btn">').attr({href:i,target:"_blank"}));else if(i&&!ox.openedInBrowserTab){var o=s.get("autoStart");if("autoStart"===i){if("none"===o)return;i=o}e.wrap($('<button type="button" class="logo-btn btn btn-link">').on("click",function(){ox.launch(i)}))}}}),i.point("io.ox/core/appcontrol").extend({id:"quicklauncher",index:400,draw:function(){if(!_.device("smartphone")){var e=window.quicklaunchers=new h;this.append(e.render().$el)}}}),i.point("io.ox/core/appcontrol/right").extend({id:"launcher",index:120,draw:function(){var e=window.launchers=new f({collection:ox.ui.apps,dontProcessOnMobile:!0});this.append(e.render().$el)}}),i.point("io.ox/core/appcontrol").extend({id:"search",index:500,draw:function(){var e=$('<div id="io-ox-topsearch">');this.append(e)}}),i.point("io.ox/core/appcontrol").extend({id:"right",index:600,draw:function(){var e=$('<ul class="taskbar list-unstyled" role="toolbar">');this.append($('<div id="io-ox-toprightbar">').append(e)),i.point("io.ox/core/appcontrol/right").invoke("draw",e)}}),i.point("io.ox/core/appcontrol").extend({id:"show",index:1e4,draw:function(){this.attr("role","banner").show()}}),_.extend(u,{LauncherView:d,LaunchersView:f})});