define("io.ox/core/attachments/view",["io.ox/core/extensions","io.ox/core/attachments/backbone","io.ox/core/strings","gettext!io.ox/core","io.ox/backbone/views/extensible","less!io.ox/core/attachments/style"],function(e,t,i,s,l){"use strict";var o=l.extend({scrollStep:120,openByDefault:!1,events:{"click .toggle-details":"onToggleDetails","click .toggle-mode":"onToggleMode","click .scroll-left":"scrollLeft","click .scroll-right":"scrollRight"},initialize:function(e){this.options=_.extend({AttachmentView:r,editable:!1,mode:"list"},e),this.listenTo(this.collection,"add",this.addAttachment),this.$el.addClass("mail-attachment-list").addClass(_.device("touch")?"touch":""),this.options.editable&&this.$el.addClass("editable"),"preview"===this.options.mode&&this.$el.addClass("show-preview"),this.$header=$('<div class="header">'),this.$list=$('<ul class="inline-items">'),this.$preview=$('<ul class="inline-items preview">'),this.$footer=$("<footer>"),this.isListRendered=!1,this.listenTo(this.collection,"add remove reset",function(){var e=this.getValidModels().length;this.$el.toggleClass("empty",0===e),this.updateScrollControls(),this.renderSummary(e),this.openByDefault&&this.toggleDetails(!0)}),this.listenTo(this.collection,"remove",function(){this.$preview.trigger("scroll")}),this.$el.toggleClass("empty",0===this.getValidModels().length)},render:function(){var e=_.uniqueId("list-container-"),t=_.uniqueId("preview-container-");return this.renderHeader(),this.$el.append(this.$header,$('<div class="list-container">').attr("id",e).append(this.$list),$('<div class="preview-container">').attr("id",t).append($('<button type="button" class="scroll-left"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>'),this.$preview,$('<button type="button" class="scroll-right"><i class="fa fa-chevron-right" aria-hidden="true"></i></button>')),this.$footer),this.openByDefault&&this.toggleDetails(!0),this.updateScrollControls(),this.updateAriaControls(),this.$header.find(".toggle-mode").attr("aria-controls",[e,t].join(" ")),this},renderHeader:function(){this.$header.append($('<a href="#" class="toggle-details" aria-expanded="false" role="button">').append($('<i class="fa fa-paperclip" aria-hidden="true">'),$('<span class="summary">'),$('<i class="fa toggle-caret" aria-hidden="true">')),$('<span class="links" role="presentation">'),$('<a href="#" class="pull-right toggle-mode" role="button">').attr("title",s("Toggle preview")).append('<i class="fa" aria-hidden="true">')),this.renderSummary()},renderSummary:function(e){e=e||this.getValidModels().length,this.$header.find(".summary").text(s.format(s.ngettext("%1$d attachment","%1$d attachments",e),e))},renderList:function(){function e(e,t,i){t.append(e.map(this.renderAttachment.bind(this,i)))}var t=this.getValidModels();e.call(this,t,this.$list,"list"),e.call(this,t,this.$preview,"preview"),this.isListRendered=!0},renderAttachment:function(e,t){return new this.options.AttachmentView({point:this.options.point,mode:e,model:t}).render().$el},addAttachment:function(e){this.isListRendered&&this.collection.isValidModel(e)&&(this.$list.append(this.renderAttachment("list",e)),this.$preview.append(this.renderAttachment("preview",e)))},getValidModels:function(){return this.collection.getValidModels()},updateAriaControls:function(){var e;e=this.$el.hasClass("show-preview")?this.$(".preview-container").attr("id"):this.$(".list-container").attr("id"),this.$header.find(".toggle-details").attr("aria-controls",e),this.$header.find(".toggle-mode").attr("aria-pressed",this.$el.hasClass("show-preview"))},toggleDetails:function(e){this.$el.toggleClass("open",!0===e||void 0),this.$header.find(".toggle-details").attr("aria-expanded",this.$el.hasClass("open")),this.trigger("change:expanded",this.$el.hasClass("open")),this.isListRendered||this.renderList()},onToggleDetails:function(e){e.preventDefault(),this.toggleDetails(),this.updateScrollControls()},onToggleMode:function(e){e.preventDefault(),this.$el.toggleClass("show-preview"),this.trigger("change:layout",this.$el.hasClass("show-preview")?"preview":"list"),this.$preview.trigger("scroll"),this.updateScrollControls(),this.updateAriaControls(),$(window).trigger("resize")},scrollLeft:function(){this.scrollList(-1)},scrollRight:function(){this.scrollList(1)},scrollList:function(e){var t=this.getScrollIndex()+e,i=this.getMaxScrollIndex();t<0||t>i||(this.updateScrollControls(t),this.$preview.stop(!0,!1).animate({scrollLeft:t*this.scrollStep},"fast"))},getScrollIndex:function(){return Math.ceil(this.$preview.scrollLeft()/this.scrollStep)},getMaxScrollIndex:function(){var e=this.$preview.width(),t=this.$preview.prop("scrollWidth");return Math.max(0,Math.ceil((t-e)/this.scrollStep))},updateScrollControls:function(e){void 0===e&&(e=this.getScrollIndex());var t=this.getMaxScrollIndex();this.$(".scroll-left").prop("disabled",e<=0),this.$(".scroll-right").prop("disabled",e>=t)}}),n=Backbone.View.extend({className:"preview",events:{keydown:"onKeydown"},initialize:function(){this.listenTo(this.model,"change:id",this.render),this.$el.on("error.lazyload",this.fallback.bind(this))},lazyload:function(e){_.defer(function(){this.$el.lazyload({container:this.$el.closest("ul"),effect:"fadeIn",previewUrl:e})}.bind(this))},getColor:function(e){return/^do[ct]x?$/.test(e)?"#2C5897":/^xlsx?|o[dt]s$/.test(e)?"#1D7047":/^p[po]tx?$/.test(e)?"#D04423":/^pdf$/.test(e)?"#C01E07":/^(zip|gz|gzip|tgz)$/.test(e)?"#FF940A":void 0},fallback:function(){var e,t=this.model.getExtension();t&&(e=this.getColor(t),this.$el.append($('<div class="abs fallback ellipsis">').css({color:e&&"white",backgroundColor:e}).text(t)))},render:function(){var e=this.model.previewUrl({delayExecution:!0});return _.isString(e)?(this.$el.addClass("lazy").attr("data-original",e),this.lazyload()):null!==e?(this.$el.addClass("lazy"),this.lazyload(e)):this.fallback(),this.$el.attr("tabindex","0"),this},onKeydown:function(e){13!==e.which&&32!==e.which||($(e.target).trigger("click"),e.preventDefault(),e.stopPropagation())}}),r=Backbone.View.extend({tagName:"li",className:"item",events:{"click .remove":"onRemove"},attributes:function(){return{"data-id":this.model.get("id")||this.model.cid}},initialize:function(t){this.options=_.extend({mode:"list"},t),this.preview="preview"===this.options.mode&&new n({model:this.model,el:this.el}),this.listenTo(this.model,{"change:uploaded":function(e){var t=100*e.get("uploaded");0===t&&this.render(),this.$(".progress").width(t+"%")},"change:file_size change:size":this.render,"upload:complete":function(){this.render()},remove:this.onRemoveModel});var i=this.options.point?this.options.point+"/view":"io.ox/core/attachment/view";e.point(i).invoke("initialize",this)},onRemove:function(e){e.preventDefault(),this.model.collection.remove(this.model)},onRemoveModel:function(){this.remove()},render:function(){return this.$el.empty().append($('<span class="file">'),$('<span class="filesize">'),this.model.needsUpload()?$('<div class="progress-container">').append($('<div class="progress">')):$()),this.preview&&this.preview.render(),this.preview||this.renderFileSize(),this.renderContent(),this.renderControls(),this},renderFileSize:function(){var e=this.model.getSize();e&&this.$(".filesize").text(" ("+i.fileSize(e,1)+")")},renderContent:function(){this.$(".file").attr("title",this.model.getTitle()).text(this.model.getShortTitle(_.device("smartphone")?23:50))},renderControls:function(){this.$el.append($('<a href="#" class="control remove">').attr("title",s("Remove attachment")).append($('<i class="fa fa-trash-o" aria-hidden="true">')))}});return{List:o,View:r,Preview:n,Model:t.Model,Collection:t.Collection}});