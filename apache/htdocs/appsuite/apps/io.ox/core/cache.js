define("io.ox/core/cache",["io.ox/core/extensions","io.ox/core/cache/indexeddb","io.ox/core/cache/localstorage","io.ox/core/cache/simple"],function(e){"use strict";var n=null,t={},r=function(e){return"object"==typeof e&&e?((e="data"in e?e.data:e).folder_id||e.folder||0)+"."+e.id:""};ox.cache={usePersistence:function(){return"always"===ox.serverConfig.persistence||!0===ox.secretCookie&&!1!==ox.serverConfig.persistence},clear:function(){return $.when.apply($,e.point("io.ox/core/cache/storage").map(function(e){return e.clear&&e.isUsable()?e.clear():$.when()}).value())}},e.point("io.ox/core/cache/storage").each(function(e){e.isUsable()&&_.isNull(n)&&(n=e.id),t[e.id]=e}),n=_.url.hash("cacheStorage")?_.url.hash("cacheStorage"):n;var o=function(e,r,o){/app-cache\.index$/.test(e)&&Modernizr.localstorage&&((o=o||{}).persistent="localstorage");var i=_.extend({fluent:"simple",persistent:n},o||{}),u=t[i.persistent],a=t[i.fluent],c=!0===r&&ox.cache.usePersistence()&&u.isUsable()&&"false"!==_.url.hash("persistence")?function(){return""!==ox.user}:function(){return!1},s=_(["appsuite.cache",ox.user,ox.locale,e||""]).compact().join("."),h=function(){var e=null;return e=c()?u:a,e.getInstance(s)};this.clear=function(){return h().clear()},this.get=function(e){return h().get(e)},this.set=function(e,n){return h().set(e,n)},this.remove=function(e){return h().remove(e)},this.keys=function(){return h().keys()}},i=function(e,n){function t(e){return e&&e.data?e.data:null}var r=new o(e+".index",n);if(!e)throw new Error("Each object cache needs a unique name!");this.clear=function(){return r.clear()},this.add=function(e,n,t){return t=void 0!==t?t:_.now(),r.get(e).then(function(o){return null!==o?t>=o.timestamp?r.set(e,{data:n,timestamp:t}).then(function(){return n}):o.data:r.set(e,{data:n,timestamp:t}).then(function(){return n})})},this.get=function(e,n,t){return r.get(e).then(function(e){return null!==e?(t&&t(e.data),e.data):n?n():null})},this.time=function(e){return r.get(e).then(function(e){return null!==e?e.timestamp:0})},this.remove=function(e){if(_.isArray(e)){for(var n=0,t=e.length,o=[];n<t;n++)o.push(r.remove(e[n]));return $.when.apply(null,o)}return r.remove(e)},this.grepRemove=function(e){var n=0,t=0;"string"==typeof e&&(e=new RegExp(_.escapeRegExp(e)));var o=function(n){if(e.test(n))return r.remove(n)};return r.keys().then(function(e){t=e.length;for(var r=[];n<t;n++)r.push(o(e[n]));return $.when.apply(null,r)})},this.keys=function(){return r.keys()},this.grepKeys=function(e){return r.keys().done(function(n){var t,r=n.length,o=0,i=[];for("string"==typeof e&&(e=new RegExp(_.escapeRegExp(e)));o<r;o++)t=n[o],e.test(t)&&i.push(t);return i})},this.values=function(){return r.keys().then(function(e){return $.when.apply($,_(e).map(function(e){return r.get(e).then(t)})).then(function(){return _(arguments).compact()})})},this.size=function(){return r.keys().then(function(e){return e.length})}};return window.dumpStorage=function(){for(var e,n,t=0,r=localStorage.length;t<r;t++){e=localStorage.key(t);try{n=JSON.parse(localStorage.getItem(e)),console.debug("#",t,"key",e,"value",n)}catch(n){console.error("key",e,n)}}},{defaultKeyGenerator:r,CacheStorage:o,SimpleCache:i,ObjectCache:function(e,n,t){i.call(this,e,n),this.keyGenerator=_.isFunction(t)?t:r;var o=this.get;this.get=function(e,n,t){if(_.isArray(e)){var r=this,i=new $.Deferred;return $.when.apply($,_(e).map(function(e){return r.get(e)})).done(function(){var e;_(arguments).reduce(function(e,n){return e||null===n},!1)?n?n().then(i.resolve,i.reject):i.resolve(null):(e=$.makeArray(arguments),t&&t(e),i.resolve(e))}),i}var u;return"string"!=typeof e&&"number"!=typeof e||(u=e),u=this.keyGenerator(e),o(u,n,t)};var u=this.add;this.add=function(e,n){var t;if(_.isArray(e)){n=void 0!==n?n:_.now();for(var r=0,o=e.length,i=this,a=[];r<o;r++)a.push(function(e,n){return i.add(e,n).then(function(){return i.keyGenerator(e)})}(e[r],n));return $.when.apply($,a).then(function(){return _(arguments).without(null)})}return t=String(this.keyGenerator(e)),u(t,e,n).then(function(){return t})},this.merge=function(e,n){var t,r=!1,i=this;if(_.isArray(e)){n=void 0!==n?n:_.now();for(var u=0,a=e.length,c=[];u<a;u++)c.push(this.merge(e[u],n).then(function(e){r=r||e}));return $.when.apply(null,c).then(function(){return r})}return t=String(this.keyGenerator(e)),o(t).then(function(t){if(null!==t){var o;for(o in t)void 0!==e[o]&&(r=r||!_.isEqual(t[o],e[o]),t[o]=e[o]);return r?i.add(t,n).then(function(){return r}):r}return!1})};var a=this.remove;this.remove=function(e){var n=new $.Deferred,t=this.keyGenerator,r=function(e){return"string"==typeof e||"number"==typeof e?e:String(t(e))};if(_.isArray(e))for(var o=0,i=e.length,u=0,c=function(){++u===i&&n.resolve()};o<i;o++)!function(e){a(r(e)).done(c).fail(c)}(e[o]);return a(r(e)).done(n.resolve).fail(n.reject),n},this.dedust=function(e,n){var t=String(this.keyGenerator(e));return o(t).then(function(r){return null!==r&&r[n]!==e[n]?a(t):$.when()})}}}});