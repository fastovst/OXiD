define("io.ox/core/api/autocomplete",["io.ox/core/http","io.ox/core/capabilities","io.ox/contacts/api","io.ox/core/api/resource","io.ox/core/api/group","io.ox/core/extensions","settings!io.ox/contacts"],function(t,i,e,s,o,n,r){"use strict";function c(t){var i=this;this.options=$.extend({users:!1,contacts:!1,distributionlists:!1,resources:!1,groups:!1,split:!0,limit:0},t),this.cache={},this.apis=[],t.users&&this.apis.push({type:"user",api:e}),t.contacts&&this.apis.push({type:"contact",api:e}),t.resources&&this.apis.push({type:"resource",api:s}),t.groups&&this.apis.push({type:"group",api:o}),this.fields=this.options.split?["email1","email2","email3"]:["email1"],t.extPoint&&n.point(t.extPoint+"/autocomplete/customize").invoke("customize",this),n.point("io.ox/core/api/autocomplete/customize").invoke("customize",this),e.on("maybeNewContact",function(){i.cache={}})}return c.prototype={search:function(i){i="string"!=typeof i?"":$.trim(i).toLowerCase();var e=this,s={admin:r.get("showAdmin",!1),emailAutoComplete:!1,limit:this.options.limit};if(i in this.cache)return $.Deferred().resolve(this.cache[i]);try{return t.pause(),$.when.apply($,_(e.apis).map(function(t){return(t.api.autocomplete||t.api.search)(i,s)})).then(function(){var t=[],o=_(arguments).toArray();return _(e.apis).each(function(n,r){var c=_(o[r]).map(function(t){return t.type=n.type,t});t=t.concat(c),/contact|custom|user/.test(n.type)&&(t=e.processContactResults(t,i),s.limit&&(t=t.slice(0,s.limit)))}),e.cache[i]=t})}finally{t.resume()}},processContactResults:function(t,i){function e(t,i){return("contact"!==i||!r[t])&&(!o[t]&&(o[t]=!0))}var s=[],o={},n=this,r={};return _(t).each(function(t){/contact|custom|user/.test(t.type)?t.mark_as_distributionlist?n.options.distributionlists&&s.push(t):_.each(n.fields,function(e){if(t[e]){if(6!==t.folder_id&&"user"===t.type)return;if(n.options.users&&6===t.folder_id&&"contact"===t.type)return;"user"===t.type&&t.internal_userid&&(t.contact_id=t.id,t.id=t.internal_userid,delete t.internal_userid);var o=_.extend({},t);o.field=e,t[e]===i?s.unshift(o):s.push(o),"user"===t.type&&(r[t.sort_name+"_"+t[e]]=!0)}}):s.push(t)}),s=_(s).filter(function(t){return t.mark_as_distributionlist?e(_.cid(t)):e(t.sort_name+"_"+t[t.field],t.type)}),o=null,r=null,s}},c});