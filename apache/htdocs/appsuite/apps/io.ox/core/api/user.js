define("io.ox/core/api/user",["io.ox/core/http","io.ox/core/api/factory","io.ox/contacts/util","io.ox/core/capabilities"],function(e,t,a,r){"use strict";var i=function(e){return e.id?(e.birthday&&moment.utc(e.birthday).local(!0).year()<=1&&(e.birthday=a.julianToGregorian(e.birthday)),e.anniversary&&moment.utc(e.anniversary).local(!0).year()<=1&&(e.anniversary=a.julianToGregorian(e.anniversary)),e):(_(e).each(function(t){t.birthday&&moment.utc(t.birthday).local(!0).year()<=1&&(t.birthday=a.julianToGregorian(t.birthday)),e.anniversary&&moment.utc(e.anniversary).local(!0).year()<=1&&(e.anniversary=a.julianToGregorian(e.anniversary))}),e)},n=t({module:"user",keyGenerator:function(e){return"string"==typeof e||"number"==typeof e?e:String(e.id)},requests:{all:{columns:"1,20,500",extendColumns:"io.ox/core/api/user/all",sort:"500",order:"asc"},list:{action:"list",columns:"1,20,500,501,502,505,524,555,606,614,616",extendColumns:"io.ox/core/api/user/list"},get:{action:"get"},search:{action:"search",columns:"1,20,500,524",extendColumns:"io.ox/core/api/user/search",sort:"500",order:"asc",getData:function(e){return{pattern:e}}}},pipe:{get:i,search:i}});ox.rampup.user&&ox.rampup.user.id===ox.user_id&&(n.caches.get.add(ox.rampup.user),n.caches.list.add(ox.rampup.user)),n.update=function(t){return _.isEmpty(t.data)?$.when():require(["io.ox/contacts/api"]).then(function(i){return t.data.birthday&&moment.utc(t.data.birthday).local(!0).year()<=1&&(t.data.birthday=a.gregorianToJulian(t.data.birthday)),t.data.anniversary&&moment.utc(t.data.anniversary).local(!0).year()<=1&&(t.data.anniversary=a.gregorianToJulian(t.data.anniversary)),t.data=_(t.data).each(function(e,a){""!==e&&void 0!==e||(t.data[a]=null)}),e.PUT({module:"user",params:{action:"update",id:t.id,folder:t.folder,timestamp:t.timestamp||_.then()},data:t.data,appendColumns:!1}).then(function(){return n.get({id:t.id},!1).then(function(e){return $.when(n.caches.get.add(e),n.caches.all.clear(),n.caches.list.remove({id:t.id}),i.caches.get.remove({folder_id:e.folder_id,id:e.contact_id}),i.caches.all.grepRemove(t.folder+i.DELIM),i.caches.list.remove({id:e.contact_id,folder:t.folder}),i.clearFetchCache()).then(function(){return e}).done(function(){n.trigger("update:"+_.ecid(e),e),n.trigger("update",e),n.trigger("refresh.list"),null===t.data.image1&&(i.trigger("update:image",e),n.trigger("reset:image reset:image:"+t.id,{id:t.id})),6===e.folder_id&&r.has("!gab")||i.get({folder_id:e.folder_id,id:e.contact_id}).done(function(e){i.trigger("update:"+_.ecid(e),e),i.trigger("update",e)})})})})})},n.editNewImage=function(t,a,r){var i=function(e){return $.when(n.caches.get.clear(),n.caches.all.clear(),n.caches.list.clear()).then(function(){n.trigger("refresh.list"),require(["io.ox/contacts/api"]).then(function(e){e.trigger("update:image",{id:t.id}),n.trigger("update update:image update:image:"+t.id,{id:t.id})})}),e};if("FormData"in window&&r instanceof window.File){var o=new FormData;return o.append("file",r),o.append("json",JSON.stringify(a)),e.UPLOAD({module:"user",params:{action:"update",id:t.id,timestamp:t.timestamp||_.then()},data:o,fixPost:!0}).then(i)}return e.FORM({module:"user",action:"update",form:r,data:a,params:{id:t.id,folder:t.folder_id,timestamp:t.timestamp||_.then()}}).then(i)},n.getName=function(e){return n.get({id:e}).then(function(e){return e.display_name||e.email1||""})},n.getGreeting=function(e){return n.get({id:e}).then(function(e){return e.first_name||e.display_name||e.email1||""})},n.getTextNode=function(e,t){var r=_.extend({type:"name"},t),i=document.createTextNode("");return n.get({id:e}).done(function(e){var t="";"name"===r.type?t=e.display_name||e.email1:"email"===r.type?t=e.email1||e.display_name:"initials"===r.type&&(t=a.getInitials(e)),i.nodeValue=t}).always(function(){_.defer(function(){i=null})}),i},n.getLink=function(e,t){return t=t?$.txt(t):n.getTextNode(e),$('<a href="#" class="halo-link">').append(t).data({internal_userid:e})},n.getCurrentUser=function(){return require(["io.ox/core/settings/user"]).then(function(e){return e.getCurrentUser()})};var o=n.get;return n.get=function(){return!arguments.length||_.isEmpty(arguments)||_.isObject(arguments[0])&&void 0===arguments[0].id?o({id:ox.user_id}):o.apply(this,arguments)},n.me=function(){return ox.rampup.user?$.when(ox.rampup.user):n.get()},n.on("update:"+_.ecid({folder_id:6,id:ox.user_id}),function(){require(["io.ox/core/api/account"],function(e){e.reload()})}),n});