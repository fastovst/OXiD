define("io.ox/core/api/quota",["io.ox/core/http","io.ox/core/capabilities","settings!io.ox/core"],function(e,t,o){"use strict";var i=Backbone.Model.extend({defaults:{quota:-1,use:0,countquota:-1,countuse:0},constructor:function(e){this.type=e,this.fetched=!1,Backbone.Model.apply(this,[])},fetch:function(){return this.fetched||"mail"===this.type&&!t.has("webmail")||"filestore"===this.type&&!t.has("infostore")?this.toJSON():e.GET({module:"quota",params:{action:"unified"===o.get("quotaMode","default")?"filestore":this.type}}).then(function(e){return this.fetched=!0,"filestore"===this.type&&o.get("properties/infostoreUsage")>0&&o.set("properties/infostoreUsage",e.use),this.set(e).toJSON()}.bind(this))}}),n=new i("mail"),u=new i("filestore"),a=!1,r={mailQuota:n,fileQuota:u,checkQuota:function(t,o){return"infostore"!==t.module?{}:e.PUT({module:"folders",params:{action:"checklimits",id:t.id,type:"filestorage"},appendColumns:!1,data:{files:o.map(function(e){return{size:e.size,name:e.name}})}}).then(function(e){return[].concat.apply(e&&e.errors||[])})},getModel:function(e){return"mail"===e?n:u},load:function(){return e.pause(),"unified"!==o.get("quotaMode","default")&&this.mailQuota.fetch(),this.fileQuota.fetch(),e.resume().then(function(){return"unified"===o.get("quotaMode","default")&&(n.fetched=!0,n.set(u.attributes)),{mail:n.toJSON(),file:u.toJSON()}})},reload:function(){n.fetched=!1,a&&(u.fetched=!1),this.load()},getAccountQuota:function(){var t=new Backbone.Collection;return function(o,i,n){var u=t.find({account_id:o.replace(/.*:\/\//,""),module:i});return u&&!1!==n?$.when(u):e.GET({module:"quota",params:{account:o,module:i}}).then(function(e){return e=e||{account_id:o.replace(/.*:\/\//,"")},e.module=i,t.add(e)})}}()};return ox.on("refresh^",function(){r.reload()}),r.requestFileQuotaUpdates=function(){a=!0},r});