define("io.ox/core/notifications/subview",["io.ox/core/extensions","io.ox/core/notifications","gettext!io.ox/core"],function(e,t,i){"use strict";function o(){return{id:"",title:"",api:null,apiEvents:null,useListRequest:!1,extensionPoints:{main:"io.ox/core/notifications/default/main",header:"io.ox/core/notifications/default/header",item:"",footer:""},showHideAllButton:!1,showHideSingleButton:!0,fullModel:!1,max:10,autoOpen:!1,desktopNotificationSupport:!0,genericDesktopNotification:{title:i("New notifications"),body:i("You have new notifications"),icon:""},specificDesktopNotification:null,hideAllLabel:""}}e.point("io.ox/core/notifications/default/main").extend({draw:function(t){var o,n=t.view,s=n.$el,l=n.model,c=l.get("api"),a=n.collection.models,d=l.get("max")||a.length,r=$('<ul class="items list-unstyled">'),h=l.get("extensionPoints"),u=l.get("showNotificationFor"),f=l.get("specificDesktopNotification"),p=this;l.set("showNotificationFor",null),s.addClass("notifications notifications-main-"+l.get("id")),e.point(h.header).invoke("draw",s,t),s.append(r),r.busy();var g=function(t,o){t?t.get||(t=new Backbone.Model(t)):t=o,String(o.get("id"))===String(u)&&require(["io.ox/core/desktopNotifications"],function(e){e.show(f(t))});var s=$('<li class="item" tabindex="0" role="menuitem">');n.model.get("showHideSingleButton")&&s.append($('<div class="notification-item-actions">').append($('<button type="button" class="btn btn-link clear-single-button fa fa-times" data-action="clear-single">').attr("aria-label",i("Hide this notification")).on("click",function(){n.hide(o)}))),s.appendTo(r),e.point(h.item).invoke("draw",s,e.Baton({view:n,model:t,requestedModel:o}))};if(c&&!l.get("fullModel"))if(l.get("useListRequest")){var m=_(a.slice(0,d)).map(function(e){return e.attributes});c.getList(m,!1).then(function(e){for(o=0;o<d&&m[o];o++)e[o]&&n.collection.get(m[o])&&g(e[o],n.collection.get(m[o]));r.idle()},function(){l.set("useListRequest",!1),s.empty(),e.point("io.ox/core/notifications/default/main").invoke("draw",p,t)})}else{var v=[];for(o=0;o<d&&a[o];o++)v.push(c.get(_.extend({},a[o].attributes,{unseen:!0})).then(_.partial(g,_,a[o]),_(n.hide).bind(n,a[o])));$.when.apply($,v).always(function(){r.idle()})}else{for(o=0;o<d&&a[o];o++)g(a[o],a[o]);r.idle()}e.point(h.footer).invoke("draw",s,t)}}),e.point("io.ox/core/notifications/default/header").extend({draw:function(e){var t=e.view.model.get("title");this.append($('<h1 class="section-title">').text(t),e.view.model.get("showHideAllButton")?$('<button type="button" class="btn btn-link clear-button fa fa-times" data-action="clear-all">').attr({"aria-label":e.view.model.attributes.hideAllLabel}):"")}});var n=Backbone.Model.extend({defaults:o()}),s=Backbone.View.extend({tagName:"div",events:{"click .notification-info":"onClick","keydown .item":"onClick",'click [data-action="clear-all"]':"hideAll"},initialize:function(e){var i=this,o=e.model.get("api"),n=e.model.get("apiEvents");this.collection=new Backbone.Collection,this.collection.subviewId=e.model.get("id"),this.hiddenCollection=new Backbone.Collection,this.placeholder=$('<div class="notification-placeholder">').css("display","none"),this.placeholderInUse=!1,t.registerSubview(this),o&&n&&(n.add&&o.on(n.add,function(){var e=arguments[0]instanceof jQuery.Event?_.rest(arguments):arguments;i.addNotifications.apply(i,e)}),n.remove&&o.on(n.remove,function(){var e=arguments[0]instanceof jQuery.Event?_.rest(arguments):arguments;i.removeNotifications.apply(i,e)}),n.reset&&o.on(n.reset,function(){var e=arguments[0]instanceof jQuery.Event?_.rest(arguments):arguments;i.resetNotifications.apply(i,e)}))},clear:function(){this.$el.empty(),this.$el.detach()},render:function(t){this.$el.empty(),this.collection.size()>0?(this.placeholderInUse?(this.placeholderInUse=!1,this.placeholder.after(this.$el),this.placeholder.detach()):0===this.$el.parents().length&&t.append(this.$el),e.point(this.model.get("extensionPoints").main).invoke("draw",t,e.Baton({view:this}))):this.placeholderInUse||(0===this.$el.parents().length?(t.append(this.placeholder),this.placeholderInUse=!0):(this.$el.after(this.placeholder),this.placeholderInUse=!0,this.$el.detach()))},hideAll:function(e){var t=this.collection.models,i=this;0!==t.length&&(this.hiddenCollection.add(t),this.collection.reset(),e&&_(t).each(function(t){setTimeout(function(e){i.hiddenCollection.remove(e),i.collection.get(e.get("id"))||i.addNotifications([e])},e,t)}))},hide:function(e,t){var i=e.id||e.get("id"),o=this.collection.get(i),n=this;o&&(this.hiddenCollection.add(o),this.collection.remove(o),_.isNumber(t)&&setTimeout(function(){n.hiddenCollection.remove(o),n.collection.get(o.get("id"))||n.addNotifications([o])},t))},responsiveRemove:function(e){var t=e.attributes||e,i=t.id,o=this.collection.get(i);if(o){this.hiddenCollection.add(o);var n=this.collection.size()>this.model.get("max");this.removeNotifications(o,!0),this.$el.find('[data-cid="'+_.cid(t)+'"]').remove(),(0===this.collection.size()||n)&&this.render(this.$el.parent()),this.trigger("responsive-remove")}},unHide:function(e){var t=e.id||e.get("id"),i=this.hiddenCollection.get(t);this.hiddenCollection.remove(i),this.collection.get(i.get("id"))||this.addNotifications(i)},checkHidden:function(e){var t=this;return _(e).filter(function(e){var i=e.id||e.get("id");return!t.hiddenCollection.get(i)})},checkNew:function(e){var t=_(e).map(function(e){return e.id}),i=_(this.collection.models).map(function(e){return e.get("id")}),o=_.difference(t,i),n=this.model;if(o.length){if(n.get("desktopNotificationSupport")){var s=n.get("genericDesktopNotification"),l=n.get("specificDesktopNotification");o.length>1||!l||!$.isFunction(l)?require(["io.ox/core/desktopNotifications"],function(e){e.show(s)}):n.set("showNotificationFor",o[0])}return!0}return!1},addNotifications:function(e,t){if(e&&(_.isArray(e)||(e=[].concat(e)),0!==e.length)){e=this.checkHidden(e);var i=this.checkNew(e,this.collection);this.collection.add(e,{silent:t}),i&&!_.device("smartphone")&&this.model.get("autoOpen")&&this.trigger("autoopen")}},removeNotifications:function(e,t){if(e&&(_.isArray(e)||(e=[].concat(e)),0!==e.length&&(1!==e.length||!e[0].id||this.collection.get(e[0])))){if(this.model.get("smartRemove")){var i=this.collection.size()>this.model.get("max");this.collection.remove(e,{silent:!0});var o=this;return _(e).each(function(e){e.get&&(e=e.attributes),o.$el.find('[data-cid="'+_.cid(e)+'"],[model-cid="'+_.cid(e)+'"]').remove()}),(0===this.collection.size()||i)&&this.render(this.$el.parent()),void this.trigger("responsive-remove")}this.collection.remove(e,{silent:t})}},resetNotifications:function(e,t){if(e=e||[],_.isArray(e)||(e=[].concat(e)),0!==this.collection.size()||0!==e.length){e=this.checkHidden(e);var i=this.checkNew(e);this.collection.reset(e,{silent:t}),i&&!_.device("smartphone")&&this.model.get("autoOpen")&&this.trigger("autoopen")}},onClick:function(e){if(!(!this.model.get("detailview")||"click"!==e.type&&13!==e.which||$(e.target).filter(".dropdown, select, a:not(.notification-info), button, .btn").length>0)){var i=13===e.which?String($(e.currentTarget).data("cid")):String($(e.currentTarget).parent().data("cid")),o=this.model.get("api"),n=t.sidepopupNode,s=this.model.get("useApiCid")?this.model.get("api").cid:_.cid,l=this;if(t.model.get("sidepopup")&&i===String(n.find("[data-cid]").data("cid")))t.closeSidepopup();else{t.closeSidepopup();var c;if(!(c=o?o.get(_.extend({},s(i),{unseen:!0})):this.collection.get(s(i)).attributes))return;_.isString(this.model.get("detailview"))?require([this.model.get("detailview")],function(e){t.openSidepopup(i,e,c,l.model.get("detailviewOptions"))}):t.openSidepopup(i,this.model.get("detailview"),c,this.model.get("detailviewOptions"))}}}});return function(e){if(e.id)return e.extensionPoints&&(e.extensionPoints=_.extend(o().extensionPoints,e.extensionPoints)),new s({model:new n(e)})}});