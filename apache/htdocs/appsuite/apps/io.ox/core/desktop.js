define("io.ox/core/desktop",["io.ox/core/event","io.ox/backbone/views/window","io.ox/core/extensions","io.ox/core/cache","io.ox/core/notifications","io.ox/core/upsell","io.ox/core/adaptiveLoader","io.ox/core/folder/api","io.ox/core/api/apps","io.ox/find/main","io.ox/core/main/icons","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,n,o,r,s,a,d,l,u,h,c){"use strict";function p(e){var t=h.get("search/modules")||[];return e=e.replace(/^io\.ox\//,"").replace(/files/,"drive"),t.indexOf(e)>-1}function f(){var e=void 0!==_.url.hash("restore")&&/^(0|false)$/i.test(_.url.hash("restore"));return void 0!==_.url.hash("restore")&&/^(1|true)$/i.test(_.url.hash("restore"))||!e&&h.get("features/storeSavePoints",!0)}var g=null,w=0,v=new n.SimpleCache("app-cache",!0),m=Backbone.Model.extend({defaults:{title:""},initialize:function(e){var t=this;this.options=e||{},this.guid=this.options.guid||w++,this.id=this.id||(this.options.refreshable?this.options.name:"")||"app-"+this.guid,this.set("path",this.options.path?this.options.path:this.getName()+"/main"),this.set("id",this.id),this.set("openInTab",this.options.openInTab),this.set("tabUrl",this.options.tabUrl),this.getInstance=function(){return t}},getName:function(){return this.get("name")},setTitle:function(e){this.set("title",e);{if(!this.options.floating)return this;this.getWindow().floating&&this.getWindow().floating.setTitle(e)}},getTitle:function(){return this.get("title")},getWindow:$.noop,saveRestorePoint:$.noop,call:$.noop});ox.ui.AppPlaceholder=m;var b={LIMIT:265e3,length:function(e){return JSON.stringify(e).length},crop:function(e,t,i){var n=b.length,r=e[i];return b.LIMIT<n(e)-n(r||"")+n(t)?(r?t=r:t.point.data={},"exceeded"in t||"io.ox/mail/compose"===t.module||(o.yell("warning",c("Failed to automatically save current stage of work. Please save your work to avoid data loss in case the browser closes unexpectedly.")),t.exceeded=!0)):delete t.exceeded,t}};return ox.ui.App=m.extend({defaults:{window:null,state:"ready",saveRestorePointTimer:null,launch:function(){return $.when()},resume:function(){return $.when()},quit:function(){return $.when()}},initialize:function(){var e=this;m.prototype.initialize.apply(this,arguments),this.set("uniqueID",_.now()+"."+String(Math.random()).substr(3,4));var t=$.proxy(this.saveRestorePoint,this);$(window).on("unload",t),this.disableRestorePointTimer||this.set("saveRestorePointTimer",setInterval(t,1e4)),this.folder=function(){var t,i,n=null,r=null,s=null,d=$.Deferred();return a.on("after:rename",function(e,t){r&&r.setTitle(t.title||"")}),t={initialized:d.promise(),unset:function(){n=null,_.url.hash("folder",null),r&&r.setTitle(""),s&&s.clear()},set:function(){function t(t,i,o,l,u){var h=_.url.hash("app")!==o;n=String(t),h||(r&&(r.setTitle(i.display_title||i.title||""),r.updateToolbar()),s&&s.prop("folder")!==n&&(s.busy().prop("folder",n),s.refresh(),a.reload(t)),_.url.hash("folder",n),e.trigger("folder:change",n,i,u)),l.resolve(i,h),"resolved"!==d.state()&&d.resolve(n,i)}return function(e,i){var o=$.Deferred();if(void 0!==e&&null!==e&&String(e)!==n){var r=_.url.hash("app"),s=a.pool.getModel(e),d=s.toJSON();s.has("title")?t(e,d,r,o,i):a.get(e).then(function(n){t(e,n,r,o,i)},function(){console.warn("Failed to change folder",e),o.reject()})}else String(e)===n?o.resolve(a.pool.getModel(e).toJSON(),!1):o.reject();return o}}(),setType:function(e){return i=e,this},setDefault:function(){return $.when().then(function(){var e=a.getDefaultFolder(i);return e?t.set(e):a.getExistingFolder(i).then(function(e){return t.set(e)},function(){return $.Deferred().reject({error:c("Could not get a default folder for this application.")})})})},isDefault:function(){return $.when().then(function(){var e=a.getDefaultFolder(i);return String(n)===String(e)})},get:function(){return n},getData:function(){if(null===n)return $.Deferred().resolve({});var e=a.pool.getModel(n);return $.Deferred().resolve(e.toJSON())},getModel:function(){return a.pool.getModel(n)},can:function(e){return null===n?$.when(!1):require(["io.ox/core/folder/api"]).then(function(t){return t.get(n).then(function(i){return t.can(e,i)})})},updateTitle:function(e){return r=e,this},updateGrid:function(e){return s=e,this},destroy:function(){t=r=s=null},handleErrors:function(){var t=_.debounce(function(t){var i=a.pool.getModel(e.folder.get());i&&a.list(i.get("folder_id"),{cache:!1}),e.folder.setDefault(),o.yell(t)},1e3,!0),i=new RegExp("(APP-0013|CON-0104|FLD-0003|FLD-0008|FLD-1004|CAL-4060|IMAP-1002|IMAP-2041|IFO-0400|FILE_STORAGE-0005|FILE_STORAGE-0055|TSK-0023)");return function(){e.listenTo(ox,"http:error",function(n,o){var r=o.params.folder||o.data.folder||n.folder||o.params.id;if(r===e.folder.get()&&("IMAP-1002"!==n.code&&"FLD-0008"!==n.code||!a.isBeingDeleted(r))&&i.test(n.code))return/(IMAP-2041|IFO-0400|APP-0013|CON-0104|TSK-0023)/.test(n.code)?a.get(e.folder.get(),{cache:!1}):void t(n)})}}()}}()},setLauncher:function(e){return this.set("launch",e),this},setResume:function(e){return this.set("resume",e),this},setQuit:function(e){return this.set("quit",e),this},setWindow:function(e){if(this.set("window",e),e.app=this,this.options.floating){var i=this.options.floatingWindowModel||new t.Model(_.extend(_(this.options).pick("closable","displayStyle","size","taskbarIcon","title","name"),{win:e}));e.floating=new t.View({el:e.nodes.outer,model:i}).render(),e.floating.listenTo(i,"quit",function(){e.app.quit().done(function(){i.trigger("close")})}),e.floating.listenTo(i,"change:active change:minimized",function(t){if(e.app.dropZone){if(!(t.get("active")&&!t.get("minimized"))&&e.app.dropZone.remove)return e.app.dropZone.remove();e.app.dropZone.include&&e.app.dropZone.include()}}),e.app.once("quit",function(){i.trigger("close")})}return this.has("name")&&e.nodes.outer.attr("data-app-name",this.get("name")),this},getWindow:function(){return this.get("window")},isFindSupported:function(){return p(this.getName())},initFind:function(){if(this.get("find"))return!0;var e=l.getApp({parent:this});return e.prepare(),this.set("find",e),e},getWindowNode:function(){return this.has("window")?this.get("window").nodes.main:$()},getWindowTitle:function(){return this.has("window")?this.get("window").getTitle():""},mediator:function(e){ox.ui.App.mediator(this.getName(),e)},mediate:function(){var e=this;return i.point(this.getName()+"/mediator").each(function(t){try{t.setup&&t.setup(e)}catch(e){console.error("mediate",t.id,e.message,e)}})},registerGlobalEventHandler:function(e,t,i){function n(){r.on(t,i)}function o(){r.off(t,i)}var r=$(e),s=this.getWindow();s.on({show:n,hide:o,quit:o}),s.state.visible&&n()},registerWindowResizeHandler:function(e){var t=this.getWindow();this.registerGlobalEventHandler(window,"resize",e),t.on("show",e),t.state.visible&&e()},setState:function(e){if(!this.options.floating&&!this.options.plugged)for(var t in e)_.url.hash(t,null!==e[t]?String(e[t]):null)},getState:function(){return _.url.hash()},launch:function(e){var n=$.when(),o=this,r=this.getName();if(this.options.floating||this.options.plugged||(r!==_.url.hash("app")&&_.url.hash({folder:null,perspective:null,id:null}),r&&_.url.hash("app",r)),"ready"===this.get("state")){this.set("state","initializing"),ox.trigger("app:init",this),_.extend(this.options,e),r&&i.point(r+"/main").invoke("launch",this,this.options);try{n=this.get("launch").call(this,this.options)||$.when()}catch(e){console.error("Error while launching application:",e.message,e,this)}n.then(function(){d.add(o),o.set("state","running"),o.trigger("launch",o),ox.trigger("app:start",o),!o.get("closable")||o.get("floating")||_.device("smartphone")||t.addNonFloatingApp(o)},function(){var e=require("settings!io.ox/core").get("autoStart");throw"none"!==e&&ox.launch(e),arguments})}else if("initializing"!==this.get("state")&&this.has("window")){this.get("window").show(),this.trigger("resume",this),ox.trigger("app:resume",this),r&&i.point(r+"/main").invoke("resume",this,e);try{n=this.get("resume").call(this,e)||$.when()}catch(e){console.error("Error while resuming application:",e.message,e,this)}$(window).trigger("resize.lazyload")}return n.then(function(){return $.Deferred().resolveWith(o,arguments)})},quit:function(e){var t,i=this;return(e?$.when():this.get("quit").call(this)||$.when()).done(function(){e&&i.destroy&&i.destroy(),i.floating||!i.getWindow()||!i.getWindow().state.visible||_.url.hash("app")&&i.getName()!==_.url.hash("app").split(":",1)[0]||_.url.hash({app:null,folder:null,perspective:null,id:null}),clearInterval(i.get("saveRestorePointTimer")),i.removeRestorePoint(),$(window).off("unload",$.proxy(i.saveRestorePoint,i)),i.folder.destroy(),i.has("window")&&((t=i.get("window")).trigger("quit"),ox.ui.windowManager.trigger("window.quit",t),t.destroy()),i.dropZone&&i.dropZone.remove&&i.dropZone.remove(),d.remove(i),i.trigger("quit"),ox.trigger("app:stop",i),i.set("state","stopped");for(var n in i)delete i[n];i=t=null})},saveRestorePoint:function(){var e=this,t=e.get("uniqueID");return this.failSave&&("io.ox/mail/compose"!==this.get("name")||h.get("features/storeMailSavePoints",!0))?ox.ui.App.getSavePoints().then(function(i){i=i||[];var n,o,r;try{n=e.failSave(),o=_(i).pluck("id"),r=_(o).indexOf(t),n&&(n.floating=e.get("floating"),n.id=t,n.timestamp=_.now(),n.version=ox.version,n.ua=navigator.userAgent,n=b.crop(i,n,r),r>-1?i.splice(r,1,n):i.push(n))}catch(t){r>-1&&(i.splice(r,1),delete e.failSave)}return i.length>0?ox.ui.App.setSavePoints(i):$.when()}):$.when()},removeRestorePoint:function(){var e=this.get("uniqueID");return ox.ui.App.removeRestorePoint(e)}}),_.extend(ox.ui.App,{mediator:function(e,t){var n=i.point(e+"/mediator"),o=0;_(t).each(function(e,t){n.extend({id:t,index:o+=100,setup:e})})},canRestore:function(){return this.getSavePoints().then(function(e){return e&&e.length>0})},cleanupSavepoints:function(){h.get("savepointCleanup",!1)||h.set("savepoints",[]).save().then(function(){h.set("savepointCleanup",ox.version).save()})},getSavePoints:function(){return f()?v.get("savepoints").then(function(e){e=e||[];var t=h.get("savepoints",[]).filter(function(e){return e.restoreById});return e=[].concat(e,t),_(e||[]).filter(function(e){var t="point"in e,i=e.ua===navigator.userAgent;return t&&(i||e.restoreById)})}):$.when([])},storeSavePoints:_.noop,setSavePoints:function(e){if(!f())return $.Deferred().resolve([]);e=e||[];var t=_(e).filter(function(e){return e.restoreById});return e=_(e).filter(function(e){return!e.restoreById}),h.set("savepoints",t),v.add("savepoints",e)},removeAllRestorePoints:function(){return this.setSavePoints([])},removeRestorePoint:function(){function e(e,t){var i=_(e).pluck("id");return e[_(i).indexOf(t)]}function t(t){_(i).each(function(n,o){e(t,o)||delete i[o]})}var i={};return function(e){var n=this;return i[e]=!0,this.getSavePoints().then(function(e){t(e=(e||[]).slice());var o=_(e).pluck("id");return _(i).each(function(t,i){var n=_(o).indexOf(i),r=e[n];if(n>-1&&e.splice(n,1),r&&r.restoreById){var s=h.get("savepoints",[]);o=_(s).pluck("id"),(n=_(o).indexOf(i))>-1&&(s.splice(n,1),h.set("savepoints",s).save())}}),n.setSavePoints(e).then(function(){return e})})}}(),restore:function(){var e=this;return this.cleanupSavepoints(),$.when(this.getSavePoints(),ox.rampup.compositionSpaces).then(function(i,n){return $.when.apply($,_([].concat(i,n||[])).map(function(i){s.stop();var n=s.startAndEnhance(i.module,[i.module+"/main"]);return ox.load(n).then(function(n){var o=n.getApp(i.passPointOnGetApp?i.point:void 0);if(_.device("!smartphone")&&(o.options.floating||o.options.closable)){var r,s;return o.options.floating?(r=new t.Model({minimized:!0,id:i.id,title:i.description,closable:!0,lazy:!0,taskbarIcon:o.options.taskbarIcon,name:o.options.name}),s=new t.TaskbarElement({model:r}).render(),t.collection.add(r)):(s=t.addNonFloatingApp(o,{lazyload:!0}),r=s.model),s.listenToOnce(r,"lazyload",function(){var t=i.id;if(i=_.clone(i),o.options.floating)return r.set(_(o.options).pick("closable","displayStyle","size","taskbarIcon","title")),void o.launch({floatingWindowModel:r}).then(function(){return i.id=this.get("uniqueID"),this.failRestore?this.failRestore(i.point):$.when()}).done(function(){e.removeRestorePoint(t).then(e.getSavePoints).then(function(t){t.push(i),!1!==i.keepOnRestore&&e.setSavePoints(t),r.get("quitAfterLaunch")&&r.trigger("quit")})}).fail(function(e){e&&"MSG-0032"===e.code&&_.delay(function(){ox.ui.App.removeRestorePoint(t),r.trigger("close")})});o.launch().then(function(){return i.id=this.get("uniqueID"),this.failRestore?this.failRestore(i.point):$.when()}).done(function(){e.removeRestorePoint(t).then(e.getSavePoints).then(function(t){t.push(i),e.setSavePoints(t)})})}),$.when()}var a=i.id;return o.launch().then(function(){if(i.id=this.get("uniqueID"),this.failRestore)return this.failRestore(i.point).then(function(){o.set("restored",!0)})}).fail(function(e){e&&"MSG-0032"===e.code&&_.delay(function(){ox.ui.App.removeRestorePoint(a)})})})})).done(function(){e.setSavePoints(i)})})},get:function(e){return d.where({name:e})},getByCid:function(e){return d.get(e)},reuse:function(e){var t=ox.ui.apps.find(function(t){return t.cid===e});return!!t&&(t.launch(),!0)},isCurrent:function(e){var t=ox.ui.App.getCurrentApp();return!(!t||t.get("name")!==(_.isString(e)?e:e.model.get("name")))},getCurrentApp:function(){return null!==g?g.app:null},getCurrentFloatingApp:function(){return _.chain(ox.ui.apps.pluck("window")).compact().map(function(e){if("io.ox/help"!==e.app.get("name"))return e.floating&&e.floating.model&&e.floating.model.get("active")?e.app:void 0}).compact().first().value()},getCurrentWindow:function(){return g}}),$("#io-ox-core").show(),window.onbeforeunload=function(){var e=d.some(function(e){return _.isFunction(e.hasUnsavedChanges)&&e.hasUnsavedChanges()});if(ox.trigger("beforeunload",e),e)return c("There are unsaved changes.")},ox.ui.createApp=function(e){if(r.visible(e.requires)&&_.device(e.device))return d.add(new ox.ui.App(e))},ox.ui.screens=function(){var t=null,i={add:function(e){return $("<div>",{id:"io-ox-"+e}).addClass("abs").hide().appendTo("#io-ox-screens")},get:function(e){return $("#io-ox-screens").find("#io-ox-"+e)},current:function(){return t},hide:function(e){this.get(e).hide(),this.trigger("hide-"+e)},show:function(e){$("#io-ox-screens").children().each(function(){var t=$(this).attr("id"),n=String(t||"").substr(6);n!==e&&"ad-skyscraper"!==n&&i.hide(n)}),this.get(e).show(),t=e,this.trigger("show-"+e)}};return e.extend(i),i}(),ox.ui.Perspective=function(){function e(e,t,i,n){var o=e.getWindow().getPerspective();o&&_.isFunction(o.save)&&o.save(),i&&(i.show(e,_.extend({perspective:t},n)),_.isFunction(i.restore)&&i.restore())}var t=function(e){this.main=$(),this.name=e,this.rendered=!1,this.render=$.noop,this.save=$.noop,this.restore=$.noop,this.afterShow=$.noop,this.afterHide=$.noop,this.show=function(t,i){var n=t.getWindow(),o=i.animation?{animation:i.animation}:{},r=this,s=i.perspective.split(":")[0];i.disableAnimations&&(o.disableAnimations=!0),i.perspective!==n.currentPerspective&&(this.main=t.pages.getPage(s),t.pages.getPageObject(s).perspective||(t.pages.getPageObject(s).perspective=this),n.addPerspective(this),"main"!==n.currentPerspective?n.trigger("change:perspective",e,i.perspective):n.trigger("change:initialPerspective",e),_.url.hash("perspective",i.perspective),this.rendered||(this.render(t,i),this.rendered=!0),t.pages.getPage(s).one("pageshow",function(){r.afterShow(t,i),n.currentPerspective=i.perspective,n.updateToolbar()}),t.pages.getCurrentPage().name===s&&(this.afterShow(t,i),n.currentPerspective=i.perspective,n.updateToolbar()),t.pages.changePage(s,o))},this.hide=function(){this.afterHide()}};return t.show=function(t,i,n){return require([t.get("name")+"/"+i.split(":")[0]+"/perspective"],function(o){e(t,i,o,n)})},t}(),ox.ui.windowManager=function(){var t=e.extend({}),i=[],n=function(){return _(i).inject(function(e,t){return e+(t.state.open?1:0)},0)};return t.getWindows=function(){return i.slice()},ox.ui.screens.on("hide-windowmanager",function(){g&&g.hide()}),t.hide=function(){ox.ui.screens.hide("windowmanager")},t.show=function(){ox.ui.screens.show("windowmanager")},t.on("window.open window.show",function(e,t){if(this.show(),i=_(i).without(t),t.options.floating?t.nodes.body.attr("role","region"):(_(i).each(function(e){e.nodes.body.removeAttr("role")}),"io.ox/settings"!==t.options.name&&t.nodes.body.attr("role","main")),i.unshift(t),i.length>1){var n=_(i).map(function(e){return e.name});v.add("windows",n||[])}}),t.on("window.beforeshow",function(){t.trigger("empty",!1)}),t.on("window.close window.quit window.pre-quit",function(e,o,r){r||(r=e.type+"."+e.namespace);var s,a,d,l=_(i).indexOf(o);if(-1!==l){for("window.quit"===r?i.splice(l,1):"window.close"!==r&&"window.pre-quit"!==r||(i=_(i).without(o)).push(o),s=0,a=i.length;s<a;s++)if((d=i[s])!==o&&d.state.open&&!d.floating){d.resume();break}v.get("windows").done(function(e){var t=_.indexOf(e,o.name);t>-1&&(e.splice(t,1),v.add("windows",e||[]))})}0===n()?v.get("windows").done(function(e){t.trigger("empty",!0,e?e[1]||null:null)}):t.trigger("empty",!1)}),t}(),ox.ui.createWindow=function(){var t=0,n=$("#io-ox-windowmanager-pane"),o=function(e){function t(e){var t=$('<div style="width: 100px; visibility: hidden; overflow-y: scroll;">').appendTo("body"),i=100-t[0].clientWidth;t.remove(),e.css("padding-right",i)}this.options=e||{},this.id=e.id,this.name=e.name||"generic",this.nodes={title:$(),toolbar:$(),controls:$(),closeButton:$(),disabled:$()},this.state={visible:!1,running:!1,open:!1},this.app=null,this.detachable=!1,this.simple=!1,this.page=e.page;var o=this.page?this.page:n,r=!1,s={},a=this,l=!0,u=$.Deferred(),c=this.name;this.updateToolbar=function(){var e=this.app&&this.app.folder?this.app.folder.get():null,t=i.Baton({window:this,$:this.nodes,app:this.app,folder:e});i.point(c+"/toolbar").invoke("draw",this.nodes.toolbar.empty(),t)},i.point(c+"/window-title").extend({id:"default",draw:function(){return $('<h1 class="window-title">').append(i.point(c+"/window-title-label").invoke("draw",this).first().value()||$())}}),i.point(c+"/window-title-label").extend({id:"default",draw:function(){return $('<span class="window-title-label">')}}),i.point(c+"/window-body").extend({id:"default",draw:function(){return this.body.append(this.main=$('<div class="abs window-content">'))}}),this.shown=u.promise(),this.setHeader=function(e){return"top"===(_.device("!desktop")?"top":h.get("features/windowHeaderPosition","bottom"))?(this.nodes.header.append(e.addClass("container")),this.nodes.outer.addClass("header-top")):(this.nodes.footer.append(e.addClass("container")),this.nodes.outer.addClass("header-bottom")),t(this.nodes.header),this.nodes.header},this.resume=function(){this.show(_.noop,!0)},this.show=function(e,t){var i=!1,n=this.app&&this.app.options.plugged;!this.floating&&!n&&g&&_.url.hash("app")&&a.name!==_.url.hash("app").split(":",1)[0]&&(i=!0),ox.trigger("change:document:title",this.app.get("title"));var r=this.nodes.outer,s=r.parent();if(i&&!t||!a||g===this&&0!==s.length)_.call(e);else{if(0===r.parent().length&&(this.floating?this.floating.open(!0):this.simple?(r.insertAfter("#io-ox-appcontrol"),document.body.style.setProperty("overflow-y","auto","important")):r.appendTo(o)),ox.ui.windowManager.trigger("window.beforeshow",a),this.trigger("beforeshow"),this.updateToolbar(),this.floating||n||_.url.hash("app")&&a.app.getName()===_.url.hash("app").split(":",1)[0]||_.url.hash("app",a.app.getName()),r.show(),null===a)return;this.floating||!g||g===a||this.page||g.hide(),this.floating||n||(g=a),_.call(e),a.state.visible=!0,a.state.open=!0,a.trigger("show"),l&&(u.resolve(),a.trigger("show:initial"),a.trigger("open"),a.state.running=!0,ox.ui.windowManager.trigger("window.open",a),ox.trigger("app:ready",a.app),l=!1),ox.ui.windowManager.trigger("window.show",a),d.trigger("resume",a.app)}return this},this.hide=function(){if(!this.floating)return this.trigger?(this.trigger("beforehide"),this.simple||this.detachable&&0===this.nodes.outer.find("iframe").length?(this.nodes.outer.detach(),$("body").css("overflowY","")):this.nodes.outer.hide(),this.state.visible=!1,this.trigger("hide"),ox.ui.windowManager.trigger("window.hide",this),g===this&&(g=null),this):this},this.toggle=function(){return g===this?this.hide():this.show(),this},this.preQuit=function(){return window.cordova||this.hide(),this.state.open=!1,this.floating&&this.floating.minimize(),ox.ui.windowManager.trigger("window.pre-quit",this),this},this.close=function(){var e=this;return this.trigger?(r&&null!==this.app?(this.trigger("beforequit"),this.app.quit().done(function(){e.state.open=!1,e.state.running=!1,e=null})):(this.hide(),this.state.open=!1,this.trigger("close"),ox.ui.windowManager.trigger("window.close",this)),this):this};this.busy=function(e,t,i){var n;return a&&(n=a.nodes.blocker,$("body").focus(),a.nodes.disabled=a.nodes.disabled.add(a.nodes.main.find('input:not([type="file"], [type="hidden"]), select, textarea, button').not(":disabled").prop("disabled",!0)),_.isNumber(e)?(e=Math.max(0,Math.min(e,1)),n.idle().find(".progress-bar").eq(0).css("width",100*e+"%").parent().show(),_.isNumber(t)?n.find(".progress-bar").eq(1).css("width",100*t+"%").parent().show():_.isString(t)&&n.find(".footer").text(t),n.show()):(n.find(".progress").hide(),n.busy().show()),_.isFunction(i)&&i.call(n),a.trigger("busy")),this},this.idle=function(){return a&&(a.nodes.blocker.find(".progress").hide().end().idle().hide().find(".header, .footer").empty(),a.nodes.disabled.prop("disabled",!1),a.nodes.disabled=$(),a.trigger("idle")),this},this.destroy=function(){return this.hide(),this.trigger("destroy"),null!==this.app&&(this.app.win=null,this.app=null),this.events.destroy(),this.show=this.busy=this.idle=$.noop,this.nodes.outer.remove(),this.nodes=a=null,this},this.setQuitOnClose=function(e){return r=!!e,this};this.getTitle=function(){return""},this.setTitle=function(e){return ox.trigger("change:document:title",[e,this.app.get("title")]),this},this.addClass=function(){var e=this.nodes.outer;return e.addClass.apply(e,arguments)},this.addButton=function(e){var t=$.extend({label:"Action",action:$.noop},e||{});return $("<div>").addClass("io-ox-toolbar-link").text(String(t.label)).on("click",t.action).appendTo(this.nodes.toolbar)},this.addPerspective=function(e){s[e.name]||(s[e.name]=e)},this.getPerspective=function(){var e=this.currentPerspective.split(":")[0];return s[e]},this.currentPerspective="main",this.setChromeless=function(e){e?(this.nodes.outer.addClass("chromeless-window"),this.nodes.body.css("left","0px")):(this.nodes.outer.removeClass("chromeless-window"),this.nodes.body.css("left",""))}};return function(n){var r=$.extend({chromeless:!1,classic:!1,id:"window-"+t,name:"",title:"",toolbar:!1,width:0,floating:!1},n),s=(String(r.width).match(/^(\d+)(px|%)$/)||["","100","%"]).splice(1),a=s[0],d=s[1],l=new o(r);return l.nodes.outer=$('<div class="window-container">').attr({id:r.id,"data-window-nr":t}),r.simple?(l.simple=!0,l.nodes.outer.addClass("simple-window").append(l.nodes.main=$('<div class="window-content" tabindex="-1">')),l.nodes.blocker=$(),l.nodes.head=$(),l.nodes.body=$()):(l.nodes.outer.append($('<div class="window-container-center">').data({width:a+d}).css({width:a+d}).append(l.nodes.blocker=$('<div class="abs window-blocker">').hide().append($('<div class="abs header">'),$('<div class="progress first"><div class="progress-bar" style="width:0"></div></div>').hide(),$('<div class="progress second"><div class="progress-bar" style="width: 0"></div></div>').hide(),$('<div class="abs footer">')),l.nodes.header=$('<div class="window-header">'),l.nodes.sidepanel=$('<div class="window-sidepanel collapsed">'),l.nodes.body=$('<div class="window-body">'),l.nodes.footer=$('<div class="window-footer">')).on("controller:quit",function(){l.app&&l.app.quit()})),r.classic&&l.nodes.outer.addClass("classic"),r.name&&l.nodes.outer.addClass(r.name.replace(/[./]/g,"-")+"-window"),i.point(r.name+"/window-body").invoke("draw",l.nodes)),e.extend(l),r.search&&console.warn("search is deprecated with 7.6.0. Please use io.ox/find instead"),r.facetedsearch&&console.warn("io.ox/search is deprecated with 7.8.0. Please use io.ox/find instead"),r.find&&p(r.name)&&(i.point("io.ox/find/view").extend({id:"view",index:100,draw:function(e){e.$.viewnode=$('<div class="generic-toolbar top io-ox-find" role="search">'),this.nodes.sidepanel.append(e.$.viewnode).addClass("top-toolbar")}}),i.point("io.ox/find/view").extend({id:"subviews",index:200,draw:function(e){e.$.viewnode.append($('<div class="sr-only arialive" role="status" aria-live="polite">'),e.$.box=$('<form class="search-box">'),e.$.boxfilter=$('<div class="search-box-filter">'))}}),i.point("io.ox/find/view").extend({id:"form",index:300,draw:function(e){_.extend(e.data,{label:c("Search"),id:_.uniqueId("search")}),e.$.group=$('<div class="form-group has-feedback">').append($('<input type="text" class="form-control has-feedback search-field tokenfield-placeholder f6-target">').attr({"aria-labelledby":e.data.id,placeholder:e.data.label+"..."})),e.$.box.append(e.$.group)}}),i.point("io.ox/find/view").extend({id:"buttons",index:400,draw:function(e){e.$.group.append($('<button type="button" class="btn btn-link form-control-feedback action action-show" data-toggle="tooltip" data-placement="bottom" data-animation="false" data-container="body">').attr({"data-original-title":c("Start search"),"aria-label":c("Start search"),id:e.data.id}).append($('<i class="fa fa-search" aria-hidden="true">')).tooltip(),$('<button type="button" class="btn btn-link form-control-feedback action action-cancel" data-toggle="tooltip" data-placement="bottom" data-animation="false" data-container="body">').attr({"data-original-title":c("Cancel search"),"aria-label":c("Cancel search")}).append($('<i class="fa fa-times-circle" aria-hidden="true">')).tooltip())}}),i.point("io.ox/find/view").invoke("draw",l,i.Baton.ensure({}))),r.chromeless&&l.setChromeless(!0),t++,l}}(),ox.load=function(){function e(){var e=setTimeout(function(){ox.busy(!0),o=setTimeout(function(){if(!s[0].firstChild){var i=$('<button type="button" class="btn btn-primary">').text(c("Cancel")).fadeIn();i.on("click",function(){n.reject(!0),t(e)}),s.append(i),i.focus()}},5e3)},1e3);return e}function t(e){clearTimeout(e),clearTimeout(o),e=null,o=null,setTimeout(function(){null===e&&ox.idle()},0)}function i(e){r.always(function(){t(e)})}var n,o,r,s=$("#background-loader");return function(t,o){assert(arguments.length<=1||2===arguments.length&&!_.isFunction(o),"ox.load does not support callback params."),n=$.Deferred(),r=o&&o.launched?o.launched:$.Deferred().resolve(),s.hasClass("secure")||ox.busy();var a=e();return require(t).always(i(a)).then(n.resolve,function(e){if(console.error(e),n.reject(!1),_.isArray(t))for(var i=0;i<t.length;i++)requirejs.undef(t[i])}),n}}(),ox.launch=function(e,t){var i=$.Deferred(),n=Date.now();if(_.isString(e)){s.stop();var r=s.startAndEnhance(e.replace(/\/main$/,""),[e]);ox.load(r,t).then(function(o){if(!o||!o.getApp)return console.error("Couldn't launch app",e,o),void i.resolve({});o.getApp(t).launch(t).done(function(){i.resolveWith(this,arguments),ox.trigger("loadtime",{app:this,id:e,loadStart:n,loadEnd:Date.now()})})},function(){o.yell("error",c("Failed to start application. Maybe you have connection problems. Please try again.")),requirejs.undef(e)})}else i.resolve({});return i},d.on("resume",function(e){s.stop(),s.listen(e.get("name"))}),ox.ui});