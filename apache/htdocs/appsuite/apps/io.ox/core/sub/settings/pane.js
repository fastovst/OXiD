define("io.ox/core/sub/settings/pane",["io.ox/core/extensions","io.ox/core/sub/model","io.ox/backbone/views","io.ox/core/folder/api","io.ox/core/folder/breadcrumb","io.ox/core/tk/dialogs","io.ox/core/yell","io.ox/core/capabilities","gettext!io.ox/core/sub","less!io.ox/core/sub/style"],function(e,t,i,n,s,o,a,r,l){"use strict";function d(e,t,i){t.preventDefault();var n=i.attr("data-cid"),s=_.cid(n);e.busy(),ox.debug&&console.error("No clue how to get here.",n,s)}function c(e,t){function i(e){e.preventDefault(),$(this).closest(".alert").remove(),y={},t.$el.empty(),t.render()}if(!e)return $();var s=$('<div class="alert alert-info sub settings">');return n.path(e).done(function(e){var t=_(e).pluck("title").join("/");s.append($('<div class="folder">').text(l('Only showing items related to folder "%1$s"',t)),$('<a href="#" class="remove-filter" data-action="remove-filter">').text(l("Show all items")).on("click",i))}),s}function u(e){var t,i;return t=e.has("folder")?e.get("folder"):e.get("entity").folder,i=new s({folder:t,exclude:["9"],notail:!0,isLast:!0}),i.handler=function(e,t){"contacts"!==t&&"calendar"!==t?ox.launch("io.ox/files/main",{folder:e}).done(function(){this.folder.set(e)}):ox.launch("io.ox/"+t+"/main",{folder:e}).done(function(){this.folder.set(e)})},i.render().$el}function p(e){if(e)return(e=e.match(D))?e[1]:""}function f(e){return e.replace(R,"...")}function h(e){return p(e.displayName)||e.displayName||l("Unnamed subscription")}function b(e){return b.needsWarning[e.source]}function m(e){return b(e)?$('<span class="text-warning"></span>').text(l("Note: Refreshing this subscription will replace the calendar content with the external content. Changes you have made inside appsuite will be overwritten")):$()}function v(){this.render()}function g(){this.remove()}function x(e){return new C({model:e})}function w(e,t,i){function n(){var e=0===(d=t.forFolder(y)).length,n=!!y.folder,s=k.isPublished&&"publication"===i,o=k.isSubscribed&&"subscription"===i;if(e&&(s||o)){if(s)return l("This folder has publications but you are not allowed to view or edit them");if(o)return l("This folder has subscriptions but you are not allowed to view or edit them")}return e?l(n?"publication"===i?"This folder has no publications":"This folder has no subscriptions":"publication"===i?"You don't have any publications yet":"You don't have any subscriptions yet"):""}function s(){(a=n())&&e.append(o=$('<li class="empty">').text(a+"."))}var o,a,d=t.forFolder(y);r.has(i)&&(_.each(d,function(t){e.append(x(t).render().el)}),t.on("add",function(t,i){var n=_.chain(i.forFolder(y)).map(function(e){return e.id}).indexOf(t.id).value();if(!(n<0)){var s=x(t).render().el;o&&o.remove(),0===n?e.prepend(s):e.children("li:nth-child("+i.indexOf(t)+")").after(s)}}),t.on("remove",function(e,t){0===t.length&&s()}),s())}var y,k,N=i.point("io.ox/core/sub/settings/list"),S=N.createView({className:"sub settings"});e.point("io.ox/core/sub/settings/detail").extend({index:100,id:"extensions",draw:function(e){var i=e.options.data?e.options.data.id:void 0;y={folder:i},k={isPublished:n.is("published",e.options.data||{}),isSubscribed:n.is("subscribed",e.options.data||{})};var s=new S({subscriptions:t.subscriptions()});this.append($('<h1 class="pane-headline">').text(e.data.title),c(i,s),s.render().$el),(new o.SidePopup).delegate(this,".file-detail-link",d)}});var D=/^http[^?]+\/(\w+)\?/,R=/\?secret=.+$/,T=function(e){return"com.openexchange.subscribe.socialplugin.linkedin"in e?"http://www.linkedin.com":"target"in e?(e[e.target]||{}).url||"":"source"in e?(e[e.source]||{}).url||"":""};b.needsWarning={"com.openexchange.subscribe.crawler.google.calendar":!0},e.point("io.ox/core/sub/settings/list/itemview").extend({id:"itemview",draw:function(e){var t,i=e.model.toJSON(),n="com.openexchange.subscription.fallback"===i.source,s=i.enabled,o=T(i),a=f(o),r=h(i)||"Â ";this[s?"removeClass":"addClass"]("disabled"),n&&this.addClass("broken disabled"),i.source&&"ready"===e.model.refreshState()?(t=$('<a href="#" class="action" data-action="refresh">').attr({"aria-label":r+", "+l("Refresh")}).text(l("Refresh")),b(i)&&t.addClass("text-error")):i.source&&"pending"!==e.model.refreshState()&&(t=$("<span>")),this.addClass("widget-settings-view").append($('<div class="widget-controls">').append(s?t:"",i.source?$('<a href="#" class="action" data-action="toggle">').attr({"aria-label":r+", "+l(s?"Disable":"Enable")}).text(l(s?"Disable":"Enable")):"",$('<a href="#" role="button" class="remove" data-action="remove">').attr({title:l("Delete"),"aria-label":r+", "+l("Delete")}).append($('<i class="fa fa-trash-o" aria-hidden="true">'))),$('<span class="content">').append($('<span data-property="displayName" class="list-title pull-left">').text(r),$('<div class="url">').addClass(a?"":"empty").append(s?$('<a target="_blank">').attr("href",o).text(a):$("<i>").text(a)),u(e.model),m(i))),i.source&&"pending"===e.model.refreshState()&&this.find(".name").append($('<i class="fa fa-refresh fa-spin" aria-hidden="true">'))}});var C=Backbone.View.extend({tagName:"li",className:"",initialize:function(){this.listenTo(this.model,"change",v),this.listenTo(this.model,"remove",g)},events:{'click [data-action="toggle"]':"onToggle",'click [data-action="refresh"]':"onRefresh",'click [data-action="remove"]':"onRemove"},render:function(){var t=e.Baton({model:this.model,view:this});return e.point("io.ox/core/sub/settings/list/itemview").invoke("draw",this.$el.empty(),t),this},onToggle:function(e){var t=this.model;e.preventDefault(),t.set("enabled",!t.get("enabled"),{validate:!0}).save().fail(function(){t.set("enabled",!t.get("enabled"),{validate:!0})}),this.render()},onRefresh:function(t){var i=e.Baton({model:this.model,view:this});t.preventDefault(),a({type:"info",headline:l("Subscription refresh"),message:l("A refresh takes some time, so please be patient, while the refresh runs in the background. Only one refresh per subscription and per session is allowed.")}),this.model.performRefresh().done(function(){i.view.render()}),i.view.render()},onRemove:function(e){e.preventDefault(),this.model.destroy().done(function(){n.refresh()})},close:function(){this.stopListening()}});N.extend({id:"content",render:function(){var e=this.baton,t=r.has("publication")&&r.has("subscription");r.has("publication")&&(this.$el.append($("<fieldset>").append(t?$('<legend class="pane-headline sectiontitle">').text(l("Publications")):$(),e.pubListNode=$('<ul class="list-unstyled publications list-group widget-list">'))),w(e.pubListNode.empty(),e.publications,"publication")),r.has("subscription")&&(this.$el.append($("<fieldset>").append(t?$('<legend class="pane-headline sectiontitle">').text(l("Subscriptions")):$(),e.subListNode=$('<ul class="list-unstyled subscriptions list-group widget-list">'))),w(e.subListNode.empty(),e.subscriptions,"subscription"))}})});