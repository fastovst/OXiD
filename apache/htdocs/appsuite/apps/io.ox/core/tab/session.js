define("io.ox/core/tab/session",["io.ox/core/boot/util"],function(e){"use strict";function o(){require("io.ox/core/api/tab").disable()}function s(){i.events.listenTo(i.events,"getSession",function(e){var o=require("io.ox/core/api/tab");o.propagate("propagateLogin",_.extend(e,{exceptWindow:o.getWindowName(),storageKey:o.DEFAULT_STORAGE_KEYS.SESSION}))}),i.events.listenTo(i.events,"propagateLogin",function(e){(ox.signin||t(e))&&require(["io.ox/core/boot/login/tabSession"],function(o){o(e)})})}function t(e){var o=ox.user_id===e.user_id&&ox.user===e.user&&ox.context_id===e.context_id;return e.relogin&&o}var i,n=!1;return i={events:_.extend({},Backbone.Events),propagateGetSession:function(){if(!ox.session){var e,o=window.name||JSON.stringify({}),s=require("io.ox/core/api/tab");try{e=JSON.parse(o)}catch(o){e={},ox.debug&&console.warn("TabSession.propagateGetSession",o)}finally{if(e.loggingOut)delete e.loggingOut,window.name=JSON.stringify(e);else{var t={};_.url.hash("session")&&_.extend(t,{session:_.url.hash("session")}),s.propagate("getSession",{parameters:t,exceptWindow:s.getWindowName(),storageKey:s.DEFAULT_STORAGE_KEYS.SESSION})}}}},login:function(){var e,s=$.Deferred();return _.url.hash("serverToken")&&_.url.hash("clientToken")?s.reject():(this.propagateGetSession(),e=setTimeout(function(){s.reject()},50),this.events.listenTo(i.events,"propagateSession",function(e){_.url.hash("session")&&e.session!==_.url.hash("session")?(o(),s.reject()):s.resolve(e)}),s.done(function(){window.clearTimeout(e)}))},propagateSession:function(e){var o=require("io.ox/core/api/tab");ox.session&&ox.user&&ox.user_id?e.session&&e.session!==ox.session||o.propagate("propagateSession",{session:ox.session,language:ox.language,theme:ox.theme,user:ox.user,user_id:ox.user_id,context_id:ox.context_id,exceptWindow:o.getWindowName(),storageKey:o.DEFAULT_STORAGE_KEYS.SESSION}):o.propagate("propagateNoSession",{exceptWindow:o.getWindowName(),storageKey:o.DEFAULT_STORAGE_KEYS.SESSION})},handleListener:function(e){switch(e.propagate){case"getSession":this.propagateSession(e.parameters);break;case"propagateSession":this.events.trigger(e.propagate,e.parameters);break;case"propagateNoSession":this.events.trigger(e.propagate);break;case"propagateLogout":if(ox.signin)return;this.events.trigger("before:propagatedLogout"),require("io.ox/core/main").logout({force:!0,skipSessionLogout:!0,autologout:e.parameters&&e.parameters.autologout});break;case"propagateLogin":if(ox.session&&!t(e.parameters))return;this.events.trigger(e.propagate,e.parameters)}}},e.checkTabHandlingSupport()&&!n&&Modernizr.localstorage&&(s(),n=!0),i});