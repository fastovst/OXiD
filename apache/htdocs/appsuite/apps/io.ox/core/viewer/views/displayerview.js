define("io.ox/core/viewer/views/displayerview",["io.ox/files/api","io.ox/core/viewer/views/types/typesregistry","io.ox/backbone/views/disposable","io.ox/core/viewer/util","static/3rd.party/swiper.js","static/3rd.party/bigscreen.min.js","settings!io.ox/files","gettext!io.ox/core","css!3rd.party/swiper/swiper.css"],function(e,i,t,s,n,o,l,a){"use strict";function r(){var e="loopendlessly"===String(l.get("autoplayLoopMode")).toLowerCase();d=!e,h=1e3*Number(l.get("autoplayPause")),isFinite(h)||(h=5e3)}var d,h,c=[.5,.75,1,1.25,1.5,2,3,4],u=_.last(c),p=_.first(c);return t.extend({className:"viewer-displayer",attributes:{role:"main"},events:{"click a.fullscreen-button":"toggleFullscreen"},initialize:function(i){_.extend(this,i),this.captionTimeoutId=null,this.navigationTimeoutId=null,this.slideViews=[],this.slideDuplicateViews={},this.loadedSlides=[],this.preloadOffset=3,this.slidesToCache=7,this.swiper=null,this.lastSwiperZoomMode=null,this.fullscreen=!1,this.fullscreenPromise=$.when(),this.canAutoplayImages=!1,this.autoplayMode="",this.autoplayStarted=!1,this.autoplayStopAtIndex=!1,this.sidebarBeforeFullscreen=null,this.listenTo(this.viewerEvents,"viewer:blendcaption",this.blendCaption),this.listenTo(this.viewerEvents,"viewer:blendnavigation",this.blendNavigation),this.listenTo(this.viewerEvents,"viewer:zoom:in:swiper",this.onZoomIn),this.listenTo(this.viewerEvents,"viewer:zoom:out:swiper",this.onZoomOut),this.listenTo(this.collection,"change:version",this.onModelChangeVersion.bind(this)),this.listenTo(this.viewerEvents,"viewer:display:version",this.onDisplayVersion.bind(this)),this.listenTo(this.viewerEvents,"viewer:autoplay:toggle",this.handleToggleAutoplayMode.bind(this)),this.listenTo(e,"remove:file",this.onFileRemoved.bind(this)),this.displayerviewMousemoveClickHandler=_.throttle(this.blendNavigation.bind(this),500),this.$el.on("mousemove click",this.displayerviewMousemoveClickHandler),this.$el.on("dblclick",".viewer-displayer-item-container",this.onToggleZoom.bind(this)),this.updateModelAndDisplayVersionDebounced=_.debounce(this.updateModelAndDisplayVersion.bind(this),100),o.onchange=this.onChangeFullScreen.bind(this),o.onerror=this.onFullScreenError.bind(this)},initializeAutoplayImageModeData:function(){var e=this.collection.models.reduce(function(e,i){return i.isImage()&&(e[i.attributes.id]=i),e},{});Object.keys(e).length>=2&&(this.canAutoplayImages=!0,this.imageFileRegistry=e)},render:function(e){if(!e)return console.error("Core.Viewer.DisplayerView.render(): no file to render"),!1;var i,t=this,s=$('<div id="viewer-carousel" class="swiper-container" role="listbox">'),o=$('<div class="swiper-wrapper">'),l=$('<a href="#" role="button" class="swiper-button-prev swiper-button-control left" aria-controls="viewer-carousel"><i class="fa fa-angle-left" aria-hidden="true"></i></a>'),d=$('<a href="#" role="button" class="swiper-button-next swiper-button-control right" aria-controls="viewer-carousel"><i class="fa fa-angle-right" aria-hidden="true"></i></a>'),h=$('<div class="viewer-displayer-caption">'),c=this.collection.getStartIndex(),f={loop:!this.standalone&&this.collection.length>1,loopedSlides:0,followFinger:!1,simulateTouch:!1,noSwiping:!0,speed:0,initialSlide:c,runCallbacksOnInit:!1,zoom:{maxRatio:u,minRatio:p,toggle:!1,containerClass:"viewer-displayer-item-container"},navigation:{nextEl:d[0],prevEl:l[0]},on:{slideChangeTransitionStart:this.onSlideChangeStart.bind(this),slideNextTransitionEnd:this.onSlideNextChangeEnd.bind(this),slidePrevTransitionEnd:this.onSlidePrevChangeEnd.bind(this),touchEnd:this.hideCaption.bind(this)}};return(_.device("smartphone")||_.device("tablet"))&&(f=_.extend(f,{followFinger:!0,simulateTouch:!0,speed:300,spaceBetween:100})),l.attr({title:a("Previous"),"aria-label":a("Previous")}),d.attr({title:a("Next"),"aria-label":a("Next")}),s.attr("aria-label",a("Use left/right arrow keys to navigate and escape key to exit the viewer.")),s.append(o),this.collection.length>1&&(s.append(l,d),this.initializeAutoplayImageModeData(),this.canAutoplayImages&&(i=$('<a href="#" role="button" class="fullscreen-button"><i class="fa fa-arrows-alt" aria-hidden="true"></i></a>'),s.append(i),r())),this.$el.append(s,h),this.carouselRoot=s,t.swiper=new n(t.carouselRoot[0],f),this.createSlides().then(this.createDuplicateSlides.bind(this)).then(function(){t.disposed||(t.carouselRoot.removeClass("initializing"),t.swiper.slideTo(c+1,0,!1),t.loadSlide(c,"both"),t.swiper.autoplay.stop(),t.blendSlideCountCaption(),t.blendNavigation(),t.focusActiveSlide(),t.handleInitialStateForEnabledAutoplayMode())}).fail(function(){console.warn("DisplayerView.createSlides() - some errors occured:",arguments)}),this.$el.append($('<div class="bottom toolbar">')),this},createView:function(e,t){var s={model:e,collection:this.collection,viewerEvents:this.viewerEvents};return this.app&&(s.app=this.app),t&&t.el&&(s.el=t.el),i.getModelType(e).then(function(e){return new e(s).render()},function(){return a("Cannot require a view type for %1$s",e.get("filename"))})},createSlides:function(){var e,i=this,t=[];return this.collection.each(function(e){t.push(i.createView(e))}),e=$.when.apply(null,t),e=e.then(function(){i.slideViews=[].slice.call(arguments),i.swiper.appendSlide(_.pluck(arguments,"el"))})},createDuplicateSlides:function(){var e,i=this,t=[];return this.$el.find(".swiper-slide-duplicate").each(function(e,s){var n=$(s).data("swiper-slide-index"),o=i.collection.at(n),l=i.createView(o,{el:s});l=l.then(function(e){return{view:e,index:n}}),t.push(l)}),e=$.when.apply(null,t),e=e.then(function(){i.slideDuplicateViews={},_.each(arguments,function(e){i.slideDuplicateViews[e.index]=e.view})})},getSlideLoadRange:function(e,i,t){function s(){return _.range(e,e-(i+1),-1).sort(function(e,i){return e-i})}function n(){return _.range(e,e+i+1,1)}var o;switch(e=e||0,t){case"left":o=s();break;case"right":o=n();break;case"both":o=_.union(s(),n());break;default:o=[e]}return _(o).chain().map(this.normalizeSlideIndex.bind(this)).uniq().value()},loadSlide:function(e,i){var t,s=this,n=this.isActiveSlideDuplicate();e=e||0,t=this.getSlideLoadRange(e,this.preloadOffset,i),_.each(t,function(e){var i;s.isSlideLoaded(e)||(i={priority:s.getPrefetchPriority(e)},s.slideViews[e].prefetch(i),s.slideDuplicateViews[e]&&s.slideDuplicateViews[e].prefetch(i),s.loadedSlides.push(e))}),n&&this.slideDuplicateViews[e]?this.slideDuplicateViews[e].show():this.slideViews[e].show()},getPrefetchPriority:function(e){var i=this.collection.length,t=Math.abs(this.swiper.realIndex-e);return Math.max(1,t<i/2?t:i-t)},isSlideLoaded:function(e){return _.contains(this.loadedSlides,e)},onModelChangeVersion:function(e){this.updateModelAndDisplayVersionDebounced(e)},updateModelAndDisplayVersion:function(i){e.get(i.toJSON(),{cache:!1}).then(function(){this.displayVersion(i)}.bind(this))},onDisplayVersion:function(e){if(e){var i=e.id,t=e.folder_id,s=e.last_modified,n=moment().isSame(moment(s),"day"),o=this.collection.find(function(e){return e.get("id")===i&&e.get("folder_id")===t}),l=s?moment(s).format(n?"LT":"l LT"):"-";this.displayVersion(o,e),this.blendCaption(a("Version of %1$s",l),5e3)}},displayVersion:function(i,t){function s(e,i){if(i&&i.length)for(var t,s=0;s<i.length;s++)t=i.item(s),e.setAttribute(t.name,t.value)}if(i){var n,o,l=this,a=this.collection.indexOf(i),r=this.slideViews[a],d=r.isPrefetched,h=r.el,c=h&&h.attributes,u=this.slideDuplicateViews[a],p=Boolean(u&&u.isPrefetched),f=u&&u.el||null,w=f&&f.attributes,v=Boolean(u&&this.isActiveSlideDuplicate()),g=t?new e.Model(t):i;r.unload().dispose(),n=this.createView(g,{el:h}).then(function(e){l.disposed||(s(e.el,c),d&&e.prefetch({priority:1}),l.slideViews[a]=e)}),u?(u.unload().dispose(),o=this.createView(g,{el:f}).then(function(e){l.disposed||(s(e.el,w),p&&e.prefetch({priority:1}),l.slideDuplicateViews[a]=e)})):o=$.when(),$.when(n,o).then(function(){l.disposed||(v?l.slideDuplicateViews[a].show():l.slideViews[a].show())})}},blendCaption:function(e,i){i=i||3e3;var t=this.$el.find(".viewer-displayer-caption"),s=$('<div class="caption-content">').text(e);t.empty().append(s),window.clearTimeout(this.captionTimeoutId),t.show(),this.captionTimeoutId=window.setTimeout(function(){t.fadeOut()},i)},blendSlideCountCaption:function(e){var i=this.collection.length,t=this.swiper?this.swiper.realIndex:this.collection.getStartIndex();i>1&&this.blendCaption(a.ngettext("%1$d of %2$d item","%1$d of %2$d items",i,t+1,i),e)},hideCaption:function(){var e=this.$el.find(".viewer-displayer-caption");window.clearTimeout(this.captionTimeoutId),e.hide()},blendNavigation:function(){var e,i;return function(t){if(t&&"mousemove"===t.type){if(t.clientX===e&&t.clientY===i)return;e=t.clientX,i=t.clientY}if(this.$el){var s=this.$el.find(".swiper-button-control"),n=this.$el.find(".fullscreen-button");window.clearTimeout(this.navigationTimeoutId),s.show(),n.toggle(this.fullscreen),this.navigationTimeoutId=window.setTimeout(function(){var e=s.add(n);_.each(e,function(e){var i=$(e);i.is(":not(:hover)")&&i.fadeOut()})},3e3)}}}(),isActiveSlideDuplicate:function(){return this.getActiveSlideNode().hasClass("swiper-slide-duplicate")},focusActiveSlide:function(){this.swiper.slides.removeAttr("tabindex").attr({"aria-selected":"false"}),this.getActiveSlideNode().attr({tabindex:0,"aria-selected":"true"}).visibleFocus()},getActiveSlideNode:function(){if(!this.swiper||!this.swiper.slides)return $();var e=this.swiper.slides[this.swiper.activeIndex];return e?$(e):$()},getPreviousSlideNode:function(){if(!this.swiper||!this.swiper.slides||!_.isNumber(this.swiper.previousIndex))return $();var e=this.swiper.slides[this.swiper.previousIndex];return e?$(e):$()},normalizeSlideIndex:function(e){var i=this.collection.length;return e<0?(e+=i)<0&&(e=0):e>=i&&(e%=i),e},setZoomLevel:function(e){function i(){var e=document.activeElement,t=n.getActiveSlideNode();n.getActiveSlideNode().blur(),o.off("transitionend",i),n.focusActiveSlide(),_.defer(function(){t.is(e)||e.focus()})}if(this.swiper&&this.swiper.zoom.enabled){var t=parseFloat(this.swiper.zoom.scale,10);if((e=s.minMax(e,p,u))!==t){var n=this,o=this.getActiveSlideNode().find(".viewer-displayer-item-container");this.lastSwiperZoomMode=e>t?"zoom_in":"zoom_out",_.device("safari && macos")&&o.on("transitionend",i),1===e?this.swiper.zoom.out():(o.attr("data-swiper-zoom",String(e)),this.swiper.zoom.in(),o.removeAttr("data-swiper-zoom")),this.blendCaption(Math.round(100*e)+" %")}}},onZoomIn:function(){if(this.swiper&&this.swiper.zoom.enabled){var e=parseFloat(this.swiper.zoom.scale,10),i=_.find(c,function(i){return i>e})||u;this.setZoomLevel(i)}},onZoomOut:function(){if(this.swiper&&this.swiper.zoom.enabled){var e=parseFloat(this.swiper.zoom.scale,10),i=_.findLastIndex(c,function(i){return i<e}),t=c[i]||p;this.setZoomLevel(t)}},onToggleZoom:function(){if(this.swiper&&this.swiper.zoom.enabled){var e,i=parseFloat(this.swiper.zoom.scale,10);switch(this.lastSwiperZoomMode){case"zoom_in":e=i>1?1:u;break;case"zoom_out":default:e=i<1?1:u}this.setZoomLevel(e)}},onSlideChangeStart:function(){var e,i=this.getPreviousSlideNode(),t=parseInt(i.data("swiper-slide-index"),10),s=this.slideViews[t];s&&(e=s.$el.scrollTop(),s.pdfDocument&&s.setInitialScrollPosition(s.model.get("id"),e))},onSlideNextChangeEnd:function(){this.onSlideChangeEnd("right")},onSlidePrevChangeEnd:function(){this.onSlideChangeEnd("left")},onSlideChangeEnd:function(e){var i=this.getActiveSlideNode(),t=this.getPreviousSlideNode();"running"!==this.autoplayMode?(this.blendSlideCountCaption(),this.blendNavigation()):d&&this.autoplayStopAtIndex===this.swiper.realIndex&&this.toggleFullscreen(),this.lastSwiperZoomMode=null,this.loadSlide(this.swiper.realIndex,e),i.attr({"aria-selected":"true",tabindex:0}),t.removeAttr("tabindex").attr({"aria-selected":"false"}),t.find("audio, video").each(function(){this.pause()}),this.viewerEvents.trigger("viewer:displayeditem:change",this.collection.at(this.swiper.realIndex)),this.unloadDistantSlides(this.swiper.realIndex),this.focusActiveSlide()},onFileRemoved:function(e){var i=this,t=this.swiper.realIndex,s=_.filter(e,function(e){var t=e.cid||_.cid(e);return!!i.collection.get(t)});_.isEmpty(s)||(this.collection.remove(s),this.swiper.removeAllSlides(),this.slideViews=[],this.slideDuplicateViews={},this.loadedSlides=[],this.collection.isEmpty()?this.viewerEvents.trigger("viewer:close"):this.createSlides().then(this.createDuplicateSlides.bind(this)).then(function(){if(!i.disposed){var e=i.collection.length,s=t>=e?e-1:t;i.viewerEvents.trigger("viewer:displayeditem:change",i.collection.at(s)),i.swiper.slideTo(s+1,0,!1),i.loadSlide(s,"both")}}))},onAutoplayStart:function(){if(this.swiper){var e={autoplay:{delay:h,disableOnInteraction:!1}},i=this,t=Object.keys(this.imageFileRegistry).map(function(e){return i.imageFileRegistry[e]}),s=i.collection.models[i.swiper.realIndex].get("id");this.collectionBackup=this.collection.clone(),this.collection.reset(t);var n=_.findIndex(t,function(e){return e.attributes.id===s});this.slideViews=[],this.slideDuplicateViews={},this.loadedSlides=[],this.swiper.removeAllSlides(),this.createSlides().then(this.createDuplicateSlides.bind(this)).then(function(){i.disposed||(i.carouselRoot.removeClass("initializing"),i.swiper.slideTo(n+1,0,!1),i.loadSlide(n,"both"),d&&(i.autoplayStopAtIndex=i.normalizeSlideIndex(i.swiper.realIndex-1)),_.extend(i.swiper.params,e),i.swiper.autoplay.start(),i.autoplayStarted=!0,i.viewerEvents.trigger("viewer:autoplay:state:changed",{autoplayStarted:i.autoplayStarted}))})}},onAutoplayStop:function(){if(this.swiper){var e=this;this.autoplayStarted=!1,this.swiper.autoplay.stop(),this.autoplayStopAtIndex=!1,this.viewerEvents.trigger("viewer:autoplay:state:changed",{autoplayStarted:this.autoplayStarted});var i=e.collection.models[e.swiper.realIndex];if(this.collectionBackup.length){this.swiper.removeAllSlides(),this.collection.reset(this.collectionBackup.models);var t=this.collection.indexOf(i);this.collectionBackup=!1,this.slideViews=[],this.slideDuplicateViews={},this.loadedSlides=[],this.createSlides().then(this.createDuplicateSlides.bind(this)).then(function(){e.disposed||(e.carouselRoot.removeClass("initializing"),e.swiper.slideTo(t+1,0,!1),e.loadSlide(t,"both"),e.autoplayStarted=!1)})}}},hasAutoplayStartAlreadyBeenTriggered:function(){return this.autoplayStarted},handleToggleAutoplayMode:function(e){"pausing"===(e=("running"===e||"pausing"===e)&&e||"pausing"===this.autoplayMode&&"running"||"running"===this.autoplayMode&&"pausing"||"pausing")?this.hasAutoplayStartAlreadyBeenTriggered()&&(this.fullscreen?this.toggleFullscreen(!1):this.onAutoplayStop()):this.toggleFullscreen(!0).then(function(){this.onAutoplayStart(),this.$el.focus()}.bind(this)),this.autoplayMode=e},handleInitialStateForEnabledAutoplayMode:function(){this.canAutoplayImages&&!this.hasAutoplayStartAlreadyBeenTriggered()&&this.handleToggleAutoplayMode("pausing")},toggleFullscreen:function(e){return!o.enabled||_.device("iOS")||_.isBoolean(e)&&e===this.fullscreen?this.fullscreenPromise=$.when():(this.fullscreenPromise=$.Deferred(),_.isBoolean(e)?e?o.request(this.carouselRoot[0]):o.exit():o.toggle(this.carouselRoot[0])),this.fullscreenPromise},onFullScreenError:function(){this.fullscreenPromise.resolve()},onChangeFullScreen:function(e){_.isNull(e)?(this.fullscreen=!1,this.$el.removeClass("fullscreen-mode"),this.handleToggleAutoplayMode("pausing"),this.$el.focus(),this.isSidebarOpen()!==this.sidebarBeforeFullscreen&&this.viewerEvents.trigger("viewer:toggle:sidebar")):e===this.carouselRoot[0]&&(this.fullscreen=!0,this.$el.addClass("fullscreen-mode"),this.sidebarBeforeFullscreen=this.isSidebarOpen(),this.sidebarBeforeFullscreen&&this.viewerEvents.trigger("viewer:toggle:sidebar")),_.defer(function(){this.fullscreenPromise.resolve()}.bind(this))},isSidebarOpen:function(){return this.$el.parent().find(".viewer-sidebar.open").length>0},unloadDistantSlides:function(e){var i=this,t=this.getSlideLoadRange(e,this.preloadOffset,"both"),s=_.difference(i.loadedSlides,t);_.each(s,function(e){i.slideViews[e].unload(),i.slideDuplicateViews[e]&&i.slideDuplicateViews[e].unload()}),this.loadedSlides=t},onDispose:function(){window.clearTimeout(this.captionTimeoutId),window.clearTimeout(this.navigationTimeoutId),this.swiper&&(this.swiper.removeAllSlides(),this.swiper.destroy(),this.swiper=null),this.captionTimeoutId=null,this.navigationTimeoutId=null,this.preloadOffset=null,this.loadedSlides=null,this.slideViews=null,this.slideDuplicateViews=null,this.lastSwiperZoomMode=null,this.carouselRoot=null,this.canAutoplayImages=null,this.imageFileRegistry=null,this.autoplayMode=null,this.autoplayStarted=null,this.autoplayStopAtIndex=null,this.displayerviewMousemoveClickHandler=null,this.sidebarBeforeFullscreen=null,this.fullscreenPromise=null,this.fullscreen=null}})});