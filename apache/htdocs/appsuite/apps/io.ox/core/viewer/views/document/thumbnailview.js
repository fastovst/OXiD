define("io.ox/core/viewer/views/document/thumbnailview",["io.ox/backbone/views/disposable","io.ox/core/capabilities","io.ox/core/tk/doc-converter-utils","io.ox/core/viewer/util"],function(e,t,i,n){"use strict";return e.extend({events:{"click .document-thumbnail-link":"onThumbnailClicked","keydown .document-thumbnail-link":"onThumbnailKeydown"},initialize:function(e){_.extend(this,e),this.listenTo(this.viewerEvents,"viewer:document:selectthumbnail",this.selectThumbnail),this.listenTo(this.viewerEvents,"viewer:sidebar:renderthumbnails",this.render),this.listenTo(this.viewerEvents,"viewer:sidebar:scroll",this.refreshThumbnails),this.listenTo(this.viewerEvents,"viewer:resize",this.refreshThumbnails),this.thumbnailLoadDef=n.createAbortableDeferred($.noop),this.thumbnailImages=[]},render:function(){var e=this;return t.has("document_preview")?(this.$el.addClass("io-ox-busy"),this.thumbnailLoadDef=i.beginConvert(this.model).done(function(t){return e.convertData=t,_.times(t.pageCount,function(t){var i=e.createThumbnailNode(t);e.$el.append(i)}),e.loadThumbnails(t),t}).fail(function(e){return $.Deferred().reject(e)}).always(function(){e.$el.removeClass("io-ox-busy")}),this):this},createThumbnailNode:function(e){var t=$('<a class="document-thumbnail-link">'),i=$('<div class="document-thumbnail">'),n=this.createDocumentThumbnailImage("thumbnail-image"),a=$('<div class="page-number">').text(e+1);return i.append(n).addClass("io-ox-busy"),this.thumbnailImages.push(n),t.append(i,a).attr({role:"button","aria-selected":!1,"data-page":e+1}),t},loadThumbnails:function(e){var t={action:"convertdocument",convert_action:"getpage",target_format:"png",target_width:200,target_zoom:1,job_id:e.jobID,page_number:e.pageNumber,id:this.model.get("id"),folder_id:this.model.get("folder_id"),filename:this.model.get("filename"),version:this.model.get("version")},a=this.$(".document-thumbnail"),o=n.getVisibleNodes(a);_.each(o,function(e){var n=this.thumbnailImages[e-1];if(!n.src){t.page_number=e;var a=i.getConverterUrl(t,{encodeUrl:!0});n.src=a}}.bind(this))},createDocumentThumbnailImage:function(e){var t=new Image;return t.className=e,t.onload=function(){var e=$(this),t=e.parent(),i=e.width()>e.height();t.removeClass("io-ox-busy").toggleClass("landscape",i)},t.style.width="100%",t.style.height="auto",t.style.maxWidth="100%",t.style.maxHeight="100%",t},onThumbnailClicked:function(e){var t=$(e.currentTarget).data("page");this.selectThumbnail(t),this.viewerEvents.trigger("viewer:document:scrolltopage",t)},onThumbnailKeydown:function(e){switch(e.which){case 13:case 32:e.stopPropagation(),this.onThumbnailClicked(e)}},selectThumbnail:function(e){var t=this.$el.find(".document-thumbnail-link[data-page="+e+"]");if(t.length>0){t.siblings().removeClass("selected").attr("aria-selected",!1),t.addClass("selected").attr("aria-selected",!0);var i=t[0].getBoundingClientRect(),n=this.$el.parent(".viewer-sidebar"),a=t[0].offsetTop;i.bottom>window.innerHeight&&n.scrollTop(a+t.outerHeight()-n.outerHeight()+10),i.top<n.scrollTop()&&n.scrollTop(a-10)}},refreshThumbnails:function(){this.thumbnailLoadDef.done(function(e){this.loadThumbnails(e)}.bind(this))},onDispose:function(){var e=this.thumbnailLoadDef;"pending"===e.state()&&e.abort(),e.done(function(e){i.endConvert(this.model,e.jobID)}.bind(this)),_.each(this.thumbnailImages,function(e){e.onload=null}),this.thumbnailImages=null}})});