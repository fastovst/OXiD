define("io.ox/core/viewer/util",["io.ox/core/capabilities","io.ox/core/http","gettext!io.ox/core/viewer"],function(e,o,a){"use strict";var t=!1,r=null,n=null,i=ox&&ox.ui&&ox.ui.apps,f=!(!i||!(i.has("io.ox/office/text/main")||i.has("io.ox/office/presentation/main")||i.has("io.ox/office/spreadsheet/main"))),l={};l.CATEGORY_ICON_MAP={file:"fa-file-o",txt:"fa-file-text-o",doc:"fa-file-text-o",ppt:"fa-file-powerpoint-o",xls:"fa-file-excel-o",image:"fa-file-image-o",video:"fa-file-video-o",audio:"fa-file-audio-o",pdf:"fa-file-pdf-o"},l.getClippedLabels=function(e,o){var a=_.extend({maxNormal:40,maxShort:26,charpos:"middle"},o||{}),t=String(e||"").trim();return{title:t,"aria-label":t,"data-label-normal":_.ellipsis(t,_.extend(a,{max:a.maxNormal})),"data-label-short":_.ellipsis(t,_.extend(a,{max:a.maxShort}))}},l.setClippedLabel=function(e,o,a){var t=l.getClippedLabels(o,a);(e=e instanceof $?e:$(e)).attr(t).addClass("viewer-responsive-label")},l.setDeviceClass=function(e){return e=e instanceof $?e:$(e),_.device("smartphone")?e.addClass("smartphone"):_.device("tablet")?e.addClass("tablet"):void 0},l.getIconClass=function(e){if(!e)return l.CATEGORY_ICON_MAP.file;var o=e.getFileType();return l.CATEGORY_ICON_MAP[o]||l.CATEGORY_ICON_MAP.file},l.getVisibleNodes=function(e){function o(e){function o(e){return e>=0&&e<=window.innerHeight}var a=e.getBoundingClientRect();return o(a.top)||o(a.bottom)||a.top<0&&a.bottom>window.innerHeight}var a=[];return _.each(e,function(e,t){o(e)&&a.push(t+1)}),a},l.createAbortableDeferred=function(e){return _.extend($.Deferred(),{abort:e})},l.renderItemSize=function(e){var o,t,r;return e.isFile()||e.isComposeAttachment()||e.isMailAttachment()||e.isPIMAttachment()?(o=e.get("file_size"),r=_.isNumber(o)?_.filesize(o):"-"):(t=e.get("total"),r=_.isNumber(t)?a.format(a.ngettext("1 item","%1$d items",t),t):"-"),r};var d={drive:"io.ox/files/actions/download",mail:"io.ox/mail/attachment/actions/download",compose:"io.ox/mail/compose/actions/download",pim:"io.ox/core/tk/actions/download-attachment",guardDrive:"oxguard/download"};return l.getRefByModelSource=function(e){return d[e]},l.minMax=function(e,o,a){return Math.min(Math.max(e,o),a)},l.startPerformanceTimer=$.noop,l.logPerformanceTimer=$.noop,l.addToPerformanceLogger=$.noop,l.addDefaultPerformanceInfo=$.noop,l.savePerformanceTimer=$.noop,f&&(e.has("text")||e.has("spreadsheet")||e.has("presentation"))&&require(["settings!io.ox/office"]).done(function(e){(t=e.get("module/logPerformanceData",!1))&&(l.startPerformanceTimer=function(){n={},r=_.now()},l.logPerformanceTimer=function(e){r&&l.addToPerformanceLogger(e,_.now()-r)},l.addToPerformanceLogger=function(e,o){n&&(n[e]=o)},l.addDefaultPerformanceInfo=function(e){l.addToPerformanceLogger("user-agent",navigator.userAgent),l.addToPerformanceLogger("platform",navigator.platform),l.addToPerformanceLogger("user",ox.user),l.addToPerformanceLogger("version",ox.version),l.addToPerformanceLogger("server",ox.abs),l.addToPerformanceLogger("application","viewer"),l.addToPerformanceLogger("filename",e&&e.selection&&e.selection.filename?e.selection.filename:"")},l.savePerformanceTimer=function(e){var a=null;return r&&n&&(l.addDefaultPerformanceInfo(e),a=o.POST({module:"oxodocumentfilter",data:{action:"logperformancedata",performanceData:JSON.stringify(n)}}),n=null,r=null),a||$.when()})}),l});