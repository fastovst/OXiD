define("io.ox/core/pdf/pdfview",["io.ox/core/viewer/util","io.ox/core/pdf/pdftextlayerbuilder","io.ox/core/pdf/pdfannotationslayerbuilder","less!io.ox/core/pdf/pdfstyle"],function(e,n,t){"use strict";function i(e){return _.isObject(e)&&_.isNumber(e.width)&&_.isNumber(e.height)}function r(a,c){function g(e,n){return _.isObject(e)?e.getViewport({scale:r.getAdjustedZoom(n)}):null}function h(e,n,t,i){return e>=t&&i>=e||t>=e&&n>=t}function u(e,n,t){if(!e){e={min:99999999,max:0,childs:[]};var i=_.last(t);i&&((i=_.last(i.childs)).innerHTML=i.innerHTML+"\r\n"),t.push(e)}var a=r.convertCssLength(n.style.top,"px",1),s=r.convertCssLength(n.style.fontSize,"px",1);e.min=Math.min(e.min,a),e.max=Math.max(e.max,a+s);var o=_.last(e.childs);if(e.childs.push(n),o){var d=r.convertCssLength(o.style.fontSize,"px",1),c=r.convertCssLength(n.style.left,"px",1)-($(o).width()+r.convertCssLength(o.style.left,"px",1));o.innerHTML=c<4*d?o.innerHTML+" ":o.innerHTML+"\t"}return e}function l(e){if(e){var n=e.children(),t=n.length,i=[],a=null;n.detach(),_.each(n,function(e){1===e.innerHTML.length&&(e.style.transform="scaleX(1)");var n=r.convertCssLength(e.style.top,"px",1),t=r.convertCssLength(e.style.fontSize,"px",1)+n;a&&!h(a.min,a.max,n,t)&&(a=null),a=u(a,e,i)}),i.sort(function(e,n){return e.min-n.min}),_.each(i,function(n){e.append(n.childs)}),n=e.children(),_.each(n,function(e,n){_.device("touch")&&_.browser.iOS&&_.browser.Safari||(e.style.margin="-500px -2em 0 -10em",e.style.padding="+500px +2em 0 +10em",e.style.transformOrigin="10em 0 0"),e.style.zIndex=t-n}),n.appendTo(e),e.append('<div style="bottom: 0; right: 0; padding: 200% 0 0 100%; cursor: default;">&#8203;</div>')}}function f(e){return P[e]||(P[e]={}),P[e]}function p(e){var n=w?w.getPageNode(e):null;return n?$(n):null}function m(){if(_.isObject(w)&&!v.isRenderingSuspended()){var e=w.getVisiblePageNumbers();if(_.isArray(e)&&e.length>0){e=_.sortBy(e);for(var n=0;n<2;++n)e[0]>1&&e.unshift(e[0]-1),e[e.length-1]<a.getPageCount()&&e.push(e[e.length-1]+1);e=_.intersection(e,_.range(1,a.getPageCount()+1));var t=_.difference(e,b),i=_.difference(b,e);if(t&&t.length>0){var r=[];_.isFunction(w.beginRendering)&&w.beginRendering(t),v.suspendRendering(),_.each(t,function(e){var n=w.getPageNode(e);n&&(0===n.children().length&&v.createPDFPageNode(n,_.extend({pageZoom:v.getPageZoom(e)},c)),r.push(v.renderPDFPage(n,e,v.getPageZoom(e))),n.css({visibility:"visible"}))}),$.when.apply($,r).always(function(){_.isObject(w)&&_.isFunction(w.endRendering)&&w.endRendering(t),v.resumeRendering()})}i&&i.length>0&&_.each(i,function(e){var n=p(e);n&&n.css({visibility:"hidden"}).empty()}),b=e}}}var v=this,P=[],w=null,b=[],x=0,y=0;this.destroy=function(){this.clearRenderCallbacks()},this.setRenderCallbacks=function(e){this.clearRenderCallbacks(),_.isObject(e)&&_.isFunction(e.getVisiblePageNumbers)&&_.isFunction(e.getPageNode)&&(w=e,y=window.setInterval(m,100))},this.clearRenderCallbacks=function(){this.suspendRendering(),y&&window.clearInterval(y),w=null,this.resumeRendering()},this.suspendRendering=function(){++x},this.resumeRendering=function(){--x},this.isRenderingSuspended=function(){return x>0},this.createPDFPageNode=function(e,n){var t=_.extend({},c,n),s=t.pageSize,o=t.pageNumer,d=t.pageZoom;if(i(s)||(s=_.isNumber(o)?a.getOriginalPageSize(o):a.getDefaultPageSize()),_.isNumber(d)&&i(s)&&(s=r.getNormalizedSize({width:s.width*d,height:s.height*d})),i(s)){var g='width="'+s.width+'" height="'+s.height+'" style="width:'+s.width+"px; height:"+s.height+'px"',h=$('<div class="pdf-page" '+g+">"),u=$('<div class="canvas-wrapper" '+g+">");if(h.append(u.append($("<canvas "+g+">"))),t.textOverlay){var l=$('<div class="text-wrapper user-select-text" '+g+">");h.append(l)}$(e).append(h)}return s},this.setPageZoom=function(e,n){if(_.isNumber(e)){if(this.suspendRendering(),n){var t=f(n-1);if(t.pageZoom!==e){var i=p(n);i&&i.empty(),t.pageZoom=e,b=_.without(b,n)}}else _.times(a.getPageCount(),function(n){v.setPageZoom(e,n+1)});this.resumeRendering()}},this.getPageZoom=function(e){var n=f(e-1);return _.isNumber(e)&&n.pageZoom?n.pageZoom:1},this.getRealPageSize=function(e,n){var t=null,i=_.isNumber(n)?n:this.getPageZoom(e);return _.isObject(a)&&(t=_.isNumber(e)?a.getOriginalPageSize(e):a.getDefaultPageSize()),_.isObject(t)?{width:Math.ceil(i*t.width),height:Math.ceil(i*t.height)}:{width:0,height:0}},this.renderPDFPage=function(i,h,u){var f=$.Deferred(),p=$(i).children().eq(0),m=h-1;if(P[m]||(P[m]={}),f.always(function(){P[m]&&(P[m].isInRendering=null)}),p.length&&!P[m].isInRendering){P[m].curPageZoom=u,P[m].isInRendering=!0;var v=$.Deferred();v.done(function(){e.logPerformanceTimer("pdfView:renderPDFPage_before_getPDFJSPage_"+h),a.getPDFJSPage(h).then(function(i){if(e.logPerformanceTimer("pdfView:renderPDFPage_getPDFJSPage_then_handler_"+h),p.children().length){var a=g(i,u),d=r.getNormalizedSize({width:a.width,height:a.height}),m={width:d.width,height:d.height},v=p.children(".canvas-wrapper"),_=v.children("canvas"),P=p.children(".text-wrapper"),w=null,b=function(e){return e*s>o?o/(e*s):s},x=b(m.width),y=b(m.height);m.width*=x,m.height*=y,_.empty(),p.attr(d).css(d),p.parent(".document-page").css(d),v.attr(d).css(d),_.attr(m).css(d),P.length&&(P.empty().attr(d).css(d),w=new n({textLayerDiv:P[0],viewport:a,pageIndex:h})),c.annotationsOverlay&&new t({pageDiv:p[0],pdfPage:i,linkService:c.linkService}).render(a,"display");var R=_[0].getContext("2d");return R._transformMatrix=[x,0,0,y,0,0],R.scale(x,y),e.logPerformanceTimer("pdfView:renderPDFPage_before_pdfjsPage_render_"+h),i.render({canvasContext:R,viewport:a}).promise.then(function(){if(e.logPerformanceTimer("pdfView:renderPDFPage_pdfjsPage_render_then_handler_"+h),w)return i.getTextContent().then(function(e){return w.setTextContent(e),w.render(),l(P),f.resolve()});f.resolve()})}return f.reject()})}),d(v)}else f.reject();return f.promise()}}var a=function(){var e=1;return"deviceXDPI"in screen&&"logicalXDPI"in screen&&screen.logicalXDPI>0?e=screen.deviceXDPI/screen.logicalXDPI:window.hasOwnProperty("devicePixelRatio")&&(e=window.devicePixelRatio),e}(),s=Math.min(a,2),o=_.browser.iOS||_.browser.Android||_.browser.Safari||_.browser.IE<=10?2156:4096,d=function(){var e=$.when(),n=[];return function(t){n.push(t),e=e.then(function(){var e=$.Deferred();return n.shift().resolve(),setTimeout(function(){e.resolve()},250),e})}}();return r.getAdjustedZoom=function(e){return _.isNumber(e)?e*(96/72):1},r.getZoom=function(e){return _.isNumber(e)?e/(96/72):1},r.getNormalizedSize=function(e){return i(e)?{width:Math.ceil(e.width),height:Math.ceil(e.height)}:null},r.round=function(e,n){return e=Math.round(n<1?e*Math.round(1/n):e/n),n<1?e/Math.round(1/n):e*n},r.convertLength=function(){var e={px:1,pc:1/9,pt:4/3,in:96,cm:96/2.54,mm:96/25.4};return function(n,t,i,a){return n*=(e[t]||1)/(e[i]||1),_.isFinite(a)?r.round(n,a):n}}(),r.convertCssLength=function(e,n,t){var i=parseFloat(e);return _.isFinite(i)||(i=0),i&&e.length>2&&(i=r.convertLength(i,e.substr(-2),n,t)),i},r});