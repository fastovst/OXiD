define("io.ox/core/pdf/pdftextlayerbuilder",["io.ox/core/pdf/pdfpolyfill","io.ox/core/pdf/pdfcustomstyle","pdfjs-dist/build/pdf","pdfjs-dist/build/pdf.worker"],function(t,e,i){"use strict";function n(t){return!s.test(t)}var s=/\S/;return function(){function t(t){this.textLayerDiv=t.textLayerDiv,this.renderingDone=!1,this.divContentDone=!1,this.pageIdx=t.pageIndex,this.pageNumber=this.pageIdx+1,this.matches=[],this.viewport=t.viewport,this.textDivs=[],this.findController=t.findController||null}return t.prototype={_finishRendering:function(){this.renderingDone=!0;var t=document.createEvent("CustomEvent");t.initCustomEvent("textlayerrendered",!0,!0,{pageNumber:this.pageNumber}),this.textLayerDiv.dispatchEvent(t)},renderLayer:function(){var t=document.createDocumentFragment(),i=this.textDivs,n=i.length,s=document.createElement("canvas").getContext("2d");if(n>1e5)this._finishRendering();else{for(var r,d,a=0;a<n;a++){var o=i[a];if(void 0===o.dataset.isWhitespace){var h=o.style.fontSize,l=o.style.fontFamily;h===r&&l===d||(s.font=h+" "+l,r=h,d=l);var f=s.measureText(o.textContent).width;if(f>0){t.appendChild(o);var v;v=void 0!==o.dataset.canvasWidth?"scaleX("+o.dataset.canvasWidth/f+")":"";var c=o.dataset.angle;c&&(v="rotate("+c+"deg) "+v),v&&e.setProp("transform",o,v)}}}this.textLayerDiv.appendChild(t),this._finishRendering(),this.updateMatches()}},render:function(t){if(this.divContentDone&&!this.renderingDone)if(this.renderTimer&&(clearTimeout(this.renderTimer),this.renderTimer=null),t){var e=this;this.renderTimer=setTimeout(function(){e.renderLayer(),e.renderTimer=null},t)}else this.renderLayer()},appendText:function(t,e){var s=e[t.fontName],r=document.createElement("div");if(this.textDivs.push(r),n(t.str))r.dataset.isWhitespace=!0;else{var d=i.Util.transform(this.viewport.transform,t.transform),a=Math.atan2(d[1],d[0]);s.vertical&&(a+=Math.PI/2);var o=Math.sqrt(d[2]*d[2]+d[3]*d[3]),h=o;s.ascent?h=s.ascent*h:s.descent&&(h=(1+s.descent)*h);var l,f;0===a?(l=d[4],f=d[5]-h):(l=d[4]+h*Math.sin(a),f=d[5]-h*Math.cos(a)),r.style.left=l+"px",r.style.top=f+"px",r.style.fontSize=o+"px",r.style.fontFamily=s.fontFamily,r.textContent=t.str,i.pdfBug&&(r.dataset.fontName=t.fontName),0!==a&&(r.dataset.angle=a*(180/Math.PI)),r.textContent.length>1&&(s.vertical?r.dataset.canvasWidth=t.height*this.viewport.scale:r.dataset.canvasWidth=t.width*this.viewport.scale)}},setTextContent:function(t){this.textContent=t;for(var e=t.items,i=0,n=e.length;i<n;i++)this.appendText(e[i],t.styles);this.divContentDone=!0},convertMatches:function(t){for(var e=0,i=0,n=this.textContent.items,s=n.length-1,r=null===this.findController?0:this.findController.state.query.length,d=[],a=0,o=t.length;a<o;a++){for(var h=t[a];e!==s&&h>=i+n[e].str.length;)i+=n[e].str.length,e++;e===n.length&&console.error("Could not find a matching mapping");var l={begin:{divIdx:e,offset:h-i}};for(h+=r;e!==s&&h>i+n[e].str.length;)i+=n[e].str.length,e++;l.end={divIdx:e,offset:h-i},d.push(l)}return d},renderMatches:function(t){function e(t,e){var n=t.divIdx;s[n].textContent="",i(n,0,t.offset,e)}function i(t,e,i,r){var d=s[t],a=n[t].str.substring(e,i),o=document.createTextNode(a);if(r){var h=document.createElement("span");return h.className=r,h.appendChild(o),void d.appendChild(h)}d.appendChild(o)}if(0!==t.length){var n=this.textContent.items,s=this.textDivs,r=null,d=this.pageIdx,a=null!==this.findController&&d===this.findController.selected.pageIdx,o=null===this.findController?-1:this.findController.selected.matchIdx,h={divIdx:-1,offset:void 0},l=o,f=l+1;if(null!==this.findController&&this.findController.state.highlightAll)l=0,f=t.length;else if(!a)return;for(var v=l;v<f;v++){var c=t[v],u=c.begin,x=c.end,p=a&&v===o?" selected":"";if(this.findController&&this.findController.updateMatchPosition(d,v,s,u.divIdx,x.divIdx),r&&u.divIdx===r.divIdx?i(r.divIdx,r.offset,u.offset):(null!==r&&i(r.divIdx,r.offset,h.offset),e(u)),u.divIdx===x.divIdx)i(u.divIdx,u.offset,x.offset,"highlight"+p);else{i(u.divIdx,u.offset,h.offset,"highlight begin"+p);for(var g=u.divIdx+1,m=x.divIdx;g<m;g++)s[g].className="highlight middle"+p;e(x,"highlight end"+p)}r=x}r&&i(r.divIdx,r.offset,h.offset)}},updateMatches:function(){if(this.renderingDone){for(var t=this.matches,e=this.textDivs,i=this.textContent.items,n=-1,s=0,r=t.length;s<r;s++){for(var d=t[s],a=Math.max(n,d.begin.divIdx),o=d.end.divIdx;a<=o;a++){var h=e[a];h.textContent=i[a].str,h.className=""}n=d.end.divIdx+1}null!==this.findController&&this.findController.active&&(this.matches=this.convertMatches(this.findController.pageMatches[this.pageIdx]||[]),this.renderMatches(this.matches))}}},t}()});