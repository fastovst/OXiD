define("io.ox/multifactor/settings/views/totpRegistrationView",["io.ox/backbone/views","io.ox/core/extensions","io.ox/backbone/mini-views","io.ox/backbone/views/modal","io.ox/multifactor/api","gettext!io.ox/core/boot","io.ox/backbone/mini-views/copy-to-clipboard"],function(e,i,o,t,n,r,a){"use strict";function c(e,i){return new t({async:!0,point:v,title:r("Authenticator Registration"),enter:"OK",model:new Backbone.Model({device:i})}).build(function(){}).addCancelButton().addButton({label:r("Ok"),action:"OK"}).on("OK",function(){var o=$("#verification").val().replace(/\s/g,"");o&&""!==o?p(e,i,o):f.reject()}).on("cancel",function(){f.reject()}).on("open",function(){$("#verification").focus()}).open()}function d(e){$(e.target).toggleClass("mfInputError",e.target.value.match(/[0-9\s]*/)[0]!==e.target.value)}function l(e){return e?e.trim().replace(/(\w{4})/g,"$1 ").replace(/(^\s+|\s+$)/,""):""}function s(e){require(["io.ox/core/notifications"],function(i){i.yell("error",e)})}function p(e,i,o){var t={secret_code:o};n.finishRegistration(e,i.deviceId,t).then(function(e){if(e&&e.enabled)return u.close(),void f.resolve();var i;e&&e.error&&(i=r("Bad input or server error. Please try again.")+" "+e.error),s(i),u.idle(),$("#verification").focus()},function(e){if(e&&"MFA-0021"===e.code)return s(r("Bad verification code. Please try again")),u.idle(),void $("#verification").focus();s(r("Bad input or server error. Please try again.")+" "+e.error),u.close(),f.reject(),console.error(e)})}var u,f,v="multifactor/settings/views/totpRegistrationView",b=0;return i.point(v).extend({index:b+=100,id:"header",render:function(){var e=$('<label for="qrcode">').append(r("Scan the QR code with your authenticator.")).append("<br>");this.$body.append(e)}},{index:b+=100,id:"qr",render:function(e){var i=$('<div class="qrDiv">'),o=e.model.get("device").challenge,t=o.base64Image,n=$('<img id="qrcode" src="data:image/png;base64, '+t+'">');if(i.append(n),o.url&&!_.device("small")){var c=$('<input id="qrUrl" style="position:absolute; left: -1000px;">').val(o.url),d=new a({targetId:"#qrUrl"}).render().$el,l=$('<span class="input-group-btn multifactor-copy">').append(d);i.append(c).append(l),n.attr("title",r("Click to copy URL to clipboard")).click(function(){d.click(),window.setTimeout(function(){$(".tooltip").hide()},3e3)})}this.$body.append(i)}},{index:b+=100,id:"code",render:function(e){var i=$('<label for="code">').append(r("If scanning does not work, you may be able to enter the following setup code.")),o=$('<span id="code" class="totpShared selectable-text">').append(l(e.model.get("device").challenge.sharedSecret));this.$body.append(i).append(o)}},{index:b+=100,id:"Prompt",render:function(){var e=$('<label for="verification">').append(r("Once complete, please enter an authentication code to verify everything is configured properly."));this.$body.append(e)}},{index:b+=100,id:"verification",render:function(){var e=$('<input type="text" class="form-control mfInput" id="verification">').keyup(d),i=$('<div class="verificationDiv">').append(e);this.$body.append(i)}}),{open:function(e,i,o){return u=c(e,i),f=o,u}}});