define("io.ox/backbone/modelFactory",["io.ox/backbone/basicModel","io.ox/core/extensions"],function(t,e){"use strict";function n(t,e){var n={},i={},r=this,a=0;this.internal={cachedServerAttributes:function(t){return i[t]||{}}},this.create=function(t){var r=new e.model(t),a=e.internal.toUniqueIdFromObject(t);return n[a]=r,i[a]=JSON.parse(JSON.stringify(r.toJSON())),r},this.get=function(){var t=$.makeArray(arguments),a=e.internal.toUniqueIdFromGet.apply(e,t),o=$.Deferred();return n[a]?$.Deferred().resolve(n[a]):(e.internal.load.apply(e.internal,t).done(function(t){t._realm=r;var a=new e.model(t);n[a.id]=a,i[a.id]=JSON.parse(JSON.stringify(a.toJSON())),o.resolve(a)}).fail(o.reject),o)},this.getAll=function(){var t=$.Deferred();return e.internal.loadAll.apply(e.internal,$.makeArray(arguments)).done(function(){r.getList.apply(r,$.makeArray(arguments)).done(t.resolve).fail(t.reject)}).fail(t.reject),t},this.getList=function(){function t(){var t=_(o).map(function(t){return n[t.uid]});a.resolve(t)}var a=$.Deferred(),o=e.internal.componentizeList.apply(e.internal,$.makeArray(arguments)),s=[];return _(o).each(function(t){n[t.uid]||s.push(t.id)}),_.isEmpty(s)?(t(),a):(e.internal.loadBulk(s).done(function(a){_(a).each(function(t){t._realm=r;var a=e.create(t);n[a.id]=a,i[a.id]=JSON.parse(JSON.stringify(a.toJSON()))}),t()}).fail(a.reject),a)},this.refresh=function(t,e){if(n[t]){var r=n[t];_(r.attributes).each(function(t,e){/^_/.test(e)||r.unset(e,{silent:!0})}),r.set(e),i[t]=JSON.parse(JSON.stringify(r.toJSON()))}},this.markDestroyed=function(t){if(n[t]){var e=n[t];delete n[t],e.trigger("destroy",e)}},this.destroy=function(){_(n).each(function(t){t.off()}),n={}},this.retain=function(){return a++,this},this.release=function(){--a<=0&&(a=0,this.destroy())},e.point("realm").invoke("extend",this)}var i=t.extend({idAttribute:"_uid",initialize:function(){t.prototype.initialize.apply(this,$.makeArray(arguments)),this.realm=this.get("_realm")||this.factory.realm("default"),delete this.attributes._realm,this.syncer=this.factory.internal;var e=this;this.on("sync",function(){e.touchedAttributes={}})},point:function(t){return this.factory.point(t)},touch:function(){var t=this;this.touchedAttributes=this.touchedAttributes||{},_(arguments).each(function(e){t.touchedAttributes[e]=!0})},changedSinceLoading:function(){var t=this,e=this.realm.internal.cachedServerAttributes(this.id)||{},n=this.attributes,i={},r={};return _(e).chain().keys().each(function(t){i[t]=1}),_(n).chain().keys().each(function(t){i[t]=1}),_(i).chain().keys().each(function(i){var a=e[i],o=n[i],s=!1;t.touchedAttributes&&t.touchedAttributes[i]?r[i]=o:a!==o&&(_.isArray(a)&&_.isArray(o)?0===_(a).difference(o).length&&0===_(o).difference(a).length||(a.length!==o.length?s=!0:_.each(o,function(t,e){_.each(o[e],function(t,n){void 0===a[e]?s=!0:t!==a[e][n]&&(s=!0)})}),!0===s&&(r[i]=o)):r[i]=o)}),r},isDirty:function(){return!_.isEmpty(this.changedSinceLoading())},getCompositeId:function(){return(this.get("folder")||this.get("folder_id"))+"."+(this.get("id")||"new-object")}});return function(t){function r(t){var e=a.internal.toUniqueIdFromObject(t);return t._uid=e,t}this.internal={};var a=this,o={};this.realm=function(t){return t?o[t]||(o[t]=new n(t,this)):this.realm("default")},this.model=i.extend(_.extend({factory:this},t.model||{})),this.collection=Backbone.Collection.extend({model:this.model,sync:function(){return a.point("collection/sync").invoke("sync",this,$.makeArray(arguments))}}),this.api=t.api,this.ref=t.ref,this.internal.load=t.load||function(){var t=$.makeArray(arguments);return a.api.get.apply(a.api,t).then(r)},this.internal.loadAll=t.loadAll||function(){return a.api.getAll.apply(a.api,$.makeArray(arguments))},this.internal.loadBulk=t.loadBulk||function(t){return a.api.getList(t).then(function(t){return _(t).each(r),t})},this.internal.create=t.create||function(t){return a.api.create(t.toJSON())},this.internal.read=t.read||function(t){return a.api.get({id:t.get("id"),folder:t.get("folder")||t.get("folder_id")}).done(function(e){t.realm.refresh(a.internal.toUniqueIdFromObject(e),e)})},this.internal.update=t.update||function(e){var n=null;return t.getUpdatedAttributes?n=t.getUpdatedAttributes(e):((n=e.changedSinceLoading()).id=e.id,n.last_modified=e.get("last_modified"),n.folder||(n.folder=e.get("folder")||e.get("folder_id"))),a.api.update(n)},this.internal.destroy=t.destroy||function(t){return a.api.remove({id:t.id,folder:t.get("folder_id")||t.get("folder")})},this.internal.toUniqueId=t.toUniqueId||function(t){return t.id},this.internal.toUniqueIdFromGet=t.toUniqueIdFromGet||this.internal.toUniqueId,this.internal.toUniqueIdFromObject=t.toUniqueIdFromObject||this.internal.toUniqueId,this.internal.eventToGetArguments=t.eventToGetArguments||function(t,e){return[{id:e.id,folder:e.folder||e.folder_id}]},this.internal.componentizeList=t.componentizeList||function(t){return _(t).map(function(t){return{uid:a.internal.toUniqueIdFromObject(t),id:t}})},/\/$/.test(this.ref)||(this.ref=this.ref+"/"),this.point=this.point||function(t){return/^\//.test(t)&&(t=t.substring(1)),e.point(this.ref+t)},this.get=this.get||function(){var t=this.realm("default");return t.get.apply(t,$.makeArray(arguments))},this.getAll=this.getAll||function(){var t=this.realm("default");return t.getAll.apply(t,$.makeArray(arguments))},this.getList=this.getList||function(){var t=this.realm("default");return t.getList.apply(t,$.makeArray(arguments))},this.create=this.create||function(t){return(t=t||{}).id?this.realm("default").create(t):new this.model(t)},this.createCollection=this.createCollection||function(t){return new this.collection(t)},this.internal.updateEvents=t.updateEvents||["update"],this.internal.destroyEvents=t.destroyEvents||["delete"],_(this.internal.updateEvents).each(function(t){a.api.on(t,function(){var t=a.internal.eventToGetArguments.apply(a,$.makeArray(arguments)),e=a.internal.toUniqueIdFromGet.apply(a,t);a.api.get.apply(a.api,t).done(function(t){_(o).each(function(n){n.refresh(e,t)})})})}),_(this.internal.destroyEvents).each(function(t){a.api.on(t,function(){var t=a.internal.eventToGetArguments.apply(a,$.makeArray(arguments)),e=a.internal.toUniqueIdFromGet.apply(a,t);_(o).each(function(t){t.markDestroyed(e)})})}),this.point("validation").extend({id:"generic",validate:function(t,e){_(t).each(function(n,i){var r=a.point("validation/"+i).invoke("validate",e,n,e,t,i).value();_(r).each(function(t){t&&(_.isArray(t)?_(t).each(function(t){e.add(i,t)}):e.add(i,t))})})}}),this.wrap=function(t){return arguments.length>1?this.createCollection(_(arguments).map(function(t){return a.wrap(t)})):t.attributes&&t.factory===this?t:this.create(t)},_($.makeArray(arguments).splice(1)).each(function(t){_.extend(a,t)})}});