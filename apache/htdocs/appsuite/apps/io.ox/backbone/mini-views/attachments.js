define("io.ox/backbone/mini-views/attachments",["io.ox/backbone/mini-views/abstract","io.ox/core/api/attachment","io.ox/core/tk/attachments","io.ox/core/strings","gettext!io.ox/core","settings!io.ox/core"],function(t,e,a,n,i,s){"use strict";var h=0;return{ListView:t.extend({tagName:"div",className:"attachment-list",events:{"click .attachment .remove":"onDeleteAttachment"},onDeleteAttachment:function(t){t.preventDefault();var e=$(t.currentTarget).data();this.deleteAttachment(e)},setup:function(){this.attachmentsToAdd=[],this.attachmentsToDelete=[],this.attachmentsOnServer=[],this.allAttachments=[],this.listenToOnce(this.model,"save:success",this.save),this.loadAttachments()},dispose:function(){this.stopListening()},render:function(){return this.$el.empty().append(_(this.allAttachments).map(this.renderAttachment)),this},renderAttachment:function(t){var e=t.file_size>0?n.fileSize(t.file_size,0):"Â ";return $('<div class="attachment">').append($('<div class="file ellipsis">').append($('<span class="filesize pull-right">').text(e),$('<span class="filename">').text(t.filename)),$('<button type="button" class="btn btn-link remove">').data(t).attr("title",i('Remove attachment "%1$s"',t.filename)).append('<i class="fa fa-minus-circle" aria-hidden="true">'))},checkQuota:function(){var t=s.get("properties"),e=this.attachmentsToAdd.reduce(function(t,e){return t+(e.file_size||0)},0),a=t.attachmentMaxUploadSize;a&&a>0&&e>a?this.model.set("quotaExceeded",{actualSize:e,attachmentMaxUploadSize:t.attachmentMaxUploadSize}):this.model.unset("quotaExceeded")},loadAttachments:function(){var t=this;this.model.id&&e.getAll({module:this.options.module,id:this.model.id,folder:this.model.get("folder")||this.model.get("folder_id")}).done(function(e){t.attachmentsOnServer=e,t.updateState()})},updateState:function(){var t=this;this.allAttachments=_(this.attachmentsOnServer.concat(this.attachmentsToAdd)).reject(function(e){return _(t.attachmentsToDelete).any(function(t){return t.id===e.id})}),this.model.attachments(this.attachmentsToAdd.length+this.attachmentsToDelete.length),this.checkQuota(),this.render()},addFile:function(t){this.addAttachment({file:t,newAttachment:!0,cid:h++,filename:t.name,file_size:t.size})},addAttachment:function(t){this.attachmentsToAdd.push(t),this.updateState()},deleteAttachment:function(t){t.newAttachment?this.attachmentsToAdd=_(this.attachmentsToAdd).reject(function(e){return e.cid===t.cid}):this.attachmentsToDelete.push(t),this.updateState()},save:function(){function t(){a.options.changeCallback&&a.options.changeCallback(a.model,i),a.model.attachments(0)}var a=this,n=0,i=[],s={module:this.options.module,id:this.model.get("id"),folder:this.model.get("folder_id")};this.attachmentsToDelete.length&&n++,this.attachmentsToAdd.length&&(n+=2),this.attachmentsToDelete.length&&e.remove(s,_(this.attachmentsToDelete).pluck("id")).then(function(){--n<=0&&t()},function(e){a.model.trigger("server:error",e),n--,i.push(e),n<=0&&t()}),this.attachmentsToAdd.length&&e.create(s,_(this.attachmentsToAdd).pluck("file")).then(function(){(n-=2)<=0&&t()},function(e){a.model.trigger("server:error",e),n-=2,i.push(e),n<=0&&t()}),n<=0&&t(),this.attachmentsToAdd=[],this.attachmentsToDelete=[],this.attachmentsOnServer=[],this.allAttachments=[]},isDirty:function(){return this.attachmentsToDelete.length>0||this.attachmentsToAdd.length>0}}),UploadView:t.extend({className:"fileupload",events:{'change input[type="file"]':"onChange"},onChange:function(t){t.preventDefault();var e=$(t.target),a=this.$el.closest(".section").find(".attachment-list").data("view");_(e[0].files).each(a.addFile.bind(a)),e[0].value="",e.trigger("reset.fileupload")},render:function(){var t=a.fileUploadWidget({buttontext:i("Add attachment")}).find("button").addClass("btn-link").removeClass("btn-default").prepend($('<i class="fa fa-plus-circle" aria-hidden="true">'));return this.$el.attr("data-add","attachment").append(t),this}})}});