define("io.ox/backbone/mini-views/combobox",["io.ox/core/util"],function(t){"use strict";return Backbone.View.extend({events:{"blur input":"onBlur","focus input":"onFocus","keydown input":"onKeydown","keyup input":"onKeyup","mousedown .dropdown-menu":"onMousedownMenu","mouseup .dropdown-menu":"onMouseupMenu","mousedown .dropdown-menu li":"onClickOption"},initialize:function(t){this.opt=_.extend({options:[],dropdownClass:"",dropdownId:_.uniqueId("combobox-controls-"),inputClass:""},t)},renderInput:function(){var t=this.opt.input||$("<input>").addClass(this.opt.inputClass);if(t.attr("role","combobox"),this.opt.label)if(this.opt.label instanceof $){var e=this.opt.label.attr("id")||_.uniqueId("control-label-");this.opt.label.attr("id",e),t.attr("aria-labelledby",e)}else t.attr("aria-label",this.opt.label);return t.attr({"aria-controls":this.opt.dropdownId,"aria-expanded":!1,"aria-autocomplete":"list"}).addClass(this.opt.inputClass)},renderDropdown:function(){return $('<ul class="typeahead dropdown-menu"> role="listbox"').attr("id",this.opt.dropdownId).hide().addClass(this.opt.dropdownClass).append(this.opt.options.map(function(t){return $('<li role="option">').attr({"data-value":t.value,id:_.uniqueId("dropdown-option-")}).append($('<a href="#">').text(t.name))}))},render:function(){return this.$el.append($('<div role="presentation">').css("display","inline").append(this.$input=this.renderInput()),this.$dropdown=this.renderDropdown()),this},onBlur:function(){this.preventBlur||(this.$input.attr({"aria-expanded":!1,"aria-activedescendant":null}),this.$dropdown.hide(),this.$dropdown.find(".active").removeClass("active"),delete this.index)},onFocus:function(){var t=this.$input.position(),e=this.$dropdown.is(":visible");this.$input.attr("aria-expanded",!0),this.$dropdown.css({top:t.top+this.$input.outerHeight(),left:t.left}).show(),this.updateQuery();var i=this.$dropdown.find("strong").first();e||1!==i.length||this.scrollIntoView(i)},onMousedownMenu:function(e){var i=e.offsetX,n=this.$("li").first().outerWidth(),o=n+t.getScrollBarWidth();if(i>=n&&i<=o&&(this.preventBlur=!0,e.preventDefault(),_.browser.ie||_.browser.edge)){var s=this;_.defer(function(){s.$input.focus(),s.preventBlur=!1})}},onMouseupMenu:function(){this.preventBlur=!1},onClickOption:function(t){this.preventBlur=!1,this.index=$(t.currentTarget).closest("li").index(),this.select(),this.onBlur()},preSelect:function(t){if(_.isUndefined(this.index)||(this.index+=t),this.index<0&&(this.index=this.opt.options.length-1),this.index>=this.opt.options.length&&(this.index=0),_.isUndefined(this.index)){var e=this.$input.val();this.index=_(this.opt.options).findIndex(function(t){return 0===t.name.toLowerCase().indexOf(e.toLowerCase())})}if(this.$dropdown.find(".active").removeClass("active"),this.index>=0){var i=this.$dropdown.children().eq(this.index);i.addClass("active"),this.$input.attr("aria-activedescendant",i.attr("id")),this.scrollIntoView(i)}},scrollIntoView:function(t){t=t.closest("li");var e=this.$dropdown.scrollTop(),i=t.position().top,n=t.height(),o=this.$dropdown.outerHeight();i<0?this.$dropdown.scrollTop(e+i):i+n>o&&this.$dropdown.scrollTop(e+i+n-o)},select:function(){if(!_.isUndefined(this.index)&&-1!==this.index){var t=this.$dropdown.children().eq(this.index);this.$input.val(t.attr("data-value"))}this.$input.trigger("change")},updateQuery:function(){var t=this,e=this.$input.val();e||(e=""),this.$dropdown.children("li").each(function(){var i=$(this),n=i.find("a"),o=i.attr("data-value");n.html(t.highlighter(o,e))})},highlighter:function(t,e){return e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),t.replace(new RegExp("("+e+")","ig"),function(t,e){return"<strong>"+e+"</strong>"})},onKeydown:function(t){switch(t.keyCode){case 9:this.onBlur();break;case 13:t.preventDefault(),this.select(),this.onBlur();break;case 27:t.preventDefault(),this.onBlur();break;case 38:t.preventDefault(),this.onFocus(),this.preSelect(-1);break;case 40:t.preventDefault(),this.onFocus(),this.preSelect(1)}},onKeyup:function(t){/(13|27|38|40)/.test(t.keyCode)||(this.updateQuery(),this.$dropdown.is(":visible")&&(delete this.index,this.preSelect()))}})});