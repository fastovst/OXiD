define("io.ox/backbone/mini-views/dropdown",["io.ox/backbone/mini-views/abstract","io.ox/core/a11y"],function(t,e){"use strict";function i(t){return _.isFunction(t)?t():_.isObject(t)?t:$.txt(t)}function a(t,e){return t.addClass("checkbox-color color-flags-no-checkbox").css("background-color",e)}return t.extend({tagName:"div",className:"dropdown",events:{"shown.bs.dropdown":"onShown","hidden.bs.dropdown":"resetDropdownOverlay",'keydown *[data-toggle="dropdown"]':"onKeyDown",ready:"onReady",contextmenu:"onContextMenu"},onContextMenu:function(t){t.preventDefault()},onReady:function(){_.device("smartphone")&&!this.options.dontProcessOnMobile||(!1!==this.smart||this.$overlay)&&this.$el.hasClass("open")&&(this.$ul.css({width:"auto",height:"auto"}),this.adjustBounds())},resetDropdownOverlay:function(){$(document).trigger("click.bs.dropdown.data-api"),this.$overlay&&(this.$ul.removeAttr("data-original-id"),this.$placeholder.before(this.$ul).detach(),this.$el.removeClass("open"),this.$ul.attr("style",this.$ul.data("style")||"").removeData("style"),this.$overlay.remove(),this.$toggle.attr("aria-expanded",!1),delete this.$overlay,this.lastEvent&&9===this.lastEvent.which&&(this.lastEvent.shiftKey?e.getPreviousTabbable(this.$toggle).focus():e.getNextTabbable(this.$toggle).focus(),delete this.lastEvent))},setDropdownOverlay:function(){var t=this;this.$overlay=$('<div class="smart-dropdown-container dropdown open" role="navigation">',this.onReady.bind(this)).addClass(this.$el.prop("className")),this.$ul.data("style",this.$ul.attr("style")),this.adjustBounds(),this.$ul.attr("data-original-id",this.$placeholder.attr("id")),this.$ul.before(this.$placeholder).detach(),$("body").append(this.$overlay.append($('<div class="abs">').on("mousewheel touchmove",!1).on("click contextmenu",function(e){return e.stopPropagation(),t.resetDropdownOverlay(),!1}),this.$ul))},adjustBounds:function(){var t=this.$ul.get(0).getBoundingClientRect(),e={top:parseInt(this.$ul.css("margin-top")||0,10),left:parseInt(this.$ul.css("margin-left")||0,10)},i={top:t.top-e.top,left:t.left-e.left,width:t.width,height:"auto"},a=this.$toggle.offset(),o=this.$toggle.outerWidth(),s=$(window).width(),n=$(window).height(),r=$("#io-ox-appcontrol");t.top+t.height>n-this.margin?(a.left+o+t.width+this.margin<s?i.left=a.left+o+this.margin:i.left=a.left-t.width-this.margin,i.top=n-this.margin-t.height,i.top=Math.max(i.top,r.offset().top+r.height()+this.margin),i.height=t.height,i.height=Math.min(n-this.margin-i.top,i.height)):(11===_.browser.IE&&(i.bottom="auto"),i.left=Math.max(this.margin,i.left),i.left=Math.min(s-i.width-this.margin,i.left)),this.$toggle.data("fixed")&&(i.left=t.left),this.$ul.css(i)},onShown:function(){!1!==this.smart&&(_.device("smartphone")&&!this.options.dontProcessOnMobile||this.setDropdownOverlay())},onKeyDown:function(t){if(this.$el.hasClass("open")&&this.$overlay){var i=e.getTabbable(this.$ul);40===t.which&&i.first(":visible").focus(),38===t.which&&i.last(":visible").focus(),27===t.which&&(this.$toggle.trigger("click"),t.stopImmediatePropagation(),t.preventDefault())}},onKeyDownMenu:function(t){9===t.which&&(this.lastEvent=t)},open:function(){this.$el.hasClass("open")||this.$overlay||this.$toggle.trigger("click")},close:function(){(this.$el.hasClass("open")||this.$overlay)&&this.$toggle.trigger("click")},onClick:function(t){var e=$(t.currentTarget),i=e.attr("href"),a=e.attr("data-name"),o=e.data("value"),s=e.data("toggle-value"),n=e.data("toggle"),r=this.options.keep||"true"===e.attr("data-keep-open");if(!(i&&0!==i.length&&"#"!==i||(t.preventDefault(),r&&t.stopPropagation(),e.hasClass("disabled")))){if(!t.isPropagationStopped()&&this.$overlay&&this.$placeholder&&!this.options.noDetach){var l=$('<div class="hidden">');e.before(l).detach(),this.$placeholder.append(e),this.$el.trigger(_.extend({},t,{type:"mousedown"})),this.$el.trigger("track",t.currentTarget),this.$el.trigger(t),l.replaceWith(e)}if(this.trigger("click",e.data()),this.model&&(this.options.allowUndefined||void 0!==o)){var h=o;n&&(h=void 0===s?!this.model.get(a):this.model.get(a)===o?s:o),this.options.saveAsArray&&(h=[h]),this.model.set(a,h)}}},setup:function(){this.$ul=this.options.$ul||this.$ul||$('<ul class="dropdown-menu" role="menu">'),this.$placeholder=$('<div class="hidden">').attr("id",_.uniqueId("dropdown-placeholder-")),this.smart=this.options.smart,this.margin=this.options.margin||8,this.$ul.on("click","a",$.proxy(this.onClick,this)),this.$ul.on("keydown","a",$.proxy(this.onKeyDownMenu,this)),this.model&&this.listenTo(this.model,"change",this.options.update||this.update),this.options.dontProcessOnMobile&&(this.$el.attr("dontProcessOnMobile",!0),this.$ul.attr("dontProcessOnMobile",!0))},update:function(){var t=this.$ul;this.model&&(_(this.model.changed).each(function(e,i){var o=t.find('[data-name="'+i+'"]');o.children("i").each(function(t,e){var i=$(e),o=i.data("color");i.removeClass("fa-check").addClass("fa-none"),o&&a(i,o)}),o.each(function(){var t=$(this);t.filter("[role=menuitemcheckbox][aria-checked]").attr({"aria-checked":_.isEqual(t.data("value"),e)}),_.isEqual(t.data("value"),e)&&t.children("i").each(function(t,e){var i=$(e),o=i.data("color");i.removeClass("fa-none").addClass("fa-check"),o&&a(i,o)})})},this),this.label())},label:function(){},stringify:function(t){return _.isObject(t)?JSON.stringify(t):t},append:function(t,e){return(e&&e.group?this.$ul.find('[role="group"]:last'):this.$ul).append($('<li role="presentation">').append(t)),this},option:function(t,e,i,o){o=_.extend({prefix:"",toggleValue:void 0,radio:!1},o);var s=this.model?this.model.get(t):void 0,n=_.isEqual(s,e),r=o.radio?"menuitemradio":"menuitemcheckbox",l=_.isFunction(i)?$("<div>").append(i()).text():i,h=o.prefix?[o.prefix,l].join(" "):void 0,d=$('<i class="fa fa-fw" aria-hidden="true">').addClass(n?"fa-check":"fa-none"),c=$('<a href="#" draggable="false">').attr({role:r,"aria-checked":n,"data-keep-open":!!o.keepOpen||void 0,"data-name":t,"data-value":this.stringify(e),"data-toggle":_.isBoolean(e)||void 0!==o.toggleValue,"data-toggle-value":o.toggleValue,"aria-label":h,title:o.title,tabindex:"-1"});return o.color&&c.addClass("color-flag"),c.on("dragstart",!1).data("value",e).append(o.color?a(d,o.color).attr({"data-color":o.color,"data-color-label":o.color}):d,_.isFunction(i)?i():$.txt(i)),this.append(c,_.pick(o,"group"))},forceOpen:function(t){this.$el.attr("forceOpen",t)},link:function(t,e,i,a){a=a||{};var o=$('<a href="#" draggable="false" role="menuitem" tabindex="-1">').attr("data-name",t).on("dragstart",!1).append(a.icon?$('<i class="fa fa-fw" aria-hidden="true">'):$(),$.txt(e));return a.data&&o.data(a.data),i&&o.on("click",{},i),this.append(o)},header:function(t){return this.$ul.append($('<li class="dropdown-header" role="separator">').append($('<span aria-hidden="true">').text(t))),this},group:function(t,e){return this.header(t),this.$ul.append($('<div role="group">').attr("aria-label",t).append(e)),this},divider:function(){return this.$ul.append('<li class="divider" role="separator">'),this},render:function(){$(this.$el,function(){this.trigger("ready")}.bind(this));var t=i(this.options.label),e=this.options.aria?this.options.aria:null,a='<a href="#" draggable="false">';return _.isString(t)&&(e+=" "+t),this.options.buttonToggle&&(a='<button type="button" draggable="false" class="btn btn-link">'),this.$el.append(this.$toggle=this.options.$toggle||this.$toggle||$(a).attr({"aria-label":e,"data-action":this.options.dataAction,title:this.options.title||null,ondragstart:_.device("firefox")?"return false;":null}).append($('<span class="dropdown-label">').append(t),this.options.caret?$('<i class="fa fa-caret-down" aria-hidden="true">'):[]),this.$ul),this.label(),this.ensureA11y(),this},ensureA11y:function(){var t=this.$ul.children("li");this.$toggle.attr({"aria-haspopup":!0,"aria-expanded":!1,"data-toggle":"dropdown"}),this.$toggle.is("a")&&this.$toggle.attr("role","button"),this.options.tabindex&&this.$toggle.attr("tabindex",this.options.tabindex),this.$ul.not("[role]").attr({role:"menu"}),t.filter(":not([role])").attr({role:"presentation"}),t.find("a:not([role])").attr({role:"menuitem",tabindex:"-1"})},prepareReuse:function(){return this.$toggle&&this.$toggle.remove(),this.$ul&&this.$ul.empty(),this},dispose:function(){this.$overlay&&this.$overlay.remove(),t.prototype.dispose.call(this,arguments)}})});