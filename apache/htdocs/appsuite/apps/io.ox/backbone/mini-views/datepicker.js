define("io.ox/backbone/mini-views/datepicker",["settings!io.ox/calendar","gettext!io.ox/core","io.ox/calendar/util","less!io.ox/backbone/mini-views/datepicker"],function(e,t,i){"use strict";return Backbone.View.extend({tagName:"fieldset",initialize:function(e){this.options=_.extend({display:"DATE",clearButton:!1,ignoreToggle:!1,timezoneButton:!1,timezoneAttribute:"timezone",label:"",a11y:{}},e),this.attribute=this.options.attribute,this.nodes={},this.mobileSettings={},this.mobileMode=_.device("touch"),this.chronos=e.chronos,this.listenTo(this.model,"change:"+this.attribute,this.updateView),this.listenTo(this.model,"invalid:"+this.attribute,this.onError),this.listenTo(this.model,"valid",this.onValid),this.listenTo(this.model,"change:"+this.options.timezoneAttribute,this.updateView),this.options.attribute&&this.$el.attr("data-attribute",this.options.attribute)},events:{"click .timezone":"clickTimezone"},render:function(){var i=this,o=$.Deferred(),s=_.uniqueId("form-control-label-");return this.$el.addClass("dateinput").toggleClass("mobile-mode",i.mobileMode).append($('<label class="simple control-label">').attr("for",s).text(this.options.label),$('<div class="input-group form-inline">').append(function(){var e,o=s+"-aria",l=t("Date")+" ("+moment.localeData().longDateFormat("l")+")";if(i.nodes.dayField=$('<input type="text" class="form-control datepicker-day-field">').attr({id:s,"aria-label":l,"aria-describedby":o}),i.mobileMode)return[i.nodes.dayField];i.nodes.timeField=$('<input type="text" class="form-control time-field">').attr("id",_.uniqueId("form-control-label-"));var a=i.chronos?i.model.getMoment(i.attribute):moment.tz(i.model.get(i.options.timezoneAttribute)),n=a.zoneAbbr(),d=(a.format("Z ")+a.zoneAbbr()+" "+a.tz()).replace(/_/g," ");return i.options.timezoneButton||i.mobileMode?(e=i.nodes.timezoneField=$('<a role="button" class="timezone input-group-addon btn">').attr("tabindex",0).text(n).attr("aria-label",d),i.model.has("start_date")&&i.model.has("end_date")&&(e.attr("data-toggle","popover"),require(["io.ox/calendar/util"],function(t){t.addTimezonePopover(e,i.model.attributes,{placement:"top",trigger:"click",closeOnScroll:i.options.closeOnScroll,attrName:i.attribute})}))):e=i.nodes.timezoneField=$('<div class="timezone input-group-addon">').text(n).attr("aria-label",d),i.nodes.a11yDate=$('<p class="sr-only">').attr("id",o).text(t("Use cursor keys to change the date. Press ctrl-key at the same time to change year or shift-key to change month. Close date-picker by pressing ESC key.")),i.toggleTimeInput(!i.isFullTime()),[i.nodes.dayField,i.nodes.a11yDate,i.nodes.timeField,$('<label class="sr-only">').attr("for",i.nodes.timeField.attr("id")).text(t("Time")+" ("+moment.localeData().longDateFormat("LT")+")"),i.nodes.a11yTime,e]})),this.updateView(),this.mobileMode?(i.nodes.dayField.attr("type",i.isFullTime()?"date":"datetime-local"),i.chronos&&i.nodes.dayField.attr({required:"required",defaultValue:""}),o.resolve()):require(["io.ox/backbone/views/datepicker","io.ox/backbone/mini-views/combobox","io.ox/core/tk/datepicker"],function(t,s){new t({date:i.model.get(i.attribute),attribute:i.attribute}).attachTo(i.nodes.dayField);for(var l=[],a=moment().startOf("day"),n=parseInt(e.get("interval"),10)||30,d=0;d<1440;d+=n)l.push({name:a.format("LT"),value:a.format("LT")}),a.add(n,"minutes");var r=new s({options:l,dropdownClass:"calendaredit",input:i.nodes.timeField,label:i.options.a11y.timeLabel});i.nodes.timeField.replaceWith(r.$el.addClass("combobox")),r.render(),i.nodes.timeField.on("change",_.bind(i.updateModel,i)).on("click",function(){i.trigger("click:time")}),i.toggleTimeInput(!i.isFullTime()),o.resolve()}),o.then(function(){i.updateView(),i.nodes.dayField.on(i.mobileMode?"input":"change",_.bind(i.updateModel,i))}),this},updateView:function(){var e;if(this.chronos)e=this.model.getMoment(this.attribute);else{if(_.isNull(this.model.get(this.attribute))&&(this.nodes.dayField.val(""),this.nodes.timeField&&this.nodes.timeField.val("")),e=parseInt(this.model.getDate?this.model.getDate(this.attribute,{fulltime:this.isFullTime()}):this.model.get(this.attribute),10),_.isNaN(e))return;e=moment.tz(e,this.model.get(this.options.timezoneAttribute)||moment().tz())}this.mobileMode||(this.nodes.timeField.val(e.format("LT")),this.nodes.timezoneField.text(e.zoneAbbr())),this.toggleTimeInput(!this.isFullTime()),this.nodes.dayField.val(this.getDateStr(e)),this.mobileMode||this.nodes.dayField.trigger("change")},updateModel:function(){var e=this.getTimestamp();if(!this.chronos||null!==e&&void 0!==e)if(this.chronos||_.isNull(e)||_.isNumber(e)){var i={validate:!0,fulltime:this.isFullTime()};this.model[this.model.setDate?"setDate":"set"](this.attribute,e,i),this.model.trigger("valid")}else this.model.trigger("invalid:"+this.attribute,[t("Please enter a valid date")]);else this.updateView()},isFullTime:function(){return!this.options.ignoreToggle&&this.model.has("full_time")?!!this.model.get("full_time"):this.chronos?i.isAllday(this.model):"DATE"===this.options.display},getDateStr:function(e){return void 0===e||null===e?"":this.mobileMode?this.isFullTime()?e.format("YYYY-MM-DD"):e.format("YYYY-MM-DDTHH:mm"):e.format("l")},getTimestamp:function(){var e=this.nodes.dayField.val(),t="l";if(""===e)return null;this.mobileMode?(this.isFullTime()&&(t="YYYY-MM-DD"),t="YYYY-MM-DDTHH:mm"):this.isFullTime()||(t+=" LT",this.nodes.timeField&&""!==this.nodes.timeField.val()?e+=" "+this.nodes.timeField.val():t="l");var i=moment.tz(e,t,this.chronos?this.model.get(this.attribute).tzid||moment().tz():this.model.get(this.options.timezoneAttribute)||moment().tz());return this.chronos?this.isFullTime()?{value:i.format("YYYYMMDD")}:{value:i.format("YYYYMMDD[T]HHmmss"),tzid:this.model.get(this.attribute).tzid||moment().tz()}:i?i.valueOf():void 0},onError:function(e){var t=this;this.onValid(),this.$el.addClass("error"),this.nodes.helpBlock=$('<div class="help-block error">'),_(e).each(function(e){t.nodes.helpBlock.append($.txt(e))}),this.$el.append(this.nodes.helpBlock)},onValid:function(){this.nodes.helpBlock&&(this.nodes.helpBlock.remove(),delete this.nodes.helpBlock,this.$el.removeClass("error"))},clickTimezone:function(){this.trigger("click:timezone")},toggleTimeInput:function(e){if(this.mobileMode){if(e&&"datetime-local"===this.nodes.dayField.attr("type")||!e&&"date"===this.nodes.dayField.attr("type"))return;this.nodes.dayField.attr("type",e?"datetime-local":"date")}else{if(e&&!this.$el.hasClass("dateonly")||!e&&this.$el.hasClass("dateonly"))return;this.$el.toggleClass("dateonly",!e),this.nodes.timeField.add(this.nodes.timezoneField).css("display",e?"":"none")}}})});