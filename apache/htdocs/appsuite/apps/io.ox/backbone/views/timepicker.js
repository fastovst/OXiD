define("io.ox/backbone/views/timepicker",["io.ox/backbone/views/disposable","io.ox/backbone/mini-views/common","less!io.ox/backbone/views/datepicker"],function(t,e){"use strict";var i=t.extend({className:"time-picker",events:{"click .date":"onSelectDate",keydown:"onKeydown"},constructor:function(e){this.options=e||{},this.$target=$(),this.$parent=$(this.options.parent||"body"),this.date=this.getInitialDate(),this.closing=!1,t.prototype.constructor.apply(this,arguments),this.on({select:function(t){this.date=t.clone(),this.close()},dispose:function(){this.$target.off({change:this.onTargetInput,click:this.open,dispose:this.remove,focus:this.open,focusout:this.focusOut,input:this.onTargetInput,keydown:this.onTargetKeydown}).closest(".scrollable").off("scroll",this.close),$(window).off("resize",$.proxy(this.onWindowResize,this))}}),this.focusOut=_.debounce(function(){var t=document.activeElement;this.disposed||this.el!==t&&this.$target[0]!==t&&($.contains(this.el,t)||this.close(!1))},1),this.$el.on("focusout",$.proxy(this.focusOut,this)),$(window).on("resize",$.proxy(this.onWindowResize,this))},getInitialDate:function(){return moment(this.options.time).startOf("hour").add(1,"hour")},attachTo:function(t){return this.$target=$(t),this.$target.on("focus click",$.proxy(this.open,this)),this.on("select",function(){this.$target.val(this.getFormattedDate()).trigger("change")}),this.$target.attr({"aria-haspopup":!0}).on("change input",$.proxy(this.onTargetInput,this)).on("keydown",$.proxy(this.onTargetKeydown,this)).on("focusout",$.proxy(this.focusOut,this)).on("dispose",$.proxy(this.remove,this)).closest(".scrollable").on("scroll",$.proxy(this.close,this)),this},toggle:function(){this.isOpen()?this.close():this.open()},open:function(){if(!this.isOpen()&&!this.closing){this.trigger("before:open"),this.render().$el.appendTo(this.$parent);var t=this.$target.offset()||{top:200,left:600},e=this.$target.outerHeight()||0,i=this.$parent.height();t.top+e+this.$el.outerHeight()>i?this.$el.css({top:Math.max(0,t.top-this.$el.outerHeight())}):this.$el.css({top:t.top+e}),this.$el.css({left:t.left}).addClass("open");var s=_.uniqueId("picker");this.$el.attr("id",s),this.$target.attr("aria-owns",s),this.trigger("open")}},close:function(t){this.isOpen()&&(this.closing=!0,this.trigger("before:close"),this.$el.removeClass("open"),this.$target.removeAttr("aria-owns"),!1!==t&&this.$target.focus(),this.closing=!1,this.trigger("close"))},isOpen:function(){return this.$el.hasClass("open")},onWindowResize:function(){this.isOpen()&&this.close()},render:function(){var t=this.date.clone().startOf("day");return this.$el.attr({role:"region",tabindex:0}).append(_.range(0,48).map(function(){var e=$('<div class="date">').attr("data-date",t.valueOf()).toggleClass("fullhour",0===t.minutes()).text(t.format("LT"));return t.add(30,"minutes"),e})),this},onSelectDate:function(t){var e=moment($(t.currentTarget).data("date"));this.trigger("select",e)},onTargetInput:function(){var t=this.$target.val(),e=moment(t,"LT");this.setDate(e)},getFormattedDate:function(){return this.getDate().format("LT")},getDate:function(){return this.date},setDate:function(t){(t=moment(t||this.date)).isValid()&&(t.isSame(this.getDate())||(this.date=t,this.trigger("change",t)))}});return _.device("smartphone")?e.InputView.extend({el:'<input type="time" class="form-control">'}):e.InputView.extend({format:"LT",onChange:function(){var t=+moment(this.$el.val(),this.format);this.model.set(this.name,t)},update:function(){var t=this.model.get(this.name);this.$el.val(t||this.options.mandatory?this.getFormattedDate(t):"")},getFormattedDate:function(t){return moment(t).format(this.format)},render:function(){return e.InputView.prototype.render.call(this),setTimeout(function(){new i({parent:this.$el.closest(".modal, #io-ox-core"),mandatory:this.options.mandatory}).attachTo(this.$el).on("select",function(t){this.model.set(this.name,t.valueOf())}.bind(this))}.bind(this)),this}})});