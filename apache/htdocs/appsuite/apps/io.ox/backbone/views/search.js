define("io.ox/backbone/views/search",["io.ox/backbone/views/extensible","io.ox/backbone/mini-views/common","gettext!io.ox/core","less!io.ox/backbone/views/search"],function(e,t,o){"use strict";var i=!1,r={items:[],index:[],hash:{}},s=e.extend({events:{"click .dropdown-toggle":"onToggle","input .search-field":"onInput","focus .search-field":"onFocus","keydown .search-field":"onKeyDownSeachField",keyup:"onKeyUp","submit .dropdown":"onSubmit"},constructor:function(){this.model=new Backbone.Model({words:"",folder:"current"}),e.prototype.constructor.apply(this,arguments),this.$el.addClass("search-view").one("focus",".search-field",this.onFirstFocus.bind(this))},render:function(){return this.$el.append(this.$input=$('<input type="text" class="search-field" spellcheck="false" autocomplete="false">').attr("placeholder",o("New search ... (prototype)")),this.$dropdownToggle=$('<button type="button" class="dropdown-toggle"><i class="fa fa-caret-down" aria-hidden="true"></i></button>').attr({"aria-haspopup":!0,"aria-expanded":!1}),this.$dropdown=$('<form class="dropdown" autocomplete="off">'),this.$progress=$('<div class="progress">'),this.$autocomplete=$('<ul class="autocomplete address-picker scrollable">')).popover({container:"body",content:"<p>This is just a <b>prototype</b> to play around with a visually different and more explicit user interface.</p><p>Simple for the 99% use-case (just entering a word or name), still easy to use for explicit queries.</p><p>You can open a dropdown by clicking on the caret on the right-hand side.</p>",html:!0,placement:"right",title:"Please note",trigger:"manual"}),this.invoke("render")},onFirstFocus:function(){var e=this;require(["io.ox/contacts/addressbook/popup"],function(t){e.$progress.css("width","50%"),t.getAllMailAddresses().then(function(o){r.items=o.items.sort(t.sorter),r.index=o.index,r.hash=o.hash,s.picker={search:t.search,renderItems:t.renderItems,resolve:function(e){return r.hash[e]}},e.$progress.css("width","100%").delay(300).fadeOut("fast"),e.$autocomplete.on("appear",t.onAppear),e.$input.trigger("input"),e=null})})},onInput:function(){this.clear(),this.model.set(this.parseQuery()),this.renderAutoComplete()},clear:function(){var e=this.model.get("folder");this.model.clear().set("folder",e)},onFocus:function(){this.serializeQuery(),this.toggleDropdown(!1)},onToggle:function(){this.toggleDropdownWithFocus()},toggleDropdownWithFocus:function(){var e=this.isFocusInsideDropdown();this.toggleDropdown()?this.$dropdown.find(":input:first").focus():e&&this.$dropdownToggle.focus()},toggleDropdown:function(e){return void 0===e&&(e=!this.isDropdownOpen()),this.$el.toggleClass("open",e),this.$dropdownToggle.attr("aria-expanded",e),this.trigger(e?"open":"close"),this.$autocomplete.empty(),e},isDropdownOpen:function(){return this.$el.hasClass("open")},isAutocompleteOpen:function(){return this.$autocomplete.children().length},onKeyDownSeachField:function(e){var t,o,i,r,n;switch(e.which){case 13:t=this.$autocomplete.children(".selected"),this.isAutocompleteOpen()&&t.length?(o=s.picker.resolve(t.attr("data-cid")),r=this.$input.val().lastIndexOf(this.getLastWord()),this.$input.val(this.$input.val().substr(0,r)+o.email).trigger("input"),this.$autocomplete.empty(),(i=this.$input[0]).scrollLeft=i.scrollWidth):(this.toggleDropdown(!1),this.submit());break;case 38:if(n=this.$autocomplete.children(),(r=n.index(n.filter(".selected")))<=0)return;n.filter(".selected").removeClass("selected"),n.eq(r-1).addClass("selected").intoView(this.$autocomplete);break;case 40:if(n=this.$autocomplete.children(),(r=n.index(n.filter(".selected")))>=n.length-1)return;n.filter(".selected").removeClass("selected"),n.eq(r+1).addClass("selected").intoView(this.$autocomplete)}},onKeyUp:function(e){27===e.which&&this.toggleDropdown(!1)},onSubmit:function(e){e.preventDefault(),this.toggleDropdown(!1),this.serializeQuery(),this.$input.focus(),setTimeout(this.submit.bind(this),0)},submit:function(){var e=this.parseQuery();if(e.empty)return this.trigger("cancel");e.folder=this.model.get("folder"),this.trigger("search",e),i||(this.$el.popover("show"),i=!0,$(document).one("click",this.$el.popover.bind(this.$el,"hide")))},cancel:function(){return this.toggleDropdown(!1),this.$autocomplete.empty(),this.$input.val(""),this.clear(),this.trigger("cancel")},input:function(e,o){return $('<div class="form-group">').append(t.getInputWithLabel(e,o,this.model))},checkbox:function(e,o){return new t.CustomCheckboxView({name:e,label:o,model:this.model}).render().$el},select:function(e,o,i){var r=_.uniqueId("form-control-label-");return $('<div class="form-group">').append($("<label>").attr("for",r).text(o),new t.SelectView({name:e,id:r,list:i,model:this.model}).render().$el)},dateRange:function(){var e=_.uniqueId("form-control-label-"),i=_.uniqueId("form-control-label-");return $('<div class="form-group row">').append($('<div class="col-md-6">').append($("<label>").attr("for",e).text(o("After")),new t.DateView({name:"after",id:e,model:this.model,mandatory:!1}).render().$el),$('<div class="col-md-6">').append($("<label>").attr("for",i).text(o("Before")),new t.DateView({name:"before",id:i,model:this.model,mandatory:!0}).render().$el))},button:function(){return $("<div>").append($('<button type="submit" class="btn btn-primary pull-right">').text(o("Search")))},isEmpty:function(){return!this.$input.val().trim().length},isFocusInsideDropdown:function(){return $.contains(this.$dropdown[0],document.activeElement)},serializeQuery:function(){this.$input.val(_(this.model.toJSON()).chain().map(function(e,t){if(e&&"empty"!==t&&"folder"!==t)return"words"===t||"addresses"===t?e:_.isNumber(e)?t+":"+moment(e).utc(!0).format("YYYY-MM-DD"):t+":"+(String(e).indexOf(" ")>-1?'"'+e+'"':e)}).compact().value().join(" "))},parseQuery:function(){var e={words:[],addresses:[],empty:!0};return this.$input.val().trim().toLowerCase().split(/(\w+:(?:"[^"]+"|\S+)|\S+)/).forEach(function(t){if(""!==t&&" "!==t){var o=t.split(":",2),i=o[0],r=(o[1]||"").replace(/^"|"$/g,"");i&&r?"before"===(i=i.toLowerCase())||"after"===i?/^\d\d\d\d-\d\d-\d\d$/.test(r)&&(e[i]=+moment(r).utc(!0)):e[i]=r:/^[^@]+@[^@\s]*?\.\w+$/.test(t)?e.addresses.push(t):e.words.push(t),e.empty=!1}}),e.addresses=e.addresses.join(" "),e.words=e.words.join(" "),e},renderAutoComplete:function(){var e=this.getLastWord(),t=s.picker.search(e,r.index,r.hash,!0);if(!t.length)return this.$autocomplete.empty();t=_(t).filter(function(e){return!e.list&&!e.label}),s.picker.renderItems.call(this.$autocomplete,t,{isSearch:!0}),this.$autocomplete.children().removeAttr("tabindex"),this.$autocomplete.find(".contact-picture").slice(0,8).trigger("appear")},getLastWord:function(){var e=this.$input.val().match(/(\w+:)?(\S+)$/);return e?e[2]:""}});return s.picker={search:_.constant([]),renderItems:_.noop,resolve:_.noop},s});