define("io.ox/backbone/views/recurrence-view",["io.ox/core/extensions","io.ox/backbone/views/modal","io.ox/backbone/mini-views","io.ox/backbone/mini-views/datepicker","gettext!io.ox/calendar/edit/main","io.ox/calendar/util","settings!io.ox/calendar","less!io.ox/backbone/views/recurrence-view"],function(e,t,n,i,a,r,o){var s=["d","w","M","y"],l=0,d=n.InputView.extend({onChange:function(){var e=this.$el.val();e.match(/^\d+$/)&&(e=parseInt(e,10)),this.model.set(this.name,e,{validate:!0})}}),c={getStart:function(e){if(e.has("startDate"))return r.getMoment(e.get("startDate"));var t=e.get("timezone")||moment().tz();return moment.tz(e.get("start_time")||e.get("start_date"),t)},previousStart:function(e){if(e.has("startDate"))return r.getMoment(e.previous("startDate"));var t=e.get("timezone")||moment().tz();return moment.tz(e.previous("start_time")||e.previous("start_date"),t)}};e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"repeat",render:function(){var e=n.SelectView.extend({getBitmask:function(){var e,t=0;for(e=0;e<o.get("numDaysWorkweek");e++)t+=1<<(o.get("workweekStart")+e)%7;return t},onChange:function(){var e=this.$el.val(),t=parseInt(e,10),n=this.model.get("days");"2:1"===e&&(n=this.getBitmask()),this.model.get("every-weekday")&&(n=void 0),this.model.set({recurrence_type:t,days:n,"every-weekday":"2:1"===e,interval:"2:1"===e?1:this.model.get("interval")})},update:function(){var e=this.model.get(this.name);this.model.get("every-weekday")?this.$el.val("2:1"):this.$el.val(e)}});return function(){var t=_.uniqueId("form-control-label-"),n=new e({model:this.model,name:"recurrence_type",id:t,list:[{value:1,label:a("Daily")},{value:"2:1",label:a("Daily on workdays")},{value:2,label:a("Weekly")},{value:3,label:a("Monthly")},{value:4,label:a("Yearly")}]});n.listenTo(this.model,"change:recurrence_type change:every-weekday",function(e){var t=e.get("recurrence_type"),n=c.getStart(e),i=e.get("day_in_month"),a=e.get("days");i||(i=n.date(),a=void 0),1===t?e.set({days:void 0,day_in_month:void 0,month:void 0}):2===t?e.set({days:e.has("days")?e.get("days"):1<<n.day(),day_in_month:void 0,month:void 0}):3===t?e.set({days:a,day_in_month:i,month:void 0}):4===t&&e.set({days:a,day_in_month:i,month:e.has("month")?e.get("month"):n.month(),interval:1})}),this.$body.append($('<div class="form-group">').append($('<label class="control-label col-sm-4">').attr("for",t).text(a("Repeat")),$('<div class="col-sm-7">').append(n.render().$el)))}}()}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"repeat-by",render:function(){var e=n.RadioView.extend({setup:function(e){this.serialize=e.serialize,this.deserialize=e.deserialize,this.listenTo(this.model,"change:"+(this.listenTo||this.name),this.update)},onChange:function(){var e=this.$el.find('[name="'+this.name+'"]:checked').val();this.serialize(e)},update:function(){var e=this.deserialize();_.each(this.$el.find('[name="'+this.name+'"]'),function(t){e===t.value&&$(t).prop("checked",!0)})}});return function(){var t,n=_.uniqueId("form-control-label-"),i=new e({model:this.model,id:n,name:"day-of-week-or-month",listenTo:"days",list:[{label:a("Date"),value:"date"},{label:a("Weekday"),value:"weekday"}],serialize:function(e){var t=c.getStart(this.model),n=this.model.get("recurrence_type");"date"===e?this.model.set({month:4===n?t.month():void 0,days:void 0,day_in_month:t.date()}):this.model.set({month:4===n?t.month():void 0,day_in_month:1+((t.date()-1)/7>>0),days:1<<t.day()})},deserialize:function(){return this.model.has("days")?"weekday":"date"}}),r=function(e){var n=e.get("recurrence_type"),a=4===n,r=3===n||a;t.toggleClass("hidden",!r),r&&i.update()};i.listenTo(this.model,"change:recurrence_type",r),this.$body.append(t=$('<fieldset class="form-group">').append($('<legend class="control-label col-sm-4">').attr("for",n).text(a("Repeat by")),$('<div class="btn-group col-sm-8">').append(i.render().$el))),r(this.model)}}()}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"repeat-on-checkbox",render:function(){var e=n.CheckboxView.extend({setup:function(e){this.bitmask=e.bitmask,n.CheckboxView.prototype.setup.apply(this,arguments)},onChange:function(){var e=this.model.get(this.name);this.$el.prop("checked")?e|=this.bitmask:e&=~this.bitmask,this.model.set(this.name,e)},update:function(){var e=this.isModelChecked();this.$el.prop("checked",e),this.$el.parent().toggleClass("active",e),this.isModelChanged()&&this.$el.focus()},isModelChanged:function(){return 0!=(this.model.previous(this.name)&this.bitmask)!==this.isModelChecked()},isModelChecked:function(){return 0!=(this.model.get(this.name)&this.bitmask)}}),t=Backbone.View.extend({initialize:function(e){this.list=e.list},render:function(){var t=this;return this.$el.attr("data-toggle","buttons").append(_(this.list).map(function(n){var i=_.uniqueId("form-control-label-"),a=new e(_.extend({id:i,model:t.model},n.options)).render();return $('<label class="btn btn-default">').attr("for",i).toggleClass("active",a.$el.prop("checked")).append(a.$el,n.label)})),this}});return function(){var e,i=i=_.uniqueId("form-control-label-"),r=_(_.range(7)).map(function(e){return moment().weekday(e).format("dd")}),o=moment.localeData().firstDayOfWeek(),s=_(r).map(function(e,t){return{options:{bitmask:1<<(t+o)%7,name:"days"},label:e}}),l=new t({id:i,className:"btn-group",model:this.model,list:s}),d=function(t){var n=2===t.get("recurrence_type")&&!t.get("every-weekday");e.toggleClass("hidden",!n)};l.listenTo(this.model,"change:recurrence_type change:every-weekday",d),this.$body.append(e=$('<fieldset class="form-group hidden">').append($('<legend class="control-label col-sm-4">').attr("for",i).text(a("Weekday")),$('<div class="col-sm-8">').append(l.render().$el,new n.ErrorView({model:this.model,focusSelector:"input:focus",name:"days"}).render().$el))),d(this.model)}}()}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"interval",render:function(){var e,t,i=_.uniqueId("form-control-label-"),r=[a("day(s)"),a("week(s)"),a("month(s)"),a("year(s)")],o=new d({model:this.model,name:"interval",id:i}),s=function(n){var i=n.get("recurrence_type"),a=0!==i&&4!==i&&!n.get("every-weekday");e.toggleClass("hidden",!a),t.text(r[i-1])};o.listenTo(this.model,"change:recurrence_type change:every-weekday",s),this.$body.append(e=$('<div class="form-group">').append($('<label class="control-label col-sm-4 col-xs-12">').attr("for",i).text(a("Interval")),$('<div class="col-xs-8">').append(o.render().$el.addClass("small"),t=$('<span class="extra-label">'),new n.ErrorView({model:this.model,name:"interval"}).render().$el))),s(this.model)}}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"summary",render:function(){var e=n.AbstractView.extend({className:"simple-text-view col-sm-8 col-sm-offset-4",setup:function(){this.listenTo(this.model,"change",this.update)},update:function(){if(this.model.checkValidation()){var e=this.model.toJSON();this.$el.text(r.getRecurrenceDescription(e))}},render:function(){return this.update(),this}});return function(){var t=new e({model:this.model});this.$body.append($('<div class="form-group text-group">').append(t.render().$el))}}()}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"ends",render:function(){var e=n.SelectView.extend({onChange:function(){var e=this.$el.val(),t=this.getValue();if(t!==e){var n=c.getStart(this.model);if("never"===e)this.model.set({until:null,occurrences:null});else if("until"===e){var i=moment(n).add(1,s[this.model.get("recurrence_type")-1]);"occurrences"===t&&(i=moment(n).add(this.model.get("occurrences")-1,s[this.model.get("recurrence_type")-1]),i=moment.max(n,i)),this.model.set({occurrences:void 0,until:i.valueOf()})}else{var a=1;if("until"===t){var r=moment(this.model.get("until"));a=Math.ceil(r.diff(n,s[this.model.get("recurrence_type")-1],!0))+1,a=Math.max(1,a)}this.model.set({until:void 0,occurrences:a})}}},update:function(){this.$el.val(this.getValue())},getValue:function(){return this.model.has("occurrences")?"occurrences":this.model.has("until")?"until":"never"}});return function(){var t,n=_.uniqueId("form-control-label-"),i=new e({model:this.model,id:n,name:"until",list:[{label:a("Never"),value:"never"},{label:a("After a number of occurrences"),value:"occurrences"},{label:a("On specific date"),value:"until"}]}),r=function(e){var n=e.get("recurrence_type");t.toggleClass("hidden",n<=0)};i.listenTo(this.model,"change:recurrence_type",r),this.$body.append(t=$('<div class="form-group">').append($('<label class="control-label col-sm-4">').attr("for",n).text(a("Ends")),$('<div class="col-sm-7">').append(i.render().$el))),r(this.model)}}()}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"occurrences",render:function(){var e,t=_.uniqueId("form-control-label-"),i=new d({model:this.model,name:"occurrences",id:t}),r=function(t){var n=t.get("recurrence_type")>0&&t.has("occurrences");e.toggleClass("hidden",!n)};i.listenTo(this.model,"change:recurrence_type change:occurrences",r),this.$body.append(e=$('<div class="form-group hidden">').append($('<label class="control-label col-sm-4">').attr("for",t).text(a("Occurrences")),$('<div class="col-sm-8">').append(i.render().$el.addClass("small"),new n.ErrorView({model:this.model,name:"interval"}).render().$el))),r(this.model)}}),e.point("io.ox/backbone/views/recurrence-view/dialog").extend({index:l+=100,id:"until",render:function(){var e=i.extend({onError:$.noop});return function(){var t=_.uniqueId("form-control-label-"),i=new e({model:this.model,attribute:"until",clearButton:!0,display:"DATE"}),r=$('<div class="form-group">'),o=function(e){var t=e.get("recurrence_type")>0&&e.has("until");r.toggleClass("hidden",!t)};i.listenTo(this.model,"change:recurrence_type change:until",o),this.$body.append(r.append($('<label class="control-label col-sm-4">').attr("for",t).text(a("Ends on")),$('<div class="col-sm-8">').append(i.render().$el,new n.ErrorView({model:this.model,name:"until"}).render().$el))),i.$(".simple.control-label").remove(),o(this.model)}}()});var h=n.CustomCheckboxView.extend({onChange:function(){var e=this.$input.prop("checked"),t=this.model.get("recurrence_type")>0;if(!t&&e){var n=c.getStart(this.model);this.model.set({recurrence_type:2,interval:1,days:1<<n.day()})}t&&!e&&(this.model.set("recurrence_type",0),this.model.unset("interval"),this.model.unset("days"),this.model.unset("day_in_month"),this.model.unset("month"),this.model.unset("occurrences"),this.model.unset("until"))},update:function(){this.$input.prop("checked",this.model.get("recurrence_type")>0)}}),u=Backbone.Model.extend({initialize:function(e){this.on("change:interval",this.validateInterval),this.on("change:occurrences",this.validateOccurences),this.on("change:until",this.validateUntil),this.on("change:days",this.validateDays),this.set("every-weekday",2===e.recurrence_type&&62===e.days)},validateInterval:function(){var e=String(this.get("interval")),t=e.match(/^\d+$/)&&parseInt(e,10)>0;return t?this.trigger("valid:interval"):this.trigger("invalid:interval",a("Please enter a positive number")),t},validateOccurences:function(){var e=String(this.get("occurrences")),t=!this.has("occurrences")||e.match(/^\d+$/)&&parseInt(e,10)>0;return t?this.trigger("valid:occurrences"):this.trigger("invalid:occurrences",a("Please enter a positive number")),t},validateUntil:function(){var e=moment(this.get("until")),t=c.getStart(this),n=!this.has("until")||e.isAfter(t,"day")||e.isSame(t,"day");return n?this.trigger("valid:until"):this.trigger("invalid:until",a("Please insert a date after the start date")),n},validateDays:function(){if(2!==this.get("recurrence_type"))return!0;if(this.get("every-weekday"))return!0;var e=this.get("days"),t=e&&e>0;return t?this.trigger("valid:days"):this.trigger("invalid:days",a("Please select at least one day")),t},checkValidation:function(){return!!this.validateInterval()&&(!!this.validateOccurences()&&(!!this.validateUntil()&&!!this.validateDays()))}});return n.AbstractView.extend({className:"recurrence-view",events:{"click .summary":"onOpenDialog"},initialize:function(){this.originalModel=this.model,this.model=this.getMappedModel(),this.listenTo(this.model,"change:recurrence_type change:interval change:days change:day_in_month change:month change:occurrences change:until",this.updateSummary),this.listenTo(this.model,"change:start_time change:start_date change:startDate",this.onChangeStart)},getMappedModel:function(){return this.model.getRruleMapModel?this.model.getRruleMapModel():this.model},onOpenDialog:function(){var e=this;new t({title:a("Edit recurrence"),width:560,point:"io.ox/backbone/views/recurrence-view/dialog",async:!0,model:new u(this.model.pick("recurrence_type","interval","days","day_in_month","month","occurrences","until","startDate","start_time","start_date","timezone")),focus:"select"}).build(function(){this.$el.addClass("recurrence-view-dialog"),this.$body.addClass("form-horizontal")}).addCancelButton({left:!0}).addButton({label:a("Apply"),action:"apply"}).on("apply",function(){if(!this.model.checkValidation())return this.idle(),void $(".has-error input").first().focus();e.model.unset("every-weekday"),e.model.set(this.model.toJSON()),this.close()}).open(),this.trigger("openeddialog")},render:function(){return this.$el.append(new h({model:this.model,name:"recurrence_type",label:a("Repeat")}).render().$el,$('<button type="button" class="btn btn-link summary">')),this.updateSummary(),this},updateSummary:function(){var e=this.$(".summary"),t=this.model.get("recurrence_type")>0;this.$(".summary").toggleClass("hidden",!t),t&&e.text(r.getRecurrenceString(this.model))},onChangeStart:function(){var e=this.model.get("recurrence_type");if(0!==e){var t=c.previousStart(this.model),n=c.getStart(this.model),i=!1;if(!0===this.model.get("full_time")&&n.utc(),2===e){var a=n.diff(t,"days")%7,r=this.model.get("days");a<0&&(a+=7);for(var o=0;o<a;o++)(r<<=1)>127&&(r-=127);r!==this.model.get("days")&&(i=!0),this.model.set("days",r)}if(3===e||4===e)if(this.model.has("days")){var s={day_in_month:1+((n.date()-1)/7>>0),days:1<<n.day()};s.day_in_month===this.model.get("day_in_month")&&s.days===this.model.get("days")||(i=!0),this.model.set(s)}else n.date()!==this.model.get("day_in_month")&&(i=!0),this.model.set("day_in_month",n.date());4===e&&(n.month()!==this.model.get("month")&&(i=!0),this.model.set("month",n.month())),this.model.get("until")&&moment(this.model.get("until")).isBefore(n)&&this.model.set({until:void 0,occurrences:void 0}),i&&this.model.trigger("autochanged")}},dispose:function(){this.originalModel!==this.model&&this.model.stopListening(),n.AbstractView.prototype.dispose.call(this)}})});