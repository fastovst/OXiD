define.async("io.ox/realtime/polling_transport",["io.ox/core/extensions","io.ox/core/event","io.ox/core/capabilities","io.ox/core/uuids","io.ox/core/http","io.ox/realtime/stanza","io.ox/realtime/tab_id","io.ox/realtime/synchronized_http"],function(e,n,o,t,s,r,i,a){"use strict";function c(){A&&(V++,_(F).each(function(e){e(V)}),L&&setTimeout(c,1e3))}function u(){L||(L=!0,setTimeout(c,1e3))}function l(){L=!1}function g(){if(w.trace&&console.log("Drain buffer"),A&&(!_.isEmpty(H.stanzas)||!_.isEmpty(N))){w.trace&&console.log("SENDING",H.stanzas);var e=H.stanzas;H.stanzas=[],_.isEmpty(N)||(e.unshift({type:"ack",seq:_(N).keys()}),N={}),w.trace&&console.log("->",e),j=!0,w.trace&&console.log("Starting purge, so setting purging to true"),I=_.now(),a.PUT({module:"rt",params:{action:"send",resource:i},data:e,noRetry:!0,timeout:U,silent:!0,skipable:!0}).done(function(e){j=!1,w.trace&&console.log("Purged stanzas, so setting purging to false"),q(e),_.isEmpty(H.stanzas)&&_.isEmpty(N)||g()}).fail(function(e){j=!1,w.debug&&console.log("Purging call failed, setting purging to false",e),p(e),_.isEmpty(H.stanzas)&&_.isEmpty(N)||g()})}}function d(){if(w.events){var e=w.events.list();if(!e)return!1;var n=!1;return _(e).each(function(e,o){n||/^receive/.test(o)&&e.length>0&&(n=!0)}),n}}function f(e){delete z[e],T[e]&&T[e].resolve(),w.debug&&console.log("Received receipt for "+e),delete T[e]}function m(){z={},_(T).chain().values().each(function(e){e.reject()}),T={},H.stanzas=[],H.timer=!1,w.debug&&console.log("Flushing buffers and rejecting all sends"),R=!0}function h(e){w.debug&&console.log("Resetting sequence to ",e),I=_.now(),m(),a.PUT({module:"rt",params:{action:"send",resource:i},timeout:U,data:{type:"nextSequence",seq:e},silent:!0}).done(function(){w.debug&&console.log("Done resetting the sequence, no longer rejecting all sends."),R=!1,z={},_(T).chain().values().each(function(e){e.reject()}),T={},H.stanzas=[],H.timer=!1,w.debug&&console.log("Got reset command, nextSequence is ",k),k=e,D=-1,w.debug&&console.log("Sequence number was reset to "+k+". Triggering reset event."),w.trigger("reset")})}function b(e){if(w.debug&&console.log("Received  Stanza",e),B.shouldPass(e))if(e.get("atmosphere","received"))_(e.getAll("atmosphere","received")).each(function(e){f(Number(e.data))});else if(e.get("atmosphere","pong"))_(e.getAll("atmosphere","pong")).each($.noop);else if(e.get("atmosphere","nextSequence")||e.get("ox","nextSequence"))E?E=!1:(w.debug&&console.log("Got nextSequence stanza, so resetting sequence"),h(e.get("atmosphere","nextSequence").data));else if(e.get("ox","tracingDemand"))C=!!e.get("ox","tracingDemand").data;else if(e.seq>-1&&(w.debug&&console.log("Enqueueing receipt "+e.seq),N[Number(e.seq)]=1),-1===D&&e.seq>0&&(D=e.seq-1),w.debug&&console.log("SERVER THRESHHOLD: ",D,e.seq),-1===e.seq||e.seq>D||0===e.seq){var n=!1;if(e.seq>0&&e.seq-D>1&&(console.error("Received a sequence number that is too far out of order: Expected: "+(D+1)+", but got: "+e.seq),n=!0),e.seq>0&&e.seq<=D)return;if(n)w.debug&&console.log("Out of order, so resetting sequence to 0"),h(0);else{if(e.get("","error")){w.debug&&console.log("Received Stanza contained an error",e);var o=e.get("","error");o.data&&1005===o.data.code?ox.trigger("relogin:required"):o.data&&1006===o.data.code?(w.debug&&console.log("Got error 1006, so resetting sequence"),h(-1)):(w.trigger("error",e),w.trigger("error:"+e.selector,e),o.data&&o.data.code&&w.trigger("error:code:"+o.data.code,e))}else w.debug&&console.log("RECEIVED",e.seq,e),w.trigger("receive",e),w.trigger("receive:"+e.selector,e),w.trigger("receive:from:"+e.from,e);-1!==e.seq&&(D=e.seq)}}else w.debug&&console.log("Already received "+e.seq+". Waiting for "+(D+1));else w.debug&&console.log("Discarding Stanza",e.id,e.seq,e)}function p(e){return"RT_STANZA-1006"===e.code||"RT_STANZA-0006"===e.code||1006===e.code||6===e.code?(w.debug&&console.log("Got error 1006, so resetting sequence"),void h(0)):"RT_STANZA-1007"===e.code||1007===e.code?(A=!1,void v().done(function(){m(),w.trigger("reset",e)})):void 0}function q(e){I=_.now(),O.reset();var n=null;return e.acks&&_(e.acks).each(function(e){f(e)}),e.stanzas&&!_.isEmpty(e.stanzas)&&(J=_.now(),_(e.stanzas).each(function(e){b(new S(e))}),g()),e.result&&(n=new S(e.result)),e.error&&p(e.error),n}function v(){return L?A?void 0:(I=_.now(),a.GET({module:"rt",params:{action:"enrol",resource:i},timeout:U,silent:!0}).done(function(e){A=!0,q(e)}).done(g).fail(p)):$.when()}var S=r.RealtimeStanza;if(!o.has("rt")){console.error("Backend doesn't support realtime communication!");var y={send:$.noop,sendWithoutSequence:$.noop,query:function(){return $.when()}};return n.extend(y),$.Deferred().resolve(y)}var x,w={protocol:"ox"},k=0,z={},T={},D=0,E=!0,N={},R=!1,j=!1,A=!1,C=!1,U=12e4,G=U/5e3,I=_.now(),W="lazy",P={lazy:1e4,eager:1e3,lazyThreshhold:3e5,guardClear:6e5},B=function(){var e={};return{shouldPass:function(n){return!n.id||(e[n.id]?(w.debug&&console.log("I have already seen uuid "+n.id+" at "+e[n.id]),!1):(e[n.id]=_.now(),w.debug&&console.log("I have not seen uuid "+n.id+" yet"),!0))},tick:function(){var n=_.now();w.debug&&console.log("Clearing UUID guards older than "+n);var o=0;_(e).chain().keys().each(function(t){e[t]+P.guardClear>=n&&(o++,delete e[t])}),w.debug&&console.log("I have cleared "+o+" uuids at "+n)}}}(),O={value:0,threshhold:10,state:"working",systemSleep:!1,isWorking:function(){return"working"===this.state},isBrokenDueToSystemSleep:function(){return this.systemSleep},brokenDueToSystemSleep:function(){this.value=this.threshhold,this.state="broken",this.systemSleep=!0,this.trigger("broken")},increase:function(e){this.value+=e,this.trigger("change"),w.debug&&console.log("Connection does not seem to be working well. ",this.value,this.threshhold),this.value>this.threshhold&&"working"===this.state&&(this.state="broken",this.trigger("broken"))},reset:function(){this.value=0,this.systemSleep=!1,"working"!==this.state&&(this.state="working",this.trigger("working"))}};n.extend(O);var H={stanzas:[]},J=_.now(),Z=_.now(),V=0,F={},L=!1;F.expireGuards=function(e){e%300==0&&B.tick()},F.purge=function(){j||_.isEmpty(H.stanzas)||g()},F.poll=function(){if(d()){var e=_.now()-I,n=_.now()-Z,o=_.now()-J;e>U&&O.isWorking()&&(w.debug&&console.log("Connection sent last message 2 minutes ago and state is working. Could be system awake from sleep mode => triggering offline event."),O.brokenDueToSystemSleep()),n>=P[W]&&!j&&(Z=_.now(),I=_.now(),a.GET({module:"rt",params:{action:"poll",resource:i},timeout:U,silent:!0,skipable:!0}).done(q).fail(p)),W=o>=P.lazyThreshhold?"lazy":"eager"}},F.flushResendBuffer=function(e){if("broken"!==O.state){var n=!1;e%5==0&&(j?w.debug&&console.log("Skipping flush, purging or transmission in progress"):(_(z).each(function(e){e.count++,e.count>2&&(n=!0),e.count<G?w.sendWithoutSequence(e.msg):(w.debug&&console.log("Count to infinity reached, dropping message with sequence: ",e.msg.seq),delete z[Number(e.msg.seq)],T[Number(e.msg.seq)].reject(),delete T[Number(e.msg.seq)])}),n&&O.increase(1)))}else w.debug&&console.log("Skipping flush of resend buffer due to broken connection")},n.extend(w),ox.on("relogin:required",function(){w.debug&&console.log("Session seems to have expired. Relogin required."),m(),l()}),ox.on("relogin:success",function(){w.debug&&console.log("Relogin was successful, resuming operation"),A=!1,u(),v()}),ox.on("change:session",function(){w.debug&&console.log("Got a new sessionID. Resuming operation."),A=!1,u(),v()}),ox.on("connection:down connection:offline",function(){O.increase(1)}),ox.on("connection:up connection:online",function(){O.reset()}),O.on("broken",function(){function e(){w.debug&&console.log("Connection was still broken after 2 minute grace period. Triggering offline event."),w.trigger("offline"),l()}w.debug&&console.log("Connection seems to be broken. Waiting 2 minutes for the connection to return."),O.isBrokenDueToSystemSleep()?e():x=setTimeout(e,1e4)}),O.on("working",function(){w.debug&&console.log("Connection seems to be working again. Triggering online event"),x&&clearTimeout(x),w.trigger("online"),u()}),w.internal={setSequence:function(e){k=e}},w.query=function(e){var n=e.force||!1,o=$.Deferred(),s=null;if((e.trace||C)&&(delete e.trace,e.tracer=ox.user+"@"+ox.context_id+" ["+t.randomUUID()+"]"),e.seq=k,k++,s=T[Number(e.seq-1)]||$.when(),n)if("pending"===s.state())o.reject({cause:"sync_send_not_possible"});else{var r=ox.apiRoot+"/rt?action=query&session="+ox.session+"&resource="+i,c=JSON.stringify(e);try{var u={type:"text/plain; charset=utf-8"};c=new Blob([c],u),navigator.sendBeacon(r,c)}catch(e){}}else s.done(function(){I=_.now(),a.PUT({module:"rt",params:{action:"query",resource:i},timeout:U,data:e,silent:!0}).done(function(e){var n=e.stanzas;e.stanzas=[],setTimeout(function(){q({stanzas:n})},0),e.error?(p(e.error),o.reject(e)):o.resolve(q(e))}).fail(function(n){p(n),w.send({to:"devnull://sequenceDiscard",seq:e.seq,element:"message"}),o.reject(n)})});return o},w.hasPendingAcks=function(){var e=T[k];return _.isObject(e)&&"pending"===e.getState()},w.send=function(e){return w.debug&&console.log("Send",e),R||!L?(w.debug&&console.log("Not connected, so rejecting all (send)"),K.reject()):(e.seq||(e.seq=k,k++),w.sendWithoutSequence(e))},w.sendWithoutSequence=function(e){var n=$.Deferred();return R||!L?(w.debug&&console.log("Not connected, so rejecting all (sendWithoutSequence)"),n.reject()):((e.trace||C)&&(delete e.trace,e.tracer=ox.user+"@"+ox.context_id+" ["+t.randomUUID()+"]"),_.isNumber(e.bufferinterval)&&delete e.bufferinterval,_.isUndefined(e.seq)?n.resolve():(w.debug&&console.log("Enqueuing in resendBuffer ",e.seq),T[Number(e.seq)]?n=T[Number(e.seq)]:(T[Number(e.seq)]=n,z[Number(e.seq)]={count:0,msg:e})),w.debug&&console.log("Adding to sender queue ",H),H.stanzas.push(JSON.parse(JSON.stringify(e))),j||(w.debug&&console.log("Start purge process"),g()),n)},w.resource=i,u();var K=$.Deferred();return v().done(function(){K.resolve(w)}).fail(K.reject),K});