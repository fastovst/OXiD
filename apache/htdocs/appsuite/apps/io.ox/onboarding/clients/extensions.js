define("io.ox/onboarding/clients/extensions",["io.ox/backbone/mini-views/common","io.ox/onboarding/clients/api","io.ox/backbone/views/modal","io.ox/core/yell","io.ox/core/extensions","gettext!io.ox/core/onboarding"],function(t,e,i,a,n,o){"use strict";function s(t){if(_.isObject(t)&&"error"in t)return a(t.warnings?"warning":"error",t.error_desc||t.error)}var r={removeIcons:function(t){$(t.target||t).parent().find(".button-clicked").remove()},addIcon:function(t){var e=$(t.target||t);r.removeIcons(t),e.after($('<i class="fa fa-check button-clicked" aria-hidden="true">'))},disable:function(t){$(t.target||t).addClass("disabled"),$(t.target||t).prop("disabled",!0)},enable:function(t){$(t.target||t).removeClass("disabled"),$(t.target||t).prop("disabled",!1)},showWizard:function(){$(".client-onboarding, .wizard-backdrop").show()},hideWizard:function(){$(".client-onboarding, .wizard-backdrop").hide()}};return{ActionsListView:Backbone.View.extend({events:{"click .section-title":"accordion","click .toggle-link":"toggleMode"},initialize:function(t){_.extend(this,t),this.setElement($('<div class="actions">')),this.register()},register:function(){var t=this.wizard;this.$el.on("click",".action",function(e){var i=$(this).attr("data-action"),a=$(e.target),n=a.hasClass("action-call")?"action:execute":"action:select",o=a.attr("data-detail");t.trigger(n,i,o)})},getToggleNode:function(){var t=_.uniqueId("description");return[$('<div class="sr-only">').attr("id",t).text(o("Show or hide alternative options for advanced users.")),$('<a href="#" class="toggle-link" data-value="to-advanced">').attr("aria-describedby",t).text(o("Show more options")),$('<a href="#" class="toggle-link" data-value="to-simple">').attr("aria-describedby",t).text(o("Show less options"))]},toggleMode:function(t){t.preventDefault();var e=this.$el.closest(".wizard-step"),i="advanced"===e.attr("data-mode");return e.attr("data-mode",i?"simple":"advanced"),this.wizard.trigger("mode:toggle",i?"simple":"advanced"),this.update()},update:function(){var t=this.$el.find(".actions-scenario"),e=this.$step.attr("data-mode");_.each(t,function(t){if((t=$(t)).find("advanced"===e?".action":".action:visible").length<=1)return t.addClass("single-action");t.removeClass("single-action")})},render:function(){var t=this.scenarios,e=this.config,i=this;return _.each(t,function(t){var a=e.getActions(t.id)||[],o=$('<div class="actions-scenario hidden" role="tablist">').attr("data-parent",t.id),s=n.Baton({data:a,config:e,model:e.model});_.each(s.data,function(t){o.attr("data-value",t.id);var e=n.point("io.ox/onboarding/clients/views/"+t.type);0===e.list().length&&ox.debug&&console.error("missing view for client-onboarding action: "+t.id),e.invoke("draw",o,t,s)}),s.data.length>1&&o.append(i.getToggleNode()),this.$el.append(o),this.$el.find(".action:first").addClass("expanded")}.bind(this)),this.update(),this},accordion:function(t){t.preventDefault();var e=$(t.target).closest(".action");e.closest(".actions").find(".action:visible").length<=1?e.addClass("expanded").find(".section-title").attr("aria-pressed",!0):e.toggleClass("expanded").find(".section-title").attr("aria-pressed",e.hasClass("expanded")),e.closest(".actions-scenario").find(".action").not(e).removeClass("expanded").find(".section-title").attr("aria-pressed",!1)}}),DisplayActionView:Backbone.View.extend({initialize:function(t,e){_.extend(this,t),this.model=e.baton.model,this.config=e.baton.config,this.setElement($('<fieldset class="action form-group">').attr("data-action",t.id))},render:function(){var t=_.uniqueId("controls");return this.$el.empty().append($('<button class="title section-title" role="tab">').attr("aria-controls",t).append($('<i class="fa fa-fw fa-chevron-right" aria-hidden="true"> '),$('<i class="fa fa-fw fa-chevron-down" aria-hidden="true">'),$.txt(o("Manual Configuration"))),$('<pre class="config">').append($("<div>").append(_.map(this.data,function(t){var e=!("value"in t);return $('<div class="property">').addClass(e?"title":"").text(t.name+(e?"":":"))})),$("<div>").append(_.map(this.data,function(t){var e=!("value"in t);return $('<div class="value">').text(e?" ":t.value).addClass(e?"title":"")})))),this}}),ShortMessageActionView:Backbone.View.extend({tagName:"fieldset",className:"action form-group",events:{"click .btn":"_onClick","keyup input":"_updateState","change input":"_updateState"},initialize:function(t,e){_.extend(this,t),this.model=e.baton.model,this.config=e.baton.config,this.$el.attr("data-action",t.id)},_input:function(){var e=this.model.get("sms")||this.config.getUserMobile();return new t.InputView({name:"sms",type:"tel",model:this.model}).render().$el.removeClass("form-control").addClass("field form-control").attr("title",this.name).attr("list","addresses").attr("placeholder",o("Cell phone")).val(e).trigger("change")},_select:function(){var e=new t.SelectView({name:"code",model:this.model,list:this.config.getCodes()}),i=this.default;return e.render().$el.removeClass("form-control").addClass("select form-control").attr("title",this.name).attr("list","addresses").val(this.model.get("code")||this.config.getCodes(i).value).trigger("change"),e},render:function(){var t=_.uniqueId("description");return this.$el.empty().append($('<button class="title section-title" role="tab">').attr("aria-describedby",t).append($('<i class="fa fa-fw fa-chevron-right" aria-hidden="true"> '),$('<i class="fa fa-fw fa-chevron-down" aria-hidden="true">'),$.txt(o("Automatic Configuration (via SMS)"))),$('<span class="content">').append($('<div class="description">').attr("id",t).text(o("Please enter your mobile phone number, and we´ll send you a link to automatically configure your iOS device! It´s that simple!")),$('<div class="interaction">').append($('<form class="form-inline">').append($('<div class="row">').append(this._select().$el,this._input(),$('<button type="button" class="btn btn-primary action-call">').text(o("Send"))))))),this},getNumber:function(){var t=this.model.get("sms"),e=this.model.get("code");return t=t.replace(/[^\d+]+/g,""),e=e.replace(/[^\d+]+/g,""),t=t.replace(/^00/,"+"),this.config.find(t)?t:(t=t.replace(/[\D]+/g,""),t=t.replace(/^0+/,""),e+t)},_updateState:function(t){if(13!==t.which){var e=$(t.target).val().trim(),i=this.$("button.action-call");if(r.removeIcons(i),!e.length)return r.disable(i);r.enable(i)}},_onClick:function(t){t.preventDefault();var a=this.config.getScenarioCID(),n=this.id,l={sms:this.getNumber()};r.disable(t),r.hideWizard(),new i({title:o("Please confirm"),width:600}).build(function(){this.$body.text(o("Link will be sent to %1$s",l.sms))}).addCancelButton({left:!0}).addButton({action:"apply",label:o("Send")}).on("apply",function(){e.execute(a,n,l).always(s).done(_.partial(r.addIcon,t)).fail(_.partial(r.removeIcons,t)).fail(_.partial(r.enable,t))}).on("cancel",function(){r.showWizard(),r.enable(t)}).open()}}),EmailActionView:Backbone.View.extend({events:{"click .btn":"_onClick","keyup input":"_updateState","change input":"_updateState"},initialize:function(t,e){_.extend(this,t),this.model=e.baton.model,this.config=e.baton.config,this.setElement($('<fieldset class="action form-group">').attr("data-action",t.id))},_input:function(){var e=this.model.get("email")||this.config.getUserMail();return new t.InputView({name:"email",model:this.model}).render().$el.addClass("field form-control").attr("title",this.name).attr("list","addresses").val(e||"").trigger("change")},render:function(){var t=_.uniqueId("description");return this.$el.empty().append($('<button class="title section-title" role="tab">').attr("aria-describedby",t).append($('<i class="fa fa-fw fa-chevron-right" aria-hidden="true"> '),$('<i class="fa fa-fw fa-chevron-down" aria-hidden="true">'),$.txt(o("Configuration Email"))),$('<span class="content">').append($('<div class="description">').attr("id",t).text(this.description),$('<div class="interaction">').append($('<form class="form-inline">').append($('<div class="row">').append(this._input(),$('<button type="button" class="btn btn-primary action-call">').text(o("Send"))))))),this},_updateState:function(t){if(13!==t.which){var e=$(t.target).val().trim(),i=this.$("button.action-call");if(r.removeIcons(i),!e.length)return r.disable(i);r.enable(i)}},_onClick:function(t){t.preventDefault();var i=this.config.getScenarioCID(),a=this.id,n={email:this.model.get("email")};e.execute(i,a,n).always(s).done(_.partial(r.addIcon,t)).fail(_.partial(r.removeIcons,t)).fail(_.partial(r.enable,t))}}),DownloadActionView:Backbone.View.extend({events:{"click .btn":"_onClick"},initialize:function(t,e){_.extend(this,t),this.model=e.baton.model,this.config=e.baton.config,this.setElement($('<fieldset class="action form-group">').attr("data-action",t.id))},render:function(){var t=_.uniqueId("description-");return this.$el.empty().append($('<button class="title section-title" role="tab">').append($('<i class="fa fa-fw fa-chevron-right" aria-hidden="true"> '),$('<i class="fa fa-fw fa-chevron-down" aria-hidden="true">'),$.txt(o("Automatic Configuration"))),$('<span class="content">').append($('<div class="description">').attr("id",t).text(this.description),$('<button type="button" class="btn btn-primary action-call">').attr("aria-describedby",t).text(o("Download profile")))),this},_onClick:function(t){t.preventDefault();var i=e.getUrl(this.config.getScenarioCID(),this.id);require(["io.ox/core/download"],function(t){t.url(i)})}}),ClientActionView:Backbone.View.extend({events:{"click .action-call":"_onClick"},initialize:function(t,e){_.extend(this,t),this.model=e.baton.model,this.config=e.baton.config,this.setElement($('<fieldset class="action form-group">').attr("data-action",t.id))},getImage:function(){return this.image||this.imageplaceholder?$('<a href="#" class="app">').append($('<img class="app-icon action-call" role="button">').attr({"data-detail":this.store.name,src:this.image||this.imageplaceholder})):$()},getButton:function(){return this.store.image?$('<a href="#" class="store">').append($('<img class="store-icon action-call" role="button">').attr({"data-detail":this.store.name,src:this.store.image})):$('<button type="button" class="btn btn-primary action-call">').text(o("Download"))},render:function(){var t=_.uniqueId("description");return this.$el.empty().append($('<button class="title section-title" role="tab">').attr("aria-describedby",t).append($('<i class="fa fa-fw fa-chevron-right" aria-hidden="true"> '),$('<i class="fa fa-fw fa-chevron-down" aria-hidden="true">'),$.txt(o("Installation"))),$('<span class="content">').append($('<div class="description">').attr(t,t).text(this.store.description),this.getImage(),this.getButton())),this},_onClick:function(t){t.preventDefault(),window.open(this.link)}})}});