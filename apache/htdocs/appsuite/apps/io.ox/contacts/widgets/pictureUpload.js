define("io.ox/contacts/widgets/pictureUpload",["io.ox/backbone/views/disposable","io.ox/backbone/views/edit-picture","io.ox/core/notifications","io.ox/contacts/api","io.ox/core/util","io.ox/core/strings","gettext!io.ox/contacts","settings!io.ox/contacts"],function(e,i,t,o,n,a,l,s){"use strict";function r(e){var i=$.Deferred(),t=new FileReader;return t.onload=function(t){i.resolve(e,t.target.result)},t.onerror=function(t){i.reject(e,t)},t.readAsDataURL(e),i}function c(e){return e&&s.get("maxImageSize")&&e.size>s.get("maxImageSize")}var d=(_.device("IE")||_.device("edge"))&&!_.device("edgechromium");return e.extend({className:"contact-photo-upload",events:{"change .file":"onFileSelect","focus .file":"toggleFocus","blur .file":"toggleFocus","click .file":"onClick","click .contact-photo":"onClickContainer"},initialize:function(){this.listenTo(this.model,"change:pictureFileEdited",this.onChangeFile)},onClick:function(e,i){var t=i||{};e.stopPropagation(),t.forceUpload||d||(e.preventDefault(),this.openEditDialog())},onClickContainer:function(){return d?this.openFilePicker():this.openEditDialog()},removeImage:function(e){e&&e.stopImmediatePropagation(),this.model.set({pictureFile:void 0,pictureFileEdited:"",crop:"",image1:"",image1_url:""}),this.$('input[type="file"]').val("")},openFilePicker:function(){this.$('input[type="file"]').trigger("click",{forceUpload:!0})},openEditDialog:function(){this.editPictureDialog&&this.editPictureDialog.close&&this.editPictureDialog.close(),this.editPictureDialog=i.getDialog({model:this.model,title:l("Change contact photo")}).open().on("upload",this.openFilePicker.bind(this)).on("reset",this.removeImage.bind(this))},onChangeFile:function(){var e=this.model.get("pictureFileEdited");c(e)&&(this.model.unset("pictureFileEdited",{silent:!0}),t.yell("error",l("The photo exceeds the allowed file size of %1$s",a.fileSize(s.get("maxImageSize"),2)))),e&&(e.lastModified||e.lastModifiedDate)&&(this.$thumbnail.css("background-image","none").busy(),r(e).done(function(e,i){this.$thumbnail.idle(),this.model.set({image1_url:"",image1_data_url:i})}.bind(this)))},onFileSelect:function(e){var i=e.target.files[0];if(i&&!/(jpg|jpeg|gif|bmp|png)/i.test(i.type))return t.yell("error",l('The file type "%1$s" cannot be used as a contact photo. Supported file types are JPEG, GIF, BMP, and PNG.',i.type));if(i){if(d)return this.model.unset("pictureFileEdited",{silent:!0}),this.model.set("pictureFileEdited",i);this.removeImage(),this.model.unset("pictureFile",{silent:!0}),this.model.set("pictureFile",i),this.openEditDialog()}},toggleFocus:function(e){this.$thumbnail.toggleClass("focus","focusin"===e.type)},render:function(){var e=_.uniqueId("image-upload-");return this.$el.append(this.$thumbnail=$('<div class="contact-photo empty">').append($("<label>").attr("for",e).text(l("Click to add photo"))),$("<form>").append($('<input type="file" name="file" class="file" accept="image/*">').attr("id",e))),this.listenTo(this.model,"change:image1_url change:image1_data_url",_.debounce(this.renderImage)),this.renderImage(),this},renderImage:function(){if(!this.disposed){var e=this.model.get("image1_data_url")||this.getImageUrl();this.$("label").toggleClass("sr-only",!!e),this.$("button").toggle(!!e),this.$thumbnail.css("background-image","none").toggleClass("empty",!e),e&&(this.$thumbnail.busy(),$("<img>").attr("src",e).one("load",function(){this.$thumbnail.idle().css("background-image","url("+e+")")}.bind(this)))}},getImageUrl:function(){var e=this.model.get("image1_url");return e?/^data:/i.test(e)?e:n.getShardingRoot(n.replacePrefix(e+"&"+$.param({uniq:_.now()}))):""}})});