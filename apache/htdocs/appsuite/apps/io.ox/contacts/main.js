define("io.ox/contacts/main",["io.ox/contacts/util","io.ox/core/util","io.ox/contacts/api","io.ox/core/tk/vgrid","io.ox/contacts/view-detail","io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/core/commons","io.ox/core/capabilities","io.ox/contacts/toolbar","gettext!io.ox/contacts","settings!io.ox/contacts","io.ox/core/folder/api","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/contacts/mobile-navbar-extensions","io.ox/contacts/mobile-toolbar-actions","less!io.ox/contacts/style"],function(e,t,o,a,n,i,r,c,s,d,l,p,g,u,f,b,m){"use strict";var h=ox.ui.createApp({name:"io.ox/contacts",id:"io.ox/contacts",title:"Address Book"});return h.mediator({"pages-mobile":function(e){if(!_.device("!smartphone")){var t=e.getWindow(),o=$('<div class="mobile-navbar">'),a=$('<div class="mobile-toolbar">').on("hide",function(){t.nodes.body.removeClass("mobile-toolbar-visible")}).on("show",function(){t.nodes.body.addClass("mobile-toolbar-visible")}),n=i.Baton({app:e});e.navbar=o,e.toolbar=a,e.pages=new f({appname:e.options.name,toolbar:a,navbar:o,container:t.nodes.main}),t.nodes.body.addClass("classic-toolbar-visible").append(o,a),e.pages.addPage({name:"folderTree",navbar:new u.NavbarView({baton:n,extension:"io.ox/contacts/mobile/navbar"})}),e.pages.addPage({name:"listView",startPage:!0,navbar:new u.NavbarView({baton:n,extension:"io.ox/contacts/mobile/navbar"}),toolbar:new u.ToolbarView({baton:n,page:"listView",extension:"io.ox/contacts/mobile/toolbar"}),secondaryToolbar:new u.ToolbarView({baton:n,page:"detailView",extension:"io.ox/contacts/mobile/toolbar"})}),e.pages.addPage({name:"detailView",navbar:new u.NavbarView({baton:n,extension:"io.ox/contacts/mobile/navbar"}),toolbar:new u.ToolbarView({baton:n,page:"detailView",extension:"io.ox/contacts/mobile/toolbar"})}),e.pages.setBackbuttonRules({listView:"folderTree"})}},"pages-desktop":function(e){_.device("smartphone")||(e.pages=new f(e),e.getWindow().nodes.main.addClass("vsplit"),e.pages.addPage({name:"listView",container:e.getWindow().nodes.main,classes:"leftside border-right"}),e.pages.addPage({name:"detailView",container:e.getWindow().nodes.main,classes:"rightside"}))},subscription:function(e){e.subscription={wantedOAuthScopes:["contacts_ro"]}},"folder-view-mobile":function(e){if(!_.device("!smartphone")){var t=e.pages.getNavbar("folderTree"),o=e.pages.getPage("folderTree");t.on("rightAction",function(){e.toggleFolders()});var a=new b({app:e,contextmenu:!0,flat:!0,indent:!1,module:"contacts"});m.initialize({app:e,tree:a}),o.append(a.render().$el)}},vsplit:function(e){var t=e.pages.getPage("listView"),o=e.pages.getPage("detailView");e.left=t,e.right=o.addClass("default-content-padding f6-target").attr({tabindex:-1,"aria-label":l("Contact Details")}).scrollable()},vgrid:function(a){var n=a.grid,r=a.settings.get("vgrid/width/"+_.display());!_.device("touch")&&r&&(a.right.parent().css("left",r+"px"),a.left.css("width",r+"px")),a.left.append(a.gridContainer),n.addTemplate({build:function(){var e,t,o,a,n;return this.addClass("contact").append(a=$('<div class="contact-photo">').attr("aria-hidden",!0),n=$('<i class="fa fa-lock private_flag" aria-hidden="true">').hide(),e=$('<div class="fullname">').attr("aria-hidden",!0),t=$('<div class="description">').attr("aria-hidden",!0),o=$('<div class="gray">').attr("aria-hidden",!0)),{name:e,private_flag:n,description:t,location:o,photo:a}},set:function(a,n){var i,r,c;if(!0===a.mark_as_distributionlist)r=a.display_name||"",n.name.text(r),n.private_flag.get(0).style.display=a.private_flag?"":"none",n.description.text(l("Distribution list")),n.location.text(""),n.photo.empty().append('<i class="fa fa-bars">').css("background-image","");else{(i=$.trim(e.getFullName(a)))?(r=i,n.name.empty().append(t.renderPersonalName({html:e.getFullName(a,!0)},a))):(r=$.trim(e.getFullName(a)||a.yomiLastName||a.yomiFirstName||a.display_name||e.getMail(a)),n.name.empty().append(t.renderPersonalName({name:r},a))),c=e.getSummaryBusiness(a),n.private_flag.get(0).style.display=a.private_flag?"":"none",n.description.text(c),n.location.text(e.getSummaryLocation(a));var s=o.getContactPhotoUrl(a,48);n.photo.empty().text(s?"":e.getInitials(a)).css("background-image",s?"url("+s+")":"").toggleClass("empty",!s),""===r&&""===c?(n.name.addClass("gray").text(l("Empty name and description found.")),n.description.text(l("Edit to set a name."))):n.name.removeClass("gray")}this.attr("aria-label",r)}});var s=function(e){return $.trim(e.sort_name||"Ω").slice(0,1).toUpperCase().slice(0,1).replace(/[ÄÀÁÂÃÄÅ]/g,"A").replace(/[Ç]/g,"C").replace(/[ÈÉÊË]/g,"E").replace(/[ÌÍÎÏ]/g,"I").replace(/[Ñ]/g,"N").replace(/[ÖÒÓÔÕØ]/g,"O").replace(/[ß]/g,"S").replace(/[ÜÙÚÛ]/g,"U").replace(/[ÝŸ]/g,"Y").replace(/[[\u0000-\u0040\u005B-\u017E]/g,"#").replace(/[^A-Z#]/,"Ω")};i.point("io.ox/contacts/getLabel").each(function(e){e.getLabel&&(s=e.getLabel)}),n.addLabelTemplate({build:function(){this.addClass("vgrid-label")},set:function(e){this.text(s(e))}}),n.requiresLabel=function(e,t,o){if(!t)return!1;var a=s(t);return(0===e||a!==o)&&a},c.wireGridAndAPI(n,o)},thumbindex:function(e){function t(e){if(!(this instanceof t))return new t(e);_.isString(e)?this.text=e:_.extend(this,e||{})}var o="#ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");t.prototype.draw=function(e){var t=$('<li class="thumb-index" role="option">').attr("id",_.uniqueId("ti_")).text(this.label||this.text);return this.enabled(e)?t.data("text",this.text):t.addClass("thumb-index-disabled").attr("aria-disabled",!0),t},t.prototype.enabled=function(e){return this.text in e.labels},e.Thumb=t,e.left.prepend(e.thumbs=$('<ul class="atb contact-grid-index listbox" tabindex="0" role="listbox">').attr("aria-label",l("Starting letter index")).on("click",".thumb-index",function(t,o){o=_.extend({inputdevice:"mouse"},o);var a=$(this).data("text"),n=_.device("smartphone")||"keyboard"!==o.inputdevice;a&&e.grid.scrollToLabelText(a,n)}).on("touchmove",function(t){if(t.preventDefault(),t.originalEvent&&t.originalEvent.targetTouches){var o=t.originalEvent.targetTouches[0],a=o.clientX,n=o.clientY,i=document.elementFromPoint(a,n),r=$(i).data("text");r&&e.grid.scrollToLabelText(r,_.device("smartphone"))}}));var a=new i.Baton({app:e,data:[],Thumb:t});i.point("io.ox/contacts/thumbIndex").extend({index:100,id:"draw",draw:function(){a.labels=e.grid.getLabels().textIndex||{},i.point("io.ox/contacts/thumbIndex").invoke("getIndex",e.thumbs,a),e.thumbs.empty(),_(a.data).each(function(t){e.thumbs.append(t.draw(a))})},getIndex:function(e){var t=_(e.labels).keys();e.data=_.map(o,e.Thumb),_(t).any(function(e){return"Ω"===e})&&e.data.push(new e.Thumb({label:"Ω",text:"Ω",enabled:_.constant(!0)}))}})},"navbars-mobile":function(e){_.device("smartphone")&&(e.pages.getNavbar("listView").setLeft(l("Folders")).setRight(l("Edit")),e.pages.getNavbar("folderTree").setTitle(l("Folders")).setLeft(!1).setRight(l("Edit")),e.pages.getNavbar("detailView").setTitle("").setLeft(l("Back")))},"toolbars-mobile":function(){_.device("smartphone")&&(h.pages.getNavbar("listView").on("leftAction",function(){h.pages.goBack()}),h.pages.getNavbar("detailView").on("leftAction",function(){h.pages.goBack()}),h.pages.getNavbar("listView").on("rightAction",function(){!0===h.props.get("checkboxes")?(h.grid.selection.clear(),h.pages.getNavbar("listView").setRight(l("Edit")).show(".left")):h.pages.getNavbar("listView").setRight(l("Cancel")).hide(".left"),h.props.set("checkboxes",!h.props.get("checkboxes"))}))},"swipe-mobile":function(){},"show-contact":function(e){if(!_.device("smartphone")){var t,a,r,s=e.grid;(t=function(t){e.right.busy(!0),t&&void 0!==t.id?(e.currentContact=o.reduce(t),o.get(e.currentContact).done(_.lfo(a)).fail(_.lfo(r,t))):e.right.idle().empty()}).cancel=function(){_.lfo(a),_.lfo(r)},a=function(t){var o=i.Baton({data:t,app:e});o.disable("io.ox/contacts/detail","inline-actions"),"all"===s.getMode()&&o.disable("io.ox/contacts/detail","breadcrumb"),e.right.idle().empty().append(n.draw(o))},r=function(o){e.right.idle().empty().append($.fail(l("Couldn't load contact data."),function(){t(o)}))},e.showContact=t,c.wireGridAndSelectionChange(s,"io.ox/contacts",t,e.right,o)}},"show-contact-mobile":function(e){if(!_.device("!smartphone")){var t,a,r,s=e.grid;(t=function(t){t&&void 0!==t.id?(e.right.empty().busy(),e.currentContact=o.reduce(t),o.get(e.currentContact).done(_.lfo(a)).fail(_.lfo(r,t))):e.right.idle()}).cancel=function(){_.lfo(a),_.lfo(r)},a=function(t){var o=i.Baton({data:t,app:e});o.disable("io.ox/contacts/detail","inline-actions"),e.right.idle().empty().append(n.draw(o))},r=function(o){e.right.idle().empty().append($.fail(l("Couldn't load contact data."),function(){t(o)}))},e.showContact=t,c.wireGridAndSelectionChange(s,"io.ox/contacts",t,e.right,o)}},"select:contact-mobile":function(e){_.device("!smartphone")||e.grid.getContainer().on("click",".vgrid-cell.selectable",function(){!0!==e.props.get("checkboxes")&&(e.grid.selection.trigger("pagechange:detailView"),e.pages.changePage("detailView"))})},"selection-doubleclick":function(e){_.device("smartphone")||e.grid.selection.on("selection:doubleclick",function(e,t){ox.launch("io.ox/contacts/detail/main",{cid:t})})},"delete:contact-mobile":function(e){_.device("!smartphone")||o.on("delete",function(){"detailView"===e.pages.getCurrentPage().name&&e.pages.goBack()})},"update:image":function(){o.on("update:image",function(e,t){_.cid(t)===_.cid(h.currentContact)&&h.showContact(h.currentContact)})},"folder-view":function(e){e.treeView=new b({app:e,contextmenu:!0,flat:!0,indent:!1,module:"contacts"}),m.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable()},props:function(e){e.props=new Backbone.Model({checkboxes:!_.device("smartphone")&&e.settings.get("showCheckboxes",!1),mobileFolderSelectMode:!1})},"vgrid-checkboxes":function(e){_.device("smartphone")||e.getGrid().setEditable(e.props.get("checkboxes"))},"vgrid-checkboxes-mobile":function(e){if(!_.device("!smartphone")){var t=e.getGrid();e.props.on("change:checkboxes",function(){t.setEditable(e.props.get("checkboxes"))})}},"prop-fullnameformat":function(e){p.on("change:fullNameFormat",function(){e.showContact(e.currentContact)})},"prop-mapService":function(e){p.on("change:mapService",function(){e.showContact(e.currentContact)})},"prop-folderview":function(e){e.props.set("folderview",!_.device("smartphone")&&e.settings.get("folderview/visible/"+_.display(),!0))},"store-view-options":function(e){_.device("smartphone")||e.props.on("change",_.debounce(function(){if(!e.props.get("find-result")){var t=e.props.toJSON();e.settings.set("showCheckboxes",t.checkboxes).save()}},500))},"change:folderview":function(e){_.device("smartphone")||(e.props.on("change:folderview",function(t,o){e.folderView.toggle(o)}),e.on("folderview:close",function(){e.props.set("folderview",!1)}),e.on("folderview:open",function(){e.props.set("folderview",!0)}))},"change:folder":function(e){_.device("smartphone")||e.grid.on("change:ids",function(){i.point("io.ox/contacts/thumbIndex").invoke("draw",e.thumbs,e.baton)})},"folder-view-mobile-listener":function(){_.device("!smartphone")||h.pages.getPage("folderTree").on("click",".folder.selectable",function(e){if(!0!==h.props.get("mobileFolderSelectMode")){var t=$(e.target).closest(".folder").data("id");g.isVirtual(t)||h.pages.changePage("listView")}else $(e.currentTarget).trigger("contextmenu")})},"change:folder-mobile":function(){_.device("!smartphone")||h.grid.on("change:ids",function(){i.point("io.ox/contacts/thumbIndex").invoke("draw",h.thumbs,h.baton),h.folder.getData().done(function(e){h.pages.getNavbar("listView").setTitle(e.title)})})},"toggle-folder-editmode":function(e){if(!_.device("!smartphone")){e.toggleFolders=function(){var t=e.pages.getPage("folderTree"),o=e.props.get("mobileFolderSelectMode"),a=l(o?"Edit":"Cancel");e.props.set("mobileFolderSelectMode",!o),e.pages.getNavbar("folderTree").setRight(a),t.toggleClass("mobile-edit-mode",!o)}}},"change:checkboxes":function(e){_.device("smartphone")||e.props.on("change:checkboxes",function(t,o){e.getGrid().setEditable(o)})},"folderview-toolbar":function(e){_.device("smartphone")||c.mediateFolderView(e)},"premium-area":function(e){i.point("io.ox/contacts/sidepanel").extend({id:"premium-area",index:1e4,draw:function(){this.append(c.addPremiumFeatures(e,{append:!1,upsellId:"folderview/contacts/bottom",upsellRequires:"carddav"}))}})},"folder-error":function(e){e.folder.handleErrors()},"api-events":function(e){o.on("create update delete refresh.all",function(){g.reload(e.folder.get())})},import:function(){o.on("import",function(){o.trigger("update:"+_.ecid(h.currentContact))})},"api-create-event":function(e){_.device("smartphone")||o.on("create",function(t,o){o.folder_id=o.folder_id||o.folder,e.folder.set(o.folder_id).done(function(){e.grid.setPreSelection(o)})})},"drag-and-drop":function(e){e.getWindow().nodes.outer.on("selection:drop",function(e,t){r.invoke("io.ox/contacts/actions/move",t)})},"inplace-find":function(e){!_.device("smartphone")&&s.has("search")&&e.isFindSupported()&&e.initFind()},"contextual-help":function(e){e.getContextualHelp=function(){return"ox.appsuite.user.sect.contacts.gui.html"}},sidepanel:function(e){i.point("io.ox/contacts/sidepanel").extend({id:"tree",index:100,draw:function(e){this.addClass("border-right").append(e.app.treeView.$el)}});var t=e.getWindow().nodes.sidepanel;i.point("io.ox/contacts/sidepanel").invoke("draw",t,i.Baton({app:e}))},detailviewResizehandler:function(e){_.device("smartphone")||(e.right.toggleClass("small-width",e.right.width()<500),$(document).on("resize",function(){e.right.toggleClass("small-width",e.right.width()<500)}))},metrics:function(e){require(["io.ox/metrics/main"],function(t){function o(e,o){var a=!!(o=$(o)).attr("data-name"),n=(o.attr("data-action")||"").replace(/^io\.ox\/contacts\/(detail\/)?/,"");t.trackEvent({app:"contacts",target:e,type:"click",action:a?o.attr("data-name"):n,detail:a?o.attr("data-value"):""})}if(t.isEnabled()){var a=e.getWindow().nodes,n=a.sidepanel;a.body.on("track",".classic-toolbar-container",function(e,t){o("toolbar",t)}),a.main.find(".vgrid-toolbar").on("mousedown","a[data-name], a[data-action]",function(e){var o=$(e.currentTarget),a=o.attr("data-name")||o.attr("data-action");a&&t.trackEvent({app:"contacts",target:"list/toolbar",type:"click",action:a})}),_.defer(function(){n.find(".context-dropdown").on("mousedown","a",function(e){t.trackEvent({app:"contacts",target:"folder/context-menu",type:"click",action:$(e.currentTarget).attr("data-action")})})}),n.find(".bottom").on("mousedown","a[data-action]",function(e){$(e.currentTarget).attr("data-action")&&t.trackEvent({app:"contacts",target:"folder/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})}),e.on("folder:change folder-virtual:change",function(e){t.getFolderFlags(e).then(function(e){t.trackEvent({app:"contacts",target:"folder",type:"click",action:"select",detail:e.join("/")})})}),e.grid.selection.on({change:function(e,o,a){a&&a.retriggerUnlessEmpty||o.length&&t.trackEvent({app:"contacts",target:"list",type:"click",action:"select",detail:o.length>1?"multiple":"one"})}})}})}}),h.setLauncher(function(e){var t=ox.ui.createWindow({name:"io.ox/contacts",chromeless:!0,find:s.has("search")});h.setWindow(t),h.settings=p,h.gridContainer=$('<div class="abs border-left border-right contact-grid-container">').attr({role:"navigation","aria-label":l("Contacts")}),h.grid=new a(h.gridContainer,{settings:p,hideTopbar:_.device("smartphone"),hideToolbar:_.device("smartphone"),containerLabel:l("Contact list. Select a contact to view details."),dividerThreshold:p.get("dividerThreshold",30)}),h.gridContainer.find(".vgrid-toolbar").attr("aria-label",l("Contacts toolbar")),c.wireGridAndWindow(h.grid,t),c.wireFirstRefresh(h,o),c.wireGridAndRefresh(h.grid,o,t),_.device("!smartphone")&&c.addGridToolbarFolder(h,h.grid,"CONTACTS"),h.getGrid=function(){return h.grid},s.has("gab !alone")&&!e.folder&&h.settings.get("startInGlobalAddressbook",!0)&&(e.folder="6");var n=$.Deferred();return c.addFolderSupport(h,h.grid,"contacts",e.folder).always(function(){h.mediate(),n.resolve(),t.show()}),n}),h.setResume(function(e){if(e&&e.folder&&e.folder!==this.folder.get()){var t=this.getWindow();return t.busy(),this.folder.set(e.folder).always(function(){t.idle()})}return $.when()}),{getApp:h.getInstance}});