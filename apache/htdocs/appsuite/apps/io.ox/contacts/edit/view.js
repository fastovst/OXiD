define("io.ox/contacts/edit/view",["io.ox/backbone/views/extensible","io.ox/backbone/mini-views","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/attachments","io.ox/contacts/util","io.ox/contacts/api","io.ox/core/api/user","io.ox/core/a11y","io.ox/core/util","io.ox/core/capabilities","io.ox/contacts/widgets/pictureUpload","io.ox/core/yell","io.ox/core/extensions","io.ox/core/tk/upload","settings!io.ox/core","settings!io.ox/contacts","gettext!io.ox/contacts","less!io.ox/contacts/style"],function(e,t,i,s,n,a,r,o,l,d,h,c,u,m,f,p,g){"use strict";function y(e){return{error:_.map(e,function(e,t){return(v.i18n[t]||t)+": "+e}).join("\n")}}var v=e.extend({point:"io.ox/contacts/edit/view",className:"contact-edit form-horizontal",events:{"click [data-remove]":"onRemoveField"},initialize:function(e){this.model=new v.ContactModel(e.data),this.visible={},this.disabled={},(!d.has("read_create_shared_folders")||this.model.isUserMode()||e.isPublic)&&(this.disabled.private_flag=!0)},extensions:{header:function(){this.renderHeader()},fields:function(){this.renderAllFields()},attachments:function(){f.get("features/PIMAttachments",d.has("filestore"))&&!this.model.isUserMode()&&(this.renderAttachments(),this.renderDropzone())},footer:function(){this.renderFooter()}},renderHeader:function(){this.$el.append($('<div class="contact-header form-group">').append($('<div class="col-xs-3 col-sm-4">').append(this.renderContactPhoto()),$('<div class="col-xs-9 col-sm-6 height-100">').append(this.renderContactSummary())))},renderFooter:function(){},renderLeftColumn:function(e){return(e||$("<div>")).addClass("col-xs-12 col-sm-4")},renderRightColumn:function(e,t){return(e||$("<div>")).addClass("col-xs-10 col-sm-"+(t||8))},renderRightShortColumn:function(e){return(e||$("<div>")).addClass("col-xs-10 col-sm-6")},renderRightColumnWithOffset:function(e,t){return this.renderRightColumn(e,t).addClass("col-xs-offset-0 col-sm-offset-4")},renderRightShortColumnWithOffset:function(e){return this.renderRightShortColumn(e).addClass("col-xs-offset-0 col-sm-offset-4")},renderContactPhoto:function(){return new h({model:this.model}).render().$el},renderContactSummary:function(){function e(){var e=n.getFullNameWithFurigana(this.model.toJSON());s.empty().toggle(!!e.length).append(e)}function t(){var e=n.getSummaryBusiness(this.model.toJSON());a.toggle(!!e).text(e)}function i(){var e=n.getSummaryLocation(this.model.toJSON());r.toggle(!!e).text(e)}var s=$("<h1>"),a=$('<h2 class="business hidden-xs">'),r=$('<h2 class="location hidden-xs">');return this.listenTo(this.model,"change:title change:first_name change:last_name change:company change:yomiFirstName change:yomiLastName change:yomiCompany",e),this.listenTo(this.model,"change:company change:department change:position",t),this.listenTo(this.model,"change:city_home change:city_business change:country_home change:country_business",i),this.listenTo(p,"change:fullNameFormat",e),e.call(this),t.call(this),i.call(this),$('<div class="contact-summary">').append(s,a,r)},renderField:function(e,i){var s=_.uniqueId("contact-field-"),n=$('<label class="control-label">').attr("for",s).text(v.i18n[e]||e),a=this.shouldBeVisible(e),r=this.model.getMaxLength(e),o=this.isReadonly(e),l=this.fieldLength[e]||6,d=6-l,h=this.renderRightColumn(null,l);return a&&(this.visible[e]=!0),$('<div class="form-group">').attr("data-field",e).toggleClass("hidden",!a).append(this.renderLeftColumn(n),h.append(i.call(this,s,n,h).attr("maxlength",r).attr("readonly",o||null),new t.ErrorView({model:this.model,name:e}).render().$el),this.renderRemoveButton(e).addClass("col-sm-offset-"+d))},renderRemoveButton:function(e){return this.isRemovable(e)?$('<div class="col-xs-2">').append($('<button type="button" class="btn btn-link remove">').attr("title",g("Remove field")).attr("data-remove",e).append(this.renderRemoveIcon())):$()},renderRemoveIcon:function(){return $('<i class="fa fa-minus-circle">')},renderTextField:function(e){return this.renderField(e,function(i){return new t.InputView({name:e,model:this.model,id:i,validate:!1}).render().$el})},renderDate:function(e){return this.renderField(e,function(i,s){return new t.DateSelectView({name:e,model:this.model,label:s}).render().$el})},renderNote:function(){return this.renderField("note",function(e){return new t.TextView({name:"note",model:this.model,id:e,validate:!1}).render().$el})},renderPrivateFlag:function(){return this.renderField("private_flag",function(e,i,s){return i.addClass("sr-only"),s.addClass("col-xs-offset-0 col-sm-offset-4"),new t.CustomCheckboxView({name:"private_flag",label:g("This contact is private and cannot be shared"),model:this.model,id:e}).render().$el})},shouldBeVisible:function(e){return this.alwaysVisible[e]||this.fieldHasContent(e)},fieldHasContent:function(e){return!!this.model.get(e)},addressHasContent:function(e){return _(this.sets[e]).any(this.fieldHasContent,this)},showDisplayName:function(){return!this.model.get("first_name")&&(!this.model.get("last_name")&&(!this.model.get("company")&&!!this.model.get("display_name")))},isRemovable:function(e){return!this.alwaysVisible[e]&&("display_name"!==e&&!/^(street|postal_code|city|state|country)_/.test(e))},isReadonly:function(e){return!!this.readonly[e]||"email1"===e&&6===this.model.get("folder_id")},renderAllFields:function(){function e(e){if(this.disabled[e])return"";var t;switch(e){case"address_home":case"address_business":case"address_other":return t=this.visible[e]=this.addressHasContent(e),this.renderAddress(e).toggleClass("hidden",!t);case"birthday":case"anniversary":return this.renderDate(e);case"note":return this.renderNote();case"display_name":return t=this.visible[e]=this.showDisplayName(),this.renderTextField(e).toggleClass("hidden",!t);case"private_flag":return this.renderPrivateFlag();default:return this.renderTextField(e)}}this.$el.append(_(this.allFields).map(function(t,i){var s=$('<div class="section">').attr("data-section",i).append(_(t.fields.map(e,this)).flatten());return s.append(this.renderDropdown(i,t.add)),s},this))},renderAddress:function(e){var t=v.i18n[e];return $('<fieldset class="address">').attr("data-address",e).append($('<legend class="sr-only">').text(t),$('<div class="form-group">').append(this.renderRightShortColumnWithOffset().addClass("section-title").attr("aria-hidden",!0).text(t),this.renderRemoveButton(e)),this.sets[e].map(function(e){return this.renderTextField(e).removeClass("hidden")},this))},renderDropdown:function(e,t){var s=$('<i class="fa fa-plus-circle" aria-hidden="true">').add($.txt(t)),n=new i({label:s,caret:!0,buttonToggle:!0});return this.renderDropdownOptions(n,e),this.listenTo(n,"click",this.onAddField.bind(this,n,e)),$('<div class="form-group">').append(this.renderRightColumnWithOffset().append(n.render().$el.attr("data-add",e)))},renderDropdownOptions:function(e,t){e.$ul.empty(),_(this.sections[t]).each(function(t){this.visible[t]||this.disabled[t]||("-"===t?e.divider():e.link(t,v.i18n[t]))},this),e.$el.toggle(!!e.$ul.children().filter(":not(.divider)").length)},renderAttachments:function(){this.attachments={list:new s.ListView({model:this.model,module:7,changeCallback:function(e,t){var i=e.get("id"),s=e.get("folder_id"),n=!e.attachments();return t.length>0&&_(t).each(function(e){c("error",e.error)}),a.get({id:i,folder:s},n).then(function(e){return n?$.when():$.when(a.caches.get.add(e),a.caches.all.grepRemove(s+a.DELIM),a.caches.list.remove({id:i,folder:s}),a.clearFetchCache()).done(function(){a.trigger("update:"+_.ecid(e)),a.trigger("refresh.list")})})}}),upload:new s.UploadView({model:this.model})},this.$el.append($('<div class="section">').attr("data-section","attachments").append(this.renderField("attachments",function(e){return $("<span>").append(this.attachments.list.render().$el.attr("id",e),this.attachments.upload.render().$el)})))},renderDropzone:function(){var e="io.ox/contacts/edit/dnd/actions",t=m.dnd.FloatingDropzone.extend({getDimensions:function(){var e=this.$el.closest(".window-content");return{top:e.scrollTop(),bottom:0,height:e.outerHeight()}}});u.point(e).extend({id:"attachment",index:100,label:g('Drop here to upload a <b class="dndignore">new attachment</b>'),action:this.attachments.list.addFile.bind(this.attachments.list)}),this.$el.parent().append(new t({point:e,scrollable:".window-content"}).render().$el)},onAddField:function(e,t,i){var s=i.name;s&&(this.isAddress(s)?this.showAddress(s):this.showField(s),this.focusField(s),this.renderDropdownOptions(e,t))},showField:function(e){this.$('[data-field="'+e+'"]').removeClass("hidden").closest(".section").removeClass("hidden"),this.visible[e]=!0},showAddress:function(e){this.$('[data-address="'+e+'"]').removeClass("hidden"),this.visible[e]=!0},focusField:function(e){this.$('[data-field="'+e+'"], [data-address="'+e+'"]').find(".form-control:first").focus()},isSet:function(e){return!!this.sets[e]},isAddress:function(e){return/^address_/.test(e)},resolveSet:function(e){return this.sets[e]||[e]},onRemoveField:function(e){var t=$(e.currentTarget).attr("data-remove");this.isAddress(t)?this.hideAddress(t):this.hideField(t);var i=b[t],s=this.$('[data-add="'+i+'"]').data("view");this.renderDropdownOptions(s,i),s.$toggle.focus()},hideField:function(e){this.$('[data-field="'+e+'"]').addClass("hidden"),this.model.set(e,""),this.visible[e]=!1},hideAddress:function(e){this.$('[data-address="'+e+'"]').addClass("hidden"),this.resolveSet(e).forEach(function(e){this.model.set(e,"")},this),this.visible[e]=!1},alwaysVisible:{first_name:!0,last_name:!0,company:!0,yomiFirstName:!0,yomiLastName:!0,yomiCompany:!0,department:!0,email1:!0,cellular_telephone1:!0,note:!0,attachments:!0,private_flag:!0},readonly:{display_name:!0},allFields:{personal:{add:g("Add personal info"),fields:["title","first_name","last_name","display_name","nickname","second_name","suffix","birthday","anniversary","marital_status","number_of_children","url"]},business:{add:g("Add business info"),fields:["company","department","position","profession","manager_name","room_number","assistant_name","employee_type","number_of_employees","sales_volume","tax_id","commercial_register","branches","business_category","info"]},communication:{add:g("Add email, phone, fax"),fields:["email1","email2","email3","instant_messenger1","instant_messenger2","cellular_telephone1","cellular_telephone2","telephone_business1","telephone_business2","telephone_home1","telephone_home2","telephone_company","telephone_other","telephone_car","telephone_isdn","telephone_pager","telephone_primary","telephone_radio","telephone_telex","telephone_ttytdd","telephone_ip","telephone_assistant","telephone_callback","fax_business","fax_home","fax_other"]},addresses:{add:g("Add postal address"),fields:["address_home","address_business","address_other"]},other:{add:g("Add additional info"),fields:["note","private_flag"]},userfields:{add:g("Add user fields"),fields:["userfield01","userfield02","userfield03","userfield04","userfield05","userfield06","userfield07","userfield08","userfield09","userfield10","userfield11","userfield12","userfield13","userfield14","userfield15","userfield16","userfield17","userfield18","userfield19","userfield20"]}},sections:{personal:["title","first_name","last_name","nickname","second_name","suffix","-","birthday","anniversary","marital_status","number_of_children","url"],business:["company","department","position","profession","-","room_number","manager_name","assistant_name"],communication:["email1","email2","email3","instant_messenger1","instant_messenger2","-","cellular_telephone1","cellular_telephone2","telephone_business1","telephone_business2","telephone_home1","telephone_home2","telephone_company","telephone_other","-","fax_business","fax_home","fax_other"],addresses:["address_home","address_business","address_other"],other:["note","private_flag"],userfields:["userfield01","userfield02","userfield03","userfield04","userfield05","userfield06","userfield07","userfield08","userfield09","userfield10","userfield11","userfield12","userfield13","userfield14","userfield15","userfield16","userfield17","userfield18","userfield19","userfield20"]},sets:{address_home:["street_home","postal_code_home","city_home","state_home","country_home"],address_business:["street_business","postal_code_business","city_business","state_business","country_business"],address_other:["street_other","postal_code_other","city_other","state_other","country_other"]},fieldLength:{number_of_children:3,room_number:3,postal_code_home:3,postal_code_business:3,postal_code_other:3}});("ja_JP"===ox.locale||p.get("features/furigana",!1))&&(v.prototype.allFields.personal.fields.splice(1,2,"yomiLastName","last_name","yomiFirstName","first_name"),v.prototype.allFields.business.fields.unshift("yomiCompany"));var b={},x=[];return _(v.prototype.allFields).each(function(e,t){_(e.fields).each(function(e){b[e]=t,x.push(e)})}),_(v.prototype.sets).each(function(e){_(e).each(x.push.bind(x))}),v.i18n={title:g.pgettext("salutation","Title"),display_name:g("Display name"),first_name:g("First name"),last_name:g("Last name"),second_name:g("Middle name"),suffix:g("Suffix"),birthday:g("Birthday"),marital_status:g("Marital status"),number_of_children:g("Children"),nickname:g("Nickname"),spouse_name:g("Spouse's name"),anniversary:g("Anniversary"),private_flag:"",email1:g("Email 1"),email2:g("Email 2"),email3:g("Email 3"),instant_messenger1:g("Instant Messenger 1"),instant_messenger2:g("Instant Messenger 2"),url:g("URL"),company:g("Company"),profession:g("Profession"),department:g("Department"),position:g("Position"),employee_type:g("Employee type"),room_number:g("Room number"),number_of_employees:g("Employee ID"),sales_volume:g("Sales Volume"),tax_id:g("TAX ID"),commercial_register:g("Commercial Register"),branches:g("Branches"),business_category:g("Business category"),info:g("Info"),manager_name:g("Manager"),assistant_name:g("Assistant"),cellular_telephone1:g("Cell phone"),cellular_telephone2:g("Cell phone (alt)"),telephone_business1:g("Phone (business)"),telephone_business2:g("Phone (business alt)"),telephone_callback:g("Telephone callback"),telephone_car:g("Phone (car)"),telephone_company:g("Phone (company)"),telephone_home1:g("Phone (home)"),telephone_home2:g("Phone (home alt)"),telephone_other:g("Phone (other)"),telephone_isdn:g("Telephone (ISDN)"),telephone_pager:g("Pager"),telephone_primary:g("Telephone primary"),telephone_radio:g("Telephone radio"),telephone_telex:g("Telex"),telephone_ttytdd:g("TTY/TDD"),telephone_ip:g("IP phone"),telephone_assistant:g("Phone (assistant)"),fax_home:g("Fax (Home)"),fax_business:g("Fax"),fax_other:g("Fax (alt)"),address_home:g("Home address"),street_home:g("Street"),postal_code_home:g("Postcode"),city_home:g("City"),state_home:g("State"),country_home:g("Country"),address_business:g("Business address"),street_business:g("Street"),postal_code_business:g("Postcode"),city_business:g("City"),state_business:g("State"),country_business:g("Country"),address_other:g("Other address"),street_other:g("Street"),city_other:g("City"),postal_code_other:g("Postcode"),state_other:g("State"),country_other:g("Country"),note:g.pgettext("contact","Note"),yomiFirstName:g("Furigana for first name"),yomiLastName:g("Furigana for last name"),yomiCompany:g("Furigana for company"),attachments:g("Attachments"),image1:g("Image 1"),userfield01:g("Optional 01"),userfield02:g("Optional 02"),userfield03:g("Optional 03"),userfield04:g("Optional 04"),userfield05:g("Optional 05"),userfield06:g("Optional 06"),userfield07:g("Optional 07"),userfield08:g("Optional 08"),userfield09:g("Optional 09"),userfield10:g("Optional 10"),userfield11:g("Optional 11"),userfield12:g("Optional 12"),userfield13:g("Optional 13"),userfield14:g("Optional 14"),userfield15:g("Optional 15"),userfield16:g("Optional 16"),userfield17:g("Optional 17"),userfield18:g("Optional 18"),userfield19:g("Optional 19"),userfield20:g("Optional 20")},v.ContactModel=Backbone.Model.extend({initialize:function(e){this.isUser=e.isUser,this.initialValues=_.omit(e,"isUser"),this.on("change:title change:first_name change:last_name change:company",_.debounce(this.deriveDisplayName)),this.addDirtyCheck(),this.on("change",_.debounce(this.validate))},toJSON:function(){var e=_(v.i18n).keys().concat("id","folder_id","image1_url");return _(this.attributes).pick(e)},addDirtyCheck:function(){var e=!_.isEmpty(_.omit(this.initialValues,"id","folder_id"));this.isDirty=function(){return e},this.resetDirty=function(){e=!1},this.on("change",function(){this.changed.display_name||(e=!0)}),this.on("save:success",function(){this.isDirty=_.constant(!1)})},deriveDisplayName:function(){this.set("display_name",n.getFullName(this.toJSON()))},save:function(){var e=Backbone.Model.prototype.save.apply(this,arguments);return e||$.Deferred().reject(y(this.validationError))},sync:function(e,t,i){switch(e){case"create":return function(){var e=this.getFile();return this.getApi().create(this.toJSON(),e)}.call(this).done(this.set.bind(this)).done(this.trigger.bind(this,"save:success")).fail(this.trigger.bind(this,"save:fail")).done(i.success).fail(i.error);case"read":return this.getApi().get(this.pick("id","folder_id")).done(function(e){this.initialValues=e}.bind(this)).done(i.success).fail(i.error);case"update":return function(){var e=this.getChanges(),t=this.getFile(),i=this.attachments();if(t)return this.getApi().editNewImage(this.pick("id","folder_id"),e,t);""===e.image1_url&&(e.image1="");var s=_.extend(this.pick("id","last_modified"),{folder:this.get("folder_id"),attachments:i,data:e});return this.getApi().update(_.extend(s,{data:e}))}.call(this).done(this.trigger.bind(this,"save:success")).fail(this.trigger.bind(this,"save:fail")).done(i.success).fail(i.error)}},isUserMode:function(){return"6"===String(this.get("folder_id"))&&String(this.get("id"))===String(ox.user_id)},getApi:function(){return this.isUserMode()?r:a},getChanges:function(){var e={},t=this.attributes,i=this.initialValues,s=0;return x.concat("image1_url").forEach(function(n){_.isEqual(t[n],i[n])||(e[n]=t[n],s++)}),1===s&&"display_name"in e?{}:e},getFile:function(){return this.get("pictureFileEdited")||this.get("pictureFile")||void 0},attachments:function(e){if(_.isUndefined(e))return!!this._attachments;this.trigger("pending",e),this._attachments=a.pendingAttachments[_.ecid(this.toJSON())]=e},validate:function(){var e=this.validateFunctions(["validateLength","validateAddresses"]);return _(this.toJSON()).each(function(t,i){var s=e[i];this.trigger((s?"invalid":"valid")+":"+i,s)},this),e},validateFunctions:function(e){for(var t,i={},s=this.toJSON(),n=0;t=e[n];n++){var a=this[t](s);a&&_.extend(i,a)}return!_.isEmpty(i)&&i},validateArray:function(e,t,i){var s=!1,n={};return e.forEach(function(e){var a=t[e];if(void 0!==a&&null!==a){var r=i.call(this,e,a);r&&(s=!0,n[e]=r)}},this),s&&n},validateLength:function(e){return this.validateArray(_.flatten(x),e,function(e,t){if(!(String(t).length<=this.getMaxLength(e)))return g("This value is too long. The allowed length is %1$d characters.",this.getMaxLength(e))})},validateAddresses:function(e){return this.validateArray(["email1","email2","email3"],e,function(e,t){if(!l.isValidMailAddress(t))return g("This is an invalid email address.",v.i18n[e])})},maxLength:{first_name:128,last_name:128,position:128,tax_id:128,url:256,profession:256,street_home:256,street_other:256,street_business:256,display_name:320,email1:512,email2:512,email3:512,company:512,note:5680},getMaxLength:function(e){return this.maxLength[e]||64}}),v});