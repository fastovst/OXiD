define("io.ox/contacts/util",["io.ox/core/util","io.ox/core/extensions","settings!io.ox/contacts","gettext!io.ox/contacts"],function(t,e,a,n){"use strict";function r(t,e){var a=new Array(t);return a[t-1]=e,{format:"%"+t+"$s",params:a}}function i(t){return/^(<span class="title">)?(dr\.?|prof\.?)/i.test(t)?t:""}function m(t){var e,a,n,r=moment.utc(t).local(!0);return e=r.month()<2?Math.floor((r.year()-1)/100):Math.floor(r.year()/100),a=Math.floor(e/4),n=e%4,Math.abs(864e5*(3*a+n-2))}function o(t,e,a){var n=t;return!0===a&&(n={},_(["title","first_name","last_name","company","display_name","cn"]).each(function(e){var a=$.trim(t[e]);if(!a)if("last_name"===e&&$.trim(t.yomiLastName))a=$.trim(t.yomiLastName);else if("first_name"===e&&$.trim(t.yomiFirstName))a=$.trim(t.yomiFirstName);else{if("company"!==e||!$.trim(t.yomiCompany))return;a=$.trim(t.yomiCompany)}var r="last_name"===e?"strong":"span";n[e]="<"+r+' class="'+e+'">'+_.escape(a)+"</"+r+">"})),e?s.getMailFullNameFormat(t):s.getFullNameFormat(n)}require(["settings!io.ox/contacts"]).then(function(t){t.get("showDepartment")&&($("html").addClass("showDepartment"),e.point("io.ox/core/person").extend({index:"last",id:"department",draw:function(t){6===t.data.folder_id&&t.data.department&&this.append($('<span class="department">').text(n.format(" (%1$s) ",t.data.department)))}}))});var s={getSortName:function(t){return t=_.pick(t,"first_name","last_name","display_name","cn"),this.getFullName(t).toLowerCase()},getFullNameFormat:function(e){var m=$.trim(e.first_name),o=$.trim(e.last_name),s=$.trim(e.display_name||e.cn),l=$.trim(e.company),u=$.trim(e.title);if(m&&o){var c,f=a.get("fullNameFormat","auto"),p=[m,o];return(u=i(u))&&p.push(u),c="firstname lastname"===f?u?"%3$s %1$s %2$s":"%1$s %2$s":"lastname, firstname"===f?u?"%3$s %2$s, %1$s":"%2$s, %1$s":n(u?"%3$s %2$s, %1$s":"%2$s, %1$s"),{format:c,params:p}}return o?r(2,o):m?r(1,m):l?r(1,l):s?r(4,t.unescapeDisplayName(s)):{format:"",params:[]}},getFullName:function(t,e){var a=o(t,!1,e);return n.format(a.format,a.params)},getFullNameWithFurigana:function(t){return this.getFullName(t,!0)},getDisplayName:function(e){return e.display_name?t.unescapeDisplayName(e.display_name):e.last_name&&e.first_name?e.last_name+", "+e.first_name:e.last_name||e.first_name||""},getMailFullNameFormat:function(e){var a=$.trim(e.first_name),i=$.trim(e.last_name),m=$.trim(e.display_name);return i&&a?{format:n.pgettext("mail address","%1$s %2$s"),params:[a,i]}:i?r(2,i):a?r(1,a):m?r(4,t.unescapeDisplayName(m)):{format:"",params:[]}},getMailFullName:function(t,e){var a=o(t,!0,e);return n.format(a.format,a.params)},getMailFormat:function(t){return t.email1?r(1,t.email1):t.email2?r(2,t.email2):t.email3?r(3,t.email3):{format:"",params:[]}},getMail:function(t){return t?(t.email1||t.email2||t.email3||t.mail||"").trim().toLowerCase():""},getJob:function(t){var e=_([t.company,t.position]).compact();return e.length?e.join(", "):t.email1||t.email2||t.email3||""},nameSort:function(t,e){var a,n;return a=void 0===t.display_name?t.mail:t.display_name.toLowerCase(),n=void 0===e.display_name?e.mail:e.display_name.toLowerCase(),a<n?-1:a>n?1:0},calcMailField:function(t,e){var a,n;return n=[t.email1,t.email2,t.email3],_.each(n,function(t,n){e===t&&(a=n+1)}),a},gregorianToJulian:function(t){return moment.utc(t-m(t)).valueOf()},julianToGregorian:function(t){return moment.utc(t+m(t)).valueOf()},getBirthday:function(t,e){return(t=moment.utc(t)).year()>1&&1604!==t.year()?t.format("l")+(e?" ("+n("Age: %1$d",moment().diff(t,"years"))+")":""):t.formatCLDR("Md")},getSummaryBusiness:function(t){var e=[t.position,t.company,t.department];return"6"===String(t.folder_id)&&e.splice(1,1),e.map($.trim).filter(Boolean).join(", ")},getSummaryLocation:function(t){return(t.city_business?[t.city_business,t.country_business]:[t.city_home,t.country_home]).map($.trim).filter(Boolean).join(", ")},getImage:function(e,a){if(_.isObject(e)&&(e=e.image1_url),!e)return"";a=_.extend({width:40,height:40,scaleType:"cover"},a),_.device("retina")&&(a.width*=2,a.height*=2);var n=e.replace(/^https?:\/\/[^/]+/i,"");return n=t.replacePrefix(n),t.getShardingRoot(n+"&"+$.param(a))},getInitials:function(){function t(t){var e=n.exec(t);return e&&e[1]||""}function e(t){var e=r.exec(t);return e&&e[1]||""}function a(a){var n=$.trim(a.first_name),r=$.trim(a.last_name),i=$.trim(a.display_name);if(n&&r)return t(n)+t(r);if(i)return t(i)+e(i);if(r)return t(r);if(n)return t(n);var m=$.trim(a.email1||a.email2||a.email3);return m?t(m):""}var n=/^.*?([a-z0-9\xC0-\xFF])/i,r=/\s.*?([a-z0-9\xC0-\xFF])\S*$/i;return function(t){return a(t).toUpperCase()}}(),getInitialsColor:function(){var t=["red","orange","yellow","green","cyan","blue","purple","pink"],e=t.length;return function(a){return a?t[a[0].charCodeAt()%e]:"gray"}}(),validateDistributionList:function(t){if(t&&_.isArray(t)&&t.length){var e=[];return t=_(t).filter(function(t){return(t=t.attributes||t).mail||t[t.field]||e.push(t),!!t.mail}),e.length&&require(["io.ox/core/yell"],function(t){1!==e.length?t("warning",n("Some contacts could not be added as they have no valid email field.")):t("warning",n("%1$s could not be added as the contact has no valid email field.",e[0].display_name))}),t}}};return s});