define("io.ox/contacts/addressbook/popup",["io.ox/core/http","io.ox/core/folder/api","io.ox/backbone/views/modal","io.ox/core/tk/list","io.ox/core/extensions","io.ox/contacts/util","io.ox/contacts/api","l10n/ja_JP/io.ox/collation","gettext!io.ox/contacts","gettext!io.ox/core","settings!io.ox/contacts","settings!io.ox/mail","io.ox/core/yell","less!io.ox/contacts/addressbook/style"],function(e,t,i,s,n,r,l,a,o,c,d,u,h){"use strict";function m(e,t){return e.rank-t.rank}function f(e,t){return _.isEmpty(t)?e:_(e).filter(function(e){return _(t).every(function(t){return e.keywords.indexOf(t)>-1})})}function p(e,t,i,s){var n,r=e.replace(/^@/,"").split(B),l=r[0];return n=G(t,l),n=y(i,n).sort(s?m:M),f(n,r.slice(1))}function v(e){P[$(e.target).attr("data-original")]=!0}function g(e,t){var i=[];return _(e).each(function(e,s){var n=t(e,s),r=this[n]=this[n]||[];r.length||i.push(r),r.push(e)},{}),i}function b(e,t){return _(e).map(function(e){return _.chain(e).sortBy(t).first().value()})}function k(e,t){e=b(e=g(e,function(e){return e.label?_.uniqueId(e.keywords):e.full_name+" "+e.email}),function(e){return e.user_id?-1:1}),t=_.extend({limit:t.isSearch?A.search:A.render,offset:0},t),e.length||t.renderEmpty&&t.renderEmpty(t);var i=e.slice(t.offset,t.limit);0===t.offset&&(this[0].innerHTML=""),this[0].innerHTML+=z({list:i}),0===t.offset&&this.scrollTop(0),this.data({list:e,options:t}),this.find(".contact-picture[data-original]").each(function(){var e=$(this),t=e.attr("data-original");P[t]?e.css("background-image","url("+t+")"):e.lazyload()})}function y(e,t){return _(t).chain().map(function(t){return e[t]}).compact().value()}function w(e,t){return $('<li class="list-item selectable removable token" role="option">').attr({id:_.uniqueId("token"),"data-cid":e.cid,"data-index":t}).append($('<span class="token-label">').text(e.title),$('<a href="#" class="token-action remove" tabindex="-1" aria-hidden="true">').attr("title",o("Remove")).append($('<i class="fa fa-times" aria-hidden="true">')))}function x(e){function t(t){return e.$list.get(t)}return{first:function(){return t(0)},last:function(){return t(e.$list.length-1)},next:function(){if(e.$selected.is(":last-child"))return this.first();var i=this.current();return i<0?this.first():t(i+1)},prev:function(){if(e.$selected.is(":first-child"))return this.last();var i=this.current();return i<0?this.last():t(i-1)},current:function(){return e.$list.index(e.$selected)}}}var C="yomiLastName yomiFirstName last_name first_name display_name".split(" "),I="email1 email2 email3".split(" "),A={departments:d.get("picker/limits/departments",100),fetch:d.get("picker/limits/fetch",1e4),labels:d.get("picker/limits/labels",1e3),more:d.get("picker/limits/more",100),render:d.get("picker/limits/list",100),search:d.get("picker/limits/search",50)},O=u.get("contactCollectFolder",0),B=/[\s,.\-:;<>()_@/'"]/,L=d.get("picker/useInitials",!0),F=L&&d.get("picker/useInitialsColor",!0),D=d.get("picker/useLabels",!1),T=d.get("picker/closeOnDoubleClick",!0),N=d.get("picker/globalAddressBook",!0),S=d.get("showDepartment"),E=void 0===S?d.get("picker/departments",!0):S;E&&C.push("department");var V=function(){function e(e){var t=[];return n.forEach(function(i){var s=e[i];"string"==typeof s&&s.length&&t.push(s)}),t.join(" ").toLowerCase().split(B)}function t(e,t,s){t.forEach(function(t){var n=t.substr(0,1);n&&i(e[n]=e[n]||{},t,s)})}function i(e,t,i){var n=t.substr(0,2);s(e[n]=e[n]||{},t,i)}function s(e,t,i){(e[t]=e[t]||{})[i]=!0}var n=C.concat("email");return function(i){var s={};return i.forEach(function(i){var n=e(i);t(s,n,i.cid)}),s}}(),G=function(){function e(t,i,s){var n=i.substr(0,s);return _(t).reduce(function(t,r,l){return s<=2?0===l.indexOf(n)?t.concat(e(r,i,s+1)):t:0===l.indexOf(i)?t.concat(_(r).keys()):t},[])}return function(t,i){return"string"==typeof i&&i.length?(i=i.toLowerCase(),_(e(t,i,1).sort()).uniq(!0)):[]}}(),H=function(){function t(t){var i={exclude_folders:(t=_.extend({columns:"1,20,500,501,502,505,519,524,555,556,557,592,602,606,616,617",exclude:N?[]:["6"],limit:A.fetch,lists:!0},t)).exclude};return"all"===t.folder&&delete t.folder,t.useGABOnly&&(i.folder=["6"]),e.PUT({module:"contacts",params:{action:"search",admin:d.get("showAdmin",!1),columns:t.columns,right_hand_limit:t.limit,sort:608,order:"desc"},data:i}).then(function(e){return e&&e.length===t.limit&&m(t.limit),t.lists?e:_.filter(e,function(e){return!e.distribution_list})})}function i(){return e.GET({module:"labels",params:{action:"all",module:"contacts",members:!0,start:0,limit:A.labels}})}function s(e,t,i,s){return e.forEach(function(e,r){e.display_name=c(e.display_name);var l,a=[];if(e.mark_as_distributionlist){a=[e.display_name],l=_(e.distribution_list).filter(function(e){return e.mail}).map(function(e){return $.trim(e.mail).toLowerCase()}).join(", "),e.last_name=e.display_name;var d=n(e,a,l,0,r);d&&(d.full_name_html+=' <span class="gray">'+o("Distribution list")+"</span>",t.push(i[d.cid]=d))}else C.forEach(function(t){"display_name"===t&&a.length||e[t]&&a.push(e[t])}),s.useGABOnly&&(I=["email1"]),I.forEach(function(s,l){var o=n(e,a,(e[s]||"").toLowerCase(),r,l,s);o&&t.push(i[o.cid]=o)})}),{items:t,hash:i,index:V(t)}}function n(e,t,i,s,n,o){if((i=$.trim(i))&&!/^(noreply|no-reply|do-not-reply)@/.test(i)&&!/^=\?iso-8859-1\?q\?=22/i.test(e.display_name)){var c=String(e.folder_id),d=E&&"6"===c&&$.trim(e.department)||"",u=r.getFullName(e).toLowerCase(),h=r.getInitials(e);return{caption:i,cid:e.folder_id+"."+e.id+"."+n,department:d,display_name:e.display_name,email:i,field:o,first_name:e.first_name,folder_id:c,full_name:u,full_name_html:r.getFullName(e,!0),image:r.getImage(e)||!L&&l.getFallbackImage(),id:String(e.id),initials:L&&h,initial_color:r.getInitialsColor(F&&h),keywords:(u+" "+i+" "+d).toLowerCase(),last_name:e.last_name,list:a(e),mail_full_name:r.getMailFullName(e),sort_name:t.concat(i).join("_").toLowerCase().replace(/\s/g,"_"),sort_name_without_mail:t.join("_").toLowerCase().replace(/\s/g,"_"),title:e.title,rank:1e3+10*(("6"===c?10:0)+s)+n,user_id:e.internal_userid}}}function a(e){return!!e.mark_as_distributionlist&&_.map(e.distribution_list,function(e){return _.extend(e,{mail_full_name:r.getMailFullName(e)})})}function c(e){return $.trim(e).replace(/^["']+|["']+$/g,"")}function u(e,t,i){e.forEach(function(e,s){if(e.members=_(e.members).chain().map(function(e){return{display_name:r.getMailFullName(e),id:e.id,folder_id:e.folder_id,email:$.trim(e.email1||e.email2||e.email3).toLowerCase()}}).filter(function(e){return!!e.email}).value(),e.members.length){e.display_name=String(e.title);var n=r.getFullName(e).toLowerCase(),l=_(e.members).pluck("email").join(", ");e={caption:_(e.members).pluck("display_name").join(", "),cid:"virtual/label."+e.id+"."+s,display_name:e.display_name,email:l,first_name:"",folder_id:"virtual/label",full_name:n,full_name_html:r.getFullName(e,!0),image:"",id:String(e.id),initials:"",initial_color:"",keywords:(n+" "+l).toLowerCase(),label:e.members,last_name:"",mail_full_name:r.getMailFullName(e),sort_name:e.display_name.toLowerCase().replace(/\s/g,"_"),title:e.title,rank:s},t.push(i[e.cid]=e)}})}var m=_.once(function(e){h("warning",o("This dialog is limited to %1$d entries and your address book exceeds this limitation. Therefore, some entries are not listed.",e))});return function(e){return e=e||{},$.when(t(e),D?i():$.when()).then(function(t,i){var n=[],r={};return s(t,n,r,e),D&&u(i[0],n,r),{items:n,hash:r,index:V(n)}})}}(),M=_.device("ja_JP")?a.sorterWithMail:function(e,t){return e.sort_name.localeCompare(t.sort_name)},j=!1,J=null,q="all",P={};l.on("create update delete import",function(){J=null});var R={private:o("My address books"),public:o("Public address books"),shared:o("Shared address books")},z=_.template('<% _(list).each(function (item) { %><li class="list-item selectable" aria-selected="false" role="option" tabindex="-1" data-cid="<%- item.cid %>">  <div class="list-item-checkmark"><i class="fa fa-checkmark" aria-hidden="true"></i></div>  <div class="list-item-content">    <% if (item.list) { %>      <div class="contact-picture distribution-list" aria-hidden="true"><i class="fa fa-align-justify" aria-hidden="true"></i></div>    <% } else if (item.label) { %>      <div class="contact-picture label" aria-hidden="true"><i class="fa fa-users" aria-hidden="true"></i></div>    <% } else if (item.image) { %>      <div class="contact-picture image" data-original="<%= item.image %>" aria-hidden="true"></div>    <% } else { %>      <div class="contact-picture initials <%= item.initial_color %>" aria-hidden="true"><%- item.initials %></div>    <% } %>    <div class="name">       <%= item.full_name_html || item.email || " " %>       <% if (item.department) { %><span class="gray">(<%- item.department %>)</span><% } %>    </div>    <div class="email gray"><%- item.caption || " " %></div>  </div></li><% }); %>'),U=Backbone.DisposableView.extend({className:"selection-summary",attributes:{role:"region"},initialize:function(e){this.opt=_.extend({selector:".addresses",useLabels:!1},e),this.$list=$(),this.$selected=$(),this.$el.on("remove",this.opt.selector,this.onRemove.bind(this)).on("click",".token",this.onClick.bind(this)).on("click",".remove",this.onRemove.bind(this)).on("click",".clear",this.onClear.bind(this)),this.iterator=x(this)},getContainer:function(){return this.$(this.opt.selector)},select:function(e){this.$selected.attr("aria-checked",!1).removeClass("selected"),this.$selected=$(e).attr("aria-checked",!0).addClass("selected"),this.getContainer().attr("aria-activedescendant",this.$selected.attr("id"))},render:function(e){var t,i,s=_(e).reduce(function(e,t){return e+(t.dist_list_length?t.dist_list_length:1)},0);return this.$el.empty(),s?(this.opt.useLabels?(t=o.format(o.ngettext("%1$d item selected","%1$d items selected",s),s),i=o("The selected items. Press Backspace or Delete to remove.")):(t=o.format(o.ngettext("%1$d address selected","%1$d addresses selected",s),s),i=o("The selected addresses. Press Backspace or Delete to remove.")),this.$el.append($('<div class="toolbar">').append($('<span role="heading" aria-level="2" aria-live="polite" class="count pull-left">').text(t),$('<a href="#" class="pull-right clear" role="button">').text(o("Clear selection"))),$('<div aria-live="polite" aria-relevant="removals">').attr("aria-label",i).append($('<ul class="addresses unstyled listbox" tabindex="0" role="listbox">').append(_(e).map(w)))),this.$list=this.getContainer().children(),this.restore(),this.$el.show(),this):(this.$el.hide(),this)},restore:function(){var e;if(this.$list.length&&!(this.$list.index(this.$selected)>-1))return this.$selected.attr("data-cid")&&(e=this.$list.filter('[data-cid="'+this.$selected.attr("data-cid")+'"]')).length?this.select(e):this.$selected.attr("data-index")?(e=this.$list.get(parseInt(this.$selected.attr("data-index"),10)))?this.select(e):this.select(this.iterator.last()):void this.select(this.iterator.first())},onClick:function(e){this.select($(e.target).closest(".token"))},onRemove:function(e){var t=$(e.target).closest(".token");t&&t.length||(t=this.$selected),this.trigger("remove",t.attr("data-cid")),this.$list.length&&this.getContainer().focus()},onClear:function(e){e.preventDefault(),this.trigger("clear")}});return{buildIndex:V,searchIndex:G,getAllMailAddresses:H,sorter:M,onAppear:v,renderItems:k,search:p,TokenView:U,open:function(e,n){if((n=_.extend({build:_.noop,button:o.pgettext("select-contacts","Select"),enter:!1,focus:".search-field",maximize:600,point:"io.ox/contacts/addressbook-popup",help:"ox.appsuite.user.sect.email.send.addressbook.html",title:o("Select contacts"),useGABOnly:!1},n)).useGABOnly&&(q="folder/6"),!j)return j=!0,new i(n).inject({renderFolders:function(e){var t=this.$(".folder-dropdown"),i=this.options.useGABOnly,s=0;!N&&e.public&&(e.public=_(e.public).reject({id:"6"})),this.options.useGABOnly&&(e=_.pick(e,"public")),t.append(_(e).map(function(e,t){return R[t]&&e.length&&(e[0].id||e[0].title)?$("<optgroup>").attr("label",R[t]).append(_(e).map(function(e){if(s++,!i||"6"===e.id)return $("<option>").val("folder/"+e.id).text(e.title)})):$()})),s>1&&t.removeClass("invisible")},renderDepartments:function(e){var t=this.getDepartments(e.items);t.length&&this.$(".folder-dropdown").append($("<optgroup>").attr("label",o("Departments")).append(t.map(function(e){return $("<option>").val("department/"+e.name).text(e.name)}))).val(q)},getDepartments:function(e){var t={};return _(e).each(function(e){!e.department||e.department.length<=1||(t[e.department]=(t[e.department]||0)+1)}),_(t).chain().map(function(e,t){return{name:t,count:e}}).sortBy("count").reverse().first(A.departments).sortBy("name").value()},onChangeFolder:function(){this.folder=q=this.$(".folder-dropdown").val()||"all",this.lastJSON=null,this.search(this.$(".search-field").val())}}).extend({addClass:function(){this.$el.addClass("addressbook-popup")},header:function(){this.$(".modal-header").append($('<div class="row">').append($('<div class="col-xs-6">').append($('<input type="text" class="form-control search-field">').attr("placeholder",o("Search")).attr("aria-label",o("Search"))),$('<div class="col-xs-6">').append($('<select class="form-control folder-dropdown invisible">').append(this.options.useGABOnly?$():$('<option value="all">').text(o("All folders")),this.options.useGABOnly||D?$():$('<option value="all_lists">').text(o("All distribution lists")),D?$('<option value="all_labels">').text(o("All groups")):$()).attr("aria-label",o("Apply filter")).val(q)))),this.defFolder=t.flat({module:"contacts"}).done(this.renderFolders.bind(this)),this.defAddresses=$.Deferred(),$.when(this.defAddresses,this.defFolder).done(this.renderDepartments.bind(this)),this.folder=q,this.$(".folder-dropdown").on("change",$.proxy(this.onChangeFolder,this))},list:function(){this.listView=new s({collection:new Backbone.Collection,pagination:!1,ref:"io.ox/contacts/addressbook-popup/list",selection:{behavior:"simple"}}),this.$body.append(this.listView.render().$el.addClass("address-picker"))},onOpen:function(){function e(e){this.disposed||(J=e,this.items=e.items.sort(M),this.store.setHash(e.hash),this.index=e.index,this.search(""),this.idle(),this.defAddresses.resolve(e))}function t(e){this.disposed||(this.idle().disableFormElements(),this.trigger("error",e))}this.busy(!0),this.on("open",function(){_.defer(function(){if(J&&!this.options.useGABOnly)return e.call(this,J);H({useGABOnly:this.options.useGABOnly}).then(e.bind(this),t.bind(this))}.bind(this))})},search:function(){this.search=function(e){var t,i=(e=$.trim(e)).length&&"@"!==e;if(i){t=p(e,this.index,this.store.getHash());var s=JSON.stringify(t);if(s===this.lastJSON)return;this.lastJSON=s}else t=this.items,this.lastJSON=null;var n=this.folder;t=_(t).filter(function(e){return"all"===n?e.folder_id!==O:"all_lists"===n?e.list:"all_labels"===n?e.label:/^folder\//.test(n)?e.folder_id===n.substr(7):!!/^department\//.test(n)&&e.department===n.substr(11)}),this.renderItems(t,{isSearch:i})}},tokenview:function(){this.tokenview=new U({useLabels:D}),this.tokenview.on("remove",function(e){this.store.remove(e);var t=this.listView.selection;t.uncheck(t.getNode(e)),t.triggerChange()}.bind(this)),this.tokenview.on("clear",function(){this.store.clear(),this.listView.selection.clear(),this.listView.selection.triggerChange()}.bind(this))},store:function(){this.store=function(){var e={},t={};return{setHash:function(t){e=t},getHash:function(){return e},add:function(e){_(e).each(function(e){t[e]=!0})},remove:function(e){e=[].concat(e),_(e).each(function(e){delete t[e]})},clear:function(){t={}},getIds:function(){return _(t).keys()},get:function(){return _(t).chain().keys().map(function(t){return e[t]},this).compact().value()},resolve:function(t){return e[t]}}}(),this.listenTo(this.listView,"selection:clear",this.store.clear),this.listenTo(this.listView,"selection:add",this.store.add),this.listenTo(this.listView,"selection:remove",this.store.remove)},footer:function(){this.$(".modal-footer").prepend(this.tokenview.$el)},onInput:function(){var e=this,t=_.debounce(function(){e.search($(this).val())},100);this.$(".search-field").on("input",t)},onCursorDown:function(){this.$(".search-field").on("keydown",function(e){40!==e.which&&13!==e.which||(this.listView.selection.focus(0),e.preventDefault())}.bind(this))},onDoubleClick:function(){T&&this.$(".list-view").on("dblclick",".list-item",function(e){$(e.currentTarget).hasClass("selected")||this.listView.selection.onClick(e),this.trigger("select"),this.close()}.bind(this))},onEscape:function(){this.$(".list-view").on("keydown",function(e){27===e.which&&(e.preventDefault(),this.$(".search-field").focus())}.bind(this))},onSelectionChange:function(){this.tokenview&&this.listenTo(this.listView,"selection:change",function(){var e=this.store.get();if(this.tokenview.render(_.map(e,function(e){return{title:e.list?e.display_name+" - "+o("Distribution list"):e.email,cid:e.cid,dist_list_length:e.list?e.list.length:void 0}})),e.length){var t=this.listView.$(".list-item:focus");if(t.hasClass("selected")){var i=t.outerHeight(),s=t.position().top+i,n=this.listView.$el.outerHeight();s>n&&(this.listView.el.scrollTop+=s-n)}}}.bind(this))}}).build(function(){function e(i){return _(i).chain().filter(function(e){return void 0===t.omittedContacts||e.list||e.mail||e.email||t.omittedContacts.push(e),e.list||e.label||e.mail||e.email}).map(function(t){if(t.list||t.label)return e(t.list||t.label);var i=t.mail_full_name,s=t.mail||t.email;return{array:[i||null,s||null],display_name:i,id:t.id,folder_id:t.folder_id,email:s,field:t.mail_field?"email"+t.mail_field:t.field,user_id:t.user_id}},this).flatten().uniq(function(e){return e.email}).value()}var t=this;this.$el.on("appear",v),this.renderItems=function(e,t){t.renderEmpty=this.renderEmpty.bind(this,t),k.call(this.$(".list-view"),e,t);var i=this.store.getIds();this.listView.selection.set(i)},this.renderEmpty=function(e){var t=this.$(".list-view");t[0].innerHTML="",t.append($('<div class="notification">').text(o(e.isSearch?"No matching items found.":"Empty")))},this.renderMoreItems=function(){var e=i.data(),t=e.options;t.limit>=e.list.length||(t.offset=t.limit,t.limit=t.limit+A.more,this.renderItems(e.list,t))};var i=$(),s=_.debounce(function(){var e=i.outerHeight();(i[0].scrollTop+e)/i[0].scrollHeight<.8||(window.requestAnimationFrame||window.setTimeout)(this.renderMoreItems.bind(this))},50);this.on("open",function(){(i=this.$(".list-view")).on("scroll",$.proxy(s,this))}),this.resolveItems=function(e){return y(this.store.getHash(),e)},this.flattenItems=function(i,s){if((s=s||{}).yellOmitted){t.omittedContacts=[];var n=e(this.resolveItems(i));return r.validateDistributionList(t.omittedContacts),delete t.omittedContacts,n}return e(this.resolveItems(i))}}).build(n.build).on({close:function(){q="all",j=!1},error:function(e){this.$body.empty().addClass("error").text(e.error||e)},select:function(){var t=this.store.getIds();ox.debug&&console.log("select",t,this.flattenItems(t)),_.isFunction(e)&&e(this.flattenItems(t,{yellOmitted:!0}))}}).addCancelButton().addButton({label:n.button,action:"select"}).open()}}});