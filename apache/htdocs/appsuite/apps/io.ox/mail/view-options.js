define("io.ox/mail/view-options",["io.ox/core/extensions","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/common","io.ox/core/api/account","gettext!io.ox/mail","io.ox/core/commons","io.ox/core/folder/contextmenu","io.ox/core/api/collection-loader","io.ox/core/http","io.ox/mail/api","io.ox/core/folder/api","settings!io.ox/mail"],function(e,o,t,i,a,n,d,r,l,s,p,c){"use strict";function f(e,o){if("virtual/all-unseen"===e.folder.get())return o.hide();o.toggle(!e.props.get("find-result"))}function u(e){var o=!!e.data.state;if(e.data.app.folderView.forceOpen=o,e.data.app.props.set("folderview",o),e.data.state)e.data.app.folderView.tree.getNodeView(e.data.app.folder.get()).$el.focus();else{var t=e.data.app.listView,i=t.selection.get().reduce(function(e,o){return e||t.selection.getNode(o)},null);if(i)t.selection.focus(0,i);else{var a=require("io.ox/mail/util"),n=t.selection.view.collection,d=n.models.find(function(e){return!a.isUnseen(e.get("flags"))});if(d)return t.selection.select(n.indexOf(d));t.$el.focus()}}}function m(e){e.getWindow().nodes.sidepanel.show(),v?e.getWindow().nodes.main.find('.toolbar-item[data-action="open-folder-view"]').hide():e.getWindow().nodes.main.find(".list-view-control").removeClass("toolbar-bottom-visible")}function w(e){e.getWindow().nodes.sidepanel.hide(),v?e.getWindow().nodes.main.find('.toolbar-item[data-action="open-folder-view"]').show():e.getWindow().nodes.main.find(".list-view-control").addClass("toolbar-bottom-visible")}var h={id:"search",index:100,draw:function(e){var o=e.app.listView,t=new r({module:"mail",mode:"search",getQueryParams:function(o){var t,i,a=o.criteria,n=[],d=a.from||a.von||a.de,r=a.to||a.an||a.a||a.para,l=a.subject||a.betreff||a.sujet||a.asunto,p=a.year||a.y||a.jahr||a.ano;return d&&n.push(["=",{field:"from"},d]),r&&n.push(["or",["=",{field:"to"},r],["=",{field:"cc"},r],["=",{field:"bcc"},r]]),l&&n.push(["=",{field:"subject"},l]),p&&(t=Date.UTC(p,0,1),i=Date.UTC(p,11,31),n.push(["and",[">",{field:"received_date"},String(t)],["<",{field:"received_date"},String(i)]])),a.words&&_(a.words.split(" ")).each(function(e){n.push(["or",["=",{field:"content"},e],["=",{field:"subject"},e]])}),a.addresses&&_(a.addresses.split(" ")).each(function(e){n.push(["or",["=",{field:"to"},e],["=",{field:"cc"},e],["=",{field:"bcc"},e],["=",{field:"content"},e]])}),"true"===a.attachment&&n.push(["=",{field:"content_type"},"multipart/mixed"]),a.after&&n.push([">",{field:"received_date"},String(a.after)]),a.before&&n.push(["<",{field:"received_date"},String(a.before)]),{action:"search",folder:"all"===a.folder?s.allMessagesFolder:e.app.folder.get(),columns:"102,600,601,602,603,604,605,606,607,608,610,611,614,652,656,X-Open-Xchange-Share-URL",sort:o.sort||"610",order:o.order||"desc",timezone:"utc",data:{filter:["and"].concat(n)}}},fetch:function(e){return l.wait().then(function(){return l.PUT({module:"mail",params:_(e).omit("data"),data:e.data})})},each:function(e){s.pool.add("detail",e)},PRIMARY_PAGE_SIZE:100,SECONDARY_PAGE_SIZE:100}),i=$('<div class="_hurz">').appendTo(this);require(["io.ox/backbone/views/search"],function(a){new a({el:i[0],point:"io.ox/mail/search/dropdown"}).build(function(){var o=this;e.app.on("folder:change",function(){o.cancel()}),e.app.folderView.tree.$el.on("click",function(){o.cancel()})}).on("search",function(e){o.connect(t),o.model.set({criteria:e,thread:!1,sort:610,order:"desc"}),o.$el.parent().find('.grid-options [data-name="thread"]').addClass("disabled")}).on("cancel",function(){var e=o.$el.parent().find('.grid-options [data-name="thread"]');e.hasClass("disabled")&&(o.connect(s.collectionLoader),o.model.unset("criteria"),e.removeClass("disabled"))}).render()})}},v=_.device("desktop")&&!navigator.webdriver&&c.get("prototypes/search",!1);v&&e.point("io.ox/mail/list-view/toolbar/top").extend(h),e.point("io.ox/mail/search/dropdown").extend({id:"default",index:100,render:function(){this.model.set("folder","current"),this.$dropdown.append(this.select("folder",a("Search in"),[{value:"current",label:a("Current folder")},{value:"all",label:a("All folders")}]),this.input("subject",a("Subject")),this.input("from",a("From")),this.input("to",a("To")),this.input("words",a("Contains words")),this.dateRange(),this.checkbox("attachment",a("Has attachments")),this.button())}}),e.point("io.ox/mail/view-options").extend({id:"sort",index:100,draw:function(e){var o=this.data("view"),t=e.app.folder.get();o.listenTo(e.app,"folder:change",function(){var t=e.app.folder.get();o.$('a[data-value="from-to"]').contents().last().replaceWith(a(i.is("sent|drafts",t)?"To":"From")),o.$('a[data-value="602"]').toggleClass("hidden",!p.pool.getModel(t).supports("ATTACHMENT_MARKER"))}),o.option("sort",610,a("Date"),{radio:!0}).option("sort","from-to",a(i.is("sent|drafts",t)?"To":"From"),{radio:!0}).option("sort",651,a("Unread"),{radio:!0}).option("sort",608,a("Size"),{radio:!0}).option("sort",607,a("Subject"),{radio:!0}),p.pool.getModel(t).supports("ATTACHMENT_MARKER")&&o.option("sort",602,a("Attachments"),{radio:!0}),c.get("features/flag/color")&&this.data("view").option("sort",102,a("Color"),{radio:!0}),c.get("features/flag/star")&&this.data("view").option("sort",660,a("Flag"),{radio:!0})}}),e.point("io.ox/mail/view-options").extend({id:"order",index:200,draw:function(){this.data("view").divider().option("order","asc",a("Ascending"),{radio:!0}).option("order","desc",a("Descending"),{radio:!0})}}),e.point("io.ox/mail/view-options").extend({id:"thread",index:300,draw:function(e){!1!==e.app.settings.get("threadSupport",!0)&&this.data("view").divider().option("thread",!0,a("Conversations"))}}),e.point("io.ox/mail/list-view/toolbar/"+(v?"bottom":"top")).extend({id:"dropdown",index:1e3,draw:function(t){var i=t.app,n=i.props,d=new o({tagName:"li",className:"dropdown grid-options toolbar-item margin-auto",attributes:{role:"presentation"},caret:!0,label:a.pgettext("dropdown","Sort"),dataAction:"sort",model:n,tabindex:-1});e.point("io.ox/mail/view-options").invoke("draw",d.$el,t),this.append(d.render().$el.find(".dropdown-menu").addClass("dropdown-menu-right").end().on("dblclick",function(e){e.stopPropagation()}));var r=_.partial(f,i,d.$el);i.props.on("change:find-result",r),i.on("folder:change",r),r()}}),e.point("io.ox/mail/all-options").extend({id:"default",index:100,draw:function(o){var t=o.app,i=d.extensions,n=this.$ul,r=["markFolderSeen","moveAllMessages","archive","divider","empty"];"virtual/all-unseen"===t.folder.get()||t.props.get("find-result")||t.props.get("categories")?r=["selectAll"]:this.header(a("All messages in this folder")),t.folder.getData().done(function(o){var a=new e.Baton({data:o,module:"mail",listView:t.listView});r.forEach(function(e){i[e].call(n,a)})})}}),e.point("io.ox/mail/list-view/toolbar/"+(v?"bottom":"top")).extend({id:"all",index:200,draw:function(t){function i(){r.prepareReuse().render(),e.point("io.ox/mail/all-options").invoke("draw",r,t)}var n=t.app,d=n.props,r=new o({tagName:"li",attributes:{role:"presentation"},className:"dropdown grid-options toolbar-item",caret:!0,label:a.pgettext("dropdown","All"),dataAction:"all",model:d});e.point("io.ox/mail/all-options").invoke("draw",r,t),this.append(r.render().$el.on("dblclick",function(e){e.stopPropagation()})),n.props.on("change:find-result change:categories",i),n.on("folder:change",i)}}),e.point("io.ox/mail/list-view/toolbar/bottom").extend({id:"toggle-folderview",index:100,draw:function(e){this.append($('<button type="button" class="btn btn-link toolbar-item pull-left" data-action="open-folder-view">').attr("aria-label",a("Open folder view")).append($('<i class="fa fa-angle-double-right" aria-hidden="true">').attr("title",a("Open folder view"))).on("click",{app:e.app,state:!0},u)),v&&e.app.getWindow().nodes.main.find(".list-view-control").removeClass("toolbar-bottom-visible"),e.app.on({"folderview:open":m.bind(null,e.app),"folderview:close":w.bind(null,e.app)}),e.app.folderViewIsVisible()&&_.defer(m,e.app)}}),e.point("io.ox/mail/sidepanel").extend({id:"toggle-folderview",index:1e3,draw:function(e){var o=_.uniqueId("control");this.addClass("bottom-toolbar").append($('<div class="generic-toolbar bottom visual-focus" role="region">').attr("aria-labelledby",o).append($('<button type="button" class="btn btn-link toolbar-item" data-action="close-folder-view">').attr({id:o,"aria-label":a("Close folder view")}).append($('<i class="fa fa-angle-double-left" aria-hidden="true">').attr("title",a("Close folder view"))).on("click",{app:e.app,state:!1},u)))}}),e.point("io.ox/mail/sidepanel").extend({id:"help",index:1100,draw:n.help}),e.point("io.ox/mail/sidepanel").extend({id:"premium-area",index:1e4,draw:function(e){this.append(n.addPremiumFeatures(e.app,{append:!1,upsellId:"folderview/mail/bottom",upsellRequires:"active_sync"}))}})});