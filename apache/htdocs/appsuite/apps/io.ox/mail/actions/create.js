define("io.ox/mail/actions/create",["io.ox/contacts/api","io.ox/core/api/user","io.ox/mail/util","io.ox/core/yell","settings!io.ox/core","settings!io.ox/calendar","gettext!io.ox/core","io.ox/calendar/util"],function(t,e,i,a,n,o,r,c){"use strict";function u(){clearTimeout(m),ox.idle()}function l(i){return e.get().then(function(t){var e=_.compact([t.email1,t.email2,t.email3]);return _.chain([].concat(i.to,i.cc,i.from)).compact().map(function(t){return t[1]}).unique().reject(function(t){return _.contains(e,t)}).value()}).then(function(e){var i=_(e).map(function(e){return t.search(e).then(function(t){return t[0]||{email1:e,display_name:e,mail_field:0}})});return $.when.apply($,i)}).fail(function(){u(),a("error",r("Error while resolving mail addresses. Please try again."))})}function s(t,e){var i=moment().startOf("hour").add(1,"hours"),a={attendees:t,summary:e,folder_id:o.get("chronos/defaultFolderId"),startDate:{value:i.format("YYYYMMDD[T]HHmmss"),tzid:i.tz()},endDate:{value:i.add(1,"hours").format("YYYYMMDD[T]HHmmss"),tzid:i.tz()}};ox.launch("io.ox/calendar/edit/main").always(u).done(function(){this.create(a),this.model.toSync=a})}function d(t,e){ox.launch("io.ox/contacts/distrib/main").always(u).done(function(){this.create(n.get("folder/contacts"),{distribution_list:t,display_name:e})})}var m=setTimeout(function(){ox.busy(!0)},500);return{createAppointment:function(t){l(t.data).then(function(){var e=[];_(arguments).each(function(t){t.internal_userid?(t.type=1,t.user_id=t.internal_userid):(t.type=5,t.mail=t.email1),e.push(c.createAttendee(t))}),console.log(t.data.subject),s(e,t.data.subject)})},createDistributionList:function(t){l(t.data).then(function(){var e=[];_(arguments).each(function(t){e.push(t.id?{id:t.id,folder_id:t.folder_id,display_name:t.display_name,mail:t.email1,mail_field:1}:{type:5,display_name:t.display_name,mail:t.email1})}),d(e,t.data.subject)})}}});