define("io.ox/mail/main",["io.ox/mail/util","io.ox/mail/api","io.ox/mail/compose/api","io.ox/core/commons","io.ox/mail/listview","io.ox/core/tk/list-control","io.ox/mail/threadview","io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/core/api/account","io.ox/core/notifications","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/core/capabilities","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/core/folder/api","io.ox/backbone/mini-views/quota","io.ox/backbone/views/action-dropdown","io.ox/mail/categories/mediator","io.ox/core/api/account","gettext!io.ox/mail","settings!io.ox/mail","settings!io.ox/core","io.ox/core/api/certificate","io.ox/settings/security/certificates/settings/utils","io.ox/mail/actions","io.ox/mail/mobile-navbar-extensions","io.ox/mail/mobile-toolbar-actions","io.ox/mail/toolbar","io.ox/mail/import","less!io.ox/mail/style","io.ox/mail/folderview-extensions"],function(e,t,i,o,n,a,s,r,l,c,d,f,u,g,p,h,m,w,v,b,x,V,y,k,C,T){"use strict";var P=ox.ui.createApp({name:"io.ox/mail",id:"io.ox/mail",title:"Mail"}),S=!1;return P.mediator({"pages-mobile":function(e){if(!_.device("!smartphone")){var t=e.getWindow(),i=$('<div class="mobile-navbar">'),o=$('<div class="mobile-toolbar">').on("hide",function(){t.nodes.body.removeClass("mobile-toolbar-visible")}).on("show",function(){t.nodes.body.addClass("mobile-toolbar-visible")}),n=r.Baton({app:e});e.navbar=i,e.toolbar=o,e.pages=new u({appname:e.options.name,toolbar:o,navbar:i,container:t.nodes.main}),t.nodes.body.addClass("classic-toolbar-visible").append(i,o),e.pages.addPage({name:"folderTree",navbar:new f.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"})}),e.pages.addPage({name:"listView",startPage:!0,navbar:new f.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"}),toolbar:new f.ToolbarView({baton:n,page:"listView",extension:"io.ox/mail/mobile/toolbar"}),secondaryToolbar:new f.ToolbarView({baton:n,page:"listView/multiselect",extension:"io.ox/mail/mobile/toolbar"})}),e.pages.addPage({name:"threadView",navbar:new f.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"}),toolbar:new f.ToolbarView({baton:n,page:"threadView",extension:"io.ox/mail/mobile/toolbar"})}),e.pages.addPage({name:"detailView",navbar:new f.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"}),toolbar:new f.ToolbarView({baton:n,page:"detailView",extension:"io.ox/mail/mobile/toolbar"})}),e.pages.getPage("detailView").on("pagebeforehide",function(){$(this).find(".popover-open").popover("destroy")}),e.pages.setBackbuttonRules({listView:"folderTree",threadView:"listView"})}},"navbars-mobile":function(e){_.device("smartphone")&&(e.pages.getNavbar("listView").setLeft(V("Folders")).setRight(V("Edit")),e.pages.getNavbar("folderTree").setTitle(V("Folders")).setLeft(!1).setRight(V("Edit")),e.pages.getNavbar("detailView").setTitle("").setLeft(V("Back")),e.pages.getNavbar("threadView").setTitle(V("Thread")).setLeft(V("Back")),e.pages.showPage("listView"))},"toolbars-mobile":function(){_.device("smartphone")&&(P.pages.getNavbar("listView").on("leftAction",function(){P.pages.goBack()}),P.pages.getNavbar("threadView").on("leftAction",function(){P.pages.goBack(),P.listView.selection.selectNone()}),P.pages.getNavbar("detailView").on("leftAction",function(){P.pages.goBack(),P.listView.selection.selectNone()}),P.pages.getNavbar("listView").on("rightAction",function(){P.props.set("checkboxes",!P.props.get("checkboxes"))}))},"pages-desktop":function(e){_.device("smartphone")||(e.pages=new u(e),e.getWindow().nodes.main.addClass("vsplit"),e.pages.addPage({name:"listView",container:e.getWindow().nodes.main,classes:"leftside"}),e.pages.addPage({name:"detailView",container:e.getWindow().nodes.main,classes:"rightside"}))},"folder-view":function(e){_.device("smartphone")||(e.treeView=new p({app:e,module:"mail",contextmenu:!0}),h.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable())},"folder-view-mobile":function(e){if(_.device("!smartphone"))return e;var t=e.pages.getNavbar("folderTree"),i=e.pages.getPage("folderTree");t.on("rightAction",function(){e.toggleFolders()});var o=new p({app:e,module:"mail",root:"1",contextmenu:!0});h.initialize({app:e,tree:o}),i.append(o.render().$el),e.treeView=o},"folder-view-ssl-events":function(e){!k.get("security/acceptUntrustedCertificates")&&k.get("security/manageCertificates")&&(e.treeView.on("accountlink:ssl",function(){ox.launch("io.ox/settings/main",{folder:"virtual/settings/io.ox/certificate"})}),e.treeView.on("accountlink:sslexamine",function(e){T.openExaminDialog(e)}))},"folder-view-account-ssl-error":function(e){function t(e,t){var i=[];return _.each(t,function(t){_(_.values(t)).contains(e)&&i.push(t)}),i}function i(i,o,n){x.all().done(function(a){var s=i?t(i,a):a;_.each(s,function(t){x.getStatus(t.id).done(function(i){var a=e.treeView.getNodeView(t.root_folder);if(a)if("invalid_ssl"===i[t.id].status){var s=o?"accountlink:sslexamine":"accountlink:ssl",r=o?n:a.options.model_id;a.showStatusIcon(i[t.id].message,s,r)}else a.hideStatusIcon(),a.render()})})})}ox.on("http:error SSL:remove",function(e){/^SSL/.test(e.code)&&C.get({fingerprint:e.error_params[0]}).done(function(t){_.isEmpty(t)?i(t.hostname,["accountlink:sslexamine"],e):i(t.hostname)})}),x.on("refresh:ssl",function(e,t){i(t)})},"mail-quota":function(e){if(!_.device("smartphone")){var i=new w({title:V("unified"===k.get("quotaMode","default")?"Quota":"Mail quota"),renderUnlimited:!1,upsell:{title:V("Need more space?"),requires:"active_sync || caldav || carddav",id:"mail-folderview-quota",icon:""},upsellLimit:5242880});m.on("cleared-trash",function(){i.getQuota(!0)}),t.on("deleted-mails-from-trash",function(){i.getQuota(!0)}),t.on("refresh.all",function(){i.getQuota(!0)}),e.treeView.$el.append(i.render().$el)}},"select-all-actions":function(){t.on("move deleted-mails archive",function(){P.listView.collection.length||P.listView.reload()})},props:function(e){e.props=new Backbone.Model({layout:function(){if(_.device("smartphone"))return"vertical";var t=e.settings.get("layout","vertical");return"compact"===t&&_.device("!desktop")&&(t="vertical"),t}(),checkboxes:!_.device("smartphone")&&e.settings.get("showCheckboxes",!1),contactPictures:!_.device("smartphone")&&e.settings.get("showContactPictures",!1),textPreview:e.settings.get("showTextPreview",!0),exactDates:e.settings.get("showExactDates",!1),alwaysShowSize:e.settings.get("alwaysShowSize",!1),categories:e.settings.get("categories/enabled",!1),category_id:b.getInitialCategoryId(),mobileFolderSelectMode:!1})},"toggle-folder-editmode":function(e){if(!_.device("!smartphone")){e.toggleFolders=function(){var t=e.pages.getPage("folderTree"),i=e.props.get("mobileFolderSelectMode"),o=V(i?"Edit":"Cancel");e.props.set("mobileFolderSelectMode",!i),e.pages.getNavbar("folderTree").setRight(o),t.toggleClass("mobile-edit-mode",!i)}}},"all-unseen":function(e){function i(){t.getAllUnseenMessages().done(function(e){var t=_(e).chain().filter(function(e){return e.id=e.original_id,e.folder_id=e.original_folder_id,!x.is("spam|confirmed_spam|trash",e.folder_id)}).pluck("folder_id").uniq().value();m.multiple(t)})}function o(){i(),ox.on("refresh^",i)}var n=t.collectionLoader,a=n.getQueryParams({folder:"virtual/all-unseen"}),s=n.getCollection(a);s.gc=!1,s.preserve=!0,s.CUSTOM_PAGE_SIZE=250,s.on("load reload",function(){this.setComplete(!0)});var r=m.pool.getModel("virtual/all-unseen");t.on("all-unseen",function(e,t){r.set("unread",t)}),y.get("features/unseenFolder")&&(y.get("unseenMessagesFolder")?o():y.once("change:features/unseenFolder",o)),e.folderView.tree.selection.addSelectableVirtualFolder("virtual/all-unseen")},"unselectable-folders":function(){if(x.cache[0]){var e=x.cache[0].root_folder+"/Shared";P.folderView.tree.selection.addUnselectableFolder(e)}},vsplit:function(e){var t=e.pages.getPage("listView"),i=e.pages.getPage("detailView");e.left=t.toggleClass("border-right",_.device("!smartphone")),e.right=i.addClass("mail-detail-pane")},"list-view":function(e){e.listView=new n({swipe:!0,app:e,draggable:!0,ignoreFocus:!0,selectionOptions:{mode:"special"}}),e.listView.model.set({folder:e.folder.get(),thread:e.settings.get("threadSupport",!0)}),window.list=e.listView},"list-view-checkboxes":function(e){_.device("smartphone")||e.listView.toggleCheckboxes(e.props.get("checkboxes"))},"list-view-checkboxes-mobile":function(e){_.device("smartphone")&&(e.props.set("checkboxes",!1),e.listView.toggleCheckboxes(!1))},"react to markunread":function(){t.on("after:refresh.unseen",function(e,i){1===i.length&&(t.setToUnread=i[0].cid)}),P.listView.on("selection:multiple selection:one",function(){delete t.setToUnread}),P.listView.on("selection:action",function(){"list"!==P.props.get("layout")&&delete t.setToUnread})},"auto-scroll":function(t){t.listView.on("add",function(i,o){if(0===o&&e.isUnseen(i.toJSON())){var n=t.listView.$el.height()/2;t.listView.$el.scrollTop()>n||t.listView.$el.scrollTop(0)}})},"get-view-options":function(e){e.getViewOptions=function(t){var i=e.settings.get(["viewOptions",t],{});return e.settings.get("threadSupport",!0)||(i.thread=!1),(!y.get("features/flag/color")&&102===i.sort||!y.get("features/flag/star")&&660===i.sort||602===i.sort&&!m.pool.getModel(t).supports("ATTACHMENT_MARKER"))&&delete i.sort,_.extend({sort:610,order:"desc",thread:!1},i)}},"prop-folderview":function(e){e.props.set("folderview",!_.device("smartphone")&&e.settings.get("folderview/visible/"+_.display(),!0))},"change:sort":function(e){e.props.on("change:sort",function(t,i){t=e.listView.model,"from-to"===i&&(i=c.is("sent|drafts",t.get("folder"))?604:603),e.changingFolders||(t.set("order",/^(610|608|102|660|651)$/.test(i)?"desc":"asc",{silent:!0}),e.props.set("order",t.get("order"))),t.set({sort:i})})},"change:order":function(e){e.props.on("change:order",function(t,i){e.listView.model.set("order",i)})},"change:thread":function(e){e.props.on("change:thread",function(t,i){if(!e.changingFolders&&e.listView.collection){var o=e.listView.collection;_.defer(function(){o.reset(),o.setComplete(!1)})}e.listView.model.set("thread",!!i)})},isThreaded:function(e){e.isThreaded=function(){return"search"!==e.listView.loader.mode&&e.props.get("thread")}},getContextualData:function(e){e.getContextualData=function(i){var o=e.isThreaded(),n=t.resolve(i,o);return{app:e,data:n,folder_id:e.folder.get(),isThread:o}}},"store-view-options":function(e){e.props.on("change",_.debounce(function(){if(!e.props.get("find-result")){var t=e.folder.get(),i=e.props.toJSON();e.settings.set(["viewOptions",t],{sort:i.sort,order:i.order,thread:i.thread}).set("showTextPreview",i.textPreview).set("showExactDates",i.exactDates).set("alwaysShowSize",i.alwaysShowSize).set("categories/enabled",i.categories),_.device("!smartphone")&&e.settings.set("layout",i.layout).set("showCheckboxes",i.checkboxes).set("showContactPictures",i.contactPictures),e.settings.save()}},500))},"restore-view-options":function(e){var t=e.getViewOptions(e.folder.get());e.changingFolders=!0,e.props.set(t),e.changingFolders=!1},"list-view-control":function(e){e.listControl=new a({id:"io.ox/mail",listView:e.listView,app:e}),e.left.append(e.listControl.render().$el.attr("aria-label",V("Messages")).find(".toolbar").attr("aria-label",V("Messages options")).end()),_.device("smartphone")&&(e.listControl.$(".toolbar.bottom").hide(),e.listControl.$(".toolbar.top").removeClass("top").addClass("bottom"),e.listControl.$el.removeClass("toolbar-top-visible")),e.listControl.resizable()},textPreview:function(e){var t=y.get("features/textPreview",!0);e.supportsTextPreview=function(){return t},e.supportsTextPreviewConfiguration=function(){var i=e.folder.get();return t&&(c.isPrimary(i)||"virtual/all-unseen"===i)},e.useTextPreview=function(){return e.supportsTextPreviewConfiguration()&&e.props.get("textPreview")},e.on("resume",function(){this.listView.fetchTextPreview()})},"thread-view":function(e){_.device("smartphone")||(e.threadView=new s.Desktop({app:e}),e.right.append(e.threadView.render().$el))},"thread-view-mobile":function(e){_.device("smartphone")&&(e.threadView=new s.Mobile,e.threadView.$el.on("showmail",function(t){var i=$(t.target).data().cid;e.showMail(i),e.pages.changePage("detailView")}),e.pages.getPage("threadView").append(e.threadView.render().$el))},"selection-message":function(e){e.right.append($('<div class="io-ox-center multi-selection-message"><div class="message"></div></div>'))},navigation:function(e){e.threadView.on({back:function(){e.right.removeClass("preview-visible"),e.listView.focus()},previous:function(){e.listView.previous()},next:function(){e.listView.next()}})},position:function(e){function t(){var t=e.listView;e.threadView.updatePosition(t.getPosition()+1).togglePrevious(t.hasPrevious()).toggleNext(t.hasNext())}e.listView.on("selection:action",t),t()},"folder:change":function(e){e.folderView.tree.on("selection:action",function(){"list"===e.props.get("layout")&&e.right.hasClass("preview-visible")&&e.threadView.trigger("back")}),e.on("folder:change",function(t){if(!e.props.get("mobileFolderSelectMode")){e.changingFolders=!0;var i=e.getViewOptions(t);e.props.set(_.pick(i,"sort","order","thread")),"from-to"===i.sort&&e.listView.model.set("sort",c.is("sent|drafts",t)?604:603),e.listView.model.set("folder",t),e.folder.getData(),e.changingFolders=!1}})},"auto-subscribe":function(e){function t(t){"mail"===t.module&&(t.subscribed?e.folderView.tree.select(t.id):m.update(t.id,{subscribed:!0},{silent:!0}).done(function(){m.refresh().done(function(){e.folderView.tree.select(t.id)})}))}e.folder.getData().done(t),e.on("folder:change",function(e,i){t(i)})},"folder:change-mobile":function(e){_.device("smartphone")&&e.on("folder:change",function(){e.props.get("mobileFolderSelectMode")||e.folder.getData().done(function(t){e.pages.getNavbar("listView").setTitle(t.title)})})},"show-mail":function(e){function i(){if(e.listView.collection.get(a)&&(e.threadView.autoSelect=e.autoSelect,delete e.autoSelect,e.threadView.show(a,e.isThreaded()),S||"list"===e.props.get("layout"))){S=!1;var t=e.threadView.$(".list-item"),i=t.index(t.filter(".expanded"));t.filter(".expanded:first").find(".body").visibleFocus(),0===i&&e.threadView.$(".scrollable").scrollTop(0)}}if(!_.device("smartphone")){var o,n,a,s=0;e.recentDelete=function(){return s>0},e.showMail=function(t){if(a=t,!s)return i();if(e.threadView.model&&e.threadView.model.cid===t)return i();e.threadView.empty(),clearTimeout(n);var o=1e3*(s-1);n=setTimeout(i,o)},t.on("beforedelete",function(){s<2&&s++,clearTimeout(o),o=setTimeout(function(){s=0},4e3)})}},"show-mail-mobile":function(e){_.device("smartphone")&&(e.showMail=function(t){e.pages.getPage("detailView").empty().append(e.threadView.renderMail(t))})},"mobile-show-thread-overview":function(e){e.showThreadOverview=function(t){e.threadView.show(t,e.isThreaded())}},"show-empty":function(e){e.showEmpty=function(){e.threadView.empty(),e.right.find(".multi-selection-message .message").empty().append(V("No message selected")).attr("id","mail-multi-selection-message")}},"show-multiple":function(e){_.device("smartphone")||(e.showMultiple=function(i){e.threadView.empty(),i=t.resolve(i,e.isThreaded());var o=e.folder.get(),n=m.pool.getModel(o).get("total"),a=e.get("find")&&e.get("find").isActive();_.defer(function(){var t=$('<span class="number">').text(i.length).prop("outerHTML");e.right.find(".multi-selection-message .message").empty().attr("id","mail-multi-selection-message").append($("<div>").append(V.format(V.ngettext("%1$d message selected","%1$d messages selected",t,t))),o&&n>i.length&&!a?$('<div class="inline-actions selection-message">').append(V("There are %1$d messages in this folder; not all messages are displayed in the list currently.",n)).hide():$())})},e.showSelectionMessage=function(){_.defer(function(){e.right.find(".selection-message").show()})})},"show-multiple-mobile":function(e){_.device("!smartphone")||(e.showMultiple=function(i){e.threadView.empty(),i?(i=t.resolve(i,e.isThreaded()),e.pages.getCurrentPage().navbar.setTitle(V("%1$d selected",i.length)),e.pages.getCurrentPage().secondaryToolbar.render()):e.folder.getData().done(function(t){e.pages.getCurrentPage().navbar.setTitle(t.title)})})},"page-change-detail-view-mobile":function(){P.pages.getPage("detailView").on("header_ready",function(){P.pages.changePage("detailView")})},"selection-mobile":function(e){_.device("smartphone")&&e.listView.on({"selection:empty":function(){e.props.get("checkboxes")&&e.showMultiple(!1)},"selection:one":function(t){e.props.get("checkboxes")&&e.showMultiple(t)},"selection:multiple":function(t){e.props.get("checkboxes")&&e.showMultiple(t)},"selection:action":function(t){var i=_.contains(c.getFoldersByType("drafts"),this.model.get("folder"));if(1===e.listView.selection.get().length&&!e.props.get("checkboxes")){var o=t[0],n=this.collection.get(o).get("threadSize")>1;if(i){var a=_.cid(o);ox.registry.call("mail-compose","open",{type:"copy",original:{folderId:a.folder_id,id:a.id}})}else n?(e.showThreadOverview(o),e.pages.changePage("threadView")):e.showMail(o)}}})},selection:function(e){function t(t){return e.right.removeClass("selection-empty selection-one selection-multiple preview-visible".replace(t,"")).addClass(t)}function i(t){return e.left.removeClass("selection-empty selection-one selection-multiple".replace(t,"")).addClass(t)}if(!_.device("smartphone")){var o=_.debounce(function(o,n){if("list"===e.props.get("layout")&&"action"===o)return t("selection-one preview-visible"),i("selection-one"),void e.showMail(n[0]);if("list"===e.props.get("layout")&&"one"===o)return t("selection-one"),void i("selection-one");switch(o){case"empty":t("selection-empty"),i("selection-empty"),e.showEmpty();break;case"one":case"action":t("selection-one"),i("selection-one"),e.showMail(n[0]);break;case"multiple":t("selection-multiple"),i("selection-multiple"),e.showMultiple(n)}},1);e.listView.on({"selection:empty":function(){e.right.find(".multi-selection-message div").attr("id",null),o("empty")},"selection:one":function(t){e.right.find(".multi-selection-message div").attr("id",null);var i="one";"alternative"===e.listView.selection.getBehavior()&&(i="multiple"),o(i,t)},"selection:multiple":function(o){e.right.find(".multi-selection-message div").attr("id",null),t("selection-multiple"),i("selection-multiple"),e.showMultiple(o)},"selection:action":function(t){e.right.find(".multi-selection-message div").attr("id",null),1===e.listView.selection.get().length&&o("action",t)},"selection:showHint":function(){e.showSelectionMessage()}})}},"preserve-selection":function(e){_.device("smartphone")||e.listView.on({"selection:add":function(i){651===e.props.get("sort")&&_(i).each(function(e){t.pool.preserveModel(e,!0)})},"selection:remove":function(e){_(e).each(function(e){t.pool.preserveModel(e,!1)})}})},"change:layout":function(e){e.props.on("change:layout",function(t,i){e.threadView.toggleNavigation("list"===i),ox.ui.apps.trigger("layout",e)}),e.threadView.toggleNavigation("list"===e.props.get("layout"))},"apply-layout":function(e){_.device("smartphone")||(e.applyLayout=function(){var t,i,o,n=e.props.get("layout"),a=e.getWindow().nodes,s=e.settings.get("listview/width/"+_.display()),r=e.settings.get("listview/height/"+_.display());e.left.css({width:"",height:""}),e.right.css({left:"",top:""}),"vertical"===n||"compact"===n?(a.main.addClass("preview-right").removeClass("preview-bottom preview-none"),_.device("touch")||function(t){var i=void 0===t?"":t+"px";e.right.css("left",i),e.left.css("width",i)}(s)):"horizontal"===n?(a.main.addClass("preview-bottom").removeClass("preview-right preview-none"),_.device("touch")||function(t){var i=void 0===t?"":t+"px";e.right.css("top",i),e.left.css("height",i)}(r)):"list"===n&&a.main.addClass("preview-none").removeClass("preview-right preview-bottom"),t=a.body.find(".classic-toolbar-container"),i=a.body.find(".categories-toolbar-container"),o="classic-toolbar-visible","compact"===n?(a.body.removeClass(o),e.right.addClass(o).prepend(t),i.length>0&&e.right.prepend(i)):(e.right.removeClass(o),a.body.addClass(o).prepend(t),i.length>0&&a.body.prepend(i)),"list"===n||"list"!==e.props.previousAttributes().layout||e.right.hasClass("preview-visible")||e.listView.selection.get().length>0&&e.listView.selection.selectEvents(e.listView.selection.getItems()),this.listControl.applySizeConstraints()},e.props.on("change:layout",function(){var t=e.getWindow().nodes.body,i=t.find('*[data-dropdown="view"] a:first').is(":focus");e.applyLayout(),e.listView.redraw(),i&&t.find('*[data-dropdown="view"] a:first').focus()}),e.getWindow().on("show:initial",function(){e.applyLayout()}))},refresh:function(e){t.on("refresh.all",function(){e.listView.reload()})},reloadOnFolderChange:function(e){t.on("changesAfterReloading",function(){e.listView.reload()})},"auto-select":function(t){if(y.get("autoselectMailOnStart",!0)&&!_.device("smartphone")){var i=function(){t.listView.collection.find(function(i,o){if(!e.isUnseen(i.get("flags")))return t.autoSelect=!0,t.listView.selection.select(o,!1,!1),t.listView.selection.getItems().eq(o).attr("tabindex","0").intoViewport(),!0})};t.listView.on("first-reset",function(){"list"!==t.props.get("layout")?_.defer(i):t.props.once("change:layout",function(){t.listView.selection.get().length||_.defer(i)})})}},"init-navbarlabel-mobile":function(e){_.device("smartphone")&&e.listView.on("first-reset",function(){e.folder.getData().done(function(t){e.pages.getNavbar("listView").setTitle(t.title)})})},prefetch:function(i){var o=y.get("prefetch/count",5);!_.isNumber(o)||o<=0||(i.prefetch=function(i){var n=require("io.ox/core/http");n.pause(),i.chain().filter(function(t){return!e.isDeleted(t)}).slice(0,o).each(function(i){var o,n,a=i.get("thread")||[i.toJSON()];for(o=a.length-1;n=a[o];o--)if(_.isString(n)&&(n=_.cid(n)),(0===o||e.isUnseen(n))&&!e.isDeleted(n)){t.get({folder:n.folder_id,id:n.id,unseen:!0});break}}),n.resume()},i.listView.on("first-reset",i.prefetch))},"prefetch-message":function(e){_.device("smartphone")||y.get("prefetch/next",!0)&&e.listView.on("selection:one",function(){if(!e.recentDelete()){var i,o=this.selection.getItems(),n=this.selection.getPosition(o),a=this.selection.getDirection(),s=o.length-1;"down"===a&&n<s?i=o.eq(n+1):"up"===a&&n>0&&(i=o.eq(n-1)),i&&((i=_.cid(i.attr("data-cid"))).unseen=!0,t.get(i))}})},"prefetch-compose":function(){_.device("smartphone")||setTimeout(function(){require(["io.ox/mail/compose/main","io.ox/mail/compose/bundle"],function(){require(["io.ox/core/api/snippets"],function(e){e.getAll()})})},3e3)},"connect-loader":function(e){e.listView.connect(t.collectionLoader)},"before-delete":function(e){function i(e,t){return 1===e.length&&(1===t.length&&_.cid(e[0])!==String(t[0]).replace(/^thread\./,""))}_.device("smartphone")||y.get("features/selectBeforeDelete",!0)&&t.on("beforedelete beforeexpunge",function(o,n){var a=e.listView.selection.get();if(!i(n,a)&&(n.length>0&&!_.isString(n[0])&&(n=_(n).map(_.cid)),_.intersection(n,a).length)){if(e.listView.selection.dodge(),e.isThreaded()&&t.one("deleted-mails",function(){e.listView.reload()}),1===n.length)return;e.listView.onBatchRemove(n.slice(1))}})},"before-delete-mobile":function(e){_.device("smartphone")&&t.on("beforedelete",function(){"detailView"===e.pages.getCurrentPage().name&&(e.isThreaded()&&1===e.threadView.collection.length?e.pages.changePage("listView",{animation:"slideright"}):e.pages.goBack()),e.listView.selection.selectNone()})},"drag-drop":function(){P.getWindow().nodes.outer.on("selection:drop",function(e,t){var i=r.Baton(P.getContextualData(t.data));i.target=t.target,l.invoke("io.ox/mail/actions/move",i)})},"selection-archive":function(){P.listView.on("selection:archive",function(e){var t=r.Baton(P.getContextualData(e));l.invoke("io.ox/mail/actions/archive",t)})},"selection-delete":function(){P.listView.on("selection:delete",function(e,t){var i=r.Baton(P.getContextualData(e));i.options.shiftDelete=t,l.invoke("io.ox/mail/actions/delete",i)})},"selection-doubleclick":function(e){_.device("smartphone")||e.listView.on("selection:doubleclick",function(i){e.isThreaded()&&(i=_(t.threads.get(i[0])).pluck("cid"));var o=i[0],n=_.cid(o);c.is("drafts",n.folder_id)?t.get(n).then(function(e){l.invoke("io.ox/mail/actions/edit",e)}):ox.launch("io.ox/mail/detail/main",{cid:o})})},"selection-mobile-swipe":function(e){_.device("!smartphone")||(r.point("io.ox/mail/mobile/swipeButtonMore").extend({draw:function(t){new v({el:this,point:"io.ox/mail/links/inline"}).setSelection(t.array(),{data:t.array(),app:e,isThread:t.isThread})}}),e.listView.on("selection:more",function(i,o){var n=r.Baton({data:i});n.isThread=1===n.data.length&&/^thread\./.test(n.data[0]),n.data=t.resolve(n.data,e.isThreaded()),r.point("io.ox/mail/mobile/swipeButtonMore").invoke("draw",o,n),o.find("a.dropdown-toggle").click()}))},"change:folderview":function(e){_.device("smartphone")||(e.props.on("change:folderview",function(t,i){e.folderView.toggle(i)}),e.on("folderview:close",function(){e.props.set("folderview",!1)}),e.on("folderview:open",function(){e.props.set("folderview",!0)}))},"change:checkboxes":function(e){_.device("smartphone")||("alternative"===e.listView.selection.getBehavior()?e.listView.toggleCheckboxes(!0):e.props.on("change:checkboxes",function(t,i){e.listView.toggleCheckboxes(i)}))},"change:checkboxes-mobile":function(e){_.device("!smartphone")||(e.listControl.$el.toggleClass("toolbar-bottom-visible",!1),e.props.on("change:checkboxes",function(t,i){e.listView.toggleCheckboxes(i),e.listControl.$el.toggleClass("toolbar-bottom-visible",i),i?e.pages.getNavbar("listView").setRight(V("Cancel")).hide(".left"):(e.pages.getNavbar("listView").setRight(V("Edit")).show(".left"),e.folder.getData().done(function(t){e.pages.getCurrentPage().navbar.setTitle(t.title)}),e.listView.selection.selectNone())}))},"change:viewOptions":function(e){function t(){e.listView.$el.toggleClass("show-contact-pictures",e.props.get("contactPictures")).toggleClass("show-text-preview",e.useTextPreview())}e.props.on("change:contactPictures change:exactDates change:alwaysShowSize change:textPreview",function(){e.listView.redraw(),e.listView.$el.trigger("scroll"),t()}),e.on("folder:change",t),t()},"fix-mobile-lazyload":function(e){_.device("!smartphone")||e.pages.getPage("detailView").on("pageshow",function(){$(this).scrollTop(0),$(this).find("li.lazy").trigger("scroll")})},"inplace-find":function(e){function i(e,i){i.on("collectionLoader:created",function(e){e.each=function(e){t.pool.add("detail",e)}})}if(!_.device("smartphone")&&g.has("search")&&e.isFindSupported())return e.initFind(),e.get("find")?i(0,e.get("find")):e.once("change:find",i)},"on:pull-to-refresh":function(e){_.device("!touch")||e.on("pull-to-refresh",function(){t.refresh().always(function(){e.listView.removePullToRefreshIndicator()})})},"contextual-help":function(e){e.getContextualHelp=function(){return"ox.appsuite.user.sect.email.gui.html"}},a11y:function(e){e.listView.$el.attr("aria-label",V("List view")),e.listView.$el.on("keydown",".list-item",function(t){if(13!==t.which)return 27===t.which?(e.folderView.tree.$(".folder.selected").focus(),!1):void 0;S=!0}),e.threadView.$el.on("keydown",function(t){27===t.which&&($(t.target).is(".dropdown-toggle, :input")||(e.right.removeClass("preview-visible"),e.listView.restoreFocus(!0)))}),e.folderView.tree.$el.on("keydown",".folder",function(t){$(t.target).hasClass("folder")&&13===t.which&&e.listView.restoreFocus(!0)})},"auto-expunge":function(e){function i(e){return 2==(2&e.get("flags"))}y.get("features/autoExpunge",!1)&&e.listView.on("collection:load collection:paginate collection:reload",function(){this.collection.any(i)&&t.expunge(e.folder.get())})},"folder-errors":function(e){m.on("error:MSG-0092",function(e){d.yell(e)}),e.folder.handleErrors()},"save-draft":function(e){i.on("before:send before:save",function(e,i){var o=i.meta.editFor;if(o){var n=_.cid({id:o.originalId,folder_id:o.originalFolderId}),a=c.getFoldersByType("drafts");_(a).each(function(e){_(t.pool.getByFolder(e)).each(function(e){e.remove(n)})})}}),i.on("after:send after:save",function(){var t=e.folder.get();c.is("drafts",t)&&e.listView.reload()})},"mail-progress":function(){_.device("smartphone")||r.point("io.ox/mail/sidepanel").extend({id:"progress",index:300,draw:function(){var e=$('<div class="generic-toolbar bottom mail-progress">').hide().append($('<div class="progress">').append($('<div class="progress-bar">')),$('<div class="caption">').append($("<span>"),$('<a href="#" class="close" data-action="close" role="button">').attr("aria-label",V("Close")).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",V("Close")))));i.queue.collection.on("progress",function(t){if(!t.count)return _.device("safari")&&(e.closest(".window-sidepanel").find(".folder-tree")[0].scrollTop+=1),e.hide();var i=t.count,o=Math.round(100*t.pct),n=V.ngettext("Sending 1 message ... %2$d%","Sending %1$d messages ... %2$d%",i,i,o);e.find(".progress-bar").css("width",o+"%"),e.find(".caption span").text(n),e.find('[data-action="close"]').off().on("click",function(e){e.preventDefault(),t.abort()}).toggle(t.pct<1),e.show()}),this.append(e)}})},"refresh-folders":function(){function e(e,i){if(i.error)return $.Deferred().reject(i).promise();if(i.data){var o=_(i.data.toString().split(t.separator)),n=o.last(),a=o.without(n).join(t.separator);$.when(x.getUnifiedMailboxName(),x.getPrimaryAddress()).done(function(t,i){var o=!1;_.chain(_.union(e.to,e.cc,e.bcc)).each(function(e){e[1]!==i[1]||(o=!0)}),setTimeout(function(){null!==t?m.refresh():o?m.reload(a,x.getInbox()):m.reload(a)},5e3)})}}var o=_.throttle(function(){var e=_(["inbox","sent","drafts"]).chain().map(function(e){var i=x.getFoldersByType(e);return t.pool.resetFolder(i),i}).flatten().value();m.multiple(e,{cache:!1}),t.trigger("refresh.all")},5e3,{leading:!1});i.on("after:save after:send",function(t,i){o(),e(t,i)})},sidepanel:function(e){if(!_.device("smartphone")){r.point("io.ox/mail/sidepanel").extend({id:"tree",index:100,draw:function(e){this.addClass("border-right").append(e.app.treeView.$el)}});var t=e.getWindow().nodes.sidepanel;r.point("io.ox/mail/sidepanel").invoke("draw",t,r.Baton({app:e}))}},metrics:function(e){require(["io.ox/metrics/main"],function(t){function i(e,i){var o=!!(i=$(i)).attr("data-name");t.trackEvent({app:"mail",target:e,type:"click",action:o?i.attr("data-name"):i.attr("data-action"),detail:o?i.attr("data-value"):""})}if(t.isEnabled()){var o=e.getWindow().nodes,n=o.outer,a=o.sidepanel;t.watch({node:n,selector:'[data-action="add-mail-account"]',type:"click"},{app:"mail",target:"folder/account",type:"click",action:"add"}),o.body.on("mousedown",".categories-toolbar-container .category",function(e){t.trackEvent({app:"mail",target:"toolbar",type:"click",action:"select-tab",detail:$(e.currentTarget).attr("data-id")})}),o.body.on("track",".classic-toolbar-container",function(e,t){i("toolbar",t)}),o.body.on("track",".thread-view-control",function(e,t){i("detail/toolbar",t)}),o.main.find(".list-view-control .toolbar").on("mousedown","a[data-name], a[data-action]",function(e){i("list/toolbar",e.currentTarget)}),_.defer(function(){a.find(".context-dropdown").on("mousedown","a",function(e){t.trackEvent({app:"mail",target:"folder/context-menu",type:"click",action:$(e.currentTarget).attr("data-action")})})}),a.find(".bottom").on("mousedown","a[data-action]",function(e){$(e.currentTarget).attr("data-action")&&t.trackEvent({app:"mail",target:"folder/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})}),e.getWindow().nodes.outer.on("selection:drop",function(e,i){t.trackEvent({app:"mail",target:"folder",type:"click",action:"drop",detail:i.data.length?"single":"multiple"})}),e.on("folder:change folder-virtual:change",function(e,i){i=i||{},t.getFolderFlags(e).then(function(e){m.is("unifiedfolder",i)&&e.unshift("unfified"),e.unshift(m.is("external",i)?"external":"primary"),t.trackEvent({app:"mail",target:"folder",type:"click",action:"select",detail:e.join("/")})})}),e.listView.on({"selection:multiple selection:one":_.throttle(function(i){t.trackEvent({app:"mail",target:"list/"+e.props.get("layout"),type:"click",action:"select",detail:i.length>1?"multiple":"one"})},100,{trailing:!1})})}})},"unified-folder-support":function(){c.getUnifiedMailboxName().done(function(i){if(i){var o=function(e){var o=t.getAccountIDFromFolder(e.get("folder_id")),n={7:"INBOX",9:"Drafts",10:"Sent",11:"Spam",12:"Trash"};return c.get(o).then(function(t){var o,a,s,r;if(t){if(t.unified_inbox_enabled){o=m.pool.models[e.get("folder_id")];var l=n[o.get("standard_folder_type")];if(l)return s=i+"/"+l,r=s+"/"+o.get("id"),[{folder_id:s,id:e.get("folder_id")+"/"+e.get("id")},{folder_id:r,id:e.get("id")}]}}else{if((o=m.pool.models[e.get("folder_id")])&&o.is("unifiedfolder")){a=e.get("original_folder_id"),r=e.get("folder_id")+"/"+a;var c=e.get("original_id");return[{folder_id:a,id:c},{folder_id:r,id:c}]}if((o=m.pool.models[o.get("folder_id")])&&o.is("unifiedfolder"))return s=o.id,a=e.get("folder_id").replace(o.id+"/",""),[{folder_id:s,id:a+"/"+e.get("id")},{folder_id:a,id:e.get("id")}]}return $.Deferred().reject()})};t.pool.get("detail").on("change:flags",function(i,n,a){if(a=a||{},i&&!a.unifiedSync){var s=e.isUnseen(i.previous("flags")),r=e.isUnseen(i.get("flags"));s!==r&&o(i).done(function(e){_(e).each(function(e){var i=t.pool.get("detail").get(_.cid(e));if(i){var o={flags:r?-33&i.get("flags"):32|i.get("flags")};r||(o.unseen=!1),i.set(o,{unifiedSync:!0}),t.threads.touch(i.attributes),t.trigger("update:"+_.ecid(i.attributes),i.attributes)}else m.changeUnseenCounter(e.folder_id,r?1:-1);t.pool.resetFolder(e.folder_id)})})}}),t.pool.get("detail").on("remove",function(i){if(i){var n=e.isUnseen(i.get("flags"));o(i).done(function(e){_(e).each(function(e){n&&m.changeUnseenCounter(e.folder_id,-1),t.pool.resetFolder(e.folder_id)})})}})}})},sockets:function(e){ox.on("socket:mail:new",function(i){m.reload(i.folder),i.folder!==e.folder.get(i.folder)?_(t.pool.getByFolder(i.folder)).invoke("expire"):e.listView.reload()})},"vacation-notice":function(e){g.has("mailfilter_v2")&&require(["io.ox/mail/mailfilter/vacationnotice/indicator"],function(t){(new t).attachTo(e.listControl.$el)})},"autoforward-notice":function(e){g.has("mailfilter_v2")&&require(["io.ox/mail/mailfilter/autoforward/indicator"],function(t){(new t).attachTo(e.listControl.$el)})}}),P.setLauncher(function(){var e=ox.ui.createWindow({name:"io.ox/mail",title:"Inbox",chromeless:!0,find:g.has("search")});_.url.hash("mailto")&&ox.registry.call("mail-compose","open"),P.setWindow(e),P.settings=y,window.mailapp=P,o.addFolderSupport(P,null,"mail",P.options.folder).always(function(){P.mediate(),e.show()}).fail(function(e){var i=y.get("folder/inbox")&&e&&e.error?e.error+" "+V("Application may not work as expected until this problem is solved."):t.mailServerDownMessage;d.yell("error",i)})}),P.setResume(function(e){if(e&&e.folder&&e.folder!==this.folder.get()){var t=this.getWindow();return t.busy(),this.folder.set(e.folder).always(function(){t.idle()})}return $.when()}),{getApp:P.getInstance}});