define("io.ox/mail/detail/links",["io.ox/mail/api","io.ox/core/util","io.ox/core/extensions","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,n,a,r){"use strict";function s(e){var t=e.match(/^https?:\/\/([^\/#]+)/i);return null!==t&&0!==t.length&&("test"===t[1]||_(ox.serverConfig.hosts).indexOf(t[1])>-1)}function i(e){var t=$();return e.prefix&&(t=t.add(o(e.prefix))),t=t.add(e.replacement),e.suffix&&(t=t.add(o(e.suffix))),$(e.node).replaceWith(t),t}function o(e){if(_.isString(e)&&(e=$.txt(e)),3===e.nodeType){var t,n,a;for(t in k)if((n=k[t]).test(e)&&(a=n.process(e)))return i(a);return e}}var d,l,u,c,f=/^(io.ox\/office\/|io.ox\/(contacts|calendar|tasks)\/detail$)/;!function(){var e="all prefix link app params param name suffix".split(" "),t="all prefix link suffix".split(" "),n={"io.ox/contacts":"contacts","io.ox/calendar":"calendar","io.ox/tasks":"tasks","io.ox/infostore":"files","io.ox/files":"files",infostore:"files"},a={contacts:r("Contact"),calendar:r("Appointment"),tasks:r("Task"),files:r("File"),infostore:r("File"),"io.ox/office/text":r("Document"),"io.ox/office/spreadsheet":r("Spreadsheet")},i={contacts:r("Address Book"),calendar:r("Calendar"),tasks:r("Tasks"),files:r("Folder"),"io.ox/settings":r("Download")},o=/^([\s\S]*)(http[^#]+#!{0,2}&?app=([^&]+)((&(folder|id|item|perspective)=[^&\s]+)+))([\s\S]*)$/i,p=/^([\s\S]*)(http[^#]+#m=(contacts|calendar|tasks|infostore)((&(f|i)=[^&\s]+)+))([\s\S]*)$/i,m=/^([\s\S]*)(https?:\/\/.*?)([!?.,>()]\s[\s\S]*|\s[\s\S]*|[!?.,>()]$|$)/i;d=function(e){return o.test(e)||p.test(e)},l=function(e){return d(e)&&s(e)},u=function(a){var r=String(a).match(o.test(a)?o:p),s=_.object(e,r),i=_.deserialize(s.params,"&");s.app=n[s.app]||s.app,/^(files|infostore)$/.test(s.app)?s.className="deep-link-files":/^(contacts|calendar|tasks)$/.test(s.app)?s.className="deep-link-"+s.app:/^io.ox\/settings$/.test(s.app)&&"virtual/settings/personaldata"===i.folder?s.className="deep-link-gdpr":f.test(s.app)&&(s.className="deep-link-app");var d=String(a).match(m),l=_.object(t,d),u=i.folder&&i.id&&_.cid({folder:i.folder,id:i.id});return $.extend(s,{folder:i.f,id:i.i},{cid:u,folder:i.folder,id:i.id||i.item,perspective:i.perspective},l)},c=function(e){var t=u(e.nodeValue),n=("id"in t?a[t.app]:i[t.app])||r("Link"),o=$('<a href="#" target="_blank" class="deep-link" role="button">').attr("href",t.link).text(n);return t.className?(s(t.link)&&o.addClass(t.className).data(t),$(e).parent().attr("href")===t.link&&(e=$(e).parent().get(0)),{node:e,prefix:t.prefix,replacement:o,suffix:t.suffix}):null}}();var p=/^([\s\S]*?)(((http|https|ftp|ftps)\:\/\/|www\.)\S+)([\s\S]*)$/i,m=/^([\s\S]*?)(((http|https|ftp|ftps)\:\/\/|www\.)\S+)([\s\S]*)$/i,h=/^([\s\S]*?)([^"\s<,:;\(\)\[\]\u0100-\uFFFF]+@([a-z0-9äöüß\-]+\.)+[a-z]{2,})([\s\S]*)$/i,x=/^([\s\S]*?)([^"\s<,:;\(\)\[\]\u0100-\uFFFF]+@([a-z0-9äöüß\-]+\.)+[a-z]{2,})([\s\S]*)$/i,g=/^([\s\S]*?)(?:&quot;([^&]+)&quot;|"([^"]+)"|'([^']+)')(?:\s|<br>)+(?:<|&#60;)([^@]+@[^&].*?)(?:>|&#62;)([\s\S]*)$/,k={deeplink:{test:function(e){return-1!==e.nodeValue.indexOf("http")&&d(e.nodeValue)},process:c},"mail-address-complex":{test:function(e){return-1!==e.nodeValue.indexOf("@")&&(g.test(e.nodeValue)&&0===$(e).closest("a").length)},process:function(e){var t=e.nodeValue.match(g);if(null===t||0===t.length)return e;var n=t[1],a=t[2]||t[3]||t[4],r=t[5],s=t[6];return{node:e,prefix:n,replacement:$('<a href="#" class="mailto-link" target="_blank">').attr("href","mailto:"+r).data({address:r,name:a}).text(a),suffix:s}}},"mail-address":{test:function(e){return-1!==e.nodeValue.indexOf("@")&&(h.test(e.nodeValue)&&0===$(e).closest("a").length)},process:function(e){var t=e.nodeValue.match(x);if(null===t||0===t.length)return e;var n=t[1],a=t[2],r=t[4];return!/(http:|https:)$/i.test(n)&&!/^www\./i.test(a)&&{node:e,prefix:n,replacement:$('<a href="#" class="mailto-link" target="_blank">').attr("href","mailto:"+a).data({address:a}).text(a),suffix:r}}},url:{test:function(e){return!!/(http|www\.)/.test(e.nodeValue)&&(p.test(e.nodeValue)&&0===$(e).closest("a").length)},process:function(e){var n=e.nodeValue.match(m);if(null===n||0===n.length)return e;var a=n[1],r=n[2],s=n[5],i=t.fixUrlSuffix(r,s),o=i.url;return/^http/i.test(o)||(o="http://"+o),{node:e,prefix:a,replacement:$('<a href="#" target="_blank" rel="noopener">').attr("href",o).text(i.url),suffix:i.suffix}}},"long-character-sequences":{test:function(e){var t=e.nodeValue;return t.length>=30&&/[\S\u00A0]{30}/.test(t)&&0===$(e).closest("a").length},process:function(e){return{node:e,replacement:$.parseHTML(t.breakableHTML(e.nodeValue))}}}};return a.get("features/recognizeDates",!1)&&function(){function e(){return moment(f)}function t(e,t){var n,a=s(null===e?t:e);return a.isValid()?(null!==e&&(n=r(t))&&n.isValid()&&a.hour(n.hour()).minute(n.minute()),'<a href="#" class="calendar-link" data-start-time="'+a+'" role="button">'+t+"</a>"):t}function n(e){var t=e.match(o.day);return t?t[0]:null}function a(e){return _.escape(e).replace(/(\w\w[.?!]\s|$)/g,"$1").replace(/\x1D$/,"").split(/\x1D/)}function r(e){for(var t in g){var n=g[t][0].exec(e);if(n)return g[t][1](e,n)}return 0}function s(e){for(var t in x){var n=x[t][0].exec(e);if(n)return x[t][1](e,n)}return e=e.toLowerCase(),w[e]&&(e=w[e]),v[e]?v[e]():(console.error('Unsupported date "'+e+'"'),moment())}var i,o={},d={},l=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],u=["sonntag","montag","dienstag","mittwoch","donnerstag","freitag","samstag"],c=moment().year();(i={names:"(((this|next|last|diesen|nächsten|letzten)\\s)?("+l.join("|")+"|"+u.join("|")+"))",relative:"(yesterday|today|tomorrow|day\\safter\\stomorrow|gestern|heute|morgen|übermorgen)",date:"(\\d{1,2}\\.\\d{1,2}\\.\\d{2,4}|\\d{1,2}\\.\\d{1,2}\\.|(cw|kw|week)\\s?\\d{1,2})",time:"(\\d{1,2}\\:\\d\\d)(\\s?(h|a|am|p|pm))?",range:"((from|von)s)?(\\d{1,2}\\:\\d\\d)s?(-|to|bis)s?(\\d{1,2}\\:\\d\\d)"}).day="("+i.names+"|"+i.relative+"|"+i.date+")",["day","name","date","time"].forEach(function(e){o[e]=new RegExp(i[e],"i"),d[e]=new RegExp(i[e],"ig")});var f=moment().hour(12).minute(0),p=" 12:00",m="DD.MM.YYYY HH:mm",h="MM/DD/YYYY HH:mm",x=[[/\d{1,2}\.\d{1,2}\.\d{2,4}/,function(e){return moment(e+p,m)}],[/\d{1,2}\.\d{1,2}\./,function(e){return moment(e+c+p,m)}],[/\d{1,2}\/\d{1,2}\/\d{2,4}/,function(e){return moment(e+p,h)}],[/\d{1,2}\/\d{1,2}/,function(e){return moment(e+c+p,h)}],[/(cw|kw|week)\s?(\d{1,2})/i,function(t,n){return e().week(n[2])}]],g=[[/(\d{1,2}):(\d\d)h?/,function(e,t){return moment(0).hour(t[1]).minute(t[2])}],[/(\d{1,2}):(\d\d)\s?(am|pm|a|p)/,function(t,n){return moment(0).hour(n[1]).minute(n[2]).add("p"===e[3][0]?12:0,"h")}]],v={yesterday:function(){return e().subtract(1,"d")},today:function(){return e()},tomorrow:function(){return e().add(1,"d")},"day after tomorrow":function(){return e().add(2,"d")}},w={gestern:"yesterday",heute:"today",morgen:"tomorrow","übermorgen":"day after tomorrow"};_.range(0,7).forEach(function(t){var n=l[t],a=u[t];v["this "+n]=function(){return e().day(t)},v["last "+n]=function(){return e().day(t-7)},v["next "+n]=v[n]=function(){return e().day(t+7)},w["diesen "+a]="this "+n,w["letzten "+a]="last "+n,w["nächsten "+a]=w[a]="next "+n}),$(document).on("click",".calendar-link",function(e){e.preventDefault();var t=$(this).data("startTime"),n=$(this).data("endTime")||t+36e5;ox.load(["io.ox/calendar/edit/main"]).done(function(e){e.getApp().launch().done(function(){this.create({start_date:t,end_date:n})})})}),k.dates={test:function(e){var t=e.nodeValue;return(o.day.test(t)||o.time.test(t))&&(!e.parentNode||"A"!==e.parentNode.tagName)},process:function(e){var r,s=a(e.nodeValue),i=_(s).reduce(function(e,a){return r=n(a)||r||"today",e+a.replace(d.day,t.bind(null,null)).replace(d.range,t.bind(null,r)).replace(d.time,t.bind(null,r))},"");return{node:e,replacement:$.parseHTML(i)}}}}(),n.point("io.ox/mail/detail/content").extend({id:"links",index:100,process:function(e){e.isLarge||($(this).contents().each(function(){o(this)}),$(this).find("*:not(style)").contents().each(function(){o(this)}))}}),{handlers:k,isValidHost:s,isDeepLink:d,isInternalDeepLink:l,parseDeepLink:u,processDeepLink:c,processTextNode:o}});