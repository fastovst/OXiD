define("io.ox/mail/detail/view",["io.ox/backbone/views/disposable","io.ox/backbone/views/toolbar","io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/api/collection-pool","io.ox/mail/detail/content","io.ox/core/a11y","io.ox/core/capabilities","gettext!io.ox/mail","less!io.ox/mail/detail/content","less!io.ox/mail/detail/style","less!io.ox/mail/style","io.ox/mail/actions"],function(e,t,i,a,n,o,d,s,l,r,h,c){"use strict";var m=0;a.point("io.ox/mail/detail").extend({id:"unread-class",index:m+=100,draw:i.unreadClass}),a.point("io.ox/mail/detail").extend({id:"flagged-class",index:m+=100,draw:i.flaggedClass}),a.point("io.ox/mail/detail").extend({id:"subject",index:m+=100,draw:function(e){var t=o.getSubject(e.data);this.append($('<h1 class="subject">').text(t))}}),a.point("io.ox/mail/detail").extend({id:"header",index:m+=100,draw:function(e){var t=$('<header class="detail-view-header">');a.point("io.ox/mail/detail/header").invoke("draw",t,e),this.append(t)}});var p=0;a.point("io.ox/mail/detail/header").extend({id:"threadcontrol",index:p+=100,draw:function(e){var t=e.data,i=o.getSubject(t),a=o.hasFrom(t)?h("Email from %1$s: %2$s",o.getDisplayName(t.from[0]),i):i;this.append($('<h2 class="toggle-mail-body">').append($('<button type="button" class="toggle-mail-body-btn">').attr("aria-expanded",e.view.$el.hasClass("expanded")).append($('<span class="sr-only">').text(a))))}}),a.point("io.ox/mail/detail/header").extend({id:"picture",index:p+=100,draw:i.senderPicture}),a.point("io.ox/mail/detail/header").extend({id:"drag-support",index:p+=100,draw:function(e){this.find(".contact-picture").attr({"data-drag-data":_.cid(e.data),"data-drag-message":o.getSubject(e.data)})}}),a.point("io.ox/mail/detail/header").extend({id:"unread-toggle",index:p+=100,draw:i.unreadToggle},{id:"paper-clip",index:p+=100,draw:i.paperClip},{id:"rows",index:p+=100,draw:function(e){for(var t,i=1;i<=5;i++)t=$('<div class="detail-view-row row-'+i+' clearfix">'),a.point("io.ox/mail/detail/header/row"+i).invoke("draw",t,e),this.append(t)}}),a.point("io.ox/mail/detail/header/row1").extend({id:"from",index:p+=100,draw:i.fromDetail},{id:"priority",index:p+=100,draw:i.priority},{id:"security",index:p+=100,draw:i.security},{id:"date",index:p+=100,draw:i.fulldate},{id:"flag-toggle",index:p+=100,draw:i.flagToggle},{id:"color-picker",index:p+=100,draw:i.flagPicker}),a.point("io.ox/mail/detail/header/row2").extend({id:"sender",index:100,draw:function(e){a.point("io.ox/mail/detail/header/sender").invoke("draw",this,e)}}),a.point("io.ox/mail/detail/header/sender").extend({id:"default",index:100,draw:function(e){var t=e.data,i=t.from||[];if(o.authenticity("via",t)&&e.data.authenticity&&e.data.authenticity.domain_mismatch&&e.data.authenticity.from_domain&&this.append($('<div class="sender">').append($('<span class="io-ox-label">').append($.txt(h("Via")),$.txt("  ")),$('<span class="address">').text(e.data.authenticity.from_domain))),"headers"in t&&"Sender"in t.headers){var a=o.parseRecipients(t.headers.Sender);i[0]&&i[0][1]===a[0][1]||this.append($('<div class="sender">').append($('<span class="io-ox-label">').append($.txt(h("Via")),$.txt("  ")),$('<span class="address">').text((a[0][0]||"")+" <"+a[0][1]+">")))}}}),a.point("io.ox/mail/detail/header/row3").extend({id:"recipients",index:100,draw:function(e){a.point("io.ox/mail/detail/header/recipients").invoke("draw",this,e)}}),a.point("io.ox/mail/detail/header/recipients").extend({id:"default",index:100,draw:i.recipients}),a.point("io.ox/mail/detail/header/row4").extend({id:"different-subject",index:100,draw:function(e){var t,i,a,d=e.data;1!==d.threadSize&&(t=n.threads.subject(d),i=o.getSubject(t,!1),a=o.getSubject(d,!1),""!==t&&i!==a&&this.append($('<span class="io-ox-label">').text(h("Subject")+"  "),$('<span class="different-subject">').text(a)))}}),a.point("io.ox/mail/detail/header/row5").extend({id:"inline-links",index:100,draw:function(e){if(e.view.$el.hasClass("expanded")&&!e.view.placeholder){var i=new t({el:this[0],point:"io.ox/mail/links/inline",inline:!0});i.$el.attr("data-toolbar","io.ox/mail/links/inline"),i.setSelection([_.cid(e.data)],{data:e.data})}}}),a.point("io.ox/mail/detail").extend({id:"notifications",index:m+=100,draw:function(e){var t=$('<section class="notifications">');a.point("io.ox/mail/detail/notifications").invoke("draw",t,e),this.append(t)}}),a.point("io.ox/mail/detail").extend({id:"warnings",index:m+=100,draw:function(e){var t=$('<section class="warnings">');a.point("io.ox/mail/detail/warnings").invoke("draw",t,e),this.append(t)}}),a.point("io.ox/mail/detail").extend({id:"preview-text",index:m+=100,draw:function(e){e.view.supportsTextPreview&&e.data.text_preview&&this.append($('<section class="text-preview">').text(e.data.text_preview+(e.data.text_preview.length>=100?"...":"")))}}),a.point("io.ox/mail/detail/warnings").extend({id:"plaintextfallback",index:100,draw:i.plainTextFallback});var g=0;a.point("io.ox/mail/detail/notifications").extend({id:"phishing",index:g+=100,draw:i.phishing}),a.point("io.ox/mail/detail/notifications").extend({id:"authenticity",index:g+=100,draw:i.authenticity}),a.point("io.ox/mail/detail/notifications").extend({id:"disposition-notification",index:g+=100,draw:i.dispositionNotification}),a.point("io.ox/mail/detail/notifications").extend({id:"external-images",index:g+=100,draw:i.externalImages}),a.point("io.ox/mail/detail/notifications").extend({id:"disabled-links",index:g+=100,draw:i.disabledLinks}),a.point("io.ox/mail/detail").extend({id:"error",index:m+=100,draw:function(){this.append($('<section class="error">').hide())}}),a.point("io.ox/mail/detail").extend({id:"body",index:m+=100,draw:function(){this.append($('<section class="attachments">'),$('<section class="body user-select-text focusable" tabindex="-1">'))}}),a.point("io.ox/mail/detail/body").extend({id:"iframe",index:100,draw:function(e){var t=$('<iframe src="" class="mail-detail-frame">').attr("title",h("Email content")).on("load",function(){t.contents().on("click",'a[rel="noopener"], area[target="_blank"]',function(e){_.device("noopener")||($(this).attr("class")||"").indexOf("deep-link")>-1||(e.preventDefault(),blankshield.open($(this).attr("href")))})});a.point("io.ox/mail/detail/body/iframe").invoke("draw",t,e),this.idle().append(t)}}),a.point("io.ox/mail/detail/body").extend({id:"content-flags",index:200,draw:function(e){if(e.content){var t=$(e.content);this.closest("article").toggleClass("content-links",!!t.find("a").length)}}}),a.point("io.ox/mail/detail/body/iframe").extend({id:"content",index:100,draw:function(e){function t(){d=0}function i(e){this.document.body&&e.data.iframe.parent().addBack().height(this.document.body.scrollHeight)}function a(e){d<=0&&(d=2,e.data.iframe.height(""),i.call(this,e),this.requestAnimationFrame(function(){d--}))}var n=s.get(e.data,{},e.flow),o=$(n.content),d=0,l=function(e){e.target=this[0],this.trigger(e)}.bind(this);e.content=n.content,n.isText&&(o=$("<body>").append(o)),this.on("load",function(){_.defer(function(){var e=$(this.contentDocument).find("html");e.attr("lang")||e.attr("lang",$("html").attr("lang")),e.on("keydown click",l),_.device("ios && smartphone")&&e.addClass("ios smartphone"),$(this.contentDocument).find("head").append("<style>"+c+"</style>"),$(this.contentDocument).find("body").replaceWith(o),o.find("table").each(function(){"100%"!==this.getAttribute("height")&&"100%"!==(this.style||{}).height||(this.setAttribute("height",""),$(this).css("height","initial"))}),$(this.contentWindow).on("complete toggle-blockquote",{iframe:$(this)},i).on("resize",{iframe:$(this)},a).on("dragover drop",!1).trigger("resize")}.bind(this))}),o.find("img").on("load error",function(){$(this).off().trigger("complete")}),$(window).on("resize",t),this.on("dispose",function(){$(window).off("resize",t),$(this.contentWindow).off()})}}),a.point("io.ox/mail/detail/body/iframe").extend({id:"events",index:200,draw:function(){this.on("load",function(){_.defer(function(){$(this.contentDocument).find("html").on("click",".mailto-link, .deep-link-tasks, .deep-link-contacts, .deep-link-calendar, .deep-link-files, .deep-link-gdpr, .deep-link-app",function(e){ox.trigger("click:deep-link-mail",e,this)})}.bind(this))})}}),a.point("io.ox/mail/detail/body/iframe").extend({id:"max-size",index:1200,after:"content",draw:function(e){this.on("load",function(){_.defer(function(){if(_(e.data.attachments).some(function(e){return e.truncated})){var t="api/mail?"+$.param({action:"get",view:"document",forceImages:!0,folder:e.data.folder_id,id:e.data.id,session:ox.session});$(this.contentDocument).find("body .mail-detail-content").append($('<div class="max-size-warning">').append($.txt(h("This message has been truncated due to size limitations.")),$.txt(" "),$('<a role="button" target="_blank">').attr("href",t).text(h(1!==e.model.get("modified")?"Show entire message":"Show entire message including all external images"))))}}.bind(this))})}}),a.point("io.ox/mail/detail/attachments").extend({id:"attachment-list",index:200,draw:function(e){0!==e.attachments.length&&i.attachmentList.call(this,e)}});var x=d.create("mail");return{View:e.extend({className:"list-item mail-item mail-detail f6-target focusable",events:{keydown:"onToggle","click .detail-view-header":"onToggle","click .text-preview":"onToggle","click .toggle-mail-body-btn":"onToggle",'click a[data-action="retry"]':"onRetry"},onChangeFlags:function(){this.$el.toggleClass("unread",o.isUnseen(this.model.get("flags"))),this.$el.toggleClass("flagged",o.isFlagged(this.model.get("flags")))},onChangeAttachments:function(){if(!this.model.changed.attachments||!_.isEqual(this.model.previous("attachments"),this.model.get("attachments"))){var e=this.model.toJSON(),t=a.Baton({view:this,model:this.model,data:e,attachments:o.getAttachments(e)}),i=this.$el.find("section.attachments").empty();a.point("io.ox/mail/detail/attachments").invoke("draw",i,t),ox.trigger("mail:detail:attachments:render",this),this.model.previous("attachments")&&this.model.get("attachments")&&this.model.previous("attachments")[0].content!==this.model.get("attachments")[0].content&&this.onChangeContent()}},getEmptyBodyNode:function(){return this.$el.find("section.body").empty()},onChangeSubject:function(){var e=this.$el.find("h1.subject");return e.text(o.getSubject(this.model.get("subject"))),e},onChangeContent:function(){var e=this.model.toJSON(),t=a.Baton({view:this,model:this.model,data:e,attachments:o.getAttachments(e)}),i=this.$el.find("section.body"),n=this.getEmptyBodyNode(),d=this;t.disable(this.options.disable),i.css("min-height",this.model.get("visualHeight")||null),_.delay(function(){a.point("io.ox/mail/detail/body").invoke("draw",n,t),ox.trigger("mail:detail:body:render",d),d.trigger("mail:detail:body:render",d),i=n=d=null},20)},onChangeRecipients:_.debounce(function(){var e=this.model.toJSON(),t=a.Baton({data:e,model:this.model,view:this}),i=this.$(".recipients").empty();a.point("io.ox/mail/detail/header/recipients").invoke("draw",i,t)},10),onToggle:function(e){if(("keydown"!==e.type||13===e.which||32===e.which)&&!$(e.target).closest("a").length){if(!$(e.currentTarget).hasClass("toggle-mail-body-btn")){var t=l.getTabbable(this.$el);if(t.index(e.target)>=0)return;if(t.find($(e.target)).length)return}$(e.target).hasClass("dropdown-menu")||$(e.target).hasClass("overlay")||0===this.$el.siblings().length&&this.$el.hasClass("expanded")||(this.$el.find(".collapsed-blockquote").hide(),this.$el.find(".blockquote-toggle").show(),this.toggle())}},onRetry:function(e){e.preventDefault(),this.$("section.error").hide(),this.$("section.body").show(),this.toggle(!0)},onUnseen:function(){var e=this.model.toJSON();this.model.cid!==n.setToUnread&&o.isToplevel(e)&&n.markRead(e)},onLoad:function(e){if(null!==this.model){e&&this.model.set(e);var t=this.model.get("unseen")||o.isUnseen(this.model.get("flags"));this.$el.find("section.body").removeClass("loading"),this.trigger("load:done"),this.$el.find(".detail-view-row.row-5").hasClass("inline-toolbar-container")||(this.$el.empty(),this.render()),this.onChangeSubject(),this.onChangeAttachments(),this.onChangeContent(),t?this.onUnseen():n.trigger("update:set-seen",[{id:this.model.get("id"),folder_id:this.model.get("folder_id")}])}},onLoadFail:function(e){this.$el&&(this.trigger("load:fail"),this.trigger("load:done"),this.$el.attr("data-loaded",!1),this.$("section.error").empty().show().append($('<i class="fa fa-exclamation-triangle" aria-hidden="true">'),$("<h4>").text(h("Error: Failed to load message content")),$("<p>").text(e.error),$('<a href="#" role="button" data-action="retry">').text(h("Retry"))))},toggle:function(e){this.placeholder=!1;var t=this.$el,i=t.find(".toggle-mail-body-btn");t.toggleClass("expanded",e);var a=t.hasClass("expanded");if(i.attr("aria-expanded",a),this.$el.trigger("toggle"),"false"===t.attr("data-loaded")&&a)if(t.attr("data-loaded",!0),t.find("section.body").addClass("loading"),this.trigger("load"),this.loaded)this.onLoad();else{var o=_.cid(this.model.cid);1===_(o).size()&&void 0!==o.id&&this.model.has("parent")?n.getNestedMail(this.model.attributes).pipe(this.onLoad.bind(this),this.onLoadFail.bind(this)):n.get(_.extend({},o,{unseen:this.model.cid===n.setToUnread})).pipe(this.onLoad.bind(this),this.onLoadFail.bind(this))}else a&&this.$el.find(".mail-detail-frame").contents().find(".mail-detail-content").trigger("resize");return this},expand:function(){return this.toggle(!0)},initialize:function(e){this.options=e||{},this.model=x.getDetailModel(e.data),this.loaded=e.loaded||!1,this.listenTo(this.model,"change:flags",this.onChangeFlags),this.listenTo(this.model,"change:attachments",this.onChangeAttachments),this.listenTo(this.model,"change:to change:cc change:bcc",this.onChangeRecipients),this.placeholder=!0,this.supportsTextPreview=e.supportsTextPreview,this.on({load:function(){this.$("section.body").empty().busy()},"load:done":function(){this.$("section.body").idle()},"load:fail":function(){this.$("section.body").hide()}})},redraw:function(){this.$el.empty(),this.render(),this.$el.hasClass("expanded")&&(this.onChangeAttachments(),this.onChangeContent())},render:function(){var e=this.model.toJSON(),t=a.Baton({data:e,model:this.model,view:this});return t.disable(this.options.disable),this.$el.attr({"data-cid":this.model.cid,"data-loaded":"false"}),this.$el.data({view:this,model:this.model}),this.placeholder||a.point("io.ox/mail/detail").invoke("draw",this.$el,t),this.$el.toggleClass("placeholder",this.placeholder),ox.trigger("mail:detail:render",this),this}})}});