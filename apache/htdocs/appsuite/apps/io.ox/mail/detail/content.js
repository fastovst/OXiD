define("io.ox/mail/detail/content",["io.ox/mail/api","io.ox/mail/util","io.ox/core/util","io.ox/core/extensions","io.ox/core/capabilities","io.ox/mail/detail/links","io.ox/mail/sanitizer","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,n,o,a,s,r,l){"use strict";function c(e){return/target="[^"]*"/.test(e)?e.replace(/(target="[^"]*")/i,'target="_blank"'):e.replace(">",' target="_blank" rel="noopener">')}function d(e,t){return/^[^:.#]+:/.test(t)?e:/^#/.test(t)?e:e.replace(t,"http://"+t)}function p(e,t,i){_(e.querySelectorAll(t)).each(i)}function u(e,t){for(;e;)if((e=e.parentNode)&&e.matches&&e.matches(t))return!0;return!1}function m(e,t){var i=3===e.nodeType&&String(e.nodeValue).trim()||"",n=i?i+" ":"";return _(e.childNodes).each(function(e){"STYLE"!==e.tagName&&(t&&"BLOCKQUOTE"===e.tagName||(n+=m(e,t)))}),n}function h(e){13!==e.which&&23!==e.which&&"click"!==e.type||(e.preventDefault(),e.stopPropagation(),$(this).hide().prev().show(),_.delay(function(){$(e.delegateTarget).trigger("resize").trigger("toggle-blockquote")},20),$(this).remove())}var g=/^text\/html$/i,f={empty:function(e){""===e.source&&(e.stopPropagation(),e.source=e.isHTML?'<div class="no-content">'+l("This mail has no content")+"</div>":l("This mail has no content"))},images:function(e){e.source=t.replaceImagePrefix(e.source)},plainTextLinks:function(e){e.isLarge||(e.source=e.source.replace(/(<a href="https?:\/\/[^"]+" target="_blank">https?:\/\/[^<]+<\/a>) &lt;<a href="https?:\/\/[^"]+" target="_blank">https?:\/\/[^<]+<\/a>&gt;/g,"$1"))},removeWBR:function(e){e.isLarge||(e.source=e.source.replace(/<wbr>/g,""))},linkTarget:function(e){e.source=e.source.replace(/<a[^>]*href=(?:"|')((?!https?:\/\/)[^'">]+)(?:"|')[^>]*>/g,d).replace(/<a[^>]*href\s*=\s*(?:"|')(https?:\/\/[^>]+)(?:"|')[^>]*>/g,c)},whitespace:function(e){e.isLarge||(e.source=e.source.replace(/^(<div[^>]+>)(\s|&nbsp;|\0x20|<br\/?>|<p[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/p>|<div[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/div>)+/g,"$1").replace(/\s*<\/html>\s*$/g,"").replace(/(\s|&nbsp;|\0x20|<br\/?>|<p[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/p>|<div[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/div>)+<\/div>$/g,""))},linkDisable:function(e){return e.replace(/(<a[^>]*)>/g,'$1 disabled="disabled" aria-disabled="true">')},linkRemoveRef:function(e){return e.replace(/(<a[^>]+?href[\s]*=[\s]*["']).*?(["'][^>]*)>/g,"$1#$2>")},linkRemoveStyle:function(e){return e.replace(/(<a[^>]+?style[\s]*=[\s]*["'])(.*?)(["'][^>]*>)/g,function(e,t,i,n){return t+i.replace(/(^|;|\s)color:[^;]+?($|;)/g,"").replace(/text-decoration:[^;]+?($|;)/g,"")+n})},tableHeight:function(e){(_.browser.safari||e.isHTML)&&(e.source=e.source.replace(/(<table[^>]+?style[\s]*=[\s]*["'])(.*?)(["'][^>]*>)/g,function(e,t,i,n){return t+i.replace(/[^-]height:\s100%\s!important/,"height: auto")+n}))},anchorLinks:function(e){e.isHTML&&this.addEventListener("click",function(e){if($(e.target).is('a[href^="#"]')){e.preventDefault();var t=$.escape($(e.target).attr("href").substr(1)),i=$(this).find("#"+t+', [name="'+$.escape(t)+'"]');i.length&&i[0].scrollIntoView()}},!1)},disableLinks:function(e){(t.isMalicious(e.data)||t.authenticity("block",e.data))&&(t.isWhiteListed(e.data)||$(this).addClass("disable-links").on("click",function(){return!1}))},pseudoBlockquotes:function(e){e.isHTML&&p(this,'div[style*="none none none solid"][style*="1.5pt"]',function(e){$(e).replaceWith($('<blockquote type="cite">').append($(e).contents()))})},nested:function(t){if(t.isHTML){var i=t.data;!("folder_id"in i)&&"filename"in i&&p(this,'img[src^="cid:"]',function(n){var o,a="<"+String(n.getAttribute("src")||"").substr(4)+">",s=_.chain(t.data.attachments).filter(function(e){return e.cid===a}).first().value();s&&(o=e.getUrl(_.extend(s,{mail:i.parent}),"view"),n.setAttribute("src",o))})}},fixedWidth:function(e){e.isText&&r.get("useFixedWidthFont",!1)&&$(this).addClass("fixed-width-font")},colorQuotes:function(){r.get("isColorQuoted",!0)&&$(this).addClass("colorQuoted")},cleanBlockquotes:function(){p(this,"blockquote",function(e){var t=/border:\s*(none|0)/i.test(e.getAttribute("style"));e.removeAttribute("style"),e.removeAttribute("type"),t&&(e.style.border="0")})},checkLinks:function(e){var t=e.data.headers["X-Open-Xchange-Share-URL"];p(this,"a",function(e){var i,n,o=$(e),s=o.attr("href")||"";if(a.isInternalDeepLink(s))return i=a.parseDeepLink(s),/^(\d+)\.\1\/\d+$/.test(i.id)&&(i.id=i.id.replace(/^\d+\./,"")),/^\d+\./.test(i.id)&&(i.id=i.id.replace(/\./,"/")),o.addClass(i.className).data(i),void(t&&o.attr("href")===t&&o.addClass("deep-link-app"));o.removeClass("deep-link-files","deep-link-contacts","deep-link-calendar","deep-link-tasks","deep-link-gdpr","deep-link-app"),s.search(/^\s*mailto:/i)>-1?(o.addClass("mailto-link").attr("target","_blank"),(n=o.text()).search(/^mailto:/)>-1&&(n=(n=n.substring(7)).split(/\?/,2)[0],o.text(n))):o.attr("href")?(o.attr({rel:"noopener",target:"_blank"}),o.attr("href",o.attr("href").replace(/"/g,"%22"))):s||o.removeAttr("href")})},autoCollapse:function(e){!1!==e.options.autoCollapseBlockquotes&&!0===r.get("features/autoCollapseBlockquotes",!0)&&(p(this,"blockquote",function(e){if(!(u(e,"blockquote")||m(e).length<500)){var t=_.uniqueId("collapsed-blockquote-"),i=$('<button type="button" class="bqt">').attr("title",l("Show quoted text")).append($('<span aria-hidden="true">').text("..."));_.browser.Chrome||i.attr({"aria-controls":t,"aria-expanded":!1});var n=[i],o=m(e,!0).replace(/<\s/g,"<").replace(/\s>/g,">").replace(/("'\s?|\s?'")/g,"").replace(/[-_]{3,}/g,"");o.length>500?n.push($.txt(o.substr(0,210).replace(/\s\S{1,10}$/," ")+"…"),$("<br>"),$.txt("…"+o.substr(-210).replace(/^\S{1,10}\s/," "))):n.push($.txt(o)),$(e).addClass("collapsed-blockquote").hide().attr("id",t).after($('<div class="blockquote-toggle">').append(n))}}),$(this).on("click keydown",".blockquote-toggle",h))},checkSimple:function(){var e=$(this);0===e.find("table").length&&e.addClass("simple-mail")},formSubmit:function(){$(this).on("submit","form",function(e){e.preventDefault();var t=_.uniqueId("blank");blankshield.open("javascript:0",t),this.target=t,setTimeout(this.submit.bind(this))})}};n.point("io.ox/mail/detail/source").extend({id:"empty",index:100,process:f.empty}),n.point("io.ox/mail/detail/source").extend({id:"images",index:200,process:f.images}),n.point("io.ox/mail/detail/source").extend({id:"plain-text-links",index:300,process:f.plainTextLinks}),n.point("io.ox/mail/detail/source").extend({id:"remove-wbr",index:400,process:f.removeWBR}),n.point("io.ox/mail/detail/source").extend({id:"link-target",index:500,process:f.linkTarget}),n.point("io.ox/mail/detail/source").extend({id:"table-height",index:550,process:f.tableHeight}),n.point("io.ox/mail/detail/source").extend({id:"white-space",index:600,process:f.whitespace}),n.point("io.ox/mail/detail/source").extend({id:"disable-links",index:700,enabled:r.get("maliciousCheck"),process:function(e){(t.isMalicious(e.data)||t.authenticity("block",e.data))&&(t.isWhiteListed(e.data)||(e.source=e.source.replace(/.*/g,f.linkDisable).replace(/.*/g,f.linkRemoveRef).replace(/.*/g,f.linkRemoveStyle)))}}),n.point("io.ox/mail/detail/content-general").extend({id:"anchor-links",index:100,process:f.anchorLinks}),n.point("io.ox/mail/detail/content-general").extend({id:"disable-links",index:200,process:f.disableLinks}),n.point("io.ox/mail/detail/content").extend({id:"pseudo-blockquotes",index:100,process:f.pseudoBlockquotes}),n.point("io.ox/mail/detail/content").extend({id:"nested",index:500,process:f.nested}),n.point("io.ox/mail/detail/content").extend({id:"fixed-width",index:600,process:f.fixedWidth}),n.point("io.ox/mail/detail/content").extend({id:"color-quotes",index:700,process:f.colorQuotes}),n.point("io.ox/mail/detail/content").extend({id:"clean-blockquotes",index:800,process:f.cleanBlockquotes}),n.point("io.ox/mail/detail/content").extend({id:"check-links",index:900,process:f.checkLinks}),n.point("io.ox/mail/detail/content").extend({id:"auto-collapse",index:1e3,process:f.autoCollapse}),n.point("io.ox/mail/detail/content").extend({id:"check-simple",index:1100,process:f.checkSimple}),n.point("io.ox/mail/detail/content").extend({id:"form-submit",index:1200,process:f.formSubmit}),n.point("io.ox/mail/detail/content").extend({id:"image-load",index:1200,process:function(){var e=this;$(e).find('img[src!=""]').each(function(){$(this).on("load error",function(){$(e).trigger("imageload")})})}}),n.point("io.ox/mail/detail/beautify").extend({id:"no-ampersand",process:function(e){e.data=e.data.replace(/&/g,"&amp;")}},{id:"trim",process:function(e){e.data=e.data.trim()}},{id:"carriage-return",process:function(e){e.data=e.data.replace(/\r/g,"")}},{id:"multiple-empty-lines",process:function(e){r.get("transform/multipleEmptyLines",!0)&&(e.data=e.data.replace(/\n{4,}/g,"\n\n\n"))}},{id:"text-to-html",process:function(e){e.data=this.text2html(e.data,{blockquotes:!0,images:!0,links:!0})}},{id:"br",process:function(e){e.data=e.data.replace(/^\s*(<br\s*\/?>\s*)+/g,"")}},{id:"white-space",process:function(e){e.data=e.data.replace(/((>) |( ) )/g,"$1&nbsp;")}});var x={extensions:f,get:function(e,t,i){if(!e||!e.attachments)return{content:$(),isLarge:!1,type:"text/plain"};var o,a=new n.Baton(_({data:e,options:t||{},source:"",type:"text/plain",flow:i}).omit(function(e){return void 0===e})),l=/^text\/(plain|html)$/i,c=/^image\//i;try{_(e.attachments).find(function(e){return!("attachment"===e.disp||"none"===e.disp||!l.test(e.content_type))&&(a.type=e.content_type.toLowerCase(),!0)}),_(e.attachments).each(function(t){"inline"===t.disp&&(t.content_type===a.type?a.source+=t.content:"text/plain"===a.type&&c.test(t.content_type)&&r.get("allowHtmlMessages",!0)&&(a.source+="\n!(api/image/mail/picture?"+$.param({folder:e.folder_id,id:e.id,uid:t.filename,scaleType:"contain",width:1024})+")\n"))}),a.source=a.source.trim(),a.isHTML=g.test(a.type),a.isText=!a.isHTML,a.isLarge=a.source.length>1024*(_.device("chrome >= 30")?64:32),n.point("io.ox/mail/detail/source").invoke("process",$(),a),a.isHTML?(a.source=s.sanitize({content_type:"text/html",content:a.source}).content,(o=document.createElement("HTML")).innerHTML=a.source,(o=o.getElementsByTagName("body")[0]).className=o.className+" mail-detail-content noI18n",p(o,"script, base, meta",function(e){e.parentNode.removeChild(e)})):((o=document.createElement("DIV")).className="mail-detail-content plain-text noI18n",a.source=x.beautifyPlainText(a.source),o.innerHTML=a.source),n.point("io.ox/mail/detail/content-general").invoke("process",o,a),a.isLarge||n.point("io.ox/mail/detail/content").invoke("process",o,a)}catch(t){console.error("mail.getContent",t.message,t,e)}return{content:o,isLarge:a.isLarge,type:a.type,isText:a.isText}},beautifyPlainText:function(e){var t=n.Baton({data:e});return n.point("io.ox/mail/detail/beautify").invoke("process",this,t),s.simpleSanitize(t.data)},transformForHTMLEditor:function(e){return this.text2html(e,{blockquotes:!0,links:!0})},text2html:function(){function e(e,t){var i=e.exec(t);return i&&i[0]}function t(d,p){var u,m="";for(p=p||c;d;)if(p.blockquotes&&(u=e(n,d)))d=d.substr(u.length),m+='<blockquote type="cite">'+(u=t(u=u.replace(/^(>(>)|> |>$)/gm,"$2"),p).replace(/(<br>)?(<\/?blockquote[^>]*>)(<br>)?/g,"$2").replace(/<br>$/,""))+"</blockquote>";else if(u=e(o,d))d=d.substr(u.length),m+=u.replace(/\n/g,"<div><br></div>");else if(u=e(a,d))d=d.substr(u.length),u=u.replace(/</g,"\r&lt;"),p.images&&(u=u.replace(l,i)),p.links&&/(http|@)/i.test(u)&&(u=u.replace(s,function(e,t,i){return'<a href="'+(t=t.replace(/@/g,"&#64;"))+'" rel="noopener" target="_blank">'+t+"</a>"+i}).replace(r,function(e,t){return'<a href="mailto:'+t+'">'+t+"</a>"})),m+="<div>"+u.replace(/\r/g,"").replace(/\n+/g,function(e){return"</div>"+new Array(e.length).join("<div><br></div>")+"<div>"})+"</div>";else if(d){ox.debug&&console.error("Ooops",m+"\n\n"+d);break}return m=m.replace(/<div><\/div>/g,"")}function i(e){return'<img src="'+e.substr(2,e.length-3)+'" alt="">'}var n=/^>+( [^\n]*|)(\n>+( [^\n]*|))*\n?/,o=/^\n+/,a=/^[^\n]*(\n(?![ ]*(> ))[^\n]*)*\n?/,s=/(https?:\/\/.*?)([!?.,>()]\s|\s|[!?.,>()]$|$)/gi,r=/([^@"\s<,:;|()[\]\u0100-\uFFFF]+?@[^@\s]*?(\.[\w-]+)+)/g,l=/^!\([^)]+\)$/gm,c={blockquotes:!0,images:!0,links:!0};return t}()};return x});