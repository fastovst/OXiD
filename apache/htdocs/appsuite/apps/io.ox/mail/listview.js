define("io.ox/mail/listview",["io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/util","io.ox/mail/api","io.ox/core/api/account","io.ox/core/tk/list","io.ox/core/tk/list-contextmenu","io.ox/core/folder/api","gettext!io.ox/mail","io.ox/mail/view-options","less!io.ox/mail/style"],function(e,i,t,a,d,n,o,l,r){"use strict";function s(e){"threadSize"in e||(e.threadSize=Math.max(1,_(e.thread).reduce(function(e,i){return e+(t.isDeleted(i)?0:1)},0)))}function c(e){if(t.isDeleted(e)){var i=_(e.thread).findWhere(function(e){return!t.isDeleted(e)});i&&(e=_.extend(e,i))}}return i.point("io.ox/mail/listview/item").extend({id:"default",index:100,draw:function(e){if(s(e.data),c(e.data),e.app){var t=e.app.props.get("layout"),a="horizontal"===t||"list"===t;this.closest(".list-item").toggleClass("small",a),i.point("io.ox/mail/listview/item/"+(a?"small":"default")).invoke("draw",this,e)}else i.point("io.ox/mail/listview/item/default").invoke("draw",this,e)}},{id:"a11y",index:200,draw:e.a11yLabel}),i.point("io.ox/mail/listview/item/small").extend({id:"unread",index:110,draw:e.unreadClass},{id:"flagged",index:115,draw:e.flaggedClass},{id:"deleted",index:120,draw:e.deleted},{id:"col1",index:100,draw:function(i){var t=$('<div class="list-item-column column-1">');e.envelope.call(t,i),this.append(t)}},{id:"col2",index:200,draw:function(i){var t=$('<div class="list-item-column column-3">');e.paperClip.call(t,i),this.append(t)}},{id:"col3",index:300,draw:function(i){var t=$('<div class="list-item-column column-3">');e.priority.call(t,i),this.append(t)}},{id:"col4",index:400,draw:function(e){var t=$('<div class="list-item-column column-4">');i.point("io.ox/mail/listview/item/small/col4").invoke("draw",t,e),this.append(t)}},{id:"col5",index:500,draw:function(i){var t=$('<div class="list-item-column column-5">');e.answered.call(t,i),0===t.children().length&&e.forwarded.call(t,i),this.append(t)}},{id:"col6",index:600,draw:function(e){var t=$('<div class="list-item-column column-6">');i.point("io.ox/mail/listview/item/small/col6").invoke("draw",t,e),this.append(t)}},{id:"col7",index:700,draw:function(e){var t=$('<div class="list-item-column column-7">');i.point("io.ox/mail/listview/item/small/col7").invoke("draw",t,e),this.append(t)}}),i.point("io.ox/mail/listview/item/small/col4").extend({id:"from",index:100,draw:e.from}),i.point("io.ox/mail/listview/item/small/col6").extend({id:"account",index:100,draw:e.account},{id:"original-folder",index:150,draw:e.folder},{id:"flag",index:200,draw:e.flag},{id:"optionalSize",index:250,draw:e.size},{id:"thread-size",index:300,draw:e.threadSize},{id:"shared-attachement",index:450,draw:e.sharedAttachement},{id:"colorflag",index:200,draw:e.colorflag},{id:"pgp-encrypted",index:600,draw:e.pgp.encrypted},{id:"pgp-signed",index:600,draw:e.pgp.signed},{id:"subject",index:1e3,draw:e.subject},{id:"text-preview",index:1100,draw:function(e){this.append($('<span class="text-preview inline gray">').text(e.data.text_preview||""))}}),i.point("io.ox/mail/listview/item/small/col7").extend({id:"date",index:100,draw:e.date}),i.point("io.ox/mail/listview/item/default").extend({id:"picture",before:"row1",draw:function(i){i.app&&i.app.props.get("contactPictures")&&e.picture.call(this,i)}},{id:"row1",index:100,draw:function(e){var t=$('<div class="list-item-row">');i.point("io.ox/mail/listview/item/default/row1").invoke("draw",t,e),this.append(t)}},{id:"unread",index:110,draw:e.unreadClass},{id:"flagged",index:115,draw:e.flaggedClass},{id:"deleted",index:120,draw:e.deleted},{id:"row2",index:200,draw:function(e){var t=$('<div class="list-item-row">');i.point("io.ox/mail/listview/item/default/row2").invoke("draw",t,e),this.append(t)}},{id:"row3",index:300,draw:function(e){if(e.app&&e.app.useTextPreview){var t=$('<div class="list-item-row">');i.point("io.ox/mail/listview/item/default/row3").invoke("draw",t,e),this.append(t)}}}),i.point("io.ox/mail/listview/item/default/row1").extend({id:"date",index:100,draw:e.date},{id:"from",index:300,draw:e.from}),i.point("io.ox/mail/listview/item/default/row2").extend({id:"account",index:100,draw:e.account},{id:"original-folder",index:150,draw:e.folder},{id:"colorflag",index:200,draw:e.colorflag},{id:"flag",index:210,draw:e.flag},{id:"optionalSize",index:250,draw:e.size},{id:"thread-size",index:300,draw:e.threadSize},{id:"paper-clip",index:400,draw:e.paperClip},{id:"shared-attachement",index:350,draw:e.sharedAttachement},{id:"pgp-encrypted",index:450,draw:e.pgp.encrypted},{id:"pgp-signed",index:450,draw:e.pgp.signed},{id:"priority",index:500,draw:e.priority},{id:"subject",index:1e3,draw:function(i){e.subject.call(this,i);var t=this.find(".flags");e.unread.call(t,i),e.answered.call(t,i),e.forwarded.call(t,i)}}),i.point("io.ox/mail/listview/item/default/row3").extend({id:"text-preview",index:100,draw:function(e){this.append($('<div class="text-preview multiline gray">').text(e.data.text_preview||""))}}),i.point("io.ox/mail/listview/notification/empty").extend({id:"default",index:100,draw:e.empty}),i.point("io.ox/mail/listview/notification/error").extend({id:"default",index:100,draw:function(e){this.append($('<i class="fa fa-exclamation-triangle" aria-hidden="true">'),$.txt(r("Error: Failed to load messages")),$('<button type="button" class="btn btn-link">').text(r("Retry")).on("click",{baton:e},function(e){e.data.baton.listView.load()}))}}),n.extend(o).extend({ref:"io.ox/mail/listview",initialize:function(e){if(n.prototype.initialize.call(this,e),this.$el.addClass("mail-item"),this.on("collection:load",this.lookForUnseenMessage),this.$el.on("click mousedown",".selectable .seen-unseen-indicator",this.markRead.bind(this)),e&&e.app){var i=e.app.props;_.extend(this.options,i.pick("thread","sort")),this.listenTo(i,"change:sort",function(e,i){this.options.sort=i})}this.$el.on("scrollend",this.fetchTextPreview.bind(this)),this.on("collection:load collection:reload",this.fetchTextPreview),this.selection&&(this.selection.resolve=function(){return a.resolve(this.get(),this.view.app.isThreaded())})},fetchTextPreview:function(){if(this.app&&this.app.useTextPreview()){var e=this.el.scrollTop,i=e+this.el.offsetHeight,t=this.getItems().outerHeight(),d=Math.floor(0,e/t),n=Math.ceil(i/t),o=this.collection.slice(d,n),l=[];o=_(o).filter(function(e){var i=_(a.threads.get(e.cid)).first(),t=i&&!i.text_preview;return t&&!e.hasNoPreview&&l.push(_(i).pick("id","folder_id")),t}),l.length&&a.fetchTextPreview(l).done(function(e){_(o).each(function(i){var t=_(a.threads.get(i.cid)).first(),d=_.cid(t);i.set("text_preview",e[d]),""===e[d]&&(i.hasNoPreview=!0)})})}},lookForUnseenMessage:function(){if(this.collection.length){var e=this.collection.at(0).get("folder_id"),i=this.collection.reduce(function(e,i){return e+t.isUnseen(i.get("flags"))?1:0},0);l.setUnseenMinimum(e,i)}},markRead:function(e){var i=$(e.currentTarget).closest(".selectable").data("cid"),d=a.threads.get(i);_(d).reduce(function(e,i){return e||t.isUnseen(i)},!1)?a.markRead(d):a.markUnread(d),e.preventDefault(),e.stopPropagation()},reprocessThread:function(e){var i=a.threads.get(e.cid);if(i.length&&e.get("thread")&&i.length!==e.get("thread").length){_.each(i,function(e){delete e.head});var t=_.extend(e.toJSON(),i[0],{thread:i,threadSize:i.length});a.processThreadMessage(t),e.set(t,{silent:!0})}},map:function(e){if(!this.app||!this.app.isThreaded())return e.toJSON();this.reprocessThread(e);var i=a.threads.head(e.toJSON()),d=a.threads.get(e.cid),n=_(d).reduce(function(e,i){return e||t.isUnseen(i)},!1);i.flags=n?-33&i.flags:32|i.flags;var o=_(d).reduce(function(e,i){return e||t.isFlagged(i)},!1);i.flags=o?8|i.flags:-9&i.flags;var l=_(d).reduce(function(e,i){return e||parseInt(i.color_label||0,10)},0);return i.color_label=l,i.thread=d.map(function(e,t){return _(e).pick(_(i.thread[t]).keys())}),i.subject=a.threads.subject(i)||i.subject||"",i},getCompositeKey:function(e){return this.options.threaded?"thread."+e.cid:e.cid},getContextMenuData:function(e){return this.app.getContextualData(e)}})});