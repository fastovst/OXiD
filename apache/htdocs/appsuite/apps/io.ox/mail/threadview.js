define("io.ox/mail/threadview",["io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/api/backbone","io.ox/mail/detail/view","io.ox/mail/detail/mobileView","io.ox/core/tk/list-dnd","io.ox/core/http","gettext!io.ox/mail","less!io.ox/mail/style","io.ox/mail/listview"],function(e,t,i,o,a,s,l,n,r,d){"use strict";t.point("io.ox/mail/thread-view").extend({id:"navigation",index:100,draw:function(){this.$el.append($('<nav class="back-navigation generic-toolbar">').append($('<div class="button">').append($('<a href="#" role="button" class="back">').attr("aria-label",d("Back to list")).append($('<i class="fa fa-chevron-left" aria-hidden="true">'),$.txt(" "),$.txt(d("Back")))),$('<div class="position">'),$('<div class="prev-next">').append($('<a href="#" role="button" class="previous-mail">').attr("aria-label",d("Previous message")).append($('<i class="fa fa-chevron-up" aria-hidden="true">')),$('<a href="#" role="button" class="next-mail">').attr("aria-label",d("Next message")).append($('<i class="fa fa-chevron-down" aria-hidden="true">')))).attr("role","navigation"))}}),t.point("io.ox/mail/thread-view").extend({id:"thread-view-list",index:200,draw:function(){this.$el.append($('<div class="thread-view-list scrollable abs">').hide().append($('<div class="thread-view-header">').attr("aria-label",d("Conversation")),this.$messages=$('<div class="thread-view list-view" role="region">')).on("scroll",this.onScrollEnd.bind(this)))}}),t.point("io.ox/mail/thread-view/header").extend({id:"toggle-all",index:100,draw:function(e){e.view.collection.length<=1||this.append($('<a href="#" role="button" class="toggle-all">').append('<i class="fa fa-angle-double-down" aria-hidden="true">').attr("aria-label",d("Open all messages")).tooltip({animation:!1,container:"body",placement:"left",title:d("Open/close all messages")}))}}),t.point("io.ox/mail/thread-view/header").extend({id:"subject",index:200,draw:function(e){var t=1===e.view.collection.length,a=e.view.model.toJSON(),s=e.view.threaded?i.threads.subject(a)||a.subject:a.subject;this.append($('<h1 class="subject">').text(o.getSubject(s,t)))}});var h=Backbone.View.extend({tagName:"div",className:"thread-view-control abs",events:{"click .button a.back":"onBack","click .back-navigation .previous-mail":"onPrevious","click .back-navigation .next-mail":"onNext","click .toggle-all":"onToggleAll",keydown:"onKeydown"},empty:function(){this.$messages.empty(),this.$el.scrollTop(0),this.$el.find(".thread-view-list").hide(),this.model=null},updateHeader:function(){var e=new t.Baton({view:this}),i=this.$el.find(".thread-view-list > .thread-view-header").empty(),a=1===e.view.collection.length,s=o.getSubject(e.view.model.toJSON(),a);this.collection.length>0&&t.point("io.ox/mail/thread-view/header").invoke("draw",i,e),this.$el.find(".thread-view").toggleClass("multiple-messages",this.collection.length>1).attr("aria-label",s)},updatePosition:function(e){return this.$el.find(".position").text(e),this},togglePrevious:function(e){return this.$el.find(".previous-mail").toggleClass("disabled",!e),this},toggleNext:function(e){return this.$el.find(".next-mail").toggleClass("disabled",!e),this},toggleNavigation:function(e){return this.$el.toggleClass("back-navigation-visible",e),this},onToggle:_.debounce(function(e){var t=0===this.getItems().filter(".expanded").length,i=t?"fa-angle-double-down":"fa-angle-double-up",o=this.$el.find(".toggle-all");o.attr("aria-label",d(t?"Open all messages":"Close all messages")),o.find("i").attr("class","fa "+i),e&&$(e.target).hasClass("expanded")||this.onScrollEnd()},10),onToggleAll:function(e){e.preventDefault();var t=0===this.getItems().filter(".expanded").length;r.pause(),this.collection.each(function(e){this.toggleMail(e.cid,t)},this),r.resume()},toggleMail:function(e,t){var i=this.$messages.children('[data-cid="'+$.escape(e)+'"]').data("view");i&&i.toggle(t)},showMail:function(e){this.toggleMail(e,!0)},autoSelectMail:function(e){if(this.autoSelect){for(var t,i=0;t=this.collection.at(i);i++)if(i===this.collection.length-1||!o.isUnseen(t.toJSON())){if(e)return t.cid;this.showMail(t.cid);break}delete this.autoSelect}else for(var a,s=this.collection.length-1;a=this.collection.at(s);s--)if(0===s||o.isUnseen(a.toJSON())){if(e)return a.cid;this.showMail(a.cid);break}},onScrollEnd:_.debounce(function(){var e=this.$el.find(".thread-view-list");this.getItems().each(function(){if($(this).hasClass("placeholder")&&this.offsetTop+$(this).height()>e.scrollTop()&&this.offsetTop<e.scrollTop()+e.height()){var t=$(this).data("view");t&&(t.placeholder=!1,t.render())}})},100),show:function(e,t){if(e=String(e).replace(/^thread\./,""),!this.model||this.model.cid!==e){var o=i.pool.get("detail"),a=o.get(e);if(!a)return this.empty(),void console.error("ThreadView.show(): Mail not found in pool",e,o);this.model&&this.stopListening(this.model),this.model=a,this.threaded=!!t,this.threaded||delete this.autoSelect,this.listenTo(this.model,"change:thread",this.onChangeModel),this.collection.reset([],{silent:!0}),this.reset()}},reset:function(){if(this.model){var e=this.threaded?i.threads.get(this.model.cid):[this.model.toJSON()];if(e.length){var t=0===this.collection.length?"reset":"set";this.collection[t](e)}}},onReset:function(){0!==this.collection.length?(this.$messages.empty(),this.$el.scrollTop(0),clearTimeout(this.renderItemTimoutId),this.updateHeader(),this.$el.find(".thread-view-list").show(),this.nextAutoSelect=this.autoSelectMail(!0),this.$messages.append(this.collection.chain().map(this.renderListItem,this).value()),this.zIndex()):this.empty()},onAdd:function(e){var t=e.get("index"),i=this.getItems(),o=this.renderListItem(e),a=this.$el.data("open");t<i.length?i.eq(t).before(o):this.$messages.append(o),o.position().top<=0&&this.$messages.scrollTop(this.$el.scrollTop()+o.outerHeight(!0)),this.zIndex(),this.updateHeader(),a&&(this.showMail(a),this.$el.data("open",null))},onRemove:function(e){var t=this.getItems(),i=t.filter(function(){return $(this).attr("data-cid")===e.cid}),o=!!i.length&&(i.attr("data-cid")&&t.first().attr("data-cid")),a=this.$messages.scrollTop();0!==i.length&&(i.position().top<a&&this.$messages.scrollTop(a-i.outerHeight(!0)),i.remove(),1===t.length?this.empty():this.updateHeader(),t.length>1&&o&&this.autoSelectMail())},onPoolRemove:function(e){this.collection.remove(e)},onChangeModel:function(){this.reset()},onBack:function(e){e.preventDefault(),this.trigger("back")},onPrevious:function(e){e.preventDefault(),this.trigger("previous")},onNext:function(e){e.preventDefault(),this.trigger("next")},onClick:function(e){var t=$(e.currentTarget).attr("data-cid");this.showMail(t)},onKeydown:function(e){switch(e.which){case 38:e.shiftKey&&this.onNext(e),e.altKey&&this.focusMessage(e,-1);break;case 40:e.shiftKey&&this.onPrevious(e),e.altKey&&this.focusMessage(e,1)}},focusMessage:function(e,t){var i=this.getItems(),o=$(document.activeElement).closest(".list-item"),a=i.index(o);e.preventDefault(),(a+=t)<0||a>=i.length||(o.data("view").toggle(!1),i.eq(a).focus().data("view").toggle(!0),i.eq(a).get(0).scrollIntoView(!0))},initialize:function(e){this.model=null,this.threaded=!0,this.collection=new a.Collection,e=e||{},this.standalone=e.standalone||!1,this.app=e.app,this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset}),this.listenTo(i.pool.get("detail"),{remove:this.onPoolRemove}),this.$messages=$(),this.$el.data("view",this),this.$el.on("toggle",".list-item",this.onToggle.bind(this)),e.disableDrag||(n.enable({container:this.$el,draggable:!0,selectable:".detail-view-header .contact-picture",simple:!0}),this.$el.on("mouseup",".detail-view-header .contact-picture",function(e){$(e.target).closest("article").focus()}));var t=$.proxy(this.onScrollEnd,this);this.$el.one("remove",function(){$(window).off("resize",t)}),e.app&&this.listenTo(e.app.props,"change:textPreview",function(e,i){this.$el.toggleClass("hide-text-preview",!i),t()}),$(window).on("resize",t)},getItems:function(){return this.$messages.children(".list-item")},render:function(){return this.$el.toggleClass("hide-text-preview",!this.app||!this.app.useTextPreview()),t.point("io.ox/mail/thread-view").invoke("draw",this),this},renderListItem:function(e){var t=this,i=new s.View({supportsTextPreview:!!this.app&&this.app.supportsTextPreviewConfiguration(),tagName:"article",data:e.toJSON(),disable:{"io.ox/mail/detail":"subject"}});return i.on("mail:detail:body:render",function(e){t.trigger("mail:detail:body:render",e)}),i.render(),this.nextAutoSelect===e.cid&&(delete this.nextAutoSelect,i.expand()),i.$el.attr({tabindex:-1})},zIndex:function(){var e=this.getItems(),t=e.length;e.each(function(e){$(this).css("zIndex",t-e)}),this.onScrollEnd()}});return t.point("io.ox/mail/mobile/thread-view").extend({id:"thread-view-list",index:100,draw:function(){this.$el.append($('<div class="thread-view-list scrollable abs">').hide().append($('<div class="thread-view-header">').attr("aria-label",d("Conversation")),this.$messages=$('<ul class="thread-view list-view">')).on("scroll",this.onScrollEnd.bind(this)))}}),t.point("io.ox/mail/detail").extend({id:"remove-halo-link",index:"last",draw:function(){_.device("!smartphone")||this.find(".halo-link").removeClass("halo-link")}}),{Desktop:h,Mobile:h.extend({initialize:function(){this.model=null,this.threaded=!0,this.collection=new a.Collection,this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset}),this.listenTo(i.pool.get("detail"),{remove:this.onPoolRemove}),this.$messages=$()},renderListItem:function(e){var t=new l.HeaderView({tagName:"li",data:e.toJSON(),disable:{"io.ox/mail/detail":["subject","actions"],"io.ox/mail/detail/header":["paper-clip"],"io.ox/mail/detail/header/row1":["color-picker","flag-toggle","security"]}});return t.render().$el.attr({role:"listitem",tabindex:"0"}),t.$el},renderMail:function(e){e=String(e).replace(/^thread\.(.+)$/,"$1");var t=i.pool.get("detail").get(e);if(t){var o=new l.DetailView({tagName:"li",data:t.toJSON()});return this.mail=t.toJSON(),o.render().toggle().$el.attr({role:"listitem",tabindex:"0"})}},render:function(){return t.point("io.ox/mail/thread-view/header").disable("toggle-all"),t.point("io.ox/mail/thread-view").invoke("draw",this),this}})}});