define("io.ox/mail/mailfilter/vacationnotice/view",["io.ox/mail/mailfilter/vacationnotice/model","io.ox/core/api/mailfilter","io.ox/backbone/views","io.ox/core/extensions","io.ox/backbone/mini-views","io.ox/backbone/mini-views/datepicker","io.ox/backbone/views/modal","io.ox/core/settings/util","io.ox/core/yell","io.ox/core/api/user","io.ox/core/api/account","io.ox/contacts/util","settings!io.ox/mail","gettext!io.ox/mail","less!io.ox/mail/mailfilter/vacationnotice/style"],function(e,t,i,a,n,o,d,s,l,r,c,m,p,u){"use strict";function h(e){throw l("error",u("MAIL_FILTER-0015"===e.code?"Unable to load mail filter settings.":"Unable to load your vacation notice. Please retry later.")),e}function f(e){return new d({async:!0,focus:'input[name="active"]',model:e.model,point:g,title:u("Vacation notice"),help:"ox.appsuite.user.sect.email.send.vacationnotice.html",width:640}).inject({updateActive:function(){var e=this.model.get("active");this.$body.toggleClass("disabled",!e).find(":input").prop("disabled",!e),this.updateDateRange()},updateDateRange:function(){var e=this.model.get("active")&&this.model.get("activateTimeFrame"),t=_.device("smartphone")?".dateinput.mobile-mode":".form-control";this.$(".date-range "+t).prop("disabled",!e)},getAddresses:function(){var e=m.getMailFullName(this.data.user).trim();return!/^[A-Za-z0-9 ]+$/.test(e)&&(e='"'+e+'"'),[].concat({value:"default",label:u("Default sender")},_(this.data.aliases).map(function(t){return t=e?e+" <"+t+">":t,{value:t,label:t}}))},getDurationString:function(){var e=this.model.getDuration();return e>0?u.ngettextf("%1$d day","%1$d days",e):""},getTimeFrameError:function(){var e=this.model.validate();return e&&e.dateUntil||""},reflectValidity:function(){var e=(this.model.validationError||{}).dateUntil;this.$(".error-message > .help-block").text(e).parent().toggle(!!e),this.$('[name="dateUntil"]').parent().toggleClass("has-error",!!e),this.$('.btn-primary[data-action="save"]').prop("disabled",!!e),this.$('[name="subject"]').prop("disabled",!!e),this.$('[name="text"]').prop("disabled",!!e)}}).build(function(){this.data=_(e).pick("aliases","config","user","primary"),this.$el.addClass("rule-dialog")}).addCancelButton().addButton({label:u("Apply changes"),action:"save"}).on("open",function(){this.updateActive()}).on("save",function(){this.model.save().done(this.close).fail(this.idle).fail(l)}).open()}function v(){var i=new e;return $.when(r.get(),t.getConfig(),c.getPrimaryAddress(),t.getRules(),i.fetch()).then(function(e,t,a,n){return _.isEmpty(n)||void 0!==i.get("position")||i.set("position",0),{model:i,aliases:e.aliases,config:t,user:e,primary:a[1]}})}var g="io.ox/mail/vacation-notice/edit",b=0,x=0,w=0,y=o.extend({updateModel:function(){this.model.set(this.attribute,this.getTimestamp(),{validate:!1,fulltime:this.isFullTime()})}});return a.point(g).extend({index:b+=100,id:"switch",render:function(){this.$header.prepend(new n.SwitchView({name:"active",model:this.model,label:"",size:"large"}).render().$el.attr("title",u("Enable or disable vacation notice"))),this.listenTo(this.model,"change:active",this.updateActive)}},{index:b+=100,id:"range",render:function(e){_(this.data.config.tests).findWhere({id:"currentdate"})&&this.$body.append(e.branch("range",this,$('<div class="form-group date-range">')))}}),a.point(g+"/range").extend({index:x+=100,id:"checkbox",render:function(e){this.listenTo(e.model,"change:activateTimeFrame",function(){this.updateDateRange()}),e.$el.append(s.checkbox("activateTimeFrame",u("Send vacation notice during this time only"),e.model))}},{index:x+=100,id:"from-util",render:function(e){var t={dateFrom:u("Start"),dateUntil:u("End")};e.$el.append($('<div class="row">').append(["dateFrom","dateUntil"].map(function(i){return $('<div class="col-md-4">').append($('<label class="control-label">').attr("for","vacation_notice_"+i).text(t[i]),_.device("smartphone")?new y({attribute:i,model:e.model,id:"vacation_notice_"+i,clearButton:!0}).render().$el.prop("disabled",!e.model.get("activateTimeFrame")):new n.DateView({name:i,model:e.model,id:"vacation_notice_"+i}).render().$el.prop("disabled",!e.model.get("activateTimeFrame")))}))),this.listenTo(this.model,"change:dateFrom",function(e,t){var i=e.get("dateUntil")-e.previous("dateFrom")||0;i<0||e.set("dateUntil",t+i)})}},{index:x+=100,id:"days",render:function(e){_.device("smartphone")||e.$el.find(".row:last").append($('<div class="col-md-4 duration">').text(this.getDurationString())),e.$el.append($('<div class="row error-message has-error">').hide().append($('<div class="col-md-8 col-md-offset-4 help-block">'))),this.listenTo(this.model,"change:dateFrom change:dateUntil change:active change:activateTimeFrame",function(){this.$(".duration").text(this.getDurationString()),this.model.isValid()&&this.reflectValidity()}),this.listenTo(this.model,"invalid",this.reflectValidity)}}),a.point(g).extend({index:b+=100,id:"subject",render:function(e){this.$body.append($('<div class="form-group">').append($('<label for="vacation_notice_subject">').append(u("Subject")),new n.InputView({name:"subject",model:e.model,id:"vacation_notice_subject"}).render().$el))}},{index:b+=100,id:"text",render:function(e){this.$body.append($('<div class="form-group">').append($('<label for="vacation_notice_text">').text(u("Message")),new n.TextView({name:"text",model:e.model,id:"vacation_notice_text",rows:6}).render().$el))}},{index:b+=100,id:"advanced",render:function(e){this.$body.append($("<div>").append($('<button type="button" class="btn btn-link">').text(u("Show advanced options")).on("click",function(){$(this).parent().next().show().find(":input:first").focus(),$(this).remove()})),e.branch("advanced",this,$('<div class="form-group">').hide()))}}),a.point(g+"/advanced").extend({index:w+=100,id:"days",render:function(e){var t=_.range(1,32).map(function(e){return{label:e,value:e}});e.$el.append($('<div class="form-group row">').append($('<label for="vacation_notice_days" class="col-md-12">').text(u("Days between notices to the same sender")),$('<div class="col-md-4">').append(new n.SelectView({list:t,name:"days",model:e.model,id:"vacation_notice_days"}).render().$el)))}},{index:w+=100,id:"sender",render:function(e){p.get("features/setFromInVacationNotice",!0)&&(e.$el.append($('<div class="form-group">').append($('<label for="from">').text(u("Send from")),new n.SelectView({list:this.getAddresses(),name:"from",model:this.model,id:"from"}).render().$el)),this.$('select[name="from"]').val()||this.$('select[name="from"]').val("default"))}},{index:w+=100,id:"aliases",render:function(e){var t=this.model,i=this.data.primary||this.data.aliases[0];t.set("primaryMail",i),this.data.aliases.length<=1||p.get("features/setAddressesInVacationNotice",!0)&&(this.data.aliases.splice(_(this.data.aliases).indexOf(i),1),e.$el.append($('<div class="help-block">').text(u("The Notice is sent out for messages received by %1$s. You may choose to send it out for other recipient addresses too:",i)),_(this.data.aliases).map(function(e){return s.checkbox("alias_"+e,e,t)}),$("<div>").append($('<button type="button" class="btn btn-link" data-action="select-all">').text(u("Select all")).on("click",{view:this},function(e){var t=e.data.view;_(t.data.aliases).each(function(e){t.model.set("alias_"+e,!0)})}))))}}),{open:function(){return v().then(f,h)}}});