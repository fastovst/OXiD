define("io.ox/mail/mailfilter/settings/filter",["io.ox/core/extensions","io.ox/core/api/mailfilter","io.ox/mail/mailfilter/settings/model","io.ox/backbone/views/modal","io.ox/core/notifications","io.ox/settings/util","io.ox/mail/mailfilter/settings/filter/view-form","gettext!io.ox/mail","io.ox/backbone/mini-views/listutils","io.ox/backbone/mini-views/settings-list-view","io.ox/backbone/views/disposable","settings!io.ox/mail","io.ox/mail/mailfilter/settings/filter/defaults","io.ox/core/folder/picker","io.ox/mail/api","static/3rd.party/jquery-ui.min.js","less!io.ox/mail/mailfilter/settings/style"],function(t,e,i,o,n,a,l,s,r,d,c,f,u,p,g){"use strict";function m(t){var e=!1;return _.each(t,function(t){_.contains(["stop"],t.id)&&(e=!0)}),e}function h(t,e){_.each(e,function(e,i){t.get(e).set("position",i)}),t.sort()}function v(t,e,i){var n,a,r,d,c=s(void 0===e.id?"Create new rule":"Edit rule"),f=function(t,e){var i;return _.each(t,function(t,o){_.isEqual(t,e)&&(i=o)}),i};if((n=new l({model:e,listView:t.data.listView,config:i,conditionsTranslation:y,actionsTranslations:k,defaults:C,actionCapabilities:T,conditionsMapping:E})).model.get("test").tests){var u=n.model.get("test");u.tests=function(t,e){var i=f(t,e);return i&&t.splice(i,1),t}(u.tests,{id:"true"}),1===u.tests.length&&(u=_.copy(u.tests[0])),n.model.set("test",u)}a=_.copy(n.model.get("test"),!0),r=_.copy(n.model.get("actioncmds"),!0),d=_.copy(n.model.get("rulename"),!0);var p=o.extend({pause:function(){this.$el.next().addBack().hide(),this.toggleAriaHidden(!1)},resume:function(){this.$el.next().addBack().show(),this.toggleAriaHidden(!0)}});n.dialog=new p({top:60,width:800,center:!1,maximize:!0,async:!0,point:"io.ox/settings/mailfilter/filter/settings/detail/dialog",title:c,help:void 0===e.id?"ox.appsuite.user.sect.email.mailfilter.create.html":"ox.appsuite.user.sect.email.mailfilter.change.html"}),n.dialog.$body.append(n.render().el),C.applyMailFilterSupport&&n.dialog.addButton({label:s("Save and apply"),action:"apply"}),n.dialog.addButton({label:s("Save"),action:"save"}).addCancelButton(),0===r.length&&n.dialog.$el.find('.modal-footer[data-action="save"]').prop("disabled",!0),n.dialog.open(),n.$el.find('input[name="rulename"]').focus(),void 0===e.id&&n.$el.find('input[name="rulename"]').trigger("select"),n.collection=x,n.dialog.on("save",function(){n.onSave()}),n.dialog.on("apply",function(){n.onApply()}),n.dialog.on("cancel",function(){n.model.set("test",a),n.model.set("actioncmds",r),n.model.set("rulename",d)})}var x,w=i.protectedMethods.buildFactory("io.ox/core/mailfilter/model",e),b=_.uniqueId("notification_"),y=u.conditionsTranslation,k=u.actionsTranslations,C=u,T=u.actionCapabilities,E=u.conditionsMapping;return t.point("io.ox/settings/mailfilter/filter/settings/detail").extend({index:200,id:"mailfiltersettings",draw:function(t,e){v(t,t.data.obj,e)}}),t.point("io.ox/settings/mailfilter/filter/settings/actions/common").extend({index:200,id:"actions",draw:function(t){var e,i=(t.get("flags")||[])[0],o=t.get("rulename"),n=s("Apply"),a=s(t.get("active")?"Disable":"Enable"),l=m(t.get("actioncmds"))?"fa-ban":"fa-arrow-down",d="vacation"!==i&&"autoforward"!==i&&C.applyMailFilterSupport?r.applyToggle(n):[];e="vacation"===i?"edit-vacation":"autoforward"===i?"edit-autoforward":"edit",$(this).append(d,r.controlsEdit({"aria-label":s("Edit %1$s",o),"data-action":e}),r.controlsToggle(a),r.controlProcessSub({faClass:l,title:s("Process subsequent rules of %1$s",o)}),r.controlsDelete({title:s("Remove %1$s",o)}))}}),t.point("io.ox/settings/mailfilter/filter/settings/actions/unknown").extend({index:200,id:"actions",draw:function(t){var e=t.get("rulename");$(this).append(r.drawWarning(s("This rule contains unsupported properties. ")),r.controlsDelete({title:s("Remove %1$s",e)}))}}),t.point("io.ox/settings/mailfilter/filter/settings/actions/vacation").extend({index:200,id:"actions",draw:function(e){t.point("io.ox/settings/mailfilter/filter/settings/actions/common").invoke("draw",this,e)}}),t.point("io.ox/settings/mailfilter/filter/settings/actions/autoforward").extend({index:200,id:"actions",draw:function(e){t.point("io.ox/settings/mailfilter/filter/settings/actions/common").invoke("draw",this,e)}}),{editMailfilter:function(l,u){var v=function(e,i,o){t.point("io.ox/settings/mailfilter/filter/settings/detail").invoke("draw",e,i,o)},y=this,k=l.closest(".scrollable-pane");return this.initialize().then(function(T,E){(x=w.createCollection(T)).comparator=function(t){return t.get("position")},k.one("refresh:mailfilter",function(){y.refresh()});var D,R;D=c.extend({tagName:"li",className:"settings-list-item",saveTimeout:0,initialize:function(){-1!==_.indexOf(this.model.get("flags"),"vacation")&&this.listenTo(ox,"mail:change:vacation-notice",this.handleToogleState),-1!==_.indexOf(this.model.get("flags"),"autoforward")&&this.listenTo(ox,"mail:change:auto-forward",this.handleToogleState),this.listenTo(this.model,"apply",function(){this.onApply()})},handleToogleState:function(t){this.model.set("active",t.get("active"))},render:function(){function e(){function t(t){if(t.flags)return!d&&/\$cl_/g.test(t.flags[0])}var e=!1;return _.each(a,function(i){(_.isEmpty(_.where(E.actioncmds,{id:i.id}))||t(i))&&(e=!0),(!_.contains(["vacation","stop"],i.id)&&_.isEmpty(_.where(C.actions,{id:i.id}))||t(i))&&(e=!0)}),_.each(function(t){var i={};return t.tests?_.each(t.tests,function(t){t.tests?(E.options.allowNestedTests||(e=!0),_.each(t.tests,function(t){i[t.id]=!0})):i[t.id]=!0}):i[t.id]=!0,i}(l),function(t,i){_.isEmpty(_.where(E.tests,{id:i}))&&(e=!0),_.isEmpty(_.where(C.tests,{id:i}))&&(e=!0)}),e?"unknown":void 0}if(!this.disposed){var i,o=(this.model.get("flags")||[])[0],n=this,a=this.model.get("actioncmds")||[],l=this.model.get("test"),d=f.get("features/flag/color"),c=n.model.get("rulename");return this.$el.attr("data-id",n.model.get("id")).addClass("draggable "+("unknown"===e()||_.contains(["autoforward","spam","vacation"],o)?"fixed":"editable")).attr("draggable",!0).toggleClass("active",n.model.get("active")).toggleClass("disabled",!n.model.get("active")).empty().append(r.dragHandle(s("Drag to reorder filter rules"),this.model.collection.length<=1?"hidden":""),i=r.makeTitle(c),r.makeControls().append(function(){t.point("io.ox/settings/mailfilter/filter/settings/actions/"+(e()||o||"common")).invoke("draw",$(this),n.model)})),n.model.on("change:rulename",function(t,e){i.text(e)}),n.model.on("ChangeProcessSub",function(t){var e=n.$el.find('[data-action="toggle-process-subsequent"] i');t?e.removeClass("fa-ban").addClass("fa-arrow-down"):e.removeClass("fa-arrow-down").addClass("fa-ban")}),n}},events:{'click [data-action="toggle"]':"onToggle",'click [data-action="apply"]':"onApply",'click [data-action="delete"]':"onDelete",'click [data-action="edit"]':"onEdit",'click [data-action="toggle-process-subsequent"]':"onToggleProcessSub",'click [data-action="edit-vacation"]':"onEditVacation",'click [data-action="edit-autoforward"]':"onEditAutoforward"},propagate:function(t){-1!==_.indexOf(t.get("flags"),"vacation")&&require(["io.ox/mail/mailfilter/vacationnotice/model"],function(e){var i=new e;i.set(t.toJSON()),ox.trigger("mail:change:vacation-notice",i)}),-1!==_.indexOf(t.get("flags"),"autoforward")&&require(["io.ox/mail/mailfilter/autoforward/model"],function(e){var i=new e;i.set(t.toJSON()),ox.trigger("mail:change:auto-forward",i)})},onToggle:function(t){t.preventDefault();var i=this;this.model.set("active",!this.model.get("active")),a.yellOnReject(e.update(i.model).done(function(){i.$el.toggleClass("active",i.model.get("active")),i.$el.toggleClass("disabled",!i.model.get("active")),$(t.target).text(s(i.model.get("active")?"Disable":"Enable")),i.propagate(i.model)}))},onApply:function(t){t&&t.preventDefault();var i=this;p({async:!0,context:"filter",title:s("Select the folder to apply the rule to"),done:function(t,o){o.close();var a=i.$el.find('a[data-action="apply"]');a.empty().append($('<i aria-hidden="true">').addClass("fa fa-refresh fa-spin")),e.apply({folderId:t,id:i.model.id}).then(function(){return g.expunge(t)}).fail(function(t){n.yell("error",t.error)}).then(function(){_(g.pool.getCollections()).forEach(function(t){t.collection.expire()}),g.refresh(),a.empty().text(s("Apply"))})},module:"mail",root:"1",settings:f,persistent:"folderpopup"})},onToggleProcessSub:function(t){t.preventDefault();var i=this,o=this.model.get("actioncmds");m(o)?o.pop():o.push({id:"stop"}),this.model.set("actioncmds",o),a.yellOnReject(e.update(i.model).done(function(){var e=$(t.target).closest(".list-item-controls").find('[data-action="toggle-process-subsequent"] i');m(o)?e.removeClass("fa-arrow-down").addClass("fa-ban"):e.removeClass("fa-ban").addClass("fa-arrow-down")}))},onDelete:function(t){t.preventDefault(),new o({title:s("Do you really want to delete this filter rule?")}).addCancelButton().addButton({label:s("Delete"),action:"delete"}).on("delete",function(){var t=this,i=this.model;!1!==i.get("id")&&(x.remove(i),a.yellOnReject(e.deleteRule(i.get("id")).done(function(){t.propagate(i.set("active",!1)),l.find('.controls [data-action="add"]').focus();var o=l.find("li[data-id]"),n=_.map(o,function(t){return parseInt($(t).attr("data-id"),10)});a.yellOnReject(e.reorder(n)),h(x,n)})))}.bind(this)).open()},onEdit:function(t){t.preventDefault();var e=this;t.data={},t.data.id=e.model.get("id"),t.data.obj=e.model,t.data.listView=this,void 0!==t.data.obj&&v(this.$el.parent(),t,E)},onEditVacation:function(t){t.preventDefault(),require(["io.ox/mail/mailfilter/vacationnotice/view"],function(t){t.open()})},onEditAutoforward:function(t){t.preventDefault(),require(["io.ox/mail/mailfilter/autoforward/view"],function(t){t.open()})}});var S=new(R=Backbone.View.extend({initialize:function(){this.collection=x,this.listenTo(ox,"refresh^",this.onRefresh),this.listenTo(ox,"app:start app:resume",function(t){this.handleRefresh(t)}),this.$el.on("dispose",function(){this.stopListening()}.bind(this))},onRefresh:function(){y.refresh()},handleRefresh:function(t){t.attributes.name!==u.tree.app.attributes.name?this.stopListening(ox,"refresh^"):this.listenTo(ox,"refresh^",this.onRefresh)},render:function(){return this.$el.empty(),this.$el.append($("<h1>").text(s("Mail Filter Rules")),$('<div class="form-group buttons">').append($('<button type="button" class="btn btn-primary" data-action="add">').append($('<i class="fa fa-plus" aria-hidden="true">'),$.txt(s("Add new rule")))),$('<div class="sr-only" role="log" aria-live="polite" aria-relevant="all">').attr("id",b)),this.renderFilter(),this},handleEmptynotice:function(){0===this.collection.length?this.$el.append($('<div class="hint">').text(s("There is no rule defined"))):this.$el.find(".hint").remove()},renderFilter:function(){this.handleEmptynotice(),this.listenTo(this.collection,"add remove",this.handleEmptynotice.bind(this)),this.$el.append(new d({collection:this.collection,sortable:!0,containment:this.$el,notification:this.$("#"+b),childView:D}).on("order:changed",function(){var t=l.find("li[data-id]"),i=_.map(t,function(t){return parseInt($(t).attr("data-id"),10)});a.yellOnReject(e.reorder(i)),h(x,i)}).render().$el)},events:{'click [data-action="add"]':"onAdd"},onAdd:function(t){t.data={listView:this,obj:w.create(i.protectedMethods.provideEmptyModel())},v(this.el,t,E)}}));return l.append(S.render().$el),x})},initialize:function(){var t={api:e,model:i,filterDefaults:C};return $.when(e.getRules(),e.getConfig(),t)},refresh:function(){this.initialize().done(function(t){_(t).each(function(t){x.add(w.create(t),{merge:!0})})})}}});