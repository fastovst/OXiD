define("io.ox/mail/mailfilter/autoforward/model",["io.ox/core/api/mailfilter","io.ox/core/api/user","gettext!io.ox/mail"],function(t,e,i){"use strict";return Backbone.Model.extend({parse:function(t){if(!_.isObject(t))return{};this.availableActions=t.availableActions;var e={active:!1,copy:!1,processSub:!0,to:"",userMainEmail:t.user.email1};return _.isEmpty(t.forward)?(e.position=_.isEmpty(t.vacation)?0:t.vacation.position+1,e):(e.active=!!t.forward.active,e.id=t.forward.id,_(t.forward.actioncmds).each(function(t){switch(t.id){case"redirect":e.to=t.to,e.copy=!!t.copy;break;case"stop":e.processSub=!1;break;case"keep":e.copy=!0}}),e)},toJSON:function(){var t=this.attributes,e={actioncmds:[{id:"redirect",to:t.to}],active:!!t.active,flags:["autoforward"],position:t.position,rulename:i("autoforward"),test:{id:"true"}};return t.copy&&(this.availableActions.copy?e.actioncmds[0].copy=!0:e.actioncmds.push({id:"keep"})),t.processSub||e.actioncmds.push({id:"stop"}),_.isNumber(t.id)&&(e.id=t.id),e},sync:function(i,o,a){switch(""===this.attributes.to&&this.attributes.id&&(i="delete"),i){case"create":return t.create(this.toJSON()).done(this.onUpdate.bind(this)).done(a.success).fail(a.error);case"read":return $.when(t.getRules("autoforward"),t.getRules("vacation"),e.get(),t.getConfig()).then(function(t,e,i,o){return{forward:t[0],vacation:e[0],user:i,availableActions:function(){var t={};return _.each(o.actioncmds,function(e){t[e.id]=e}),t}()}}).done(a.success).fail(a.error);case"update":return t.update(this.toJSON()).done(this.onUpdate.bind(this)).done(a.success).fail(a.error);case"delete":return t.deleteRule(this.get("id")).done(this.onUpdate.bind(this)).done(a.success).fail(a.error)}},onUpdate:function(){ox.trigger("mail:change:auto-forward",this)},isActive:function(){return!!this.get("active")}})});