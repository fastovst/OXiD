define("io.ox/mail/api",["io.ox/mail/api-legacy","io.ox/core/http","settings!io.ox/core","io.ox/core/api/factory","io.ox/core/folder/api","io.ox/core/api/account","io.ox/mail/util","io.ox/core/api/collection-pool","io.ox/core/api/collection-loader","io.ox/core/tk/visibility-api-util","settings!io.ox/mail","gettext!io.ox/mail","io.ox/core/capabilities","io.ox/mail/sanitizer"],function(e,t,r,n,i,a,o,l,c,s,d,u,f,g){"use strict";function h(e){G.threads.touch(e.toJSON())}function m(){return d.get("allowHtmlMessages",!0)?"html":"text"}function p(e){var t=m();if("text"===t)return"text";if(o.authenticity("block",e))return"noimg";var r="trusted"===o.authenticity("box",e),n=o.isWhiteListed(e);return r||n?t:d.get("allowHtmlImages",!1)?a.is("spam|confirmed_spam|trash",e.folder_id||e.folder)?"noimg":t:"noimg"}function v(e){return _.isArray(e)?e.map(function(e){return/^text\/(plain|html)/i.test(e.content_type)?(e.content_type=String(e.content_type).toLowerCase().split(";")[0],g.sanitize(e)):e}):[{content:"",content_type:"text/plain",disp:"inline",id:"1",sanitized:!0,size:0,truncated:!1}]}function y(e){return e.attachments=v(e.attachments),_.isArray(e.nested_msgs)&&(e.nested_msgs=e.nested_msgs.map(function(e){return e.attachments=v(e.attachments),e})),e}function x(e,t){var r=R.get("detail");1===(t=t||e).length&&(G.threads.remove(t[0]),G.threads.touch(t[0])),G.trigger("beforedelete",t),_(t).each(function(e){var t=_.cid(e),n=r.get(t);n&&(n.preserve=!1,r.remove(n))})}function w(e){return R.resetFolder(a.getFoldersByType(e))}function S(e,t){_(e).chain().pluck("folder_id").uniq().map(R.getBySorting.bind(R,t)).flatten().each(function(e){e.sorted=!1})}function b(e,r){return x(e),w(r?"spam":"inbox"),t.pause(),_(e).map(function(e){return t.PUT({module:"mail",params:{action:"update",id:e.id,folder:e.folder_id,timestamp:_.then()},data:{flags:G.FLAGS.SPAM,value:r},appendColumns:!1})}),i.reload(e[0].folder_id,a.getFoldersByType(r?"spam":"inbox")),t.resume()}function E(e,r,n){return R.resetFolder(n),t.wait(B(r,{folder_id:n},e).then(function(t){G.trigger(e,r,n),i.reload(n,r);var a=_(t.response).find(function(e){return!!e.error});return a?(G.trigger("refresh.all"),$.Deferred().reject(a.error)):"copy"===e?_(t.response).pluck("data"):r}))}function T(e){return e.id=e.original_id,e.folder_id=e.original_folder_id,32!=(32&e.flags)&&!a.is("spam|confirmed_spam|trash",e.folder_id)}function A(e){return!o.isDeleted(e)}function F(e){if(e.thread)return e.thread;var t=G.threads.get(_.cid(e))||{};return t&&t.length>1?t:[e]}function U(e){if(!e.authenticity)return e;e.authenticity_preview=e.authenticity,delete e.authenticity}var D=_("0 1 7 10 6 3 9 2 5 8 4".split(" ")).invert(),M=function(e,t){return D[t.color_label]-D[e.color_label]},R=window.mailpool=l.create("mail"),C=d.get("features/fixtoccbcc"),P=!d.get("features/ignoreDeleted",!1),L=g.isEnabled(),k=d.get("features/sandboxedCSS",!0),O=r.get("pdf/enablePreconversionOnMailFetch",!0);R.map=function(e){var t=_.cid(e),r=this.get(t);return r&&r.get("headers")&&(e.headers||(e.headers={}),e.headers=_.extend(e.headers,r.get("headers"))),_([e].concat(e.attachments)).each(function(e){e&&/^text\/(plain|html)/i.test(e.content_type)&&(e.content_type=String(e.content_type).toLowerCase().split(";")[0])}),r?(C&&["to","cc","bcc"].forEach(function(t){var n=r.get(t);_.isArray(n)&&n.length>0&&delete e[t]}),e):e};var G=n({module:"mail",keyGenerator:function(e){return e?(e.folder_id||e.folder)+"."+e.id+"."+(e.view||G.options.requests.get.view||""):""},requests:{all:{folder:"default0/INBOX",columns:"601,600,611,102",extendColumns:"io.ox/mail/api/all",sort:"610",order:"desc",deleted:P,cache:!1},list:{action:"list",columns:"102,600,601,602,603,604,605,606,607,608,610,611,614,652",extendColumns:"io.ox/mail/api/list"},get:{action:"get",embedded:String(!k),sanitize:String(!L)},getUnmodified:{action:"get",unseen:"true",view:"html",embedded:"true"},search:{action:"search",folder:"default0/INBOX",columns:"601,600,611",extendColumns:"io.ox/mail/api/all",sort:"610",order:"desc",getData:function(e,t){var r={from:603,to:604,cc:605,subject:607,text:-1},n=[];return _(t).each(function(t,i){i in r&&"on"===t&&n.push({col:r[i],pattern:e})}),n}}},cid:function(e){return(e.action||"all")+":"+e.folder+"//"+[e.sort,e.order,e.max||0,!!e.unseen,!!e.deleted].join(".")},filter:function(e){return void 0!==e.folder_id||void 0!==e.folder},pipe:{all:function(e,t){return"102"===t.sort&&(e.sort(M),"desc"===t.order&&e.reverse()),e},get:function(e,t){return _.isObject(e)&&(e.view=t.view),e}},params:{all:function(e){return"thread"===e.sort&&(e.sort=610),e}},simplify:function(e){return e.simplified.unseen=!0,e.simplified}});_.extend(G,e),G.updateViewSettings=function(){G.options.requests.get.view="text",d.get("allowHtmlMessages",!0)&&(G.options.requests.get.view=d.get("allowHtmlImages",!1)?"html":"noimg"),G.trigger("viewChanged")},G.separator=d.get("defaultseparator","/"),G.FLAGS={ANSWERD:1,DELETED:2,DRAFT:4,FLAGGED:8,RECENT:16,SEEN:32,USER:64,SPAM:128,FORWARDED:256},G.COLORS={NONE:0,RED:1,ORANGE:7,YELLOW:10,LIGHTGREEN:6,GREEN:3,LIGHTBLUE:9,BLUE:2,PURPLE:5,PINK:8,GRAY:4},R.get("detail").on("change:flags",function(e){var t=o.isUnseen(e.previous("flags")),r=o.isUnseen(e.get("flags"));t!==r&&i.changeUnseenCounter(e.get("folder_id"),r?1:-1)}),R.get("detail").on("remove",function(e){o.isUnseen(e.get("flags"))&&i.changeUnseenCounter(e.get("folder_id"),-1)});var I=G.get,N=G.getAll,z=G.search;G.get=function(e,t){var r,n=_.isObject(e)?_.cid(e):e,i=R.get("detail").get(n),a=!t||void 0===t.cache||t.cache,o="noimg"===e.view||!e.view;return i&&(r=!!i.get("attachments"),a&&!e.src&&r&&o)?$.when(i.toJSON()):(e.view||(e.view=p(_.extend({},e,i&&i.toJSON()))),e.max_size=d.get("maxSize/view",102400),e.process_plain_text=!1,e.pregenerate_previews=String(O),I.call(G,e,!1).done(function(t){e.src||"raw"===e.view||(delete t.cid,t=y(t),i?(i.set(t),h(i)):R.add("detail",t))}))},G.getAll=function(e,t){return e=e||{},/^default\d+$/.test(e.folder)?$.when([]):("from-to"===e.sort&&(e.sort=a.is("sent|drafts",e.folder)?604:603),N.call(this,e,t))},G.search=function(e,t){return"from-to"===t.sort&&(t.sort=a.is("sent|drafts",t.folder)?604:603),z.call(this,e,t)},G.remove=function(){function e(e,t){"MSG-0039"===t.code&&G.trigger("delete:fail:quota",t,e)}function r(e){return s=s.concat(e),d.promise()}function n(e){var t=[].concat(e);t.forEach(function(e){u[_.cid(e)]=!0}),setTimeout(function(){t.forEach(function(e){delete u[_.cid(e)]}),t=null},15e3)}function o(e,r){return c=!0,t.wait(_.wait(100).then(function(){return t.PUT({module:"mail",params:{action:"delete",harddelete:!!r,returnAffectedFolders:!0,timestamp:_.then()},data:t.simplify(e),appendColumns:!1}).done(function(t){_(t.folders).each(function(e,t){i.pool.getModel(t).set(e)}),G.trigger("delete"),G.trigger("deleted-mails",e),_(e).each(function(e){G.trigger("remove:"+_.ecid(e),e)}),a.is("trash",e[0].folder_id)?G.trigger("deleted-mails-from-trash"):r||w("trash")}).fail(function(){G.trigger("refresh.all")}).always(f)}))}function l(e,t,i){try{return n(e),c&&!i?r(e):o(e,i)}finally{x(e,t)}}var c=!1,s=[],d=$.Deferred(),u={},f=_.debounce(function(){s.length?(o(s).done(d.resolve).fail(d.reject).fail(e.bind(null,s)),s=[],d=$.Deferred()):c=!1},5e3);return l.getRecentlyDeleted=function(){return u},l.isRecentlyDeleted=function(e){return!!u[e]},l}(),G.archive=function(e){if(_.isArray(e)&&0!==e.length)return x(e),t.wait(t.PUT({module:"mail",params:{action:"archive",timestamp:_.then()},data:t.simplify(e)}).done(function(t){_(_(t).pluck("created")).contains(!0)?a.reload().then(function(){return d.reload()}).done(function(){i.refresh(),G.trigger("refresh.all")}):i.reload(_(t).pluck("id")),G.trigger("archive",e)}))},G.archiveFolder=function(e,r){return r=_.extend({action:"archive_folder",folder:e,days:90},r),t.PUT({module:"mail",params:r,appendColumns:!1}).done(function(){i.refresh(),G.trigger("refresh.all"),G.trigger("archive-folder",e)})},G.getAllThreads=function(e,t){return e=e||{},e=$.extend(e,{action:"threadedAll",columns:e.columns||"601,600,611,102",sort:e.sort||"610",sortKey:"threaded-"+(e.sort||"610"),konfetti:!0,order:e.order||"desc",includeSent:!a.is("sent|drafts",e.folder),cache:!1,deleted:P,max:e.max||500}),N.call(this,e,t,null,!1)};var B=function(e,r,n){var i=!1,a=r.folder_id||r.folder;return e=_.isArray(e)?e:[e],t.pause(),_(e).map(function(e){var o=e.folder||e.folder_id;return a&&a!==o&&(i=!0),t.PUT({module:"mail",params:{action:n||"update",id:e.id,folder:o,timestamp:_.then()},data:r,appendColumns:!1})}),t.resume().then(function(t){return _(e).each(function(e){G.trigger("update:"+_.ecid(e),e)}),i&&G.trigger("move"),"copy"===n||i?{list:e,response:t}:(G.trigger("update:after"),e)})};G.update=function(){console.error("Do not call this directly because mail is so special")},G.on("not-found",function(){G.trigger("refresh.list")}),G.expunge=function(e){var r=_(R.getByFolder(e)).chain().map(function(e){return e.filter(function(e){return o.isDeleted(e.attributes)})}).flatten().pluck("cid").compact().value();return G.trigger("beforeexpunge",r),_(R.getByFolder(e)).each(function(e){e.set(e.filter(function(e){return!o.isDeleted(e.toJSON())}))}),t.PUT({module:"mail",appendColumns:!1,params:{action:"expunge"},data:[e]}).done(function(){i.reload(e)})},i.on({"before:clear":function(e){_(R.getByFolder(e)).each(function(e){e.reset([])})},"clear remove:mail":function(){var e=a.getFoldersByType("trash");_(e).each(function(e){i.list(e,{cache:!1}),_(R.getByFolder(e)).invoke("expire")})},"changesAfterReloading:mail":function(e){(_(e.changed).has("unread")||_(e.changed).has("total"))&&(_(R.getByFolder(e.id)).invoke("expire"),G.trigger("changesAfterReloading"))}}),G.changeColor=function(e,r){return e=[].concat(e),r=String(r),_(e).each(function(e){e.color_label=r,R.propagate("change",{id:e.id,folder_id:e.folder_id,color_label:parseInt(r,10)||0}),G.threads.touch(e),G.trigger("update:"+_.ecid(e),e)}),t.wait(B(e,{color_label:r})).done(function(){S(e,102)})},G.flag=function(e,t){return e=[].concat(e),_.isUndefined(t)&&(t=_(e).reduce(function(e,t){return!0===e||!o.isFlagged(t)},!1)),_(e).each(function(r){r.flags=t?8|r.flags:-9&r.flags,R.propagate("change",{id:r.id,folder_id:r.folder_id,flags:r.flags}),G.threads.touch(r),G.trigger("update:"+_.ecid(r),r),G.trigger("refresh.flag",e)}),B(e,{flags:G.FLAGS.FLAGGED,value:t}).done(function(){S(e,651),i.reload(e)})},G.markUnread=function(e){return e=[].concat(e),_(e).each(function(t){t.flags=-33&t.flags,R.propagate("change",{id:t.id,folder_id:t.folder_id,flags:t.flags}),G.threads.touch(t),G.trigger("update:"+_.ecid(t),t),G.trigger("refresh.unseen",e)}),B(e,{flags:G.FLAGS.SEEN,value:!1}).done(function(){S(e,651),i.reload(e),G.trigger("after:refresh.unseen",e)})},G.markRead=function(e){e=[].concat(e);var t=!a.is("spam|confirmed_spam|trash",e[0].folder_id);return _(e).each(function(t){t.flags=32|t.flags,R.propagate("change",{id:t.id,folder_id:t.folder_id,flags:t.flags,unseen:!1}),G.threads.touch(t),G.trigger("update:"+_.ecid(t),t),G.trigger("refresh.seen",e),G.trigger("update:set-seen",e)}),B(e,{flags:G.FLAGS.SEEN,value:!0,collect_addresses:t}).done(function(){S(e,651),i.reload(e),G.trigger("after:refresh.seen",e)})},G.allSeen=function(e){return R.get("detail").each(function(t){var r=t.toJSON();r.folder_id===e&&o.isUnseen(r)&&(R.propagate("change",{id:r.id,folder_id:r.folder_id,flags:32|r.flags}),G.threads.touch(r))}),G.trigger("update:set-seen",e),t.PUT({module:"mail",params:{action:"all_seen",folder:e},appendColumns:!1}).done(function(){G.trigger("after:all-seen",e),i.reload(e)})},G.markSpam=function(e){return b(e,!0)},G.noSpam=function(e){return b(e,!1)},G.move=function(e,t,r){try{return E("update",e,t)}finally{x(e,r)}},G.moveAll=function(e,r){return _(R.getByFolder(e)).each(function(e){e.reset([]),e.setComplete(!0)}),t.wait(t.PUT({module:"mail",appendColumns:!1,params:{action:"move_all"},data:{source:e,target:r}})).done(function(){i.reload([e,r])})},G.copy=function(e,t){return E("copy",e,t)},G.autosave=function(e){G.trigger("before:autosave",{data:e});try{var r={action:"autosave",lineWrapAfter:0};return e.security&&e.security.decrypted&&(r.decrypt=!0,e.security.authentication&&(r.authToken=e.security.authentication)),t.wait(t.PUT({module:"mail",params:r,data:e,appendColumns:!1}).then(function(e){var t=a.getFoldersByType("drafts");return R.resetFolder(t),i.reload(t),G.trigger("autosave"),e}))}finally{e.msgref&&x(o.parseMsgref(G.separator,e.msgref))}},G.keepalive=function(e){return t.GET({module:"file",params:{action:"keepalive",id:e}})},G.getUnmodified=function(e){if("folder_id"in e||"folder"in e)return this.get({action:"get",id:e.id,folder:e.folder||e.folder_id,view:"html",decrypt:e.security&&e.security.decrypted},!1).then(y);if("parent"in e){var t=e.id,r=e.parent;return this.get({action:"get",id:e.parent.id,folder:e.parent.folder||e.parent.folder_id,view:"html",decrypt:e.security&&e.security.decrypted},!1).then(function(e){return _.chain(e.nested_msgs).filter(function(e){return e.id===t&&(e.parent=r,!0)}).first().value()}).then(y)}return console.error("api.getUnmodified(). Invalid case.",e),$.Deferred().resolve(e)},G.getSource=function(e){return this.get({action:"get",id:e.id,src:!0,folder:e.folder||e.folder_id,view:"html",embedded:!1},!1)},G.fetchTextPreview=function(e){return t.fixList(e,t.PUT({module:"mail",params:{action:"list",columns:"600,601,663",timezone:"utc",deleted:P},data:t.simplify(e)})).then(function(e){var t={};return _(e).each(function(e){t[_.cid(e)]=e.text_preview||""}),t})},G.saveAttachments=function(e,n){return n=n||r.get("folder/infostore"),e=_.isArray(e)?e:[e],t.pause(),_(e).each(function(e){var r={action:"attachment",id:e.mail.id,folder:e.mail.folder_id,dest_folder:n,attachment:e.id,decrypt:e.security&&e.security.decrypted};e.security&&e.security.authentication&&(r.cryptoAuth=e.security.authentication),e.reEncrypt&&(r.encrypt=!0),t.PUT({module:"mail",params:r,data:{folder_id:n,description:u("Saved mail attachment")},appendColumns:!1})}),t.resume().done(function(){require(["io.ox/files/api"],function(e){e.pool.resetFolder(n),e.trigger("add:file")})})},G.getUrl=function(e,t,r){var n,i=_.extend({scaleType:"contain",session:!0},r),a=ox.apiRoot+"/mail";if("zip"===t)return n=_(e).first(),a+"?"+$.param({action:"zip_attachments",folder:(n.parent||n.mail).folder_id,id:(n.parent||n.mail).id,attachment:_(e).pluck("id").join(","),decrypt:n.security&&n.security.decrypted,session:ox.session});if("eml:reference"===t)return this.getUrl(_([].concat(e)).first().parent,"eml");if("eml"===t)return e=[].concat(e),n=_(e).first(),e.length>1?a+"?"+$.param({action:"zip_messages",folder:n.folder_id,id:_(e).pluck("id").join(","),session:ox.session}):a+=(n.subject?"/"+encodeURIComponent(n.subject.replace(/[\\:/]/g,"_")+".eml"):"")+"?"+$.param($.extend(G.reduce(n),{action:"get",src:1,save:1,session:ox.session}));if(e.space)return a=ox.apiRoot+"/mail/compose/"+e.space+"/attachments/"+e.id,i.session&&(a+="?session="+ox.session),a;var o=e.filename?e.filename.replace(/[\\:/]/g,"_").replace(/\(/g,"%28").replace(/\)/,"%29"):void 0,l=i.width&&i.height?"&scaleType="+i.scaleType+"&width="+i.width+"&height="+i.height:"";switch(a+=(e.filename?"/"+encodeURIComponent(o):"")+"?"+$.param({action:"attachment",folder:(e.parent||e.mail).folder_id,id:(e.parent||e.mail).id,attachment:e.id,user:ox.user_id,context:ox.context_id,sequence:1,session:ox.session}),e.security&&e.security.decrypted&&(a+="&decrypt=true",e.security.authentication&&(a+="&cryptoAuth="+encodeURIComponent(e.security.authentication))),t){case"view":case"open":a+="&delivery=view"+l;break;case"download":a+="&delivery=download"}return a},G.getNestedMail=function(e){return t.GET({module:"mail",params:{action:"attachment",folder:(e.parent||e.mail).folder_id,id:(e.parent||e.mail).id,attachment:e.id,as_json:!0}})};var j=0;return G.checkInbox=function(){if(!ox.openedInBrowserTab)return t.GET({module:"mail",params:{action:"all",folder:"default0/INBOX",columns:"610,600,601,611",unseen:"true",deleted:"false",sort:"610",order:"desc",limit:100,timezone:"utc"}}).then(function(e){var t=_(e).filter(function(e){return e.received_date>j&&2!=(2&e.flags)});return G.trigger("new-mail",t,e),t.length>0?(j=t[0].received_date,G.newMailTitle(!0)):j=(new moment).valueOf(),{unseen:e,recent:t||[]}})},G.refresh=function(){if(ox.online&&f.has("webmail")&&!ox.openedInBrowserTab)return G.checkInbox().always(function(){G.trigger("refresh.all")})},G.getDefaultFolder=function(){return i.getDefaultFolder("mail")},G.getAccountIDFromFolder=function(e){return/^default(\d*)\b/.exec(e)[1]},G.beautifyMailText=function(e,t){return t=t||500,e=String(e).replace(/(\r\n|\n|\r)/gm,"").substr(0,t).replace(/-{3,}/g,"---").replace(/<br\s?\/?>(&gt;)+/gi," ").replace(/<br\s?\/?>/gi," ").replace(/<[^>]+(>|$)/g,"").replace(/(http(s?):\/\/\S+)/i,'<a href="$1" target="_blank" rel="noopener">http$2://...</a>').replace(/&#160;/g," ").replace(/\s{2,}/g," "),$.trim(e)},G.importEML=function(e){var r=e.folder||G.getDefaultFolder(),n=new FormData;return n.append("file",e.file),t.UPLOAD({module:"mail",params:{action:"import",folder:r,force:!0},data:n,fixPost:!0}).done(function(){R.resetFolder(r),i.reload(r),G.trigger("refresh.all")})},G.ack=function(e){return a.getPrimaryAddressFromFolder(e.folder).then(function(r){var n=r[0],i=r[1],a=n?'"'+n+'" <'+i+">":i;return t.PUT({module:"mail",params:{action:"receipt_ack"},data:_.extend({from:a},e)})})},d.on("change:allowHtmlMessages change:allowHtmlImages change:isColorQuoted",function(){R.get("detail").each(function(e){e.unset("attachments",{silent:!0}),e.unset("security",{silent:!0})})}),d.on("change:allowHtmlMessages",function(e){G.options.requests.get.view=e?"noimg":"text"}),a.on("refresh.all create:account",function(){i.list("1",{cache:!1}).done(function(){i.pool.unfetch()})}),i.on("create",function(e){"mail"===e.module&&G.refresh()}),G.newMailTitle=function(){function e(){document.title=(i=!i)?u("New mail"):document.customTitle}function t(){n||(n=setInterval(e,1500))}function r(){document.customTitle&&(document.title=document.customTitle),n&&(clearInterval(n),n=null)}var n=null,i=!1;return $(s).on("visibility-changed",function(e,t){!1===t.currentHiddenState&&r()}),function(e){!_.device("smartphone")&&s.isHidden&&(!0===e?t():r())}}(),G.pool=R,G.resolve=function(){function e(e){return e=String(e).replace(/^thread\./,""),R.get("detail").get(e)}return function(t,r){return r?G.threads.resolve(t):_(t).chain().map(e).compact().invoke("toJSON").value()}}(),G.threads={hash:{},reverse:{},collection:{},contains:function(e){return!!this.hash[e]},getModels:function(e){if(!_.isString(e))return[];var t=this.hash[e]||[e];return _.isEmpty(this.collection)&&(this.collection=R.get("detail")),_(t).chain().map(this.collection.get,this.collection).compact().value()},get:function(e){return _(this.getModels(e)).chain().invoke("toJSON").map(function(e,t){return e.index=t,e}).value()},head:function(e){return e.head||e},touch:function(e){e=_.isString(e)?e:_.cid(e);var t=this.reverse[e];t&&t!==e&&R.propagate("change",_.extend({timestamp:_.now()},_.cid(t)))},resolve:function(e){return _(e).chain().map(function(e){e=String(e).replace(/^thread\.(.+)$/,"$1");var t=G.threads.get(e);return t.length>0&&t}).flatten().compact().value()},clear:function(){this.hash={},this.reverse={}},add:function(e){var t=_.cid(e);this.hash[t]=e.thread||[t],_(this.hash[t]).each(function(e){this.reverse[e]=t},this)},remove:function(e){e=_.isString(e)?e:_.cid(e);var t=this.reverse[e];t&&this.hash[t]&&(this.hash[t]=_(this.hash[t]).without(e))},size:function(e){e=_.isString(e)?e:_.cid(e);var t=this.reverse[e];return t?(this.hash[t]||[e]).length:1},subject:function(e){if(!this.collection.get)return"";e=_.isString(e)?e:_.cid(e);var t,r,n;return t=this.reverse[e],r=_(this.hash[t]).first(),(n=this.collection.get(r))&&n.get("subject")?n.get("subject"):(n=this.collection.get(t))?n.get("subject"):""},append:function(e,t){var r=this.reverse[e];r&&((this.hash[r]=this.hash[r]||[]).unshift(t),this.touch(r))}},G.pool.getDependentModels=function(e){return G.threads.getModels(e)},G.allMessagesFolder=d.get("allMessagesFolder","default0/virtual/all"),G.getAllUnseenMessages=function(){return t.GET({module:"mail",params:{action:"all",folder:G.allMessagesFolder,columns:"600,654,655",sort:"610",order:"desc",unseen:!0,deleted:!1,timezone:"utc"}})},G.collectionLoader=new c({module:"mail",getQueryParams:function(e){return"virtual/all-unseen"===e.folder?{action:"all",folder:G.allMessagesFolder,columns:t.defaultColumns.mail.unseen,sort:"610",order:"desc",unseen:!0,deleted:!1,timezone:"utc"}:!0===e.thread?{action:"threadedAll",folder:e.folder,categoryid:e.category_id||e.categoryid,columns:t.defaultColumns.mail.all,sort:e.sort||"610",order:e.order||"desc",includeSent:!a.is("sent|drafts",e.folder),max:(e.offset||0)+300,deleted:P,timezone:"utc"}:{action:"all",folder:e.folder,categoryid:e.category_id||e.categoryid,columns:t.defaultColumns.mail.all,sort:e.sort||"610",order:e.order||"desc",deleted:P,timezone:"utc"}},filter:function(e){return!G.remove.isRecentlyDeleted(_.cid(e))},fail:function(e){return G.trigger("error error:"+e.code,e),e},httpGet:function(e,r){var n=r.folder===G.allMessagesFolder&&!0===r.unseen;return n&&(r.limit="0,250"),t.GET({module:e,params:r}).then(function(e){return n?_(e).filter(T):e})},PRIMARY_PAGE_SIZE:d.get("listview/primaryPageSize",50),SECONDARY_PAGE_SIZE:d.get("listview/secondaryPageSize",200)}),G.processThreadMessage=function(e){var t,r=F(e);0===(r=_(t=r).filter(A)).length&&(r=t.slice(0,1)),_(r.concat(e)).each(U);var n=_(r).last(),i=r.length;e.head=_({threadSize:i}).chain().extend(e).omit("index").value(),_.extend(e,n),e.thread=_(r).map(_.cid),e.threadSize=i,n.thread=_(r).map(_.cid),G.threads.add(e),G.pool.add("detail",r)},G.collectionLoader.noSelect=function(e){return!!/^default\d+$/.test(e.folder)||e.folder!==G.allMessagesFolder&&!i.pool.getModel(e.folder).can("read")},G.collectionLoader.each=function(e,t,r,n){e["X-Open-Xchange-Share-URL"]&&!e.headers&&(e.headers={"X-Open-Xchange-Share-URL":e["X-Open-Xchange-Share-URL"]},delete e["X-Open-Xchange-Share-URL"]),"threadedAll"===n.action?G.processThreadMessage(e):G.pool.add("detail",e)},G.mailServerDownMessage=u("Unable to connect to mail server. Possible reasons: The mail server is (temporarily) down or there are network connection problems. Please try again in a few minutes."),G});