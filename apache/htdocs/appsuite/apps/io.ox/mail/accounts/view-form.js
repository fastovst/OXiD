define.async("io.ox/mail/accounts/view-form",["io.ox/core/notifications","io.ox/core/api/account","settings!io.ox/mail","gettext!io.ox/settings","io.ox/core/extensions","io.ox/backbone/mini-views","io.ox/core/folder/picker","io.ox/core/capabilities","io.ox/core/settings/util","settings!io.ox/core"],function(e,t,o,a,n,s,r,l,i,d){"use strict";function c(){var e=_(arguments).toArray();return $('<div class="form-group">').append(e)}function p(e,t){return $('<label class="control-label col-sm-4">').attr("for",e).text(t)}function m(){var e=_(arguments).toArray();return $('<div class="col-sm-7">').append(e)}function u(e,t,o){return $('<div class="col-sm-offset-4 col-sm-7">').append(i.checkbox(e,t,o))}var g,h,f="io.ox/settings/accounts/mail/settings/detail",v=[{label:"IMAP",value:"imap"},{label:"POP3",value:"pop3"}],b={imap:{common:"143",secure:"993"},pop3:{common:"110",secure:"995"}},w=[{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"30",value:"30"},{label:"60",value:"60"},{label:"360",value:"360"}],y=[{value:"mail",label:a("As incoming mail server")},{value:"custom",label:a("Use separate username and password")},{value:"none",label:a("None")}],x=[{value:"none",label:a("None")},{value:"starttls",label:a("StartTLS")},{value:"ssl",label:a("SSL/TLS")}],S={mail_port:"143",transport_port:"587"},M={pop3:{pop3_refresh_rate:w[0].value,pop3_delete_write_through:!1,pop3_expunge_on_quit:!1}},C={onChange:function(){this.model.set(this.name,this.$el.val(),{validate:!1})}},A=s.InputView.extend(C),P=s.PasswordView.extend(C),k=function(){var e=g.get("mail_secure"),t=g.get("mail_protocol")||"imap";return b[t][e?"secure":"common"]},T=function(e,t,o){return e.get(t)?"ssl":e.get(o)?"starttls":"none"},V="",N=["personal","name","unified_inbox_enabled","archive_fullname","confirmed-ham_fullname","confirmed-spam_fullname","drafts_fullname","sent_fullname","spam_fullname","trash_fullname"],D=Backbone.View.extend({tagName:"div",initialize:function(){l.has("pop3")||this.model.get("id")||(v=[{label:"IMAP",value:"imap"}]),this.inSync=!1;var e=this.model.get("personal");e?" "===e&&this.model.set("personal",""):this.model.set("personal",V),this.selectionModel=new Backbone.Model({mail_secure:T(this.model,"mail_secure","mail_starttls"),transport_secure:T(this.model,"transport_secure","transport_starttls")}),this.listenTo(this.selectionModel,"change:mail_secure",this.onMailSecureChange.bind(this)),this.listenTo(this.selectionModel,"change:transport_secure",this.onTransportSecureChange.bind(this)),h=_.copy(this.model.toJSON(),!0),Backbone.Validation.bind(this,{selector:"name",forceUpdate:!0})},render:function(){function e(e,t){e.set("login",t,{validate:!0})}var t=this;g=t.model,t.$el.empty().append($('<div class="settings-detail-pane">').append($('<div class="io-ox-account-settings">'))),n.point(f+"/pane").invoke("draw",t.$el.find(".io-ox-account-settings"),this);var o=t.$el.find(".form-group.pop3"),a=t.$el.find("#mail_protocol");"pop3"!==t.model.get("mail_protocol")&&o.hide(),!t.model.get("id")&&l.has("pop3")||a.prop("disabled",!0),void 0===t.model.get("id")&&_.each(S,function(e,t){g.set(t,e)}),0!==t.model.get("id")?(t.model.on("change:mail_protocol",function(e,t){"pop3"!==t?o.hide():(_.each(M.pop3,function(t,o){e.has(o)||e.set(o,t)}),o.show())}),void 0===t.model.get("login")&&""!==t.model.get("primary_address")&&t.model.set("login",t.model.get("primary_address"),{validate:!0}),t.model.get("primary_address")!==t.model.get("login")||t.inSync||(t.model.on("change:primary_address",e),t.inSync=!0),t.model.on("change:login",function(o,a){a===o.get("primary_address")?t.inSync||(t.model.on("change:primary_address",e),t.inSync=!0):(t.model.off("change:primary_address",e),t.inSync=!1)})):t.$el.find("input, select").not('#personal, #name, [name="unified_inbox_enabled"]').prop("disabled",!0);var s=_.isNumber(g.get("mail_oauth"))&&g.get("mail_oauth")>-1,r=_.isNumber(g.get("transport_oauth"))&&g.get("transport_oauth")>-1;return(s||r)&&t.$el.find("#primary_address").prop("disabled",!0),s&&t.$el.find(".data_incoming").hide(),r&&t.$el.find(".data_outgoing").hide(),t},events:{save:"onSave","click .folderselect":"onFolderSelect",'change [name="mail_protocol"]':"onMailProtocolChange"},onMailProtocolChange:function(){g.set("mail_port",k())},onMailSecureChange:function(){g.set("mail_secure","ssl"===this.selectionModel.get("mail_secure")),g.set("mail_starttls","starttls"===this.selectionModel.get("mail_secure")),g.set("mail_port",k())},onTransportSecureChange:function(){g.set("transport_secure","ssl"===this.selectionModel.get("transport_secure")),g.set("transport_starttls","starttls"===this.selectionModel.get("transport_secure"));var e="ssl"===this.selectionModel.get("transport_secure")?"465":"587";this.model.set("transport_port",e)},onSave:function(){function t(){var t=o.model.get("personal");t===V?o.model.set("personal",null,{silent:!0}):""===$.trim(t)&&o.model.set("personal"," ",{silent:!0}),o.model.save().then(function(t){o.dialog.close(),o.collection&&o.collection.add([t]),o.model.isNew()?o.success():e.yell("success",a("Account updated"))},function(t){"ACC-0004"===t.code&&"login"===t.error_params[0].substring(8,13)?e.yell("error",a("Username must not be empty.")):"SVL-0002"===t.code?e.yell("error",a("Please enter the following data: %1$s",t.error_params[0])):e.yell("error",t.error),o.dialog.idle()})}var o=this;!function(e){return!!l.has("multiple_mail_accounts")&&!!_.difference(e,N).length}(function(e,t){var o=[];return _.each(e,function(e,a){t[a]!==e&&o.push(a)}),o}(this.model.attributes,h))?t():this.model.validationCheck().done(function(n,s){var r=_.isUndefined(n)||!!s&&[].concat(s.categories||[]).indexOf("ERROR")>-1,l=s&&s.warnings;r?(e.yell(s),o.dialog.idle()):l?require(["io.ox/backbone/views/modal"],function(e){var n=_.map([].concat(s.warnings),function(e){return $('<div class="alert alert-warning" style="margin: 10px">').text(e.error)});o.dialog.pause();var r=new e({title:a("Warnings")}).build(function(){this.$body.append(n)}).addCancelButton().addButton({action:"proceed",label:a("Ignore Warnings")}).on("action",function(e){o.dialog.resume(),"proceed"===e?t():"inspect"===e?require(["io.ox/settings/security/certificates/settings/utils"]).done(function(e){e.openExaminDialog(s,o.dialog)}):o.dialog.idle()});/SSL/.test(s.code)&&d.get("security/manageCertificates")&&r.addButton({label:a("Inspect certificate"),action:"inspect"}),r.open()}):t()})},onFolderSelect:function(e){this.dialog.pause();var t="default"+this.model.get("id"),o=$(e.currentTarget).attr("data-property"),a=this.model.get(o),n=this;r({async:!0,context:"account",done:function(e,t){n.model.set(o,e,{validate:!0}),t.close()},folder:a,module:"mail",realNames:!0,root:t})}});return n.point(f+"/pane").extend({index:100,id:"header",draw:function(e){function t(){"mail"===this.model.get("transport_auth")&&this.model.set({transport_login:g.get("login"),transport_password:null})}function o(){var e=this.model.get("transport_auth");this.$el.find("#transport_login, #transport_password").prop("disabled","custom"!==e).attr("data-state","manual"),"mail"===e?t.call(this):"mail"===this.model.previous("transport_auth")&&this.model.set({transport_login:"",transport_password:""})}var n=$('<fieldset class="data_incoming">').append($('<legend class="sectiontitle">').text(a("Incoming server")),$('<form class="form-horizontal">').append(c(p("mail_protocol",a("Server type")),$('<div class="col-sm-3">').append(new s.SelectView({list:v,model:g,id:"mail_protocol"}).render().$el)),c(p("mail_server",a("Server name")),m(new A({model:g,id:"mail_server",mandatory:0!==g.get("id")}).render().$el)),c(p("mail_secure",a("Connection security")),$('<div class="col-sm-3">').append(new s.SelectView({list:x,model:e.selectionModel,id:"mail_secure"}).render().$el)),c(p("mail_port",a("Server port")),$('<div class="col-sm-3">').append(new A({model:g,id:"mail_port",mandatory:0!==g.get("id")}).render().$el)),c(p("login",a("Username")),m(new A({model:g,id:"login",mandatory:0!==g.get("id")}).render().$el)),c(p("password",a("Password")),m(new P({model:g,id:"password",mandatory:void 0===g.get("id"),autocomplete:!1}).render().$el)),c(p("pop3_refresh_rate",a("Refresh rate in minutes")),m(new s.SelectView({list:w,model:g,id:"pop3_refresh_rate"}).render().$el)).addClass("pop3"),c(u("pop3_expunge_on_quit",a("Remove copy from server after retrieving a message"),g)).addClass("pop3"),c(u("pop3_delete_write_through",a("Deleting messages on local storage also deletes them on server"),g)).addClass("pop3"))),r=$('<fieldset class="data_outgoing">').append($('<legend class="sectiontitle">').text(a("Outgoing server (SMTP)")),$('<form class="form-horizontal">').append(c(p("transport_server",a("Server name")),m(new A({model:g,id:"transport_server",mandatory:0!==g.get("id")}).render().$el)),c(p("transport_secure",a("Connection security")),$('<div class="col-sm-3">').append(new s.SelectView({list:x,model:e.selectionModel,id:"transport_secure"}).render().$el)),c(p("transport_port",a("Server port")),$('<div class="col-sm-3">').append(new A({model:g,id:"transport_port",mandatory:0!==g.get("id")}).render().$el)),c(p("transport_auth",a("Authentication")),m(new s.SelectView({list:y,model:g,id:"transport_auth"}).render().$el)),c(p("transport_login",a("Username")),m(new A({model:g,id:"transport_login"}).render().$el)),c(p("transport_password",a("Password")),m(new P({model:g,id:"transport_password",autocomplete:!1}).render().$el)))),i={sent:a.pgettext("folder","Sent messages"),trash:a.pgettext("folder","Deleted messages"),drafts:a.pgettext("folder","Drafts"),spam:a.pgettext("folder","Spam"),archive:a.pgettext("folder","Archive")},d=$('<fieldset class="data_folders">').append($('<legend class="sectiontitle">').text(a("Standard folders")),$('<form class="form-horizontal">').append(_("sent trash drafts spam archive".split(" ")).map(function(e){if("archive"!==e||l.has("archive_emails")){var t=i[e],o=void 0!==g.get("id");return e+="_fullname",c(p(e,t),$('<div class="col-sm-7">').append(o?$('<div class="input-group folderselect enabled">').attr("data-property",e).append(new A({model:g,id:e}).on("update",function(t){t&&_.isString(this.model.get(e))&&t.val(this.model.get(e).replace(/^default\d+\D/,""))}).render().$el.prop("disabled",!0),$('<span class="input-group-btn">').append($('<button type="button" class="btn btn-default">').text(a("Select")))):$('<input type="text" class="form-control" disabled="disabled">').val($.trim(g.get(e)).replace(/^default\d+\D/,""))))}})));this.append($('<fieldset class="data_account">').append($('<legend class="sectiontitle">').text(a("Account settings")),$('<form class="form-horizontal">').append(c(p("name",a("Account name")),m(new A({model:g,id:"name",mandatory:!0}).render().$el)),c(p("personal",a("Your name")),m(new A({model:g,id:"personal"}).render().$el)),c(p("primary_address",a("Email address")),m(new A({model:g,id:"primary_address",mandatory:!0}).render().$el)),l.has("!multiple_mail_accounts")||l.has("!unified-mailbox")?$():c(u("unified_inbox_enabled",a("Use unified mail for this account"),g))))),g.isHidden()||(this.append(n,r),e.listenTo(g,"change:transport_auth",o),e.listenTo(g,"change:login",t),o.call(e)),void 0!==g.get("id")&&this.append(d)}}),t.getDefaultDisplayName().then(function(e){return V=e,D})});