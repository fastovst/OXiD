define("io.ox/mail/accounts/model",["io.ox/core/extensions","io.ox/keychain/model","io.ox/core/api/account","io.ox/core/folder/api","io.ox/backbone/validation","gettext!io.ox/keychain"],function(e,i,t,n,r,a){"use strict";return i.Account.extend({defaults:{spam_handler:"NoSpamHandler",transport_auth:"mail",transport_password:null},validation:{name:{required:!0,msg:a("The account must be named")},primary_address:[{required:!0,msg:a("This field is mandatory")},{fn:"isMailAddress"}],login:function(e){if(0!==this.attributes.id&&""===$.trim(e))return a("This field is mandatory")},password:function(e){if(void 0===this.attributes.id&&(!e||""===e))return a("This field is mandatory")},mail_server:{required:function(){return!this.isHidden()},msg:a("This field is mandatory")},mail_port:[{required:function(){return!this.isHidden()},msg:a("This field is mandatory")},{fn:function(e){var i=r.formats.number(e);return!0!==i&&i}}],transport_server:{required:function(){return!this.isHidden()},msg:a("This field is mandatory")},transport_port:[{required:function(){return!this.isHidden()},msg:a("This field is mandatory")},{fn:function(e){var i=r.formats.number(e);return!0!==i&&i}}]},isHidden:function(){return 0===this.attributes.id&&!this.attributes.mail_server},isMailAddress:function(e){if(!/@/.test(e))return a("This is not a valid email address")},initialize:function(){},validationCheck:function(e,i){return e=_.extend({unified_inbox_enabled:!1,transport_auth:"mail"},e||this.toJSON()),e.name=e.personal=e.primary_address,"mail"===e.transport_auth&&(delete e.transport_login,delete e.transport_password),t.validate(e,i)},save:function(e){var i=this.get("id"),r=this;return void 0!==i?t.get(i).then(function(e){var a={id:i},s=0===i?["personal","name","unified_inbox_enabled","sent_fullname","trash_fullname","drafts_fullname","spam_fullname","archive_fullname"]:r.keys();return _(r.pick(s)).each(function(i,t){_.isEqual(i,e[t])||(a[t]=i)}),"mail"===r.get("transport_auth")&&(delete a.transport_login,delete a.transport_password),t.update(a).done(function(){var e=$.when();n.pool.unfetch("default"+i),void 0!==a.unified_inbox_enabled?e=require(["settings!io.ox/mail"]).then(function(e){return e.reload()}).then(function(){n.pool.unfetch("1")}):0===i&&(e=require(["settings!io.ox/mail"]).then(function(e){return e.reload()})),e.then(function(){n.refresh()})})}).then(function(){r.trigger("sync",r)}):(e&&((e=_.extend({unified_inbox_enabled:!1},e)).name=e.primary_address,r.attributes=e,r.attributes.spam_handler="NoSpamHandler"),t.create(r.attributes))},destroy:function(){t.remove([this.attributes.id])}})});