define("io.ox/mail/util",["io.ox/core/extensions","io.ox/core/util","io.ox/core/api/account","io.ox/core/capabilities","settings!io.ox/mail","settings!io.ox/contacts","gettext!io.ox/core"],function(e,t,n,r,a,i,s){"use strict";var o,u=[{label:"System",font:"-apple-system,BlinkMacSystemFont,helvetica,sans-serif"},{label:"Andale Mono",font:"andale mono,times"},{label:"Arial",font:"arial,helvetica,sans-serif"},{label:"Arial Black",font:"arial black,avant garde"},{label:"Book Antiqua",font:"book antiqua,palatino"},{label:"Comic Sans MS",font:"comic sans ms,sans-serif"},{label:"Courier New",font:"courier new,courier"},{label:"Georgia",font:"georgia,palatino"},{label:"Helvetica",font:"helvetica"},{label:"Impact",font:"impact,chicago"},{label:"Symbol",font:"symbol"},{label:"Tahoma",font:"tahoma,arial,helvetica,sans-serif"},{label:"Terminal",font:"terminal,monaco"},{label:"Times New Roman",font:"times new roman,times"},{label:"Trebuchet MS",font:"trebuchet ms,geneva"},{label:"Verdana",font:"verdana,geneva"},{label:"Webdings",font:"webdings"},{label:"Wingdings",font:"wingdings,zapf dingbats"}],l=ox.serverConfig.prefix||"/ajax",c=new RegExp('(<img[^>]+src=")'+l,"g"),f=function(e,t,n){return n>1?t:e},d=function(e,t){if(!_.isNumber(e))return s("unknown");var n=$.extend({fulldate:!1,filtertoday:!0},t||{}),r=moment(e),a=function(){return r.format("LT")};if(n.filtertoday&&moment().isSame(r,"day"))return a();if(n.smart){var i=moment().startOf("day").diff(moment(e).startOf("day"),"day");if(1===i)return s("Yesterday");if(i<=6)return r.format("dddd")}return r.format("l")+(n.fulldate?" "+a():"")},m=function(e){return(e=$.trim(e||"")).indexOf("@")>-1?e.toLowerCase():e},p=/([^,;"]+|"(\\.|[^"])+")+/,g=/^[,;\s]+/,h=/^("(\\.|[^"])+"\s|[^<]+)(<[^>]+>)$/,y=/(^<|>$)/g,v={};return n.getAllSenderAddresses().done(function(e){_(e).chain().pluck(1).each(function(e){v[e.toLowerCase()]=!0})}),o={replaceImagePrefix:function(e,t){return e=e||"",t=t||"$1"+ox.apiRoot,e.replace(c,t)},parseRecipient:function(e,n){var r,a,i,s=$.trim(e),o=_.extend({localpart:!0},n);return null!==(r=s.match(h))?(i=r[3].replace(y,"").toLowerCase(),a=t.unescapeDisplayName(r[1])):(a=(i=s.replace(y,"").toLowerCase()).split(/@/)[0],o.localpart||(a=null)),[a,i]},parseRecipients:function(e,t){var n,r,a=[],i=t;if(!e)return a;for(;null!==(n=e.match(p));)e=e.substr(n[0].length).replace(g,""),((r=this.parseRecipient(n[0],i))[0]===r[1]||r[1].indexOf("@")>-1)&&a.push(r);return a},serializeList:function(e,n){for(var r,a,i,s=e[n=n||"from"]||[["",""]],o=0,u=s.length,l=$("<div>");o<u;o++)r={display_name:this.getDisplayName(s[o])},"undisclosed-recipients:;"!==(a=String(s[o][1]||"").toLowerCase())&&(r.email=a),i=t.renderPersonalName(r),r.email&&i.addClass("person-link person-"+n),l.append(i),o<u-1&&l.append($('<span class="delimiter">').text(",   "));return l.contents()},serializeAttachments:function(e,t){for(var n=0,r=t.length,a=$(),i="",s="";n<r;n++)i=t[n].filename||"",s=ox.apiRoot+"/mail?"+$.param({action:"attachment",folder:e.folder_id,id:e.id,attachment:t[n].id,delivery:"download"}),a=a.add($('<a class="attachment-link" target="_blank">').attr("href",s).text(i)),n<r-1&&(a=a.add($('<span class="delimiter">').append($.txt(" • "))));return a},getFontFormats:function(){return a.get("tinyMCE/font_formats",u.map(function(e){return e.label+"="+e.font}).join(";"))},getDefaultStyle:function(){var e=_.device("smartphone")?{}:a.get("defaultFontStyle",{}),t={css:{},string:"",node:$()};return e.size&&"browser-default"!==e.size&&(t.css["font-size"]=e.size),e.family&&(t.css["font-family"]="browser-default"!==e.family?e.family:u[0].font),e.color&&"transparent"!==e.color&&(t.css.color=e.color),t.string=_.reduce(_.pairs(t.css),function(e,t){return e+t[0]+":"+t[1]+";"},""),t.node=$("<div>").css(t.css).attr("data-mce-style",t.string).append("<br>"),t},getDisplayName:function(e,n){if(!_.isArray(e))return"";n=_.extend({reorderDisplayName:!0,showDisplayName:!0,showMailAddress:!1,unescapeDisplayName:!0},n);var r=e[0],a=String(e[1]||"").toLowerCase(),i=r;return n.unescapeDisplayName&&(i=t.unescapeDisplayName(r)),n.showDisplayName?(n.reorderDisplayName&&(i=i.replace(/^([^,.()]+),\s([^,.()]+)$/,"$2 $1")),n.showMailAddress&&i&&a&&(i+=" <"+a+">"),i||a):a},getSender:function(e,t){var n=e[1];if(!t)return[null,n];var r=a.get(["customDisplayNames",n],{});return[(r.overwrite?r.name:e[0]||r.defaultName)||"",n]},hasFrom:function(e){return e&&_.isArray(e.from)&&e.from.length>0&&!!e.from[0][1]},getFrom:function(e,n){e=e||{},n=_.extend({field:"from"},n);var r=_(e[n.field]).chain().map(function(e){return o.getDisplayName(e,n)}).filter(function(e){return""!==e}).value();return 0===r.length?$().add($.txt(s("from"===n.field?"Unknown sender":"No recipients"))):(r=_(r).reduce(function(e,n){return e.add(t.renderPersonalName({name:n}).addClass("person")).add($.txt(", "))},$())).slice(0,-1)},formatSender:function(e,n,r){var a=_(arguments).toArray();return _.isArray(a[0])&&(r=n,e=a[0][0],n=a[0][1]),e=t.unescapeDisplayName(e),n=m(n),""===e?n:(!1===r?e:'"'+e+'"')+" <"+n+">"},getSubject:function(e,t){var n=$.trim(_.isString(e)?e:e.subject);return""===n?s("No subject"):(a.get("features/cleanSubjects",!1)&&(n=n.replace(/\[[^[]*\]\s*/g,"")),t?n:n.replace(/^((re|ref|aw|fwd|wg|rv|tr)(\[\d+\])?:\s?)+/i,""))},getPriority:function(e){return e&&3===e.priority?$():e&&e.priority<3?$('<span class="high"><i class="fa fa-exclamation" aria-hidden="true"></i></span>').attr("title",s.pgettext("E-Mail","High priority")):$('<span class="low"><i class="fa fa-minus" aria-hidden="true"></i></span>').attr("title",s.pgettext("E-Mail","Low priority"))},getAccountName:function(e){var t=window.unescape(e?e.id:"");return/^default0/.test(t)?s("Primary account"):e&&e.account_name||"N/A"},getTime:function(e,t){return d(e,t)},getDateTime:function(e,t){return t=_.extend({fulldate:!0},t),d(e,t)},getFullDate:function(e){return _.isNumber(e)?moment(e).format("l LT"):s("unknown")},getSmartTime:function(e){var t=_.printf;if(console.warn("This method is deprecated and will be removed with 7.6.0 or at any random date later"),!_.isNumber(e))return s("unknown");var n=new Date,r=n.getTimezoneOffset(),a=n.getTime()-60*r*1e3-e,i=new Date(e),o=0;return i.getDate()===n.getDate()?a<36e5?(o=Math.ceil(a/6e4),String(t(f("%d minute ago","%d minutes ago",o),o))):(o=Math.ceil(a/36e5),String(t(f("%d hour ago","%d hours ago",o),o))):i.getDate()===n.getDate()-1?"Yesterday":i.getDate()+"."+(i.getMonth()+1)+"."+i.getFullYear()},threadFileSize:function(e){return e.reduce(function(e,t){return e+(t.size||0)},0)},count:function(e){return _(e).reduce(function(e,t){return e+(t.thread?t.thread.length:1)},0)},isToplevel:function(e){return _.isObject(e)&&"folder_id"in e&&!("filename"in e)},isUnseen:function(e){return e=_.isObject(e)?e.flags:e,_.isNumber(e)?32!=(32&e):void 0},isFlagged:function(e){return e=_.isObject(e)?e.flags:e,_.isNumber(e)?8==(8&e):void 0},isDeleted:function(e){return e&&_.isNumber(e.flags)?2==(2&e.flags):void 0},isSpam:function(e){return e&&_.isNumber(e.flags)?128==(128&e.flags):void 0},isAnswered:function(){return _.chain(arguments||[]).flatten().compact().reduce(function(e,t){return e||1==(1&t.flags)},!1).value()},isDecrypted:function(e){return e&&e.security&&e.security.decrypted},isForwarded:function(){return _.chain(arguments||[]).flatten().compact().reduce(function(e,t){return e||256==(256&t.flags)},!1).value()},isAttachment:function(e){return void 0!==(e||{}).parent},isEmbedded:function(e){return!!_.isObject(e)&&(void 0===e.folder_id&&void 0!==e.filename)},asList:_.memoize(function(e){return(e||"").replace(/[\s\n]+/g,",").replace(/(,+),/g,",").replace(/^,|,$/g,"").toLowerCase().split(",")}),isWhiteListed:function(e,t){var n=[].concat(o.asList(a.get("features/trusted/user",t||"")),o.asList(a.get("features/trusted/admin",""))),r=_.isObject(e)?e.from&&e.from.length&&String(e.from[0][1]||""):e||"";return n=_.compact(n),r=(r||"").trim().toLowerCase(),_.some(n,function(e){var t=e.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r.match(new RegExp(t+"$"))})},authenticity:function(){function e(){return a.get("features/authenticity",!1)?a.get("authenticity/level","none"):"none"}function t(e){if(_.isObject(e))return _.isObject(e.authenticity)?e.authenticity.status:e.status}function n(e,t,n){return e.test(t)&&n.indexOf(t)>-1}function r(e,t,r){switch(e){case"image":return n(/(fail|suspicious)/,r,t);case"icon":return n(/(fail|suspicious|pass|trusted)/,r,t);case"via":return!0;case"box":return n(/(fail|suspicious|trusted)/,r,t);case"block":return n(/(fail|suspicious)/,r,t);default:return!1}}return function(n,a){a.authenticity_preview&&(a=_.extend({},{authenticity:a.authenticity_preview},a));var i=t(a),s=e();if(("none"!==s||"trusted"===i)&&/^(fail|suspicious|neutral|none|pass|trusted)$/.test(i))return r(n,s,i)?i:void 0}}(),getAuthenticityMessage:function(e,t){switch(e){case"suspicious":return s("Be careful with this message. It might be spam or a phishing mail.");case"fail":return s("This is a dangerous email containing spam or malware.");case"neutral":return s("We could not verify that this email is from %1$s.",t);case"pass":case"trusted":return s("We could verify that this email is from %1$s.",t);default:return""}},isMalicious:function(){if(!a.get("maliciousCheck"))return _.constant(!1);var e=a.get("maliciousFolders");return _.isArray(e)?function(t){return!!_.isObject(t)&&n.isMalicious(t.folder_id||t.parent&&t.parent.folder_id,e)}:_.constant(!1)}(),byMyself:function(e){return(e=e||{}).from&&e.from.length&&String(e.from[0][1]||"").toLowerCase()in v},hasUnsendReadReceipt:function(e){return!(_.isNumber(e.flags)?512==(512&e.flags):void 0)&&!!e.disp_notification_to},hasOtherRecipients:function(e){e=e||{};var t=[].concat(e.to||[],e.cc||[],e.bcc||[]);return _(t).reduce(function(e,t){var n=String(t[1]||"").toLowerCase();return e+(!n||n in v?0:1)},0)>0},getDefaultSignature:function(e){var t=a.get("defaultSignature")||"",n=a.get("defaultReplyForwardSignature");return/(new|edit)/.test(e)?t:_.isBoolean(n)?t:n},getInitialDefaultSender:function(){return _(a.get("defaultSendAddress",[]))._wrapped[0]},fixInlineImages:function(e){return e.replace(new RegExp('(<img[^>]+src=")'+ox.abs+ox.apiRoot),"$1"+l).replace(new RegExp('(<img[^>]+src=")'+ox.apiRoot,"g"),"$1"+l).replace(/on(mousedown|contextmenu)="return false;"\s?/g,"").replace(/data-mce-src="[^"]+"\s?/,"")},parseMsgref:function(e,t){var n=_(t.toString().split(e)),r=n.last();return{folder_id:n.without(r).join(e),id:r}},getAttachments:function(){var e=function(e){return!("filename"in e)&&e.attachments&&1===e.attachments.length&&null===e.attachments[0].content},t=function(e,t){if(e.parent&&e.parent.needsfix){var n=t.id.split(".");t.id=t.id.split(".").length>1?n.splice(1,n.length).join("."):t.id}};return function(n){var r,a,i,o,u=[],l={id:(n=n||{}).id,folder_id:n.folder_id};for(r=0,a=(n.nested_msgs||[]).length;r<a;r++)i=n.nested_msgs[r],e(i)?(o=i.attachments[0],u.push(_.extend({},o,{mail:l,title:i.filename||"",parent:n.parent||l}))):(t(n,i),u.push({id:i.id,content_type:"message/rfc822",filename:i.filename||(i.subject||s("message")).replace(/\s+/g," ")+".eml",title:i.filename||i.subject||"",mail:l,parent:n.parent||l,nested_message:_.extend({},i,{parent:l})}));for(n.parent&&l&&void 0===l.folder_id&&(l.id=n.parent.id,l.folder_id=n.parent.folder_id),r=0,a=(n.attachments||[]).length;r<a;r++)("attachment"===(i=n.attachments[r]).disp||/^image/.test(i.content_type.toLowerCase()))&&(t(n,i),u.push(_.extend({},i,{cid:null,mail:l,title:i.filename||"",parent:n.parent||l})));return u}}()}});