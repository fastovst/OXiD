define("io.ox/mail/compose/actions/send",["io.ox/core/extensions","io.ox/mail/compose/actions/extensions","io.ox/mail/compose/api","io.ox/mail/api","settings!io.ox/mail","io.ox/core/notifications","gettext!io.ox/mail"],function(e,o,i,n,t,r,a){"use strict";e.point("io.ox/mail/compose/actions/send").extend({id:"metrics",index:100,perform:function(){require(["io.ox/metrics/main"],function(e){e.trackEvent({app:"mail",target:"compose/toolbar",type:"click",action:"send"})})}},{id:"check:no-recipients",index:200,perform:function(e){if(_.isEmpty(e.model.get("to"))&&_.isEmpty(e.model.get("cc"))&&_.isEmpty(e.model.get("bcc")))return r.yell("error",a("Mail has no recipient.")),e.view.$el.find(".tokenfield:first .token-input").focus(),e.stopPropagation(),$.Deferred().reject()}},{id:"check:no-subject",index:300,perform:function(e){if(""===$.trim(e.model.get("subject"))){var o=$.Deferred();return require(["io.ox/backbone/views/modal"],function(i){new i({title:a("Empty subject"),description:a("This email has no subject. Do you want to send it anyway?")}).addAlternativeButton({label:a("Send without subject"),className:"btn-default",action:"send"}).addButton({label:a("Add subject"),action:"subject"}).on("send",function(){o.resolve()}).on("subject",function(){e.stopPropagation(),setTimeout(function(){e.view.$el.find('input[name="subject"]').focus()},200),o.reject()}).open()}),o}}},{id:"check:attachment-empty",index:350,perform:o.emptyAttachmentCheck},{id:"check:attachment-missing",index:400,perform:o.attachmentMissingCheck},{id:"busy:start",index:500,perform:function(e){var o=e.app.getWindow();i.queue.add(e.model,function(){e.stopPropagation(),r.yell(a("error","The sending of the message has been canceled.")),i.queue.remove(e.model.get("id")),e.app.getWindow().idle().show()}),o&&(o.busy(),o.preQuit())}},{id:"wait-for-pending-uploads",index:600,perform:o.waitForPendingUploads},{id:"remove-unused-inline-images",index:700,perform:o.removeUnusedInlineImages},{id:"check-for-auto-enabled-drive-mail",index:800,perform:o.checkForAutoEnabledDriveMail({yell:!0,restoreWindow:!0,stopPropagation:!0,removeQueue:!0})},{id:"send",index:2e3,perform:function(e){return e.model.send()}},{id:"errors",index:3e3,perform:function(e){if(!e.error||e.warning);else{var o=e.app.getWindow(),i="abort"===e.error?a("The sending of the message has been canceled."):e.error;if(o&&(e.close&&e.close.show(),e.launcherClose&&e.launcherClose.show(),o.idle().show()),"MSGCS-0007"===e.errorCode||"MSGCS-0011"===e.errorCode)return;r.yell("error",i)}}},{id:"warnings",index:3100,perform:function(e){if(!e.errors&&e.warning){var o=e.warning.error||e.warning;r.yell("warning",o),e.view.dirty(!1),e.app.quit()}}},{id:"success",index:4e3,perform:function(e){e.error||e.warning||(t.get("features/notifyOnSent",!1)&&r.yell("success",a("The email has been sent")),e.view.dirty(!1),e.config.set("autoDismiss",!0),e.app.quit())}},{id:"update-caches",index:4100,perform:function(e){var o=e.model.get("meta"),i=!!o.replyFor,t=!!o.forwardsFor;(i||t)&&[].concat(o.replyFor,o.forwardsFor).filter(Boolean).forEach(function(e){var o=n.pool.get("detail").get(_.cid({id:e.originalId,folder_id:e.originalFolderId}));if(o){var r=o.get("flags");i&&(r|=1),t&&(r|=256),o.set("flags",r)}})}})});