define("io.ox/portal/main",["io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/api/user","io.ox/contacts/api","io.ox/core/tk/dialogs","io.ox/backbone/views/modal","io.ox/portal/widgets","io.ox/portal/util","io.ox/portal/settings/pane","io.ox/portal/settings/widgetview","io.ox/core/yell","gettext!io.ox/portal","settings!io.ox/portal","settings!io.ox/core","less!io.ox/portal/style"],function(e,t,i,o,n,a,d,r,s,l,c,p,g,u){"use strict";function f(e,t){function i(e){return _.contains(S,e)}function o(e){var i;return("tasks"!==e||(i=_(t.data).filter(function(e){return null!==e.end_time&&3!==e.status}),!_.isEmpty(i)))&&(!_.isEmpty(t.data)||void 0)}return!!g.get("settings/getStartedLink")&&(!!_.contains(C,e)&&(o(e)?(i(e)||S.push(e),g.set("settings/hadData",S).save(),!1):o(e)?void 0:!i(e)))}function m(e){var t=moment().hour();return t>=4&&t<=11?p("Good morning, %s",e):t>=18&&t<=23?p("Good evening, %s",e):p("Hello %s",e)}function w(){var e={id:E.get("name")};ox.launch("io.ox/settings/main",e).done(function(){this.setSettingsPane(e)})}function h(t,i,o){var n=o.closest(".widget").attr("data-widget-cid"),a=A.get(n);a&&(a.get("baton").item=o.data("item"),_.defer(function(){e.point("io.ox/portal/widget/"+a.get("type")).invoke("draw",t.empty(),a.get("baton"))}))}function v(t){t.preventDefault();var i=t.data.baton;e.point(i.point).invoke("performSetUp",null,i)}function x(e){return e&&e.promise?e:$.when()}function b(e,t){return e||t}function y(t){e.point(t.data.baton.point).invoke("action",$(this).closest(".widget"),t.data.baton)}function k(e,t,i){var o=e.invoke("load",t,i).map(x).value(),n=t.find(".decoration");return $.when.apply($,o).then(function(){i.options.loadingError=!1;var o=_.last(i.point.split("/"));t.find(".content").remove(),_.device("smartphone")&&g.get("mobile/summaryView")&&(e.all()[0].summary?e.invoke("summary",t,i):t.hasClass("generic-summary")||(t.addClass("with-summary show-summary generic-summary"),t.on("tap","h2",function(e){$(e.delegateTarget).toggleClass("show-summary generic-summary")}))),f(o,i)?E.drawFirstVisitPane(o,i):e.invoke("preview",t,i),t.removeClass("error-occurred"),n.removeClass("pending error-occurred")},function(o){var a=!u.get("security/acceptUntrustedCertificates")&&u.get("security/manageCertificates");if("remove"===o)throw d.remove(i.model),t.remove(),o;throw t.find(".content").remove(),n.removeClass("pending"),"ACC-0002"===o.code?(i.model.set("enabled",!1,{validate:!1}),c("info",p.format(p('The widget "%s" was disabled as the account might have been removed or is no longer available.'),i.model.get("title")))):"OAUTH-0006"!==o.code?(t.append($('<div class="content error">').append($("<div>").text(p("An error occurred.")),$('<div class="italic">').text(_.isString(o.error)?o.error:""),$("<br>"),!1!==o.retry?[/SSL/.test(o.code)?$():$('<a class="solution">').text(p("Try again.")).on("click",function(){t.find(".decoration").addClass("pending"),k(e,t,i)}),/SSL/.test(o.code)&&a?function(){var n=$("<div>").append($('<a class="solution">').text(p("Inspect certificate")).on("click",function(){require(["io.ox/settings/security/certificates/settings/utils"]).done(function(e){e.openExaminDialog(o)})}));return setTimeout(function(){n.find(".solution").off("click").empty().append($('<a class="solution">').text(p("Try again.")).on("click",function(){t.find(".decoration").addClass("pending"),k(e,t,i)}))},6e4),n}():$()]:$())),e.prop("stopLoadingOnError")&&(i.options.loadingError=!0),e.invoke("error",t,o,i)):E.drawDefaultSetup(i),o})}var C=["mail","calendar","tasks","myfiles"],W={mail:p("Welcome to your inbox"),calendar:p("Welcome to your calendar"),tasks:p("Welcome to your tasks"),myfiles:p("Welcome to your files")},S=g.get("settings/hadData")||[];e.point("io.ox/portal/sections").extend({id:"header",index:100,draw:function(t){var o,n;this.append(o=$('<div class="header">')),n=$('<h1 class="greeting">').append(t.$.greeting=$('<span class="greeting-phrase">'),$('<span class="signin">').append($("<span>").text(p("Signed in as")),$.txt(" "),i.getTextNode(ox.user_id,{type:"email"}))),_.device("!smartphone")?d.loadUsedPlugins().done(function(){e.point("io.ox/portal/settings/detail/view").map(function(e){e&&"add"===e.id&&e.invoke("render",{$el:o})}),o.find('[role="log"]').remove(),o.find(".form-group").addClass("pull-right").prepend($('<button type="button" class="btn btn-link" data-action="customize">').text(p("Customize this page")).on("click",w)),o.append(n)}):o.append(n)}}),e.point("io.ox/portal/sections").extend({id:"widgets",index:200,draw:function(e){this.append(e.$.widgets=$('<ol class="widgets">'))}}),e.point("io.ox/portal/sections").extend({id:"metrics",index:300,draw:function(){var e=this;require(["io.ox/metrics/main"],function(t){e.on("mousedown",".io-ox-portal-settings-dropdown",function(e){t.trackEvent({app:"portal",target:"toolbar",type:"click",action:"add",detail:$(e.target).attr("data-type")})}),e.on("mousedown","ol.widgets > .widget .content",function(e){t.trackEvent({app:"portal",target:"widgets",type:"click",action:"show-detail",detail:$(e.target).closest(".widget").attr("data-widget-type")})}),e.on("mousedown","ol.widgets .disable-widget",function(e){t.trackEvent({app:"portal",target:"widget",type:"click",action:"disable",detail:$(e.target).closest(".widget").attr("data-widget-type")})}),d.getCollection().on("order-changed",function(e){t.trackEvent({app:"portal",target:"widget",type:"click",action:"change-order",detail:e})})})}}),e.point("io.ox/portal/widget-scaffold").extend({id:"attributes",index:100,draw:function(e){this.attr({"data-widget-cid":e.model.cid,"data-widget-id":e.model.get("id"),"data-widget-type":e.model.get("type")})}}),e.point("io.ox/portal/widget-scaffold").extend({id:"classes",index:200,draw:function(e){var t=e.model.get("draggable");(_.isUndefined(t)||_.isNull(t))&&(t=!0),this.addClass("widget"+(e.model.get("inverse")?" inverse":"")).addClass(t?" draggable":" protected")}}),e.point("io.ox/portal/widget-scaffold").extend({id:"default",index:300,draw:function(e){this.append($('<div class="decoration pending">').append($("<h2>").append(e.model.get("protectedWidget")?[]:$('<a href="#" role="button" class="disable-widget">').attr("aria-label",p("Disable widget")).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",p("Disable widget"))),$('<span class="title">').text("Â "))))}}),e.point("io.ox/portal/widget-scaffold").extend({id:"color",index:400,draw:function(e){r.setColor(this,e.model.get("color"))}});var D,E=ox.ui.createApp({name:"io.ox/portal",title:"Portal"}),T=window.innerHeight,N=e.Baton({app:E}),P=new n.SidePopup({preserveOnAppchange:!0,tabTrap:!0}),A=d.getCollection();return E.settings=g,A.on("remove",function(e){N.$.widgets.find('[data-widget-cid="'+e.cid+'"]').remove(),e.has("baton")&&(delete e.get("baton").model,e.set("baton",null,{validate:!0}),e.isDeleted=!0),d.save(N.$.widgets)}).on("add",function(t){E.drawScaffold(t,!0),d.loadUsedPlugins().done(function(){if("io.ox/portal"===ox.ui.App.getCurrentApp().get("name")){var i=new l({model:t,collection:t.collection});e.point("io.ox/portal/widget/"+t.get("type")+"/settings").invoke("edit",this,t,i)}!0!==t.has("candidate")&&(E.drawWidget(t),d.save(N.$.widgets))})}).on("change",function(e,t){if("enabled"in e.changed)e.get("enabled")?(E.getWidgetNode(e).show(),E.drawWidget(e)):E.getWidgetNode(e).hide();else if("color"in e.changed)r.setColor(E.getWidgetNode(e),e.get("color"));else if("title"in e.changed)E.getWidgetNode(e).find(".title").text(e.get("title"));else{if(this.wasElementDeleted(e))return;"unset"in t&&"candidate"in e.changed&&e.drawn?E.refreshWidget(e):"props"in e.changed&&e.drawn?E.refreshWidget(e):E.drawWidget(e)}}).on("sort",function(){this.each(function(e){N.$.widgets.append(E.getWidgetNode(e))})}),A.wasElementDeleted=function(e){var t=e.cid,i=this.models;return!_(i).some(function(e){return e.cid===t})},E.getWidgetCollection=function(){return A},E.updateTitle=function(){i.getGreeting(ox.user_id).done(function(e){N.$.greeting.text(m(e))})},E.drawScaffold=function(t,i){i=i||!1;var o=e.Baton({model:t,app:E,add:i}),n=$('<li tabindex="0">');if(t.node=n,e.point("io.ox/portal/widget-scaffold").invoke("draw",n,o),!1===t.get("enabled"))n.hide();else if(!d.visible(t.get("type")))return void n.hide();if(i){var a=N.$.widgets.find("li.protected").last();a.length?a.after(n):N.$.widgets.prepend(n)}else N.$.widgets.append(n)},E.getWidgetNode=function(e){return N.$.widgets.find('[data-widget-cid="'+e.cid+'"]')},E.drawFirstVisitPane=function(e,t){var i=W[e]||"",o=g.get("settings/getStartedLink")||"#";t.model.node.append($('<div class="content">').append($("<div>").append($('<span class="bold">').text(ox.serverConfig.productName+". "),$.txt(i+".")),$('<a href="#" target="_blank" style="white-space: nowrap;" role="button">').attr("href",o).text(p("Get started here")+"!")))},E.drawDefaultSetup=function(t){var i=t.model.toJSON(),o=e.point(t.point),n=d.getTitle(i,o.prop("title")),a=t.model.node;a.append($('<div class="content">').append($('<div class="paragraph" style="min-height: 40px">').append($.txt(p("Welcome to %1$s",n)+"!"),$("<br>"),$.txt(p("Get started here")+":")),$('<a href="#" class="action" role="button">').text(p("Add your %1$s account",n)).on("click",{baton:t},v))),o.invoke("drawDefaultSetup",a,t)},E.drawWidget=function(t,i){var o=t.node,n=!_.device("smartphone")||o.offset().top<T;if(!t.drawn&&n){if(t.drawn=!0,i=i||0,!0===t.get("enabled")&&!d.visible(t.get("type")))return void o.hide();var a=e.Baton({model:t,point:"io.ox/portal/widget/"+t.get("type")}),r=e.point(a.point),s=d.getTitle(t.toJSON(),r.prop("title")),l=o.find("h2 .title").text(s),c=r.invoke("requiresSetUp").reduce(b,!1).value();t.set("baton",a,{validate:!0,silent:!0}),o.attr("aria-label",s),o.find("a.disable-widget").attr({"aria-label":s+", "+p("Disable widget")}),c?(o.find(".decoration").removeClass("pending"),E.drawDefaultSetup(a)):(void 0!==r.prop("action")&&l.addClass("action-link").css("cursor","pointer").on("click",{baton:a},y),_.delay(function(){r.invoke("initialize",o,a),o.busy(),k(r,o,a).done(function(){o.removeAttr("style")}).always(function(){o.idle()})},100*(i/2>>0)))}},E.refreshWidget=function(t,i){if(t.drawn){i=i||0;var o=t.node,n=1e3*(i/2>>0),a=t.get("baton"),d=e.point(a.point);_.defer(function(){_.delay(function(){o.find(".decoration").addClass("pending"),_.delay(function(){k(d,o,a),o=a=d=null},300)},n)})}},E.refresh=_.throttle(function(){_(d.getEnabled()).chain().filter(function(e){var t=e.attributes.baton&&e.attributes.baton.options;return!t&&!e.get("ignoreGlobalRefresh")||!t.loadingError&&!e.get("ignoreGlobalRefresh")}).each(E.refreshWidget)},3e4),E.mailWidgetRefresh=function(){_(d.getEnabled()).chain().filter(function(e){return"mail"===e.get("type")}).each(function(e,t){e.get("baton")&&e.get("baton").collection.expire(),E.refreshWidget(e,t)})},ox.on("refresh^",function(){E.refresh()}),ox.on("socket:mail:new",E.mailWidgetRefresh),E.getContextualHelp=function(){return"ox.appsuite.user.sect.portal.gui.html"},E.setLauncher(function(){E.setWindow(D=ox.ui.createWindow({name:"io.ox/portal",chromeless:!0,simple:_.device("smartphone")})),D.nodes.main.addClass("io-ox-portal f6-target").attr({tabindex:-1,"aria-label":p("Portal widgets")}),D.setTitle(p("Portal")),e.point("io.ox/portal/sections").invoke("draw",D.nodes.main,N),E.updateTitle(),_.tick(1,"hour",E.updateTitle),i.get(ox.user_id).done(function(e){o.on("update:"+_.ecid({folder_id:e.folder_id,id:e.contact_id}),E.updateTitle)}),D.show(function(){A.each(function(e){E.drawScaffold(e,!1)}),d.loadUsedPlugins().then(function(e){e.forEach(E.drawWidget),ox.trigger("portal:items:render")}),P.delegate(N.$.widgets,".item, .content.pointer, .action.pointer",_.debounce(h,100)),D.nodes.main.on("click",".disable-widget",function(e){e.preventDefault();var t=$(this).closest(".widget").attr("data-widget-id"),i=d.getModel(t);if(i)if(_.isEmpty(i.get("props")))i.collection.remove(i);else{var o=new a({title:p("Delete widget"),description:p("Do you really want to delete this widget?")}).addCancelButton().addButton({label:p("Delete"),action:"delete"}).on("delete",function(){i.collection.remove(i)});i.get("enabled")&&o.addButton({label:p("Just disable widget"),action:"disable",placement:"left",className:"btn-default"}).on("disable",function(){i.set("enabled",!1,{validate:!0})}),o.open()}}),_.browser.iOS&&D.nodes.main.css("-webkit-overflow-scrolling","touch"),_.device("smartphone")&&E.getWindow().on("hide",function(){E.getWindow().nodes.outer.removeClass("content-v-shift")}).on("show",function(){E.getWindow().nodes.outer.addClass("content-v-shift")}),_.device("touch")||require(["static/3rd.party/jquery-ui.min.js"]).done(function(){N.$.widgets.sortable({cancel:"li.protected",containment:D.nodes.main,delay:150,items:"> li.draggable:visible",scroll:!0,tolerance:"pointer",update:function(){d.getCollection().trigger("order-changed","portal"),d.save(N.$.widgets)}})})});var t=_.debounce(function(){T=$(this).scrollTop()+this.innerHeight,d.loadUsedPlugins().done(function(e){e.forEach(E.drawWidget)})},300);$(window).on("scrollend resize",t)}),{getApp:E.getInstance}});