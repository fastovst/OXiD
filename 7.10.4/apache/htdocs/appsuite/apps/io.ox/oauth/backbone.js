define("io.ox/oauth/backbone",["io.ox/core/http","io.ox/core/yell","gettext!io.ox/oauth","less!io.ox/oauth/style"],function(e,t,n){"use strict";var o=function(){return o.id=o.id+1,o.id};o.id=1;var i={};i.Model=Backbone.Model.extend({hasScopes:function(e){var t=this;return e=[].concat(e),_(e).reduce(function(e,n){return e||_(t.get("enabledScopes")).contains(n)},!1)},enableScopes:function(e){var t=this.get("wantedScopes")||this.get("enabledScopes")||[];return e=_([].concat(e,t)).uniq(),this.set("wantedScopes",e),this},disableScopes:function(e){var t=this.get("wantedScopes")||this.get("enabledScopes")||[];return e=_(t).difference([].concat(e)),this.set("wantedScopes",e),this},reauthorize:function(n){var i=this;if(!((n=_.extend({force:!0},n)).force||(this.get("wantedScopes")||[]).reduce(function(e,t){return e||!i.hasScopes(t)},!1)))return $.when();var c="oauth"+o(),a={action:"init",action_hint:"reauthorize",serviceId:i.get("serviceId"),displayName:i.get("displayName"),cb:c,id:i.id};a.scopes=_([].concat(this.get("enabledScopes"),this.get("wantedScopes"))).uniq().join(" ");var r=window.open(ox.base+"/busy.html","_blank","height=800, width=1200, resizable=yes, scrollbars=yes");return r.focus(),e.GET({module:"oauth/accounts",params:a}).then(function(e){var t=$.Deferred();return window["callback_"+c]=t.resolve,r.location=e.authUrl,t}).then(function(e){var t=$.Deferred();return delete window["callback_"+c],r.close(),e.error?t.reject(e):t.resolve(e)}).then(function(){return i.enableScopes(i.get("enabledScopes")),i.set("enabledScopes",i.get("wantedScopes")),i.unset("wantedScopes"),i},t)},sync:function(t,n,i){switch(t){case"create":var c=n.get("popup")||window.open(ox.base+"/busy.html","_blank","height=800, width=1200, resizable=yes, scrollbars=yes");return require(["io.ox/core/tk/keys"]).then(function(){var e="oauth"+o(),t={action:"init",cb:e,display:"popup",displayName:n.get("displayName"),redirect:!0,serviceId:n.get("serviceId"),session:ox.session},i=$.Deferred();return n.get("wantedScopes").length>0&&(t.scopes=n.get("wantedScopes").join(" ")),window["callback_"+e]=i.resolve,c.location=ox.apiRoot+"/oauth/accounts?"+$.param(t),i.done(function(){delete window["callback_"+e]})}).then(function(t){if(!t.data)return $.Deferred().reject(t.error);var o=t.data.id;return e.GET({module:"oauth/accounts",params:{action:"get",id:o}}).then(function(e){return n.set(e),e})}).then(function(e){return require(["io.ox/oauth/keychain"]).then(function(t){return t.accounts.add(n),e})}).done(i.success).fail(i.error).always(function(){c.close()});case"update":return n.reauthorize({force:!1}).then(function(){return e.PUT({module:"oauth/accounts",params:{action:"update",id:n.id},data:{displayName:n.get("displayName")}})}).then(function(){return n.toJSON()}).done(i.success).fail(i.error);case"delete":return e.PUT({module:"oauth/accounts",params:{action:"delete",id:n.id}}).done(i.success).fail(i.error);case"read":return e.GET({module:"oauth/accounts",params:{action:"get",id:n.id}}).then(function(e){return n.set(e),e}).done(i.success).fail(i.error)}},fetchRelatedAccounts:function(){var e=this;return require(["io.ox/core/api/account","io.ox/core/api/filestorage"]).then(function(e,t){return $.when(e.all(),t.getAllAccounts())}).then(function(t,n){return[].concat(n.toJSON().filter(function(t){return t.configuration&&String(t.configuration.account)===String(e.get("id"))}).map(function(e){return e.accountType=e.accountType||"fileStorage",e.error&&(e.status={message:e.error}),e}),t.filter(function(t){return t.mail_oauth===e.get("id")})).map(function(t){return t.serviceId=e.get("serviceId"),t})})}}),i.Collection=Backbone.Collection.extend({model:i.Model,forService:function(e,t){return t=_.extend({},t),this.filter(function(n){return n.get("serviceId")===e&&(!t.scope||_(n.get("enabledScopes")).contains(t.scope))})}});var c=Backbone.View.extend({tagName:"li",className:"service-item",render:function(){var e=this.model.get("icon")||this.model.id.match(/\.?(\w*)$/)[1]||"fallback",t=this.model.get("module")||"";return this.$el.append($('<button type="button" class="btn btn-default">').append($('<i class="service-icon fa">').addClass("logo-"+e+" "+t),$('<div class="service-label">').text(this.model.get("displayName"))).data({cid:this.model.cid})),this}}),a=c.extend({render:function(){var e=this.model.get("icon")||this.model.id.match(/\.?(\w*)$/)[1]||"fallback",t="Google"===this.model.get("displayName")?n("Sign in with Google. This will add your Gmail account."):this.model.get("displayName");return this.$el.append($('<button type="button" class="btn btn-default">').data({cid:this.model.cid}).append($('<i class="service-icon fa">').addClass("logo-"+e)),$('<div class="service-label">').text(t)),this}});return{Account:i,Views:{ServicesListView:Backbone.View.extend({tagName:"ul",className:"list-unstyled services-list-view",events:{"keypress button":"select","click button":"select"},ItemView:c,render:function(){var e=this.ItemView,t=this.model&&this.model.mailService||!1;return this.$el.append(this.collection.map(function(n){return(t?new a({model:n}):new e({model:n})).render().$el})),this},select:function(e){if("keypress"!==e.type||13===e.which||32===e.which){var t=this.collection.get($(e.currentTarget).data("cid"));this.trigger("select",t),this.trigger("select:"+t.get("type"),t)}}}),ServiceItemView:c,MailServiceItemView:a}}});