define("io.ox/notes/mediator",["io.ox/core/extensions","io.ox/files/api","io.ox/core/notifications","io.ox/core/folder/node","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/core/tk/list","io.ox/core/api/collection-loader","io.ox/notes/detail-view","gettext!io.ox/notes","settings!io.ox/notes","io.ox/notes/toolbar"],function(e,t,i,o,n,r,s,l,d,a){"use strict";return function(i){i.mediator({window:function(e){e.getWindow().nodes.main.append(e.left=$('<div class="leftside border-right">'),e.right=$('<div class="rightside">'))},"folder-structure":function(){e.point("io.ox/core/foldertree/notes/app").extend({id:"topics",index:100,draw:function(e){this.append(new o({filter:function(){return!0},folder:e.options.root,headless:!0,open:!0,icons:!0,iconClass:"sticky-note",tree:e,parent:e}).render().$el)}})},"folder-view":function(e){var t=e.settings.get("folder/root");e.treeView=new n({app:e,icons:!0,module:"notes",contextmenu:!0,root:t}),r.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable()},sidepanel:function(t){e.point("io.ox/notes/sidepanel").extend({id:"tree",index:100,draw:function(e){this.addClass("border-right").append($('<div class="section-header">').text(a("Topics")),e.app.treeView.$el)}});var i=t.getWindow().nodes.sidepanel;e.point("io.ox/notes/sidepanel").invoke("draw",i,e.Baton({app:t}))},"list-view":function(t){var i=s.extend({ref:"io.ox/notes/listview"});e.point("io.ox/notes/listview/item").extend({id:"last_modified",index:100,draw:function(e){var t=moment(e.data.last_modified),i=t.isSame(moment(),"day"),o=t.format(i?"LT":"l");this.append($('<span class="last_modified gray">').text(o))}},{id:"title",index:200,draw:function(e){var t=String(e.data.title).replace(/\.txt$/,"");this.append($('<div class="title drag-title">').text(t))}},{id:"note_preview",index:300,draw:function(e){var t=e.data.meta.note_preview||a("Preview not available");this.append($('<div class="preview gray">').text(t))}}),t.listView=new i({app:t,draggable:!1,ignoreFocus:!0}),t.listView.model.set({folder:t.folder.get()}),t.listView.toggleCheckboxes(!1),window.list=t.listView,t.left.append(t.listView.$el)},"auto-select":function(e){e.listView.on("first-content",function(){e.listView.selection.select(0)})},"connect-loader":function(e){var i=new l({module:"files",getQueryParams:function(e){return{action:"all",folder:e.folder,columns:"1,2,3,5,20,23,108,700,702,703,704,705,707",sort:e.sort||"5",order:e.order||"desc",timezone:"utc"}},PRIMARY_PAGE_SIZE:100,SECONDARY_PAGE_SIZE:200});i.each=function(e){t.pool.add("detail",e)},e.listView.connect(i)},"folder:change":function(e){e.on("folder:change",function(t){e.changingFolders=!0,e.listView.model.set("folder",t),e.folder.getData(),e.changingFolders=!1})},selection:function(e){var t=null;e.showDetailView=function(e){t!==e&&(this.right.empty().append(new d({cid:e}).$el),t=e)},e.showEmptyDetailView=function(){this.right.empty(),t=null};var i=_.debounce(function(t,i){"one"===t||"action"===t?e.showDetailView(i[0]):e.showEmptyDetailView()},10);e.listView.on({"selection:empty":function(){i("empty")},"selection:one":function(e){i("one",e)},"selection:multiple":function(e){i("multiple",e)},"selection:action":function(e){1===e.length&&i("action",e)}})},refresh:function(e){ox.on("refresh^",function(){_.defer(function(){e.listView.reload()})})}}),i.mediate()}});