define("io.ox/multifactor/settings/views/u2fRegistrationView",["io.ox/backbone/views","io.ox/core/extensions","io.ox/backbone/mini-views","io.ox/backbone/views/modal","io.ox/multifactor/api","gettext!io.ox/core/boot"],function(e,i,o,r,t,n){"use strict";function c(e,i){return new r({async:!0,point:u,title:n("Confirm Code"),width:640,enter:"OK",model:new Backbone.Model({device:i,challenge:i.challenge})}).build(function(){}).addCancelButton().on("cancel",function(){l.reject()}).open()}function a(e,i){var o={registrationData:i.registrationData,clientData:i.clientData};t.finishRegistration(d,e.deviceId,o).then(function(e){if(e&&e.enabled)return s.close(),void l.resolve();var i;e&&e.error&&(i=n("Failed to register device")+" "+e.error),require(["io.ox/core/notifications"],function(e){e.yell("error",i)}),s.close(),l.reject()},function(e){l.reject(),s.close(),require(["io.ox/core/notifications"],function(i){i.yell("error",n("Failed to register device.")+(e.error?" "+e.error:"")),console.error(e)})})}var s,l,d,u="multifactor/settings/views/u2fRegistrationView",f=0;return i.point(u).extend({index:f+=100,id:"header",render:function(e){var i=$("<label>").append(n("Please touch/activate your device")).append("<br>"),o=e.model.get("challenge"),r={challenge:o.registerRequests[0].challenge,appId:o.registerRequests[0].appId,version:o.registerRequests[0].version};o.registeredKeys.forEach(function(e){e.appId=window.location.origin}),window.u2f.register(o.registerRequests[0].appId,[r],o.registeredKeys,function(i){if(i.errorCode)return require(["io.ox/core/notifications"],function(e){4===i.errorCode?e.yell("error",n("Device is already registered")):e.yell("error",n("Problem registering device"))}),s.close(),void l.reject();a(e.model.get("device"),i)}),this.$body.append(i)}}),{open:function(e,i,o){return d=e,s=c(0,i),l=o,s}}});