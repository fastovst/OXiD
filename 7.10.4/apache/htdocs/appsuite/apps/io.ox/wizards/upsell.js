define("io.ox/wizards/upsell",["io.ox/core/extensions","io.ox/core/wizard/registry","io.ox/backbone/mini-views","settings!plugins/upsell","gettext!io.ox/wizards","less!io.ox/wizards/upsell"],function(e,t,s,n,p){"use strict";var i,a,l,r=n.get("shop"),c=e.point("io.ox/wizards/upsell"),o="%sEUR",d=Backbone.Model.extend({}),u=[];return i=function(e){var t,s,n,p=[];{if(e.products&&!_(e.products).isEmpty())return s=_(e.products).keys(),t=_(s).contains(ox.language)?e.products[ox.language]:e.products[s[0]],n=_(t).keys().sort(),_(n).each(function(e){var s=t[e];p.push(new d({id:e,image:s.image,title:s.title,price:s.price,description:s.description}))}),p;console.error("No products present",e)}},l=function(e){return _.printf(o,e.get("price").toFixed(2))},a=r.target,o=r.priceFormat?r.priceFormat:o,u=i(r),c.extend({id:"upsell-selection",index:100,title:p("Upgrade to premium edition"),activate:function(){$(".wizard-next").text(p("Next"))},draw:function(e){var t,n,i=$('<form class="upsell-product-choice">'),a=$('<div class="upsell-product-details">'),r=$('<div class="upsell-shopping-cart">'),c=$(this);n=function(){t=_(u).filter(function(e){return e.attributes.inCart}),r.find(".upsell-shopping-cart-status").empty(),_(t).each(function(e){r.find(".upsell-shopping-cart-status").append($("<span>").text(e.get("title")),$("<br/>"))}),t.length>0?e.buttons.enableNext():e.buttons.disableNext()},_(u).each(function(e){var t=_.uniqueId("form-control-label-");i.append($('<div class="upsell-product upsell-product-'+e.id+'">').append($('<div class="upsell-product-image">').css({"background-image":"url("+e.get("image")+")"}),$('<label class="upsell-product-name">').attr("for",t).append(new s.CheckboxView({name:"inCart",model:e,id:t}).render().$el,$.txt(" "),$.txt(e.get("title"))),$('<span class="upsell-product-price">').text(l(e))))}),r.append($('<i class="fa fa-shopping-cart fa-2x" aria-hidden="true">'),$('<span class="title">').text(p("Shopping cart")),$("<br/>"),$('<span class="upsell-shopping-cart-status">').text(p("Cart is empty."))),_(u).each(function(e){a.append($('<div class="upsell-product upsell-product-'+e.id+'">').append($('<div class="upsell-product-image">').css({"background-image":"url("+e.get("image")+")"}),$('<div class="upsell-product-name">').text(e.get("title")),$('<span class="upsell-product-price">').text(l(e)),$('<div class="upsell-product-description">').html(e.get("description"))))}),a.find(".upsell-product").hide(),a.append($('<div class="upsell-product filler">').append($("<span>").text("No product was selected."),$("<br/>"),$("<span>").html(" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"))),i.delegate(".upsell-product","click",function(e){var t=$(e.currentTarget).attr("class");a.find(".upsell-product").hide(),a.find("."+t.replace(/\s+/,".")).show()}),i.delegate(".upsell-product","change",n),c.append(i,r,a),n()}}),c.extend({id:"upsell-confirmation",index:200,title:p("Review your purchases"),activate:function(e){var t,s,n=e.confirm.node;n.empty(),t=_(u).filter(function(e){return e.attributes.inCart}),s=_(t).reduce(function(e,t){return e+parseFloat(t.get("price"))},0),_(t).each(function(e){n.append($('<tr class="upsell-product upsell-product-'+e.id+'">').append($('<td class="upsell-product-name">').text(e.get("title")),$('<td class="upsell-product-price">').text(_.printf(o,e.get("price").toFixed(2)))))}),n.append($('<tr class="upsell-total">').append($("<td>").text(p("Total cost")),$("<td>").text(_.printf(o,s.toFixed(2))))),t.length>0&&e.buttons.enableNext(),$(".wizard-next").text(p("Buy now!"))},draw:function(e){var t=$(this),s=$('<table class="upsell-shopping-cart-review">').appendTo(t);e.confirm={node:s},t.append($('<div class="upsell-disclaimer">').html(r.disclaimer.en_US))}}),c.extend({id:"upsell-acknowledgement",index:300,title:p("Purchase confirmation"),draw:function(e){var t,s,n=$('<div class="upsell-activation">').appendTo($(this)),i=$('<ul class="upsell-product-activated">');t=_(u).filter(function(e){return e.attributes.inCart}),s=_(t).pluck("id").join(","),$.ajax(a.replace("OXUPSELLCART",s).replace("OXUPSELLCONTEXT",ox.context_id).replace("OXUPSELLUSER",ox.user_id)),n.append($("<p>").text(p("The following products will be activated now:")),i),_(t).each(function(e){i.append($('<p class="upsell-product-name">').text(e.get("title"))),e.attributes.inCart=!1}),e.buttons.enableNext(),$(".wizard-prev").hide()}}),{getInstance:function(){return t.getWizard({id:"io.ox/wizards/upsell",closeable:!0})}}});