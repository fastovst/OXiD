define("io.ox/files/api",["io.ox/core/http","io.ox/core/folder/api","io.ox/core/api/user","io.ox/core/api/backbone","io.ox/core/api/collection-pool","io.ox/core/api/collection-loader","io.ox/core/capabilities","io.ox/core/extensions","io.ox/core/api/jobs","io.ox/core/util","io.ox/find/api","settings!io.ox/core","settings!io.ox/files","gettext!io.ox/files"],function(e,t,i,o,r,n,a,s,d,l,c,p,u,f){"use strict";function m(e){return M.add("detail",e),M.get("detail").get(_.cid(e)).toJSON()}function g(e,t){var i=M.get("detail");e.forEach(function(e){var o=i.get(_.cid(e));o&&o.set("locked_until",t)})}function v(e){b.trigger("beforedelete",e);var t=M.get("detail"),i=_(e).map(function(e){return t.get(_.cid(e))});t.remove(i)}function h(i,o,r){e.pause();var n=_(i).where({folder_id:"folder"}),a=_(i).difference(n);return a&&a.length>0&&e.PUT({module:"files",params:{action:"move",folder:o,ignoreWarnings:r,allow_enqueue:!0},data:a,appendColumns:!1}),_(n).each(function(e){t.move(e.id,o,{ignoreWarnings:r,enqueue:!0})}),e.resume()}function x(t,i,o){return e.pause(),_(t).map(function(t){var r={action:"copy",id:t.id,folder:t.folder_id,timestamp:t.timestamp||_.then(),ignoreWarnings:o};return t.file_options&&t.file_options.params&&(r=_.extend(r,t.file_options.params)),e.PUT({module:"files",params:r,data:{folder_id:i},appendColumns:!1})}),e.resume({consolidate:"reject"})}function y(t,i,o,r){var n="move"===t?h:x,a=$.Deferred(),s=function(e){for(var r,n=0,s=(e=_.isString(e)?[]:e)?e.length:0;n<s;n++)if(e[n].error&&"CONFLICT"!==e[n].error.categories){r=e[n].error.error;break}b.propagate(t,i,o),a.resolve(r||e)},l=function(e){if(_.isArray(e)){for(var t=0;t<e.length;t++)if("CONFLICT"===e[t].error.categories)return void s(e)}else if("CONFLICT"===e.categories)return void s(e);a.reject(e)};return e.wait(n(i,o,r)).then(function(e){"move"===t&&e&&e.length&&(e=_(e).map(function(e){if(!e.data||!e.data.job)return e;d.addJob({module:"folders",action:"update",done:!1,showIn:"infostore",id:e.data.job,successCallback:s,failCallback:l})}),0===(e=_(e).compact()).length)||s(e)},function(e){a.reject(e)}),a}function w(t,i,o){i=_.extend({addVersion:!0,folder:p.get("folder/infostore"),module:"files"},i);var r=_.extend({action:t,force_json_response:!0,timestamp:_.then()},i.params);i.filename&&(r.filename=i.filename),i.title&&(o.title=i.title),i.preview&&(o.meta=_.extend({},o.meta,{note_preview:i.preview})),"new"===t&&(r.extendedResponse=!0,r.try_add_version=!1!==i.addVersion,"newFile"===u.get("uploadHandling")&&(r.try_add_version=!1));var n=new FormData;return n.append("json",JSON.stringify(o)),n.folder=o.folder_id,"filename"in i?n.append("file",i.file,i.filename):"file"in i&&n.append("file",i.file),e.UPLOAD({module:i.module,params:r,data:n,fixPost:!0}).fail(E)}var b={},T=/^application\/(force-download|binary|x-download|octet-stream|vnd|vnd.ms-word.document.12|odt|x-pdf)$/i;b.Model=o.Model.extend({constructor:function(e,t){var i;(e=e||{}).space?i={filename:e.name,file_size:e.size,file_mimetype:e.mimeType,spaceId:e.space,id:e.id,origData:e,source:"compose"}:_.isObject(e.mail)?i={filename:e.filename,file_size:e.size,file_mimetype:e.content_type,id:e.id,folder_id:e.mail.folder_id||null,origData:e,source:"mail"}:_.isNumber(e.attached)&&_.isNumber(e.module)?i={filename:e.filename,file_size:e.file_size||e.size,file_mimetype:e.file_mimetype||e.fmtType,id:e.id||e.managedId,folder_id:e.folder,module:e.module,origData:e,source:"pim"}:_.isString(e.guardUrl)||"guardDrive"===e.source||"guardMail"===e.source?(i=e,e.content_type&&!i.file_mimetype&&(i.file_mimetype=e.content_type)):(i=e).source="drive",o.Model.call(this,i,t),this.listenTo(this,"change:com.openexchange.file.sanitizedFilename",function(e,t){var i=this.get("versions");if(i){for(var o=0;o<i.length;o++)if(i[o].version===e.get("version")){i[o]["com.openexchange.file.sanitizedFilename"]=t;break}this.set("versions",i)}})},isFolder:function(){return this.has("standard_folder")},isFile:function(){return!this.isFolder()&&this.isDriveItem()},isDriveItem:function(){return"drive"===this.get("source")||"guardDrive"===this.get("source")},isSVG:function(e){return/^image\/svg/.test(e||this.getMimeType())},isImage:function(e){return/^image\//.test(e||this.getMimeType())&&!this.isSVG(e)},isAudio:function(e){return/^audio\//.test(e||this.getMimeType())},isVideo:function(e){return/^video\//.test(e||this.getMimeType())},isOffice:function(e){return/^application\/(msword|excel|powerpoint|vnd\.(ms-word|ms-excel|ms-powerpoint|oasis|openxmlformats))/.test(e||this.getMimeType())},isPDF:function(e){return/^application\/pdf$/.test(e||this.getMimeType())},isZIP:function(e){return/^application\/zip$/.test(e||this.getMimeType())},isText:function(e){return/^(text\/plain|application\/rtf|text\/rtf)$/.test(e||this.getMimeType())},isWordprocessing:function(e){return/^application\/(?:msword|vnd\.(?:ms-word|openxmlformats-officedocument\.wordprocessingml|oasis\.opendocument\.text))/.test(e||this.getMimeType())},isSpreadsheet:function(e){return/^application\/(?:excel|vnd\.(?:ms-excel|openxmlformats-officedocument\.spreadsheetml|oasis\.opendocument\.spreadsheet))/.test(e||this.getMimeType())},isPresentation:function(e){return/^application\/(?:powerpoint|vnd\.(?:ms-powerpoint|openxmlformats-officedocument\.presentationml|oasis\.opendocument\.presentation))/.test(e||this.getMimeType())},isPgp:function(e){return/^application\/pgp(?:-encrypted)*$/.test(e)||this.isGuard()},isGuard:function(){return/^guard/.test(this.get("source"))},isEncrypted:function(){return this.isPgp()||/\.(grd|grd2|pgp)$/i.test(this.get("filename"))},isLocked:function(){return this.get("locked_until")>_.now()},isMailAttachment:function(){return"mail"===this.get("source")||"guardMail"===this.get("source")},isComposeAttachment:function(){return"compose"===this.get("source")},isPIMAttachment:function(){return"pim"===this.get("source")},isEmptyFile:function(){return this.isFile()&&!this.get("filename")},getDisplayName:function(){return this.get("com.openexchange.file.sanitizedFilename")||this.get("filename")||this.get("title")||""},getExtension:function(){var e=String(this.get("filename")||"").split(".");return 1===e.length?"":e.pop().toLowerCase()},getGuardExtension:function(){var e=String(this.get("filename")||"").split(".");return e.length>2&&"pgp"===e.pop().toLowerCase()?e[e.length-1].toLowerCase():""},getMimeType:function(){var e=String(this.get("file_mimetype")).toLowerCase().split(";")[0];return"guardDrive"===this.get("source")&&this.get("meta")&&this.get("meta").OrigMime&&(e=this.get("meta").OrigMime),T.test(e)?b.mimeTypes[this.getExtension()]||e:"audio/mp3"===e?"audio/mpeg":e},getGuardMimeType:function(){var e=this.get("meta"),t=e&&e.OrigMime;return t&&!T.test(t)||(t=b.mimeTypes[this.getGuardExtension()]||this.getMimeType()),t},getFileType:function(){if(this.isFolder&&this.isFolder())return"folder";if(this.getExtension){var e=this.getExtension();for(var t in this.types)if(this.types[t].test(e))return t}return!1},getGuardType:function(){var e=this.getGuardExtension();if(e)for(var t in this.types)if(this.types[t].test(e))return t;return this.getFileType()},types:{image:/^(gif|bmp|tif?f|jpe?g|gmp|png|psd|heic?f?)$/,audio:/^(aac|mp3|m4a|m4b|ogg|opus|wav)$/,video:/^(avi|m4v|mp4|ogv|ogm|mov|mpeg|webm|wmv)$/,vcf:/^(vcf)$/,doc:/^(docx|docm|dotx|dotm|odt|ott|doc|dot|rtf)$/,xls:/^(csv|xlsx|xlsm|xltx|xltm|xlam|xls|xlt|xla|xlsb|ods|ots)$/,ppt:/^(pptx|pptm|potx|potm|ppsx|ppsm|ppam|odp|otp|ppt|pot|pps|ppa|odg|otg)$/,pdf:/^pdf$/,zip:/^(zip|tar|gz|rar|7z|bz2)$/,txt:/^(txt|md)$/,guard:/^(grd|grd2|pgp)$/},supportsPreview:function(){if(this.isEncrypted())return!1;var e=this.getMimeType();return this.isImage(e)?"thumbnail":this.isAudio(e)?"cover":!(!a.has("document_preview")||!(this.isPDF(e)||this.isOffice(e)||this.isText(e)))&&"preview"},getUrl:function(e,t){return b.getUrl(this.toJSON(),e,t)},hasWritePermissions:function(){var e=$.Deferred(),t=this.get("object_permissions")||this.get("com.openexchange.share.extendedObjectPermissions")||[],o=_(t).findWhere({entity:ox.user_id,group:!1});return!o||o&&o.bits<2?i.get().done(function(i){e.resolve(t.filter(function(e){return!0===e.group&&_.contains(i.groups,e.entity)}).reduce(function(e,t){return e||t.bits>=2},!1))}).fail(function(){e.resolve(!1)}):e.resolve(!!(o&&o.bits>=2)),e}}),b.Collection=o.Collection.extend({model:b.Model}),b.mimeTypes={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp",heic:"image/heic",heif:"image/heif",mp3:"audio/mpeg",ogg:"audio/ogg",opus:"audio/ogg",aac:"audio/aac",m4a:"audio/mp4",m4b:"audio/mp4",wav:"audio/wav",mp4:"video/mp4",m4v:"video/mp4",ogv:"video/ogg",ogm:"video/ogg",webm:"video/webm",wmv:"video/video/x-ms-wmv",csv:"text/csv",odc:"application/vnd.oasis.opendocument.chart",odb:"application/vnd.oasis.opendocument.database",odf:"application/vnd.oasis.opendocument.formula",odg:"application/vnd.oasis.opendocument.graphics",otg:"application/vnd.oasis.opendocument.graphics-template",odi:"application/vnd.oasis.opendocument.image",odp:"application/vnd.oasis.opendocument.presentation",otp:"application/vnd.oasis.opendocument.presentation-template",ods:"application/vnd.oasis.opendocument.spreadsheet",ots:"application/vnd.oasis.opendocument.spreadsheet-template",odt:"application/vnd.oasis.opendocument.text",odm:"application/vnd.oasis.opendocument.text-master",ott:"application/vnd.oasis.opendocument.text-template",oth:"application/vnd.oasis.opendocument.text-web",pdf:"application/pdf",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xlsm:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xltx:"application/vnd.openxmlformats-officedocument.spreadsheetml.template",xltm:"application/vnd.openxmlformats-officedocument.spreadsheetml.template",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",pptm:"application/vnd.openxmlformats-officedocument.presentationml.presentation",ppsx:"application/vnd.openxmlformats-officedocument.presentationml.slideshow",potx:"application/vnd.openxmlformats-officedocument.presentationml.template",potm:"application/vnd.openxmlformats-officedocument.presentationml.template",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",docm:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",dotx:"application/vnd.openxmlformats-officedocument.wordprocessingml.template",dotm:"application/vnd.openxmlformats-officedocument.wordprocessingml.template",doc:"application/msword",dot:"application/msword",xls:"application/vnd.ms-excel",xlb:"application/vnd.ms-excel",xlt:"application/vnd.ms-excel",ppt:"application/vnd.ms-powerpoint",pot:"application/vnd.ms-powerpoint",pps:"application/vnd.ms-powerpoint"},b.getExtension=function(e){var t=e&&(e["com.openexchange.file.sanitizedFilename"]||e.filename||e.title),i=String(t||"").split(".");return i.length>2&&"pgp"===i.pop().toLowerCase()?i[i.length-1].toLowerCase():i.length>1?i.pop().toLowerCase():""},b.isText=function(e){return b.Model.prototype.types.txt.test(b.getExtension(e))},b.isPDF=function(e){return b.Model.prototype.types.pdf.test(b.getExtension(e))},b.isWordprocessing=function(e){return b.Model.prototype.types.doc.test(b.getExtension(e))},b.isPresentation=function(e){return b.Model.prototype.types.ppt.test(b.getExtension(e))},b.isSpreadsheet=function(e){return b.Model.prototype.types.xls.test(b.getExtension(e))},b.isOffice=function(e){return b.isWordprocessing(e)||b.isPresentation(e)||b.isSpreadsheet(e)},b.isImage=function(e){return b.Model.prototype.types.image.test(b.getExtension(e))},b.isAudio=function(e){return b.Model.prototype.types.audio.test(b.getExtension(e))},b.isVideo=function(e){return b.Model.prototype.types.video.test(b.getExtension(e))},b.getUrl=function(e,t,i){if(i=_.extend({scaleType:"contain"},i),e.space)return ox.apiRoot+"/mail/compose/"+e.space+"/attachments/"+e.id+"?session="+ox.session;var o="/files",r=encodeURIComponent(e.folder_id),n=encodeURIComponent(e.id),a="&user="+ox.user_id+"&context="+ox.context_id+"&sequence="+(e.last_modified||1),s="?action=document&folder="+r+"&id="+n+(void 0!==e.version&&!1!==i.version&&null!==i.version?"&version="+e.version:"")+a,d=e.filename?"/"+encodeURIComponent(e.filename):"",c=i.width&&i.height?"&scaleType="+i.scaleType+"&width="+i.width+"&height="+i.height:"",p=_([ox.user_id,ox.context_id,e.last_modified]).compact().join(".")||"";switch(p&&(s+="&"+p),i.params&&(s+="&"+_.serialize(i.params)),t){case"download":o=e.meta&&e.meta.downloadUrl||o+d+s+"&delivery=download";break;case"thumbnail":if(i.noSharding){o=e.meta&&e.meta.thumbnailUrl||o+s+"&delivery=view"+c;break}return l.getShardingRoot(e.meta&&e.meta.thumbnailUrl||o+s+"&delivery=view"+c);case"preview":if(i.noSharding){o=e.meta&&e.meta.previewUrl||o+s+"&delivery=view"+c+"&format=preview_image&content_type=image/jpeg";break}return l.getShardingRoot(e.meta&&e.meta.previewUrl||o+s+"&delivery=view"+c+"&format=preview_image&content_type=image/jpeg");case"cover":o="/image/file/mp3Cover?folder="+r+"&id="+n+c+a+"&content_type=image/jpeg&"+p;break;case"play":o=o+s+"&delivery=view";break;default:o=o+d+s+"&delivery=view"}return ox.apiRoot+o};var M=r.create("files",{Collection:b.Collection,Model:b.Model});M.add=_.wrap(M.add,function(e,t,i){_.isUndefined(i)&&(i=t,t="detail");var o,r=this.get(t),n=[];i=[].concat(i),"detail"===t&&i.forEach(function(e){(o=!r.get(_.cid(e))||r.get(_.cid(e))&&r.get(_.cid(e)).get("last_modified")>=e.last_modified)?e.expired=!1:(e.expired=!0,n.push(_.cid(e)))});var a=e.call(this,t,i);return n.length>0&&r.trigger("expired_models",n),a});var C="1,2,3,5,20,23,108,700,702,703,704,705,707,711,7040",k=e.getAllColumns("files",!0),F=p.get("folder/mailattachments",{});_.isEmpty(F)?k=k.replace(",7030",""):C+=",7030";var E=function(e){if(e.data=e.data||{},e&&e.code&&("UPL-0005"===e.code||"IFO-1700"===e.code))e.data.custom={type:"error",text:f(e.error,e.error_params[0],e.error_params[1])};else if(e&&e.code&&"IFO-0100"===e.code&&e.problematic&&e.problematic[0]&&700===e.problematic[0].id)e.data.custom={type:"error",text:f("The provided filename exceeds the allowed length.")};else if(e&&e.code&&"FLS-0024"===e.code)e.data.custom={type:"error",text:f("The allowed quota is reached.")};else{if(e.error&&"abort"===e.error)return;e.data.custom={type:"error",text:f("This file could not be uploaded.")+(/^0 /.test(e.error)?"":"\n"+e.error)}}return e};_.extend(b,Backbone.Events),b.pool=M,b.collectionLoader=new n({module:"files",getQueryParams:function(e){return!/^virtual\//.test(e.folder)&&{action:"all",folder:e.folder||p.get("folder/infostore"),columns:C,sort:e.sort||"702",order:e.order||"asc",pregenerate_previews:!1!==e.pregenerate_previews,timezone:"utc"}},fetch:function(i){var o=this.module,r=o+"/"+_.cacheKey(_.extend({session:ox.session},i)),n=ox.rampup[r],a=this.noSelect(i),d=this.virtual(i),l=this;return n?(delete ox.rampup[r],$.when(n)):(a&&1===t.pool.getModel(i.folder).attributes.own_rights&&(i.tree=1,i.parent=i.folder,o="folders",i.action="list",i.columns="1,2,3,5,20,23"),d?$.when(d):e.wait().then(function(){return l.mimeTypeFilter?l.filterByMimeType(i).then(function(e){return l.filter&&(e=_(e).filter(l.filter)),l.useSlice?Array.prototype.slice.apply(e,i.limit.split(",")):e}):$.when(l.httpGet(o,i),ox.manifests.loadPluginsFor("io.ox/files/filter"))}).then(function(e){return _.isFunction(l.filter)&&(e=_(e).filter(l.filter)),e=e.filter(function(e){return s.point("io.ox/files/filter").filter(function(t){return!1!==t.invoke("isEnabled",this,e)}).map(function(t){return t.invoke("isVisible",this,e)}).reduce(function(e,t){return e&&t},!0)}),l.useSlice?Array.prototype.slice.apply(e,i.limit.split(",")):e}))},httpGet:function(i,o){if("9"===o.folder){var r=[];return t.get("virtual/favorites/infostore").then(function(e){return t.list("virtual/favorites/infostore").then(function(i){return i.length&&r.push(e),t.multipleLists(["virtual/drive/private","virtual/drive/public","virtual/filestorage"]).then(function(e){switch(a.has("share_links || invite_guests")||(e=_.filter(e,function(e){return"virtual/myshares"!==e.id})),r=r.concat(e),String(o.sort)){case"702":r=_(r).sortBy("title");break;case"5":r=_.sortBy(r,function(e){return e.last_modified?e.last_modified:0})}return"desc"===o.order&&r.reverse(),r})})})}return t.list(o.folder).then(function(t){"5"===String(o.sort)&&(t=_(t).sortBy("last_modified")),"desc"===o.order&&t.reverse();var r=o.limit.split(/,/),n=Number(r[0]),a=Number(r[1]),s=n-t.length+","+(a-t.length);return t.length>=a?t.slice(n,a):e.GET({module:i,params:_.extend({},o,{limit:s})}).then(function(e){var i=[].concat(t,new Array(Math.max(0,n-t.length)),e).slice(n,a);return i.forEach(function(e,t){i[t]=m(e)}),i},function(e){return"IFO-0400"===e.code&&0===e.error_params.length&&e.error_params.push(o.folder),b.trigger("error error:"+e.code,e),ox.debug&&console.warn("files.httpGet",e.error,e),[]})})},filterByMimeType:function(e){var i=this;return t.get(e.folder).then(function(o){return t.list(e.folder).then(function(t){"5"===String(e.sort)&&(t=_(t).sortBy("last_modified")),"desc"===e.order&&t.reverse();var r=e.limit.split(/,/),n=Number(r[0]),a=Number(r[1]);if(t.length>=a)return t.slice(n,a);var s={data:{facets:[{facet:"folder",filter:null,value:e.folder},{facet:"account",filter:null,value:o.account_id},{facet:"file_type",filter:{fields:["file_extension"],queries:i.mimeTypeFilter},value:i.mimeTypeFilter}],options:{includeSubfolders:!1,sort:e.sort,order:e.order},size:a,start:n},params:{module:"files"}};return c.query(s).then(function(o){o=o.results;var r=[].concat(t,new Array(Math.max(0,n-t.length)),o).slice(n,a);return r.forEach(function(e,t){r[t]=m(e)}),i.addIndex(n,e,r),i.done(),r},function(t){return"IFO-0400"===t.code&&0===t.error_params.length&&t.error_params.push(e.folder),b.trigger("error error:"+t.code,t),ox.debug&&console.warn("files.filter",t.error,t),[]})})})},PRIMARY_PAGE_SIZE:210,SECONDARY_PAGE_SIZE:210}),b.collectionLoader.noSelect=function(e){return!t.pool.getModel(e.folder).can("read")},b.collectionLoader.each=function(e){b.pool.add("detail",e)},b.collectionLoader.setMimeTypeFilter=function(e){return!_.isEqual(b.collectionLoader.mimeTypeFilter,e)&&(b.collectionLoader.mimeTypeFilter=e,!0)},b.resolve=function(){function e(e){if(/^folder\./.test(e)){var i=t.pool.getModel(e.substr(7)).toJSON();return i.folder_id="folder",new b.Model(i)}return M.get("detail").get(e)}return function(t,i){var o=_(t).chain().map(e).compact().value();return!1===i?o:_(o).invoke("toJSON")}}(),b.get=function(t,i){if((i=_.extend({cache:!0},i)).cache){var o=M.get("detail").get(_.cid(t));if(o&&!o.get("expired")&&o.has("description"))return $.when(o.toJSON())}var r=_.extend({action:"get",id:t.id,folder:t.folder_id||t.folder,timezone:"UTC"},i.params);return i.columns&&(r.columns=i.columns),e.GET({module:"files",params:r}).then(function(e){return t.origin&&(e.origin=_.clone(t.origin)),m(e)},function(e){throw b.trigger("error error:"+e.code,e),e})},b.getAll=function(t,i){return i=_.extend({columns:C},i),e.GET({module:"files",params:_.extend({action:"all",columns:i.columns,folder:t,timezone:"UTC"},i.params)}).then(function(e){return M.add("detail",e),e},function(e){throw b.trigger("error error:"+e.code,e),e})},b.getList=function(){function t(e){return this.get(_.cid(e))}function i(e){return this.get(_.cid(e)).toJSON()}return function(o,r){var n=o,a=M.get("detail");return r=_.extend({cache:!0},r),0===o.length?$.when([]):(r.cache&&(n=_(o).reject(t,a)),r.fullModels&&0===n.length?$.when(_(o).map(t,a)):0===n.length?$.when(_(o).map(i,a)):e.fixList(n,e.PUT({module:"files",params:{action:"list",columns:C,timezone:"UTC"},data:e.simplify(n)})).then(function(e){return _(e.filter(Boolean)).each(m),r.fullModels?_(o).map(t,a):_(o).map(i,a)}))}}();var S=function(t,i){return e.pause(),_(t).each(function(t){e.PUT({module:"files",params:{action:i,id:t.id,folder:t.folder_id||t.folder,timezone:"UTC"},appendColumns:!1})}),e.resume()};b.unlock=function(e){return e=_.isArray(e)?e:[e],g(e,0),S(e,"unlock").done(function(){b.propagate("unlock",e)})},b.lock=function(e){return e=_.isArray(e)?e:[e],g(e,_.now()+6e4),S(e,"lock").then(function(){return b.propagate("lock",e)})},b.clear=function(t){return M.getByFolder(t).forEach(function(e){e.expired=!0,e.reset()}),e.PUT({module:"folders",appendColumns:!1,params:{action:"clear",tree:"1"},data:[t]}).done(function(){b.propagate("clear",{folder_id:t})})},b.restore=function(t){_.isArray(t)||(t=[t]);var i=[];return _(t).each(function(e){i.push({id:e.get("id"),folder:e.get("folder_id")}),_(b.pool.collections).invoke("remove",e),e.set("unread",0)}),e.PUT({module:"infostore",params:{action:"restore",folder:"1"===i[0].id||/^default\d+/.test(i[0].id)?0:1},data:i,appendColumns:!1}).done(function(e){var t,i=[];_.each(e,function(e){t=e.path[0].id,_.contains(i,t)||i.push(t),b.trigger("refresh:listviews")})}).fail(function(){_(t).each(function(e){b.propagate("restore:fail",e.toJSON())})})};var P=_.debounce(function(){b.trigger("refresh:listviews")},0);return t.on({"before:clear":function(e){var t=String(u.get("folder/trash"))===e;_(M.getByFolder(e)).each(function(e){var i=e.filter(function(e){return t||e.isFile()});e.length===i.length?e.reset():e.remove(i)})},"remove:infostore":function(){var e=u.get("folder/trash");e&&(t.list(e,{cache:!1}),_(M.getByFolder(e)).each(function(e){e.expired=!0})),P()},"before:remove before:move":function(e){var t=M.get("detail"),i=_.cid(e);t.remove(t.get(i))},restore:function(){b.trigger("refresh:listviews")}}),b.remove=function(t,i){return v(t),e.wait(e.PUT({module:"files",params:{action:"delete",timestamp:_.then(),hardDelete:Boolean(i)},data:e.simplify(t),appendColumns:!1}).done(function(){b.propagate("remove:file",t)}))},b.move=function(e,t,i){return v(e),y("move",e,t,i)},b.copy=function(e,t,i){return y("copy",e,t,i)},b.zip=function(e){return require(["io.ox/core/download"]).then(function(t){t.url(ox.apiRoot+"/files?"+$.param({action:"zipfolder",folder:e,recursive:!0,session:ox.session}))})},b.update=function(t,i,o){if(_.isObject(i)&&!_.isEmpty(i)){var r,n=b.pool.get("detail").get(_.cid(t)),a={};n&&(n.set(i),r=Object.keys(n.changedAttributes()),_.each(r,function(e){a[e]=n.previous(e)})),o=_.extend({silent:!1},o);var s={file:i};return o.notification&&!_.isEmpty(o.notification)&&(s.notification=o.notification),e.PUT({module:"files",params:{action:"update",id:t.id,timestamp:_.then(),ignoreWarnings:o.ignoreWarnings,extendedResponse:!0},data:s,appendColumns:!1}).then(function(e){_.isObject(e)&&n&&n.get("id")!==e.id&&(n.set("id",e.id),t.id=e.id)}).always(_.lfo(function(e,t,i){i&&i.error&&e&&t&&t.set(e)},a,n)).done(function(){o.silent||b.propagate("change:file",t,i)})}},b.upload=function(e){var t=e.folder_id||e.folder,i=w("new",e,{folder_id:t,description:e.description||""}),o=i.then(function(t){var i=t.data.file,o=_(i).pick("id","folder_id"),r=i.title||i.filename;if("new_version"===t.data.save_action){var n=b.pool.get("detail").get(_.cid(o));return n&&n.set("id",i.id),!1!==e.addVersion&&"new_version"===t.data.save_action&&"announceNewVersion"===u.get("uploadHandling")&&b.trigger("add:imp_version",r),b.propagate("add:version",i)}return b.propagate("add:file",o),i});return o.abort=i.abort,o},b.versions={upload:function(e){var t=w("update",e,{id:e.id,folder_id:e.folder_id||e.folder,version_comment:e.version_comment||""}),i=t.then(function(t){var i=t.data;if(e.id!==i){var o=b.pool.get("detail").get(_.cid(e));return o.set("id",i),b.propagate("add:version",o.toJSON())}return b.propagate("add:version",e)});return i.abort=t.abort,i},load:function(t,i){i=_.extend({cache:!0},i);var o=_.cid(t),r=M.get("detail").get(o);return r?i.cache&&r.has("versions")?$.when(r.get("versions")):e.GET({module:"files",params:{action:"versions",columns:k,folder:t.folder_id,id:t.id,timezone:"utc"},appendColumns:!0}).then(function(e){return r.set({versions:e,number_of_versions:e.length}),e}):$.when([])},remove:function(t){var i=_.cid(t),o=M.get("detail").get(i);return o&&_.isArray(o.get("versions"))&&o.set("versions",o.get("versions").filter(function(e){return e.version!==t.version})),e.PUT({module:"files",params:{action:"detach",id:t.id,folder:t.folder_id,timestamp:_.then()},data:[t.version],appendColumns:!1}).then(function(){return b.propagate("remove:version",t)})},removePreviousVersions:function(t){var i,o=M.get("detail").get(_.cid(t)),r=o.get("versions");return r.sort(function(e,t){return e.current_version?-r.length:t.current_version?r.length:t.last_modified-e.last_modified}),o&&_.isArray(r)&&o.set("versions",r.filter(function(e){return e.version===t.version?(i=!0,!0):!!e.current_version||!(parseInt(e.version,10)<parseInt(t.version,10))&&!i})),e.PUT({module:"files",params:{action:"detach",id:t.id,folder:t.folder_id,timestamp:_.then()},data:_.difference(r,o.get("versions")).map(function(e){return e.version}),appendColumns:!1}).then(function(){b.propagate("refresh:file",_.pick(t,"id","folder_id"))})},setCurrent:function(e){var t=M.get("detail").get(_.cid(e));t&&_.isArray(t.get("versions"))&&t.set("versions",t.get("versions").map(function(t){return t.current_version=t.version===e.version,t}));var i={version:e.version};return b.update(e,i).done(function(){b.propagate("change:version",e)})},getCurrentState:function(e,t){return"boolean"==typeof e.current_version?$.when(e.current_version):b.versions.load(e,t).then(function(t){var i=!1;return _.isArray(t)&&(i=!t.length||_.some(t,function(t){return t.current_version&&t.version===e.version})),i})}},b.search=function(t,i){return i=_.extend({action:"search",columns:b.search.columns,sort:"702",order:"asc",limit:100},i),e.PUT({module:"files",params:_(i).pick("action","columns","sort","order","limit","folder","includeSubfolders"),data:b.search.getData(t,i)}).done(function(e){_(e).each(m)})},b.search.columns=C,b.search.getData=function(e){return{pattern:e}},b.propagate=function(){function i(t){return e.pause(),b.get(t,{cache:!1}),b.versions.load(t,{cache:!1}),e.resume().then(function(e){return!(!_.isArray(e)||!e.length)&&e[0].data})}var o={new:"add:file",change:"change:file",update:"change:file",delete:"remove:file"};return function(e,r){var n=_.isArray(r)?r:[r];switch(t.isExternalFileStorage(r),r=_(r).pick("folder","folder_id","id","version"),e=o[e]||e,ox.debug&&console.log("files/api.propagate()",e,r,n,arguments[2]||{}),e){case"add:file":b.trigger("add:file",r),t.reload(n);break;case"restore:fail":b.trigger("restore:fail",r);break;case"add:version":case"refresh:file":return i(r).done(function(){b.trigger("add:version",r)});case"change:file":b.trigger("change:file update change:file:"+_.ecid(r)+" update:"+_.ecid(r));var a=arguments[2]||{};("title"in a||"filename"in a)&&b.propagate("rename",r),"object_permissions"in a&&b.propagate("permissions",r),"description"in a&&b.propagate("description",r);break;case"favorite:add":b.trigger("favorite:add",r);break;case"favorite:remove":b.trigger("favorite:remove",r);break;case"change:version":b.trigger("change:version",r);break;case"clear":b.trigger("clear",r.folder_id),t.reload(r.folder_id);break;case"copy":case"move":n=_.reject(n,function(e){return"folder"===e.folder_id});var s=arguments[2];b.trigger(e,n,s),t.reload(n,s),M.resetFolder(s);break;case"lock":return b.getList(n,{cache:!1});case"remove:file":t.reload(n);var d=u.get("folder/trash");d&&_(M.getByFolder(d)).each(function(e){e.expired=!0}),b.trigger("remove:file",n),_(n).each(function(e){b.trigger("remove:file:"+_.ecid(e))});break;case"remove:version":return i(r).done(function(){b.trigger("remove:version",r)});case"rename":return t.get(r.folder_id).then(function(e){if(t.isExternalFileStorage(e))return i(r).done(function(){b.trigger("rename",_.cid(r))});b.trigger("rename",_.cid(r))});case"permissions":b.trigger("change:permissions",_.cid(r));break;case"description":b.trigger("description",_.cid(r))}}}(),b.getDefaultColumns=function(t){var i=e.getAllColumns("files");return _([].concat(i,t)).uniq().sort().join(",")},b});