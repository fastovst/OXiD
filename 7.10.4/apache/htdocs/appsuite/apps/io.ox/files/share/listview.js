define("io.ox/files/share/listview",["io.ox/files/share/api","io.ox/core/extensions","io.ox/core/folder/breadcrumb","io.ox/core/tk/list","io.ox/core/tk/list-contextmenu","io.ox/files/common-extensions","io.ox/files/api","io.ox/core/capabilities","io.ox/core/yell","gettext!io.ox/files","less!io.ox/files/share/style","io.ox/files/share/view-options"],function(t,e,i,s,n,o,r,l,a,c){"use strict";function d(e){var i=(e=new t.Model(e.toJSON())).getPermissions().filter(function(t){return"anonymous"!==t.type});return e.setPermissions(i),e}function h(e){var i=(e=new t.Model(e.toJSON())).getPermissions().filter(function(t){return"anonymous"===t.type&&!0!==t.isInherited});return e.setPermissions(i),!!i.length&&e}function u(t,e){var i=t.target,s=i.getBaton(e),n=f(s)||m(s),o=g(s),r=t.itemList;if(n){var l=d(e);l&&r.push(i.renderListItem(l))}if(o){var a=h(e);a&&r.push(i.renderListItem(a))}return t}function p(t){return _.chain(t.model.getPermissions()).reject(function(t){return"user"===t.type&&t.entity===ox.user_id}).pluck("type").uniq().value()}function f(t){return _(p(t)).contains("user")||_(p(t)).contains("group")}function m(t){return _(p(t)).contains("guest")}function g(t){return _(p(t)).contains("anonymous")}var x="io.ox/files/share/myshares/listview",v=x+"/item",y=s.extend(n).extend({ref:x,initialize:function(e){var i=this;e.collection=this.collection=t.collection,s.prototype.initialize.call(this,e),this.$el.addClass("myshares-list column-layout"),this.load(),this.model.set({sort:e.app.props.get("sort"),order:e.app.props.get("order")}),this.toggleCheckboxes(!1),this.listenTo(this.collection,"reset",this.redraw),this.listenTo(ox,"refresh^",this.reload),this.listenTo(this.model,"change:sort change:order",this.sortBy),this.sortBy(),this.$el.on(_.device("touch")?"tap":"dblclick",".list-item .list-item-content",function(){_.defer(function(){i.openPermissionsDialog()})}),_.device("smartphone")||i.$el.on("keydown",".list-item",function(t){13===t.which&&i.openPermissionsDialog()})},load:function(){var e=this;return t.all().then(function(t){e.collection.reset(t)},a)},reload:function(){return this.load()},openPermissionsDialog:function(){var t=this.collection.get(this.selection.get()[0]),e=this.$el.find('.list-item.selected[data-cid="'+(t.cid?t.cid:_.cid(t))+'"]');ox.load(["io.ox/files/actions/share"]).done(function(i){if(e.length){var s=e.attr("data-share-type");"invited-people"===s?i.invite([t]):"public-link"===s&&i.link([t])}})},sortBy:function(){var t="desc"===this.model.get("order");switch(this.model.get("sort")){case 5:this.collection.comparator=function(e){var i=e.get("last_modified");return i=e.isFolder()?(t?"1":"0")+i:(t?"0":"1")+i,t?-i:i};break;case 702:this.collection.comparator=function(e,i){var s=e.getDisplayName().toLowerCase(),n=i.getDisplayName().toLowerCase(),o=(s=e.isFolder()?(t?"1":"0")+s:(t?"0":"1")+s)>(n=i.isFolder()?(t?"1":"0")+n:(t?"0":"1")+n)?1:-1;return t?-o:o}}this.collection.sort({silent:!0}),this.collection.each(function(t,e){t.set("index",e)}),this.collection.trigger("sort"),this.app.props.set(this.model.attributes)},onReset:function(){this.empty(),this.$el.append(this.collection.reduce(u,{target:this,itemList:[]}).itemList),this.trigger("reset",this.collection,this.firstReset),this.firstReset&&(this.trigger("first-reset",this.collection),this.firstReset=!1),this.firstContent&&this.collection.length&&(this.trigger("first-content",this.collection),this.firstContent=!1),this.trigger("listview:reset")},redraw:function(){var t,i,s=this,n=s.collection,o=e.point(s.ref+"/item");s.getItems().toArray().forEach(function(e){i=n.get(e.getAttribute("data-cid")),i="public-link"===e.getAttribute("data-share-type")?h(i):d(i),t=s.getBaton(i),o.invoke("draw",$(e).children().eq(1).empty(),t)})},renderListItem:function(t){var i=this.createListItem(),s=this.getBaton(t),n=g(s)&&"public-link"||"invited-people",o=f(s)&&"invited-user"||m(s)&&"invited-guest"||"not-invited";return i.attr({"data-cid":this.getCompositeKey(t),"data-index":t.get("index"),"data-share-type":n,"data-invitation-type":o}),e.point(this.ref+"/item").invoke("draw",i.children().eq(1),s),i},renderListItems:function(){this.idle();var t=this.getItems();this.queue.iterate(function(e){var i=e.has("index")?e.get("index"):this.collection.indexOf(e),s=[e].reduce(u,{target:this,itemList:[]}).itemList,n=s[0];i<t.length?(t.eq(i).before(s),n[0].offsetTop<=this.el.scrollTop&&(this.el.scrollTop+=n.outerHeight(!0)*s.length)):this.$el.append(s),this.trigger("add",e,i),this.trigger("add:"+e.cid,e,i)}),this.onSort()},getContextMenuData:function(t){return this.app.getContextualData(t,"shares")}});return e.point(v).extend({id:"default",index:100,draw:function(t){e.point(v+"/list").invoke("draw",this,t)}}),e.point(v+"/list").extend({id:"file-type",index:100,draw:o.fileTypeClass},{id:"icon",index:200,draw:function(t){var e=$('<div class="list-item-column column-1">');o.fileTypeIcon.call(e,t),this.append(e)}},{id:"displayname",index:300,draw:function(t){this.append($('<div class="list-item-column column-2">').append($('<div class="displayname">').text(t.model.getDisplayName())))}},{id:"share-icon",index:400,draw:function(t){if(!_.device("smartphone")&&(!l.has("!gab || alone")||f(t))){var e="fa-link",i=c("Public link");m(t)&&f(t)?(e="fa-user-plus",i=c("Internal and external users")):m(t)?(e="fa-user-plus",i=c("External users")):f(t)&&(e="fa-user",i=c("Internal users")),this.append($('<div class="list-item-column type">').append($('<i class="fa">').addClass(e).attr("title",i)))}}},{id:"breadcrumb",index:800,draw:function(t){if(!_.device("smartphone")){var e=t.model,s=new i({folder:e.getFolderID(),exclude:["9"],notail:!0,isLast:!0});s.handler=function(t){ox.launch("io.ox/files/main",{folder:t}).done(function(){this.folder.set(t)})},this.append($('<div class="list-item-column column-3 gray">').append(s.render().$el))}}},{id:"date",index:1e3,draw:function(t){var e=$('<div class="list-item-column column-4 gray">');o.smartdate.call(e,t),this.append(e)}}),y});