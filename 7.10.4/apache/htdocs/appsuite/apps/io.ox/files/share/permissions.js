define("io.ox/files/share/permissions",["io.ox/core/extensions","io.ox/backbone/views/disposable","io.ox/core/yell","io.ox/backbone/mini-views","io.ox/backbone/mini-views/dropdown","io.ox/core/folder/api","io.ox/files/api","io.ox/files/share/api","io.ox/contacts/api","io.ox/backbone/views/modal","io.ox/contacts/util","io.ox/core/settings/util","io.ox/core/tk/typeahead","io.ox/participants/model","io.ox/participants/views","io.ox/core/capabilities","io.ox/core/folder/util","gettext!io.ox/core","settings!io.ox/contacts","io.ox/backbone/mini-views/addresspicker","io.ox/core/util","io.ox/core/api/group","static/3rd.party/polyfill-resize.js","less!io.ox/files/share/style"],function(e,t,i,o,s,n,r,a,l,d,c,p,u,h,m,g,f,v,w,y,b,x){"use strict";function k(e){return e.isFolder()?257:1}var M="io.ox/files/share/permissions",N={viewer:{bit:257,label:v("Viewer")},reviewer:{bit:33025,label:v("Reviewer")},author:{bit:4227332,label:v("Author")},administrator:{bit:272662788,label:v("Administrator")},owner:{bit:272662788,label:v("Owner")}},E={viewer:1,reviewer:2,author:4},R=Backbone.Model.extend({idAttribute:"entity",defaults:{group:!1,bits:0},initialize:function(){this.has("type")&&"group"===this.get("type")&&this.set("group",!0)},isMyself:function(){return"user"===this.get("type")&&this.get("entity")===ox.user_id},isGroup:function(){return"group"===this.get("type")},isUser:function(){return"user"===this.get("type")},isPerson:function(){return this.isUser()||this.isGuest()},isInternal:function(){var e=this.get("type");return"user"===e||"group"===e},isGuest:function(){return"guest"===this.get("type")},isAnonymous:function(){return"anonymous"===this.get("type")},isOwner:function(e){if(this.get("entity")&&e&&_.isFunction(e.getOwner))return this.get("entity")===e.getOwner()},getDisplayName:function(e){switch(this.get("type")){case"user":return c.getFullName(this.get("contact"),e);case"group":return this.get("display_name");case"guest":var t=this.get("contact");return t[t.field]||t.email1;case"anonymous":return v("Public link")}},getEmail:function(){return c.getMail(this.get("contact"))},getSortName:function(){var e={};switch(this.get("type")){case"user":return(e=this.get("contact")).last_name||e.first_name||e.display_name;case"group":return this.get("display_name");case"guest":return(e=this.get("contact"))[e.field]||e.email1;case"anonymous":return""}},toJSON:function(){var e=this.get("type"),t={bits:this.get("bits")};if(this.has("entity"))t.entity=this.get("entity"),t.group="group"===e;else switch(e){case"guest":t.type=e;var i=this.get("contact");t.email_address=i[i.field]||i.email1,this.has("display_name")&&(t.display_name=this.get("display_name")),i&&i.id&&i.folder_id&&(t.contact_id=i.id,t.contact_folder=i.folder_id);break;case"anonymous":t.type=e}return t}}),A=Backbone.Collection.extend({model:R,isAlreadyGuest:function(e){var t=this.where({type:"guest"}),i=!1;try{for(var o=0;o<t.length;o++)t[o].attributes.contact.email1===e.contact[e.field]&&(i=!0)}catch(e){ox.debug&&console.error(e)}return i},comparator:function(e,t){if(e.isMyself())return-1;if(t.isMyself())return 1;var i,o=e.getSortName(),s=t.getSortName();return i=o===s?0:o>s?1:-1,e.isGroup()&&t.isGroup()?i:e.isGroup()?-1:t.isGroup()?1:e.isUser()&&t.isUser()?i:e.isUser()?-1:t.isUser()?1:e.isGuest()&&t.isGuest()?i:e.isGuest()?-1:(t.isGuest(),1)}}),F=t.extend({className:"permission row",initialize:function(e){if("anonymous"===this.model.get("type")){var t,i=this,o=function(){i.model.collection.remove(i.model),i.remove()};t=e.parentModel.isFile()?"remove:link:infostore:"+e.parentModel.get("folder_id")+":"+e.parentModel.get("id"):"remove:link:"+e.parentModel.get("module")+":"+e.parentModel.get("id"),a.on(t,o),this.on("dispose",function(){a.off(t,o)})}this.parentModel=e.parentModel,this.user=null,this.display_name="",this.description="",this.ariaLabel="",this.parseBitmask(),this.listenTo(this.model,"change:bits",this.onChangeBitmask),this.listenTo(this.model,"change:folder change:read change:write change:delete change:admin",this.updateBitmask)},onChangeBitmask:function(){this.parseBitmask()},parseBitmask:function(){var e=n.Bitmask(this.model.get("bits"));this.model.set({folder:e.get("folder"),read:e.get("read"),write:e.get("write"),delete:e.get("delete"),admin:e.get("admin")})},updateBitmask:function(){var e=n.Bitmask(this.model.get("bits"));e.set("folder",this.model.get("folder")),e.set("read",this.model.get("read")),e.set("write",this.model.get("write")),e.set("delete",this.model.get("delete")),e.set("admin",this.model.get("admin")),this.model.set("bits",e.get())},render:function(){if(this.getEntityDetails(),"anonymous"===this.model.get("type"))return!1;this.$el.attr({"aria-label":this.ariaLabel+".",role:"group"});var t=e.Baton({model:this.model,view:this,parentModel:this.parentModel});return e.point(M+"/entity").invoke("draw",this.$el.empty(),t),this.$el.find('a[data-name="edit"]').on("click",this.onEdit.bind(this)),this.$el.find('a[data-name="resend"]').on("click",this.onResend.bind(this)),this.$el.find('a[data-name="revoke"]').on("click",this.onRemove.bind(this)),this},onRemove:function(e){e.preventDefault(),this.model.collection.remove(this.model),this.remove()},onResend:function(e){e.preventDefault();var t=this.parentModel.isFile()?"file":"folder",o=this.parentModel.get("id"),s=this.model.get("entity");a.resend(t,o,s).then(function(){i("success",v("The notification has been resent"))},function(e){i(e)})},onEdit:function(e){function t(e){var t=new r.Model(e);ox.load(["io.ox/files/actions/share"]).done(function(e){i.hide(),e.link([t]).one("close",function(){i.show(),i=t=null})})}e.preventDefault();var i=this.$el.closest(".share-permissions-dialog");this.parentModel.isFile()?t(this.parentModel.attributes):n.get(this.parentModel.get("id")).done(t)},getEntityDetails:function(){switch(this.model.get("type")){case"user":this.user=this.model.get("contact"),this.display_name=c.getFullName(this.user),this.description=v("Internal user");break;case"group":this.display_name=this.model.get("display_name"),this.description=v("Group");break;case"guest":this.user=this.model.get("contact"),this.display_name=this.user[this.user.field]||this.user.email1,this.description=v("Guest");break;case"anonymous":this.display_name=this.ariaLabel=v("Public link"),this.description=this.model.get("share_url")}this.ariaLabel=this.ariaLabel||this.display_name+", "+this.description},getRole:function(){var e,t=this.model.get("bits");if(this.parentModel.isFile()){if(2===t||4===t)return"reviewer"}else{if(this.model.isOwner(this.parentModel))return"owner";if((e=n.Bitmask(this.model.get("bits"))).get("admin"))return"administrator";if(e.get("read")&&e.get("write"))return e.get("delete")?"author":"reviewer"}return"viewer"},getRoleDescription:function(e){return e=e||this.getRole(),N[e]?N[e].label:"N/A"},supportsAdminRole:function(){if(this.parentModel.isFile())return!1;var e=this.parentModel.get("type"),t=this.parentModel.get("module");return String(n.getDefaultFolder(t))!==this.parentModel.get("id")&&(5!==e&&((2!==e||0!==this.model.id)&&(1!==e||"contacts"!==t&&"calendar"!==t)))}}),B=t.extend({tagName:"div",className:"permissions-view container-fluid",initialize:function(){this.collection=new A,this.listenTo(this.collection,"reset",this.renderAllEntities),this.listenTo(this.collection,"add",this.renderEntity)},render:function(){return this.model.isExtendedPermission()?this.collection.reset(this.model.getPermissions()):console.error("Extended permissions are mandatory",this),this},renderAllEntities:function(){return this.$el.empty().append(this.collection.map(function(e){return new F({model:e,parentModel:this.model}).render().$el},this)),this},renderEntity:function(e){var t=this.$el.children(),i=this.collection.indexOf(e),o=new F({model:e,parentModel:this.model}).render().$el;0===i?this.$el.prepend(o):t.length>1?this.$el.children().eq(i-1).after(o):this.$el.append(o)}});e.point(M+"/entity").extend({index:100,id:"image",draw:function(e){var t=$('<div class="col-sm-1 col-xs-2 image">'),i=$('<span class="contact-picture">');e.view.user?t.append(l.pictureHalo(i,e.view.user,{width:40,height:40})):t.append(i.addClass("group").append($('<i class="fa fa-'+("group"===e.model.get("type")?"group":"link")+'" aria-hidden="true">'))),this.append(t)}},{index:200,id:"who",draw:function(e){var t=e.model.get("share_url");this.append($('<div class="col-sm-5 col-xs-10">').append($('<div class="display_name">').append(e.model.isUser()?e.model.getDisplayName(!0):$.txt(e.model.getDisplayName())),$('<div class="description">').append(t?$('<a href="" target="_blank">').attr("href",t).text(t):$.txt(e.view.description))))}},{index:210,id:"userid",draw:function(e){if(e.model.isUser()){var t=this.find(".description:first"),i=e.model.getEmail(),o=_.first(i.split("@"));o&&t.append($('<span class="post-description">').text(" ("+o+")"))}}},{index:300,id:"role",draw:function(e){var t,i,o=e.view.getRole(),n=e.view.getRoleDescription(o),r=e.parentModel.isFile(),a=e.model.isOwner(e.parentModel),l=e.parentModel.get("module"),d=e.model.isInternal()||!/^(contacts|calendar|tasks)$/.test(l);e.model.set("role",o,{silent:!0}),t=$('<div class="col-sm-3 col-sm-offset-0 col-xs-4 col-xs-offset-2 role">'),!e.parentModel.isAdmin()||a||!d||e.model.isAnonymous()?t.text(n):(i=new s({el:t.addClass("dropdown")[0],caret:!0,label:n,title:v("Current role"),model:e.model,smart:!0,buttonToggle:!0}).option("role","viewer",function(){return[$.txt(v("Viewer")),$.txt(" "),$("<small>").text(v("(Read only)"))]}).option("role","reviewer",function(){return[$.txt(v("Reviewer")),$.txt(" "),$("<small>").text(v("(Read and write)"))]}),r||i.option("role","author",function(){return[$.txt(v("Author")),$.txt(" "),$("<small>").text(v("(Read, write, and delete)"))]}),e.view.supportsAdminRole()&&i.divider().option("role","administrator",v("Administrator")),e.view.listenTo(e.model,{change:_.debounce(function(t){o=e.view.getRole(),t.set("role",o,{silent:!0}),i.$(".dropdown-label").text(e.view.getRoleDescription(o))},10),"change:role":function(e,t){e.set("bits",r?E[t]:N[t].bit)}}),i.render()),this.append(t)}},{index:400,id:"detail-dropdown",draw:function(e){var t=e.model,i=t.isAnonymous(),o=e.parentModel.get("module"),n=t.isInternal()||!/^(contacts|calendar|tasks)$/.test(o);if(i)this.append('<div class="col-sm-2 col-xs-4">');else{if(e.parentModel.isFile()){var r=t.get("bits");return(r<1||r>4)&&t.set("bits",1),void this.append($('<div class="col-sm-2 col-xs-4 detail-dropdown">'))}var a=64===t.get("folder")?64:4,l=64===t.get("read")?64:2,d=64===t.get("write")?64:2,c=64===t.get("delete")?64:2,p=new s({caret:!0,keep:!0,label:v("Details"),title:v("Detailed access rights"),model:t,smart:!0,buttonToggle:!0}).group(v("Folder")).option("folder",1,v("View the folder"),{radio:!0,group:!0}).option("folder",2,v("Create objects"),{radio:!0,group:!0}).option("folder",a,v("Create objects and subfolders"),{radio:!0,group:!0}).divider().group(v("Read permissions")).option("read",0,v("None"),{radio:!0,group:!0}).option("read",1,v("Read own objects"),{radio:!0,group:!0}).option("read",l,v("Read all objects"),{radio:!0,group:!0}).divider().group(v("Write permissions")).option("write",0,v("None"),{radio:!0,group:!0}).option("write",1,v("Edit own objects"),{radio:!0,group:!0}).option("write",d,v("Edit all objects"),{radio:!0,group:!0}).divider().group(v("Delete permissions")).option("delete",0,v("None"),{radio:!0,group:!0}).option("delete",1,v("Delete own objects"),{radio:!0,group:!0}).option("delete",c,v("Delete all objects"),{radio:!0,group:!0});e.view.supportsAdminRole()&&p.divider().group(v("Administrative role")).option("admin",0,v("User"),{radio:!0,group:!0}).option("admin",1,v("Administrator"),{radio:!0,group:!0}),p.render(),e.parentModel.isAdmin()&&n||p.$("li > a").addClass("disabled").prop("disabled",!0),this.append($('<div class="col-sm-2 col-xs-4 detail-dropdown">').append(p.$el))}}},{index:500,id:"actions",draw:function(e){var t=n.Bitmask(e.parentModel.get("own_rights")).get("admin")>=1;if(e.parentModel.isAdmin()&&(!t||!e.model.isOwner(e.parentModel))){var i=new s({label:$('<i class="fa fa-bars" aria-hidden="true">'),smart:!0,title:v("Actions"),buttonToggle:!0}),o=e.model.get("type"),r=e.model.isMyself(),a=e.model.has("new"),l="mail"===e.parentModel.get("module");switch(o){case"group":i.link("revoke",v(a?"Remove":"Revoke access"));break;case"user":case"guest":r||a||l||i.link("resend",v("Resend invitation")).divider(),i.link("revoke",v(a?"Remove":"Revoke access"));break;case"anonymous":g.has("share_links")&&i.link("edit",v("Edit")).divider(),i.link("revoke",v(a?"Remove":"Revoke access"))}this.append($('<div class="col-sm-1 col-xs-2 entity-actions">').append(i.render().$el))}}});var P={Permission:R,Permissions:A,showFolderPermissions:function(e,t){P.showByModel(new Backbone.Model({id:e}),t)},showFilePermissions:function(e,t){P.showByModel(new Backbone.Model(e),t)},showByModel:function(e,t){var o=e.isFile?e.isFile():e.has("folder_id");(e=new a.Model(o?e.pick("id","folder_id"):e.pick("id"))).loadExtendedPermissions({cache:!1}).done(function(){P.show(e,t)}).fail(function(e){i(e)})},showShareDialog:function(e){P.show(e,{share:!0})},isOrIsUnderPublicFolder:function(e){function t(e){if("15"===e)return!0;if("9"===e||"1"===e||"0"===e||void 0===e)return!1;var i=n.pool.getModel(e);return t(i&&i.get("folder_id"))}return t(e.isFolder()?e.get("id"):e.get("folder_id"))},show:function(t,s){function a(){var e=[];return _.each(A.get("oldGuests"),function(t){F.collection.get(t)&&e.push(t)}),F.collection.where({type:"guest"}).length>e.length}var c,f=n.isNested(t.get("module")),N=!this.isOrIsUnderPublicFolder(t);(s=_.extend({async:!0,focus:".form-control.tt-input",help:"ox.appsuite.user.sect.dataorganisation.sharing.invitation.html",title:void 0,smartphoneInputFocus:!0,width:800,nested:f,share:!1},s)).title=s.title||(s.share?v('Share %1$s "%2$s"',v(t.isFile()?"file":"folder"),t.getDisplayName()):v('Permissions for %1$s "%2$s"',v(t.isFile()?"file":"folder"),t.getDisplayName())),s.point="io.ox/files/share/permissions/dialog";var E=new d(s),A=new(Backbone.Model.extend({defaults:{cascadePermissions:f,message:"",sendNotifications:N,disabled:!1},toJSON:function(){var e={cascadePermissions:this.get("cascadePermissions"),notification:{transport:"mail"}};return A.get("sendNotifications")?this.get("message")&&""!==$.trim(this.get("message"))&&(e.notification.message=this.get("message")):delete e.notification,e}})),F=new B({model:t,share:s.share});F.listenTo(F.collection,"reset",function(){A.set("oldGuests",_.copy(F.collection.where({type:"guest"})))}),F.listenTo(F.collection,"add remove",function(){0!==F.collection.where({type:"guest"}).length&&a()?(A.set("sendNotifications",!0),A.set("disabled",!0),A.unset("byHand")):(A.set("sendNotifications",N),A.set("disabled",!1)),void 0!==A.get("byHand")&&(A.set("sendNotifications",A.get("byHand")),A.set("disabled",!1))}),t.isAdmin()&&E.$footer.prepend($('<div class="form-group">').addClass(_.device("smartphone")?"":"cascade").append(p.checkbox("sendNotifications",v("Send notification by email"),A).on("change",function(e){var t=e.originalEvent.srcElement;A.set("byHand",t.checked)}))),A.on("change:disabled",function(){E.$footer.find('[name="sendNotifications"]').prop("disabled",A.get("disabled"))}),E.$el.addClass("share-permissions-dialog"),E.$body.addClass(_.browser.IE?"IE11":"").append(F.render().$el);var P=t.isAdmin(),D=t.getFolderModel(),C=P&&D.supportsInternalSharing(),G=D.supportsInviteGuests();if(C){e.point(M+"/autoCompleteItem").extend({id:"view",index:100,draw:function(e){this.append(new m.ParticipantEntryView({model:e,closeButton:!1,halo:!1,field:!0}).render().$el)}});var I=t.get("module"),O=!_.device("smartphone")&&g.has("contacts")&&w.get("picker/enabled",!0),S=function(e,i){var o=/^(1|2)$/.test(i.get("type"))||i.has("user_id"),s=!o&&5===i.get("type"),n={bits:o?4227332:k(t),group:2===i.get("type"),type:2===i.get("type")?"group":"user",new:!0};o&&(n.entity=i.has("user_id")?i.get("user_id"):i.get("id")),n.contact=i.toJSON(),n.display_name=i.getDisplayName(),s&&(n.type="guest",n.contact_id=i.get("id"),n.folder_id=i.get("folder_id"),n.field=i.get("field"),F.collection.isAlreadyGuest(n))||F.collection.add(new R(n))},T=new u({apiOptions:{contacts:G,users:!0,groups:!0},placeholder:v("Add people"),harmonize:function(e){return e=_(e).map(function(e){return new h.Participant(e)}),_(e).filter(function(e){return!(!G&&"email1"!==e.get("field"))&&(("mail"!==I||"email1"===e.get("field"))&&!F.collection.get(e.id))})},click:S,extPoint:M});t.isFolder()&&s.nested&&E.$footer.append($('<div class="form-group">').addClass(_.device("smartphone")?"":"cascade").append(p.checkbox("cascadePermissions",v("Apply to all subfolders"),A).on("change",function(e){var t=e.originalEvent.srcElement;A.set("cascadePermissions",t.checked)}))),E.$header.append($('<div class="row">').append($('<div class="form-group col-sm-6">').append($('<div class="input-group">').toggleClass("has-picker",O).append($('<label class="sr-only">',{for:c=_.uniqueId("form-control-label-")}).text(v("Start typing to search for user names")),T.$el.attr({id:c}),O?new y({isPermission:!0,process:S,useGABOnly:!G}).render().$el:[])).on("keydown blur","input",function(e){if("mail"!==I&&G&&("keydown"!==e.type||13===e.which)){var i=$.trim($(this).typeahead("val")),o=b.getAddresses(i);_.each(o,function(e){_.isEmpty(e)||F.collection.add(new R({bits:k(t),contact:{email1:e},type:"guest",new:!0}))}),$(this).typeahead("val","")}}))),E.$body.append($('<div class="share-options form-group">').toggle(N).addClass(_.browser.IE?"IE":"nonIE").append($('<label class="control-label sr-only">').text(v("Enter a Message to inform users")).attr({for:c=_.uniqueId("form-control-label-")}),new o.TextView({name:"message",model:A}).render().$el.addClass("message-text").attr({id:c,rows:3,placeholder:v("Personal message (optional). This message is sent to all newly invited people.")}))),_.browser.IE&&window.resizeHandlerPolyfill(E.$body.find(".message-text")[0]),E.listenTo(A,"change:sendNotifications",function(e,t){this.$(".message-text").parent().toggle(t)}),T.render()}P?E.addCancelButton().addButton({action:"save",label:v(s.share?"Share":"Save")}):E.addButton({action:"cancel",label:v("Close")}),E.on("save",function(){var e,o,s=A.toJSON();t.isFolder()?(e={permissions:F.collection.toJSON()},o=n.update(t.get("id"),e,s)):(e={object_permissions:F.collection.toJSON()},o=r.update(t.pick("folder_id","id"),e,s)),o.then(function(){x.refreshGroup(2147483647),t.reload().then(function(){E.close(),l.trigger("maybeNewContact")},function(e){E.idle(),i(e)})},function(e){E.idle(),i(e)})}),E.open()}};return P});