define("io.ox/files/share/wizard",["io.ox/backbone/views/disposable","io.ox/core/extensions","io.ox/files/share/api","io.ox/files/share/model","io.ox/backbone/mini-views","io.ox/backbone/mini-views/dropdown","io.ox/contacts/api","io.ox/core/api/group","io.ox/core/tk/tokenfield","io.ox/core/yell","io.ox/core/settings/util","gettext!io.ox/files","settings!io.ox/contacts","io.ox/core/capabilities","io.ox/backbone/mini-views/addresspicker","io.ox/backbone/mini-views/copy-to-clipboard","io.ox/core/folder/util","static/3rd.party/polyfill-resize.js","less!io.ox/files/share/style"],function(e,o,i,n,t,r,s,d,a,l,c,p,u,f,m,h,x){"use strict";var g=0,v="io.ox/files/share/wizard";return o.point(v+"/fields").extend({id:"description",index:g+=100,draw:function(){this.append($('<span class="help-block">').text(p("You can copy and paste this link in an email, instant messenger or social network. Please note that anyone with this link can access the share.")))}}),o.point(v+"/fields").extend({id:"link",index:g+=100,draw:function(e){var o,i=e.model.get("url",""),n=_.uniqueId("form-control-label-");this.append(o=$('<div class="form-group">').append($("<label>").attr("for",n).text(),$('<div class="input-group link-group">').append($('<input type="text" class="form-control" readonly>').attr("id",n).val(i).on("focus",function(){_.defer(function(){$(this).select()}.bind(this))})))),e.view.listenTo(e.model,"change:url",function(e,i){var n=o.find("input").val(i).select();_.device("ios")||n.focus()}),""===i&&e.model.fetch()}}),o.point(v+"/fields").extend({id:"link-to-clipboard",index:g+=100,draw:function(){var e=this.find(".link-group"),o="#"+e.find("input").attr("id");e.append($('<span class="input-group-btn">').append(new h({targetId:o}).render().$el))}}),o.point(v+"/fields").extend({id:"defaultOptions",index:g+=100,draw:function(e){var i=$('<div class="form-group shareoptions">');o.point(v+"/options").invoke("draw",i,e),this.append(i)}}),o.point(v+"/fields").extend({id:"recipients-tokenfield",index:g+=100,draw:function(e){var o=_.uniqueId("form-control-label-"),i=!_.device("smartphone")&&f.has("contacts")&&u.get("picker/enabled",!0),n=new a({id:o,extPoint:v,placeholder:p("Add recipients ..."),apiOptions:{contacts:!0,users:!0,groups:!1},leftAligned:!0});this.append($('<div class="form-group recipients">').addClass(_.browser.IE?"IE":"nonIE").append($('<div class="input-group has-picker">').append($('<label class="sr-only">').attr({for:o}).text(p("Add recipients ...")),n.$el,i?new m({isPermission:!0,process:function(o,i,n){var t={label:n.array[0],value:n.array[1]},r=e.model.get("recipients")||[];i.set("token",t),e.model.set("recipients",r.concat([i]))}}).render().$el:[]))),n.render(),n.listenTo(e.model,"change:recipients",function(e,o){n.redrawLock||n.collection.reset(o)}),n.collection.on("change add remove sort",function(){n.redrawLock=!0,e.model.set("recipients",this.toArray()),n.redrawLock=!1})}}),o.point(v+"/fields").extend({id:"message",index:g+=100,draw:function(e){var o,i=_.uniqueId("form-control-label-");this.append($('<div class="message">').addClass(_.browser.IE?"IE":"nonIE").append($('<label class="control-label sr-only">').text(p("Message (optional)")).attr({for:i}),o=new t.TextView({name:"message",model:e.model}).render().$el.attr({id:i,placeholder:p("Message (optional)")}))),_.browser.IE&&window.resizeHandlerPolyfill(o[0])}}),o.point(v+"/options").extend({id:"includeSubfolders",index:g+=100,draw:function(e){if(!_(e.model.get("files")).every(function(e){return!e.isFolder()||x.is("drive",e.attributes)})||!e.model.attributes||!e.model.attributes.files)return e.model.set("includeSubfolders",!1,{silent:!0});var o=!0;_.each(e.model.attributes.files,function(e){e.isFolder()&&(o=!1)}),o||(this.append($('<div class="form-inline">').append($('<div class="form-group">').append(c.checkbox("includeSubfolders",p("Share with subfolders"),e.model).on("change",function(o){var i=o.originalEvent.srcElement;e.model.set("includeSubfolders",i.checked)})))),e.model.once("change",function(e){var o=e.get("is_new"),i=!1;!0===o?(i=o,e.set("includeSubfolders",i)):i=e.get("includeSubfolders")}))}}),o.point(v+"/options").extend({id:"temporary",index:g+=100,draw:function(e){var o={0:p("one day"),1:p("one week"),2:p("one month"),3:p("three months"),4:p("six months"),5:p("one year")},i=new r({tagName:"span",model:e.model,label:o[e.model.get("expires")],caret:!0});e.model.get("expiry_date")&&i.$el.find(".dropdown-label").text(new moment(e.model.get("expiry_date")).format("L")),_(o).each(function(e,o){i.option("expires",parseInt(o,10),e)}),this.append($('<div class="form-inline">').append($('<div class="form-group expiresgroup">').append(c.checkbox("temporary",p("Expires in"),e.model).on("change",function(o){var i=o.originalEvent.srcElement;e.model.set("temporary",i.checked)}),$.txt(" "),i.render().$el.addClass("dropup")))),e.model.once("change",function(){e.model.get("expiry_date")&&e.model.set("expires",null)}),e.model.on("change:expiry_date",function(e,o){i.$el.find(".dropdown-label").text(new moment(o).format("L")),i.$el.closest(".expiresgroup").find("span.caption>span").text(p("Expires on")),e.set("temporary",!0)}),e.model.on("change:expires",function(o){null!==e.model.get("expires")&&o.set({temporary:!0,expiry_date:o.getExpiryDate()})})}}),o.point(v+"/options").extend({id:"secured",index:g+=100,draw:function(e){var o,i;this.append($('<div class="form-inline passwordgroup">').append($('<div class="form-group">').append(c.checkbox("secured",p("Password required"),e.model).on("change",function(o){var i=o.originalEvent.srcElement;e.model.set("secured",i.checked)})),$.txt(" "),$('<div class="form-group">').append($('<label class="control-label sr-only">').text(p("Enter Password")).attr({for:o=_.uniqueId("form-control-label-")}),i=new t.PasswordViewToggle({name:"password",model:e.model,autocomplete:!1}).render().$el.find("input").attr({id:o,placeholder:p("Password")}).removeAttr("name").prop("disabled",!e.model.get("secured")).end()))),e.view.listenTo(e.model,"change:password",function(e,o,i){o&&!e.get("secured")&&e.set("secured",!0,i)}),e.view.listenTo(e.model,"change:secured",function(e,o,n){var t=i.find("input");t.prop("disabled",!o),i.prop("disabled",!o),n._inital||t.focus()}),e.model.once("change",function(e){var o=i.find("input"),n=!1;e.get("password")&&(n=!0),e.set("secured",n),o.prop("disabled",!n),i.prop("disabled",!n)})}}),e.extend({className:"share-wizard",initialize:function(e){this.model=new n.WizardShare({files:e.files}),this.baton=o.Baton({model:this.model,view:this}),this.listenTo(this.model,"invalid",function(e,o){l("error",o)})},render:function(){return this.$el.addClass(this.model.get("type")),o.point(v+"/fields").invoke("draw",this.$el,this.baton),this},share:function(){s.trigger("maybeNewContact");var e;if(this.model.get("secured")&&_.isString(this.model.validationError))e=$.Deferred().reject("error",this.model.validationError);else if(!1===(e=this.model.save()))return $.Deferred().reject();return e.fail(l)},removeLink:function(){var e=this.model;return i.deleteLink(e.toJSON(),e.get("lastModified")).done(function(){d.refreshGroup(2147483647)}).done(e.destroy.bind(e))}})});