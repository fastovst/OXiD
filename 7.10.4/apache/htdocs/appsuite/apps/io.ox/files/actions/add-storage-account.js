define("io.ox/files/actions/add-storage-account",["io.ox/backbone/views/modal","io.ox/metrics/main","io.ox/core/yell","gettext!io.ox/files","io.ox/oauth/keychain","io.ox/core/api/filestorage","io.ox/oauth/backbone"],function(e,o,t,n,c,i,a){"use strict";function r(e){var o=new a.Account.Model({serviceId:e.id,displayName:c.chooseDisplayName(e)}),r={};return u[e.id]&&(r.displayName=n("My %1$s",u[e.id])),c.accounts.forService(e.id)[0]&&_(o.attributes.enabledScopes).contains("drive")&&!i.getAccountForOauth(o.attributes)?i.createAccountFromOauth(o.attributes,r).done(function(){t("success",n("Account added successfully"))}):o.enableScopes("drive").save().then(function(e){return require("io.ox/core/folder/api").once("pool:add",function(){var o=c.accounts.get(e.id);o&&o.fetch()}),i.createAccountFromOauth(e,r)}).then(function(){t("success",n("Account added successfully"))})}function s(){var e=this,s=c.services.filter(function(e){return e.canAdd({scopes:["drive"]})&&i.isStorageAvailable(e.id)}),u=new a.Views.ServicesListView({collection:new Backbone.Collection(s)});u.listenTo(u,"select",function(e){r(e).fail(function(e){e&&"EEXISTS"===e.code?t("error",n("Account already exists")):e?t(e):t("error",n("Account could not be added"))}).always(function(){u.trigger("done")})}),u.listenTo(u,"done",function(){u.stopListening(),u=null,e.close()}),o.isEnabled()&&u.listenTo(u,"select",function(e){o.trackEvent({app:"drive",target:"folder/account/add",type:"click",action:e.get("id")||"unknown"})}),e.$body.append(u.render().$el)}var u={"com.openexchange.oauth.google":"Google Drive","com.openexchange.oauth.boxcom":"Box Drive","com.openexchange.oauth.dropbox":"Dropbox","com.openexchange.oauth.microsoft.graph":"OneDrive"};return function(){return new e({title:n("Add storage account"),width:576}).addButton({label:n("Close"),action:"close"}).build(s).open()}});