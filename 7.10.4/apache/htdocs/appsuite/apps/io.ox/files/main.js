define("io.ox/files/main",["io.ox/core/commons","gettext!io.ox/files","settings!io.ox/files","settings!io.ox/core","io.ox/core/extensions","io.ox/core/folder/api","io.ox/core/api/jobs","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/files/listview","io.ox/core/tk/list-control","io.ox/backbone/mini-views/toolbar","io.ox/backbone/views/actions/util","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/core/capabilities","io.ox/files/api","io.ox/core/tk/sidebar","io.ox/core/viewer/views/sidebarview","io.ox/backbone/mini-views/quota","io.ox/core/notifications","io.ox/backbone/views/toolbar","io.ox/files/mobile-navbar-extensions","io.ox/files/mobile-toolbar-actions","io.ox/files/actions","less!io.ox/files/style","less!io.ox/core/viewer/style","io.ox/files/toolbar","io.ox/files/upload/dropzone","io.ox/core/folder/breadcrumb","io.ox/files/contextmenu"],function(e,o,t,i,n,r,s,l,a,d,c,f,u,p,g,h,w,v,m,b,y,x){"use strict";var V,k=ox.ui.createApp({id:"io.ox/files",name:"io.ox/files",title:"Drive"}),C=new m({closable:!0,app:k});k.mediator({"pages-desktop":function(e){if(!_.device("smartphone")){var o=e.getWindow().nodes.main;e.pages=new g(e),e.pages.addPage({name:"main",container:o,startPage:!0})}},"refresh-from-broadcast":function(){if(ox.tabHandlingEnabled){var e=require("io.ox/core/api/tab").communicationEvents;e.listenTo(e,"refresh-file",function(e){w.propagate("refresh:file",_.pick(e,"folder_id","id"))})}},"pages-mobile":function(e){if(!_.device("!smartphone")){var o=e.getWindow(),t=$('<div class="mobile-navbar">'),i=$('<div class="mobile-toolbar">').on("hide",function(){o.nodes.body.removeClass("mobile-toolbar-visible")}).on("show",function(){o.nodes.body.addClass("mobile-toolbar-visible")}),r=n.Baton({app:e});e.navbar=t,e.toolbar=i,e.pages=new g({appname:e.options.name,toolbar:i,navbar:t,container:o.nodes.main}),o.nodes.body.addClass("classic-toolbar-visible").append(t,i),e.pages.addPage({name:"folderTree",navbar:new p.NavbarView({baton:r,extension:"io.ox/files/mobile/navbar"})}),e.pages.addPage({name:"main",startPage:!0,navbar:new p.NavbarView({baton:r,extension:"io.ox/files/mobile/navbar"}),toolbar:new p.ToolbarView({baton:r,page:"main",extension:"io.ox/files/mobile/toolbar"}),secondaryToolbar:new p.ToolbarView({baton:r,page:"main/multiselect",extension:"io.ox/files/mobile/toolbar"})}),e.pages.setBackbuttonRules({main:"folderTree"})}},"navbars-mobile":function(e){_.device("smartphone")&&(e.pages.getNavbar("main").setLeft(o("Folders")).setRight(o("Edit")),e.pages.getNavbar("folderTree").setTitle(o("Folders")).setLeft(!1).setRight(o("Edit")),e.pages.getNavbar("main").on("leftAction",function(){e.pages.goBack()}).hide(".right"),e.pages.showPage("main"))},"folder-view":function(e){_.device("smartphone")||(e.treeView=new l({app:e,module:"infostore",root:t.get("rootFolderId",9),contextmenu:!0}),a.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable(),r.on("error:FILE_STORAGE-0004",function(e,o){o&&r.pool.removeCollection(o,{removeModels:!0})}))},"pdf-preconversion":function(){function e(e){return w.get(e).then(function(e){return w.pool.get("detail").get(_.cid(e))})}function o(e){return require(["io.ox/core/tk/doc-converter-utils"]).then(function(o){return o.getEncodedConverterUrl(e,{async:!0})})}function t(e){var o=e.toJSON();return w.isWordprocessing(o)||w.isPresentation(o)||w.isSpreadsheet(o)&&!h.has("spreadsheet")}h.has("document_preview")&&!1!==i.get("pdf/enablePreconversionOnUpload")&&w.on("add:file add:version",function(i){e(i).then(function(e){return t(e)?o(e):$.Deferred().reject()}).then(function(e){$.ajax({url:e,dataType:"text"})})})},"files-quota":function(e){if(!_.device("smartphone")){var t=new b({title:o("unified"===i.get("quotaMode","default")?"Quota":"File quota"),renderUnlimited:!1,module:"file",upsell:{title:o("Need more space?"),requires:"boxcom || google || microsoftgraph",id:"files-folderview-quota",icon:""},upsellLimit:5242880});r.on("clear",function(){t.getQuota(!0)}),w.on("add:file remove:file add:version remove:version",function(){t.getQuota(!0)}),w.on("copy",function(){t.getQuota(!0)}),e.treeView.$el.append(t.render().$el)}},"long-running-jobs":function(){s.on("added:infostore",function(){require(["io.ox/core/yell"],function(e){e("info",o("Move operation takes longer to finish"))})}),s.on("finished:infostore",_.debounce(function(){require(["io.ox/core/yell"],function(e){e("info",o("Finished moving"))})},50))},"folder-view-mobile":function(e){if(!_.device("!smartphone")){var o=e.pages.getNavbar("folderTree"),i=e.pages.getPage("folderTree");o.on("rightAction",function(){e.toggleFolders()});var n=new l({app:e,contextmenu:!0,module:"infostore",root:t.get("rootFolderId",9)});e.treeView=n,a.initialize({app:e,tree:n,firstResponder:"main"}),i.append(n.render().$el)}},"change:folder-mobile":function(e){function o(){e.folder.getData().done(function(o){e.pages.getNavbar("main").setTitle(o.title)})}_.device("!smartphone")||(e.on("folder:change",o),o())},"get-view-options":function(e){e.getViewOptions=function(o){var t=e.settings.get(["viewOptions",o],{}),i=702,n="asc";return("virtual/myshares"===o||r.is("attachmentView",{id:o}))&&(i=5,n="desc"),/^(list|icon|tile)/.test(t.layout)||(t.layout="list"),_.extend({sort:i,order:n,layout:"list"},t)}},props:function(e){var o=e.settings.get("layout");/^(list|icon|tile)/.test(o)||(o="list"),e.props=new Backbone.Model({checkboxes:!_.device("smartphone")&&e.settings.get("showCheckboxes",!1),filter:"all",layout:o,folderEditMode:!1,details:!_.device("touch")&&e.settings.get("showDetails",!0)});var t=e.folder.get();t&&e.props.set(e.getViewOptions(t))},"list-view":function(e){e.listView=new d({app:e,draggable:!0,ignoreFocus:!0,noSwipe:!0,noPullToRefresh:!0}),e.listView.model.set({folder:e.folder.get(),sort:e.props.get("sort"),order:e.props.get("order")}),window.list=e.listView},"list-view-control":function(e){e.listControl=new c({id:"io.ox/files/listviewcontrol",listView:e.listView,app:e}),(_.device("smartphone")?e.pages.getPage("main"):e.getWindow().nodes.main).append(e.listControl.render().$el.attr({"aria-label":o("Files")}).find(".toolbar").attr("aria-label",o("Files options")).end())},"connect-loader":function(e){e.listView.connect(w.collectionLoader)},"folder:change":function(e){e.folderView.tree.selection.view.on("scrollIntoView",function(){e.getWindow().nodes.sidepanel.hide().show(0)}),e.on("folder:change",function(o){e.listView.empty();var t=e.getViewOptions(o);e.props.set(t),e.listView.model.set("folder",null,{silent:!0}),e.listView.model.set("folder",o)}),e.on("folder-virtual:change",function(o){e.listView.empty();var t=e.getViewOptions(o);e.props.set(t),e.listView.model.set(t),e.listView.model.set("folder",null,{silent:!0}),e.listView.model.set("folder",o)})},getContextualData:function(e){e.getContextualData=function(o,t){var i={folder_id:e.folder.get(),app:e,allIds:[],originFavorites:!1,originMyShares:!1};switch(t){case"favorites":i.all=this.myFavoriteListView.collection,i.originFavorites=!0;break;case"shares":i.all=this.mysharesListView.collection,i.originMyShares=!0;break;default:i.all=this.listView.collection}return i.models="shares"===t?o.map(function(e){return i.all.get(e)}):w.resolve(o,!1),i.data=_(i.models).invoke("toJSON"),i}},"myshares-listview":function(e){if(!h.has("guest")&&h.has("gab || share_links")){r.virtual.add("virtual/myshares",function(){return $.when([])});var t=!1;e.folderView.tree.on({virtual:function(i){if("virtual/myshares"===i){if(e.folder.unset(),e.getWindow().setTitle(o("My shares")),e.mysharesListViewControl)return e.mysharesListViewControl.$el.show().siblings().hide(),void e.updateMyshareToolbar([]);e.getWindow().nodes.body.busy().children().hide(),t||(t=!0,require(["io.ox/files/share/listview","io.ox/files/share/api","io.ox/files/share/toolbar"],function(o,i){e.mysharesListView=new o({app:e,pagination:!1,draggable:!1,ignoreFocus:!0,noSwipe:!0,noPullToRefresh:!0}),e.mysharesListViewControl=new c({id:"io.ox/files/share/myshares",listView:e.mysharesListView,app:e}),w.on("change:permissions",_.debounce(function(){e.mysharesListView.reload()}),10),r.on("change:permissions",_.debounce(function(){e.mysharesListView.reload()}),10),i.on("remove:link new:link",_.debounce(function(){e.mysharesListView.reload()}),10);var n=new x({point:"io.ox/files/share/toolbar/links",title:e.getTitle()});e.getWindow().nodes.body.prepend(e.mysharesListViewControl.render().$el.hide().addClass("myshares-list-control").prepend(n.$el)),e.updateMyshareToolbar=function(e){n.setSelection(e.map(_.cid),function(){return this.getContextualData(e,"shares")}.bind(this))},e.updateMyshareToolbar([]),e.mysharesListView.on("selection:change change",function(){e.updateMyshareToolbar(e.mysharesListView.selection.get())}),null===e.folder.get()&&e.mysharesListViewControl.$el.show().siblings().hide(),t=!1}))}},change:function(){e.mysharesListViewControl&&(e.mysharesListViewControl.$el.hide().siblings().show(),e.mysharesListView&&e.mysharesListView.trigger("listview:shown")),t&&e.getWindow().nodes.body.idle().children().show()}}),e.pages.getPage("main").on("myshares-folder-back",function(){e.folderView.tree.selection.getItems().removeClass("selected"),e.folderView.tree.selection.set(r.getDefaultFolder("infostore")),e.mysharesListViewControl.$el.hide().siblings().show()})}},"myfavorites-listview":function(e){var t=!1;e.folderView.tree.on({virtual:function(i){if("virtual/favorites/infostore"===i){if(e.folder.unset(),e.getWindow().setTitle(o("Favorites")),e.myFavoritesListViewControl)return e.myFavoritesListViewControl.$el.show().siblings().hide(),void e.updateMyFavoritesToolbar([]);e.getWindow().nodes.body.busy().children().hide(),t||(t=!0,require(["io.ox/files/favorite/listview"],function(o){e.myFavoriteListView=new o({app:e,pagination:!1,draggable:!1,ignoreFocus:!0,noSwipe:!0,noPullToRefresh:!0}),e.myFavoritesListViewControl=new c({id:"io.ox/files/favorite/myfavorites",listView:e.myFavoriteListView,app:e});var i=new x({point:"io.ox/files/toolbar/links",title:e.getTitle(),strict:!1});e.getWindow().nodes.body.prepend(e.myFavoritesListViewControl.render().$el.hide().addClass("myfavorites-list-control").prepend(i.$el)),e.updateMyFavoritesToolbar=_.debounce(function(e){i.setSelection(e.map(_.cid),function(){return this.getContextualData(e,"favorites")}.bind(this))},10),e.updateMyFavoritesToolbar([]),e.myFavoriteListView.on("selection:change change favorite:add favorite:remove",function(){e.updateMyFavoritesToolbar(e.myFavoriteListView.selection.get())}),null===e.folder.get()&&e.myFavoritesListViewControl.$el.show().siblings().hide(),t=!1}))}},change:function(){e.myFavoritesListViewControl&&(e.myFavoritesListViewControl.$el.hide().siblings().show(),e.myFavoriteListView.selection.clear(),e.mysharesListView&&e.mysharesListView.trigger("listview:shown")),t&&e.getWindow().nodes.body.idle().children().show()}}),e.pages.getPage("main").on("myfavorites-folder-back",function(){e.folderView.tree.selection.getItems().removeClass("selected"),e.folderView.tree.selection.set(r.getDefaultFolder("infostore")),e.myFavoritesListViewControl.$el.hide().siblings().show()})},attachmentViewUpdater:function(e){function o(){_(t).each(function(o){_(w.pool.getByFolder(o)).each(function(e){e.expired=!0}),e.folder.get()===o&&e.listView.reload()})}var t=i.get("folder/mailattachments",{});_.isEmpty(t)||(e.folderView.tree.on("change",o),require(["io.ox/mail/api"],function(e){e.on("delete new-mail copy update archive archive-folder",o)}))},"store-view-options":function(e){e.props.on("change",_.debounce(function(){if(!e.props.get("find-result")){var o=e.folder.get()||"virtual/myshares",t=e.props.toJSON();e.settings.set(["viewOptions",o],{sort:t.sort,order:t.order,layout:t.layout}),_.device("!smartphone")&&e.settings.set("showCheckboxes",t.checkboxes),e.settings.set("showDetails",t.details),e.settings.save().fail(function(i){if(!("SVL-0011"!==i.code&&_.keys(e.settings.get("viewOptions")).length<2500))return e.settings.set("viewOptions",{}).set(["viewOptions",o],{sort:t.sort,order:t.order,layout:t.layout}).save()})}},500)),e.listenTo(r,"remove:infostore",function(o){var t=e.settings.get("viewOptions",{});delete t[o.id],e.settings.set("viewOptions",t).save()})},"restore-view-options":function(e){var o=e.getViewOptions(e.folder.get());e.props.set(o)},"change:sort":function(e){e.props.on("change:sort",function(o,t){if(e.treeView){var i=e.listView.model,n=e.getViewOptions(e.treeView.selection.get());n?i.set("order",n.order,{silent:!0}):i.set("order",/^(5|704)$/.test(t)?"desc":"asc",{silent:!0}),e.props.set("order",i.get("order")),i.set("sort",t)}})},"change:order":function(e){e.props.on("change:order",function(o,t){e.listView.model.set("order",t)})},"selection:change":function(){function e(e,t){if(C.open)if(k.listView.selection.isEmpty())C.$(".detail-pane").empty().append($('<div class="io-ox-center">').append($('<div class="summary empty">').text(o("No elements selected"))));else{var i,n=t||k.listView.selection.get()[0];i=/^folder\./.test(n)?new w.Model(r.pool.getModel(n.replace(/^folder\./,"")).attributes):k.listView.collection.get(n),C.render(i),C.$("img").trigger("appear.lazyload"),C.$(".sidebar-panel-thumbnail").attr("aria-label",o("thumbnail"))}}_.device("touch")||(k.listView.on("selection:change",e),w.pool.get("detail").on("expired_models",function(o){C&&C.model&&-1!==_(o).indexOf(C.model.cid)&&e()}))},"change:filter":function(e){var o=!1;e.props.on("change:filter",function(t,i){if(e.listView.selection.selectNone(),w.collectionLoader.setMimeTypeFilter("all"===i?null:[i])){var n=e.listView.model.get("folder");_(w.pool.getByFolder(n)).each(function(e){e.expired=!0}),e.listView.empty();var r=e.getViewOptions(n);e.props.set(r),e.listView.model.set("folder",null,{silent:!0}),o=!0,e.listView.model.set("folder",n),o=!1}}),e.on("folder:change",function(){o||(w.collectionLoader.setMimeTypeFilter(null),e.props.set("filter","all"))})},resize:function(e){if(!_.device("smartphone")){var o=!1;$(window).on("resize",function(){var t,i,n,r=e.listView;o=!0,r.$el.is(":visible")&&(t=r.$el.width(),i="icon"===e.props.get("layout")?140:180,n=Math.max(1,Math.min(12,t/i>>0)),r.el.className=r.el.className.replace(/\s?grid-\d+/g,""),r.$el.addClass("grid-"+n).attr("grid-count",n),o=!1)}),$(window).trigger("resize"),e.on("resume",function(){o&&$(window).trigger("resize")})}},"change:layout":function(e){function o(){_.device("landscape")?e.listView.$el.removeClass("grid-2").addClass("grid-3"):e.listView.$el.removeClass("grid-3").addClass("grid-2")}e.applyLayout=function(){var t=e.props.get("layout");e.props.get("details")&&_.device("!touch")&&(C.open=!0,C.$el.toggleClass("open",!0),e.listView.trigger("selection:change")),"list"===t?(n.point("io.ox/core/viewer/sidebar/fileinfo").enable("thumbnail"),e.listView.$el.addClass("column-layout").removeClass("grid-layout icon-layout tile-layout")):"icon"===t?e.listView.$el.addClass("grid-layout icon-layout").removeClass("column-layout tile-layout"):e.listView.$el.addClass("grid-layout tile-layout").removeClass("column-layout icon-layout"),"list"!==t&&n.point("io.ox/core/viewer/sidebar/fileinfo").disable("thumbnail"),e.listView.trigger("selection:change"),_.device("smartphone")&&o()},_.device("smartphone")&&$(window).on("orientationchange",_.debounce(o,500)),e.props.on("change:layout",function(){_.defer(function(){e.applyLayout(),e.listView.redraw(),$(document).trigger("resize"),ox.ui.apps.trigger("layout",e)})}),e.applyLayout()},"selection-doubleclick":function(e){var o=_.device("touch")?"tap":"dblclick";e.listView.$el.on(o,".file-type-folder .list-item-content",function(o){var t=$(o.currentTarget).parent().attr("data-cid").replace(/^folder./,"");e.folder.set(t)}),e.listView.$el.on(o,".list-item:not(.file-type-folder) .list-item-content",function(o){var t=$(o.currentTarget).parent().attr("data-cid"),i=n.Baton(e.getContextualData([t]));u.invoke("io.ox/files/actions/default",i)})},"selection-enter":function(e){if(!_.device("smartphone")){var o=ox.tabHandlingEnabled?"keypress":"keydown";e.listView.$el.on(o,".file-type-folder",function(o){if(/13|32/.test(o.which)){o.preventDefault();var t=$(o.currentTarget).attr("data-cid").replace(/^folder./,"");e.listView.once("collection:load",function(){e.listView.selection.select(0)}),e.folder.set(t)}}),e.listView.$el.on(o,".list-item:not(.file-type-folder)",function(o){if(/13|32/.test(o.which)){o.preventDefault();var t=n.Baton(e.getContextualData(e.listView.selection.get()));u.invoke("io.ox/files/actions/default",t)}})}},"requires-reload":function(e){w.on("rename description add:version remove:version change:version change:file",_.debounce(function(){e.listView.reload()},100)),w.on("reload:listview",_.debounce(function(){e.listView.selection.clear(),e.listView.reload()},100)),w.on("refresh:listviews",_.debounce(function(){ox.trigger("refresh^")},100)),r.on("rename",_.debounce(function(o,t){t.folder_id===e.folder.get()?e.listView.reload():ox.trigger("refresh^")},100)),w.on("add:file",_.throttle(function(){e.listView.reload()},1e4)),w.on("stop:upload",_.bind(e.listView.reload,e.listView));var o=!1,t=_.debounce(function(){o&&(o=!1,e.listView.reload())},100);w.on("copy",function(i,n){e.folder.get()===n&&(o=!0),t()})},"select-uploaded-files":function(e){w.on("stop:upload",function(o){w.collectionLoader.collection.once("reload",function(){$.when.apply(this,o).done(function(){var o,t,i=e.listView.selection;o=_(arguments).map(_.cid),t=i.getItems(function(){var e=o.indexOf($(this).attr("data-cid"));return e>=0&&delete o[e],e>=0});var n=w.collectionLoader.PRIMARY_PAGE_SIZE-i.getItems().length;_.each(_.without(o,void 0).slice(0,n>0?n:0),function(o){var n=w.pool.get("detail").get(o);n&&e.folder.get()===n.get("folder_id")&&o&&e.listView.on("add:"+o,function(e){_.each(i.getItems(),function(o){$(o).attr("data-cid")===e.cid&&t.push(o)}),i.selectAll(t)})}),i.selectNone(),i.selectAll(t)})})})},"change:checkboxes":function(e){_.device("smartphone")||(e.props.on("change:checkboxes",function(o,t){e.listView.toggleCheckboxes(t)}),e.listView.toggleCheckboxes(e.props.get("checkboxes")))},"detail-sidebar":function(e){_.device("smartphone")||v.add({side:"right",sidebar:C.$el.css("padding","0 16px"),target:e.listControl.$el,visible:e.props.get("details")})},"change:details":function(e){function o(o){C.open=o,C.$el.trigger("toggle-sidebar",o).toggleClass("open",o),e.applyLayout(),e.listView.trigger("selection:change"),$(document).trigger("resize")}_.device("smartphone")||(e.props.on("change:details",function(e,t){o(t)}),o(e.props.get("details")),C.$el.on("click",".viewer-fileinfo .close",function(){e.props.set("details",!1)}))},refresh:function(e){ox.on("refresh^",function(){_.defer(function(){e.listView.reload({pregenerate_previews:!1})})})},"account:delete":function(){ox.on("account:delete",function(e){e&&-1!==k.folder.get().indexOf(e)&&F()})},"folder:add/remove":function(e){r.on("create",function(o){o.folder_id===e.folder.get()&&e.listView.reload(),e.listView.on("add:"+_.cid(o),function(o){var t=e.listView.getCompositeKey(o);e.listView.selection.set([t],!0)})}),r.on("remove",function(e,o){_(w.pool.getByFolder(o.folder_id)).each(function(e){e.expired=!0})})},"folder-error":function(e){e.folder.handleErrors()},"prop-folderview":function(e){e.props.set("folderview",!_.device("smartphone")&&e.settings.get("folderview/visible/"+_.display(),!0))},"change:folderview":function(e){_.device("smartphone")||(e.props.on("change:folderview",function(o,t){e.folderView.toggle(t)}),e.on("folderview:close",function(){e.props.set("folderview",!1)}),e.on("folderview:open",function(){e.props.set("folderview",!0)}))},"change:checkboxes-mobile":function(e){_.device("!smartphone")||(e.pages.getNavbar("main").on("rightAction",function(){e.props.set("showCheckboxes",!e.props.get("showCheckboxes"))}),e.props.on("change:showCheckboxes",function(){var t=e.getWindow().nodes.main.find(".view-list");e.selection.clear(),e.props.get("showCheckboxes")?(t.removeClass("checkboxes-hidden"),e.pages.getNavbar("main").setRight(o("Cancel")).hide(".left")):(t.addClass("checkboxes-hidden"),e.pages.getNavbar("main").setRight(o("Edit")).show(".left"))}))},"toggle-secondary-toolbar":function(e){e.props.on("change:showCheckboxes",function(o,t){e.pages.toggleSecondaryToolbar("main",t)})},"folderview-toolbar":function(o){e.addFolderViewToggle(o)},"premium-area":function(){n.point("io.ox/files/sidepanel").extend({id:"premium-area",index:1e4,draw:function(o){this.append(e.addPremiumFeatures(o.app,{append:!1,upsellId:"folderview/infostore/bottom",upsellRequires:"boxcom || google || microsoftgraph"}))}})},"toggle-folder-editmode":function(e){if(!_.device("!smartphone")){e.toggleFolders=function(){var t=e.pages.getPage("folderTree"),i=e.props.get("mobileFolderSelectMode"),n=o(i?"Edit":"Cancel");e.props.set("mobileFolderSelectMode",!i),e.pages.getNavbar("folderTree").setRight(n),t.toggleClass("mobile-edit-mode",!i)}}},"inplace-find":function(e){function o(o,t){t.on({"find:query":function(){e.listControl.$el.find(".grid-options:first").hide()},"find:cancel":function(){e.listControl.$el.find(".grid-options:first").show()}})}if(!_.device("smartphone")&&h.has("search")&&e.isFindSupported())return e.initFind(),e.get("find")?o(0,e.get("find")):e.once("change:find",o)},find:function(e){!_.device("smartphone")&&e.get("find")&&e.get("find").on({"find:query:result":function(o){w.pool.add("detail",o.results),e.props.set("filter","all")}})},"contextual-help":function(e){e.getContextualHelp=function(){var e=this.folder.get()||this.treeView.selection.get()||"";return e.match(/^virtual\/myshares$/)?"ox.appsuite.user.sect.dataorganisation.sharing.drive.html":e.match(/^maildrive:\/\/0/)?"ox.appsuite.user.sect.drive.view.attachments.html":"ox.appsuite.user.sect.drive.gui.html"}},"before-delete":function(e){_.device("smartphone")||w.on("beforedelete",function(o){var t=e.listView.selection,i=_.map(o,_.cid);if(_.intersection(i,t.get()).length){if(t.getPosition(),t.dodge(),1===o.length)return;e.listView.onBatchRemove(o.slice(1))}})},"remove-file":function(e){w.on("remove:file",function(){e.listView.$el.trigger("scroll");var o=t.get("folder/trash");o&&r.get(o,{cache:!1})})},"selection-delete":function(){k.listView.on("selection:delete",function(e){var o=_(w.resolve(e,!1)).invoke("toJSON");u.invoke("io.ox/files/actions/delete",o)})},"listview-dropzone":function(e){e.listView.$el.addClass("dropzone").attr("data-dropzones",".selectable.file-type-folder")},sidepanel:function(e){if(!_.device("smartphone")){n.point("io.ox/files/sidepanel").extend({id:"tree",index:100,draw:function(e){this.addClass("border-right").append(e.app.treeView.$el)}});var o=e.getWindow().nodes.sidepanel;n.point("io.ox/files/sidepanel").invoke("draw",o,n.Baton({app:e}))}},metrics:function(e){require(["io.ox/metrics/main"],function(o){function t(e,t){var i=!!(t=$(t)).attr("data-name"),n=(t.attr("data-action")||"").replace(/^io\.ox\/files\/(detail\/)?/,"");o.trackEvent({app:"drive",target:e,type:"click",action:i?t.attr("data-name"):n,detail:i?t.attr("data-value"):""})}if(o.isEnabled()){var i=e.getWindow().nodes,n=i.body.find(".list-view-control > .generic-toolbar"),r=i.sidepanel;o.watch({node:r,selector:'[data-action="add-storage-account"]',type:"click"},{app:"drive",target:"folder/account",type:"click",action:"add"}),i.body.on("track",".classic-toolbar-container",function(e,o){t("toolbar",o)}),n.on("track",function(e,o){t("list/toolbar",o)}),_.defer(function(){r.find(".context-dropdown").on("mousedown","a",function(e){o.trackEvent({app:"drive",target:"folder/context-menu",type:"click",action:$(e.currentTarget).attr("data-action")})})}),r.find(".bottom").on("mousedown","a[data-action]",function(e){$(e.currentTarget).attr("data-action")&&o.trackEvent({app:"drive",target:"folder/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})}),e.on("folder:change folder-virtual:change",function(e){o.getFolderFlags(e).then(function(e){o.trackEvent({app:"drive",target:"folder",type:"click",action:"select",detail:e.join("/")})})}),e.listView.on({"selection:multiple selection:one":_.throttle(function(t){o.trackEvent({app:"drive",target:"list/"+e.props.get("layout"),type:"click",action:"select",detail:t.length>1?"multiple":"one"})},100,{trailing:!1})}),ox.on("action:invoke:io.ox/files/actions/default",function(){o.trackEvent({app:"drive",target:"list/"+e.props.get("layout"),type:"click",action:"selection-doubleclick"})})}})},"select-file":function(e){e.selectFile=function(o){o=_.isString(o)?_.cid(o):o,w.get(o).done(function(o){var t=w.resolve(o,!1),i=n.Baton({models:t,app:e,favorites:!1,portal:!0});u.invoke("io.ox/files/actions/show-in-folder",i)})}},a11y:function(e){e.listView.$el.on("keydown",".list-item",function(o){if(27===o.which)return e.folderView.tree.$(".folder.selected").focus(),!1}),e.folderView.tree.$el.on("keydown",".folder",function(o){$(o.target).hasClass("folder")&&13===o.which&&e.listView.restoreFocus(!0)})},"special-error-handling":function(e){e.listenTo(ox,"http:error:FLD-0003 http:error:FLD-0008 http:error:FILE_STORAGE-0004 http:error:FILE_STORAGE-0055 CHECK_CURRENT_FOLDER",function(e,o){var t=o.params.parent||o.data.parent;t&&t===this.folder.get()&&(r.isBeingDeleted(t)||F(e))})}});var F=_.debounce(function(e){var o=r.pool.getModel(k.folder.get());o&&r.list(o.get("folder_id"),{cache:!1}),k.folder.setDefault(),e&&r.path(o.get("folder_id")).done(function(o){e.error+="\n"+_(o).pluck("title").join("/"),y.yell(e)})},1e3,!0);return k.setLauncher(function(o){return k.setWindow(V=ox.ui.createWindow({name:"io.ox/files",id:"io.ox/files",title:"Drive",chromeless:!0,find:h.has("search")})),V.addClass("io-ox-files-main"),k.settings=t,k.registerGlobalEventHandler(window,"orientationchange",function(){var e=$("body").find("ul.dropdown-menu:visible");e.css("-webkit-overflow-scrolling","touch"),e.css("-webkit-overflow-scrolling","")}),e.wirePerspectiveEvents(k),V.nodes.outer.on("selection:drop",function(e,o){var t=n.Baton(k.getContextualData(o.data));t.dropType="infostore",t.target=o.target.replace(/^folder\./,""),u.invoke("io.ox/files/actions/move",t)}),o.folder=o.folder||r.getDefaultFolder("infostore")||9,e.addFolderSupport(k,null,"infostore",o.folder).then(function(){k.mediate(),V.show(function(){$(window).trigger("resize")})})}),k.setResume(function(e){if(e&&e.folder&&e.folder!==this.folder.get()){var o=this.getWindow();return o.busy(),this.folder.set(e.folder).always(function(){o.idle()})}return $.when()}),{getApp:k.getInstance}});