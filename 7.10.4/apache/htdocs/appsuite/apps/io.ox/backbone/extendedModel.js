define("io.ox/backbone/extendedModel",["io.ox/core/extensions","gettext!io.ox/core"],function(t,i){"use strict";function e(){this.errors={},this.add=function(t,i){return(this.errors[t]||(this.errors[t]=[])).push(i),this},this.hasErrors=function(){return!_.isEmpty(this.errors)},this.errorsFor=function(t){return this.errors[t]},this.each=function(){var t=_(this.errors);return t.each.apply(t,$.makeArray(arguments))}}var r=Backbone.Model.extend({initialize:function(){this._valid=!0,this.attributeValidity={},this.init&&this.init.apply(this,$.makeArray(arguments)),this.savedAttributes=this.toJSON()},changedSinceLoading:function(){var t=this.savedAttributes||{},i=this.attributes,e={},r={};return _(t).chain().keys().each(function(t){e[t]=1}),_(i).chain().keys().each(function(t){e[t]=1}),_(e).chain().keys().each(function(e){var n=t[e],a=i[e],s=!1;n!==a&&(_.isArray(n)&&_.isArray(a)?0===_(n).difference(a).length&&0===_(a).difference(n).length||(n.length!==a.length?s=!0:_.each(a,function(t,i){_.each(a[i],function(t,e){void 0===n[i]?s=!0:t!==n[i][e]&&(s=!0)})}),!0===s&&(r[e]=a)):r[e]=a)}),r},point:function(i){return/^\//.test(i)&&(i=i.substring(1)),t.point(this.ref+i)},validate:function(t,i,r){r=2===arguments.length&&i&&i.isSave?i:r||{};var n=this,a=n.errors=new e;if(t=t||this.toJSON(),this.point("validation").invoke("validate",a,t,a,this),r.isSave&&this.point("validation/save").invoke("validate",a,t,a,this),a.hasErrors()){var s={};_(t).chain().keys().each(function(t){s[t]=!0}),a.each(function(t,i){s[i]=!1,n.trigger("invalid:"+i,t,a,n)}),_(n.attributeValidity).each(function(t,i){!t&&s[i]&&n.trigger("valid:"+i,n)}),n.attributeValidity=s,n.trigger("invalid",a,n),n._valid=!1}else n._valid||(_(n.attributeValidity).each(function(t,i){t||n.trigger("valid:"+i,n)}),_(t).chain().keys().each(function(t){n.attributeValidity[t]=!0}),n._valid=!0,this.trigger("valid"))},sync:function(t,e){var r=this;if("delete"===t&&(t="destroy"),("update"===t||"create"===t)&&!this.isValid({isSave:!0})){var a=i("The dialog contains invalid data"),s=this.errors.errors;return 1===_(s).size()&&_.isString(s[_(s).keys()[0]][0])&&(a=s[_(s).keys()[0]]),$.Deferred().reject({error:a,model:this})}if(this.syncer&&this.syncer[t]||this.api)return this.trigger(t+":start"),this.trigger("sync:start"),(this.syncer&&this.syncer[t]?this.syncer[t]:n[t]).call(this,e).done(function(i){r.trigger(t,i),r.trigger("sync",i),r.savedAttributes=r.toJSON()}).fail(function(e,n){!n||404!==n.status&&0!==n.status||(e.error=i("Server unreachable")),r.trigger("backendError",e,n),r.trigger(t+":fail",e),r.trigger("sync:fail",e)}).always(function(){r.trigger(t+":always"),r.trigger("sync:always")});throw new Error("No Syncer specified!")},isSet:function(){var t=this;return _(arguments).all(function(i){return t.has(i)&&""!==t.get(i)})},isValid:function(t){return this.validate(this.toJSON(),null,t),this._valid}}),n={create:function(t){return t.api.create(t.toJSON())},update:function(t){var i=null;return t.getUpdatedAttributes?i=t.getUpdatedAttributes(t):((i=t.changedSinceLoading()).id=t.id,i.last_modified=t.get("last_modified"),i.folder||(i.folder=t.get("folder")||t.get("folder_id"))),t.api.update(i)}};return r});