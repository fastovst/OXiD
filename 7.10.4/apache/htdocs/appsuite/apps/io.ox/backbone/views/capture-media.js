define("io.ox/backbone/views/capture-media",["io.ox/backbone/views/modal","io.ox/backbone/mini-views/common","io.ox/core/media-devices","io.ox/core/yell","gettext!io.ox/core","less!io.ox/backbone/views/capture-media"],function(e,t,i,a,s){"use strict";function n(e){e=e.get?e.get(0):e;var t={height:$(e).attr("data-height"),width:$(e).attr("data-width")},i=document.createElement("canvas");return i.setAttribute("height",t.height+"px"),i.setAttribute("width",t.width+"px"),i.getContext("2d").drawImage(e,0,0),i.toDataURL("image/png")}function o(e){e&&_.each(e.getVideoTracks(),function(e){e.stop()})}var d={unspecified:s("Please grant access to your webcam first."),pending:s("Requesting device information. Please wait..."),nodevices:s("Currently there are no compatible webcams available on your device.")};return{getDialog:function(){return new e({title:s("Take a photo"),width:500,point:"io.ox/backbone/capture-media",model:new Backbone.Model,async:!0}).inject({updateDevices:function(){var e=this.model;return i.getDevices("videoinput").then(function(t){e.unset("devices",{silent:!0}),e.set({devices:t,device:(_.first(t)||{}).id})},function(t){e.set({message:t.message,devices:[],device:void 0})})},setStream:function(){var e=this.$(".stream"),t=this.model,a=t.toJSON(),s=t.get("stream");if(this.$("button.btn-primary").attr("data-state","manual").prop("disabled","disabled").addClass("disabled"),_.isArray(a.devices)&&0===a.devices.length)return this.model.set("message",d.nodevices);var n={video:a.device?{optional:[{sourceId:a.device}]}:{width:{ideal:400},height:{ideal:400},facingMode:"user"}};_.device("smartphone")&&(this.facingMode="user"===this.facingMode?"environment":"user",n={video:{facingMode:this.facingMode}});var c=setTimeout(function(){t.set("message",d.unspecified)},800);e.addClass("hidden").attr("url","").parent().addClass("io-ox-busy"),i.getStream(n).then(function(i){t.set({access:!0,stream:i,message:""}),e[0].srcObject=i},function(e){t.set({access:!1,stream:void 0,message:e.message})}).always(function(){clearTimeout(c),o(s)})},onClose:function(){o(this.model.get("stream"))},onApply:function(){this.trigger("ready",n(this.$(".stream"))),this.onClose(),this.close()}}).extend({"init-start":function(){this.$el.addClass("capture-media blank"),this.$("button.btn-primary").attr("data-state","manual").prop("disabled","disabled").addClass("disabled"),this.busy(!0)},hint:function(){this.$body.append($('<div class="hint">').text(this.model.get("message"))),this.listenTo(this.model,"change:message",function(e,t){this.$el.toggleClass("blank",!!t),this.$(".hint").text(t),this.idle()})},"select-device":function(){if(!_.device("!desktop")){var e=$('<div class="devices">'),i=_.uniqueId("form-control-label-");this.$body.append(e),this.listenTo(this.model,"change:devices",function(a,n){e.toggleClass("hidden",!n||n.length<2).empty().append($('<label class="control-label">').attr("for",i).text(s("Webcam")),new t.SelectView({name:"device",model:this.model,list:n,id:i}).render().$el)})}},stream:function(){var e=this;this.$body.append($('<div class="stream-container">').append($('<video autoplay playsinline class="stream">').on("canplay",function(){e.$("button.btn-primary").removeAttr("disabled").removeClass("disabled"),e.$(".stream-container").removeClass("io-ox-busy"),$(this).removeClass("hidden").removeAttr("style"),_.device("!desktop")&&e.$(".switchcamera").show();var t=this.getBoundingClientRect(),i={"data-height":t.height,"data-width":t.width,ratio:t.width/t.height,orientation:t.width>t.height?"landscape":"portrait"},a=Math.min(e.$(".stream-container").width(),e.$(".stream-container").height()),s={height:/landscape/.test(i.orientation)?a:a*i.ratio,width:/landscape/.test(i.orientation)?a*i.ratio:a};$(this).attr(i),_.device("!smartphone")&&$(this).css(s)}),$('<button class="btn btn-link switchcamera" style="display:none;">').attr("title",s("Switch camera")).append($('<i class="fa fa-refresh" aria-hidden="true">')).on("tap",function(){e.setStream()}))),this.listenTo(this.model,"change:device",this.setStream)},"init-end":function(){navigator.mediaDevices&&(navigator.mediaDevices.ondevicechange=this.updateDevices.bind(this)),this.updateDevices()}}).addCancelButton().addButton({label:s("Take a photo"),action:"apply"}).on({apply:function(){this.onApply()},close:function(){this.onClose()}})}}});