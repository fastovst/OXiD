define("io.ox/backbone/views/modal",["io.ox/backbone/views/extensible","io.ox/core/a11y","gettext!io.ox/core"],function(t,e,i){"use strict";function s(t){if(this.$el){this.trigger("before:close"),this.$el.off("hidden.bs.modal"),t&&"hidden"===t.type||this.$el.modal("hide"),this.toggleAriaHidden(!1),this.trigger("close");var e=this.previousFocus;return this.$el.remove(),d.remove(this),e&&e.focus(),this}}function o(t){return this.disableFormElements(),this.activeElement=this.activeElement||document.activeElement,t?(this.$body.addClass("invisible"),this.$body.parent().busy()):this.$body.css("opacity",.5),this.$el.focus(),this}function n(){return this.enableFormElements(),this.$body.parent().idle(),this.$body.removeClass("invisible").css("opacity",""),this.autoFocusOnIdle&&($.contains(this.el,this.activeElement)?$(this.activeElement).focus():this.setFocus(this.options)),this.activeElement=null,this}var a=t.extend({className:"modal flex",events:{"click .modal-footer [data-action]":"onAction","keydown input:text, input:password":"onKeypress",keydown:"onKeydown"},constructor:function(e){e=_.extend({async:!1,context:{},keyboard:!0,maximize:!1,smartphoneInputFocus:!1,autoFocusOnIdle:!0},e),_.device("smartphone")&&e.width>=320&&(e.width="95%",e.maximize="95%"),this.context=e.context,t.prototype.constructor.apply(this,arguments),this.autoFocusOnIdle=e.autoFocusOnIdle;var i=_.uniqueId("title");if(this.$el.toggleClass("maximize",!!e.maximize).attr({role:"dialog","aria-modal":!0,"aria-labelledby":i}).append($('<div class="modal-dialog" role="document">').width(e.width).append($('<div class="modal-content">').append(this.$header=$('<div class="modal-header">').append(this.$title=$('<h1 class="modal-title">').attr("id",i).text(e.title||" ")),this.$body=$('<div class="modal-body">'),this.$footer=$('<div class="modal-footer">')))),this.close=s.bind(this),this.busy=o.bind(this),this.idle=n.bind(this),this.$el.on("hidden.bs.modal",this.close),(_.isNumber(e.maximize)||_.isString(e.maximize))&&this.$(".modal-content").css("max-height",e.maximize),e.help){var a=$('<a class="io-ox-context-help">');this.$header.append(a),require(["io.ox/backbone/mini-views/helplink"],function(t){a.parent().addClass("help"),a.replaceWith(new t({href:e.help,modal:!0}).render().$el)})}e.description&&this.addDescription(e),_.device("smartphone")&&e.smartphoneInputFocus&&(this.$el.find(".modal-content").css("overflow-y","auto"),this.listenToDOM(window,"resize",this.scrollToInput)),this.keepFocus=this.keepFocus.bind(this),this.listenToDOM(document,"focusin",this.keepFocus)},scrollToInput:function(){1===$(document.activeElement).filter('input[type="email"],input[type="text"],textarea').length&&document.activeElement.scrollIntoView()},keepFocus:function(t){var e=$(t.target);if(!this.$el.has(e).length){var i=$(t.target).closest(".io-ox-dialog-popup, .io-ox-sidepopup, .mce-window, .date-picker").length>0,s=$("body > .smart-dropdown-container").length>0;(i||s)&&t.stopImmediatePropagation()}},render:function(){return this.invoke("render",this.$body)},open:function(){var t=this.options,e=this;return!1!==t.render&&this.render().$el.appendTo("body"),this.previousFocus=t.previousFocus||$(document.activeElement),_.device("smartphone")&&(this.$el.addClass("mobile-dialog"),this.$footer.rowfluid=$('<div class="row">'),this.$footer.append(this.$footer.rowfluid),this.$buttons=this.$footer.find("button,a.btn"),_.each(this.$buttons,function(t){e.$footer.rowfluid.prepend($(t).addClass("btn-medium")),$(t).wrap('<div class="col-xs-12 col-md-3">')})),this.trigger("before:open"),this.$el.modal({backdrop:t.backdrop||"static",keyboard:!1}).modal("show"),this.toggleAriaHidden(!0),this.trigger("open"),this.setFocus(t),d.add(this),this},setFocus:function(t){var i=this;if(t.focus){var s=this.$(t.focus);s.length&&(this.activeElement=s[0],s[0].focus())}else _.defer(function(){i.$el.toggleClass("compact",i.$body.is(":empty"));var t=e.getTabbable(i.$body).first();0===t.length&&(t=i.$footer.find(".btn-primary")),0===t.length&&(t=e.getTabbable(i.$footer).first()),0!==t.length&&t.focus()})},toggleAriaHidden:function(){},disableFormElements:function(){this.formElementsDisabled||(this.formElementsDisabled=!0,this.$(":input").each(function(){"cancel"!==$(this).attr("data-action")&&"manual"!==$(this).attr("data-state")&&$(this).toggleClass("disabled",$(this).prop("disabled")).prop("disabled",!0)}))},enableFormElements:function(){this.formElementsDisabled=!1,this.$(":input").each(function(){"manual"!==$(this).attr("data-state")&&($(this).hasClass("disabled")?$(this).removeClass("disabled"):$(this).prop("disabled",!1))})},hideBody:function(){return this.$(".modal-body").hide(),this.$(".modal-footer").css("border-top",0),this},addButton:function(t){var e=_.extend({placement:"right",className:"btn-primary",label:i("Close"),action:"cancel"},t),s="left"===e.placement,o=s?"prepend":"append";return s&&(e.className+=" pull-left"),this.$footer[o]($('<button type="button" class="btn">').addClass(e.className).attr("data-action",e.action).text(e.label)),this},addDescription:function(t){if(!t.description)return this;var e=_.uniqueId("modal-description-"),i=$("<div>").attr("id",e);return"object"==typeof t.description?i.append(t.description):i.text(t.description),this.$el.attr("aria-describedby",e),this.$body.prepend(i),this},addDownloadButton:function(t){var e=_.extend({placement:"right",className:"btn-primary",label:i("Download"),action:"cancel",href:"#"},t),s="left"===e.placement,o=s?"prepend":"append";return s&&(e.className+=" pull-left"),this.$footer[o]($('<a role="button" class="btn">').addClass(e.className).attr({"data-action":e.action,href:e.href,download:"download"}).text(e.label)),this},addCloseButton:function(){return this.addButton()},addCancelButton:function(t){t=t||{};var e={className:"btn-default",label:i("Cancel")};return t.left&&(e.placement="left"),this.addButton(e)},addAlternativeButton:function(t){return this.addButton(_.extend({placement:"left",className:"btn-default",label:"Alt",action:"alt"},t))},addCheckbox:function(t){var e=_.extend({className:"pull-left"},t),i=_.uniqueId("custom-");return this.$footer.prepend($('<div class="checkbox custom">').append($("<label>").attr("for",i).prepend($('<input type="checkbox" class="sr-only">').attr({id:i,name:e.action}).prop("checked",e.status),$('<i class="toggle" aria-hidden="true">'),$.txt(e.label||" "))).addClass(e.className)),this},onAction:function(t){this.invokeAction($(t.currentTarget).attr("data-action"))},invokeAction:function(t){this.options.async&&"cancel"!==t&&this.busy(),this.trigger(t),this.trigger("action",t),(this.options&&!this.options.async||"cancel"===t)&&this.close()},onKeypress:function(t){13===t.which&&this.options.enter&&$(t.target).is("input:text, input:password")&&(t.preventDefault(),this.invokeAction(this.options.enter))},onKeydown:function(t){this.onEscape(t),this.onTab(t)},onEscape:function(t){27===t.which&&(t.isDefaultPrevented()||(this.$footer.find('[data-action="cancel"]').length>0&&this.trigger("cancel"),this.close()))},onTab:function(t){9===t.which&&e.trapFocus(this.$el,t)},pause:function(){$(document).off("focusin",this.keepFocus),!1!==this.options.render?this.$el.next(".modal-backdrop.in:visible").addBack().hide():this.$el.prev(".modal-backdrop.in:visible").addBack().hide(),this.disableFormElements(),this.toggleAriaHidden(!1)},resume:function(){$(document).on("focusin",this.keepFocus),!1!==this.options.render?this.$el.next(".modal-backdrop.in:hidden").addBack().show():this.$el.prev(".modal-backdrop.in:hidden").addBack().show(),$(document.body).addClass("modal-open"),this.toggleAriaHidden(!0),this.idle()}}),d={queue:[],add:function(t){this.queue.indexOf(t)>-1||(this.queue.length&&_(this.queue).last().pause(),this.queue.push(t))},remove:function(t){this.queue=_(this.queue).without(t),this.queue.length&&_(this.queue).last().resume()}};return a});