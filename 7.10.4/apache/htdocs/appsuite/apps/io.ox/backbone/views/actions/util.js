define("io.ox/backbone/views/actions/util",["io.ox/core/extensions","io.ox/core/upsell","io.ox/core/folder/api","io.ox/core/collection","io.ox/core/capabilities"],function(e,t,n,i,o){"use strict";function r(t){t.setSelectionFinalize=function(t,n,i){if(!this.disposed){var o=e.Baton(_.extend(t,{selection:n,collection:i,list:this.options.list,restoreFocus:""}));this.render(o)}}}function a(t){return t instanceof e.Baton?t:(_.isArray(t)||(t=[t]),e.Baton({data:t}))}function c(e){return _.isFunction(e.quick||e.matches||e.requires)}function l(e,t,n){var i=!0;return n&&t.quick?i=t.quick(e):t.matches?i=t.matches(e):_.isFunction(t.requires)&&(i=t.requires({baton:e,collection:e.collection,data:e.data,extension:t})),$.when(i).pipe(null,_.constant(!1))}function d(e,t,n,i){var o=t.icon,r=s(t.title||t.label,n),a=!1!==i&&(t.tooltip||o&&r);o?e.attr("title",r).append($('<i aria-hidden="true">').addClass(o)):r&&e.text(r),a&&e.addActionTooltip(a),t.customize&&setTimeout(t.customize.bind(e,n))}function s(e,t){return _.isFunction(e)?e(t):e}function u(e,t){var n=t.data(),i={right:"auto",bottom:"auto"},o=t.get(0).getBoundingClientRect(),r=$(window).height()-16,a=$(window).width()-16;if(void 0!==n.top)i.top=n.top,i.left=n.left;else{var c=e.get(0).getBoundingClientRect();i.top=c.top+c.height,i.left=t.hasClass("dropdown-menu-right")?c.right-o.width:c.left}i.top=Math.max(0,Math.min(i.top,r-o.height)),i.left=Math.max(0,Math.min(i.left,a-o.width)),t.css(i)}function p(){$(this).children("a").tooltip("hide")}var f={Action:function(t,n){e.point(t).extend(_.extend({id:"default",index:100},n))},createListItem:function(){return $('<li role="presentation">')},createDivider:function(){return $('<li class="divider" role="separator">')},createCaption:function(e){return $('<li class="dropdown-header dropdown-description" role="presentation">').text(e)},createSectionTitle:function(e){return $('<li class="dropdown-header" role="presentation">').text(e)},createDropdownToggle:function(){return $('<a href="#" role="button" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" draggable="false" tabindex="-1">')},createDropdownList:function(){return $('<ul class="dropdown-menu" role="menu">')},createCaret:function(){return $('<i class="fa fa-caret-down" aria-hidden="true">')},processItem:function(t,n){if(!f.checkPriority(n))return{link:n,available:!1};if(n.dropdown||n.custom)return{link:n,available:!0,enabled:!0};var i=n.ref?e.point(n.ref).list():[],o=i.filter(f.checkActionAvailability);if(!o.length)return{link:n,available:!1};var r=o.filter(f.checkActionEnabled.bind(null,t));return/\bactions/.test(_.url.hash("debug"))&&console.debug("item",n.ref,"available",o,"enabled",r.length>0,"action",i,"baton",t),{link:n,available:!0,enabled:r.length>0,actions:r}},checkPriority:function(e){return"none"!==e[_.device("smartphone")?"mobile":"prio"]},checkActionAvailability:function(e){return!("toggle"in e&&!e.toggle)&&(!!_.device(e.device)&&!!t.visible(e.capabilities))},checkActionEnabled:function(e,t){return!e.isPropagationStopped()&&(!(t.every&&!f.every(e.data,t.every))&&(!(t.collection&&!e.collection.matches(t.collection))&&!(t.folder&&!f.checkFolder(e,t))))},createItem:function(e,t){if(t.available&&(t.enabled||t.link.drawDisabled)){var n,i=f.createListItem(),o=t.link;return o.dropdown?(n=f.renderDropdown(i,e,{caret:o.caret,customize:o.customize,drawDisabled:o.drawDisabled,icon:o.icon,point:o.dropdown,title:s(o.title||o.label,e),tooltip:o.tooltip}),{$li:i,def:n}):(o.custom?o.draw.call(i,e):f.renderListItem(i,e,t),{$li:i,def:f.processMatches(i,e,t)})}},processMatches:function(e,t,n){function i(){var e=r.shift();e&&!t.isPropagationStopped()?o(e):a.resolve(!1)}function o(e){l(t,e,!1).done(function(e){e?a.resolve(!0):i()}).fail(i)}var r=n.actions||[],a=$.Deferred();return r.length?i():a.resolve(!0),a.done(function(i){t.resumePropagation(),i||(n.link.drawDisabled?e.children("a").addClass("disabled").attr("aria-disabled",!0):e.addClass("hidden"))})},waitForMatches:function(e,t){var n=_(e).chain().pluck("def").flatten().compact().value();return $.when.apply($,n).done(t)},renderListItem:function(e,t,n){e.attr("data-prio",n.link[_.device("smartphone")?"mobile":"prio"]||"lo").data({section:n.link.section,sectionTitle:n.link.sectionTitle,caption:n.link.caption}).on("shown.bs.dropdown",p).append(function(){var e=$('<a href="#" role="button" draggable="false" tabindex="-1">').data({baton:t}).attr({"data-action":n.link.ref});return d(e,n.link,t,n.enabled),n.enabled||e.addClass("disabled").attr("aria-disabled",!0),e})},renderDropdown:function(e,t,n){var i=f.createDropdownToggle().attr("data-dropdown",n.point);d(i,n,t),!1!==n.caret&&i.append(f.createCaret());var o=f.createDropdownList();return e.addClass("dropdown").append(i,o),e.on("shown.bs.dropdown",p),_.device("smartphone")&&f.bindActionEvent(o),t?f.renderDropdownItems(e,t,n):$.when()},renderDropdownItems:function(t,n,i){var o=e.point(i.point).list().map(f.processItem.bind(null,n)).map(f.createItem.bind(null,n)).filter(Boolean),r=t.find("> .dropdown-menu");return r.empty().append(_(o).pluck("$li")),f.waitForMatches(o,function(){f.injectSectionDividers(r),!r.find("[data-action]:not(.disabled)").length&&(i.drawDisabled?t.find(".dropdown-toggle").addClass("disabled").attr("aria-disabled",!0):t.hide())})},injectCaption:function(e){var t,n=(e=$(e)).find("a"),i=f.createCaption(e.data("caption"));t=_.uniqueId("link-description-"),i.attr("id",t),n.attr("aria-describedby",t),i.on("click",n.trigger.bind(n,"click")),i.insertAfter(e)},injectSectionDividers:function(e){var t=null;e.find("li.hidden").remove(),e.find('a[role="button"]').attr("role","menuitem"),e.children().each(function(e,n){var i=$(n).data();i.caption&&f.injectCaption(n),i.section!==t&&(t=i.section,0!==e&&f.createDivider().insertBefore(n),i.sectionTitle&&f.createSectionTitle(i.sectionTitle).insertBefore(n))})},hasActions:function(e){return e.find("ul > li > a:not(.disabled)").length>0},invokeByEvent:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.data("baton"),i=t.data("action");!t.hasClass("disabled")&&n&&(n.e=e,f.invoke(i,n),_.defer(function(){t.tooltip("hide")}))},cid:function(e){return[e.folder_id||e.folder,e.id,e.recurrenceId].filter(Boolean).join(".")},every:function(e,t){var n=String(t||"").replace(/\w[\w:]+/gi,function(e){return/^(undefined|null|true|false)$/.test(e)?e:'data["'+e+'"]'});try{var i=new Function("data","return !!("+n+")");return e.every(i)}catch(n){return console.error("every",n,t,e),!1}},checkFolder:function(e,t){if(void 0===e.folder_id)return console.error("ToolbarView > checkFolder: No folder_id given",t,e),!1;var i=n.pool.models[e.folder_id];if(!i)return!1;var o=String(t.folder).replace(/\w[\w:]+/gi,function(e){return/^(undefined|null|true|false)$/.test(e)?e:i.can(e.toLowerCase())});try{return new Function("return !!("+o+")")()}catch(e){return console.error("checkFolder",t.folder,"condition",o,i,e),!1}},setSelection:function(e,t){this.setSelectionFinalize||r(this),t?_.isFunction(t)&&(t=t.call()):t={};var n=_.lfo(!0,this,this.setSelectionFinalize);return(t.promise?t:$.when(t)).done(function(t){if(this.options.simple)n(t,e,new i.Simple(e));else{var o=new i(t.data||e);o.getProperties().done(function(){n(t,e,o)})}}.bind(this)),this},setData:function(e){return e=[].concat(e),this.setSelection(e,{data:e}),this},getBaton:function(t,n){return e.Baton(_.extend({data:t,selection:t,collection:new i.Simple(t)},n))},invoke:function(n,r,d){function s(){var e=g.shift();e?u(e):w.resolve(!1)}function u(e){return"default"===e.id&&r.isDefaultPrevented()?s():r.isDisabled(v.id,e.id)?s():e.capabilities&&!o.has(e.capabilities)?s():f.checkActionAvailability(e)&&f.checkActionEnabled(r,e)?c(e)?p(e,r):void h(e,r):s()}function p(e,t){try{l(t,e,!0).done(function(n){n?h(e,t):s()}).fail(s)}catch(e){console.error(e),s()}}function h(e,t){try{d||(_.isFunction(e.action)?e.action(t):_.isString(e.action)?require([e.action],function(e){e(t)}):_.isFunction(e.multiple)&&e.multiple(t.array(),t),ox.trigger("action:invoke action:invoke:"+n,t,e,n))}catch(i){console.error('point("'+n+'") > invoke()',i.message,{baton:t,action:e,exception:i})}finally{w.resolve(!0)}}var v=e.point(n),b=v.pluck("capabilities"),g=v.list(),w=$.Deferred();return b.length&&!t.any(b)?(!d&&t.enabled(b)&&t.trigger({type:"inline-action",id:n,missing:t.missing(b)}),w.resolve(!1)):((r=a(r)).collection?s():new(r.simple?i.Simple:i)(r.array()).getPromise().pipe(function(e){r.collection=e,s()}),w)},checkAction:function(e,t){return f.invoke(e,t,!0).pipe(function(e){return e?t:$.Deferred().reject()})},addBackdrop:function(e){var t=e.find(".dropdown-toggle"),n=e.find(".dropdown-menu"),i=$('<div class="smart-dropdown-container dropdown open" role="navigation">').on("click contextmenu",function(){return t&&t.dropdown("toggle"),!1}),o=e.attr("class");f.bindActionEvent(n),e.on({"show.bs.dropdown":function(){i.append(n).addClass(o).appendTo("body"),u(t,n)},"hide.bs.dropdown":function(){i.detach(),n.insertAfter(t)},dispose:function(){i&&i.remove(),t=n=i=null}})},bindActionEvent:function(e){e.on("click","a[data-action]",f.invokeByEvent)}};return $.fn.addActionTooltip=function(e){return _.device("smartphone")?$(this):$(this).attr({"data-original-title":e,"aria-label":e,"data-placement":"bottom","data-animation":"false","data-container":"body"}).tooltip({trigger:"hover"})},f});