define("io.ox/backbone/views/edit-picture",["io.ox/core/extensions","io.ox/backbone/views/modal","io.ox/backbone/views/capture-media","io.ox/core/media-devices","settings!io.ox/core","io.ox/contacts/api","gettext!io.ox/contacts","static/3rd.party/croppie.min.js","css!3rd.party/croppie/croppie.css","less!io.ox/backbone/views/edit-picture"],function(t,e,o,i,n,a,r){"use strict";function s(t){var e=$.Deferred(),o=new FileReader;return o.onload=function(t){e.resolve(t.target.result)},o.onerror=function(t){e.reject(void 0,t)},o.readAsDataURL(t),e}function c(t){var e=[1,6,3,8];return e[(Math.max(e.indexOf(t),0)+1)%4]}return{getDialog:function(t){return new e({title:t.title||r("Change photo"),point:"io.ox/backbone/crop",width:560,async:!0,model:t.model||new Backbone.Model,focus:'button[data-action="upload"]'}).inject({load:function(){return $.when().then(function(){var t=this.model.get("pictureFile"),e=this.model.get("image1_url");return e&&(e=e+"&"+$.param({uniq:_.now()})),_.isString(t)?t:t&&t.lastModified?s(t):e}.bind(this)).then(this.setImage.bind(this))},storeState:function(t){var e=_.extend({},this.model.get("crop"),this.$body.croppie("get"));t&&t.rotate&&(e.orientation=c(e.orientation)),this.model.set("crop",e)},setImage:function(t){this.toggleEmpty(!t);var e=_.extend({zoom:0},this.model.get("crop"),{url:t});if(t)return this.$(".cr-boundary, .cr-slider-wrap").show(),this.$body.croppie("bind",e)},toggleEmpty:function(t){this.$el.toggleClass("empty",t),this.$body.find("button, :input").prop("disabled",t)},onApply:function(){var t=n.get("properties/contactImageMaxWidth",500);this.storeState(),this.$body.croppie("result",{type:"blob",size:{width:t},format:"jpeg",quality:1,circle:!1}).then(function(t){var e=new File([t],"cropped.jpeg",{type:"image/jpeg"});this.model.unset("pictureFileEdited",{silent:!0}),this.model.set("pictureFileEdited",e),this.idle(),this.close()}.bind(this))},onRemovePhoto:function(){this.idle(),this.toggleEmpty(!0),this.model.unset("pictureFile")},onCancel:function(){this.model.unset("pictureFile"),this.idle()},onUserMedia:function(){o.getDialog().open().on("ready",function(t){this.model.set("pictureFile",t),this.setImage(t)}.bind(this))},onRotate:function(t){this.$body.croppie("rotate",t),this.storeState({rotate:!0})}}).extend({toolbar:function(){this.$header.append($('<div class="upper-toolbar">').append($('<button type="button" class="btn btn-default" data-action="upload">').text(r("Upload a photo")),i.isSupported()?$('<button type="button" class="btn btn-default" data-action="usermedia">').text(r("Take a photo")):$()).on("click","button",function(t){this.trigger("action",$(t.currentTarget).data("action"))}.bind(this)))},default:function(){this.$el.addClass("edit-picture");var t,e,o;_.device("small")?(t=320,e=240,o=180):(t=560,e=360,o=320);var i={viewport:{width:o,height:o,type:"circle"},boundary:{width:t,height:e},showZoomer:!0,enableResize:!1,enableOrientation:!0};this.$body.croppie(i)},"slider-label":function(){var t=this.$body,e=_.uniqueId("slider-");t.on("update",function(){var e=t.find("input.cr-slider"),o=e.attr("min"),i=e.attr("max"),n=e.attr("step"),a=100*(t.croppie("get").zoom-o)/(i-o),s=a?r.format("Zoom: %1$d%",a.toFixed(0)):r("Zoom");e.attr("max",i-=(i-o)%n),t.find("#zoom").text(s)}).find("input.cr-slider").attr({id:e,step:"0.01"}).before($('<label id="zoom" class="control-label sr-only">').attr("for",e))},"croppie-focus":function(){this.$body.find(".cr-boundary").on("mousedown click",function(){$(this).find(".cr-viewport.cr-vp-circle").focus()})},"inline-actions":function(){this.$body.append($('<div class="inline-actions">').append($('<button type="button" class="btn" data-action="rotate-left">').append($('<i class="fa fa-rotate-left fa-lg">'),$.txt("Rotate left")),$('<button type="button" class="btn" data-action="rotate-right">').append($('<i class="fa fa-rotate-right fa-lg">'),$.txt("Rotate right"))).on("click","button",function(t){this.trigger("action",$(t.currentTarget).data("action"))}.bind(this)))}}).addAlternativeButton({label:r("Remove photo"),action:"remove"}).addCancelButton().addButton({label:r("Apply"),action:"apply"}).on("open",function(){this.busy(),this.load().done(this.idle)}).on("action",function(t){switch(t){case"usermedia":this.onUserMedia();break;case"rotate-left":this.onRotate(90);break;case"rotate-right":this.onRotate(-90);break;case"upload":this.trigger("upload");break;case"remove":this.onRemovePhoto();break;case"cancel":this.onCancel();break;case"apply":if(!this.$el.hasClass("empty"))return this.onApply();this.model.get("image1_url")&&this.trigger("reset"),this.onCancel(),this.close()}})}}});