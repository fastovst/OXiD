define("io.ox/find/bundle",[],function(){"use strict";define("io.ox/find/date/patterns",["io.ox/core/extensions","gettext!io.ox/core"],function(e,t){function i(){function e(e){return _.map(e,function(e){return"("!==e[0]?e:/\((.+)\|.*\)/.exec(e)[1]})}function i(e,t,i){[].concat(e).forEach(function(e){var n=String(e).toLowerCase();a[n]=_.extend({},i,{label:e,id:n,index:t})})}if(u===moment().format("YYYY-MM-DD"))return f;var n,a={},o=e(moment.weekdays()),s=e(moment.months()),r=moment().month(),d=moment().year();for(_(o).map(function(e,t){var n=moment().day(t);moment().diff(n,"day",!0)<0&&n.subtract(7,"days"),i(e,t,{start:n.clone(),end:n.clone()})}),n=d;n>=d-5;n--)_(s).each(_.partial(function(e,t,n){if(!(e===d&&n>r)){var a=n+1+" "+e;i(t+" "+e,-(e+.01*n),{start:moment(a,"M YYYY").startOf("month"),end:moment(a,"M YYYY").endOf("month")})}},n));for(n=d;n>=d-20;n--)i(n,-n,{start:moment(n,"YYYY").startOf("year"),end:moment(n,"YYYY").endOf("year")});return i(t("Today"),0,{start:moment(),end:moment()}),i([t("Last day"),t("Yesterday")],0,{start:moment().subtract(1,"day"),end:moment().subtract(1,"day")}),i([t("Last week"),t("Previous week")],0,{start:moment().subtract(7,"day").startOf("week"),end:moment().subtract(7,"day").endOf("week")}),i([t("Last month"),t("Previous month")],1,{start:moment().subtract(1,"month").startOf("month"),end:moment().subtract(1,"month").endOf("month")}),i([t("Last year"),t("Previous year")],2,{start:moment().subtract(1,"year").startOf("year"),end:moment().subtract(1,"year").endOf("year")}),i(t("Last 7 days"),3,{start:moment().subtract(7,"day"),end:moment()}),i(t("Last 30 days"),4,{start:moment().subtract(30,"day"),end:moment()}),i(t("Last 365 days"),5,{start:moment().subtract(7,"day"),end:moment()}),f={},_(a).each(function(e,t){var i=t.substr(0,2);(f[i]||(f[i]=[])).push(_.extend(e,{id:t}))}),u=moment().format("YYYY-MM-DD"),f}function n(e){var t=i(),n=e.substr(0,2),a=e.length;return _(t[n]).chain().filter(function(t){return t.id.substr(0,a)===e}).sortBy("index").value()}var a=e.point("io.ox/find/date/patterns"),o=0,s={fulldate:"((\\d{1,2})[/.-](\\d){1,2}[/.-](\\d{4})|(\\d{4})[/.-](\\d){1,2}[/.-](\\d{1,2}))",connector:"(\\s)?("+["-","\\.\\.","to","bis","à","au","a"].join("|")+")(\\s)?"},r=new RegExp("^"+s.fulldate+"$"),d=new RegExp(s.fulldate,"g"),c=new RegExp("^"+s.fulldate+s.connector+s.fulldate+"$");a.extend({index:o+=100,id:"lookup",match:function(e){var t=e.data.value,i=e.options.limit-e.data.matched.length;i<=0||(e.data.matched=e.data.matched.concat(n(t).slice(0,i)))}}),a.extend({index:o+=100,id:"format-full-date",regex:r,match:function(e){var t,i=e.extension,n=e.data.value;e.options.limit!==e.data.matched.length&&i.regex.test(n)&&(t=moment(n,l(n)),e.data.matched.push({id:i.id,start:t.clone(),end:t.clone()}))}}),a.extend({index:o+=100,id:"range",regex:c,match:function(e){var i,n,a,o,s,r=e.extension,c=e.data.value;e.options.limit!==e.data.matched.length&&r.regex.test(c)&&(i=c.match(d).slice(0,2),n=_.map(i,function(e){return{value:e,format:l(e)}}),a=moment(n[0].value,n[0].format),o=moment(n[1].value,n[1].format),s=a.diff(o,"days")>0,e.data.matched.push({id:r.id,detail:t("as daterange"),start:s?o:a,end:s?a:o}))}});var u,l=function(){var e=/(\d{1,4})([/.-])(\d{1,2})[/.-](\d{1,4})/,t=function(e,t,i,n,a){var o,s=t.length<a.length,r=s?[void 0,void 0,"YYYY"]:["YYYY",void 0,void 0];return"/"===i&&s&&(o="MM/DD/YYYY"===moment.localeData().longDateFormat("L"),r[0]=t.replace(/./g,o?"M":"D"),r[1]=n.replace(/./g,o?"D":"M")),r[1]=r[1]||n.replace(/./g,"M"),r[0]=r[0]||t.replace(/./g,"D"),r[2]=r[2]||a.replace(/./g,"D"),r.join(i)};return function(i){return i.replace(e,t)}}(),f={};return{lookup:n,getTree:i,getMatches:function(t,i){t=String(t||"").toLowerCase();var n=_.extend({limit:3},i||{}),a=e.Baton.ensure({data:{matched:[],value:t},options:n});return e.point("io.ox/find/date/patterns").invoke("match",this,a),a.data.matched}}}),define("io.ox/find/date/value-model",["io.ox/find/manager/value-model"],function(e){var t=e.extend({type:"valueDate",_base:function(e,i){return t.__super__[e].apply(this,i)},_onChangeDateMatch:function(e,t){t&&this.get("facet").show()},initialize:function(e){this._base("initialize",arguments);var t=e.data;this.set({"date-match":t.match}),this.register()},register:function(){this.on("change:date-match",this._onChangeDateMatch)},asDates:function(){return _.extend({},this.get("date-match"))},asString:function(){var e=_.extend({start:moment(0),end:moment()},this.asDates()||{});return"["+e.start.startOf("day").valueOf()+" TO "+e.end.endOf("day").valueOf()+"]"},getRequest:function(){if(this.isActive())return{facet:"date",value:this.asString(),filter:null}}});return t}),define("io.ox/find/date/facet-model",["io.ox/find/manager/facet-model","io.ox/core/extensions","io.ox/find/date/patterns"],function(e,t,i){var n=e.extend({type:"facetDate",_base:function(e,t){return n.__super__[e].apply(this,t)},initialize:function(e){this.prepare(e),this._base("initialize",arguments)},prepare:function(e){var t=(e.values||e)[0],n=t.value.toLowerCase().trim(),a=i.getMatches(n);e.values=[],_.each(a,function(i){var n=$.extend(!0,{},t);n.value=i.label,n.id=i.id,n.match=i,n.item.name=i.label||n.item.name,n.item.detail=i.detail||n.item.detail,e.values.push(n)})},update:function(e){return this.prepare(e),e.values.length?this.show():this.hide(),this._base("update",[e])}});return n}),define("io.ox/find/manager/facet-collection",["io.ox/find/manager/facet-model","io.ox/find/date/facet-model","io.ox/core/extensions"],function(e,t,i){function n(e,t){return e.get?e.get(t):e[t]}function a(e){var t=n(e,"id");return"simple"===n(e,"style")&&(t=t+":"+(n(e,"name")||n(e,"item").name)),t}var o=i.point("io.ox/find/manager/facet");return o.extend({index:100,customize:function(e){var i=$.Deferred();return _.extend(e||{},{"date.custom":t}),i}}),Backbone.Collection.extend({model:e,type:"facet-collection",comparator:"index",initialize:function(){var e=this;this.on("change:list-of-actives",_.debounce(function(){e.trigger("active",this.getActive().length)},10)),this.facetmodels={},o.invoke("customize",this,this.facetmodels)},isFolderOnly:function(){var e=this.getActive();if(1===e.length)return _.where(e,{id:"folder"}).length},isAccountOnly:function(){var e=this.getActive();if(1===e.length)return _.where(e,{id:"account"}).length},_createModel:function(t){return new(this.facetmodels[t.id]||e)(t)},add:function(e,t){var i=this,n=_.map([].concat(e),function(e){return i._createModel(e)});return this.set(n,_.extend({merge:!1},t,{add:!0,remove:!1}))},update:function(e,t){var i=this,n=[],o=[],s={},r=_.extend({keep:[]},t);e=[].concat(e),_.each(e,function(e,t){var o=a(e),d=i.get(o);d?r.keep.indexOf(o)<0&&d.update(e):d||(e.cid=o,e.index=e.index||100*t,n.push(e)),s[o]=d?"update":"add"}),i.add(n),o=this.filter(function(e){var t=e.get("id"),i=!!e.getActive().length;return!(s[t]||i)}),i.remove(o)},activate:function(e,t,i){i=(i||{}).option||i,this.get(e).getValue(t).activate(i)},getActive:function(){return this.filter(function(e){return e.getActive().length})},reset:function(){this.filter(function(e){_.each(e.getActive(),function(e){e.deactivate()})})},getRequest:function(){var e=[];return this.each(function(t){t.get("values").each(function(t){var i=t.getRequest();i&&e.push(i)})}),e},getResponseCid:function(){return"search/"+moment().format("YYYY-MM-DD")+"/"+_(this.getRequest()).chain().map(function(e){var t=e.filter;return e.facet+(t&&_.isArray(t.fields)?"("+t.fields.join(",")+")":"")+"="+(t&&_.isArray(t.queries)?t.queries.join(","):e.value)}).value().sort().join("&")}})}),define("io.ox/find/manager/facet-model",["io.ox/find/manager/value-collection"],function(e){function t(e){var t={};return e.forEach(function(e){t[e]=!0}),t}return Backbone.Model.extend({type:"facetBase",initialize:function(i){var n=new e([],{},{facet:this});this.set({id:i.cid,style:i.style,data:_.copy(i,!0),values:n,type:"facet"}),this.flags=t(this.get("data").flags),n.customAdd(i.values||i,this)},is:function(e){return this.flags[e]},getType:function(){return this.get("style")},isType:function(e){var t=[].concat(e),i=this.get("style");return!!_.filter(t,function(e){return i===e}).length},hide:function(){this.flags.hidden=!0},show:function(){delete this.flags.hidden},isId:function(e){var t=[].concat(e),i=this.get("id");return!!_.filter(t,function(e){return i===e}).length},getConflicting:function(){var e=[];return _.each(this.get("data").flags,function(t){0===t.indexOf("conflicts:")&&e.push(t.split(":")[1])}),e},hasPersons:function(){return this.isId(["contacts","contact","participant","task_participants"])},getOriginalId:function(){return this.get("data").id},getName:function(){return this.get("name")},update:function(e){var t=this.getInactive(),i=this.get("values");i.remove(t),i.customAdd(e.values||e,this)},getValue:function(e){var t=this.get("values");return e?t.get(e):t.at(0)},getActive:function(){return this.get("values").filter(function(e){return e.isActive()})},getInactive:function(){return this.get("values").filter(function(e){return!e.isActive()})}})}),define("io.ox/find/manager/value-collection",["io.ox/find/manager/value-model","io.ox/find/date/value-model","io.ox/core/extensions"],function(e,t,i){var n=i.point("io.ox/find/manager/value");return n.extend({index:100,customize:function(e){var i=$.Deferred();return _.extend(e||{},{"date.custom":t}),i}}),Backbone.Collection.extend({model:e,type:"value-collection",initialize:function(e,t,i){this.facet=i.facet,this.on("change:active change:option",function(e){var t=Object.keys(e.changed)[0],i={active:e.changed.active?"activate":"deactivate",option:"change"};this.trigger("change:list-of-actives",i[t||"option"],e.id),this.facet.trigger("change:list-of-actives",i[t||"option"],e.id,e)}),this.valuemodels={},n.invoke("customize",this,this.valuemodels)},_createModel:function(t,i){return new(this.valuemodels[i.get("id")]||e)({data:t,facet:i})},customAdd:function(e,t){var i=this;e=[].concat(e),_.each(e,function(e){i.get(e.id)||i.add(i._createModel(e,t))})},getActive:function(){return this.filter(function(e){return e.get("active")})},getInactive:function(){return this.filter(function(e){return!e.get("active")})}})}),define("io.ox/find/manager/value-model",["gettext!io.ox/core"],function(e){return Backbone.Model.extend({type:"valueBase",initialize:function(e){var t,i=e.data,n=e.facet;_.each(i.options,function(e){"folder"!==n.get("id")&&"account"!==n.get("id")||e.active&&(t=e.id)}),this.set({cid:i.id,id:i.id,style:i.style,type:"value",options:i.options||[],option:t,active:!!t,facet:n,name:i.name||(i.item||{}).name,detail:i.detail||(i.item||{}).detail,data:_.copy(i,!0)})},activate:function(e){if(_.isObject(e)){var t=this.getOption("dynamic"),i=!_.findWhere(this.get("options"),{id:e.id});t.hidden=!i,i&&(t.value=e.value,t.item.name=e.name,"dynamic"===(e="dynamic")&&this.trigger("change:option",this)),e=i?"dynamic":e.id}this.set({active:!0,option:e})},deactivate:function(){this.set({active:!1,option:void 0})},isActive:function(){return!(!this.getOption().id||"disabled"===this.getOption().id)&&!!this.get("active")},isMandatory:function(){return this.get("facet").is("mandatory")},getTypeLabel:function(){var e=this.get("facet"),t=e.getType();if("simple"!==t)return"exclusive"===t||"custom"===t?e.getName():this.getOption().name},getTokenType:function(){return this.isPerson()?this.getTypeLabel():""},getTokenValue:function(){return this.isPerson()?this.getNameDetail()||this.getDisplayName():this.getDisplayName()},getOption:function(e){var t=e||this.get("option"),i=this.get("options");return i.length?t?_.findWhere(i,{id:t})||{}:_.findWhere(i,{hidden:!1})||i[0]:this.get("data")},getOriginalId:function(){return this.get("id")},getImageUrl:function(){var e=this.get("data");if(e.item)return e.item.image_url},getFilter:function(){return this.getOption().filter},getName:function(){return"folder"===this.get("facet").get("id")?(this.getOption().item||this.getOption()).name:this.get("name")||e("All")},isPerson:function(){return this.get("facet").hasPersons()},getDisplayName:function(){var e=this.getName(),t=this.get("detail");return!t||this.isPerson()?e:e+" "+t},getNameDetail:function(){return this.get("detail")},getRequest:function(){var e={simple:function(){return{facet:this.get("facet").get("data").id,value:this.get("facet").get("cid"),filter:this.getFilter()}},default:function(){return{facet:this.get("facet").get("data").id,value:this.get("data").id,filter:this.getFilter()}},exclusive:function(){return{facet:this.get("facet").get("data").id,value:this.getOption().id,filter:this.getFilter()}},custom:function(){return{facet:this.get("facet").get("data").id.replace(".custom",""),value:this.getOption().value,filter:this.getFilter()}}};return function(){if(this.isActive()||this.isMandatory()){var t=this.get("facet").getType();return e[t].call(this)}}}()})}),define("io.ox/find/api",["io.ox/core/http","io.ox/core/cache","io.ox/core/api/factory","settings!io.ox/contacts"],function(e,t,i,n){function a(e){var t=e.params.module,n=r[t],a={};return n.extendColumns&&n.columns&&(a.columns=i.extendColumns(n.extendColumns,t,n.columns)),n.extendFields&&n.fields&&(a.fields=i.extendColumns(n.extendFields,t,n.fields)),{params:a}}function o(e){var t=_.copy(s.options.requests[e],!0);return _.extend(t.data.options,{admin:n.get("showAdmin",!1)}),t}var s=i({id:"search",module:"find",requests:{autocomplete:{module:"find",method:"PUT",params:{action:"autocomplete",module:"",limit:6},data:{prefix:"",options:{timezone:"UTC"},facets:[]}},query:{module:"find",method:"PUT",params:{action:"query",module:""},data:{facets:[],options:{timezone:"UTC"},start:0,size:100}}}}),r={mail:{columns:e.defaultColumns.mail.search,extendColumns:"io.ox/mail/api/list"},files:{columns:"20,23,1,5,700,702,703,704,705,707,3",extendColumns:"io.ox/files/api/list"},tasks:{columns:"1,20,101,200,202,203,220,300,301,309",extendColumns:"io.ox/tasks/api/list"},contacts:{columns:"20,1,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607,5",extendColumns:"io.ox/contacts/api/list"},calendar:{fields:"color,createdBy,endDate,flags,folder,id,location,recurrenceId,seriesId,startDate,summary,timestamp",extendFields:"io.ox/calendar/api/fields"}},d=new t.SimpleCache("find/autocomplete");return s.cid=function(e){return JSON.stringify(e)},s.config=function(e){var t=$.extend(!0,{},o("autocomplete"),e);return t.data.options.check=!1,s.autocomplete(t)},s.autocomplete=function(t){var i=$.extend(!0,{},o("autocomplete"),t),n=s.cid(i);return d.get(n).then(function(t){return null!==t?t:e[i.method](i).then(d.add.bind(this,n))})},s.resetCache=function(){d.clear()},s.query=function(t){var i=$.extend(!0,{},o("query"),a(t),t);return e[i.method](i)},s}),define("io.ox/find/apiproxy",["io.ox/core/extensions","io.ox/find/api","io.ox/core/notifications","io.ox/find/extensions-api"],function(e,t,i,n){var a=e.point("io.ox/find/api/autocomplete");a.extend({id:"custom-facet-daterange",index:200,customize:n.daterange}),a.extend({id:"flag",index:300,customize:n.flag}),a.extend({id:"folder",index:350,customize:n.folder}),a.extend({id:"account",index:360,customize:n.account}),a.extend({id:"add-option-disabled",index:400,customize:n.addOptionDisabled});return{init:function(n){function o(t,i){var o=e.Baton.ensure({app:n,data:i.facets,request:t,waitsFor:[]});return a.invoke("customize",this,o),$.when.apply($,o.waitsFor).then(function(){return o.data})}function s(e){return e.data.facets=r.manager.getRequest(),e.data.options=e.data.options||{},/^virtual/.test(e.data.options.folder)&&!n.isMandatory("folder")&&(e.data.options.folder=void 0),t.autocomplete(e).then(o.bind(this,e))}var r=n.model;return{resetCache:t.resetCache,config:function(e){var i={params:{module:n.getModuleParam()},data:{facets:r.manager.getRequest(),prefix:""}},a=$.extend(!0,i,e||{});return t.config(a).then(o.bind(this,a))},search:function(e){var t={params:{module:n.getModuleParam()},data:{prefix:e}};return n.trigger("find:autocomplete:start",e),s(t).then(function(t){return r.set({query:e}),t},function(e){throw i.yell(e),e})},query:function(){function e(e){return!e.data.facets.length||1===e.data.facets.length&&"folder"===e.data.facets[0].facet?$.Deferred().resolve(void 0):t.query(e)}function a(e,t){return t&&(t.request=e),t}function o(e){return e&&n.trigger("find:query:result",e),n.trigger("find:query:stop"),e}function s(e){throw i.yell(e),n.trigger("find:query:stop"),n.trigger("find:query:fail"),e}return function(t,i){var d=r.manager,c={params:_.extend({module:n.getModuleParam()},i),data:{start:r.get("start"),size:r.get("size")+r.get("extra"),facets:d.getRequest()}};return n.trigger("find:query:start"),n.trigger("find:query:running"),e(c).then(a.bind(this,c)).then(t?o:_.lfo(o),t?s:_.lfo(s))}}()}}}}),define("io.ox/find/extensions-api",["io.ox/core/folder/util","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i){function n(e){return/^virtual/.test(e.id)}function a(t){return!e.can("read",t)}return{daterange:function(e){if(!(_.device("smartphone")||e.app&&"io.ox/mail"!==e.app.getModule())){var t,n,a=e.request.data.prefix;e.data=_.filter(e.data,function(e){return"date"!==e.id||(t=_.copy(e),n=_.copy(e.options[0]),delete t.options,t=$.extend(t,{id:t.id+".custom",style:"custom",values:[n]}),delete n.filter,delete n.name,n=$.extend(n,{id:"custom",facet:t.id,item:{name:a,detail:i("as date")},value:a||"",options:[]}),!1)}),t&&e.data.unshift(t)}},flag:function(e){if(!_.device("smartphone")){var t={style:["simple"],id:["contacts","contact","participant","task_participants","date.custom"]};_.each(e.data,function(e){var i=_.contains(t.style,e.style),n=_.contains(t.id,e.id);!(i||n)?e.flags.push("toolbar"):e.flags.push("tokenfield")})}},folder:function(e){var o=$.Deferred(),s={current:1,default:2,standard:3};require(["io.ox/core/http","io.ox/core/folder/api","io.ox/core/api/account"],function(r,d,c){var u,l,f,h,p=[],m=e.app.getModuleParam(),g={},v={};return e.data.unshift(h={id:"folder",name:i("Folder"),style:"custom",custom:!0,hidden:!0,flags:["toolbar","conflicts:folder_type","mandatory"],values:[{facet:"folder",id:"custom",item:{name:i("Folder")},options:[{account:void 0,value:null,id:"disabled",data:{},item:{name:i("All Folders")},hidden:e.app.isMandatory("folder"),type:"virtual",filter:null}]}]}),e.app.isMandatory("folder")&&h.flags.push("mandatory"),m="files"===m?"infostore":m,r.pause(),"mail"===m?(_.each(d.getStandardMailFolders(),function(t){var i=t.indexOf("default0")>-1;if(i&&["inbox","sent","drafts","trash"].indexOf(c.getType(t))>-1)return v[t]="standard";if(!i){var n=e.app.get("parent").folder.get().split("/")[0];if(!(t.indexOf(n)<0||["inbox","sent"].indexOf(c.getType(t))<0))return v[t]="standard"}}),p.push(c.all())):p.push($.Deferred().resolve([])),(u=d.getDefaultFolder(m))&&(v[u]="default"),f=u=e.app.get("parent").folder.get()||void 0,u&&!v[u]&&(v[u]="current"),l=_(v).chain().keys().uniq().value(),p.push(d.multiple(l)),r.resume(),$.when.apply($,p).then(function(t,i){var n=$.Deferred(),a=e.app.get("storages"),o=e.app.get("parent");return a.length<=1?n.resolve(t,i):(o.folder.getData().then(function(e){var o=a.findWhere({qualifiedId:e.account_id});o&&(i=_.filter(i,function(e){return e.account_id===o.get("qualifiedId")})),n.resolve(t,i)}),n)}).then(function(e,t){return _.each(e,function(e){g[e.id]=e}),_(t).chain().compact().map(function(e){return{id:e.id,title:e.title||e.id,type:v[e.id],data:e}}).value()}).then(function(e){var t,i={};return _.each(e,function(e){t=c.parseAccountId(e.id),i[t]=i[t]||{list:[]},i[t].list.push(e),i[t].name=(g[t]||{}).name}),i}).then(function(e){return _.each(e,function(e,t){if("0"!==t)for(var i=e.length-1;i>1;i--)e.list[i].hidden=!0;e.list.sort(function(e,t){return s[e.type]-s[t.type]}),_.each(e.list,function(t){t.accountname=e.name,t.hidden=n(t)})}),e}).then(function(e){var t=h.values[0].options;_.each(e,function(e,i){var n="0"===i;_.each(e.list,function(e){t.push({id:"current"===e.type?"dynamic":e.id,value:e.id,item:{name:e.title,detail:n?void 0:e.accountname},hidden:e.hidden,type:"current"===e.type?"dynamic":e.type,account:i,data:e.data,filter:null})})}),t.push({account:void 0,value:void 0,id:"callback",data:{},item:{name:i("More")+"…"},type:"link",callback:"openFolderDialog",filter:null}),_.findWhere(t,{id:"dynamic"})||t.push({account:void 0,value:void 0,id:"dynamic",data:{},item:{name:""},hidden:!0,type:"current",filter:null})}).then(function(){var i,s,r,c,u,l=h.values[0].options,p=_.findWhere(l,{id:"disabled"}),g=_.findWhere(l,{value:f}),v=_.findWhere(l,{type:"default"}),x="0"===g.account,y=t.get("search/allfolders",{mail:!1});if(i=g||v,!x&&g&&a(g.data)){var w=g.account;(i=_.findWhere(l,{type:"standard",account:w})||i).id!==g.id&&(l=h.values[0].options=_.without(l,g))}s=e.app.isMandatory("folder"),r="default"===i.type,c="mail"===m?!d.can("read",i.data):n(i.data),u=r&&!1!==y[m],s||!u&&!c?s&&c&&(i=v):i=p||v,i.active=!0,o.resolve()})}),e.waitsFor.push(o)},account:function(e){var t=$.Deferred(),n=e.app.get("storages");if(!(n.length<=1)){if("files"!==e.app.getModuleParam())return t.resolve();var a,o=[];return e.data.unshift(a={id:"account",name:i("Accounts"),style:"custom",custom:!0,hidden:!0,flags:["toolbar","hidden"],values:[{facet:"folder",id:"custom",item:{name:i("Folder")},options:[]}]}),e.app.isMandatory("account")&&a.flags.push("mandatory"),e.waitsFor.push(t),$.when.apply($,o).then(function(){var e=a.values[0].options;n.each(function(t){var i=t.get("isDefaultAccount"),n={id:t.get("id"),value:t.get("qualifiedId"),item:{name:t.get("displayName"),detail:t.get("filestorageService")},hidden:!0,type:t.get("filestorageService"),account:t.get("id"),data:t.attributes,filter:null};i?e.splice(0,0,n):e.push(n)})}).then(function(){return e.app.get("parent").folder.getData().then(function(e){_.each(a.values[0].options,function(t){t.data.qualifiedId===e.account_id&&(t.active=!0)})})}).then(t.resolve)}},addOptionDisabled:function(e){_.each(e.data,function(e){!_.contains(e.flags,"tokenfield")&&e.options&&e.options.unshift({id:"disabled",name:i("All"),type:"all",filter:null,value:null})})}}}),define("io.ox/find/extensions-facets",["io.ox/core/extensions","io.ox/backbone/mini-views/toolbar","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/helplink","gettext!io.ox/core"],function(e,t,i,n,a){return{toolbar:function(i){if(!_.device("smartphone")){var n=new t({title:a("Search")}).render().$list.clone();this.append(n),e.point("io.ox/find/facets/list").invoke("draw",n,i)}},list:function(t){var i,n=this,a=[];i=t.model.manager.filter(function(e){return e.is("toolbar")}),t.options.conflicting={},_.each(i,function(e){e.getValue().isActive()&&_.each(e.getConflicting(),function(e){t.options.conflicting[e]=!0})}),_.each(i,function(i){if(i.is("toolbar")){var o=i.get("id"),s=e.point("io.ox/find/facets/dropdown/"+o);s.list().length>0?s.invoke("draw",n,t,i):a.push(i)}}),a.length&&e.point("io.ox/find/facets/dropdown/default").invoke("draw",this,t,a),e.point("io.ox/find/facets/help").invoke("draw",this,t,a)},dropdownDefault:function(t,n){var o=new Backbone.Model,s=new i({model:o,tagName:"li",className:"facets dropdown pull-left",attributes:{"data-dropdown":"view",role:"presentation"},caret:!0,label:a("Options")});_.each(n,function(i){e.point("io.ox/find/facets/dropdown/default/item").invoke("draw",s,t,i)}),o.on("change",function(e){var i=Object.keys(e.changed)[0],n=e.get(i+":value"),a=e.get(i);t.model.manager.activate(i,n,a)}),this.append(s.render().$el)},item:function(e,t){var i=this,n=i.model,a=t.id,o=e.options.conflicting[a];i.$ul.append($('<li class="dropdown-header">').text(t.getName())),_.each(t.get("values").models,function(e){e.set(a,e.getOption().id),n.set(a,e.getOption().id),n.set(a+":value",e.id),_.each(e.get("options"),function(e){if(!e.hidden){var t=(e.item||e).name;i.option(a,e.id,t),o&&i.$ul.children().last().find("a").addClass("disabled")}})})},dropdownFolder:function(e,t){var n,a=t.get("values").first(),o=a.getOption().id,s=new Backbone.Model({option:o}),r=new i({model:s,tagName:"li",caret:!0,label:a.getOption().name||a.getDisplayName(),attributes:{"data-facet":t.get("id"),"data-dropdown":"view",role:"presentation"},className:"facets dropdown pull-left"});e.options.conflicting[t.id]&&r.$el.addClass("conflicting");var d={default:"standard"};a.set("option",o),s.on("change:option",function(t,i){e.view.userchange(),a.activate(i)}),_.each(a.get("options"),function(t){if(!t.hidden){var i=(t.item||t).name,a=t.account||t.type,o=e.view.ui.facets;n&&(d[a]||a!==n)&&(r.divider(),t.item&&t.item.detail&&r.$ul.append($('<li class="dropdown-header">').text(t.item.detail))),n=d[a]||a,"link"!==a?r.option("option",t.id,i):r.link("link",i,_.bind(o[t.callback],o))}}),this.append(r.render().$el)},help:function(){var e={mail:"ox.appsuite.user.sect.email.search.html",contacts:"ox.appsuite.user.sect.contacts.search.html",calendar:"ox.appsuite.user.sect.calendar.search.html",tasks:"ox.appsuite.user.sect.tasks.search.html",files:"ox.appsuite.user.sect.drive.search.html"};return function(t){var i=e[t.app.getModuleParam()];if(i){var a=new n({href:i});a.$el.hasClass("hidden")||this.append($('<li class="pull-right" role="presentation">').append(a.render().$el))}}}()}}),define("io.ox/find/extensions-tokenfield",["io.ox/core/extensions","io.ox/core/util","io.ox/contacts/api"],function(e,t,i){var n="io.ox/find/tokenfield";return{item:function(t){this.addClass(t.data.facet.getOriginalId()),this.attr("data-id",t.data.value.getOriginalId()),e.point(n+"/image").invoke("draw",this,t),e.point(n+"/name").invoke("draw",this,t),e.point(n+"/detail").invoke("draw",this,t)},image:function(e){if(e.data.facet.hasPersons()){var t=e.data.value.get("data").item||{};this.removeClass("indent"),this.append(i.pictureHalo($('<div class="image">'),{email:t.detail,image1_url:t.image_url},{width:40,height:40,effect:"fadeIn",urlOnly:!1}))}},name:function(e){var t=e.data.value.getName()||" ";this.data(e.data).append($('<div class="name">').text(t))},detail:function(e){var t=e.data.value.getNameDetail();e.data.facet.hasPersons()?(this.removeClass("indent"),this.append($('<div class="detail">').text(t||" "))):t&&this.find(".name").append($("<i>").text(" "+t))},click:function(e){e.data.deferred.done(function(t){var i=e.data.model.manager,n=t.get("facet");i.activate(n.get("id"),t.get("id"),t.get("option"))})}}}),define("io.ox/find/model",["io.ox/find/api","io.ox/find/manager/facet-collection"],function(e,t){return Backbone.Model.extend({defaults:function(){return{query:"",start:0,size:100,extra:1}},initialize:function(e){this.manager=new t,this.app=e.app,_.defer(_.bind(this.update,this))},update:function(){var e=this;require(["io.ox/core/folder/api","io.ox/core/api/account"],function(t,i){if("mail"===e.app.getModuleParam()){var n=_.filter(t.getStandardMailFolders(),function(e){if(i.is("inbox",e)||i.is("sent",e))return!0});t.multiple(n)}})},reset:function(e){var t=e||{};this.set({query:"",start:0},{silent:!0}),this.manager.reset(),t.silent||this.trigger("reset")}})}),define("io.ox/find/view-facets",["io.ox/find/extensions-facets","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/api/account","gettext!io.ox/core"],function(e,t,i,n,a){var o="io.ox/find/facets";return i.point(o+"/toolbar").extend({index:100,draw:e.toolbar}),i.point(o+"/list").extend({index:100,draw:e.list}),i.point(o+"/dropdown/default").extend({index:100,draw:e.dropdownDefault}),i.point(o+"/dropdown/default/item").extend({index:100,draw:e.item}),i.point(o+"/dropdown/folder").extend({index:100,draw:e.dropdownFolder}),i.point(o+"/dropdown/account").extend({index:100,draw:$.noop}),i.point(o+"/help").extend({index:100,draw:e.help}),Backbone.View.extend({attributes:{"aria-label":a("Search facets"),role:"navigation"},initialize:function(e){_.extend(this,e),this.setElement(this.parent.$el.find(".search-box-filter")),this.register()},register:function(){this.listenTo(this.app.model.manager,"active",$.proxy(this.redraw,this)),this.listenTo(this.app,"find:config-updated",$.proxy(this.render,this))},redraw:function(){this.render()},render:function(){return this.reset(),i.point("io.ox/find/facets/toolbar").invoke("draw",this.$el,this.baton),this.$el.find("ul.classic-toolbar").outerHeight(this.$el.parent().outerHeight()),this.$el.find("ul.classic-toolbar > li > a:not(:first)").attr("tabindex",-1),this},show:function(){this.$el.show()},hide:function(){this.$el.hide()},reset:function(){this.$el.empty()},focus:function(){this.$el.find(".facet > a").focus()},is:function(e,i,n){var a;return!!(a={readable:_.partial(t.can,"read"),virtual:function(e){return t.isVirtual(e.id)},account:function(e,t){return e.account=t.account}}[e])&&a.call(this,i,n)},openFolderDialog:function(){function e(e){if("mail"===u)return!n.isPrimary(e.id)&&(n.isPrimary(c)&&!n.isPrimary(e.id));if("infostore"===u){var t=i.model.manager.get("account");if(!t)return;return e.account_id!==t.getValue().getOption().value}return!1}var i=this,a=i.is,o=i.model.manager,s=o.get("folder"),r=s.getValue().getOption().value,d=i.baton.app.getModuleParam(),c=r||t.getDefaultFolder(u),u="files"===d?"infostore":d;require(["io.ox/core/folder/picker"],function(i){i({async:!0,folder:c,module:u,root:"files"===d?"9":"1",flat:t.isFlat(u),done:function(e,i){t.get(e).always(function(t){var n=(t||{}).title||e;o.activate(s.id,"custom",{value:e,id:e,name:n}),i.close()})},disable:function(i){return!a("readable",i)||t.is("virtual",i)||e(i)}})})}})}),define("io.ox/find/view-placeholder",["io.ox/backbone/views/disposable","gettext!io.ox/core"],function(e,t){return e.extend({events:{focusin:"focused",keyup:"showSpinner"},initialize:function(e){var t=e.app.getWindow();this.setElement(t.nodes.sidepanel.find(".io-ox-find")),this.ui={field:this.$el.find(".search-field"),action:this.$el.find(".action-show")},this.options=e,this.listenTo(e.app,"view:disable",this.disable),this.listenTo(e.app,"view:enable",this.enable)},hideSpinner:function(){this.ui.action.removeClass("io-ox-busy")},showSpinner:function(){this.ui.action.addClass("io-ox-busy")},disable:function(){!0!==this.ui.field.prop("disabled")&&(this.ui.field.prop("disabled",!0),this.ui.action.prop("disabled",!0),this.ui.field.find("input.token-input.tt-input").removeAttr("tabindex"),this.$el.find(".arialive").text(t("Search function not supported in this folder")))},enable:function(){!1!==this.ui.field.prop("disabled")&&(this.ui.field.prop("disabled",!1),this.ui.action.prop("disabled",!1),this.ui.field.find("input.token-input.tt-input").attr("tabindex",0),this.$el.find(".arialive").text(""))},focused:function(){this.trigger("launch"),this.destroy()},destroy:function(){this.disposed||(this.hideSpinner(),this.trigger("destroy"),this.dispose())}})}),define("io.ox/find/view-searchbox",["io.ox/find/view-tokenfield"],function(e){return Backbone.View.extend({_height:{},initialize:function(t){return _.extend(this,t),this.setElement(this.win.nodes.sidepanel.find(".search-box")),this.ui={tokenfield:new e(_.extend(t,{parent:this}))},this.register(),this},render:function(){return this.ui.tokenfield.render(),this._height.initial=this._height.current=this.$el.outerHeight(),this},show:function(){this.setFocus()},hide:$.noop,reset:function(){this.ui.tokenfield.reset(),this.ui.tokenfield.hiddenapi.dropdown.empty(),this.ui.tokenfield.hiddenapi.dropdown.close()},_onResize:function(){var e=this;_.defer(function(){var t=_.max([e._height.initial,e.$el.height()]),i=t-e._height.current;i&&(e._height.current=t,e.trigger("resize",i))})},register:function(){this.ui.tokenfield.on("tokenfield:createdtoken tokenfield:removedtoken",_.bind(this._onResize,this))},isEmpty:function(){return this.ui.tokenfield.isEmpty()},setFocus:function(){return this.ui.tokenfield.setFocus()}})}),define("io.ox/find/view-token",["io.ox/backbone/mini-views/dropdown"],function(e){return Backbone.View.extend({initialize:function(){return this.ui={label:this.$el.find(".token-label"),tokeninput:this.$el.parent().find(".token-input.tt-input"),dropdown:$()},this.api=this.$el.closest(".tokenfield").find("input.tokenfield").data("bs.tokenfield"),this.listenTo(this.model,"change:option",_.bind(this.render,this)),this},render:function(){return this.ui.label.empty().append(this.model.isPerson()?this.getDropdown():this.getNameNode()),this.api.update(),this},getNameNode:function(){return this.model.isPerson()?$():this.model.getNameDetail()?[$('<span class="token-name">').text(this.model.getName()),$.txt(" "),$('<span class="token-detail">').text(this.model.getNameDetail())]:$.txt(this.model.getName())},update:function(){var e=this.$el.offset().left;this.ui.dropdown.$el.find(".dropdown-menu").css("left",e)},getDropdown:function(){if(!this.model.isPerson())return $();if(!this.model.get("options").length)return[$('<span class="token-name">').text(this.model.getDisplayName())];var t=this.model,i=new Backbone.Model,n=new e({model:i,tagName:"div",classname:"facets",label:function(){return[$('<span class="token-type">').text(t.getTokenType()),$('<i class="fa fa-caret-down" aria-hidden="true">'),$('<span class="token-name">').text(t.getDisplayName())]}});return n.$el.on("show.bs.dropdown",function(){$(this).find(".dropdown-menu").css("top",$(this).offset().top+$(this).height()+"px")}),this.ui.dropdown=n,i.set("option",t.getOption().id),n.$el.on("show.bs.dropdown",_.bind(this.update,this)),i.on("change:option",function(e,i){t.activate(i)}),_.each(t.get("options"),function(e){if(!e.hidden){var t=(e.item||e).name;n.option("option",e.id,t)}}),n.render().$el.addClass("pull-left").attr("data-dropdown","view")}})}),define("io.ox/find/view-tokenfield",["io.ox/find/extensions-tokenfield","io.ox/core/extensions","settings!io.ox/contacts","io.ox/core/tk/tokenfield","io.ox/find/view-token","gettext!io.ox/core"],function(e,t,i,n,a,o){var s="io.ox/find/tokenfield";return t.point(s+"/item").extend({index:100,draw:e.item}),t.point(s+"/name").extend({index:100,draw:e.name}),t.point(s+"/detail").extend({index:100,draw:e.detail}),t.point(s+"/image").extend({index:100,draw:e.image}),t.point(s+"/handler/click").extend({index:"last",flow:e.click}),t.point(s+"/token").extend({id:"token",index:100,draw:function(e,t){t.attrs.view||(t.attrs.view=new a({model:e,el:t.relatedTarget})),t.attrs.view.render()}}),Backbone.View.extend({api:$.noop,initialize:function(e){return _.extend(this,e),this.ui={container:void 0,field:void 0,view:void 0},this},render:function(){var e,a=this.app,r=this.baton,d=r.app.view.$el.find(".search-field"),c=r.app.view.$el.find(".action-show"),u=_.uniqueId("form-control-label-"),l=r.model,f=d.is(":focus")||c.is(":focus"),h=this;return this.ui.view=new n({extPoint:s,id:u,placeholder:o("Search")+"...",className:"search-field",delayedautoselect:!0,inputtype:"search",dnd:!1,hint:!1,allowEditing:!1,createTokensOnBlur:!1,customDefaultModel:!0,delimiter:"",maxResults:20,minLength:Math.max(1,i.get("search/minimumQueryLength",1)),autoselect:!0,source:a.getSuggestions,reduce:function(e){var t=l.manager,i=[];return t.update(e,{keep:"folder"}),e=t.filter(function(e){return e.is("tokenfield")&&!e.is("hidden")}),_.each(e,function(e){i=i.concat(e.get("values").filter(function(e){return!e.isActive()}))}),i},suggestion:function(e){var i=$('<div class="autocomplete-item">'),n=e.model;return function(e){var i=e.get("facet"),n=i.get("data").id;r.data={value:e,facet:i};var a=t.point(s+"/item/"+n);a.list().length?a.invoke("draw",this,r):t.point(s+"/item").invoke("draw",this,r)}.call(i,n),i},harmonize:function(e){return _(e).map(function(e){return{label:e.getDisplayName(),value:e.getDisplayName(),model:e}})},click:function(e,i){var n=t.Baton.ensure({deferred:$.Deferred().resolve(i.model),model:l});t.point(s+"/handler/click").invoke("flow",this,n)}}),this.ui.field=this.ui.view.$el,this.api=_.bind(this.ui.field.tokenfield,this.ui.field),e=d.val(),d.replaceWith(this.ui.field),this.register(),this.ui.view.render(),this.instance=this.ui.field.data("bs.tokenfield"),this.hiddenapi=this.ui.view.hiddenapi,this.ui.container=this.ui.field.parent(),this.ui.tokeninput=this.ui.container.find(".token-input"),f&&this.setFocus(),e&&this.app.on("change:state",function(t,i){"launched"===i&&h.hiddenapi.input.setInputValue(e,!1)}),this.ui.tokeninput.on({"typeahead:cursorchange typeahead:cursorchanged":_.bind(this.updateSelection,this,"add"),"typeahead:close typeahead:closed":_.bind(this.updateSelection,this,"remove"),"typeahead:select typeahead:selected":_.bind(this.updateSelection,this,"remove")}),this},retrigger:function(e,t){this.trigger(e.type,e,t)},reopenDropdown:function(){var e=this.hiddenapi;e.dropdown.isOpen||this.getQuery()&&e.input.trigger("queryChanged",e.input.query)},disable:function(){this.api("disable")},enable:function(){this.api("enable")},register:function(){var e=this;this.ui.field.on(["tokenfield:initialize","tokenfield:clickedtoken","tokenfield:createtoken","tokenfield:createdtoken","tokenfield:removetoken","tokenfield:removedtoken","aria-live-update"].join(" "),_.bind(this.retrigger,this)),this.on({"tokenfield:createtoken":function(e){$(document.activeElement).is("body")&&e.preventDefault()},"tokenfield:createdtoken tokenfield:removedtoken":_.bind(this.setPlaceholder,this),"tokenfield:removedtoken":_.bind(this.removedToken,this),"aria-live-update":_.bind(this.updateAriaLive,this)}),this.ui.view.on({"typeahead-custom:dropdown-rendered":_.bind(this.restoreSelection,this)}),this.app.view.on({focusin:_.bind(e.reopenDropdown,e)}),this.app.on({"view:disable":_.bind(e.disable,e),"view:enable":_.bind(e.enable,e)})},updateAriaLive:function(e,t){$(".io-ox-find .arialive").text(t)},updateSelection:function(e,t,i){if("add"!==e||!i)return this.ui.selected=void 0;this.ui.selected=i.model.get("id")},restoreSelection:function(){if(this.ui.selected){var e=$('.tt-suggestion> [data-id="'+this.ui.selected+'"]');if(!e.length)return this.ui.selected=void 0;e.parent().addClass("tt-cursor")}},removedToken:function(e){_([].concat(e.attrs)).each(function(e){e.model.deactivate()}),this.setFocus()},getField:function(){return this.ui.field},getQuery:function(){return this.ui.tokeninput.val().trim()},isEmpty:function(){var e=this.model.manager.getActive();return!_.filter(e,function(e){return!e.is("mandatory")}).length&&0===this.api("getTokens").length&&""===this.getQuery()},empty:function(){var e=this,t=this.api("getTokens");_.each(t,function(t){e.ui.field.trigger($.Event("tokenfield:removetoken",{attrs:t}))}),this.api("setTokens",[],!1,!1),_.each(t,function(t){e.ui.field.trigger($.Event("tokenfield:removedtoken",{attrs:t}))})},reset:function(){this.hiddenapi.setVal(""),this.empty(),this.setPlaceholder(),this.ui.tokeninput.css("width","auto")},setFocus:function(){this.ui.tokeninput.focus()},setPlaceholder:function(){this.ui.container.find("input.tt-input").attr({placeholder:this.isEmpty()?this.ui.view.options.placeholder||"":""})}})}),define("io.ox/find/view",["io.ox/core/extensions","io.ox/find/view-searchbox","io.ox/find/view-facets","gettext!io.ox/core","less!io.ox/find/style"],function(e,t,i,n){return Backbone.View.extend({events:{"focusin .token-input":"show",keydown:"onKeydown",focusout:"smartCancel","click .action-cancel":"cancel","keydown .action-cancel":"cancel"},classes:{active:"io-ox-find-active",userchange:"changed-by-user"},initialize:function(n){var a={app:n.app,win:n.app.getWindow(),model:n.model,baton:e.Baton({app:n.app,model:n.model,view:this,$:this.$el})};a.baton.model=a.model,_.extend(this,a),_.extend(this,{active:!1,lastFocus:"",selectors:{facets:".search-facets:first",facetsadv:".search-facets-advanced"}}),this.setElement(this.win.nodes.sidepanel.find(".io-ox-find")),this.ui={container:void 0,body:void 0,manager:void 0,searchbox:void 0,facets:void 0,field:this.$el.find(".search-field"),action:this.$el.find(".action-show")},this.ui.container=this.$el.closest(".window-container"),this.ui.body=this.ui.container.find(".window-body"),this.ui.manager=$("#io-ox-windowmanager"),this.ui.searchbox=new t(_.extend(a,{parent:this})),this.ui.facets=new i(_.extend(a,{parent:this})),this.listenTo(n.app,"view:disable",this.disable),this.listenTo(n.app,"view:enable",this.enable)},disable:function(){!0!==this.ui.field.prop("disabled")&&(this.ui.field.prop("disabled",!0),this.ui.action.prop("disabled",!0),this.ui.field.find("input.token-input.tt-input").removeAttr("tabindex"),this.$el.find("input.form-control.tokenfield").trigger("aria-live-update",n("Search function not supported in this folder")))},enable:function(){!1!==this.ui.field.prop("disabled")&&(this.ui.field.prop("disabled",!1),this.ui.action.prop("disabled",!1),this.ui.field.find("input.token-input.tt-input").attr("tabindex",0),this.$el.find("input.form-control.tokenfield").trigger("aria-live-update",""))},calculateDimensions:function(){this.css={body:{closed:this.ui.body.css("top"),open:this.$el.outerHeight()+"px"},el:{closed:this.$el.css("top"),open:this.ui.manager.offset().top+"px"}}},render:function(){return this.ui.searchbox.render(),this.ui.facets.render(),this.register(),this},onKeydown:function(e){this.isActive()||9===e.which||this.show()},show:function(){this.trigger("focusin"),this.isActive()||(this.calculateDimensions(),this.$el.next().css("margin-top",this.css.body.open),this.ui.body.css("top",this.css.body.open),this.ui.container.addClass(this.classes.active),this.ui.searchbox.show(),this.ui.facets.show(),this.trigger("show"))},hide:function(){this.isActive()&&this.isEmpty()&&(this.$el.next().css("margin-top",""),this.ui.body.css("top",this.css.body.closed),this.$el.css("top",this.css.el.closed),this.ui.container.removeClass(this.classes.active),this.ui.searchbox.hide(),this.ui.facets.hide(),this.trigger("hide"))},reset:function(){this.isActive()&&(this.model.reset(),this.ui.searchbox.reset(),this.ui.facets.reset(),this.ui.container.removeClass(this.classes.userchange),this.trigger("reset"))},cancel:function(e){e&&"click"!==e.type&&!/13|32/.test(e.which)||(this.reset(),this.hide(),this.trigger("cancel"))},userchange:function(){this.ui.container.addClass(this.classes.userchange),this.setFocus()},hasChanged:function(){return this.ui.container.hasClass(this.classes.userchange)},smartCancel:function(){var e=this;this.app.trigger("focusout"),_.delay(function(){e.hasFocus()||!e.isEmpty()||e.hasChanged()||e.cancel()},150)},_onResize:function(e){var t=this.$el,i=this.ui.facets.$el.find("ul"),n=this.$el.closest(".window-sidepanel").find(".folder-tree"),a=this.$el.closest(".window-container").find(".window-body");t.outerHeight(t.outerHeight()+e),i.outerHeight(i.outerHeight()+e),n.offset({top:n.offset().top+e}),this.app.isActive()&&a.offset({top:a.offset().top+e})},register:function(){this.ui.searchbox.on("resize",_.bind(this._onResize,this))},setFocus:function(){return this.ui.searchbox.setFocus()},isActive:function(){return this.ui.container.hasClass(this.classes.active)},isEmpty:function(){return this.ui.searchbox.isEmpty()},hasFocus:function(){return!!$(document.activeElement).closest(".io-ox-find, .smart-dropdown-container.facets").length}})})});