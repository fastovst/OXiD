define("io.ox/find/extensions-api",["io.ox/core/folder/util","settings!io.ox/core","gettext!io.ox/core"],function(e,t,a){"use strict";function n(e){return/^virtual/.test(e.id)}function i(t){return!e.can("read",t)}return{daterange:function(e){if(!(_.device("smartphone")||e.app&&"io.ox/mail"!==e.app.getModule())){var t,n,i=e.request.data.prefix;e.data=_.filter(e.data,function(e){return"date"!==e.id||(t=_.copy(e),n=_.copy(e.options[0]),delete t.options,t=$.extend(t,{id:t.id+".custom",style:"custom",values:[n]}),delete n.filter,delete n.name,n=$.extend(n,{id:"custom",facet:t.id,item:{name:i,detail:a("as date")},value:i||"",options:[]}),!1)}),t&&e.data.unshift(t)}},flag:function(e){if(!_.device("smartphone")){var t={style:["simple"],id:["contacts","contact","participant","task_participants","date.custom"]};_.each(e.data,function(e){var a=_.contains(t.style,e.style),n=_.contains(t.id,e.id);!(a||n)?e.flags.push("toolbar"):e.flags.push("tokenfield")})}},folder:function(e){var o=$.Deferred(),d={current:1,default:2,standard:3};require(["io.ox/core/http","io.ox/core/folder/api","io.ox/core/api/account"],function(r,l,u){var c,s,f,p,h=[],v=e.app.getModuleParam(),m={},g={};return e.data.unshift(p={id:"folder",name:a("Folder"),style:"custom",custom:!0,hidden:!0,flags:["toolbar","conflicts:folder_type","mandatory"],values:[{facet:"folder",id:"custom",item:{name:a("Folder")},options:[{account:void 0,value:null,id:"disabled",data:{},item:{name:a("All Folders")},hidden:e.app.isMandatory("folder"),type:"virtual",filter:null}]}]}),e.app.isMandatory("folder")&&p.flags.push("mandatory"),v="files"===v?"infostore":v,r.pause(),"mail"===v?(_.each(l.getStandardMailFolders(),function(t){var a=t.indexOf("default0")>-1;if(a&&["inbox","sent","drafts","trash"].indexOf(u.getType(t))>-1)return g[t]="standard";if(!a){var n=e.app.get("parent").folder.get().split("/")[0];if(!(t.indexOf(n)<0||["inbox","sent"].indexOf(u.getType(t))<0))return g[t]="standard"}}),h.push(u.all())):h.push($.Deferred().resolve([])),(c=l.getDefaultFolder(v))&&(g[c]="default"),f=c=e.app.get("parent").folder.get()||void 0,c&&!g[c]&&(g[c]="current"),s=_(g).chain().keys().uniq().value(),h.push(l.multiple(s)),r.resume(),$.when.apply($,h).then(function(t,a){var n=$.Deferred(),i=e.app.get("storages"),o=e.app.get("parent");return i.length<=1?n.resolve(t,a):(o.folder.getData().then(function(e){var o=i.findWhere({qualifiedId:e.account_id});o&&(a=_.filter(a,function(e){return e.account_id===o.get("qualifiedId")})),n.resolve(t,a)}),n)}).then(function(e,t){return _.each(e,function(e){m[e.id]=e}),_(t).chain().compact().map(function(e){return{id:e.id,title:e.title||e.id,type:g[e.id],data:e}}).value()}).then(function(e){var t,a={};return _.each(e,function(e){t=u.parseAccountId(e.id),a[t]=a[t]||{list:[]},a[t].list.push(e),a[t].name=(m[t]||{}).name}),a}).then(function(e){return _.each(e,function(e,t){if("0"!==t)for(var a=e.length-1;a>1;a--)e.list[a].hidden=!0;e.list.sort(function(e,t){return d[e.type]-d[t.type]}),_.each(e.list,function(t){t.accountname=e.name,t.hidden=n(t)})}),e}).then(function(e){var t=p.values[0].options;_.each(e,function(e,a){var n="0"===a;_.each(e.list,function(e){t.push({id:"current"===e.type?"dynamic":e.id,value:e.id,item:{name:e.title,detail:n?void 0:e.accountname},hidden:e.hidden,type:"current"===e.type?"dynamic":e.type,account:a,data:e.data,filter:null})})}),t.push({account:void 0,value:void 0,id:"callback",data:{},item:{name:a("More")+"â€¦"},type:"link",callback:"openFolderDialog",filter:null}),_.findWhere(t,{id:"dynamic"})||t.push({account:void 0,value:void 0,id:"dynamic",data:{},item:{name:""},hidden:!0,type:"current",filter:null})}).then(function(){var a,d,r,u,c,s=p.values[0].options,h=_.findWhere(s,{id:"disabled"}),m=_.findWhere(s,{value:f}),g=_.findWhere(s,{type:"default"}),y="0"===m.account,x=t.get("search/allfolders",{mail:!1});if(a=m||g,!y&&m&&i(m.data)){var b=m.account;(a=_.findWhere(s,{type:"standard",account:b})||a).id!==m.id&&(s=p.values[0].options=_.without(s,m))}d=e.app.isMandatory("folder"),r="default"===a.type,u="mail"===v?!l.can("read",a.data):n(a.data),c=r&&!1!==x[v],d||!c&&!u?d&&u&&(a=g):a=h||g,a.active=!0,o.resolve()})}),e.waitsFor.push(o)},account:function(e){var t=$.Deferred(),n=e.app.get("storages");if(!(n.length<=1)){if("files"!==e.app.getModuleParam())return t.resolve();var i,o=[];return e.data.unshift(i={id:"account",name:a("Accounts"),style:"custom",custom:!0,hidden:!0,flags:["toolbar","hidden"],values:[{facet:"folder",id:"custom",item:{name:a("Folder")},options:[]}]}),e.app.isMandatory("account")&&i.flags.push("mandatory"),e.waitsFor.push(t),$.when.apply($,o).then(function(){var e=i.values[0].options;n.each(function(t){var a=t.get("isDefaultAccount"),n={id:t.get("id"),value:t.get("qualifiedId"),item:{name:t.get("displayName"),detail:t.get("filestorageService")},hidden:!0,type:t.get("filestorageService"),account:t.get("id"),data:t.attributes,filter:null};a?e.splice(0,0,n):e.push(n)})}).then(function(){return e.app.get("parent").folder.getData().then(function(e){_.each(i.values[0].options,function(t){t.data.qualifiedId===e.account_id&&(t.active=!0)})})}).then(t.resolve)}},addOptionDisabled:function(e){_.each(e.data,function(e){!_.contains(e.flags,"tokenfield")&&e.options&&e.options.unshift({id:"disabled",name:a("All"),type:"all",filter:null,value:null})})}}});