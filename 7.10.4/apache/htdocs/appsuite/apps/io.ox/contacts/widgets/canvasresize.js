define("io.ox/contacts/widgets/canvasresize",["io.ox/core/tk/image-util"],function(e){"use strict";function t(e,t,a,r,i){var n=i?"h":"";if(a&&e>a||r&&t>r){var o=e/t;(o>=1||0===r)&&a&&!i?(e=a,t=a/o>>0):i&&o<=a/r?(e=a,t=a/o>>0,n="w"):(e=r*o>>0,t=r)}return{width:e,height:t,cropped:n}}function a(e,t){if(!(_.browser.chrome&&_.browser.chrome>=77)&&self.OffscreenCanvas)return new self.OffscreenCanvas(e,t);var a=document.createElement("canvas");return a.width=e,a.height=t,a}function r(e){var t=e.width;if(t*e.height>1048576){var r=a(1,1).getContext("2d");return r.drawImage(e,1-t,0),0===r.getImageData(0,0,1,1).data[3]}return!1}function i(e,t){var a={1:{90:6,180:3,270:8},2:{90:7,180:4,270:5},3:{90:8,180:1,270:6},4:{90:5,180:2,270:7},5:{90:2,180:7,270:4},6:{90:3,180:8,270:1},7:{90:4,180:5,270:2},8:{90:1,180:6,270:3}};return a[e][t]?a[e][t]:e}function n(e,t,a,r){switch(r){case 5:case 6:case 7:case 8:e.width=a,e.height=t;break;default:e.width=t,e.height=a}var i=e.getContext("2d");switch(r){case 1:break;case 2:i.translate(t,0),i.scale(-1,1);break;case 3:i.translate(t,a),i.rotate(Math.PI);break;case 4:i.translate(0,a),i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI),i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI),i.translate(0,-a);break;case 7:i.rotate(.5*Math.PI),i.translate(t,-a),i.scale(-1,1);break;case 8:i.rotate(-.5*Math.PI),i.translate(-t,0)}}function o(e,t,r){var i=a(1,r).getContext("2d");i.drawImage(e,0,0);for(var n=i.getImageData(1,0,1,r).data,o=0,c=r,s=r;s>o;)0===n[4*(s-1)+3]?c=s:o=s,s=c+o>>1;var h=s/r;return 0===h?1:h}function c(){var e=arguments[0]||{},t=1,a=arguments.length,r=!1;e.constructor===Boolean&&(r=e,e=arguments[1]||{}),1===a&&(e=this,t=0);for(var i;t<a;t++)if(null!==(i=arguments[t]))for(var n in i)e!==i[n]&&(r&&"object"==typeof i[n]&&e[n]?c(e[n],i[n]):void 0!==i[n]&&(e[n]=i[n]));return e}function s(e,c){var s=e.img,h=e.options,g=h.exif||1,f=(g=i(g,h.rotate))>=5&&g<=8?t(s.height,s.width,h.width,h.height,h.crop):t(s.width,s.height,h.width,h.height,h.crop),l=s.width,d=s.height,u=f.width,m=f.height,w=a(300,150),v=w.getContext("2d");v.save(),n(w,u,m,g),h.isSafari&&r(s)&&(l/=2,d/=2);for(var p=1024,I=a(p,p),b=I.getContext("2d"),k=o(s,l,d),x=0;x<d;){for(var C=x+p>d?d-x:p,y=0;y<l;){var M=y+p>l?l-y:p;b.clearRect(0,0,p,p),b.drawImage(s,-y,-x);var D=Math.floor(y*u/l),_=Math.ceil(M*u/l),P=Math.floor(x*m/d/k),R=Math.ceil(C*m/d/k);v.drawImage(I,0,0,M,C,D,P,_,R),y+=p}x+=p}v.restore(),I=b=null;var B=a("h"===f.cropped?m:u,"w"===f.cropped?u:m),L="h"===f.cropped?.5*(m-u):0,U="w"===f.cropped?.5*(u-m):0;B.getContext("2d").drawImage(w,L,U,u,m);var q,z=h.file;return q=B.toDataURL?"image/png"===z.type?B.toDataURL(z.type):B.toDataURL("image/jpeg",.01*h.quality):B.transferToImageBitmap(),c(null,q),q}var h=new e.PromiseWorker({newsize:t,createCanvas:a,detectSubsampling:r,rotate:i,transformCoordinate:n,detectVerticalSquash:o,resize:s}),g={width:300,height:0,crop:!1,quality:80,rotate:0,callback:_.identity};return function(t,a){return a=c({file:t,isSafari:_.device("safari")},g,a),e.getImageFromFile(t,{exif:!0}).then(function(e){return a.exif=e.exif,!(_.browser.chrome&&_.browser.chrome>=77)&&self.OffscreenCanvas&&self.ImageBitmap?h.invoke("resize",{img:e,options:_.omit(a,"callback")}).then(function(e){if(self.ImageBitmap&&e instanceof self.ImageBitmap){var r=document.createElement("canvas");r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height),e="image/png"===t.type?r.toDataURL(t.type):r.toDataURL("image/jpeg",.01*a.quality)}return e},function(e){console.log(e)}):s({img:e,options:a},$.noop)})}});