define("io.ox/contacts/edit/view-form",["io.ox/contacts/model","io.ox/backbone/views","io.ox/backbone/views/actions/util","io.ox/contacts/api","io.ox/contacts/util","io.ox/core/capabilities","io.ox/core/extensions","io.ox/backbone/mini-views","io.ox/backbone/mini-views/attachments","gettext!io.ox/contacts","io.ox/core/folder/api","io.ox/core/folder/util","settings!io.ox/core","less!io.ox/contacts/edit/view-form"],function(e,t,n,a,i,s,o,d,l,r,c,p,m){"use strict";function h(h){function f(){var e=$(this).closest(".edit-contact").toggleClass("compact"),t=e.hasClass("compact");e.find('.field input[type="text"]').each(function(){var e=$(this),t=e.closest(".field"),n=""!==$.trim(e.val());t.toggleClass("has-content",n)}),e.find(".block").each(function(){var e=$(this),n=0===e.find("div.row.field > *").length&&0===e.children("div.always").length||t&&0===e.children("div.has-content, div.always").length;e.removeClass("odd even hidden"),n&&e.addClass("hidden")}),e.find(".block:not(.hidden)").each(function(e){$(this).addClass(e%2?"even":"odd")})}function g(e,t){var n,a=_.uniqueId("contacts-"+e.field+"-");this.append($('<label class="control-label col-xs-12">').attr("for",a).append($.txt(e.label),n=new d.InputView({id:a,name:e.field,model:t,maxlength:u.maxlength[e.field]||64}).render().$el,new d.ErrorView({selector:".row"}).render().$el)),_.indexOf(["title","first_name","last_name"],e.field)>=0&&n.on("keyup",function(){if(t.set(e.field,$(this).val(),{silent:!0}),!t.changed.display_name){var n=t.toJSON();delete n.display_name,t.set("display_name",i.getFullName(n))}})}function b(e,t){var n,a=_.uniqueId("contacts-"+e.field+"-");this.append($('<fieldset class="col-lg-12 form-group birthdate">').append(n=$('<legend class="simple">').attr("id",a).text(e.label),new d.DateSelectView({name:e.field,model:t,label:n}).render().$el))}function v(e,t,n){t=e.get("id")||t;var i=e.get("folder_id"),s=a.uploadInProgress(_.ecid({folder:i,id:t}));return n.length>0&&require(["io.ox/core/notifications"],function(e){_(n).each(function(t){e.yell("error",t.error)})}),a.get({id:t,folder:i},!s).then(function(e){return s?$.when(a.caches.get.add(e),a.caches.all.grepRemove(i+a.DELIM),a.caches.list.remove({id:t,folder:i}),a.clearFetchCache()).done(function(){a.removeFromUploadList(_.ecid(e)),a.trigger("refresh.list")}):$.when()})}var x="io.ox/core/user"===h;x&&(delete u.sections.attachments,delete u.i18n.attachments,u.sections.personal=_.without(u.sections.personal,"private_flag"));var w=t.point(h+"/edit"),y=w.createView({tagName:"div",className:"edit-contact compact"+(x?"":" container"),render:function(){return this.point.invoke.apply(this.point,["draw",this.$el].concat(this.extensionOptions?this.extensionOptions():[this.baton])),this},init:function(e){x||(e&&e.model.get("folder_id")?c.get(e.model.get("folder_id")).done(function(e){p.is("public",e)?o.point(h+"/edit/personal").disable("private_flag"):o.point(h+"/edit/personal").enable("private_flag")}):o.point(h+"/edit/personal").enable("private_flag"))}});w.basicExtend({id:"header",index:10,draw:function(e){if(e.parentView.toggle=f,e.app){var t=$('<div class="header">');o.point(h+"/edit/buttons").invoke("draw",t,e),"top"===(_.device("!desktop")?"top":m.get("features/windowHeaderPosition","bottom"))?e.app.getWindow().nodes.header.empty():e.app.getWindow().nodes.footer.empty(),e.app.getWindow().nodes.header.empty(),e.app.getWindow().setHeader(t)}}}),o.point(h+"/edit/buttons").extend({index:100,id:"save",draw:function(e){this.append($('<button type="button" class="btn btn-primary save" data-action="save">').text(r("Save")).on("click",function(){n.invoke(h+"/actions/edit/save",e)}))}}),o.point(h+"/edit/buttons").extend({index:200,id:"discard",draw:function(e){this.append($('<button type="button" class="btn btn-default discard" data-action="discard">').text(r("Discard")).on("click",function(){e.$discardButton=$(this),n.invoke(h+"/actions/edit/discard",e)}))}}),o.point(h+"/edit/buttons").extend({index:100,id:"metrics",draw:function(){var e=this;require(["io.ox/metrics/main"],function(t){t.isEnabled()&&e.on("mousedown","[data-action]",function(e){var n=$(e.target);t.trackEvent({app:"contacts",target:"edit/contact/toolbar",type:"click",action:n.attr("data-action")||n.attr("data-name"),detail:n.attr("data-value")})})})}}),w.basicExtend({id:"autoExpand",index:1e12,draw:function(e){e.parentView.on("restore",function(){_.chain(e.model.changed).keys().without("id","folder","display_name").difference(u.alwaysVisible).value().length>0&&f.call(this.$el)})}});var k=d.AbstractView.extend({tagName:"h1",className:"name",setup:function(){this.listenTo(this.model,"change:display_name",this.render)},render:function(){var e=this.model.toJSON();delete e.display_name,this.$el.attr("id","dialog-title");var t=i.getFullName(e);return this.$el.toggle(!!t).text(t),x&&!s.has("gab")&&this.$el.css("margin-top","0px"),this}}),V=d.AbstractView.extend({tagName:"h2",className:"job",setup:function(){this.listenTo(this.model,"change:position change:department change:company",this.render)},render:function(){var e=i.getJob(this.model.toJSON());return this.$el.toggle(!!e).text(e),this}});w.basicExtend({id:"summary",index:150,draw:function(e){this.append(new k({model:e.model}).render().$el,new V({model:e.model}).render().$el,$('<div class="clearfix">'))}}),w.basicExtend({id:"final",index:1e12,draw:function(e){var t=this.find(".field").not('.rare,[data-field="attachments_list"]').not(".has-content");this.find('[data-id="userfields"] > div').wrapAll($('<div class="row">')),0===t.length&&e.parentView.toggle()}}),w.basicExtend({id:"final_metrics",index:0xe8d4a51001,draw:function(e){require(["io.ox/metrics/main"],function(t){t.isEnabled()&&e.$.form.find(".file-input").on("change",function(){t.trackEvent({app:"contacts",target:"edit/contacts",type:"click",action:"add-attachment"})})})}}),o.point("io.ox/contacts/edit/dnd/actions").extend({id:"attachment",index:100,label:r('Drop here to upload a <b class="dndignore">new attachment</b>'),multiple:function(e,t){var n=t.view.$el.find(".attachment-list").data("view");_(e).each(function(e){n.addFile(e)})}});var C=n.Action;new C(h+"/actions/edit/save",{action:function(e){var t=e.parentView.$el.find(".attachment-list").data("view");t&&t.isDirty()&&t.model.set("tempAttachmentIndicator",!0),e.parentView.trigger("save:start"),e.model.save().then(function(t){e.parentView.trigger("save:success",t)},function(t){e.parentView.trigger("save:fail",t)})}}),new C(h+"/actions/edit/discard",{action:function(e){e.$discardButton.trigger("controller:quit")}}),new C(h+"/actions/edit/reset-image",{action:function(e){e.model.set("image1","",{validate:!0});var t=a.getFallbackImage();e.parentView.$el.find(".picture-uploader").css("background-image","url("+t+")")}});var E=400,N={birthday:b,anniversary:b,note:function(e,t){var n=_.uniqueId("contacts-"+e.field+"-");this.append($("<label>").attr("for",n).addClass("control-label col-xs-12").text(u.i18n.comment),new d.TextView({id:n,name:e.field,model:t,maxlength:u.maxlength[e.field]||64}).render().$el)},private_flag:function(e,t){var n=_.uniqueId("contacts-"+e.field+"-");this.append($('<div class="col-lg-12 checkbox">').append($("<label>").attr("for",n).append(new d.CheckboxView({id:n,name:e.field,model:t}).render().$el,$.txt(" "),$.txt(e.label))))},attachments_list:function(e,t,n){this.append(n.$.form=$("<form>").append(new l.ListView({model:t,module:7,changeCallback:v}).render().$el,new l.UploadView({model:t}).render().$el.addClass("col-xs-12")))}};return _(u.sections).each(function(t,n){o.point(h+"/edit").extend({id:n,index:E+=100,draw:function(e){var t=_.uniqueId("group-"),a="comment"===n?$('<fieldset class="block" role="presentation">').attr({"data-id":n}):$('<fieldset class="block" role="group">').attr({"data-id":n,"aria-labelledby":t}).append($('<legend class="group">').append($("<h2>").attr("id",t).text(u.i18n[n])));"attachments"===n?(a.addClass("col-lg-12"),this.append($('<div class="clearfix">'))):"userfields"===n?a.addClass("col-lg-12"):a.addClass("col-sm-6"),o.point(h+"/edit/"+n).invoke("draw",a,e),this.append(a),0===a.children("div.has-content, div.always").length?a.addClass("hidden"):this.find("fieldset.block").length%2?a.addClass("odd"):(a.addClass("even"),this.append($('<div class="clearfix">')))}}),_(t).each(function(t,a){o.point(h+"/edit/"+n).extend({id:t,index:100+100*a,draw:function(i){var s,o=i.model.get(t),d=_(u.alwaysVisible).indexOf(t)>-1,l=_(u.rare).indexOf(t)>-1,r="anniversary"===t?_.isNumber(o):!!o,c={index:a,field:t,label:e.fields[t],value:o};s=$("<div>").attr("data-field",t).addClass("row field"+(d?" always":"")+(r?" has-content":"")+(l?" rare":"")),(N[t]||g).call(s,c,i.model,i),6===i.model.get("folder_id")&&"email1"===t&&s.find("input").prop("disabled",!0),"userfields"===n?this.append($('<div class="col-sm-6">').append(s)):this.append(s)}})})}),y}var u={sections:{personal:["title","first_name","last_name","second_name","suffix","nickname","birthday","marital_status","number_of_children","spouse_name","anniversary","url"],job:["profession","position","department","company","room_number","employee_type","number_of_employees","sales_volume","tax_id","commercial_register","branches","business_category","info","manager_name","assistant_name"],messaging:["email1","email2","email3","instant_messenger1","instant_messenger2"],phone:["cellular_telephone1","cellular_telephone2","telephone_business1","telephone_business2","telephone_home1","telephone_home2","telephone_company","telephone_other","fax_business","fax_home","fax_other","telephone_car","telephone_isdn","telephone_pager","telephone_primary","telephone_radio","telephone_telex","telephone_ttytdd","telephone_ip","telephone_assistant","telephone_callback"],home_address:["street_home","postal_code_home","city_home","state_home","country_home"],business_address:["street_business","postal_code_business","city_business","state_business","country_business"],other_address:["street_other","postal_code_other","city_other","state_other","country_other"],comment:["note"],userfields:["userfield01","userfield02","userfield03","userfield04","userfield05","userfield06","userfield07","userfield08","userfield09","userfield10","userfield11","userfield12","userfield13","userfield14","userfield15","userfield16","userfield17","userfield18","userfield19","userfield20"],attachments:["attachments_list"],advanced:["toggle"]},rare:["nickname","marital_status","number_of_children","spouse_name","anniversary","telephone_company","fax_other","telephone_car","telephone_isdn","telephone_pager","telephone_primary","telephone_radio","telephone_telex","telephone_ttytdd","telephone_assistant","telephone_callback","telephone_ip","number_of_employees","sales_volume","tax_id","commercial_register","branches","business_category","info","manager_name","assistant_name","employee_type"],alwaysVisible:["title","first_name","last_name","birthday","position","department","company","email1","email2","instant_messenger1","cellular_telephone1","telephone_home1","street_home","postal_code_home","city_home","state_home","country_home","note","attachments_list"],input_type:{email1:"email",email2:"email",email3:"email"},i18n:{personal:r("Personal information"),messaging:r("Messaging"),phone:r("Phone & fax numbers"),home_address:r("Home address"),business_address:r("Business address"),other_address:r("Other address"),job:r("Job description"),comment:r("Comment"),advanced:r("Advanced"),userfields:r("User fields"),attachments:r("Attachments")},maxlength:{128:"first_name last_name position department tax_id",256:"url profession street_home street_other street_business",512:"email1 email2 email3 company",5680:"note"}};return _.device("smartphone")&&u.alwaysVisible.push("toggle"),_(u.maxlength).keys().forEach(function(e){u.maxlength[e].split(" ").forEach(function(t){u.maxlength[t]=e})}),m.get("features/PIMAttachments",s.has("filestore"))||(delete u.sections.attachments,delete u.i18n.attachments),s.has("read_create_shared_folders")&&u.sections.personal.push("private_flag"),_.each(["home","business","other"],function(e){var t=u.sections[e+"_address"];u.sections[e+"_address"]=_.compact(_.aprintf(r("%1$s\n%2$s %3$s\n%4$s\n%5$s"),function(e){return t[e]},$.noop))}),{ContactEditView:h("io.ox/contacts"),protectedMethods:{createContactEdit:h}}});