define("io.ox/contacts/view-detail",["io.ox/core/extensions","io.ox/contacts/util","io.ox/contacts/api","io.ox/contacts/actions","io.ox/contacts/model","io.ox/participants/views","io.ox/participants/model","io.ox/core/folder/breadcrumb","io.ox/core/util","io.ox/core/capabilities","gettext!io.ox/contacts","settings!io.ox/contacts","io.ox/core/tk/attachments","io.ox/core/http","io.ox/core/locale/postal-address","io.ox/backbone/views/toolbar","io.ox/backbone/views/action-dropdown","static/3rd.party/purify.min.js","less!io.ox/contacts/style"],function(t,e,a,n,i,o,r,d,s,l,c,p,u,h,f,m,x,b){"use strict";function v(){return!ox.ui.apps.get("io.ox/contacts")}function g(){var t=_(arguments).compact(),e=$('<section class="block">'),a=$('<dl class="dl-horizontal">');return t.length<1?$():(_.each(t,function(t){a.append(t)}),e.append(a))}function w(t,e){var a=e();return a?function(){$(this).append($("<dt>").text(i.fields[t]),$("<dd>").append(_.isString(a)?$.txt(a):a))}:null}function y(t,e,a){var n=$.trim(t[e]);return n?function(){$(this).append($("<dt>").text(a||i.fields[e]),$("<dd>").text(n))}:null}function k(t){l.has("webmail")&&(t.preventDefault(),ox.registry.call("mail-compose","open",{to:[[t.data.display_name,t.data.email]]}))}function C(t,e,a){return t?function(){$(this).append($("<dt>").text(i.fields[a]),$("<dd>").append($("<a>").attr("href","mailto:"+t).text(t).on("click",{email:t,display_name:e},k)))}:null}function S(t,e,a){var n=$.trim(t[e]);return n?function(){$(this).append($("<dt>").text(a||i.fields[e]),$("<dd>").append($("<a>").attr({href:_.device("smartphone")?"tel:"+n:"callto:"+n,"aria-label":a||i.fields[e]}).text(n)))}:null}function A(t){var e=$.trim(t.note);return e?function(){$(this).append($("<dt>").text(i.fields.note),_.nltobr(e,$('<dd class="note">')))}:null}function D(t,e){if(!(t=$.trim(t)))return null;var a={};return/^skype:/.test(t)?(t=t.split("skype:")[1],function(){$(this).append($("<dt>").text("Skype"),$("<dd>").append($("<a>",{href:"callto:"+t+"?call"}).text(t)))}):/^x-apple:/.test(t)?(t=t.split("x-apple:")[1],function(){$(this).append($("<dt>").text("iMessage"),$("<dd>").append($("<a>",{href:"imessage://"+t+"@me.com"}).text(t)))}):(a[e]=t,y(a,e,c("Messenger")))}function N(t,e){var a=f.format(t,e);if(!a)return null;var n={google:{label:c("Google Maps"),url:"https://www.google.com/maps?q="},osm:{label:c("Open Street Map"),url:"https://www.openstreetmap.org/search?query="},apple:{label:c("Apple Maps"),url:"https://maps.apple.com/?q="}},i={home:c("Home address"),business:c("Business address"),other:c("Other address")};return function(){var t=$("<address>").attr("data-property",e).text($.trim(a)),o=p.get("mapService","google"),r=$("<dd>").append(t);if($(this).append($("<dt>").text(i[e]),r),"apple"!==o||_.device("ios || macos")||(o="none"),"none"===o)return $(this);var d=encodeURIComponent(a.replace(/\n*/,"\n").trim().replace(/\n/g,", "));r.append($('<a class="maps-service" target="_blank" rel="noopener">').attr("href",n[o].url+d).append($('<i class="fa fa-external-link" aria-hidden="true">'),$.txt(" "+c("Open in %1$s",n[o].label))))}}function R(t,e){function a(t,e){return new x({point:"io.ox/core/tk/attachment/links",data:t,title:t.filename||e}).$el}return function(){$(this).append($("<dt>").text(t),$("<dd>").append(function(){var t=_.map(e,a);return e.length<2?t:t.concat(a(e,c("All attachments")))}))}}function F(t,e){var a=t.data.baton;a.data=e,$(this).replaceWith(t.data.view.draw(a))}var T=100;t.point("io.ox/contacts/detail").extend({index:T+=100,id:"inline-actions",draw:function(t){a.looksLikeResource(t.data)||v()||this.append(new m({point:"io.ox/contacts/links/inline",inline:!0}).setSelection(t.array(),{data:t.array()}).$el)}}),t.point("io.ox/contacts/detail").extend({index:T+=100,id:"contact-header",draw:function(e){if(!e.data.mark_as_distributionlist){var a=$("<dt>");t.point("io.ox/contacts/detail/photo").invoke("draw",a,e);var n=$('<dd class="contact-summary">');t.point("io.ox/contacts/detail/summary").invoke("draw",n,e),this.append($('<dl class="dl-horizontal contact-header">').append(a,n))}}}),t.point("io.ox/contacts/detail").extend({index:T+=100,id:"list-header",draw:function(t){if(t.data.mark_as_distributionlist){var a=t.data.number_of_distribution_list,n=0===a?c("Distribution list"):c.format(c.ngettext("Distribution list with 1 entry","Distribution list with %1$d entries",a),a);this.addClass("distribution-list").append($('<div class="contact-header">').append($('<h1 class="fullname">').text(e.getFullName(t.data)),$("<h2>").text(n)))}}}),t.point("io.ox/contacts/detail/photo").extend({draw:function(t){this.append(a.getContactPhoto(t.data,{size:120}))}});var E=p.get("features/countryFlag",!1),M={US:"ðŸ‡ºðŸ‡¸",GB:"ðŸ‡¬ðŸ‡§",DE:"ðŸ‡©ðŸ‡ª",FR:"ðŸ‡«ðŸ‡·",ES:"ðŸ‡ªðŸ‡¸",IT:"ðŸ‡®ðŸ‡¹",NL:"ðŸ‡³ðŸ‡±",FI:"ðŸ‡«ðŸ‡®",JP:"ðŸ‡¯ðŸ‡µ",AT:"ðŸ‡¦ðŸ‡¹",CH:"ðŸ‡¨ðŸ‡­",BE:"ðŸ‡§ðŸ‡ª"};t.point("io.ox/contacts/detail/summary").extend({index:100,id:"fullname",draw:function(t){var a={html:e.getFullNameWithFurigana(t.data),tagName:'h1 class="fullname"'},n=s.renderPersonalName(a,t.data);n.text()&&this.append(n)}},{index:110,id:"flag",draw:function(t){if(E&&!_.device("smartphone")){var e=t.data.country_home||t.data.country_business;if(e){var a=M[f.getCountryCode(e)];a&&this.find("h1.fullname").append($.txt(" "+a))}}}},{index:120,id:"private_flag",draw:function(t){!_.device("smartphone")&&t.data.private_flag&&this.find("h1.fullname").append($('<div class="sr-only">').attr("aria-label",c("Private contact")),$('<i class="fa fa-lock private-flag" aria-hidden="true">').attr("title",c("Private")))}},{index:200,id:"business",draw:function(t){var a=e.getSummaryBusiness(t.data);a&&this.append($('<h2 class="business hidden-xs">').text(a))}},{index:300,id:"location",draw:function(t){var a=e.getSummaryLocation(t.data);a&&this.append($('<h2 class="location hidden-xs">').text(a))}}),t.point("io.ox/contacts/detail").extend({index:T+=100,id:"contact-content",draw:function(e){var a=$('<article class="clearfix">').appendTo(this),n=e.data.mark_as_distributionlist?"io.ox/contacts/detail/list":"io.ox/contacts/detail/content";t.point(n).invoke("draw",a,e)}}),t.point("io.ox/contacts/detail/member").extend({draw:function(t){this.append(new o.ParticipantEntryView({tagName:"li",model:new r.Participant(t),halo:!0,isMail:!0,strict:!0}).render().$el)}}),t.point("io.ox/contacts/detail/list").extend({draw:function(e){var a,n=_.copy(e.data.distribution_list||[],!0),i=n.length,o={};this.append(0===i?$('<div class="list-count">').text(c("This list has no members yet")):$(),a=$('<ul class="member-list list-unstyled">')),i&&(h.pause(),_(n).chain().filter(function(t){return!o[t.display_name+"_"+t.mail]&&(o[t.display_name+"_"+t.mail]=!0)}).each(function(e){t.point("io.ox/contacts/detail/member").invoke("draw",a,e)},this),h.resume())}}),t.point("io.ox/contacts/detail/content").extend({id:"personal",index:200,draw:function(t){var a=t.data;this.append(g(y(a,"title"),y(a,"second_name"),y(a,"nickname"),y(a,"suffix"),w("birthday",function(){if(_.isNumber(t.data.birthday))return e.getBirthday(t.data.birthday,!0)}),w("url",function(){var e=$.trim(t.data.url);if(e){/^https?:\/\//i.test(e)||(e="http://"+e);var a=$('<a target="_blank" rel="noopener">').attr("href",encodeURI(decodeURI(e))).text(e);return b.sanitize(a.get(0),{ALLOW_TAGS:["a"],ADD_ATTR:["target"],SAFE_FOR_JQUERY:!0,RETURN_DOM_FRAGMENT:!0})}}),y(a,"marital_status"),y(a,"number_of_children"),y(a,"spouse_name"),w("anniversary",function(){if(_.isNumber(t.data.anniversary))return e.getBirthday(t.data.anniversary)})).attr("data-block","personal"))}}).extend({id:"job",index:300,draw:function(t){var e=t.data;this.append(g(y(e,"company"),y(e,"department"),y(e,"position"),y(e,"profession"),y(e,"room_number"),y(e,"manager_name"),y(e,"assistant_name"),y(e,"employee_type"),y(e,"number_of_employees"),y(e,"sales_volume"),y(e,"tax_id"),y(e,"commercial_register"),y(e,"branches"),y(e,"business_category"),y(e,"info")).attr("data-block","job"))}}).extend({id:"communication",index:400,draw:function(t){var a=t.data,n=e.getFullName(a),i=_([a.email1,a.email2,a.email3]).chain().map(function(t){return $.trim(t).toLowerCase()}).value();this.append(g(C(i[0],n,"email1"),C(i[1],n,"email2"),C(i[2],n,"email3"),D(a.instant_messenger1,"instant_messenger1"),D(a.instant_messenger2,"instant_messenger2"),S(a,"cellular_telephone1"),S(a,"cellular_telephone2"),S(a,"telephone_business1"),S(a,"telephone_business2"),S(a,"telephone_home1"),S(a,"telephone_home2"),S(a,"telephone_other"),y(a,"fax_business"),y(a,"fax_home"),y(a,"fax_other"),S(a,"telephone_company"),S(a,"telephone_car"),S(a,"telephone_isdn"),S(a,"telephone_pager"),S(a,"telephone_primary"),S(a,"telephone_radio"),S(a,"telephone_telex"),S(a,"telephone_ttytdd"),S(a,"telephone_ip"),S(a,"telephone_assistant"),S(a,"telephone_callback")).attr("data-block","communication"))}}).extend({id:"home-address",index:600,draw:function(t){this.append(g(N(t.data,"home")).attr("data-block","home-address"))}}).extend({id:"business-address",index:700,draw:function(t){this.append(g(N(t.data,"business")).attr("data-block","business-address"))}}).extend({id:"other-address",index:800,draw:function(t){this.append(g(N(t.data,"other")).attr("data-block","other-address"))}}).extend({id:"misc",index:900,draw:function(t){var e=t.data;this.append(g(A(e),y(e,"userfield01"),y(e,"userfield02"),y(e,"userfield03"),y(e,"userfield04"),y(e,"userfield05"),y(e,"userfield06"),y(e,"userfield07"),y(e,"userfield08"),y(e,"userfield09"),y(e,"userfield10"),y(e,"userfield11"),y(e,"userfield12"),y(e,"userfield13"),y(e,"userfield14"),y(e,"userfield15"),y(e,"userfield16"),y(e,"userfield17"),y(e,"userfield18"),y(e,"userfield19"),y(e,"userfield20")).attr("data-block","misc"))}}).extend({id:"attachments",index:1e3,draw:function(t){if(t.data.number_of_attachments&&!t.data.mark_as_distributionlist){var e=$('<section class="block hidden">');if(!!a.pendingAttachments[_.ecid(t.data)]){var n=new u.progressView({cid:_.ecid(t.data)});return this.append(n.render().$el).show()}require(["io.ox/core/api/attachment"],function(a){function n(){a.getAll({folder_id:t.data.folder_id,id:t.data.id,module:7}).then(i,o)}function i(t){if(!t.length)return e.remove();e.replaceWith(g(R(c("Attachments"),t)).addClass("contains-dropdown").attr("data-block","attachments"))}function o(){e.show().append($.fail(c("Could not load attachments for this contact."),n))}n()}),this.append(e)}}});var B=/(^|\s+)(\+?[\d\x20/()]{4,})($|\s+)/g,P=/[^+0-9]/g;return t.point("io.ox/contacts/detail/content").extend({index:1e12,id:"description",draw:function(t){var e=_.escape($.trim(t.data.description||""));""!==e&&(e=e.replace(B,function(t){var e=t.replace(P,"");return 0===e.length?t:'<a href="callto:'+e+'">'+t+"</a>"}),e=(e=s.urlify(e)).replace(/\n/g,"<br>"),this.append($('<div class="description">').append($("<div>").html(e),t.data.callbacks&&"extendDescription"in t.data.callbacks?$('<a href="#">').text(c("Copy to description")).on("click",{description:$("<div>").html(e.replace(/[ \t]+/g," ").replace(/<br>/g,"\n")).text()},t.data.callbacks.extendDescription):[])))}}),t.point("io.ox/contacts/detail").extend({index:1e12,id:"breadcrumb",draw:function(t){var e=t.data.folder_id;e&&(v()||("6"!==String(e)||l.has("gab"))&&this.append($('<div class="clearfix">'),new d({folder:e,app:t.app,display:"block",label:c("Saved in:"),disable:["2","3"]}).render().$el))}}),{draw:function(e){if(!e)return $("<div>");try{e=t.Baton.ensure(e);var n=$.createViewContainer(e.data,a).on("redraw",{view:this,data:e.data,baton:e},F).addClass("contact-detail view").attr({role:"region","aria-label":c("Contact Details")});return t.point("io.ox/contacts/detail").invoke("draw",n,e),n}catch(t){console.error("io.ox/contacts/view-detail:draw()",t)}}}});