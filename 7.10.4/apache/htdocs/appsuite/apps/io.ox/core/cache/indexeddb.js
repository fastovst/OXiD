define.async("io.ox/core/cache/indexeddb",["io.ox/core/extensions"],function(e){"use strict";function n(e){function n(e,n){return f.then(function(r){try{var t=r.transaction("cache",n?"readwrite":"readonly");return e(t.objectStore("cache"))}catch(e){return console.error("IndexedDB.operation()",e.message,e),$.Deferred().reject(e)}})}function o(e){return n(e,!1)}function a(e){return n(e,!0)}var c,i,u={},l={},f=$.Deferred(),h=window.indexedDB.open("appsuite.cache",d);h.onupgradeneeded=function(e){(i=e.target.result).createObjectStore("cache",{keyPath:"key"})},r(h).then(f.resolve,f.reject),c={hash:{},flush:_.debounce(function(){f.then(function(n){var r=n.transaction("cache","readwrite").objectStore("cache");_(c.hash).each(function(n,t){t=String(e+"//"+t),r.put({key:t,data:n})}),c.hash={}})},500),clear:function(){this.hash={}},add:function(e,n){this.hash[e]=n,this.flush()},remove:function(e){delete this.hash[e]}},_.extend(this,{clear:function(){return _(u).each(function(e,n){l[n]=!0}),u={},c.clear(),a(function(e){return r(e.clear(),"clear")})},get:function(n){if(_.isUndefined(n)||_.isNull(n))return $.Deferred().resolve(null);if((n=String(n))in l)return $.Deferred().resolve(null);if(n in u)try{return $.Deferred().resolve(JSON.parse(u[n]))}catch(r){return console.error("Failed to deserialize cached data",n,"cache",e,"data",{data:u[n]},r.message,r),$.Deferred().resolve(null)}return o(function(t){return n=String(e+"//"+n),r(t.get(n)).then(function(r){return _.isUndefined(r)||_.isNull(r)?r:(n=n.substr(String(e+"//").length),r.key=n,r)}).then(function(r){if(_.isUndefined(r)||_.isNull(r))return $.Deferred().resolve(null);try{var t=JSON.parse(r.data);return u[n]=r.data,$.Deferred().resolve(t)}catch(t){return console.error("Failed to deserialize cached data",n,"cache",e,"data",{data:r.data},t.message,t),$.Deferred().resolve(null)}})})},set:function(n,r){n=String(n);try{r=JSON.stringify(r),u[n]=r,delete l[n]}catch(t){console.error("Could not serialize",e,n,r)}return r.length<=s&&c.add(n,r),$.Deferred().resolve(n)},remove:function(n){return n=String(n),u[n]&&(delete u[n],l[n]=!0),c.remove(n),a(function(t){return n=String(e+"//"+n),r(t.delete(n),"delete")})},keys:function(){return o(function(e){var n=$.Deferred(),r=[];return t(e.openCursor()).step(function(e){r.push(e.key)}).end(function(){n.resolve(r)}).fail(n.reject),n}).then(function(n){return n.filter(function(n){return 0===n.indexOf(String(e+"//"))}).map(function(n){return n.substr(String(e+"//").length)})}).then(function(e){return _(e).chain().union(_(u).keys()).uniq().value()})},close:function(){i&&i.close()}})}function r(e,n){var r=$.Deferred();return e.onerror=function(t){!0===ox.debug&&console.warn("IndexedDB: error request",e,n,t),r.reject(t)},e.onblocked=function(t){!0===ox.debug&&console.warn("IndexedDB: blocked request",e,n,t),r.reject(t)},"clear"!==n&&"delete"!==n||!e.transaction?e.onsuccess=function(e){r.resolve(e.target.result)}:e.transaction.oncomplete=function(e){r.resolve(e.target.result)},r}function t(e){var n={step:[],end:[],fail:[]},r=!1,t=!1;e.onerror=function(e){r||t||_(n.fail).each(function(n){n(e)}),r=!0},e.onsuccess=function(e){r||t||(e.target.result?(_(n.step).each(function(n){n(e.target.result)}),e.target.result.continue()):(_(n.end).each(function(e){e()}),t=!0))};var o={step:function(e){return n.step.push(e),o},end:function(e){return n.end.push(e),o},fail:function(e){return n.fail.push(e),o}};return o}function o(){return r(c.transaction("meta","readwrite").objectStore("meta").put({id:"default",version:ox.version}))}function a(){var e=$.Deferred(),n=_(l).chain().values().map(function(e){return e.clear()});return $.when.apply($,n).then(function(){l={},r(window.indexedDB.deleteDatabase("cache"),"deleteDatabase").then(e.resolve,e.reject)}),e}var c,i,u,d=1,s=1048576,l={},f=$.Deferred(),h=!1;if(h=!(void 0!==window.IDBVersionChangeEvent&&Modernizr.indexeddb&&window.indexedDB&&!window.cordova))return $.when();u={id:"indexeddb",index:100,getInstance:function(e){return l[e]?l[e]:l[e]=new n(e)},getStorageLayerName:function(){return"cache/indexeddb"},isUsable:function(){return!h},gc:function(){},clear:function(){if(!h)return a()}};try{(i=window.indexedDB.open("appsuite.cache.metadata",d)).onupgradeneeded=function(e){e.target.result.createObjectStore("meta",{keyPath:"id"})},r(i).then(function(e){if(!(c=e))return h=!0,void f.resolve(u);c.onerror=function(e){console.error("IndexedDB error: ",e.target.errorCode,e)},r(c.transaction("meta").objectStore("meta").get("default")).done(function(e){var n=null;e?ox.online&&(e.version!==ox.version||e.cleanUp)&&"true"!==_.url.hash("keep-data")?(e.cleanUp=!0,!0===ox.debug&&console.warn("IndexedDB: Clearing persistent caches due to UI update"),n=a().done(function(){e.cleanUp=!1,e.version=ox.version,r(c.transaction("meta","readwrite").objectStore("meta").put(e))})):n=$.when():n=o(),n.then(function(){f.resolve(u)},function(){h=!0,console.warn("Failed to use IndexedDB"),f.resolve(u)})})},function(){h=!0,console.warn("Failed to use IndexedDB"),f.resolve(u)})}catch(e){h=!0,console.warn("Failed to use IndexedDB",e.message),f.resolve(u)}return f.done(function(n){e.point("io.ox/core/cache/storage").extend(n)})});