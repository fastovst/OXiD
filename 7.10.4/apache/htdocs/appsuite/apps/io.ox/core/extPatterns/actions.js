define("io.ox/core/extPatterns/actions",["io.ox/core/extensions","io.ox/core/upsell","io.ox/core/collection","io.ox/core/capabilities","io.ox/backbone/views/actions/util"],function(e,n,t,i,o){"use strict";var r=function(e){return function(n){return n.collection.has.apply(n.collection,e.split(/ /))}},a=function(e){return e.collection.has("one")},c=function(e){return!_(this).any(function(n){return _.isEqual(e,n)})},s=function(t,o,r){(r=e.Baton.ensure(r)).tracker=[].concat(r.data);var a,s,l=e.point(t),u=l.pluck("capabilities"),p=0===r.tracker.length,f=l.list(),d=0,v=f.length;if(!u.length||n.any(u)){for(;d<v&&!r.isPropagationStopped();d++)if(("default"!==(a=f[d]).id||!r.isDefaultPrevented())&&!r.isDisabled(l.id,a.id)&&(!a.capabilities||i.has(a.capabilities))){if(!p&&0===r.tracker.length)break;if(_.isFunction(a.filter)?(s=_(r.tracker).filter(a.filter),r.tracker=_(r.tracker).filter(c,s)):s=r.tracker.slice(),s.length||p)try{_.isFunction(a.action)&&a.action.call(o,r),_.isFunction(a.multiple)&&a.multiple.call(o,s,r)}catch(e){console.error('point("'+t+'") > invoke()',e.message,{baton:r,context:o,extension:a,exception:e})}}}else n.enabled(u)&&n.trigger({type:"inline-action",id:t,missing:n.missing(u)})},l=function(n,t,i){var r=!1,a=function(){r=!0},c=e.point(n).map(function(c){var s,l,u,p,f={};if(r)return $.when(!1);try{c.matches||c.collection||c.device||c.folder||"toogle"in c?(p=e.Baton({app:i.app,collection:t,data:[].concat(i.data),folder_id:i.app&&i.app.folder.get(),stopPropagation:a}),o.checkActionAvailability(c)&&o.checkActionEnabled(p,c)?(l=!0,_.isFunction(c.matches)&&(u=c.matches(p))):l=!1):_.isFunction(c.requires)&&(f={baton:i,collection:t,context:i.data,extension:c,point:n,stopPropagation:a},s=c.requires(f))}catch(e){f.exception=e,console.error('point("'+n+'") > "'+c.id+'" > processActions() > requires()',e.message,e.stack,f)}return s?$.when(s):!1===l?$.when(!1):u?$.when(u):$.when(!0)}).value();return $.when.apply($,c)},u=function(e){s(e.data.ref,this,e.data.selection)};return{Action:function(n,t){ox.debug&&console.warn("Action is DEPRECATED with 7.10.2 (io.ox/core/extPatterns/actions.js)",t);var i=_.extend({id:"default",index:100,requires:a},t);_.isString(i.requires)&&(i.requires=r(i.requires)),e.point(n).extend(i)},check:function(n,i){var o=new t(_.isArray(i)?i:[]);return o.getProperties().pipe(function(){return l(n,o,e.Baton.ensure(i)).pipe(function(){return _(arguments).any(function(e){return!0===e})?$.Deferred().resolve(!0):$.Deferred().reject(!1)})})},invoke:s,applyCollection:function(t,i,o,r){if(!t)return $.when();o=e.Baton.ensure(o);var a=new $.Deferred;return i.getProperties().pipe(function(){var c=e.point(t).map(function(t){var a=$.Deferred();if(!t.ref)return a.resolve({link:t,state:!0});if(t.isEnabled&&!t.isEnabled.apply(t,r))return a.resolve({link:t,state:!1});var c=e.point(t.ref).pluck("capabilities");return n.visible(c)?l(t.ref,i,o).pipe(function(){var e=_(arguments).any(function(e){return!0===e});return{link:t,state:e}}):a.resolve({link:t,state:!1})});$.when.apply($,c.value()).done(function(){a.resolve(_(arguments).toArray()),c=null})},function(){a.resolve([])}),a},updateCustomControls:function(e,n,i){var o=$.Deferred(),r=new t(n),a=e.find("[data-action]");return i=$.extend({cssDisable:!1,eventType:"click"},i),r.getProperties().done(function(){$.when.apply($,_(a).map(function(e){var t=(e=$(e)).attr("data-action");return l(t,r,n).done(function(o){!1===o?(e.prop("disabled",!0).off(i.eventType+".action"),i.cssDisable&&e.addClass("disabled")):e.prop("disabled",!1).removeClass("disabled").off(i.eventType+".action").on(i.eventType+".action",{ref:t,selection:n},u)})})).done(o.resolve)}),o.done(function(){r=n=a=null})}}});