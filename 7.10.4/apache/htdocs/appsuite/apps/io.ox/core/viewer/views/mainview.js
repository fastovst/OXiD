define("io.ox/core/viewer/views/mainview",["io.ox/core/viewer/views/toolbarview","io.ox/core/viewer/views/displayerview","io.ox/core/viewer/views/sidebarview","io.ox/backbone/views/disposable","io.ox/core/tk/nodetouch","io.ox/core/viewer/util","io.ox/core/viewer/settings","io.ox/core/a11y","less!io.ox/core/viewer/style","io.ox/files/actions"],function(e,i,t,s,r,n,o,a){"use strict";return s.extend({className:"io-ox-viewer abs",events:{keydown:"onKeydown"},initialize:function(s){n.logPerformanceTimer("MainView:initialize"),_.extend(this,s),this.standalone||this.$el.parent().find(".simple-window").hide();var r=this.standalone?"viewer-light-theme":"viewer-dark-theme";this.setTheme(r),this.viewerEvents=_.extend({},Backbone.Events);var o={collection:this.collection,viewerEvents:this.viewerEvents,standalone:this.standalone,app:this.app,opt:this.opt,isViewer:!0,openedBy:this.openedBy,isSharing:this.isSharing};this.toolbarView=new e(o),this.displayerView=new i(o),this.sidebarView=new t(o),this.listenTo(this.viewerEvents,"viewer:close",this.viewerCloseHandler),this.listenTo(this.viewerEvents,"viewer:toggle:sidebar",this.onToggleSidebar),this.listenTo(this.viewerEvents,"viewer:sidebar:change:state",this.onSideBarToggled),this.standalone||this.listenTo(ox,"app:start app:resume",this.viewerCloseHandler),this.app&&this.app.on("resume",this.onAppResume),$(window).on("resize",this.refreshViewSizes.bind(this));var a=this.collection.getStartIndex(),l=this.collection.at(a);this.render(l),this.initMetrics()},render:function(e){var i=!this.isSharing&&o.getSidebarOpenState();{if(e)return this.$el.attr("tabindex",-1),n.setDeviceClass(this.$el),this.$el.append(this.sidebarView.render(e).el,this.toolbarView.render(e).el,this.displayerView.render(e).el),this.sidebarView.toggleSidebar(i),this;console.error("Core.Viewer.MainView.render(): no file to render")}},initMetrics:function(){var e=this;require(["io.ox/metrics/main"],function(i){i.isEnabled()&&e.$el.find(".viewer-toolbar").on("mousedown",".io-ox-action-link",function(e){i.trackEvent({app:"core",target:"viewer/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})})})},onKeydown:function(e){function i(e){_.defer(function(){$.contains(r.toolbarView.el,document.activeElement)||n(e)})}var t=this.$el,s=this.displayerView.swiper,r=this,n=_.throttle(function(e){s&&("right"===e?s.slideNext():s.slidePrev(),s.updateClickedSlide({target:null}))},200);switch(e.which){case 9:if(this.standalone)return;!function(e){var i=a.getTabbable(t).filter(":not(.swiper-button-control):not([tabindex=-1])"),s=i.length;if(0!==s){var r=i.index(document.activeElement)+(e.shiftKey?-1:1);e.preventDefault(),r>=s&&(r=0),i.eq(r).visibleFocus()}}(e);break;case 27:var o=$(e.target),l=o.parents(".dropdown-menu").length>0,h="dropdown"===o.attr("data-toggle")&&"true"===o.attr("aria-expanded");l||h||this.viewerCloseHandler();break;case 37:i("left");break;case 39:i("right");break;case 33:e.preventDefault(),this.viewerEvents.trigger("viewer:document:previous");break;case 34:e.preventDefault(),this.viewerEvents.trigger("viewer:document:next");break;case 114:e.altKey||e.shiftKey||e.metaKey===e.ctrlKey||(e.preventDefault(),this.onToggleSidebar())}},onToggleSidebar:function(){this.sidebarView.toggleSidebar()},onSideBarToggled:function(){this.refreshViewSizes()},refreshViewSizes:function(){if(!this.disposed&&this.$el.is(":visible")){var e=this.sidebarView.open?this.sidebarView.$el.outerWidth():0,i=this.displayerView.$el,t=this.displayerView.getActiveSlideNode(),s=this.displayerView.swiper;i.css({width:window.innerWidth-e}),t.find(".viewer-displayer-item").css({maxWidth:window.innerWidth-e}),s&&(s.update(),this.viewerEvents.trigger("viewer:resize"))}},onAppResume:function(){$(window).trigger("resize")},setTheme:function(e){this.$el.removeClass().addClass("io-ox-viewer abs "+e)},viewerCloseHandler:function(e){e&&e.options&&e.options.plugged||e&&"io.ox/help"===e.get("name")||(this.viewerEvents.trigger("viewer:beforeclose"),this.isSharing||o.setSidebarOpenState(this.sidebarView.open),this.$el.hide(),this.standalone?this.app.quit():(this.$el.parent().find(".simple-window").show(),this.remove()))},onDispose:function(){this.toolbarView&&this.toolbarView.remove(),this.displayerView&&this.displayerView.remove(),this.sidebarView&&this.sidebarView.remove(),this.collection=null,this.toolbarView=null,this.displayerView=null,this.sidebarView=null,$(window).off("resize",this.refreshViewSizes.bind(this)),this.app&&this.app.off("resume",this.onAppResume),!this.standalone&&this.app&&(this.app.quit(),this.app=null)}})});