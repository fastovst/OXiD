define("io.ox/core/viewer/views/toolbarview",["io.ox/backbone/mini-views/dropdown","io.ox/backbone/views/disposable","io.ox/backbone/views/toolbar","io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/files/api","io.ox/backbone/mini-views/helplink","io.ox/core/tk/doc-converter-utils","io.ox/core/viewer/util","io.ox/core/viewer/settings","io.ox/files/util","gettext!io.ox/core"],function(e,o,i,t,n,a,r,l,s,d,c,p){"use strict";function h(e,o){return!e.context.standalone&&(e.context.autoplayStarted===o&&(!!e.model.isImage()&&f(e.model)>=2))}function f(e){return e.collection.reduce(function(e,o){return o.isImage()?e+1:e},0)}var m="io.ox/core/viewer/actions/toolbar",u=m+"/dropdown",v=p("This document cannot be viewed at the moment because a new version is being uploaded. Please wait until the upload is completed."),g={filename:{prio:"hi",mobile:"hi",ref:m+"/rename",title:p("File name"),customize:function(){var e=o.extend({initialize:function(e){this.standalone=e.standalone,this.listenTo(this.model,"change",this.render),this.$el.addClass("viewer-toolbar-filename")},render:function(){return this.$el.empty().append(this.standalone?null:$('<i class="fa" aria-hidden="true">').addClass(s.getIconClass(this.model)),$('<span class="filename-label">').text(this.model.getDisplayName())),this}});return function(o){new e({el:this,model:o.model,standalone:o.standalone}).render(),this.parent().addClass("align-left"),o.model.isFile()&&n.checkAction("io.ox/files/actions/rename",o.data).then(function(){this.attr({"data-original-title":p("Rename File"),"data-placement":"bottom"}),this.tooltip()}.bind(this),function(){this.addClass("disabled")}.bind(this))}}()},editplaintext:{prio:"hi",mobile:"lo",title:p("Edit"),section:"edit",ref:"io.ox/files/actions/editor"},zoomout:{prio:"hi",mobile:"lo",icon:"fa fa-search-minus",title:p("Zoom out"),section:"zoom",ref:m+"/zoomout",customize:function(){this.addClass("viewer-toolbar-zoomout")}},zoomin:{prio:"hi",mobile:"lo",icon:"fa fa-search-plus",title:p("Zoom in"),section:"zoom",ref:m+"/zoomin",customize:function(){this.addClass("viewer-toolbar-zoomin")}},zoomfitwidth:{prio:"lo",mobile:"lo",title:p("Fit to screen width"),section:"zoom",ref:m+"/zoomfitwidth",customize:function(){this.addClass("viewer-toolbar-fitwidth")}},zoomfitheight:{prio:"lo",mobile:"lo",title:p("Fit to screen size"),section:"zoom",ref:m+"/zoomfitheight",customize:function(){this.addClass("viewer-toolbar-fitheight")}},autoplaystart:{prio:_.device("desktop")?"hi":"lo",mobile:"lo",icon:"fa fa-play",title:p("Slideshow"),tooltip:p("Run slideshow"),ref:m+"/autoplaystart",customize:function(){this.addClass("viewer-toolbar-autoplay-start")}},autoplaystop:{prio:_.device("desktop")?"hi":"lo",mobile:"lo",icon:"fa fa-stop",title:p("Stop slideshow"),ref:m+"/autoplaystop",customize:function(){this.addClass("viewer-toolbar-autoplay-stop")}}},w={togglesidebar:{prio:"hi",mobile:"hi",icon:"fa fa-info-circle",title:p("View details"),ref:m+"/togglesidebar",customize:function(){this.addClass("viewer-toolbar-togglesidebar")}},popoutstandalone:{prio:"hi",icon:"fa fa-external-link-square",title:p("Pop out standalone viewer"),ref:m+"/popoutstandalone",customize:function(){this.addClass("viewer-toolbar-popoutstandalone")}},help:{prio:"hi",icon:"fa fa-question-circle",title:p("Help"),ref:m+"/help",customize:function(){var e=new r({href:"ox.appsuite.user.sect.drive.gui.viewer.html"});this.replaceWith(e.render().$el)}},close:{prio:"hi",mobile:"hi",icon:"fa fa-times",title:p("Close"),tooltip:p("Close viewer"),ref:m+"/close"}},b={drive:{rename:{prio:"lo",mobile:"lo",title:p("Rename"),section:"edit",ref:"io.ox/files/actions/rename"},editdescription:{prio:"lo",mobile:"lo",title:p("Edit description"),section:"edit",ref:"io.ox/files/actions/edit-description"},download:{prio:"hi",mobile:_.device("ios && ios < 12")?"lo":"hi",icon:"fa fa-download",title:p("Download"),section:"export",ref:s.getRefByModelSource("drive")},share:{prio:"hi",mobile:"none",title:p("Share"),tooltip:p("Share this file"),dropdown:"io.ox/files/toolbar/share"},open:{prio:"lo",mobile:_.device("!ios || ios >= 12")?"lo":"hi",icon:_.device("ios && ios < 12")?"fa fa-download":"",title:p("Open attachment"),section:"export",ref:"io.ox/files/actions/open"},print:{prio:"lo",mobile:"lo",title:p("Print as PDF"),section:"export",ref:u+"/print"},invite:{prio:"none",mobile:"lo",title:p("Invite people"),section:"share",ref:"io.ox/files/actions/invite"},sharelink:{prio:"none",mobile:"lo",title:p("Create sharing link"),section:"share",ref:"io.ox/files/actions/getalink"},sendbymail:{prio:"lo",mobile:"lo",title:p("Send by email"),section:"share",ref:"io.ox/files/actions/send"},addtoportal:{prio:"lo",mobile:"lo",title:p("Add to portal"),section:"share",ref:"io.ox/files/actions/add-to-portal"},addtofavorites:{prio:"lo",mobile:"lo",title:p("Add to favorites"),section:"favorites",ref:"io.ox/files/actions/favorites/add"},removefromfavorites:{prio:"lo",mobile:"lo",title:p("Remove from favorites"),section:"favorites",ref:"io.ox/files/actions/favorites/remove"},uploadnewversion:{prio:"lo",mobile:"lo",title:p("Upload new version"),section:"import",ref:"io.ox/files/actions/upload-new-version"},delete:{prio:"lo",mobile:"lo",title:p("Delete"),section:"delete",ref:"io.ox/files/actions/delete"}},mail:{print:{prio:"lo",mobile:"lo",title:p("Print as PDF"),ref:u+"/print"},downloadmailattachment:{prio:"hi",mobile:"lo",icon:"fa fa-download",title:p("Download"),ref:s.getRefByModelSource("mail")},savemailattachmenttodrive:{prio:"lo",mobile:"lo",title:p("Save to %1$s",p.pgettext("app","Drive")),ref:"io.ox/mail/attachment/actions/save"}},compose:{},pim:{print:{prio:"lo",mobile:"lo",title:p("Print as PDF"),ref:u+"/print"},downloadmailattachment:{prio:"hi",mobile:"lo",icon:"fa fa-download",title:p("Download"),ref:s.getRefByModelSource("pim")},savemailattachmenttodrive:{prio:"lo",mobile:"lo",title:p("Save to %1$s",p.pgettext("app","Drive")),ref:"io.ox/core/tk/actions/save-attachment"}},guardDrive:{rename:{prio:"lo",mobile:"lo",title:p("Rename"),section:"edit",ref:"io.ox/files/actions/rename"},editdescription:{prio:"lo",mobile:"lo",title:p("Edit description"),section:"edit",ref:"io.ox/files/actions/edit-description"},download:{prio:"hi",mobile:"lo",icon:"fa fa-download",title:p("Download"),section:"export",ref:s.getRefByModelSource("guardDrive")},sendbymail:{prio:"lo",mobile:"lo",title:p("Send by email"),section:"share",ref:"oxguard/sendcopy"},addtoportal:{prio:"lo",mobile:"lo",title:p("Add to portal"),section:"share",ref:"io.ox/files/actions/add-to-portal"},uploadnewversion:{prio:"lo",mobile:"lo",title:p("Upload new version"),section:"import",ref:"io.ox/files/actions/upload-new-version"},delete:{prio:"lo",mobile:"lo",title:p("Delete"),section:"delete",ref:"io.ox/files/actions/delete"}},guardMail:{}};_(b).each(function(e,o){var i=0,n="io.ox/core/viewer/toolbar/links/"+o,a=t.point(n),r=_.extend({},g,e,w);_(r).each(function(e,o){a.extend(_.extend({id:o,index:i+=100},e))})});var x=n.Action;return new x(u,{action:$.noop}),new x(u+"/print",{capabilities:"document_preview",collection:"one",matches:function(e){var o=e.model,i=o.get("meta");return!(i&&i.document_conversion_error&&i.document_conversion_error.length>0)&&(!(o.isFile()&&!e.collection.has("read"))&&(o.isOffice()||o.isPDF()))},action:function(e){var o=l.getEncodedConverterUrl(e.context.model);_.device("noopener")?window.open(o,"_blank","noopener"):blankshield.open(o,"_blank")}}),new x(m+"/rename",{action:_.noop}),new x(m+"/togglesidebar",{action:function(e){e.context.onToggleSidebar()}}),new x(m+"/popoutstandalone",{capabilities:"infostore",device:"!smartphone",matches:function(e){return"localFile"!==e.model.get("group")&&!e.context.standalone},action:function(e){if(!c.isFileVersionUploading(e.data.id,v)){var o=e.model.isFile()?e.model:{file:e.data};ox.launch("io.ox/files/detail/main",o)}}}),new x(m+"/help",{capabilities:"infostore",device:"!smartphone",matches:function(e){return!e.context.standalone},action:$.noop}),new x(m+"/close",{action:function(e){return e.context.onClose(e.e)}}),new x(m+"/zoomin",{matches:function(e){var o=e.model;return o.isOffice()||o.isPDF()||o.isText()||o.isImage()},action:function(e){e.context.onZoomIn()}}),new x(m+"/zoomout",{matches:function(e){var o=e.model;return o.isOffice()||o.isPDF()||o.isText()||o.isImage()},action:function(e){e.context.onZoomOut()}}),new x(m+"/zoomfitwidth",{matches:function(e){var o=e.model;return(o.isOffice()||o.isPDF()||o.isText())&&e.context.standalone},action:function(e){e.context.viewerEvents.trigger("viewer:zoom:fitwidth")}}),new x(m+"/zoomfitheight",{matches:function(e){var o=e.model;return(o.isOffice()||o.isPDF()||o.isText())&&e.context.standalone},action:function(e){e.context.viewerEvents.trigger("viewer:zoom:fitheight")}}),new x(m+"/autoplaystart",{matches:function(e){return h(e,!1)},action:function(e){e.context.onAutoplayStart()}}),new x(m+"/autoplaystop",{matches:function(e){return h(e,!0)},action:function(e){e.context.onAutoplayStop()}}),o.extend({className:"viewer-toolbar",events:{'click a[data-action="io.ox/core/viewer/actions/toolbar/rename"]':"onRename",'keydown a[data-action="io.ox/core/viewer/actions/toolbar/rename"]':"onRename"},initialize:function(e){_.extend(this,e),this.listenTo(this.viewerEvents,"viewer:displayeditem:change",this.render),this.listenTo(this.viewerEvents,"viewer:document:loaded",this.onDocumentLoaded),this.listenTo(this.viewerEvents,"viewer:document:pagechange",this.onPageChange),this.listenTo(this.viewerEvents,"viewer:sidebar:change:state",this.onSideBarToggled),this.listenTo(this.viewerEvents,"viewer:autoplay:state:changed",this.onAutoplayRunningStateChanged),this.listenTo(a,"favorite:add favorite:remove",this.onFavoritesChange),this.$el.toggleClass("standalone",this.standalone),this.autoplayStarted=!1,this.toolbar=new i({el:this.el,align:"right",strict:!1})},onDocumentLoaded:function(){this.standalone&&!_.device("smartphone")&&this.renderPageNavigation()},onSideBarToggled:function(e){this.$(".viewer-toolbar-navigation").toggleClass("sidebar-offset",e)},onPageChange:function(e,o){var i=this.$(".viewer-toolbar-page"),t=this.$(".viewer-toolbar-page-total");i.val(e).attr("data-page-number",e).trigger("change",{preventPageScroll:!0}),o&&(t.text(p("of %1$d",o)),i.attr("data-page-total",o))},onClose:function(e){e.preventDefault(),e.stopPropagation(),this.viewerEvents.trigger("viewer:close")},onToggleSidebar:function(){this.viewerEvents.trigger("viewer:toggle:sidebar")},onRename:function(e){32!==e.which&&13!==e.which&&"click"!==e.type||(e.preventDefault(),this.model.isFile()&&n.invoke("io.ox/files/actions/rename",this.model.toJSON()))},onZoomIn:function(){this.model.isImage()?this.viewerEvents.trigger("viewer:zoom:in:swiper"):this.viewerEvents.trigger("viewer:zoom:in")},onZoomOut:function(){this.model.isImage()?this.viewerEvents.trigger("viewer:zoom:out:swiper"):this.viewerEvents.trigger("viewer:zoom:out")},onModelChange:function(e){e.changed.description&&this.model.previous("description")!==e.get("description")||this.render(e)},onFavoritesChange:function(e){e.id===_.cid(this.model.toJSON())&&this.updateToolbar()},onAutoplayRunningStateChanged:function(e){e&&(this.autoplayStarted=e.autoplayStarted,this.updateToolbar())},onAutoplayStart:function(){this.viewerEvents.trigger("viewer:autoplay:toggle","running")},onAutoplayStop:function(){this.viewerEvents.trigger("viewer:autoplay:toggle","pausing")},render:function(e){if(!e)return console.error("Core.Viewer.ToolbarView.render(): no file to render"),this;var o=o=e.get("source");return this.model&&this.stopListening(this.model,"change"),this.model=e,this.listenTo(this.model,"change",this.onModelChange),s.setDeviceClass(this.$el),this.toolbar.setPoint("io.ox/core/viewer/toolbar/links/"+o),this.updateToolbar(),this},updateToolbar:_.debounce(function(){if(this.model){var e=this.model.isFile(),o=this.model.toJSON();this.toolbar.setSelection([o],function(){return{context:this,data:e?o:this.model.get("origData"),model:this.model,models:e?[this.model]:null,openedBy:this.openedBy}}.bind(this))}},10),renderPageNavigation:function(){function e(e,o){o?$(e).removeClass("disabled").removeAttr("aria-disabled"):$(e).addClass("disabled").attr("aria-disabled",!0)}var o=$('<a class="viewer-toolbar-navigation-button" role="button">').attr({"aria-label":p("Previous page"),title:p("Previous page")}).append($('<i class="fa fa-arrow-up" aria-hidden="true">')),i=$('<a class="viewer-toolbar-navigation-button" role="button">').attr({"aria-label":p("Next page"),title:p("Next page")}).append($('<i class="fa fa-arrow-down" aria-hidden="true">')),t=$('<input type="text" class="viewer-toolbar-page" role="textbox">'),n=$('<div class="viewer-toolbar-page-wrapper">').append(t),a=$('<div class="viewer-toolbar-page-total">'),r=$('<li class="viewer-toolbar-navigation" role="presentation">'),l=!this.isSharing&&d.getSidebarOpenState(),s=this;t.on("keydown",function(e){e.stopPropagation(),13!==e.which&&27!==e.which||s.$el.parent().focus()}).on("change",function(t,n){n=_.extend({preventPageScroll:!1},n);var a=parseInt($(this).val(),10),r=parseInt($(this).attr("data-page-number"),10),l=parseInt($(this).attr("data-page-total"),10);isNaN(a)?$(this).val(r):(a<=0&&($(this).val(1),a=1),a>l&&($(this).val(l),a=l),e([o[0],i[0]],!0),1===a&&e(o,!1),a===l&&e(i,!1),$(this).attr("data-page-number",a),n.preventPageScroll||s.viewerEvents.trigger("viewer:document:scrolltopage",a))}).on("click",function(){$(this).select()}),o.on("click",function(){s.viewerEvents.trigger("viewer:document:previous")}),i.on("click",function(){s.viewerEvents.trigger("viewer:document:next")}),r.append(o,i,n,a).toggleClass("sidebar-offset",l),this.$el.prepend(r)},onDispose:function(){this.stopListening(a),this.model=null}})});