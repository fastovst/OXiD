define("io.ox/core/viewer/views/sidebar/uploadnewversionview",["io.ox/backbone/views/disposable","io.ox/files/api","io.ox/core/folder/api","io.ox/core/tk/dialogs","io.ox/files/util","io.ox/core/extensions","io.ox/core/api/user","io.ox/files/upload/main","gettext!io.ox/core/viewer"],function(e,i,t,o,n,d,r,s,a){"use strict";var l="io.ox/core/viewer/upload-new-version";return d.point(l+"/dialog").extend({index:100,id:"header",draw:function(e){e.$.header($("<h4>").text(a("Version Comment")))}}),d.point(l+"/dialog").extend({index:200,id:"body",draw:function(e){e.$.append($('<textarea rows="6" class="form-control comment">'))}}),d.point(l+"/dialog").extend({index:300,id:"primary",draw:function(e){var i=this;e.$.addPrimaryButton("upload",a("Upload"),"upload").on("upload",function(){var t=e.$.getContentNode().find("textarea.comment").val()||"";i.upload(t)})}}),d.point(l+"/dialog").extend({index:400,id:"cancel",draw:function(e){var i=this;e.$.addButton("cancel",a("Cancel"),"cancel").on("cancel",function(){_.first(i.$('input[type="file"]')).value=""})}}),d.point(l+"/dialog").extend({index:500,id:"show",draw:function(e){e.$.show(function(){this.find(".btn-primary").focus()})}}),e.extend({className:"viewer-uploadnewversion",events:{'change input[type="file"]':"onFileSelected"},onFileSelected:function(e){if(e.preventDefault(),!t.pool.getModel(this.model.get("folder_id")).supports("extended_metadata"))return this.upload();var i=d.Baton({data:this.getFile(),$:new o.ModalDialog});d.point(l+"/dialog").invoke("draw",this,i)},getFile:function(){return _.first(this.$('input[type="file"]')[0].files)},upload:function(e){var i={folder:this.model.get("folder_id"),id:this.model.get("id"),params:this.model.isEncrypted()?{cryptoAction:"Encrypt"}:{}},o=this.app?this.app.getWindowNode():this.$el.closest(".io-ox-viewer").find(".viewer-displayer");t.pool.getModel(this.model.get("folder_id")).supports("extended_metadata")&&(i.version_comment=e||""),s.setWindowNode(o),s.update.offer(this.getFile(),i)},initialize:function(e){e=e||{},this.model&&this.model.isFile()||this.$el.hide(),this.app=e.app},render:function(){if(!this.model||!this.model.isFile())return this;var e=this;return $.when(t.get(this.model.get("folder_id")),r.get()).done(function(i,o){if(!this.disposed&&!n.hasStatus("lockedByOthers",{context:this.model.attributes})&&t.can("add:version",i)){if(!t.can("write",i)){var r=e.model.get("object_permissions")||e.model.get("com.openexchange.share.extendedObjectPermissions")||[],s=_(r).findWhere({entity:ox.user_id});if((!s||s&&s.bits<2)&&_(r).findWhere({group:!0})&&(s=_(r).findWhere({entity:_(_.pluck(r,"entity")).intersection(o.groups)[0]})),!(s&&s.bits>=2))return}var l=this.$el;require(["io.ox/core/tk/attachments"],function(e){l.append(e.fileUploadWidget({multi:!1,buttontext:a("Upload new version")})),d.point("io.ox/core/viewer/views/sidebarview/uploadnewversion").invoke("draw",this)}.bind(this))}}.bind(this)),this},onDispose:function(){this.model&&(this.model=null)}})});