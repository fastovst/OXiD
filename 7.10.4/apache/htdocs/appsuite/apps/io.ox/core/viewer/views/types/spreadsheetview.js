define("io.ox/core/viewer/views/types/spreadsheetview",["io.ox/core/viewer/views/types/baseview","io.ox/core/extensions","io.ox/files/api","settings!io.ox/files","gettext!io.ox/core"],function(e,t,i,n,o){"use strict";return e.extend({initialize:function(e){_.extend(this,e),this.isPrefetched=!1,this.documentContainer=null,this.appLaunchDelayId=null,this.spreadsheetApp=null,this.tempFileModel=null,this.listenTo(this.viewerEvents,"viewer:beforeclose",this.onDispose)},withValidApp:function(e){!this.disposed&&this.spreadsheetApp&&this.spreadsheetApp.isInQuit&&!this.spreadsheetApp.isInQuit()&&e.call(this,this.spreadsheetApp)},assureDriveFile:function(e){return e.isFile()?$.when(e):this.saveAttachmentToTempFolder(e)},saveAttachmentToTempFolder:function(e){var t=String(n.get("folder/trash")),o=this,s=null;return s=e.isPIMAttachment()?(s=(s=require(["io.ox/core/api/attachment"])).then(function(i){return o.disposed?$.Deferred().reject():i.save(e.get("origData"),t)})).then(function(e){return i.get({id:e,folder_id:t})}):e.isMailAttachment()?(s=(s=require(["io.ox/mail/api"])).then(function(i){return o.disposed?$.Deferred().reject():i.saveAttachments(e.get("origData"),t)})).then(function(e){var t=e&&e[0]&&e[0].data||{};return i.get({id:t.id,folder_id:t.folder_id})}):$.Deferred().reject(e),s=s.then(function(e){return o.tempFileModel=i.pool.get("detail").get(_.cid(e))||null,o.tempFileModel})},deleteTempFile:function(){return this.tempFileModel?i.remove([this.tempFileModel.toJSON()],!0).then(function(){this.tempFileModel=null}.bind(this)):$.when()},showLoadError:function(e){this.disposed||(this.displayDownloadNotification(e||o("An error occurred loading the document so it cannot be displayed.")),this.documentContainer=null)},render:function(){return this.documentContainer=$('<div class="viewer-document-container viewer-displayer-spreadsheet marsupilami">'),this.$el.empty().append(this.documentContainer),this},prefetch:function(e){if(e&&1===e.priority&&!this.disposed&&this.model.isFile()){var t={action:"getoperations",subaction:"prefetch",session:ox.session,id:this.model.get("id"),folder_id:this.model.get("folder_id")},i=ox.apiRoot+"/oxodocumentfilter?"+_.map(t,function(e,t){return t+"="+encodeURIComponent(e)}).join("&");_.delay(function(){$.ajax({url:i,dataType:"text"})},1e3),this.isPrefetched=!0}return this},show:function(){function e(e){var i=n.assureDriveFile(e);return i=i.then(function(e){if(n.disposed)return $.Deferred().reject();var i=t.point("io.ox/office/spreadsheet/viewer/load/drive"),o=new t.Baton({data:e,page:n.documentContainer}),s=i.invoke("launch",n,o);return s&&_.isArray(s._wrapped)?s._wrapped[0]:$.Deferred().reject()})}function i(){var e=n.spreadsheetApp=this;n.disposed||n.$el.idle(),e.onInit(function(){function t(t,i,o){e.waitForImportSuccess(function(){n.listenTo(t,i,n.withValidApp.bind(n,o))})}t(n.viewerEvents,"viewer:resize",function(){e.getView().refreshPaneLayout()}),t(n.viewerEvents,"viewer:zoom:in",function(){e.getController().executeItem("view/zoom/inc")}),t(n.viewerEvents,"viewer:zoom:out",function(){e.getController().executeItem("view/zoom/dec")}),n.app&&t(n.app.getWindow(),"show",function(){e.getWindow().show(null,!0)}),e.getWindow().on("hide",function(){n.app&&!n.disposed&&n.app.getWindow().hide()}),e.waitForImportFailure(function(e,t){n.showLoadError(t.message)})})}var n=this;if(this.documentContainer&&!(this.documentContainer.children().length>0))return this.$el.busy(),this.appLaunchDelayId&&window.clearTimeout(this.appLaunchDelayId),this.appLaunchDelayId=window.setTimeout(function(){n.appLaunchDelayId=null,e(n.model).then(i,n.showLoadError.bind(n))},500),this},unload:function(){var e=this;return this.appLaunchDelayId&&(window.clearTimeout(this.appLaunchDelayId),this.appLaunchDelayId=null),this.withValidApp(function(t){t.quit().then(function(){e.spreadsheetApp=null})}),this.deleteTempFile(),this.isPrefetched=!1,this},onDispose:function(){this.unload(),this.off().stopListening(),this.disposed=!0,this.documentContainer=null}})});