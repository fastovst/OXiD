define("io.ox/core/viewer/views/sidebarview",["io.ox/backbone/views/disposable","io.ox/core/viewer/util","io.ox/files/api","io.ox/core/folder/api","io.ox/core/dropzone","io.ox/core/capabilities","io.ox/core/viewer/settings","io.ox/core/viewer/views/types/typesutil","io.ox/core/viewer/views/document/thumbnailview","io.ox/core/viewer/views/sidebar/fileinfoview","io.ox/core/viewer/views/sidebar/filedescriptionview","io.ox/core/viewer/views/sidebar/fileversionsview","io.ox/core/viewer/views/sidebar/uploadnewversionview","io.ox/core/extensions","gettext!io.ox/core/viewer","io.ox/core/viewer/views/sidebar/panelbaseview"],function(e,i,o,t,s,n,a,d,l,r,h,c,p,v,w){"use strict";function b(){var e=this,i=arguments;require(["io.ox/core/notifications"],function(o){o.yell.apply(e,i)})}return v.point("io.ox/core/viewer/views/sidebarview/detail").extend({id:"file-info",index:100,draw:function(e){var i={model:e.model,fixed:!0,closable:e.options.closable,disableFolderInfo:!(!e.options.opt||!e.options.opt.disableFolderInfo)};this.append(new r(i).render().el)}}),v.point("io.ox/core/viewer/views/sidebarview/detail").extend({id:"file-description",index:200,draw:function(e){e.model.isFile()&&t.pool.models[e.data.folder_id]&&t.pool.models[e.data.folder_id].supports("extended_metadata")&&this.append(new h({model:e.model}).render().el)}}),v.point("io.ox/core/viewer/views/sidebarview/detail").extend({id:"file-versions",index:300,draw:function(e){e.model.isFile()&&t.pool.models[e.data.folder_id]&&t.pool.models[e.data.folder_id].can("add:version")&&this.append(new c({model:e.model,viewerEvents:e.context.viewerEvents,isViewer:e.context.isViewer}).render().el)}}),v.point("io.ox/core/viewer/views/sidebarview/detail").extend({id:"upload-new-version",index:400,draw:function(e){e.model.isFile()&&t.pool.models[e.data.folder_id]&&t.pool.models[e.data.folder_id].can("add:version")&&this.append(new p({model:e.model,app:e.app}).render().el)}}),e.extend({className:"viewer-sidebar",open:!1,events:{"keydown .tablink":"onTabKeydown"},initialize:function(e){e=e||{},_.extend(this,{viewerEvents:e.viewerEvents||_.extend({},Backbone.Events),standalone:e.standalone,options:e,isViewer:e.isViewer}),this.model=null,this.zone=null,this.app=e.app,this.listenTo(this.viewerEvents,"viewer:displayeditem:change",this.setModel),this.$el.on("scroll",_.throttle(this.onScrollHandler.bind(this),500)),this.initTabNavigation()},initTabNavigation:function(){var e=$('<ul class="viewer-sidebar-tabs hidden">'),i=$('<a class="tablink" data-tab-id="detail">').text(w("Details")),o=$('<li class="viewer-sidebar-detailtab">').append(i),t=$('<div class="viewer-sidebar-pane detail-pane" data-tab-id="detail">'),s=$('<a class="tablink selected"  data-tab-id="thumbnail">').text(w("Thumbnails")),n=$('<li class="viewer-sidebar-thumbnailtab">').append(s),a=$('<div class="viewer-sidebar-pane thumbnail-pane" data-tab-id="thumbnail">');e.append(n,o),this.$el.append(e),e.on("click",".tablink",this.onTabClicked.bind(this)),this.$el.append(a,t)},onScrollHandler:function(e){this.viewerEvents.trigger("viewer:sidebar:scroll",e)},onTabClicked:function(e){var i=$(e.target).attr("data-tab-id");this.activateTab(i)},onTabKeydown:function(e){switch(e.stopPropagation(),e.which){case 13:case 32:this.onTabClicked(e)}},activateTab:function(e){var i=this.$(".tablink"),o=this.$(".viewer-sidebar-pane"),t=i.filter('[data-tab-id="'+e+'"]'),s=o.filter('[data-tab-id="'+e+'"]');switch(i.removeClass("selected"),o.addClass("hidden"),t.addClass("selected"),s.removeClass("hidden"),e){case"detail":this.renderSections();break;case"thumbnail":0===this.$(".document-thumbnail").length&&new l({el:this.$(".thumbnail-pane"),model:this.model,viewerEvents:this.viewerEvents}).render()}this.standalone&&(this.model.isOffice()||this.model.isPDF())&&a.setSidebarActiveTab(e)},toggleSidebar:function(e){this.open=_.isUndefined(e)?!this.open:Boolean(e),this.$el.toggleClass("open",this.open),this.viewerEvents.trigger("viewer:sidebar:change:state",this.open),this.renderSections()},setModel:function(e){this.model=e||null,this.renderSections()},renderSections:function(){if(this.model&&this.open){var e=this.$(".detail-pane"),i=t.pool.models[this.model.get("folder_id")];e.empty(),this.zone&&(this.zone.off(),this.zone.remove(),this.zone=null),this.loadFileDetails(),this.model.isFile()&&i&&i.can("add:version")&&(this.zone=new s.Inplace({caption:w('Drop new version of "%1$s" here',this.model.get("filename"))}),this.zone.on({show:function(){e.addClass("hidden")},hide:function(){e.removeClass("hidden")},drop:this.onNewVersionDropped.bind(this)}),e.parent().append(this.zone.render().$el.addClass("abs"))),v.point("io.ox/core/viewer/views/sidebarview/detail").invoke("draw",e,v.Baton({options:this.options,isViewer:this.isViewer,context:this,app:this.app,$el:e,model:this.model,data:this.model.isFile()?this.model.toJSON():this.model.get("origData")}))}},render:function(e){if(this.$el.attr({tabindex:-1,role:"complementary","aria-label":w("Details")}),i.setDeviceClass(this.$el),this.$el.enableTouch&&this.$el.enableTouch({selector:null,horSwipeHandler:this.onHorizontalSwipe.bind(this)}),this.model=e,this.standalone&&!_.device("smartphone")&&d.isDocumentType(e)){this.$(".viewer-sidebar-tabs").removeClass("hidden");var o=a.getSidebarActiveTab();this.activateTab(o)}else this.activateTab("detail");return this},loadFileDetails:function(){this.model&&(this.options.opt&&this.options.opt.disableFileDetail||this.model.isFile()&&o.get(this.model.toJSON()).done(function(e){if(this.model){var i=e&&_.isString(e.description)?e.description:"";this.model.set("description",i)}}.bind(this)))},onNewVersionDropped:function(e){if(_.isArray(e)&&1===e.length){var i=this;require(["io.ox/files/upload/main"],function(o){var t={folder:i.model.get("folder_id"),id:i.model.get("id"),params:i.model.isEncrypted()?{cryptoAction:"Encrypt"}:{}},s=i.isViewer?i.$el.parent().find(".viewer-displayer"):i.app.getWindowNode();o.setWindowNode(s),o.update.offer(_.first(e),t)})}else b({error:w("Drop only a single file as new version.")})},onHorizontalSwipe:function(e,i,o){o>0&&this.toggleSidebar()},onDispose:function(){this.$el.disableTouch(),this.zone&&(this.zone.off(),this.zone=null),this.model=null}})});