define("io.ox/core/folder/breadcrumb",["io.ox/core/folder/api"],function(i){"use strict";return Backbone.DisposableView.extend({className:"breadcrumb-view",events:{"click .breadcrumb-link":"onClickLink"},initialize:function(i){this.folder=i.folder,this.label=i.label,this.exclude=i.exclude,this.disable=i.disable,this.display=i.display||"inline",this.rootAlwaysVisible=i.rootAlwaysVisible,this.linkReadOnly=i.linkReadOnly,this.defaultRootPath=i.defaultRootPath,this.notail=i.notail,"block"===this.display&&(this.computeWidth=$.noop),i.app&&(this.app=i.app,this.handler=function(i){this.app.folder.set(i)},this.folder=this.app.folder.get(),this.find=this.app.get("find"),this.listenTo(this.app,"folder:change",this.onChangeFolder),this.find&&this.find.isActive()&&(this.folder=i.folder,this.notail=!0,this.handler=function(i){var e=this.app.folder;e.unset(),e.set(i)}),"block"!==this.display&&this.listenToDOM(window,"resize",this.computeWidth))},onChangeFolder:function(i){this.folder=i,this.render()},render:function(){return void 0===this.folder?this:(this.$el.text("Â "),i.path(this.folder).done(this.renderPath.bind(this)),this)},renderPath:function(e){if(!this.disposed){if(this.exclude){var t=_(this.exclude);e=_(e).filter(function(i){return!t.contains(i.id)})}this.defaultRootPath&&this.defaultRootPath.id!==_.first(e).id&&e.unshift(this.defaultRootPath),this.stopListening(i),this.stopListeningModels(),_(e).each(this.listener,this),this.rootAlwaysVisible?this.$el.empty().append(this.renderLink(_.first(e),0,e),$('<span class="breadcrumb-ellipsis" aria-hidden="true">&hellip;</span>').hide(),this.label?$('<span class="breadcrumb-label">').text(this.label):[],_(_.rest(e)).map(this.renderLink,this)):this.$el.empty().append($('<span class="breadcrumb-ellipsis" aria-hidden="true">&hellip;</span>').hide(),this.label?$('<span class="breadcrumb-label">').text(this.label):[],_(e).map(this.renderLink,this)),this.app&&this.computeWidth()}},computeWidth:_.throttle(function(){if(!this.disposed&&this.$el.is(":visible")){var i=this.$el.parent().width(),e=_(this.$el.siblings(":visible")).reduce(function(i,e){return i+$(e).outerWidth(!0)},0),t=Math.max(0,i-e-96),s=0;this.$el.addClass("invisible").children().show(),this.rootAlwaysVisible&&this.$el.children().toArray().slice(0,1).reverse().forEach(function(i){s+=$(i).outerWidth(!0)}),this.$el.children().toArray().slice(this.rootAlwaysVisible?2:1).reverse().forEach(function(i,e){s+=$(i).outerWidth(!0),$(i).toggle(0===e||s<t)}),this.$el.children(".breadcrumb-ellipsis").toggle(s>t),this.$el.css("max-width",t+32).removeClass("invisible")}},100),renderLink:function(e,t,s){var l,n=t===s.length-1,h=!(i.can("read",e)||this.linkReadOnly&&1===e.own_rights)||this.disable&&_(this.disable).indexOf(e.id)>-1;return 0===t&&this.defaultRootPath&&this.defaultRootPath.id!==e.id&&this.renderLink(this.defaultRootPath,0,s),(l=n&&!this.notail?$('<span class="breadcrumb-tail">'):!this.handler||h?$('<span class="breadcrumb-item">'):$('<a href="#" role="button" class="breadcrumb-link">').attr("href",i.getDeepLink(e))).attr({"data-id":e.id,"data-module":e.module}).text(n?e.title:_.ellipsis(e.title,{max:20})),n||(l=l.add($('<i class="fa breadcrumb-divider" aria-hidden="true">'))),l},onClickLink:function(i){i.preventDefault();var e=$(i.target).attr("data-id"),t=$(i.target).attr("data-module");this.handler&&this.handler(e,t)},onFolderModelChange:function(i){i.changed&&i.previous("id")===this.folder?this.onChangeFolder(i.get("id")):this.render()},onFolderPathModified:function(i,e){i!==e&&(this.folder===i?this.onChangeFolder(e):this.render())},listener:function(i){this.listenToFolderChange(i),this.listenToFolderModelChange(i)},stopListeningModels:function(){var i=this;_.each(i.models,function(e){i.stopListening(e,"change")}),i.models=[]},listenToFolderModelChange:function(e){var t=i.pool.getModel(e.id);this.models.push(t),this.listenTo(t,"change",this.onFolderModelChange.bind(this))},listenToFolderChange:function(e){this.listenTo(i,"update:"+e.id,this.onFolderPathModified.bind(this))}})});