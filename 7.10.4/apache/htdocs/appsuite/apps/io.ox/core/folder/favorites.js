define("io.ox/core/folder/favorites",["io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/upsell","settings!io.ox/core","gettext!io.ox/core","io.ox/files/favorites"],function(e,t,o,n,i,r){"use strict";function a(e){return"calendar"===e&&void 0===i.get("favorites/chronos")&&l(),i.get(d(e),[])}function d(e){return"favorites/"+("calendar"===e?"chronos":e)}function l(){var e=_(i.get("favorites/calendar",[])).map(function(e){return"cal://0/"+e});i.set("favorites/chronos",e).save()}function f(e,o){return e.filter(function(e){var n=e.get("id");if(n)return 0===n.indexOf(o+t.getMailFolderSeparator(n))})}function c(e,o,n){if(o=o||t.pool.getModel(e),n=n||o.get("module")){var i="virtual/favorites/"+n;t.pool.getCollection(i).remove(o),t.trigger("favorite:remove")}}function s(e,o){if((o=o||t.pool.getModel(e)).get("module")){var n="virtual/favorites/"+o.get("module"),i=t.pool.getCollection(n);o.set("index/"+n,!0,{silent:!0}),i.add(o),i.sort(),t.trigger("favorite:add")}}function u(e){s(e.data.id)}function v(e){c(e.data.id,void 0,e.data.module)}function p(e,t){return $('<a href="#" role="menuitem" tabindex="-1">').attr("data-action",e).text(t).on("click",$.preventDefault)}function m(e){return e.attr("aria-disabled",!0).removeAttr("tabindex").addClass("disabled")}function g(e,t){if("infostore"!==t.data.module){var o=p(t.action,t.text);return t.enabled?o.on("click",t.data,t.handler):m(o),e.append($('<li role="presentation">').append(o)),o}}return _("mail contacts calendar tasks".split(" ")).each(function(l){function c(e){i.set(d(l),e).save()}function s(){c(_(p.pluck("id")).filter(function(e){return!m[e]}))}if(("mail"!==l||n.has("webmail"))&&("mail"===l||n.has(l))){var u="virtual/favorites/"+l,v=t.pool.getModel(u),p=t.pool.getCollection(u),m={};t.virtual.add(u,function(){var e=!p.expired&&p.fetched;return t.multiple(a(l),{errors:!0,cache:e}).then(function(e){var o=_(e).filter(function(e){return e.error&&/^(FLD-0008|FLD-0003|ACC-0002|FLD-1004|IMAP-1002|FILE_STORAGE-0004)$/.test(e.code)?(m[e.id]=!0,!1):(delete m[e.id],!0)});return _(o).each(t.injectIndex.bind(t,u)),v.set("subscr_subflds",o.length>0),o.length!==e.length&&_.defer(s),o})}),p.on("add",function(e){delete m[e.id]}),p.on("add remove change:id",s),"mail"===l?(t.on("rename",function(e,t){"mail"===t.module&&f(p,e).forEach(function(o){o.set("id",t.id+o.get("id").substr(e.length)),s()})}),t.on("remove:mail",function(e){f(p,e.id).forEach(function(e){p.remove(e),s()})})):"infostore"===l&&(v.set("title",r("Favorites")),v.set("folder_id","9"),v.set("own_rights",1),v.set("standard_folder",!0));var g={id:"favorites",index:1,draw:function(o){this.append(new e({empty:!1,folder:u,indent:!t.isFlat(l),open:!1,parent:o,sortable:!0,title:r("Favorites"),tree:o,icons:o.options.icons}).render().$el.addClass("favorites")),o.on("sort:"+u,c)}};o.point("io.ox/core/foldertree/"+l+"/app").extend(_.extend({},g)),o.point("io.ox/core/foldertree/"+l+"/popup").extend(_.extend({},g))}}),t.on("collection:remove",function(e,t){c(e,t)}),o.point("io.ox/core/foldertree/contextmenu/default").extend({id:"toggle-favorite",index:1010,draw:function(e){var o=e.data.id,n=e.module,i=a(n),d=_(i).indexOf(o)>-1;t.is("trash",e.data)||g(this,{action:"toggle-favorite",data:{id:o,module:n},enabled:!0,handler:d?v:u,text:r(d?"Remove from favorites":"Add to favorites")})}}),{add:s,remove:c}});