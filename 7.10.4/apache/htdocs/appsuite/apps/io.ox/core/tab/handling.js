define("io.ox/core/tab/handling",["io.ox/core/boot/util"],function(n){"use strict";function e(){var n=localStorage.getItem(u)||JSON.stringify([]);try{m=JSON.parse(n),_.isArray(m)||(m=[])}catch(n){m=[],ox.debug&&console.warn("TabHandling.fetch",n)}}function i(){var n,e=m||[];try{n=JSON.stringify(e)}catch(e){n=JSON.stringify([]),ox.debug&&console.warn("TabHandling.store",e)}finally{localStorage.setItem(u,n)}}function t(n){if(n&&!_.isEmpty(n)&&n.windowName){var e=_.pick(n,"windowName","windowType");n.windowType===p.WINDOW_TYPE.CHILD&&_.extend(e,{parent:n.parentName}),N(n.windowName)||(m.push(e),i())}}function o(n){e(),m=_.without(m,_.findWhere(m,{windowName:n})),i()}function a(){var n=r(location.href.indexOf("office?app")>=0);window.name=JSON.stringify(n),_.extend(p,_.pick(n,"windowName","windowType","parentName")),c()}function r(n){var e=w(window.name);return n&&(e=_.extend(e,{windowName:e.windowName||d(p.WINDOW_TYPE.CHILD),windowType:p.WINDOW_TYPE.CHILD,parentName:e.parentName||d(p.WINDOW_TYPE.PARENT)})),n||(e.windowType===p.WINDOW_TYPE.CHILD&&(delete e.parentName,delete e.windowName),e=_.extend(e,{windowName:e.windowName||d(p.WINDOW_TYPE.PARENT),windowType:p.WINDOW_TYPE.PARENT})),e}function w(n){n=n||JSON.stringify({});var e;try{e=JSON.parse(n)}catch(n){e={},ox.debug&&console.warn("TabHandling.parseWindowName",n)}return e}function d(n){return n+"-"+Date.now()}function N(n){return e(),_.find(m,function(e){return e.windowName===n})}function c(){ox.on("login:success",function(){t(_.pick(p,"windowName","windowType","parentName"))})}var p,s=!1,u="appsuite.window-handling",m=[];return p={windowName:"",windowType:"",parentName:"",LOGGING_OUT_STATE:{LEADER:"leader",FOLLOWER:"follower"},WINDOW_TYPE:{PARENT:"parent",CHILD:"child"},getWindowList:function(){return e(),m},setLoggingOutState:function(n){var e,i=window.name||JSON.stringify({});try{e=JSON.parse(i)}catch(n){e={},ox.debug&&console.warn("setLoggingOutState",n)}finally{e.loggingOut=n,window.name=JSON.stringify(e)}},getLoggingOutState:function(){var n,e=window.name||JSON.stringify({});try{n=JSON.parse(e)}catch(e){n={},ox.debug&&console.warn("getLoggingOutState",e)}return n.loggingOut},createURL:function(n,e){var i=_.omit(_.url.hash(),"!!"),t=e&&e.exclude;t&&(i=_.omit(i,t)),_.extend(i,n);var o="/"+(e&&e.suffix||"");return ox.abs+ox.root+o+"#!&"+$.param(i)},openTab:function(n,e){var i,t=n||ox.abs+ox.root+"/busy.html";return _.isEmpty(e)&&(e=_.pick(this,"windowName","windowType","parentName")),i=JSON.stringify(_.pick(e,"windowName","windowType","parentName")),e.windowType===this.WINDOW_TYPE.PARENT&&window.opener&&window.opener.name&&(i=window.opener.name),window.open(t,i)},openParent:function(n,e){var i=_.isString(n)?n:this.createURL(n,e),t=this.openTab(i,{windowName:this.parentName,windowType:this.WINDOW_TYPE.PARENT});return window.opener||(window.opener=t),t},openChild:function(n,e){var i=_.isString(n)?n:this.createURL(n,e);return this.openTab(i,{windowName:d(this.WINDOW_TYPE.CHILD),windowType:this.WINDOW_TYPE.CHILD,parentName:this.windowType===this.WINDOW_TYPE.CHILD?this.parentName:this.windowName})},isParent:function(){return!this.parentName},getWindowNameObject:function(){return _.pick(this,"windowName","windowType","parentName")},removeFromWindowList:function(n){n&&o(n)}},n.checkTabHandlingSupport()&&!s&&Modernizr.localstorage&&(e(),a(),s=!0),p});