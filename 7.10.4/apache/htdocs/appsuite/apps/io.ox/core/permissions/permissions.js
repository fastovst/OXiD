define("io.ox/core/permissions/permissions",["io.ox/core/extensions","io.ox/core/notifications","io.ox/core/folder/breadcrumb","io.ox/core/folder/api","io.ox/core/api/user","io.ox/core/api/group","io.ox/contacts/api","io.ox/core/tk/dialogs","io.ox/contacts/util","io.ox/core/tk/typeahead","io.ox/core/settings/util","io.ox/participants/model","io.ox/participants/views","gettext!io.ox/core","less!io.ox/core/permissions/style"],function(e,t,o,i,n,a,r,s,d,l,p,c,u,m){"use strict";function f(){this.render()}function h(){this.remove()}var g,v,x,b,w,y="io.ox/core/permissions",k=[{label:m("Guest"),bits:257},{label:m("Author"),bits:4227332},{label:m("Administrator"),bits:272662788}],j=Backbone.Model.extend({idAttribute:"entity",defaults:{group:!1,bits:0}}),C=Backbone.Collection.extend({model:j}),B=Backbone.View.extend({initialize:function(e){this.options=e,this.model.off("change",f),this.model.on("change",f,this),this.model.off("remove",h,this),this.model.on("remove",h,this)},className:"permission row",events:{"click a.bit":"updateDropdown","click a.role":"applyRole",'click a[data-action="remove"]':"removeEntity"},render:function(){var t=e.Baton({model:this.model,view:this,admin:this.options.admin,folder:this.options.folder});return e.point(y+"/detail").invoke("draw",this.$el.empty(),t),this},removeEntity:function(e){e.preventDefault(),this.collection.remove(this.model),this.remove()},updateDropdown:function(e){e.preventDefault();var t=$(e.target),o=t.parent().parent().parent(),n=t.attr("data-value"),a=o.children("a"),r=a.attr("data-type"),s=i.Bitmask(this.model.get("bits")).set(r,n).get();a.text(t.text()),this.model.set("bits",s,{validate:!0}),this.updateRole()},applyRole:function(e){e.preventDefault();var t=$(e.target).attr("data-value");this.model.set("bits",parseInt(t,10),{validate:!0})},updateRole:function(){var e=this.$el.find(".preset > a").text(m("Apply role")),t=this.model.get("bits");_(k).find(function(o){if(o.bits===t)return e.text(o.label),!0})}}),P=new C,N={folder:{1:m("view the folder"),2:m("create objects"),4:m("create objects and subfolders"),64:m("create objects and subfolders")},read:{0:m("no read permissions"),1:m("read own objects"),2:m("read all objects"),64:m("read all objects")},write:{0:m("no edit permissions"),1:m("edit own objects"),2:m("edit all objects"),64:m("edit all objects")},delete:{0:m("no delete permissions"),1:m("delete only own objects"),2:m("delete all objects"),64:m("delete all objects")},admin:{0:m("No"),1:m("Yes")},preset:{}},D=!1;return e.point(y+"/detail").extend({index:100,id:"folderpermissions",draw:function(t){var o=this,i=t.model.get("entity");t.model.get("group")?a.getName(i).done(function(i){t.name=i,e.point(y+"/entity").invoke("draw",o,t)}):n.get({id:String(i)}).done(function(i){t.name=d.getFullName(i),t.user=i,e.point(y+"/entity").invoke("draw",o,t)})}}),e.point(y+"/entity").extend({index:100,id:"entityimage",draw:function(e){e.user?this.append(r.pictureHalo($('<div class="pull-left contact-picture">'),e.user,{width:64,height:64})):this.append($('<div class="pull-left contact-picture group">').append($('<i class="fa fa-group" aria-hidden="true">')))}}),e.point(y+"/entity").extend({index:200,id:"entitysentence",draw:function(e){var t,o;this.append($('<div class="entity">').append(t=$("<div>").append($('<span class="name">').text(e.name),e.model.get("entity")===e.view.options.owner?$('<span class="owner">').text(m("Owner")):$(),x(e)))),o=$("<div>").append(m("Folder permissions"),$.txt(": "),v("folder",e),$.txt(". "),m("Object permissions"),$.txt(": "),v("read",e),$.txt(", "),v("write",e),$.txt(", "),v("delete",e),$.txt(". "),m("The user has administrative rights"),$.txt(": "),v("admin",e),$.txt(". ")),e.admin?o.addClass("readwrite"):(o.addClass("readonly"),o.find("span.dropdown a").attr({"aria-haspopup":!1,"data-toggle":null,disabled:"disabled"})),t.append(b(e.model.get("entity")),o),e.view.updateRole()}}),b=function(e){return D&&e!==ox.user_id?$('<a href="# "data-action="remove">').append($('<i class="fa fa-trash-o" aria-hidden="true">')):$()},w=function(e,t){if("admin"===e&&(String(i.getDefaultFolder(t.folder.module))===t.folder.id||5===t.folder.type||2===t.folder.type&&0===t.model.id||1===t.folder.type&&("contacts"===t.folder.module||"calendar"===t.folder.module)))return!0},v=function(e,t){var o,n,a=t.model.get("bits"),r=i.Bitmask(a).get(e);return w(e,t)?$("<i>").text(N[e][r]):(o=$('<span class="dropdown">').append($('<a href="#" aria-haspopup="true" data-toggle="dropdown">').attr("data-type",e).text(N[e][r]),n=$('<ul class="dropdown-menu" role="menu">')),_(N[e]).each(function(e,t){if("64"===t)return!0;n.append($("<li>").append($('<a href="#" role="menuitem" class="bit">').attr("data-value",t).text(e)))}),o)},x=function(e){return D?$('<span class="dropdown preset">').append($('<a href="#" data-type="permission" data-toggle="dropdown" aria-haspopup="true">'),$('<ul class="dropdown-menu" role="menu">').append(_(k).map(function(t){if(!w("admin",e)||272662788!==t.bits)return $("<li>").append($('<a href="#" role="menuitem" class="role">').attr("data-value",t.bits).text(t.label))}))):$()},{show:function(a){var r=$.Deferred();return g=String(a),i.get(g,{cache:!1}).done(function(a){try{D=i.Bitmask(a.own_rights).get("admin")>=1,"mail"!==a.module||a.capabilities&Math.pow(2,0)||(D=!1);var d={top:60,width:800,center:!1,maximize:!0,async:!0,help:"ox.appsuite.user.sect.dataorganisation.sharing.invitation.html"};_.device("!desktop")&&(d={top:"40px",center:!1,async:!0});var f=new s.ModalDialog(d);f.getHeader().append($("<h4>").text(m("Folder permissions")),new o({folder:a.id}).render().$el),_.device("!desktop")&&(f.getHeader().append(f.addButtonMobile("save",m("Save")).addClass("btn-primary"),f.addButtonMobile("cancel",m("Cancel"))),f.getFooter().hide());var h=a.created_by||(i.is("insideDefaultfolder",a)?ox.user_id:null);P.on("reset",function(){var e=f.getContentNode().empty();this.each(function(t){new B({model:t,collection:this,owner:h,admin:D,folder:a}).render().$el.appendTo(e)},this)}),P.on("add",function(e,t){var o=f.getContentNode();new B({model:e,collection:t,owner:h,admin:D,folder:a}).render().$el.appendTo(o)});var v=_.chain(a.permissions).filter(function(e){return!1===e.group}).pluck("entity").value(),x=new Backbone.Model({cascadePermissionsFlag:!1});if(f.getContentNode().addClass("scrollpane").busy(),D){_.device("desktop")&&f.addPrimaryButton("save",m("Save"),"save").addButton("cancel",m("Cancel"),"cancel"),e.point("io.ox/core/permissions/permissions/autoCompleteItem").extend({id:"view",index:100,draw:function(e){this.append(new u.ParticipantEntryView({model:e,closeButton:!1,halo:!1,field:!0}).render().$el)}});var b=$("<div>").addClass("checkbox control-group cascade").append(p.checkbox("cascadePermissions",m("Apply to all subfolders"),x).on("change",function(e){var t=e.originalEvent.srcElement;x.set("cascadePermissionsFlag",t.checked)})),w=new l({apiOptions:{users:!0,groups:!0,split:!1},placeholder:m("Add user/group"),harmonize:function(e){return e=_(e).map(function(e){return new c.Participant(e)}),_(e).filter(function(e){return!P.get(e.id)})},click:function(e,o){var i={entity:o.get("id"),bits:257,group:2===o.get("type")};_.isNumber(i.entity)?P.add(new j(i)):t.yell("error",m("This is not a valid user or group."))},extPoint:"io.ox/core/permissions/permissions"}),y=_.uniqueId("input"),k=$('<div class="autocomplete-controls">').append($('<div class="form-group">').append($('<label class="sr-only">',{for:y}).text(m("Start typing to search for user names")),w.$el.attr({id:y})));w.render(),_.device("desktop")?(f.getHeader().append(k),f.getFooter().prepend(b)):f.getHeader().append(k,b)}else f.addPrimaryButton("cancel",m("Close"));f.getPopup().addClass("permissions-dialog"),f.on("save",function(){if(!D)return r.reject(),f.idle();i.update(g,{permissions:P.toJSON()},{cascadePermissions:x.get("cascadePermissionsFlag")}).then(function(){P.off(),f.close(),r.resolve()},function(e){f.idle(),t.yell(e),r.reject()})}).on("cancel",function(){P.off(),r.reject()}).show(),n.getList(v,!0,{allColumns:!0}).done(function(){f.getContentNode().idle(),P.reset(_(a.permissions).map(function(e){return new j(e)})),f.getPopup().find('[tabindex="0"]:first').focus()})}catch(e){console.error("Error",e)}}),r}}});