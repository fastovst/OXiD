define("io.ox/core/settings",["io.ox/core/http"],function(t){"use strict";var e=function(t){if(!_.isUndefined(t))try{return JSON.parse(JSON.stringify(t))}catch(e){throw console.error(t,e,e.stack),e}},n=function(t){return _.isArray(t)?t:String(t).split(/\//)},r=function(t,r,i){if(void 0===r)return e(t);for(var o,s=n(r),a=t||{};s.length;){if(o=s.shift(),!(_.isObject(a)&&o in a))return i;a=a[o]}return e(a)},i={},o=function(e,o,s){var a=this,u=!1,c=JSON.parse(JSON.stringify(o||{}));o=o||{},s=s||{},this.get=function(t,e){return r(o,t,e)},this.meta=function(t){return r(s,t,{})},this.isConfigurable=function(t){var e=this.meta(t);return!("configurable"in e)||e.configurable},this.contains=function(t){for(var e,r=n(t),i=o||{};r.length;){if(e=r.shift(),!r.length)return _.isObject(i)&&e in i;if(!_.isObject(i))return!1;i=i[e]}};var f=function(t,e,r){for(var i,s=n(t),a=o||{};s.length&&(i=s.shift(),_.isObject(a));)s.length?a=!!r&&(!_.isObject(a[i])||_.isArray(a[i]))?a[i]={}:a[i]:e(a,i)};this.set=function(t,e,n){var r=$.extend({silent:!1},n);return 1===arguments.length&&_.isObject(t)?(o=t,r.silent||a.trigger("reset",o)):f(t,function(n,i){var o=n[i],s=JSON.stringify(e)!==JSON.stringify(o);void 0===e?delete n[i]:n[i]=e,s&&(r.silent||a.trigger("change:"+t,e,o).trigger("change",t,e,o))},!0),this},this.remove=function(t){return f(t,function(e,n){var r=e[n];delete e[n],a.trigger("remove:"+t).trigger("remove change",t,r)}),this};var l=function(){return require([e+"/settings/defaults"]).then(function(t){o=_.extend({},t,o)})},g=function(t){_(t.changed).each(function(t,e){a.set(e,t,{validate:!0})})};this.createModel=function(t){return ox.debug&&console.warn("createModel is deprecated"),new t(o).on("change",g)},this.stringify=function(){return JSON.stringify(this.get())},this.detach=function(){return u=!0,this},this.load=function(){var n;return ox.rampup.jslobs&&(n=ox.rampup.jslobs[e])?(o=n.tree,s=n.meta,c=JSON.parse(JSON.stringify(o)),l().then(function(){return{tree:o,meta:s}})):ox.online?t.PUT({module:"jslob",params:{action:"list"},data:[e]}).then(function(t){return u?$.when():(o=t[0].tree,s=t[0].meta,c=JSON.parse(JSON.stringify(o)),l())},function(t){return o={},s={},c={},u=!0,console.error("Cannot load jslob",e,t),l()}).then(function(){return a.trigger("load",o,s),{tree:o,meta:s}}):(a.detach(),$.Deferred().resolve({tree:o,meta:s}))},this.reload=function(){return u?$.when():t.PUT({module:"jslob",params:{action:"list"},data:[e]}).then(function(t){return o=t[0].tree,s=t[0].meta,c=JSON.parse(JSON.stringify(o)),l(),a.trigger("reload",o,s),{tree:o,meta:s}})},this.clear=function(){return t.PUT({module:"jslob",params:{action:"set",id:e},data:{}}).done(function(){o={},s={},a.trigger("reset")})},this.isPending=function(){return!!i[e]},this.getAllPendingSettings=function(){return i},this.save=function(){var n,r=function(r){n=t.PUT({module:"jslob",params:{action:"set",id:e},data:r}).done(function(){c=JSON.parse(JSON.stringify(r)),a.trigger("save")}).fail(function(t){ox.debug&&console.error("jslob:set",t)}).always(function(){delete i[e]})},f=_.throttle(r,5e3);return function(t,a){var l=$.extend({force:!1},a);if(u&&console.warn("Not saving detached settings.",e),u||!t&&_.isEqual(c,o))return $.when();var g={tree:t||o,meta:s};return void 0===g.tree?$.when():(i[e]=this,l.force?r(g.tree):f(g.tree),n)}}(),this.saveAndYell=function(t,e){var n=this.save(t,e);return $.extend({debug:!1},e).debug&&n.always(function(){var t=_.isArray(this)?this:[this];_.each(t,function(t){t.state?console.warn("SAVEANDYELL: "+t.state()):n.state&&console.warn("SAVEANDYELL: "+n.state())})}),n.fail(function(t){require(["io.ox/core/notifications"],function(e){var n=t||{type:"error"};e.yell(n)})})},this.merge=function(n){if(u&&console.warn("Not merging/saving detached settings.",e),u||!n&&_.isEqual(c,o))return $.when();var r=n||o;return void 0===r?$.when():(i[e]=this,t.PUT({module:"jslob",params:{action:"update",id:e},data:r}).done(function(){c=JSON.parse(JSON.stringify(r)),a.trigger("save")}).always(function(){delete i[e]}))},_.extend(this,Backbone.Events)};return{load:function(t,e,n){var r=new o(t);r.load().then(function(){n(r)},function(){try{n.error({})}catch(t){console.error(t.message)}requirejs.undef("settings!"+t)})}}}),function(){"use strict";window.define("settings",["io.ox/core/settings"],_.identity)}();