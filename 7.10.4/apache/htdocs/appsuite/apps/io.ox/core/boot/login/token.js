define("io.ox/core/boot/login/token",["io.ox/core/boot/util","io.ox/core/boot/config","io.ox/core/extensions","io.ox/core/session","io.ox/core/http"],function(e,o,n,s,i){"use strict";function t(){return(c=_.url.hash()).tokenSession?(e.debug("Token-based login ...",c.tokenSession),s.redeemToken(c.tokenSession).then(r,function(o){e.debug("Token-based FAIL",o)})):(e.debug("Session-based login ...",c.session),r({session:c.session}))}function r(e){var n=$.Deferred();return ox.session=e.session,ox.secretCookie="true"===(c.secretCookie||_.getCookie("secretCookie")),s.rampup().always(function(){o.user().then(u).then(n.resolve,n.reject)}),n}function u(){if(!(c.user&&c.language&&c.user_id&&c.context_id))return i.GET({module:"system",params:{action:"whoami"}}).then(l);c.locale=c.language,l(c)}function l(o){return e.debug("Token/session-based login DONE",o),s.set({locale:o.locale,session:o.session,user:o.user,user_id:parseInt(o.user_id,10)||0,context_id:o.context_id}),_.url.hash({context_id:null,language:null,login_type:null,ref:null,secretCookie:null,session:null,token:null,user:null,user_id:null}),o}n.point("io.ox/core/boot/login").extend({id:"token",index:200,login:function(o){if(o.hash.tokenSession||o.hash.session)return t().then(function(e){o.stopPropagation(),ox.trigger("login:success",e)},function(){e.debug("Session-based login FAILED",c.session),ox.trigger("login:fail:session-based",o)})}});var c={};return t});