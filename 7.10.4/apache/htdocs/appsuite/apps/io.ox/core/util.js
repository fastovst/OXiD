define("io.ox/core/util",["io.ox/core/extensions","settings!io.ox/core","static/3rd.party/purify.min.js"],function(e,t,n){"use strict";var r=ox.serverConfig.prefix||"/ajax",i=/(\S{30,})/g,a=/(\S{30})/g,o=/([^.,;:-=()]+[.,;:-=()])/,u=new RegExp("^"+r);e.point("io.ox/core/person").extend({id:"default",index:100,draw:function(e){!1!==e.html?this.append(e.html):this.text(e.halo.name)}});var l=/((https?|ftps?):\/\/[^\s"]+)/gim,s={replacePrefix:function(e,t){return e=e||"",t=t||"",e.replace(u,t)},renderPersonalName:function(t,n){var r={name:(t=_.extend({$el:void 0,html:!1,tagName:"span"},t)).full_name||t.display_name||t.name||t.cn||t.email,email:t.email,email1:t.email,user_id:t.user_id};t.contact&&(r.contact=t.contact),n&&n.nohalo&&(t.$el=$("<span>"));var i=new e.Baton({data:n||{},halo:r,html:t.html}),a=t.$el||(r.email||r.user_id?$('<a href="#" role="button" class="halo-link">').attr("title",r.email).data(r):$("<"+t.tagName+">"));return e.point("io.ox/core/person").invoke("draw",a.empty(),i),a},unescapeDisplayName:function(e){for(e=$.trim(e||"");e.length>1&&/^["'\\\s]/.test(e[0])&&e[0]===e.substr(-1);)e=$.trim(e.substr(1,e.length-2));return e=e.replace(/\\"/g,'"'),e=e.replace(/\\{2}/g,"\\")},fixUrlSuffix:function(e,t){return t=t||"",e=e.replace(/([.,;!?<>(){}[\]|]+)$/,function(e,n){return t=n+t,""}),{url:e,suffix:t}},removeQuotes:function(e){return $.trim(e).replace(/^["'\\]+|["'\\]+$/g,"").replace(/\\?"/g,"")},urlify:function(e){return e=(e||"").replace(l,function(e){var t=this.fixUrlSuffix(e);return $('<a target="_blank" rel="noopener">').attr("href",t.url).append(s.breakableHTML(t.url)).prop("outerHTML")+t.suffix}.bind(this)),e=n.sanitize(e,{ALLOW_DATA_ATTR:!1,ALLOWED_TAGS:["a","wbr"],ALLOWED_ATTR:["target","rel","href"],SAFE_FOR_JQUERY:!0}),e=s.injectAttribute(e,"a","rel","noopener")},injectAttribute:function(e,t,n,r){var i=document.createElement("div");return i.innerHTML=e,_(i.getElementsByTagName(t)).each(function(e){e.setAttribute(n,r)}),i.innerHTML},breakableHTML:function(e){var t=String(e||"").replace(i,function(e){return _(e.split(o)).map(function(e){return 0===e.length?"":e.length<30?e+"​":e.replace(a,"$1​")}).join("")});return _(t.split("​")).map(_.escape).join("<wbr>").replace(/\u00a0/g," <wbr>")},breakableText:function(e){var t=String(e||"").replace(/(\S{20})/g,"$1​");return"​"===t[t.length-1]&&(t=t.slice(0,-1)),t},isValidMailAddress:function(){function e(e){if(""===e)return!0;var s=e.lastIndexOf("@");if(s<=0)return!1;var c=e.substr(0,s),d=e.substr(s+1);return!(c.length>64&&c.length>0)&&(!(d.length>255)&&(!(!t.test(c)&&(n.test(c)||i.test(c)||a.test(c)||r.test(c)))&&!!(o.test(d)||u.test(d)||l.test(d))))}var t=/^"[^"]+"$/,n=/@/,r=/["\\,:; ]/,i=/^\./,a=/\.\./,o=/^\[(\d{1,3}\.){3}\d{1,3}\]$/,u=/^\[IPv6(:\w{0,4}){0,8}\]$/i,l=/[a-z0-9]$/i;return function(t){return e($.trim(t))}}(),isValidPhoneNumber:function(){function e(e){return""===e||!n.test(e)&&t.test(e)}var t=/^\+?[0-9 .,;\-/()*#]+$/,n=/^\+\d{0,2}$/;return function(t){return e($.trim(t))}}(),getDeepLink:function(e,t){var n,r="";return void 0===t.folder_id?n="&folder="+encodeURIComponent(t.id):(n="&folder="+encodeURIComponent(t.folder_id),r="&id="+(/^[\d/]+$/.test(t.id)?t.id:encodeURIComponent(t.id))),ox.abs+ox.root+"/#!&app="+e+n+r},getAddresses:function(e){return/^[^,;\s]+$/.test(e)?[e]:(String(e).match(/("[^"]+"|'[^']+'|\w[\w\u00C0-\u024F.!#$%&'*+-/=?^_`{|}~]*)@[^,;\x20\t\n]+|[\w\u00C0-\u024F][\w\u00C0-\u024F\-\x20]+\s<[^>]+>|("[^"]+"|'[^']+')\s<[^>]+>/g)||[]).map(function(e){return e.replace(/^([^"]+)\s</,'"$1" <')})},getShardingRoot:function(){function e(e){for(var t=e.length-1,n=0;t;t--)n+=e.charCodeAt(t);return n}var n=location.host+ox.apiRoot,r=[].concat(t.get("shardingSubdomains",n));return function(t){var i=0;return 0===t.indexOf("//"+n)&&(t=t.substr(n.length+2)),r.length>1&&(i=e(t)%r.length),/^\//.test(t)||(t="/"+t),ox.debug?"//"+n+t:"//"+r[i]+t}}(),getScrollBarWidth:_.memoize(function(){var e=$("<div>").css({visibility:"hidden",width:100,overflow:"scroll"}).appendTo("body"),t=$("<div>").css({width:"100%"}).appendTo(e).outerWidth();return e.remove(),100-t})};return s});