define.async("io.ox/core/sub/subscriptions",["io.ox/core/extensions","io.ox/core/sub/model","io.ox/core/api/sub","io.ox/core/folder/api","io.ox/core/notifications","io.ox/backbone/views/modal","io.ox/keychain/api","gettext!io.ox/core/sub","io.ox/backbone/mini-views","io.ox/oauth/backbone","io.ox/oauth/keychain","io.ox/core/a11y","settings!io.ox/core"],function(e,o,t,i,n,r,s,c,a,d,l,u,p){"use strict";function f(e,o){var t=e.get("entityModule"),n=p.get("folder/"+t),r=c("New Folder");return o.displayName&&"calendar"===t&&(r=c("My %1$s calendar",o.displayName)),o.displayName&&"contacts"===t&&(r=c("My %1$s contacts",o.displayName)),i.create(n,{title:r}).then(function(o){return e.attributes.folder=e.attributes.entity.folder=o.id,e.unset("wantedScopes"),e.save()})}function b(e,o,t){var i=[].concat(t);e.find("div.alert").remove(),_(i).each(function(e){this.prepend($('<div class="alert alert-danger alert-dismissible" role="alert">').append($("<strong>").text(o),$.txt(" "),$("<span>").html(e),$('<button type="button" data-dismiss="alert" class="btn btn-default close">').text("x")))},e)}function h(e,o){var t=e.formDescription[0].options.type;return new d.Account.Model({serviceId:t,displayName:l.chooseDisplayName(e)}).enableScopes(o).save()}var m="io.ox/core/sub/subscribe",v=function(e){e=e||{};var t=new o.Subscription({folder:e.folder,entity:{folder:e.folder},entityModule:e.module});new y({model:t,app:e.app}).render()},g=function(e){return e.substring(e.lastIndexOf(".")+1)},w=function(){var e={calendar:!1,contacts:!1};return _(l.services.models).each(function(o){-1===o.get("availableScopes").indexOf("contacts")&&-1===o.get("availableScopes").indexOf("contacts_ro")||(e.contacts=!0),-1===o.get("availableScopes").indexOf("calendar")&&-1===o.get("availableScopes").indexOf("calendar_ro")||(e.calendar=!0)}),e}(),y=Backbone.View.extend({tagName:"div",initialize:function(e){this.on("subscribe",this.subscribe),this.app=e.app},getServices:function(){var e=this;return t.sources.getAll().then(function(o){var t=[];return _.each(o,function(o){e.model.get("entityModule")===o.module&&t.push(o)}),t=_.filter(t,function(o){var t;return 0===(o.formDescription||[]).length||(o.formDescription=_.filter(o.formDescription,function(o){if("oauthAccount"!==o.widget)return!0;var i=g(o.options.type);return!!_.where(s.getAll(),{serviceId:o.options.type}).filter(function(o){return!e.app.subscription||!_.isArray(e.app.subscription.wantedOAuthScopes)||e.app.subscription.wantedOAuthScopes.reduce(function(e,t){return e&&o.availableScopes.indexOf(t)>=0},!0)}).length||((t=s.isEnabled(i))||console.error("Keys for "+i+" are missing. A needed plugin was not registered in the server config."),t)}),(o.formDescription||[]).length)}),e.services=t,t})},render:function(){var o=this,t=c("Subscribe");"contacts"===this.model.get("entityModule")&&(t=c("Subscribe to address book")),"calendar"===this.model.get("entityModule")&&(t=c("Subscribe to calendar"));var i=new r({title:t,async:!0,help:"ox.appsuite.user.sect.contacts.folder.subscribe.html",width:576});this.getServices().done(function(t){if(o.app.subscription&&_.isArray(o.app.subscription.wantedOAuthScopes)&&o.model.set("wantedScopes",o.app.subscription.wantedOAuthScopes),t.length>0){var n=e.Baton({view:o,model:o.model,data:o.model.attributes,services:t,popup:i,app:o.app});e.point(m+"/dialog").invoke("draw",i.$body,n),i.addCancelButton().addButton({label:c("Add"),action:"add"}).build(function(){this.$footer.find('[data-action="add"]').hide()})}else i.addDescription(c("No subscription services available for this module")),i.addButton({label:c("Cancel"),action:"cancel"});i.open(),t.length<=3&&$(".modal-dialog",i.$el).css("width","440px"),i.on("add",function(){i.$body.find("div.alert").remove(),o.subscribe()})}),this.popup=i},subscribe:function(){var e=this,r=this.popup,s=_(this.services).findWhere({id:this.model.get("source")});if(r.busy(),this.model.set("service",s),this.model.validate(),this.model.errors&&this.model.errors.hasErrors())return this.model.errors.each(function(e){e.length>0&&b(r.$body,c("Error:"),e)}),void r.idle();f(this.model,s).then(function(s){e.model.id||(e.model.id=s),t.subscriptions.refresh({id:s,folder:e.model.get("folder")}).then(function(){return n.yell("success",c("Subscription successfully created.")),r.close(),e.model},function(o){throw r.idle(),b(r.$body,c("Error:"),o.error_html||o.error),t.subscriptions.destroy(s),e.model=e.model.clone(),i.remove(e.model.get("folder")),o}).then(function(e){return e.fetch()}).then(function(e){o.subscriptions().add(e,{merge:!0})}).done(function(){e.app.folder.set(e.model.get("folder"))})},function(o){throw r.idle(),o.error?b(r.$body,c("Error:"),o.error):n.yell({type:"error",headline:c("Error"),message:c("The subscription could not be created.")}),i.remove(e.model.get("folder")),o})}});e.point(m+"/dialog").extend({id:"service",index:100,draw:function(o){_(o.services).each(function(e){/.*(contact|calendar)$/.test(e.id)&&(e.icon=_.last(e.id.split("."),2)[0]),e.id.indexOf("gmx.de")>=0&&(e.icon="gmx"),e.id.indexOf("web.de")>=0&&(e.icon="webde"),"com.openexchange.subscribe.microformats.contacts.http"===e.id&&(e.icon="oxmf")}),o.services=_(o.services).sortBy(function(e){return"com.openexchange.subscribe.microformats.contacts.http"===e.id?1:0}),this.append(new d.Views.ServicesListView({collection:new Backbone.Collection(o.services)}).on("select",function(t){var i=t.get("formDescription"),n=e.Baton({view:o.view,subModel:o.model,model:t,services:o.services,popup:o.popup,app:o.app});o.model.setSource(t.toJSON()),o.popup.$body.find("div.alert").remove(),1===i.length&&"oauthAccount"===i[0].widget?e.point(m+"/oauth").invoke("configure",this,n):e.point(m+"/subscribe").invoke("configure",this,n)}).render().$el)}}),e.point(m+"/oauth").extend({id:"oauth",index:100,configure:function(e){var o=e.model.toJSON();h(o,e.subModel.get("wantedScopes")).then(function(t){e.subModel.setSource(o,{account:parseInt(t.id,10)}),e.view.trigger("subscribe")},function(o){b(e.view.popup.$body,c("Error:"),o)})}}),e.point(m+"/subscribe").extend({id:"subscribe",index:100,configure:function(e){var o=e.model,t=new Backbone.Model,i=o.toJSON();e.popup.$body.empty().append($('<form class="form-horizontal">').append($("<h4>").text(c.format(c("Configure %s"),o.get("displayName"))),_(o.get("formDescription")).map(function(e){var o="password"===e.name?a.PasswordView:a.InputView;return $('<div class="control-group">').append($('<label class="control-label">').attr("for",e.name).text("account"===e.name?c("Account"):e.displayName),$('<div class="controls">').append(new o({model:t,name:e.name,autocomplete:!1}).render().$el))})).on("keydown",function(o){10!==o.which&&13!==o.which||e.view.trigger("subscribe")})),e.popup.$footer.find('[data-action="add"]').show(),e.view.listenTo(t,"change",function(){e.subModel.setSource(i,t.toJSON())})}});var x=$.Deferred();return w.contacts&&w.calendar?x.resolve():t.sources.getAll().then(function(e){w.contacts=w.contacts||_(e).any({module:"contacts"}),w.calendar=w.calendar||_(e).any({module:"calendar"})}).always(x.resolve),x.then(function(){return{availableServices:w,buildSubscribeDialog:v}})});