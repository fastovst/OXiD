define("io.ox/core/sub/model",["io.ox/core/extensions","io.ox/backbone/basicModel","io.ox/core/api/sub","io.ox/settings/util","gettext!io.ox/core/sub"],function(e,t,r,i,n){"use strict";function o(e){var t=String(e.folder_id||e.folder||"");return t?this.filter(function(e){return(e.get("entity")||{folder:e.get("folder")}).folder===t}):this.toArray()}var s,u=t.extend({ref:"io.ox/core/sub/subscription/",url:function(){return this.attributes[this.attributes.source].url},source:function(){return this.attributes[this.attributes.source]},setSource:function(e,t){delete this.attributes[this.attributes.source],this.attributes.source=e.id,this.attributes[this.attributes.source]=t||{}},refreshState:function(){return this._refresh?this._refresh.state():"ready"},performRefresh:function(){return"ready"===this.refreshState()?(r.subscriptions.refresh(this),this._refresh=_.wait(5e3)):this._refresh},syncer:function(e){return{create:function(t){return i.yellOnReject(e.create(t.attributes))},read:function(t){return e.get({id:t.id,folder:t.get("folder")})},update:function(t){return i.yellOnReject(e.update(t.attributes))},destroy:function(t){return i.yellOnReject(e.destroy(t.id))}}}(r.subscriptions)}),c={factory:function(e){return Backbone.Collection.extend({initialize:function(){var t=this;e.on("refresh:all",function(){t.fetch()}),this.on("change:enabled",function(e){e.collection.sort()})},sync:function(t,r){if("read"===t){var i=this;return e.getAll().then(function(e){return _(e).each(function(e){new i.model(e).fetch().then(function(e){return r.add(e)})}),r.each(function(t){t&&0===_(e).where({id:t.id}).length&&r.remove(t)}),r})}},forFolder:o,comparator:function(e){return!e.get("enabled")+String(e.get("displayName")).toLowerCase()}})}}.factory(r.subscriptions).extend({model:u});return e.point("io.ox/core/sub/subscription/validation").extend({validate:function(e,t){var r=e[e.source];if(!r)return t.add(e.source,n("Model is incomplete."));_((e.service||{}).formDescription).each(function(i){i.mandatory&&!r[i.name]&&t.add(e.source,n("%1$s must not be empty.",i.displayName))})}}),{subscriptions:function(){return s||(s=new c),s.fetch(),s},Subscription:u}});