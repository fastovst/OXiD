define("io.ox/core/sockets",["static/3rd.party/socket.io.slim.js","io.ox/core/capabilities"],function(e,o){"use strict";function n(){var e=window.crypto||window.msCrypto;return String(_.now())+e.getRandomValues(new window.Uint32Array(1))[0]}function t(e){try{ox.websocketlog.push({timestamp:_.now(),date:moment().format("D.M.Y HH:mm:ss"),event:e})}catch(e){console.log(e)}}function c(){ox.socketConnectionId=a;var o=$.Deferred();return d&&t("Websocket trying to connect..."),s=e.connect(i+"/?session="+ox.session+"&connection="+a,u),d&&(window.socket=s),s.on("connect",function(){d&&t("Websocket connected!"),r=!0,o.resolve(s)}),s.on("disconnect",function(){d&&t("Websocket disconnected"),r=!1}),s.on("reconnect",function(){d&&t("Websocket was reconnected"),r=!0}),s.on("reconnecting",function(){d&&t("Websocket trying to reconnect")}),s.on("connect_error",function(){d&&t("Websocket connection error"),s.io.backoff.attempts===u.reconnectionAttempts&&(ox.trigger("socket:maxreconnections:reached"),d&&t("Max reconnection attempts for socket reached, stopping reconnection.")),o.reject()}),s.on("connect_timeout",function(){d&&t("Websocket connection timeout"),o.reject()}),s.on("session:invalid",function(){d&&t("Websocket disconnected due to invalid session"),s.connected&&s.close()}),ox.on("relogin:required",function(){d&&t("Websocket disconnected due to invalid session"),s.connected&&s.close()}),ox.on("relogin:success",function(){s.disconnected&&(d&&t("Websocket reconnecting with new session"),s.disconnected&&(ox.socketConnectionId=a=n(),s.io.uri=i+"/?session="+ox.session+"&connection="+a,s.connect()))}),ox.on("logout",function(){d&&t("Websocket disconnected on logout"),s.connected&&s.close()}),o}var s,i=ox.serverConfig.websocketUri?ox.serverConfig.websocketUri:ox.abs,r=!1,d=_.url.hash("socket-debug")||ox.debug,a=n(),u={path:"/socket.io/appsuite",transports:["websocket"],reconnectionAttempts:25,randomizationFactor:0,reconnectionDelay:1e3,reconnectionDelayMax:6e5};return ox.websocketlog=[],{isConnected:r,getSocket:function(){return void 0===s&&Modernizr.websockets&&o.has("websocket")?c():s?$.Deferred().resolve(s):(d&&t("No websocket support, connection not possible."),$.Deferred().reject())}}});