define("io.ox/core/tk/image-util",["io.ox/contacts/widgets/exif"],function(e){function i(e){try{self[e.data.name](e.data.args,function(i,r){if(i)return self.postMessage({id:e.data.id,error:i});self.postMessage({id:e.data.id,result:r})})}catch(i){self.postMessage({id:e.data.id,error:i.toString()})}}function r(e){var r,t=window.URL||window.webkitURL,n=_(e).map(function(e,i){var r=e.toString(),t=e.name||(r.match(/^function\s*([^\s(]+)/)||[])[1];return t&&t!==i?"var "+i+" = "+t+" = "+r:"var "+i+" = "+r}).join("\n")+"\nself.onmessage = "+i.toString();try{r=new Blob([n],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,(r=new window.BlobBuilder).append(n),r=r.getBlob()}this.promises={},this.worker=new Worker(t.createObjectURL(r)),this.worker.addEventListener("message",function(e){var i=e.data,r=i.id;this.promises[r]&&(i.error?this.promises[r].reject(i.error):this.promises[r].resolve(i.result),delete this.promises[r])}.bind(this))}return _.extend(r.prototype,{invoke:function(e,i){var r=_.uniqueId();return this.promises[r]=new $.Deferred,this.worker.postMessage({id:r,name:e,args:i}),this.promises[r].promise()}}),{PromiseWorker:r,getImageFromFile:function(){function i(e,i){var r=new Image;r.onload=function(){i(null,r)},r.onerror=i,r.src=e}var t=new r({getImage:function(e,i){self.createImageBitmap(e).then(function(e){i(null,e)},function(e){i(e)})},readFile:function(e,i){var r=new FileReader;r.onload=function(){i(null,r.result)},r.onerror=i,r.readAsDataURL(e)}}),n=[];return function(r,o){o=_.extend({exif:!1},o);var a=_(n).find(function(e){if(e.file===r&&(!o.exif||e.exif))return!0});if(a)return a.promise;if(!o.exif&&self.createImageBitmap)a=t.invoke("getImage",r);else{var s;a=t.invoke("readFile",r).then(function(n){if(o.exif&&(s=e.getOrientation(n)),self.createImageBitmap)return t.invoke("getImage",r);var a=new $.Deferred;return i(n,function(e,i){e&&a.reject(e),a.resolve(i)}),a}).then(function(e){return s&&(e.exif=s),e})}var f={file:r,exif:o.exif,promise:a};return _.delay(function(){n=_(n).without(f)},1e4),n.push(f),a}}()}});