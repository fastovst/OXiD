define("io.ox/core/tk/wizard",["io.ox/backbone/views/disposable","io.ox/core/tk/hotspot","gettext!io.ox/core"],function(t,i,e){"use strict";function n(t,i){i=i||0;var e=t.offset();return e.width=t.outerWidth()+2*i,e.height=t.outerHeight()+2*i,e.availableWidth=$(window).width(),e.availableHeight=$(window).height(),e.right=e.availableWidth-e.width-e.left+i,e.bottom=e.availableHeight-e.height-e.top+i,e.top-=i,e.left-=i,e}function s(t){return function(){var i=this.$(t);return i.append.apply(i,arguments),this}}function o(t){return function(i,e){return i.append($(t).attr("data-action",e.action).addClass(e.className).text(e.label||"à¨€")),this}}function r(t){return(t=$(t).filter(":visible")).length?t.first():null}function a(t){this.options=t||{},this.currentStep=0,this.steps=[],this.closed=!1,this.options.model=this.options.model||new Backbone.Model,_.extend(this,Backbone.Events),this.on({"step:next":this.next,"step:back":this.back,"step:close":this.close,"step:done":this.close}),this.on("step:hide",function(){_(c).invoke("detach"),l.detach(),i.removeAll()}),$(document).on("click.wizard",".wizard-overlay, .wizard-backdrop",function(){$(".wizard-step:visible").find("button.btn-primary:first").focus()}),this.container=d.clone(),_.device("smartphone")&&h.call(this)}function h(){this.container.find(".wizard-title").text(this.options.title||e("Welcome")),this.container.on("tap","[data-action]",{parent:this},function(t){t.preventDefault();var i=$(this).attr("data-action");t.data.parent.trigger("step:"+i)}),this.options.model.on("change:paused",function(){a.getCurrentStep().toggleNext(!a.isStepPaused())}),this.shift=function(t){this.setCurrentStep(this.currentStep+t),this.withCurrentStep(function(t){t.renderNavBar()});var i=this.container.find(".wizard-pages"),e=i.position().left/n*100,s=0-100*this.currentStep;return i.stop().velocity({translateX:[s+"%",e+"%"]},500,[150,15]),this};var t,i,n,s,o,r,a=this,h=0,c=0;this.container.find(".wizard-pages").on({touchstart:function(t){var e=t.originalEvent.targetTouches;1===e.length&&($(t.target).is("input")?r=!0:(c=e[0].pageX,i=!1,n=$(window).width(),h=$(this).position().left,o=a.hasBack()?+n:+n/3,s=a.hasNext()?-n:-n/3))},touchmove:function(e){var l=e.originalEvent.targetTouches;if(1===l.length&&!r){if(e.preventDefault(),t=l[0].pageX-c,!i){if(Math.abs(t)<20)return;return i=!0,c=l[0].pageX,void(t=0)}t=Math.min(t,o),t=Math.max(t,s),a.isStepPaused()&&(h+t)/n*100<-100||$(this).css("transform","translateX("+(h+t)/n*100+"%)")}},touchend:function(){if(r=!1,i){var e=t/n*100;a.isStepPaused()&&e<0||a.shift(e<0?e>-50?0:1:e<50?0:-1)}}})}var c=[$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay wizard-spotlight abs">')],l=$('<div class="wizard-backdrop abs">'),d=_.device("smartphone")?$('<div class="wizard-container abs">  <div class="wizard-navbar">    <div class="wizard-back"></div>    <div class="wizard-title"></div>    <div class="wizard-next"></div>  </div>  <div class="wizard-pages"></div>  <div class="wizard-animation"></div></div>'):$('<div class="wizard-container abs">');_.extend(a.prototype,{step:function(t){var i=new u(t,this);return this.steps.push(i),i},getCurrentStep:function(){return this.steps[this.currentStep]},withCurrentStep:function(t){var i=this.getCurrentStep();return i&&t.call(this,i),this},setCurrentStep:function(t){this.currentStep!==t&&(t<0||t>=this.steps.length||(this.currentStep=t,this.trigger("change:step")))},get:function(t){return this.steps[t]},getContainer:function(){return this.container},shift:function(t){if(this.withCurrentStep(function(t){t.hide()}),this.isInvalidShift(t))return this.trigger("skip:step"),this.shift(t<0?t-1:t+1);this.setCurrentStep(this.currentStep+t),this.withCurrentStep(function(t){t.show()})},next:function(){return this.hasNext()&&this.shift(1),this},back:function(){return this.hasBack()&&this.shift(-1),this},hasNext:function(){return this.currentStep<this.steps.length-1},hasBack:function(){return this.currentStep>0},close:function(){if(!this.closed)return this.trigger("before:stop"),this.withCurrentStep(function(t){t.hide()}),_(this.steps).each(function(t){t.dispose()}),this.container.remove().empty(),$(document).off("click.wizard"),this.steps=[],this.container=null,this.trigger("stop"),this.off(),this.closed=!0,$("body").removeClass("wizard-open"),this},isInvalidShift:function(t){var i=this.currentStep+(t||0),e=this.get(i);return!!e&&(i!==this.steps.length-1&&e.hasValue())},isStepPaused:function(){var t=this.currentStep;return(this.options.model.get("paused")||[]).indexOf(t)>-1},start:function(){return _.device("smartphone")?(this.trigger("before:start"),_(this.steps).invoke("show"),this.container.appendTo("body"),this.withCurrentStep(function(t){t.renderNavBar()}),this.trigger("start")):(this.trigger("before:start"),this.container.appendTo("body"),this.showFirst(),this.trigger("start")),$("body").addClass("wizard-open"),window.wizard=this,this},showFirst:function(){this.currentStep=0,this.shift(0)},spotlight:function(t,i){if(t){_.isFunction(t)&&(t=t());var e=$(t).filter(":visible");if(e.length){var s=n(e,i?i.padding:0);c[0].css({width:s.left,right:"auto"}),c[1].css({left:s.left,height:s.top,bottom:"auto"}),c[2].css({left:s.left+s.width,top:s.top}),c[3].css({left:s.left,top:s.top+s.height,right:s.right}),c[4].css(_(s).pick("top","right","bottom","left")),$("body").append(c)}}},toggleBackdrop:function(t,i){l.css("backgroundColor",i||""),$("body").append(l.toggle(!!t))}});var u=t.extend({className:"wizard-step center middle",events:{"click [data-action]":"onAction",keydown:"onKeyDown",keyup:"onKeyUp"},onAction:function(t){t.preventDefault();var i=$(t.currentTarget).attr("data-action");t.stopImmediatePropagation(),this.trigger(i)},onKeyDown:function(t){if(9===t.which&&this.$el.is(":visible")){var i=this.$('button[tabindex!="-1"][disabled!="disabled"]:visible'),e=t.shiftKey&&document.activeElement===i.get(0),n=!t.shiftKey&&document.activeElement===i.get(-1);(e||n)&&(t.preventDefault(),i.get(e?-1:0).focus())}},onKeyUp:function(t){function i(t){return $(t.target).is("input, textarea, select")}switch(t.which){case 27:this.$el.find(".wizard-close").length&&this.trigger("close");break;case 37:!i(t)&&this.$el.find('[data-action="back"]:enabled').length&&this.trigger("back");break;case 39:!i(t)&&this.$el.find('[data-action="next"]:enabled').length&&this.trigger("next")}},initialize:function(t,i){this.parent=i,this.options=_.extend({id:void 0,modal:!0,focusWatcher:!0,back:!0,next:!0,enableBack:!0,labelBack:e("Back"),labelDone:e.pgettext("tour","Finish"),attributes:{}},t),this.on("all",function(t){this.parent.trigger("step:"+t,this.parent.currentStep)}),_(["width","minWidth"]).each(function(t){this.options[t]&&this.$el.css(t,this.options[t])},this),_.device("smartphone")||this.once("before:show",this.renderButtons),this.$el.attr(this.options.attributes),this.render()},title:s(".wizard-title"),content:s(".wizard-content"),footer:s(".wizard-footer"),getModel:function(){return this.parent.options.model},getId:function(){return this.options.id},setValue:function(t){return this.getModel.set(this.getId(),t)},getValue:function(){return this.getModel().get(this.getId())},hasValue:function(){return void 0!==this.getValue()},render:function(){return this.$el.attr({role:"dialog",tabindex:-1,"aria-labelledby":"dialog-title"}).append($('<div role="document">').append($('<div class="wizard-header">').append($('<h1 class="wizard-title" id="dialog-title">'),$('<button type="button" class="wizard-close close" data-action="close">').attr("aria-label",e("Close")).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",e("Close")))),$('<div class="wizard-content" id="dialog-content">'),$('<div class="wizard-footer">'))),this},renderButtons:function(){var t=this.getDirections(),i=this.$(".wizard-footer").empty();t.back&&this.addButton(i,{action:"back",className:"btn-default",label:this.getLabelBack()}),t.next&&this.addButton(i,{action:"next",className:"btn-primary",label:this.getLabelNext()}),t.done&&this.addButton(i,{action:"done",className:"btn-primary",label:this.getLabelDone()})},renderNavBar:function(){var t=this.getDirections(),i=this.parent.container.find(".wizard-back").empty(),e=this.parent.container.find(".wizard-next").empty();t.back&&this.addLink(i,{action:"back",label:this.getLabelBack()}),t.next&&this.addLink(e,{action:"next",label:this.getLabelNext()}),t.done&&this.addLink(e,{action:"done",label:this.getLabelDone()}),this.parent.isStepPaused()&&this.toggleNext(!1)},addButton:o('<button type="button" class="btn">'),addLink:o('<a href="#" role="button">'),getLabelNext:function(){return void 0===this.options.labelNext?e(this.isFirst()?"Start tour":"Next"):this.options.labelNext},getLabelBack:function(){return this.options.labelBack},getLabelDone:function(){return this.options.labelDone},getDirections:function(){return{back:this.options.back&&this.parent.hasBack(),next:this.options.next&&this.parent.hasNext(),done:this.options.next&&this.isLast()}},mandatory:function(){return this.$(".wizard-header .wizard-close").remove(),this},toggleNext:function(t){return _.device("smartphone")?this.parent.container.find('[data-action="next"]').attr({disabled:!t,"aria-disabled":!t}):(this.$('.btn[data-action="next"]').prop("disabled",!t),this)},toggleBack:function(t){return this.$('.btn[data-action="back"]').prop("disabled",!t),this},isFirst:function(){return 0===this.parent.currentStep},isLast:function(){return this.parent.currentStep===this.parent.steps.length-1},indexOf:function(){return _(this.parent.steps).indexOf(this)},show:function(){function t(){this.trigger("before:navigate"),ox.launch(this.options.navigateTo.id,this.options.navigateTo.options).done(function(){this.trigger("navigate"),e.call(this,0)}.bind(this))}function e(t){if(0===t&&this.trigger("wait"),_.isFunction(this.options.waitFor.selector)&&(this.options.waitFor.selector=this.options.waitFor.selector()),r(this.options.waitFor.selector))return s.call(this);t<(_.isNumber(this.options.waitFor.timeout)?10*this.options.waitFor.timeout:50)?setTimeout(e.bind(this,t+1),100):(console.error("Step.show(). Stopped waiting for:",this.options.waitFor.selector),this.parent.close())}function n(){_(this.options.hotspot).each(function(t){_.isString(t)&&(t=[t,{}]),i.add(t[0],t[1]||{})},this)}function s(){if(this.$el.addClass("invisible").appendTo(this.parent.container),this.trigger("ready"),this.align(),$(window).on("resize.wizard-step",_.debounce(this.align.bind(this,null),100)),this.options.spotlight?(this.parent.toggleBackdrop(!1),this.parent.spotlight(this.options.spotlight.selector,this.options.spotlight.options),$(window).on("resize.wizard.spotlight",_.debounce(function(){this.parent.spotlight(this.options.spotlight.selector)}.bind(this),100))):this.parent.toggleBackdrop(this.options.modal,this.options.backdropColor),this.options.hotspot&&n.call(this),this.options.scrollIntoView){var t=$(this.options.scrollIntoView);t.length&&t.get(0).scrollIntoView()}this.$el.removeClass("invisible").find('button[tabindex!="-1"][disabled!="disabled"]:visible:last').focus(),this.options.focusWatcher&&(this.focusWatcher=setInterval(function(){$.contains(this.el,document.activeElement)||this.$el.find('button[tabindex!="-1"][disabled!="disabled"]:visible:last').focus()}.bind(this),100)),this.trigger("show")}function o(){return this.$el.css("left",100*this.indexOf()+"%").removeClass("center middle").appendTo(this.parent.container.find(".wizard-pages")),this.trigger("show"),this}return function(){return this.trigger("before:show"),_.device("smartphone")?o.call(this):(this.parent.toggleBackdrop(!0),this.options.navigateTo?t.call(this):this.options.waitFor?e.call(this,0):s.call(this),this)}}(),hide:function(){return this.trigger("before:hide"),_.device("smartphone")||(this.focusWatcher&&clearInterval(this.focusWatcher),$(window).off("resize.wizard.spotlight resize.wizard.hotspot resize.wizard-step"),this.$el.detach()),this.trigger("hide"),this},beforeShow:function(t){return this.once("before:show",t),this},referTo:function(t,i){return this.options.referTo={selector:t,options:i},this},spotlight:function(t,i){return this.options.spotlight={selector:t,options:i},this},hotspot:function(t,i){return _.isFunction(t)&&(t=t()),this.options.hotspot=_.isArray(t)?t:[[t,i]],this.options.backdropColor="rgba(255, 255, 255, 0.01)",this},modal:function(t){return this.options.modal=!!t,this},backdrop:function(t){return this.options.backdropColor=t,this},waitFor:function(t,i){return this.options.waitFor={selector:t,timeout:i},this},navigateTo:function(t,i){return this.options.navigateTo={id:t,options:i},this},scrollIntoView:function(t){return this.options.scrollIntoView=t,this},align:function(t){function i(t,i,e,n){i=Math.min(Math.max(16,i),n-e-16),p.css(t,i)}function e(t){i("left",t,g,f.availableWidth)}function s(t){i("top",t,b,f.availableHeight)}function o(){if(f.left+f.width+g<f.availableWidth)return e(f.left+f.width+16),s(f.top),!0}function a(){if(f.left-g>0)return e(f.left-g-16),s(f.top),!0}function h(){if(f.top+f.height+b<f.availableHeight)return e(f.left),s(f.top+f.height+16),!0}function c(){if(f.top-b>0)return e(f.left),s(f.top-b-16),!0}function l(){p.addClass("center middle").css({top:"",right:"",bottom:"",left:""})}if(t||!this.options){var d,u;if(_.isString(t)?d=r(t):_.isObject(t)&&(d=r(t.selector),u=t.options),d){var p=this.$el,f=n(d),g=p.width(),b=p.height();switch(p.removeClass("center middle").css({top:"auto",right:"auto",bottom:"auto",left:"auto"}),u&&u.position||"right"){case"right":o()||h()||a()||c()||l();break;case"left":a()||h()||o()||c()||l();break;case"bottom":h()||c()||o()||a()||l();break;case"top":c()||h()||o()||a()||l();break;default:l()}return this.trigger("align"),this}}else{if(this.options.referTo)return this.align(this.options.referTo);if(this.options.spotlight)return this.align(this.options.spotlight.selector)}},end:function(){return this.parent}});return a.registry={collection:new Backbone.Collection,add:function(t,i){t.run=i;var e=new Backbone.Model(t);return this.collection.add(e),e},get:function(t){return this.collection.get(t)},list:function(t){return void 0===t?this.collection:this.collection.where({type:t})},run:function(t){var i=this.get(t);i&&i.get("run")()}},a});