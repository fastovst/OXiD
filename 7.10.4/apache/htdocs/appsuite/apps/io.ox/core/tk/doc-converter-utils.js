define("io.ox/core/tk/doc-converter-utils",["io.ox/core/http"],function(e){"use strict";var t={};return t.CONVERTER_MODULE_NAME="oxodocumentconverter",t.MODULE_SOURCE_MAP={1:"calendar",4:"tasks",7:"contacts"},t.getConverterUrl=function(e){if(ox.session&&ox.ui.App.getCurrentApp()){var r=ox.ui.App.getCurrentApp().get("uniqueID"),n=t.CONVERTER_MODULE_NAME;return e=_.extend({session:ox.session,uid:r},e),ox.apiRoot+"/"+n+"?"+$.param(_.omit(e,_.isUndefined))}},t.getEncodedConverterUrl=function(e,r){return t.getConverterUrl(t.getConvertParams(e,r),{encodeUrl:!0})},t.beginConvert=function(e){var r={action:"convertdocument",convert_format:"image",convert_action:"beginconvert"};return t.sendConverterRequest(e,r).then(function(e){return e&&_.isNumber(e.pageCount)?$.Deferred().resolve(e):$.Deferred().reject(e)})},t.endConvert=function(e,r){if(!r)return $.Deferred().reject();var n={action:"convertdocument",convert_action:"endconvert",job_id:r};return t.sendConverterRequest(e,n)},t.sendConverterRequest=function(r,n){if(!r||!ox.ui.App.getCurrentApp())return $.Deferred().reject();var o=t.getConvertParams(r,n),i={module:t.CONVERTER_MODULE_NAME,params:o},u=null,c=null;return i.processResponse=!(!n||!n.processResponse),u=e.GET(i),c=u.then(function(e){return e&&e.cause?$.Deferred().reject(e):$.Deferred().resolve(e)}),_.extend(c,{abort:function(){u.abort()}})},t.getConvertParams=function(e,r){var n=t.getProprietaryParams(e),o={action:"getdocument",documentformat:"pdf",priority:"instant",session:ox.session,filename:e.get("filename"),id:e.get("id"),folder_id:e.get("folder_id"),mimetype:e.get("file_mimetype"),revtag:_.uniqueId("revtag-"),nocache:_.uniqueId()};return ox.ui.App.getCurrentApp()&&(o.uid=ox.ui.App.getCurrentApp().get("uniqueID")),e.has("version")&&(o.version=e.get("version")),_.extend(o,n,r)},t.getProprietaryParams=function(e){var r=e.get("origData"),n=e.get("module"),o=null,i=null,u=null,c=null;return e.isComposeAttachment()?c={source:"compose",id:e.get("spaceId"),attachmentId:e.get("id")}:e.isMailAttachment()?(i=e.get("file_options")?e.get("file_options").params:null,c={id:r.mail.id,source:"mail",attached:e.get("id")},e.isEncrypted()||i&&i.cryptoAuth?(c.decrypt=!0,c.cryptoAuth=i?i.cryptoAuth:"",c.cryptoAction=i?i.cryptoAction:""):(c.cryptoAuth=r.auth?r.auth:"",c.decrypt=Boolean(r&&r.security&&r.security.decrypted))):e.isPIMAttachment()?c={source:t.MODULE_SOURCE_MAP[n],attached:r.attached,module:n}:e.isEncrypted()&&(i=(o=e.get("file_options"))?o.params:null,u=e.get("meta"),c={source:"guard",cryptoAuth:i?i.cryptoAuth:null,cryptoAction:i?i.cryptoAction:null,mimetype:u&&u.OrigMime||e.get("file_mimetype")}),c},t});