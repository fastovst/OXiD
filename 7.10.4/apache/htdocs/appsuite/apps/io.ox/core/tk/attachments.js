define("io.ox/core/tk/attachments",["io.ox/backbone/views/disposable","io.ox/backbone/views/action-dropdown","io.ox/core/api/attachment","io.ox/core/strings","io.ox/core/capabilities","settings!io.ox/core","gettext!io.ox/core","io.ox/core/pim/actions"],function(t,e,a,i,n,o,s){"use strict";return{EditableAttachmentList:function(t){var e=0;_.extend(this,{init:function(){function e(t){t=t||{},a.model.off("create update",e);var i=t.id||a.model.attributes.id,n=a.model.attributes.folder||a.model.attributes.folder_id;_.isString(n)&&(n=(n=n.split("/"))[n.length-1]),n&&i&&a.save(i,n)}var a=this;this.attachmentsToAdd=[],this.attachmentsToDelete=[],this.attachmentsOnServer=[],this.allAttachments=[],this.loadAttachments(),t.noUploadOnSave||this.model.on("create update",e)},finishedCallback:function(t){t.trigger("finishedAttachmentHandling")},render:function(){var t=this;return this.$el.empty(),_(this.allAttachments).each(function(e){t.$el.addClass("io-ox-core-tk-attachment-list clearfix").append(t.renderAttachment(e))}),this.baton.parentView.trigger("attachmentCounterRefresh",this.allAttachments.length),this},renderAttachment:function(t){var e,a,n=this,o=$('<div class="col-lg-6 col-md-6">').append($('<div class="io-ox-core-tk-attachment file">').append($('<i class="fa fa-paperclip" aria-hidden="true">'),$('<div class="row-1">').text(_.ellipsis(t.filename,{max:40,charpos:"middle"})),$('<div class="row-2">').append(e=$('<span class="filesize">').text(i.fileSize(t.file_size||t.size))),a=$('<a href="#" class="remove">').attr("title",s("Remove attachment")).append($('<i class="fa fa-trash-o" aria-hidden="true">'))));return a.on("click",function(){n.deleteAttachment(t)}),"0 B"===e.text()&&e.text(" "),o},loadAttachments:function(){if(1===t.module)return this.attachmentsOnServer=this.model.get("attachments")||[],void this.updateState();var e=this;this.model.id&&a.getAll({module:t.module,id:this.model.id,folder:this.model.get("folder")||this.model.get("folder_id")}).done(function(t){e.attachmentsOnServer=t,e.updateState()})},checkQuota:function(){var t=o.get("properties"),e=this.attachmentsToAdd.reduce(function(t,e){return t+(e.file_size||0)},0),a=t.attachmentMaxUploadSize;a&&a>0&&e>a?this.model.set("quotaExceeded",{actualSize:e,attachmentMaxUploadSize:t.attachmentMaxUploadSize}):this.model.unset("quotaExceeded")},updateState:function(){var t=this;this.allAttachments=_(this.attachmentsOnServer.concat(this.attachmentsToAdd)).reject(function(e){return _(t.attachmentsToDelete).any(function(t){if(!e.newAttachment)return e.managedId?t.managedId===e.managedId:t.id===e.id})}),this.checkQuota(),this.render()},addFile:function(t){this.addAttachment({file:t,newAttachment:!0,cid:e++,filename:t.name,file_size:t.size})},addAttachment:function(t){this.attachmentsToAdd.push(t),this.updateState()},deleteAttachment:function(t){t.newAttachment?this.attachmentsToAdd=_(this.attachmentsToAdd).reject(function(e){return e.cid===t.cid}):this.attachmentsToDelete.push(t),this.updateState()},save:function(t,e){var i=this,n=[],o=0,s={module:this.module,id:t||this.model.id,folder:e||this.model.get("folder")||this.model.get("folder_id")};this.attachmentsToDelete.length&&o++,this.attachmentsToAdd.length&&(o+=2),this.attachmentsToDelete.length&&a.remove(s,_(this.attachmentsToDelete).pluck("id")).fail(function(e){i.model.trigger("backendError",e),n.push(e),--o<=0&&i.finishedCallback(i.model,t,n)}).done(function(){--o<=0&&i.finishedCallback(i.model,t,n)}),this.attachmentsToAdd.length&&a.create(s,_(this.attachmentsToAdd).pluck("file")).fail(function(e){i.model.trigger("backendError",e),n.push(e),(o-=2)<=0&&i.finishedCallback(i.model,t,n)}).done(function(){(o-=2)<=0&&i.finishedCallback(i.model,t,n)}),o<=0&&i.finishedCallback(i.model,t,n),this.attachmentsToAdd=[],this.attachmentsToDelete=[],this.attachmentsOnServer=[],this.allAttachments=[]}},t)},AttachmentList:function(t){var i=this;_.extend(this,{draw:function(n){function o(a,i){1===t.module&&(a=_(a).map(function(t){return t.folder=n.model.get("folder").split("/"),t.folder=t.folder[t.folder.length-1],t.module=1,t.attached=parseInt(n.model.get("id"),10),t}));var o=new e({point:"io.ox/core/tk/attachment/links",title:i||a.filename,data:a});l.append(o.$el)}function d(e,i){var d=function(t){t.length?(_(t).each(function(t){o([t],t.filename)}),t.length>1&&o(t,s("All attachments"))):l.append(s("None"))};(!i||i.module===t.module&&i.id===n.data.id&&i.folder===(n.data.folder||n.data.folder_id))&&(1!==t.module?(l.empty(),a.getAll({module:t.module,id:n.data.id,folder:n.data.folder||n.data.folder_id}).done(d)):d(n.model.get("attachments")))}i.processArguments&&(n=i.processArguments.apply(this,$.makeArray(arguments)));var l=$('<div class="attachment-list">').appendTo(this);a.on("attach detach",d),l.on("dispose",function(){a.off("attach detach",d)}),d()}},t)},fileUploadWidget:function(t){t=_.extend({buttontext:s("Add attachments"),drive:!1,multi:!0},t);var e,a=$("<div>").toggleClass("form-group",!!t.wrapperClass),i=_.uniqueId("form-control-label-"),o=$('<button type="button" class="btn btn-default btn-file">').attr("id",i).text(t.buttontext).append(e=$('<input name="file" type="file" class="file-input" tabindex="-1">').attr("aria-labelledby",i).prop({multiple:t.multi})),d=$('<button type="button" class="btn btn-default" data-action="add-internal">').text(s("Add from Drive"));return e.on("focus",function(){o.addClass("active")}).on("blur",function(){o.removeClass("active")}),t.drive&&_.device("!smartphone")&&n.has("infostore")?a.append($('<div class="btn-group">').append(o,d)):a.append(o),o.on("click keypress",function(t){$(t.target).is("button")&&("click"===t.type||/^(13|32)$/.test(t.which))&&(t.preventDefault(),e.focus(),e.trigger("click"),o.focus())}),a},progressView:t.extend({className:"attachments-progress-view",label:s("Uploading attachments"),initialize:function(t){var e=this;this.objectCid=t.cid,a.on("progress:"+this.objectCid,this.updateProgress.bind(e)),t=t||{},this.label=t.label||this.label,this.callback=t.callback||$.noop},render:function(){return this.$el.append($("<label>").text(this.label),$('<div class="progress">').append(this.progress=$('<div class="progress-bar">'))),this},updateProgress:function(t,e){if(e.total&&this.progress){var a=Math.max(0,Math.min(100,Math.round(e.loaded/e.total*100)));this.progress.css("width",a+"%"),100===a&&this.callback()}},dispose:function(){a.off("progress: + this.objectCid")}})}});