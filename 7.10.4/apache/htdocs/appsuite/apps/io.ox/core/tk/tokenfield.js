define("io.ox/core/tk/tokenfield",["io.ox/core/extensions","io.ox/core/tk/typeahead","io.ox/participants/model","io.ox/participants/views","io.ox/contacts/api","io.ox/core/http","io.ox/core/util","io.ox/contacts/util","gettext!io.ox/core","static/3rd.party/bootstrap-tokenfield.js","css!3rd.party/bootstrap-tokenfield/css/bootstrap-tokenfield.css","less!io.ox/core/tk/tokenfield","static/3rd.party/jquery-ui.min.js"],function(t,e,i,n,o,a,s,l,r){"use strict";$.fn.tokenfield.Constructor.prototype.getTokensList=function(t,e,i){var n=(t=t||this._firstDelimiter)+((e=void 0!==e&&null!==e?e:this.options.beautify)&&" "!==t?" ":""),o=this;return $.map(this.getTokens(i),function(t){if(t.model){var e=t.model.getDisplayName({isMail:o.options.isMail}),i=t.model.getEmail?t.model.getEmail():void 0;return e===i?i:'"'+s.removeQuotes(e)+'" <'+i+">"}return t.value}).join(n)},$.fn.tokenfield.Constructor.prototype.setTokens=function(t,e,i){if(t){e||this.$wrapper.find(".token").remove(),void 0===i&&(i=!0),"string"==typeof t&&(t=this._delimiters.length?s.getAddresses(t):[t]);var n=this;return $.each(t,function(t,e){n.createToken(e,i)}),this.$element.get(0)}};var d=!1;$.fn.tokenfield.Constructor.prototype.blur=function(t){d?this.$input.focus():(this.focused=!1,this.$wrapper.removeClass("focus"),this.preventDeactivation||this.$element.is(document.activeElement)||(this.$wrapper.find(".active").removeClass("active").attr({tabindex:-1,"aria-selected":!1}),this.$firstActiveToken=null),(!this.preventCreateTokens&&this.$input.data("edit")&&!this.$input.is(document.activeElement)||this.options.createTokensOnBlur)&&this.createTokensFromInput(t),this.preventDeactivation=!1,this.preventCreateTokens=!1)},$.fn.tokenfield.Constructor.prototype.keypress=function(t){if(-1!==$.inArray(t.which,this._triggerKeys)&&this.$input.is(document.activeElement)){var e=this.$input.val();if(/^"[^"]*$/.test(e))return;if(e){if(this.$input.data("edit")){var i=this;return void this.$input.one("input",function(){i.createTokensFromInput(t)})}this.createTokensFromInput(t)}return!1}};var u=i.Participant.extend({setPID:function(){u.__super__.setPID.call(this),this.set("pid",this.get("pid")+"_"+_.uniqueId(),{silent:!0})}});return e.extend({className:"test",events:{dispose:"dispose"},initialize:function(i){var o=this;i=_.extend({},{harmonize:function(t){return _(t).map(function(t){var e=new u(t);return{value:e.getTarget({fallback:!0}),label:e.getDisplayName({isMail:i.isMail}).trim()||e.getEmail(),model:e}})},delayedautoselect:!1,allowEditing:!0,createTokensOnBlur:!0,dnd:!0,html:!1,init:!1,customDefaultModel:!1,extPoint:"io.ox/core/tk/tokenfield",leftAligned:!1},i),t.point(i.extPoint+"/token").extend({id:"token",index:100,draw:function(){}}),t.point(i.extPoint+"/autoCompleteItem").extend({id:"view",index:100,draw:function(t){var e=new n.ParticipantEntryView({model:t.model,closeButton:!1,halo:!1,isMail:i.isMail});this.append(e.render().$el)}}),t.point(i.extPoint+"/tokenfield/customize").invoke("customize",this,i),e.prototype.initialize.call(this,i);var a=Backbone.Collection.extend({model:u});this.collection=i.collection||new a,this.collection.comparator=function(t){return t.index||null},this.redrawLock=!1,this.listenTo(this.collection,"reset change:display_name",_.throttle(o.redrawTokens.bind(o),100))},dispose:function(){this.$el.tokenfield("destroy"),this.stopListening(),this.collection=null,this.api=null},register:function(){var e=this;this.$el.tokenfield().parent().on("click mousedown",".token",function(t){var i=$.extend(!0,{},t,{type:"tokenfield:clickedtoken",attrs:$(t.currentTarget).data().attrs,originalEvent:t});e.$el.tokenfield().trigger(i)}),this.options.delayedautoselect&&(e.autoselect={},e.model.on("change:query",function(t,i){e.autoselect[i]&&(e.input.trigger($.Event("keydown",{keyCode:13,which:13})),delete e.autoselect[i])})),this.$el.parent().find(".token-input").on("typeahead:close typeahead:closed",function(){e.$el.trigger("aria-live-update","")}),this.on("typeahead-custom:dropdown-rendered",function(t){var i,n=t.find(".tt-suggestions").children().length;0===n&&(i=r("No autocomplete entries found")),i||(i=r.format(r.ngettext("One autocomplete entry found","%1$d autocomplete entries found",n),n)),e.$el.trigger("aria-live-update",i)}),this.$el.tokenfield().on({"tokenfield:createtoken":function(t){if(!e.redrawLock){if(e.options.customDefaultModel&&!t.attrs.model)return t.preventDefault(),!1;var i,n=e.getInput().data();if(!0===n.edit)return i=/^"(.*?)"\s*(<\s*(.*?)\s*>)?$/.exec(t.attrs.value),_.isArray(i)?t.attrs.label=s.removeQuotes(i[1]):i=["",t.attrs.value,"",t.attrs.value],t.attrs.model=n.editModel.set("token",{label:i[1],value:i[3]}),t.attrs.value=t.attrs.model.cid,void(n.edit=!1);var o=e.hiddenapi.dropdown.getDatumForTopSuggestion();if(!t.attrs.model&&o&&t.attrs.value===o.value&&o.raw&&o.raw.model&&(t.attrs.model=o.raw.model,t.attrs.label=t.attrs.model.getDisplayName({isMail:e.options.isMail})),t.attrs.model||(i=/^"(.*?)"\s*(<\s*(.*?)\s*>)?$/.exec(t.attrs.value),_.isArray(i)?(t.attrs.label=s.removeQuotes(i[1]),t.attrs.value=i[3]):i=["",t.attrs.value,"",t.attrs.value],t.attrs.model=new u({type:5,display_name:i[1],email1:i[3]})),t.attrs.model.has("distribution_list")){a.pause(),l.validateDistributionList(t.attrs.model.get("distribution_list"));var d=_.chain(t.attrs.model.get("distribution_list")).filter(function(t){return!!t.mail}).map(function(t){return t.type=5,new u({type:5,display_name:t.display_name,email1:t.mail}).set("token",{label:t.display_name,value:t.mail},{silent:!0})}).value(),c=t.attrs.model.get("display_name"),p=_(d).map(function(t){return[t.get("token").label+", "+t.get("token").value]});return e.$el.trigger("aria-live-update",1===p.length?r("Added distribution list %s with %s member. The only member of the distribution list is %s.",c,p.length,p.join(", ")):r("Added distribution list %s with %s members. Members of the distribution list are %s.",c,p.length,p.join(", "))),e.collection.add(d),e.redrawTokens(),e.input.data("ttTypeahead").input.$input.val(""),a.resume(),!1}t.attrs.model.set("token",{label:t.attrs.label,value:t.attrs.value},{silent:!0}),t.attrs.value=t.attrs.model.cid;var h;t.attrs.model.get("display_name")?h=t.attrs.model.value&&t.attrs.model.value!==t.attrs.model.get("display_name")?r("Added %1$s, %2$s.",t.attrs.model.get("display_name"),t.attrs.model.value):r("Added %1$s.",t.attrs.model.get("display_name")):t.attrs.model.get("name")&&t.attrs.model.get("detail")?h=r("Added %1$s, %2$s.",t.attrs.model.get("name"),t.attrs.model.get("detail")):t.attrs.model.get("name")&&(h=r("Added %1$s.",t.attrs.model.get("name"))),h&&e.$el.trigger("aria-live-update",h),e.collection.add(t.attrs.model)}},"tokenfield:createdtoken":function(i){if(i.attrs){var n=i.attrs.model||e.getModelByCID(i.attrs.value),o=$(i.relatedTarget),a=o.find(".token-label"),s=n.get("token"),l=s.label&&s.label!==s.value?s.label+" "+s.value:s.value;"0px"===a.css("max-width")&&a.css("max-width","none"),a.attr({"aria-hidden":!0,title:l}),o.attr("aria-label",r("%1$s. Press backspace to delete.",l)),t.point(e.options.extPoint+"/token").invoke("draw",i.relatedTarget,n,i,e.getInput())}},"tokenfield:edittoken":function(t){if(t.attrs&&t.attrs.model){var i=t.attrs.model.get("token");e.getInput().data("editModel",t.attrs.model),t.attrs.value=i.label,i.value!==i.label&&(t.attrs.value=i.label?'"'+s.removeQuotes(i.label)+'" <'+i.value+">":i.value),e.getInput().one("blur",function(){for(var t=e.$el.parent().find(".token"),i=e.getInput().data().editModel.cid,n=!1,o=0;o<t.length;o++)if($(t[o]).data("attrs").value===i)return void(n=!0);n||e.collection.remove(e.getModelByCID(i))})}},"tokenfield:removetoken":function(t){_([].concat(t.attrs)).each(function(t){var i=e.getModelByCID(t.value);if(i){var n;i.get("display_name")?n=i.value&&i.value!==i.get("display_name")?r("Removed %1$s, %2$s.",i.get("display_name"),i.value):r("Removed %1$s.",i.get("display_name")):i.get("name")&&i.get("detail")?n=r("Removed %1$s, %2$s.",i.get("name"),i.get("detail")):i.get("name")&&(n=r("Removed %1$s.",i.get("name"))),n&&e.$el.trigger("aria-live-update",n),e.collection.remove(i)}})}})},render:function(){var t=this.options,i=this;this.$el.addClass("tokenfield").tokenfield({createTokensOnBlur:t.createTokensOnBlur,minLength:t.minLength,delimiter:_.isUndefined(t.delimiter)?void 0:t.delimiter,allowEditing:t.allowEditing,typeahead:i.typeaheadOptions,html:this.options.html||!1,inputType:this.options.inputtype||"email",isMail:t.isMail,minWidth:0}),this.register(),this.input=$(this.$el).data("bs.tokenfield").$input,e.prototype.render.call({$el:this.input,model:this.model,options:this.options}),this.hiddenapi=this.input.data("ttTypeahead");var n=_.extend(this.hiddenapi.dropdown,{onDropdownMouseEnter:function(){d=!0},onDropdownMouseLeave:function(){d=!1}});return(_.browser.IE||_.browser.Edge<79)&&(this.input.off("blur.tt").on("blur.tt",function(){d||(this.resetInputValue(),this.trigger("blurred"))}.bind(this.hiddenapi.input)),n.$menu.on("mouseenter.tt",n.onDropdownMouseEnter.bind(n)).on("mouseleave.tt",n.onDropdownMouseLeave.bind(n))),(_.device("smartphone")||t.leftAligned)&&(this.hiddenapi.dropdown._show=function(){var e="auto",n=0;_.device("smartphone")?(n=-1*i.input.offset().left,e=window.innerWidth):t.leftAligned&&(n=i.input.position().left,n=-1*Math.round(n)+17),this.$menu.css({left:n,width:e}).show()}),this.hiddenapi.input._callbacks.enterKeyed.sync[0]=function(t,e){var i=this.dropdown.getDatumForCursor(),n=this.dropdown.getDatumForTopSuggestion(),o=this.input.getHint();i&&_.isEmpty(o)?(this._select(i),e.preventDefault()):this.autoselect&&n&&(this._select(n),e.preventDefault())}.bind(this.hiddenapi),this.hiddenapi.input.$input.on("keydown",function(t){var e=!!this.hiddenapi.dropdown.getDatumForCursor();32===t.which&&e&&this.hiddenapi._onEnterKeyed("ox.spaceKeyed",t)}.bind(this)),this.options.delayedautoselect&&this.input.on("keydown",function(e){var n=13===e.which,o=32===e.which,a=!!i.input.val()&&i.input.val().length>=t.minLength,s=i.model.get("query")!==i.input.val(),l=38===e.which||40===e.which;!s||n||o||l||(i.hiddenapi.dropdown.empty(),i.hiddenapi.dropdown.close()),n&&a&&s&&(i.autoselect[i.input.val()]=!0)}),this.$el.parent().addClass(this.options.className),this.options.dnd&&this.$el.closest("div.tokenfield").sortable({items:"> .token",connectWith:"div.tokenfield",cancel:"a.close",placeholder:"token placeholder",revert:0,tolerance:"pointer",forcePlaceholderSize:!0,stop:function(t,e){this.isMultisort&&e.item.after($(this).find(".active")),i.resort()},start:function(t,e){e.item.hasClass("active")&&$(this).find(".active").length>1?(_($(this).find(".active")).each(function(t){t!==e.item[0]&&$(t).hide()}),e.item.append($('<span class="drag-counter badge">').text($(this).find(".active").length)),this.isMultisort=!0,this.multisortData=_($(this).find(".active")).map(function(t){return $(t).data().attrs.model})):(this.isMultisort=!1,this.multisortData=[])},receive:function(t,e){var n=e.sender[0].isMultisort?e.sender[0].multisortData:e.item.data().attrs.model;i.collection.add(n),i.resort()},remove:function(t,e){var n=this.isMultisort?this.multisortData:e.item.data().attrs.model;i.collection.remove(n),i.resort()}}).droppable({hoverClass:"drophover"}),this.$el.closest("div.tokenfield").on("copy",function(t){var e=t.target.value.split(", "),n="";_(e).each(function(t){var e=i.collection.get(t);e&&(n=n+(""===n?"":", ")+e.value)}),""!==n&&(t.originalEvent.clipboardData.setData("text/plain",n),t.preventDefault())}),this.getInput().on("focus blur updateWidth",function(t){var e=i.$el.data("bs.tokenfield");e.options.minWidth="focus"===t.type?1:0,e.update()}),this},getModelByCID:function(t){return this.collection.get({cid:t})},redrawTokens:function(){var t=[],e=this;this.redrawLock=!0,this.collection.each(function(i){t.push({label:i.getDisplayName({isMail:e.options.isMail}),value:i.cid,model:i})}),this.$el.tokenfield("setTokens",t,!1),this.redrawLock=!1},resort:function(){var t=this.collection;_(this.$el.tokenfield("getTokens")).each(function(e,i){t.get({cid:e.value})&&(t.get({cid:e.value}).index=i)}),t.sort(),this.redrawTokens()},getInput:function(){return this.input},setFocus:function(){this.$el.parent().find(".token-input").focus()}})});