define("io.ox/core/tk/selection",["io.ox/core/event","io.ox/core/extensions","io.ox/core/collection","io.ox/core/notifications","gettext!io.ox/core","io.ox/core/tk/draghelper"],function(e,t,n,i,a){"use strict";function r(e,t){return e=e.map(function(){return $.trim($(this).attr("title")||$(this).text())}),$.makeArray(e).join(t||"")}function s(e){return r(this.find(".selected .drag-title"),", ")||a.format(a.ngettext("1 item","%1$d items",e.length),e.length)}var o=function(i,a){a=_.extend({draggable:!1,dragMessage:s,dragCssClass:void 0,dragType:"",dropzone:!1,dropzoneSelector:".selectable",dropType:"",scrollpane:i,focus:"[tabindex]",markable:!1},a),this.classFocus="focussed",this.classSelected="selected",e.extend(this);var r,o,c,d,l,u,f,h,g,v,p,m,b,x,z,y,k,C,w,I,S,j,D,M,T,E,q,P,A,F,K,L,Y,R,V=this,X=!0,B=!1,O=".vgrid-cell",U={},H=!0,N=[],G={},J={},Q=J,W=J,Z=$.noop,ee=-1,te=0;if(C=function(e){return!$(e.target).hasClass("not-selectable")},w=function(e){var t=$(e.target).closest(O);return B&&t.length},I=function(e){return X&&e&&(e.metaKey||e.ctrlKey)},S=function(e){return e&&e.shiftKey&&X},Y=function(){return _.size(U)>1},r=function(e){var t=V.get();V.trigger("change",t,e),0===t.length&&V.trigger("empty")},x=function(){var e=V.get();V.trigger("_m_change",e),0===e.length&&V.trigger("empty")},o=function(e,t,n){S(t)?(V.selectRange(W,e),Q=e):(Z(t)?A(e):k(e),Q=W=e,te=j(e)),n?w(t)||R?(t.preventDefault(),x()):o(e,t):r()},M=function(e){if(H&&N.length){var t=N[0].data;v(e),A(t);var n=V.serialize(t);D(n).focus()}},T=function(e,t){if(H&&N.length){var n=N[0];if(v(e),o(n.data,e),V.trigger("select:first",n.data),t){var i=V.serialize(n.data);D(i).focus()}}},E=function(e){if(H){var t,n=j(Q)-1;n>=0&&(t=N[n],v(e),o(t.data,e),V.trigger("select:previous",t.data))}},q=function(e){if(H&&N.length){var t=N.length-1,n=N[t];v(e),o(n.data,e),V.trigger("select:last",n.data)}},P=function(e){if(H){var t,n=j(Q)+1;n<N.length&&(t=N[n],v(e),o(t.data,e),V.trigger("select:next",t.data))}},L=function(e){switch(V.trigger("keyboard",e,e.which),e.which){case 38:if(e.preventDefault(),$(e.target).hasClass("folder-options-badge dropdown-opened"))return;e.metaKey?T(e):E(e);break;case 36:T(e);break;case 35:q(e);break;case 32:if(a.markable){if(e.preventDefault(),!$(e.target).hasClass("marked"))return;k(Q),r()}break;case 40:if(e.preventDefault(),$(e.target).hasClass("folder-options-badge dropdown-opened"))return;e.metaKey?q(e):P(e);break;case 8:case 46:e.preventDefault(),V.trigger("selection:delete",V.get())}},c=function(e){var t,n;e.isDefaultPrevented()||(t=$(this).attr("data-obj-id"),void 0!==(n=H?(N[j(t)]||{}).data:t)&&w(e)&&C(e)&&o(n,e))},d=function(e){var t;e.isDefaultPrevented()||(t=$(this).attr("data-obj-id"),V.trigger("selection:doubleclick",t))},u=function(e){var t,n,i,r;e.isDefaultPrevented()||(n=(t=$(this)).attr("data-obj-id"),i=H?(N[j(n)]||{}).data:n,a.markable&&K(),r=function(){if(void 0!==i&&!w(e)){if(I(e))return void o(i,e);p(i)?Y()&&t.addClass("pending-select"):(S(e)&&W===J&&(W=V.get()[0]||J),v(),o(i,e))}},_.device("!smartphone")?setTimeout(r,50):r())},l=function(e){var t,n,a,r;e.isDefaultPrevented()||(n=(t=$(this)).attr("data-obj-id"),a=H?(N[j(n)]||{}).data:n,r=function(){void 0!==a&&t.hasClass("pending-select")&&C(e)&&(v(),o(a,e)),i.find(".pending-select").removeClass("pending-select")},_.device("!smartphone")?setTimeout(r,50):r())},f=function(e){var t,n;e.isDefaultPrevented()||(t=$(this).attr("data-obj-id"),n=H?(N[j(t)]||{}).data:t,R&&o(n,e,!0))},j=function(e){return H?G[V.serialize(e)]:-1},D=function(e){return $('.selectable[data-obj-id="'+V.serialize(e).replace(/\\\./g,"\\\\.")+'"]',i)},p=function(e){return void 0!==U[V.serialize(e)]},m=function(e,t){var n=V.serialize(e);U[n]=e;var a=t||D(n);return i.has(document.activeElement).length&&a.focus(),g(),a.addClass(V.classSelected).attr({"aria-selected":"true",tabindex:0}).end()},b=function(e,t){e&&(m(e).intoViewport(a.scrollpane),Q=e,ee=j(e),W===J&&(W=e,te=ee),!0!==t&&V.trigger("select",V.serialize(e),e))},z=function(e){var t=V.serialize(e);delete U[t],D(t).removeClass(V.classSelected).attr({"aria-selected":"false",tabindex:-1}),V.trigger("deselect",t),a.markable&&i.find(".marked").length>0?i.find(".marked").attr({tabindex:0}):_.size(U)>0&&D(y()).attr({tabindex:0})},y=function(){return _.last(V.get())},k=function(e){if(p(e)){if(a.markable&&!Y())return;z(e)}else b(e)},h=function(e){if(!i.is(":hidden")){(e=e||!1)&&V.clearIndex();var t=$(".selectable:visible",i),n=0,a=null;for(t.removeClass(V.classSelected);n<t.length;n++){var r=(a=t.eq(n)).attr("data-obj-id");e&&V.addToIndex(r),p(r)&&a.addClass(V.classSelected).attr({"aria-selected":"true"})}}},g=function(){i.find('.selectable[tabindex="0"]').attr({tabindex:-1})},v=function(){U={},i.find(".selectable."+V.classSelected).removeClass(V.classSelected).attr({"aria-selected":"false",tabindex:-1})},a.markable){var ne,ie=v;this.classMarked="marked",Z=function(e){return X&&e&&(38===e.which||40===e.which)&&e.ctrlKey},v=function(e){K(),Z(e)||ie(e)},F=function(e,t){var n=V.serialize(e);ne=e;var a=t||D(n);i.has(document.activeElement).length&&a.focus();var r=a.attr("id")||_.uniqueId("option-");return g(),a.addClass(V.classMarked).attr({tabindex:0,id:r}).parent('[role="listbox"]').attr("aria-activedescendant",r).end()},A=function(e,t){e&&(F(e).intoViewport(a.scrollpane),Q=e,ee=j(e),W===J&&(W=e,te=ee),!0!==t&&V.trigger("mark",V.serialize(e),e))},K=function(){if(ne){var e=V.serialize(ne);ne=void 0,D(e).removeClass(V.classMarked).attr("tabindex",-1).parent('[role="listbox"]').removeAttr("aria-activedescendant"),ne=void 0}}}this.serialize=function(e){return"object"==typeof e?void 0!==e.folder_id?_.cid(e):e.id:e},this.setSerializer=function(e){this.serialize=function(t){return"object"==typeof t?e(t):t}},this.init=function(e){var t=this.get(),n=_.clone(U);v(),N=new Array(e.length),G={},Q=W=J,e.length>0&&(ee=-1);for(var a,s,o=0,c=e.length,d=!0;o<c;o++)a=e[o],s=this.serialize(a),N[o]={data:a,cid:s},G[s]=o,s in n&&d&&(te=ee=o,Q=s,d=!1);return $(".selectable",i).each(function(){var e=$(this);e.attr("data-obj-id")in n?e.addClass(V.classSelected).attr({"aria-selected":"true",tabindex:0}):e.removeClass(V.classSelected).attr({"aria-selected":"false",tabindex:-1})}),U=n,_.isEqual(t,this.get())||r(),this},this.insertAt=function(e,t){var n=e.length,i=[];_(e).reduce(function(e,t){var n=V.serialize(t);return i.push({data:t,cid:n}),e||n in G},!1)||(N.splice.apply(N,[t,0].concat(i)),_(G).each(function(e,i){e>=t&&(G[i]+=n)}),_(e).each(function(e,n){G[V.serialize(e)]=t+n}))},this.remove=function(e){_(e).each(function(e){var t=V.serialize(e),n=G[t];void 0!==n&&N.splice(n,1,null)}),N=_(N).compact(),G={},_(N).each(function(e,t){G[e.cid]=t})},this.update=function(){return h(),this},this.updateIndex=function(){return h(!0),this},this.debug=function(){console.debug("selection",{selected:U,observed:N,index:G})},this.clearIndex=function(){return N=[],G={},this},this.addToIndex=function(e){var t=this.serialize(e);return void 0===G[t]&&(G[t]=N.length,N.push({data:e,cid:t})),this},this.removeFromIndex=function(e){var t={},n=0;_([].concat(e)).each(function(e){t[V.serialize(e)]=!0}),G={},N=_(N).filter(function(e){var i=e.cid;return!(i in t)&&(G[i]=n++,!0)})},this.hasIndex=function(e){return H=!!e,this},this.getObservedItems=function(){return G},this.setMultiple=function(e){return X=!!e,this},this.setEditable=function(e,t){return B=!!e,O=t||".vgrid-cell",Q=W=J,ee=-1,this},this.get=function(){var e=[],t="";for(t in U)e.push(U[t]);return e},this.unique=function(e){e=e||this.get();var t={};return _(e).filter(function(e){var n=_.isString(e)?e:_.cid(e);return!(n in t)&&(t[n]=!0)})},this.unfold=this.get,this.clear=function(e){return v(),!0!==e&&(V.trigger("clear"),r()),this},this.focus=function(){if(!$.contains(i,document.activeElement)){if(0===this.get().length)return this.selectFirst(!0);var e=this.serialize(_.last(this.get()));D(e).focus()}},this.select=function(e){return b(e),r(),this},this.deselect=function(e){return z(e),r(),this},this.set=function(e,t){var n=this.get(),s=this,o={},c=!0;return v(),ee=-1,$(".selectable",i).each(function(){var e=$(this),t=e.attr("data-obj-id");o[t]=e}),_(!e||_.isArray(e)?e:[e]).each(function(e,t){var n,i,r=s.serialize(e);r in o?(i="string"==typeof e&&H&&void 0!==(n=N[j(e)])?m(n.data,o[r]):m(e,o[r]),0===t&&i.intoViewport(a.scrollpane)):U[r]=e,c&&(ee=j(r),Q=r,c=!1)}),o=null,_.isEqual(_(n).map(s.serialize),_(this.get()).map(s.serialize))||!0===t||r(),this},this.equals=function(e){return _.isEqual(e,this.get())},this.selectRange=function(e,t){var n,i,a;if(H){for(a=(e=j(e))>(t=j(t)),n=e;a?n>=t:n<=t;a?n--:n++)i=N[n],n===t?b(i.data):U[i.cid]=i.data;this.update()}return this},this.markFirst=function(){return M(),this},this.selectFirst=function(e){return T(null,e),this},this.selectLast=function(){return q(),this},this.selectSmart=function(){return 0===this.get().length&&this.selectFirst(),this},this.selectNext=P,this.selectAll=function(){if(H&&N.length){for(var e,t=0,n=N.length;t<n;t++)e=N[t],0===t||t===n-1?b(e.data,!0):U[e.cid]=e.data;this.update(),R?x():r()}},this.resetLastIndex=function(){te=-1},this.setLastIndex=function(e){return W=e,te=j(e),this},this.selectIndex=function(){var e=N[te];void 0!==e&&this.select(e.data)},this.selectLastIndex=function(){if(-1!==te){var e=N[te]||_.last(N);void 0!==e&&this.select(e.data)}},this.isSelected=function(e){return p(e)},this.getIndex=function(e){return j(e)},this.isEmpty=function(){return _.isEmpty(U)},this.contains=function(e){var t=[].concat(e);return!!t.length&&_(t).inject(function(e,t){return t=_.isObject(t)?V.serialize(t):t,e&&t in G},!0)},this.getLastIndex=function(){return te},this.keyboard=function(e,t){return $(e)[t?"on":"off"]("keydown",L),this},this.retrigger=function(e){if(e){var t=this.get();this.clear(),this.set(t)}else R?x():r()},this.retriggerUnlessEmpty=function(){this.get().length&&r({retriggerUnlessEmpty:!0})},this.destroy=function(){this.clear(),this.keyboard(!1),this.events.destroy(),i.off("mousedown mouseup contextmenu"),U=N=G=Q=null},this.setMobileSelectMode=function(e){R=e},this.getMobileSelectMode=function(){return R},i.on("contextmenu",function(e){e.preventDefault()}).on("mousedown",".selectable",u).on("mouseup",".selectable",l).on("click",".selectable",c).on("dblclick",".selectable",d).on("tap",".selectable",f).on("focus",".selectable",function(){i.addClass("has-focus")}).on("blur",".selectable",function(){_.delay(function(){0===i.find(":focus").length&&(i.removeClass("has-focus"),a.markable&&(K(),D(y()).attr({tabindex:0}),y()&&(Q=y())))},10)}),function(){function e(e){C=e.pageX+x,w=e.pageY+z,(I(y-C)>=5||I(k-w)>=5)&&(p.left=C+"px",p.top=w+"px",y=C,k=w)}function r(){i.trigger("selection:dragstart")}function s(){this.trigger("click")}function o(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(this).find(".folder-arrow");$(this).addClass("dnd-over"),t.length&&(clearTimeout(m),m=setTimeout(s.bind(t),1500))}}function c(){clearTimeout(m),$(this).removeClass("dnd-over")}function d(n){$(document).off("mousemove.dnd",d),b=$('<div class="drag-helper">'),t.point("io.ox/core/tk/draghelper").invoke("draw",b,new t.Baton({container:i,data:g,source:v,dragMessage:a.dragMessage})),p=b[0].style,y=k=C=w=0,e(n),b.appendTo(document.body),$(document).on("mousemove.dnd",e).one("mousemove.dnd",r).on("mouseover.dnd",".folder-tree",S.over).on("mouseout.dnd",".folder-tree",S.out).on("mousemove.dnd",".folder-tree",S.move).on("mouseover.dnd",".selectable",o).on("mouseout.dnd",".selectable",c)}function l(){null!==b&&(b.remove(),b=p=null)}function u(){S.out(),$(document).off("mousemove.dnd mouseup.dnd mouseover.dnd mouseout.dnd"),$(".dropzone").each(function(){var e=$(this),t=e.attr("data-dropzones");(t?e.find(t):e).off("mouseup.dnd")}),$(".dnd-over").removeClass("dnd-over"),i.trigger("selection:dragstop"),null!==b&&l()}function f(e){if(!e.isDefaultPrevented()){e.preventDefault(),clearTimeout(m);var n=$(this).attr("data-obj-id")||$(this).attr("data-cid")||$(this).attr("data-id"),i=new t.Baton({data:g,dragType:a.dragType,dropzone:this,target:n});$(this).trigger("selection:drop",[i])}}function h(e){var t=Math.abs(e.pageX-e.data.x),i=Math.abs(e.pageY-e.data.y);if(t>15||i>15){if(0===(g=V.unique(V.unfold())).length){var a=v.attr("data-obj-id");g=a?[_.cid(a)]:[]}var r=new n(g);r.getProperties(),r.isResolved()&&!r.has("delete")?$(document).off("mousemove.dnd mouseup.dnd"):($(".dropzone").each(function(){var e=$(this),t=e.attr("data-dropzones");(t?e.find(t):e).on("mouseup.dnd",f)}),$(document).off("mousemove.dnd").on("mousemove.dnd",d))}}var g,v,p,m,b=null,x=15,z=15,y=0,k=0,C=0,w=0,I=Math.abs,S=function(){var e=0,t=null;return{move:function(t){e=t.pageY-$(this).offset().top},out:function(){clearInterval(t),t=null},over:function(){if(!t){var n=this.clientHeight;t=setInterval(function(){var t=Math.round(e/n*10)-5,i=t<0?-1:1,a=Math.abs(t);a>2&&(this.scrollTop+=i*(a-2)*2)}.bind(this),5)}}}}();_.device("!touch")&&(a.draggable&&i.on("mousedown.dnd",".selectable",function(e){if(e.preventDefault(),v=$(this),$(document).on("mousemove.dnd",{x:e.pageX,y:e.pageY},h).on("mouseup.dnd",u),!_.browser.IE){var t=$(e.target).closest(a.focus);(a.focus&&t.length?t:i).focus()}}),a.dropzone&&i.addClass("dropzone").attr("data-dropzones",a.dropzoneSelector).on("drop",function(e,t){t.dropType=a.dropType,V.trigger("selection:drop",t)}))}()};return o.extend=function(e,t,n){return e.selection=new o(t,n||{})},o});