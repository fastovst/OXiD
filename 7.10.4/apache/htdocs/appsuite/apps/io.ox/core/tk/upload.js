define("io.ox/core/tk/upload",["io.ox/core/event","io.ox/core/extensions","io.ox/core/notifications","io.ox/core/folder/api","io.ox/core/api/filestorage","gettext!io.ox/core","less!io.ox/core/tk/upload.less"],function(e,o,t,r,n,i){"use strict";function s(e){return e.originalEvent&&e.originalEvent.dataTransfer&&(_.browser.Firefox&&"dragleave"!==e.type?"none"!==e.originalEvent.dataTransfer.dropEffect:"none"===e.originalEvent.dataTransfer.dropEffect)&&(_(e.originalEvent.dataTransfer.types).contains("Files")||_(e.originalEvent.dataTransfer.types).contains("application/x-moz-file"))}function a(o){require(["less!io.ox/core/tk/upload"]);var r,n,a=this,l=$('<div class="abs io-ox-dropzone-multiple-overlay">').on("click",c),d=function(e){if(s(e)&&!($("body > .io-ox-dialog-wrapper").length>0))return clearTimeout(n),$("body").addClass("io-ox-dropzone-active").append(l),!1},c=function(){return $("body").removeClass("io-ox-dropzone-active"),l.detach(),!1},p=function(){var e=$('<div class="io-ox-dropzone-action">');return l.append(e),e};e.extend(this),_(o.actions||[]).each(function(e){var n=p();n.append($('<div class="dropzone">').on({dragenter:function(){r&&r.removeClass("io-ox-dropzone-hover"),r=n,n.addClass("io-ox-dropzone-hover")},dragleave:function(e){_.browser.IE?$(e.target).hasClass("dropzone")||$(e.target).hasClass("dndignore")||n.removeClass("io-ox-dropzone-hover"):n.removeClass("io-ox-dropzone-hover")},drop:function(n){var s,l=(n=n.originalEvent||n).dataTransfer.files;if(r&&r.removeClass("io-ox-dropzone-hover"),_.browser.Chrome&&_.browser.Chrome>21){var d=n.dataTransfer.items;for(s=0;s<d.length;s++)if(d[s].webkitGetAsEntry().isDirectory)return t.yell("error",i("Uploading folders is not supported.")),c(n),!1}if("importEML"===o.actions[0].id)for(s=0;s<l.length;s++)if(!/(\.eml)$/i.test(l[s].name))return t.yell("error",i("Mail was not imported. Only .eml files are supported.")),c(n),!1;for(s=0;s<l.length;s++)"mailAttachment"===o.actions[0].id?a.trigger("drop",l[s]):a.trigger("drop",e.id,l[s],e);return a.trigger("drop-multiple",e,$.makeArray(l)),c(n),!1}}).append($('<span class="dndignore">').html(e.label)))});var h=!1;this.remove=function(){h&&(h=!1,$(document).off("dragenter",d).off("drop",c),l.off("dragenter dragover dragend dragleave drop"))},this.include=function(){h||(h=!0,$(document).on("dragenter",d),l.on({dragenter:function(){return clearTimeout(n),!1},dragover:function(e){return clearTimeout(n),e.preventDefault(),!1},dragleave:function(e){n=setTimeout(function(){c(e)},200),e.stopPropagation()},drop:function(e){return e.preventDefault(),c(e),!1}}))}}function l(){this.enabled=!1,this.bind=$.noop,this.unbind=$.noop,this.remove=$.noop,this.include=$.noop}function d(o){o?o.progress||console.warn('The delegate to a queue should implement a "progress" method!'):console.warn("No delegate supplied to file processing queue."),o=_.extend({start:$.noop,stop:$.noop,changed:$.noop,progress:function(){return $.when()},type:!1},o||{}),e.extend(this);var n=[],i=0,s=!1;this.next=function(){if(!s){if(0===n.length||n.length<=i)return this.stop();s=!0;var e=this;0===i&&this.start(),this.progress().always(function(o){o&&o.error&&(/^(FLS-0024|OX-0023|OX-0507)$/.test(o.code)||o.error_params&&o.error_params.length&&/^429 /.test(o.error_params[0]))?e.stop():(s=!1,i++,e.queueChanged())})}},this.validateFiles=function(e,n){return n.folder&&"importEML"!==o.type?r.get(n.folder).then(function(o){return r.is("infostore",o)?require(["io.ox/core/api/quota"]).then(function(t){return t.checkQuota(o,e)}):$.when([])}).then(function(o){return 0===o.length?[]:require(["io.ox/core/tk/upload-problems"]).then(function(t){return t.report(e,o)})},function(e){return t.yell(e),$.Deferred().reject([e])}):$.when([])},this.offer=function(e,o){var t=this,r=[].concat(e);this.validateFiles(r,o).then(function(){_(r).each(function(e){n.push({file:e,options:o})}),t.queueChanged()})},this.length=0,this.remove=function(e){n.splice(e,1),e===i&&i--},this.queueChanged=function(){this.length=n.length,o.changed(n[i],i,n),this.trigger("changed",n[i],i,n),this.next()},this.dump=function(){console.info("this",this,"file",n[i],"position",i,"files",n)},this.start=function(){ox.autoLogout.stop(),o.start(n[i],i,n),this.trigger("start",n[i],i,n)},this.progress=function(){var e=o.progress(n[i],i,n);return this.trigger("progress",e,n[i],i,n),e},this.stop=function(){ox.autoLogout.start(),o.stop(n[i],i,n),this.trigger("stop",n[i],i,n),n=[],i=0,s=!1}}var c=Backbone.DisposableView.extend({className:"abs dropzone-overlay",initialize:function(e){require(["less!io.ox/core/tk/upload"]),this.options=_.extend({point:"",app:void 0,scrollable:".scrollable"},e),this.actions=[];var t=o.point(e.point);t.each(function(e){t.isEnabled(e.id)&&this.actions.push(e)}.bind(this)),this.listenToDOM(document,"dragover",this.toggleOverlay.bind(this,!0)),this.listenToDOM(document,"dragleave drop mouseout",this.toggleOverlay.bind(this,!1))},events:{dragenter:"onDragEnter",dragover:"onDragOver",dragleave:"onDragLeave",drop:"onDrop"},toggleOverlay:function(e,o){"mouseout"!==o.type&&this.$el.hasClass("locked")||(s(o)||this.$el.hasClass("visible"))&&this.$el.toggleClass("visible",e).css(this.getDimensions())},getDimensions:function(){var e=this.$el.closest(this.options.scrollable),o=e.scrollTop(),t=e.outerHeight(),r=e.children().outerHeight();return{top:o,bottom:Math.max(0,r-t-o)}},show:function(){this.$(".dropzone-floating").addClass("visible"),this.$el.closest(this.options.scrollable).addClass("scrollable-disabled")},hide:function(){this.$el.removeClass("locked"),this.$(".dropzone-floating").removeClass("visible"),this.$el.closest(this.options.scrollable).removeClass("scrollable-disabled")},render:function(){return this.$el.append($('<div class="abs dropzone-floating">').append(_.map(this.actions,function(e){return $('<div class="dropzone-floating-action dropzone">').attr({"data-id":e.id}).append($('<span class="dndignore">').html(e.label))}))),this},onDragEnter:function(e){if(($(e.target).hasClass("dndignore")?$(e.target).parent():$(e.target)).addClass("hover"),$(e.target).hasClass("dropzone-overlay")){if(!s(e))return;return $(e.target).addClass("locked"),this.show()}$(e.target).hasClass("dropzone-floating")&&(!s(e)||$("body > .io-ox-dialog-wrapper").length>0||this.show())},onDragLeave:function(e){($(e.target).hasClass("dndignore")?$(e.target).parent():$(e.target)).removeClass("hover"),_.defer(function(){this.$(".hover").length||this.$el.hasClass("hover")||this.hide()}.bind(this))},onDrop:function(e){var o,r=(e=e.originalEvent||e).dataTransfer.files,n=$(e.target).closest(".dropzone-floating-action").attr("data-id"),s=_.findWhere(this.actions,{id:n});if(!s)return this.hide();if(_.browser.Chrome){var a=e.dataTransfer.items;for(o=0;o<a.length;o++)if(a[o].webkitGetAsEntry().isDirectory)return t.yell("error",i("Uploading folders is not supported.")),!1}return s.action&&_.each(r,function(e){s.action.apply(s.extension,[e].concat(this.options.app))}.bind(this)),s.multiple&&s.multiple.apply(s.extension,[r].concat(this.options.app)),this.hide(),!1},onDragOver:function(e){return e.preventDefault(),!1}});return{dnd:{enabled:_.device("!touch"),createDropZone:function(e){return e=e||{},this.enabled?new a(e):new l(e.node)},FloatingDropzone:c},createQueue:function(e){return new d(e)}}});