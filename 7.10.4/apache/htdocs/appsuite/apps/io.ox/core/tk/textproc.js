define("io.ox/core/tk/textproc",["settings!io.ox/mail","static/3rd.party/purify.min.js"],function(e,t){"use strict";function r(e,t){var r,n=$(t),i=t.tagName,a=n.children(),c=!0;if("DIV"===i&&n.attr("id")&&-1!==n.attr("id").indexOf("ox-text-p")&&(c=!1),n.removeAttr("id title alt rel"),/^(BR|HR|IMG)$/.test(i))return e;if(n.attr("align")&&n.css("textAlign",n.attr("align")).removeAttr("align"),n.contents().each(function(){3===t.nodeType&&(t.nodeValue=t.nodeValue.replace(/:$/,": "))}),0===a.length)if(""===(r=n.text().match(/^[ \u00A0\t]$/)?n.text:$.trim(n.text()))){if("TD"!==i)return n.remove(),!1;n.text(" ")}else{if(/^(SPAN|SMALL|PRE)$/.test(i)&&!n.attr("class")&&!n.attr("style"))return n.replaceWith($.txt(n.text())),!1;/^".+"$/.test(r)&&n.text(r.replace(/^"/,"“").replace(/"$/,"”"))}else if("DIV"===i&&!n.attr("class")&&!n.attr("style")&&c)return a.eq(0).unwrap(),!1;return e}function n(){$(this).children().first().unwrap()}function i(){var e=$(this);e.replaceWith($("<em>").text(e.text()))}function a(){var e,t=$(this);t.attr("href")?(t.removeAttr("title target"),/^\[\d+\]$/.test(t.text())&&/^#/.test(t.attr("href"))&&(e=String(t.text()).match(/^\[(\d+)\]$/),t.replaceWith($("<sup>").text(e[1]).add($.txt(" "))))):t.replaceWith(t.contents())}function c(){var e=$(this);e.removeAttr("width").attr({border:"0",cellSpacing:"0",cellPadding:"0"}).css({lineHeight:"1em",margin:"0.5em auto 0.5em auto"}),e.find("th").css({fontWeight:"bold",textAlign:"center",borderBottom:"1px solid #555",padding:"0.4em 1em 0.4em 1em"}),e.find("td").css({borderBottom:"1px solid #aaa",padding:"0.4em 1em 0.4em 1em"}),e.find("tr").first().find("td, th").css({borderTop:"1px solid #555"}),e.find("tr").last().find("td, th").css({borderBottom:"1px solid #555"})}function s(){var e=$(this),t=e.attr("style"),r=$("<div>");t&&r.attr("style",t),e.replaceWith(r.append(e.contents()),$("<div><br></div>"))}return{paste_preprocess:function(e,t){t.content=t.content.replace(/<!--(.*?)-->/g,"")},paste_postprocess:function(e,t){var o,u=$(t.node);u.find("iframe, object, applet, input, textarea, button, select, canvas, script, noscript, audio, video, img").filter(":not("+["img.emoji",'img[src*="'+ox.abs+ox.root+'/api/file"]','img[src*="'+ox.root+'/api/file"]','img[src*="'+ox.abs+ox.root+'/api/image"]','img[src*="'+ox.root+'/api/image"]','img[data-pending="true"]'].join(", ")+")").remove(),u.find("sup").css("lineHeight","0"),u.find("article, header, footer, section, form").each(n),u.find("a").each(a),u.find("code").each(i);do{o=_(u.find("*")).inject(r,!0)}while(!o);u.find("table").each(c),u.find("p").each(s)},htmltotext:function(e){function r(e,t){return o(_(e.childNodes).map(n.bind(null,t)).join(""))}function n(e,t,r,n){if(3===t.nodeType){if(e.preserveWhitespace)return t.nodeValue;var o=t.nodeValue;return(0===r||s(n[r-1]))&&(o=o.replace(/^\s+/g,"")),(r===n.length-1||s(n[r+1]))&&(o=o.replace(/\s+$/g,"")),o.replace(/[\n\t]/g," ").replace(/\s{2,}/g," ")}return i(t,r,n.length)||c(t,a(t,e))}function i(e,t,r){switch(e.nodeName){case"BR":var n=t===r-1,i=1===r;return 0===t&&i||n?"​":"";case"HR":return"\0------------------------------\0";case"INPUT":switch(e.getAttribute("type")){case"checkbox":case"radio":return"["+(e.hasAttribute("checked")?"X":" ")+"]";default:return"["+(e.getAttribute("value")||"")+"]"}}}function a(e,t){var n=r(e,{preserveWhitespace:t.preserveWhitespace||"PRE"===e.nodeName});switch(e.nodeName){case"DIV":return e.classList.contains("io-ox-signature")?"\0"+n+"\n":n;case"A":var i=e.getAttribute("href");return/^https?:\/\//i.test(i)?n&&n!==i?n+" ("+i+")":i:n;case"BLOCKQUOTE":return n.replace(/^/gm,"> ").replace(/\u0001/gm,"\n> ");case"UL":return n.replace(/^/gm,"  ");case"OL":var a=parseInt(e.getAttribute("start")||"1",10);return n.replace(/^\* /gm,function(){return"  "+a+++". "});case"LI":return"* "+n.replace(/\u0001/g,"\n  ");case"TD":return n+"\t";case"H1":case"H2":case"H3":return"\n"+n;default:return n}}function c(e,t){return s(e)?"\0"+t+"\0":t}function s(e){return/^(P|DIV|BLOCKQUOTE|UL|OL|LI|PRE|H\d|DL|ADDRESS|FIELDSET|FORM|NOSCRIPT|SECTION|TABLE|TR)$/.test(e.nodeName)}function o(e){return e.replace(/(^\0+|\0+$)/g,"").replace(/\0\0?/g,"\n")}return function(e){return e.replace(/\u200B/g,"").replace(/\u0001+/g,"\n")}(r(t.sanitize(e,{FORBID_TAGS:["STYLE","SCRIPT","TITLE"],ALLOWED_ATTR:["href","type","value","checked","start","class"],RETURN_DOM:!0}),{}))}}});