define("io.ox/core/tk/attachmentsUtil",["io.ox/core/strings","io.ox/preview/main","io.ox/core/capabilities","io.ox/core/extensions","gettext!io.ox/core"],function(e,t,i,a,n){"use strict";var r,s=function(e){var t;return e.disp&&"attachment"===e.disp?t={type:e.type||e.content_type||"",module:"mail",group:e.type?"file":"reference"}:e.content_type&&"message/rfc822"===e.content_type?t={type:"eml",module:"mail",group:"reference"}:e.display_name||e.email1?t={type:"vcf",module:"contacts",group:"reference"}:e.id&&e.folder_id?t={type:e.type||e.content_type||"",module:"infostore",group:"reference"}:e instanceof $&&"INPUT"===e[0].tagName?t={type:e.val().split(".").length>1?e.val().split(".").pop():"",module:"mail",group:"input"}:window.File&&e instanceof window.File&&(t={type:e.type||e.content_type||"",module:"any",group:"file"}),t||{}},p=function(e,t){return r.hasPreview(e)?$('<a href="#" class="attachment-preview">').data({file:e,rightside:t}).text(n("Preview")):$()},o=function(e,t,i){"text/plain"===i?e.css({width:"100%",height:"100%"}).append($("<div>").css({width:"100%",height:"100%"}).html(_.escape(t).replace(/\n/g,"<br>"))):e.css({width:"100%",height:"100%"}).append($("<div>").css({width:"100%",height:"100%",backgroundImage:"url("+t+")",backgroundRepeat:"no-repeat",backgroundPosition:"center center",backgroundSize:"contain"}))};return r={get:function(e,t){var i=e.file?e.file:e,a=s(i);return t?a[t]:a},hasPreview:function(e){var a=r.get(e),n=/^image\/(png|gif|jpe?g|bmp)$/i.test(a.type),s=/^text\/(plain)$/i.test(a.type),p=!1;return i.has("text")&&(p=e.file?new t.Preview({mimetype:e.file.content_type,filename:e.file.filename}).supportsPreview():new t.Preview({mimetype:e.content_type,filename:e.filename}).supportsPreview()),"eml"===a.type?new t.Preview({mimetype:"message/rfc822",parent:e.parent}).supportsPreview():"input"!==a.group&&("reference"===a.group||(!(!window.FileReader||!n&&!s)||(!!p||(/(png|gif|jpe?g|bmp)$/i.test(a.type)||/(txt)$/i.test(a.type)))))},node:function(t,i){var r,s,o,l=this,d=$.extend({showpreview:!0,rightside:$(),labelmax:30},i),f=t.name||t.filename||t.subject||" ",c=t.file_size||t.size||0;if(c=0!==c?n.format("%1$s  ",e.fileSize(c)):"","vcard"!==t.group?(r=$('<i class="fa fa-paperclip" aria-hidden="true">'),s=$('<span class="filesize">').text(c)):(r=$('<i class="fa fa-list-alt" aria-hidden="true">'),s=$('<span class="filesize">').text("vCard "),f=t.file.display_name||t.file.email1||""),o=$("<div>").addClass(this.itemClasses).append($('<div class="item file">').addClass(this.fileClasses).append(r,$('<div class="row-1">').text(_.ellipsis(f,{max:d.labelmax,charpos:"middle"})),$('<div class="row-2">').append(s,d.showpreview?p(t.file,d.rightside):$(),$.txt(" ")),$('<a href="#" class="remove">').attr("title",n("Remove attachment")).append($('<i class="fa fa-trash-o" aria-hidden="true">')).on("click",function(e){e.preventDefault(),"remove"in l||console.error("Caller should provide a remove function."),l.remove(t)}))),i.ref){var m=JSON.parse(JSON.stringify(t));m.name=f,m.size=c,a.point(i.ref).invoke("customize",o,m)}return o},preview:function(e,i,a){i.preventDefault();var n,s,p=a.data("file"),l=r.get(p);a.data("rightside")&&(a.data("rightside")||$()).find("iframe").contents().find("body").one("click",this.close),"eml"===l.type?(n=new t.Preview({data:{nested_message:p},mimetype:"message/rfc822",parent:p.parent},{width:e.parent().width(),height:"auto"})).supportsPreview()&&(n.appendTo(e),e.append($("<div>").text(" "))):"contacts"===l.module?require(["io.ox/contacts/view-detail"],function(t){e.append(t.draw(p))}):"infostore"===l.module?require(["io.ox/files/api"],function(i){var a=new t.Preview({name:p.filename,filename:p.filename,mimetype:p.file_mimetype,size:p.file_size,dataURL:i.getUrl(p,"bare"),version:p.version,id:p.id,folder_id:p.folder_id},{width:e.parent().width(),height:"auto"});a.supportsPreview()&&(e.append($("<h4>").addClass("mail-attachment-preview").text(p.filename)),a.appendTo(e),e.append($("<div>").text(" ")))}):p.atmsgref?require(["io.ox/mail/api"],function(i){var a=p.atmsgref.lastIndexOf("/");p.parent={folder_id:p.atmsgref.substr(0,a),id:p.atmsgref.substr(a+1)};var n=new t.Preview({data:p,filename:p.filename,source:"mail",folder_id:p.parent.folder_id,id:p.parent.id,attached:p.id,parent:p.parent,mimetype:p.content_type,dataURL:i.getUrl(p,"view")},{width:e.parent().width(),height:"auto"});n.supportsPreview()&&(e.append($("<h4>").addClass("mail-attachment-preview").text(p.filename)),n.appendTo(e),e.append($("<div>").text(" ")))}):((s=new FileReader).onload=function(t){try{return o(e,t.target.result,p.type)}finally{s=s.onload=null}},"text/plain"===p.type?s.readAsText(p):s.readAsDataURL(p))}}});