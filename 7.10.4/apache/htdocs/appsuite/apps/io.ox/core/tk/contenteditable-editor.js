define("io.ox/core/tk/contenteditable-editor",["io.ox/core/capabilities","io.ox/core/extensions","io.ox/core/tk/textproc","io.ox/mail/api","io.ox/mail/util","static/3rd.party/purify.min.js","settings!io.ox/core","settings!io.ox/mail","gettext!io.ox/core","less!io.ox/core/tk/contenteditable-editor-content","less!io.ox/core/tk/contenteditable-editor"],function(t,e,n,o,i,r,s,a,c,l){"use strict";function d(t){var e=t.contentWindow.getSelection().getRangeAt(0);e.collapsed||(t.execCommand("Delete",!1,null),e=t.contentWindow.getSelection().getRangeAt(0));var n,o=e.commonAncestorContainer,r=null;for(n=function(t){var e;if(t)if(t.hasChildNodes())for(e=0;e<t.childNodes.length;e++){if(1===t.childNodes[e].nodeType)return void n(t.childNodes[e]);3===t.childNodes[e].nodeType&&(t.childNodes[e].nodeValue=t.childNodes[e].nodeValue.replace("â€‹",""))}else"BR"===t.nodeName&&(r=t)};o&&!/mce-content-body/.test(o.className);){e.setEndAfter(o);var s=o.parentNode,a=e.extractContents();n(a.firstChild),$(a).text().length>0&&s.insertBefore(a,o.nextSibling);try{var c,l=$(s).children("ol + ol");l.length>0&&(c=l.prev().children("li").length+1,l.attr("start",c))}catch(t){ox.debug&&console.error(t)}o=s}if(r)try{r.parentNode.removeChild(r)}catch(t){ox.debug&&console.error(t)}var d=i.getDefaultStyle().node.get(0);e.insertNode(d),e.setStart(d,0),e.setEnd(d,0),t.contentWindow.getSelection().empty(),t.contentWindow.getSelection().addRange(e)}function u(t){var e=t.commonAncestorContainer||t.parentElement();return $(e).parents("blockquote").last().length>0}function p(t,e){var n=t.contentWindow.getSelection().getRangeAt(0);u(n)&&n.startContainer&&(d(t),t.dom.events.cancel(e),t.focus())}function g(t){var e=$(t.container).closest(".scrollable"),n=t.contentWindow.getSelection(),o=n.getRangeAt(0),i=_.device("safari")?o.getClientRects()[0]:o.getBoundingClientRect(),r=i?i.top:0,s=e.find(".mail-compose-fields").height(),a=e.parents(".window-container-center").find(".window-footer").outerHeight(),c=e.find(".contenteditable-editor").css("margin-bottom")||"0px",l=parseInt(c.replace("px",""),10)||0,d=e.height()-a-2*l;if(0===r)if(n.modify)n.modify("extend","backward","character"),i=(o=n.getRangeAt(0)).getBoundingClientRect(),o.collapse(),r=i.top+i.height,n.collapseToEnd();else{var u=o.commonAncestorContainer;r=$(u).offset().top+u.clientHeight}return{pos:r-e.scrollTop()+s,top:r,bottom:d,scrollable:e}}function h(){var t=ox.language,e=["ar","ar_SA","az","be","bg_BG","bn_BD","bs","ca","cs","cy","da","de","de_AT","dv","el","en_CA","en_GB","es","et","eu","fa","fi","fo","fr_FR","gd","gl","he_IL","hr","hu_HU","hy","id","is_IS","it","ja","ka_GE","kk","km_KH","ko_KR","lb","lt","lv","ml","ml_IN","mn_MN","nb_NO","nl","pl","pt_BR","pt_PT","ro","ru","si_LK","sk","sl_SI","sr","sv_SE","ta","ta_IN","tg","th_TH","tr_TR","tt","ug","uk","uk_UA","vi","vi_VN","zh_CN","zh_TW"],n=_.indexOf(e,t,!0);return"fr_CA"===t?"fr_FR":n>-1?e[n]:(n=_.indexOf(e,t.substr(0,2),!0))>-1?e[n]:"en"}c("Drop inline images here"),c("Please only drop images here. If you want to send other files, you can send them as attachments.");var f="io.ox/core/tk/contenteditable-editor",m=0;e.point(f+"/setup").extend({id:"default",index:m+=100,draw:function(t){t.on("keydown",function(e){e.shiftKey||13!==e.which||p(t,e),(13===e.which&&!e.shiftKey||40===e.which)&&setTimeout(y,0,t),38!==e.which&&8!==e.which||setTimeout(x,0,t)})}}),e.point(f+"/setup").extend({id:"list-style-position",index:m+=100,draw:function(t){t.on("NodeChange",function(t){"LI"===t.element.nodeName&&"left"!==t.element.style.textAlign&&""!==t.element.style.textAlign&&$(t.element).css("list-style-position","inside")})}}),e.point(f+"/setup").extend({id:"sanitize",index:m+=100,draw:function(t){t.on("PastePreProcess",function(t){t.content&&(t.content=r.sanitize(t.content)+"")})}}),e.point(f+"/setup").extend({id:"retrigger-change",index:m+=100,draw:function(t){t.on("keyup input SetContent Change",_.throttle(this.trigger.bind(this,"change"),50))}}),e.point(f+"/setup").extend({id:"ios-focus",index:m+=100,draw:function(t){_.device("!tablet && ios >= 13")||t.on("touchstart",function(){$(document.activeElement).is("iframe")||$(document.activeElement).blur()})}});var v=300,b="swing",x=_.throttle(function(t){var e=g(t);e.top>0&&e.pos<0&&e.scrollable.animate({scrollTop:e.top},v,b),e.top<16&&e.scrollable.animate({scrollTop:0},v,b)},v),y=_.throttle(function(t){var e=g(t);e.pos>=e.bottom&&e.scrollable.animate({scrollTop:e.top},v,b)},v);return function(r,d){function u(t){return String(t||"").replace(/[\s\xA0]+$/g,"")}function p(t){var e=Math.round(.9*s.get("maxUploadIdleTimeout",2e5));I.push(setInterval(d.keepalive||o.keepalive,e,t))}function g(){_(I).each(clearInterval)}var m,v,b,x=$.Deferred(),w=this,C=r.data("editorId"),k=i.getDefaultStyle();_.extend(this,Backbone.Events),r.append(m=$('<div class="contenteditable-editor">').attr("data-editor-id",C).on("keydown",function(t){27===t.which&&t.preventDefault()}).append(b=$('<div class="editable" tabindex="0" role="textbox" aria-multiline="true">').attr("aria-label",c("Rich Text Area. Press ALT-F10 for toolbar")).toggleClass("simple-linebreaks",a.get("compose/simpleLineBreaks",!1)))),d=_.extend({toolbar1:"*undo *redo | bold italic underline | bullist numlist outdent indent",advanced:"*styleselect | *fontselect fontsizeselect | link image *emoji | forecolor backcolor",toolbar2:"",toolbar3:"",plugins:"autoresize autolink oximage oxpaste oxdrop link paste textcolor emoji lists code",theme:"modern",height:null,imageLoader:null},d),b.addClass(d.class),d.toolbar1+=" | "+d.advanced,d.toolbar1=s.get("tinyMCE/theme_advanced_buttons1",d.toolbar1),d.toolbar2=s.get("tinyMCE/theme_advanced_buttons2",d.toolbar2),d.toolbar3=s.get("tinyMCE/theme_advanced_buttons3",d.toolbar3),t.has("emoji")||(d.toolbar1=d.toolbar1.replace(/( \| )?\*?emoji( \| )?/g," | "),d.toolbar2=d.toolbar2.replace(/( \| )?\*?emoji( \| )?/g," | "),d.toolbar3=d.toolbar3.replace(/( \| )?\*?emoji( \| )?/g," | "),d.plugins=d.plugins.replace(/emoji/g,"").trim());var T=d.toolbar1.replace(/\s*\|\s*/g," ");d.toolbar1=d.toolbar1.replace(/\*/g,"");var E='.contenteditable-editor[data-editor-id="'+C+'"] > .mce-tinymce > .mce-stack-layout > .mce-top-part',N={script_url:(window.cordova?ox.localFileRoot:ox.base)+"/apps/3rd.party/tinymce/tinymce.min.js",extended_valid_elements:"blockquote[type]",invalid_elements:"object,iframe,script,embed",height:d.height,autoresize_bottom_margin:0,menubar:!1,statusbar:!1,skin:d.skin,body_class:"ox-mce",content_style:l,toolbar1:d.toolbar1,toolbar2:d.toolbar2,toolbar3:d.toolbar3,relative_urls:!1,remove_script_host:!1,entity_encoding:"raw",font_formats:i.getFontFormats(),fontsize_formats:"8pt 10pt 11pt 12pt 13pt 14pt 16pt 18pt 24pt 36pt",forced_root_block:"div",forced_root_block_attrs:{style:k.string,class:"default-style"},browser_spellcheck:!0,plugins:d.plugins,link_title:!1,target_list:!1,link_assume_external_targets:!0,language:h(),hidden_input:!1,theme:d.theme,mobile:{theme:"modern",toolbar:!1},init_instance_callback:function(t){v=t,x.resolve()},execcommand_callback:function(t,e,n){"createlink"===n&&_.defer(function(){$(tinyMCE.get(t).getBody()).find("a").attr({target:"_blank",rel:"noopener"})})},paste_preprocess:n.paste_preprocess,paste_postprocess:n.paste_postprocess,setup:function(t){d.oxContext&&(t.oxContext=d.oxContext),e.point(f+"/setup").invoke("draw",w,t),t.on("init",function(){this.oxContext&&this.oxContext.signature&&$(this.contentDocument.getElementsByTagName("html")[0]).addClass("signature-editor"),$(E).find("span.mce-txt").attr("tabindex",-1);var e=$(E).find(".mce-widget");T.split(" ").forEach(function(t,n){e.eq(n).attr("data-name",t),/^\*/.test(t)&&e.eq(n).attr("data-hidden","xs")}),$(E).find(".mce-btn-group").each(function(){$(this).toggleClass("mce-btn-group-visible-xs",$(this).has(".mce-widget:not([data-hidden])").length>0)}),t.on("SetContent",function(e){e.paste&&setTimeout(y,0,t)})})},oxImageLoader:d.imageLoader};e.point(f+"/options").invoke("config",N,d.oxContext),require(["3rd.party/tinymce/jquery.tinymce.min"]).then(function(){b.tinymce(N)});var A=function(t){return t.replace(/<[a-z][^>]*\sdata-mce.*?>/gi,function(t){return t.replace(/\sdata-mce-\S+=("[^"]*"|'[^']*')/g,"")})},R=_.debounce(function(){if(null!==r){var t=r.find(".mce-btn").filter('[data-hidden="xs"]');t.filter(":hidden").attr({role:"presentation","aria-hidden":!0}),t.filter(":visible").removeAttr("aria-hidden").attr("role","button");var e=0,n=0,o=r.find("iframe"),i=o.contents().height(),s=r.closest(".window-container"),a=s.find(".window-header:visible").outerHeight()||0,c=s.find(".window-footer:visible").outerHeight()||0,l=0;_.device("smartphone")?(e=$(window).height(),n=r.offset().top):(e=r.closest(".window-content").height(),n=r.parent().find(".mail-compose-fields").outerHeight(),l=8);var u=e-n-a-c-l;_.device("smartphone")&&i>u&&(u=i),b.css("min-height",u+"px"),o.css("min-height",u+"px"),d.css&&b.css(d.css)}},30),S=function(t){v.setContent(t),/position:(\s+)?absolute/i.test(t)&&$(v.getBody()).find("[style*=absolute]").css("position","static"),/white-space:(\s+)?nowrap/i.test(t)&&$(v.getBody()).find("[style*=nowrap]").css("white-space","normal")},B=function(t){return String(t||"").replace(/\r/g,"").replace(new RegExp("\\n","g"),t.indexOf("io-ox-signature")>-1?"\n":"<br>")};this.content_type=d.config&&"alternative"===d.config.get("preferredEditorMode")?"ALTERNATIVE":"text/html",this.done=function(t){return $.when(x).then(function(){return t(this),this}.bind(this))},this.focus=function(){_.device("ios")||_.defer(function(){v&&(v.focus(),v.execCommand("mceFocus",!1,C))})},this.ln2br=B,this.clear=function(){S("")},this.getContent=function(t){t=t||{},$(v.getBody()).find(".mce-resizehandle").remove();var e=v.getContent({format:t.format||"raw"});return e=A(e),e=e.replace(/<(\w+)[ ]?\/>/g,"<$1>").replace(/(<div>(<br>)?<\/div>)+$/,""),e=e.replace(/(\s|&nbsp;|\0x20|<br\/?>|<div( class="io-ox-signature")>(&nbsp;|\s|<br\/?>)*<\/div>)*$/g,""),u(e)},this.getPlainText=function(){return n.htmltotext($(v.getBody()).html())},this.setContent=S,this.setPlainText=function(t){t=u(t),_.isUndefined(t)||require(["io.ox/mail/detail/content"],function(e){S(e.text2html(t)),v.undoManager.clear()})},this.paste=function(t){v.execCommand("mceInsertClipboardContent",!1,{content:t})},this.scrollTop=function(t){var e=$(v.getDoc());if(void 0===t)return e.scrollTop();"top"===t?e.scrollTop(0):"bottom"===t&&e.scrollTop(e.get(0).body.scrollHeight)},this.setCaretPosition=function(){$(v.getDoc()).scrollTop(0)},this.appendContent=function(t){var e=this.getContent();t=/^<div/i.test(t)?t:"<div>"+B(t)+"</div>",e=e.replace(/^(<div><br><\/div>){2,}/,"").replace(/(<div><br><\/div>)+$/,"")+"<div><br></div>"+t,/^<blockquote/.test(e)&&(e="<div><br></div>"+e),this.setContent(e)},this.prependContent=function(t){var e=this.getContent();e="<div><br></div>"+(e=(t=/^<div/i.test(t)?t:"<div>"+B(t)+"</div>")+"<div><br></div>"+e.replace(/^(<div><br><\/div>)+/,"").replace(/(<div><br><\/div>){2,}$/,"")),this.setContent(e)},this.setContentParts=function(t,e){var n="";(t=_.isString(t)?{content:t}:t).content=t.content.replace(/^(<div><br><\/div>)+/,"").replace(/(<div><br><\/div>){2,}$/,""),t.content?n+=t.content:n+='<div class="default-style" style="'+k.string+'"><br></div>',"above"===e&&t.cite&&(n+=t.cite),t.quote&&(t.quote=t.quote.replace(/<div><br>(&nbsp;|&#160;)<\/div>/,""),n+=t.quote||""),"below"===e&&t.cite&&(!/<div><br><\/div>$/i.test(n)&&/<\/blockquote>$/.test(n)&&(n+='<div class="default-style" style="'+k.string+'"><br></div>'),n+=t.cite),this.setContent(n)},this.getContentParts=function(){var t=this.getContent(),e="forward"===d.view.model.get("mode")&&a.get("forwardunquoted",!1),n=t.indexOf(e?"----":'<blockquote type="cite">');return'<blockquote type="cite"><div>'===t.substring(0,15)&&(n=0),'<div><br></div><blockquote type="cite">'===t.substring(0,23)&&(n=0),n<0?{content:t}:{content:t.substring(0,n).replace(/\s+$/g,""),quote:t.substring(n),cite:void 0}},this.insertPrevCite=function(t){var e=this.getContentParts();t=/^<div/i.test(t)?t:"<div>"+B(t)+"</div>",e.cite=t,this.setContentParts(e,"above")},this.insertPostCite=function(t){var e=this.getContentParts();t=/^<div/i.test(t)?t:"<div>"+B(t)+"</div>",e.cite=t,this.setContentParts(e,"below")},this.replaceParagraph=function(t,e){var n,o,i=this.getContent();return t=/^<div/i.test(t)?t:"<div>"+B(t)+"</div>",(n=i.indexOf(t))>-1&&(o=this.scrollTop(),this.setContent(i.substr(0,n)+(e||"")+i.substr(n+t.length)),this.scrollTop(o),!0)},this.removeContent=function(t){this.replaceContent(t,"")},this.find=function(t){return $(v.getBody()).find(t)},this.children=function(t){return $(v.getBody()).children(t)},this.replaceContent=function(t,e){function n(){v.selection.setContent(e||"")}var o,i=v.getWin(),r=!1;if(v.selection.select(v.getBody(),!0),v.selection.collapse(!0),_.browser.IE)for(v.focus(),o=v.getDoc().selection.createRange();o.findText(t,1,0);)o.scrollIntoView(),o.select(),n(),r=!0;else for(;i.find(t,0,0,!1,!1,!1,!1);)n(),r=!0;return r},this.getMode=function(){return"html"},this.tinymce=function(){return b.tinymce?b.tinymce():{}},this.show=function(){m.show(),$(E).css("display",""),window.toolbar=$(E),$(window).on("resize.tinymce xorientationchange.tinymce changefloatingstyle.tinymce",R),$(window).trigger("resize")},this.hide=function(){m.hide(),$(window).off("resize.tinymce xorientationchange.tinymce changefloatingstyle.tinymce",R)},function(){if(!_.device("smartphone")){var t=d.scrollpane||d.app&&d.app.getWindowNode(),e=t.find(".mail-compose-fields"),n=!1;d.app&&d.app.get("floating")&&d.app.get("window").floating&&d.app.get("window").floating.on("move",function(){n&&$(E).css("top",d.view.$el.parent().offset().top)}),t.on("scroll",function(){var o=t.scrollTop()||0;n=o>e.height()+14,$(E).css("top",n?d.view.$el.parent().offset().top:0),e.css("margin-bottom",n?40:0),m.toggleClass("toolbar-fixed",n)})}}(),this.destroy=function(){this.hide(),g(),delete tinyMCE.EditorManager.activeEditor,tinyMCE.EditorManager.remove(v),v=void 0};var I=[];b.on("addInlineImage",function(t,e){p(e)})}});