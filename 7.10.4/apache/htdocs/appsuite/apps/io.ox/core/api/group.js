define("io.ox/core/api/group",["io.ox/core/http","io.ox/core/api/factory"],function(e,t){"use strict";function n(){o.caches.all.clear(),o.caches.list.clear(),o.caches.get.clear()}var o=t({module:"group",keyGenerator:function(e){return String(e.id)},requests:{all:{columns:"1,20",extendColumns:"io.ox/core/api/group/all",sort:"500",order:"asc"},list:{},get:{},search:{action:"search",columns:"1,20,500,524",extendColumns:"io.ox/core/api/group/search",getData:function(e){return{pattern:e}}}}}),r=Backbone.Model.extend({defaults:{display_name:"",members:[],name:""},initialize:function(){var e=this.get("members");_.isString(e)&&""!==e&&this.set("members",e.split(",").map(function(e){return parseInt(e,10)}),{silent:!0}),this.on("change:display_name",function(){this.set("name",this.getName())}),this.set("name",this.getName())},getName:function(){var e={"ä":"ae","ö":"oe","ü":"ue","ß":"ss"};return function(){return this.has("id")&&this.get("name")?this.get("name"):this.get("display_name").trim().toLowerCase().replace(/[äöüß]/g,function(t){return e[t]}).replace(/\W+/g,"_")}}()}),a=Backbone.Collection.extend({comparator:function(e){return(e.get("display_name")||"").toLowerCase()},model:r});return o.collection=new a,o.getModel=function(e){return o.collection.get(e)||new r},o.create=function(t){return e.PUT({module:"group",params:{action:"new"},data:t,appendColumns:!1}).then(function(e){return o.get({id:e.id}).done(function(e){o.collection.add(e,{parse:!0}),o.trigger("create",e),n()})})},o.update=function(t){return e.PUT({module:"group",params:{action:"update",id:t.id,timestamp:_.then()},data:_(t).pick("name","display_name","members"),appendColumns:!1}).done(function(){var e=o.collection.get(t.id);e&&e.set(t),o.trigger("update",t),n()})},o.refreshGroup=function(e){return o.collection.get(e)?o.get({id:e},!1).done(function(t){return o.collection.get(e).set(t)}):$.when()},o.remove=function(t){return o.trigger("before:remove",t),e.PUT({module:"group",params:{action:"delete",timestamp:_.then()},data:{id:t},appendColumns:!1}).done(function(){var e=o.collection.get(t);e&&o.collection.remove(e),o.trigger("remove",t),n()})},o.getName=function(e){return o.get({id:e}).then(function(e){return e.display_name||e.name||""})},o.getTextNode=function(e){var t=document.createTextNode("");return o.get({id:e}).done(function(e){t.nodeValue=e.display_name}).always(function(){_.defer(function(){t=null})}),t},o});