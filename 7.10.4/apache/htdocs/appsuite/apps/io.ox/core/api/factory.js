define("io.ox/core/api/factory",["io.ox/core/http","io.ox/core/cache","io.ox/core/event","io.ox/core/extensions","io.ox/core/api/backbone"],function(e,t,n,r,o){"use strict";var i=function(e){var t=_.copy(e,!0);return t.folder=t.folder||t.folder_id,delete t.folder_id,t},l="id: folder_id:folder folder: recurrence_position:".split(" "),a=function(e){return _.isObject(e)?_(l).reduce(function(t,n){var r=n.split(":"),o=r[0],i=r[1]||r[0];return o in e&&(t[i]=e[o]),t},{}):e},c=function(r){(r=$.extend(!0,{id:null,keyGenerator:null,module:"",requests:{all:{action:"all",timezone:"utc"},list:{action:"list",timezone:"utc"},get:{action:"get",timezone:"utc"},search:{action:"search",timezone:"utc"},remove:{action:"delete"}},cid:function(e){return e.folder+"//"+(e.sortKey||e.sort)+"."+e.order+"."+(e.max||e.limit||0)},done:{},fail:{},pipe:{},params:{},filter:null},r||{})).id=r.id||r.module,_.each(r.requests,function(e){e.extendColumns&&(e.columns=c.extendColumns(e.extendColumns,r.module,e.columns),delete e.extendColumns)});var l={all:new t.SimpleCache(r.id+"-all"),list:new t.ObjectCache(r.id+"-list",!1,r.keyGenerator),get:new t.ObjectCache(r.id+"-get",!1,r.keyGenerator)},u={},d={},s={DELIM:"//",options:r,cid:r.cid,getAll:function(t,n,o,i){var a=$.extend({},r.requests.all,t||{}),c=r.cid(a);n=void 0===n||!!n,o=o||l.all;var f=function(){var t=r.params.all?r.params.all(_.copy(a,!0)):a;return e.GET({module:r.module,params:t,processResponse:void 0===i||i}).then(function(e){var n=$.when();return/(^5,|,5,|5$)/.test(t.columns)?$.when.apply($,_(e).map(function(e){var t=_.cid(e);return void 0===d[t]?(d[t]=e.last_modified,n):e.last_modified>d[t]?(d[t]=e.last_modified,$.when(s.caches.list.remove(t),s.caches.get.remove(t)).done(function(){s.trigger("update:"+_.ecid(e),e)})):void 0})).then(function(){return e}):e},function(e){throw s.trigger("error error:"+e.code,e),e}).then(function(e){return(r.pipe.all||_.identity)(e,a)}).then(function(e){return $.when(o.add(c,e)).then(function(){return e})})};return(n?o.get(c,f,function(){!1!==ox.serverConfig.persistence&&(c in u||(u[c]=!0,setTimeout(function(){s.refresh()},5e3)))}):f()).then(r.pipe.allPost).done(r.done.all||$.noop)},getList:function(t,n,o){t=t?[].concat(t):[],r.filter&&(t=_(t).filter(r.filter)),o=o||{},n=void 0===n||!!n;var i=function(){var n=_.extend({},r.requests.list);return o.allColumns&&(n.columns=e.getAllColumns(r.module,!0)),o.unseen&&(n.unseen=!0),e.fixList(t,e.PUT({module:r.module,params:n,data:e.simplify(t)})).then(function(e){return(r.pipe.list||_.identity)(e)}).then(function(e){var t=o.allColumns?"add":"merge";return $.when(l.list.add(e),l.get[t](e)).then(function(){return e})})};return 0===t.length?$.Deferred().resolve([]).done(r.done.list||$.noop):(n?l.list.get(t,i):i()).then(r.pipe.listPost).done(r.done.list||$.noop)},get:function(t,n){var o=$.extend({},r.requests.get,t),a=function(){return e.GET({module:r.module,params:i(o)}).then(function(e){return(r.pipe.get||_.identity)(e,o)},function(e){throw s.trigger("error error:"+e.code,e),e}).then(function(e){return n?$.when(l.get.add(e),l.list.merge(e).done(function(e){e&&s.trigger("refresh.list")})).then(function(){return e}):e}).fail(function(e){_.call(r.fail.get,e,o,r)})};return((n=void 0===n||!!n)?l.get.get(o,a,r.pipe.getCache):a()).then(r.pipe.getPost).done(r.done.get||$.noop)},localRemove:function(e,t,n){return _(e).filter(function(e){return!0!==t[n(e)]})},updateCaches:function(e,n){e=e||[],e=_.isArray(e)?e:[e];var r,o={},i={},l=t.defaultKeyGenerator;return _(e).each(function(e){o[l(e)]=i[e.folder_id]=!0}),e.length<100?(r=_(i).map(function(e,t){var n=s.caches.all;return n.grepKeys(t+"//").then(function(e){return $.when.apply($,_(e).map(function(e){return n.get(e).then(function(t){return t?("data"in t?t.data=s.localRemove(t.data,o,l):t=s.localRemove(t,o,l),n.add(e,t)):$.when()})}))})}),e.length&&(r.push(s.caches.list.remove(e)),r.push(s.caches.get.remove(e)))):(r=[s.caches.all.clear()],e.length&&(r.push(s.caches.list.clear()),r.push(s.caches.get.clear()))),s.resetTrashFolders&&r.push(s.resetTrashFolders()),$.when.apply($,r).done(function(){n||_(e).each(function(e){s.trigger("delete:"+_.ecid(e))}),o=i=r=e=null})},remove:function(t,n){t=t||[],t=_.isArray(t)?t:[t],n=_.extend({local:!1,force:!1},n||{});var o=$.extend({},r.requests.remove,{timestamp:_.then()}),i=e.simplify(t);n.force&&(o.harddelete=!0);var l=function(e){var n={};return _(t).each(function(e){n[e.folder_id]=e.folder_id}),$.when.apply($,_(n).map(function(e){return s.caches.all.grepRemove(e+"//")})).then(function(){return $.Deferred()[e.error?"reject":"resolve"](e)})},a=function(){s.trigger("refresh.all"),s.trigger("delete",t)};return s.trigger("beforedelete",t),s.updateCaches(t).then(function(){return s.trigger("refresh:all:local"),!0!==n.local?e.PUT({module:r.module,params:o,data:i,appendColumns:!1}).then(l,l).always(a):a()})},needsRefresh:function(e,t,n){return l.all.keys(e+"//"+t+"."+n).then(function(e){return null!==e})},reduce:a,caches:l};return r.requests.search&&(s.search=function(t,n){var o=$.extend({},r.requests.search,n||{}),i=o.getData;return n=n||{},r.requests.search.omitFolder&&!1!==n.omitFolder&&delete o.folder,delete o.omitFolder,delete o.getData,e.PUT({module:r.module,params:o,data:i(t,n)}).then(function(e){return(r.pipe.search||_.identity)(e)})}),r.requests.advancedsearch&&(s.advancedsearch=function(t,n){var o=$.extend({},r.requests.advancedsearch,n||{}),i=o.getData;return n=n||{},r.requests.advancedsearch.omitFolder&&!1!==n.omitFolder&&delete o.folder,delete o.omitFolder,delete o.getData,e.PUT({module:r.module,params:o,data:i(t,n)}).then(function(e){return e})}),n.extend(s),s.refresh=function(){return ox.online?$.when(s.caches.all.clear(),s.caches.list.clear()).done(function(){s.trigger("refresh.all")}):$.when()},ox.on("refresh^",function(){s.refresh()}),s.Model=o.Model,s.Collection=o.Collection,s};return c.reduce=a,c.extendColumns=function(t,n,o){var i={},l={},a=e.getColumnMapping(n);return _.each(a,function(e,t){l[e]=t}),_.each(o.split(","),function(e){i[e]=1}),_.chain(r.point(t).invoke("columns")).flatten(!0).each(function(e){i[l[e]||e]=1}),_.keys(i).join()},c});