define("io.ox/core/api/reminder",["io.ox/core/http","io.ox/tasks/api","io.ox/core/event"],function(e,n,t){"use strict";function r(e){(e||e.length)&&(_.isArray(e)&&(1===e.length?e=e[0]:m.getReminders()),i(e,!0)&&f())}function i(e,n){var t=!1;return _(d).each(function(r,i){r.target_id===e.id&&(n&&delete d[i],t=!0)}),t}var o,a,d={},u=[],c=function(e){var n=[];_(e).each(function(e){n.push(e.id)}),d=_.object(n,e)},f=function(){if(u=[],clearTimeout(a),o&&!d[o.id]&&(o=null),_(d).each(function(e){e.alarm<=_.now()?u.push(e):(!o||e.alarm<o.alarm)&&(o=e)}),m.trigger("set:tasks:reminder",u),o){var e=o.alarm-_.now();a=setTimeout(function(){o=null,m.getReminders()},e)}},m={deleteReminder:function(n){return e.PUT({module:"reminder",params:{action:"delete"},data:n}).then(function(){_.isArray(n)?_(n).each(function(e){delete d[e.id]}):delete d[n.id]})},remindMeAgain:function(n,t){return e.PUT({module:"reminder",params:{action:"remindAgain",id:t,timezone:"UTC"},data:{alarm:n}}).always(function(){m.getReminders()})},getReminders:function(n){return e.GET({module:"reminder",params:{action:"range",timezone:"UTC",modules:"tasks",end:n||moment().add(1,"hour").valueOf()}}).then(function(e){return e=_(e).filter(function(e){return 4===e.module}),c(e),f(),e})},get:function(e){if(e.module&&e.target_id||(e=d[e.id]),!e)return $.Deferred().reject();var t={id:e.target_id,folder_id:e.folder};return n.get(t)}};return t.extend(m),m.refresh=function(){m.getReminders().done(function(){m.trigger("refresh.all")})},ox.on("refresh^",function(){m.refresh()}),n.on("delete mark:task:confirmed",function(e,n){if("mark:task:confirmed"===e.type){var t=[];_(n).each(function(e){e.data&&2!==e.data.confirmation||t.push(e)}),r(t)}else r(n)}),n.on("update",function(e,n){i(n)&&m.getReminders()}),m});