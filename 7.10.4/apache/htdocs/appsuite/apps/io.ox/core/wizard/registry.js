define("io.ox/core/wizard/registry",["io.ox/core/extensions","io.ox/core/tk/dialogs","gettext!io.ox/core/wizard","less!io.ox/core/wizard/style"],function(t,e,n){"use strict";function i(i){function a(){return s().buttons.nextEnabled}function o(){v=!0,g.dialog.busy()}function d(){v=!1,g.dialog.idle(),g.updateButtonState()}function s(e){if(_.isUndefined(e)&&(e=g.index),h[e])return h[e];var n=t.Baton.ensure(g.runOptions);return n.wizard=g,n.ready=$.Deferred(),h[e]=n,n.completed=!1,n.buttons={nextEnabled:!1},n.buttons.enableNext=function(){n.buttons.nextEnabled=!0,n.wizard.updateButtonState()},n.buttons.disableNext=function(){n.buttons.nextEnabled=!1,n.wizard.updateButtonState()},n}function r(t,e,n){return t[e]&&_.isFunction(t[e])?t[e](s(n)):null}function u(t,e){var n=s(e);if("pending"!==n.ready.state())return n.ready;if(t.load){var i=t.load(n);return i&&i.done(n.ready.resolve).fail(n.ready.reject),n.ready}return n.ready.resolve(),n.ready}function l(t,e){var n=s(e);if("pending"===n.ready.state()&&(!t.options||_.isUndefined(t.options.preLoad)||t.options.preLoad)){if(!t.preLoad){if(t.load){var i=t.load(n);return i&&i.done(n.ready.resolve).fail(n.ready.reject),n.ready}return n.ready.resolve(),n.ready}t.preLoad(n)}}function c(t){var e=g.pages(),n=e.length;if(!_.isNumber(t)){var i=t;t=_(e).find(function(e){return e.id===t}),_.isUndefined(t)&&(console.error('Could not find page with id "'+i+'"'),t=0)}t>=n?g.close():t<0||(g.currentPage&&r(g.currentPage,"leave",g.index),g.previousPage=t>0?e[t-1]:null,g.nextPage=t+1<n?e[t+1]:null,g.currentPage=e[t],g.previousPage?g.navButtons.find(".wizard-prev").show():g.navButtons.find(".wizard-prev").hide(),g.nextPage?(g.navButtons.find(".wizard-next").show(),g.navButtons.find(".wizard-done").hide()):(g.navButtons.find(".wizard-next").hide(),g.navButtons.find(".wizard-done").show()),g.navButtons.find(".wizard-close").show(),g.currentPage.metadata("hideButtons",s())&&g.navButtons.find("button").hide(),g.index=t,o(),u(g.currentPage).done(function(){if(g.dialog.getBody().find(".wizard-page").detach(),!p[g.index]){var t=$('<div class="wizard-page"></div>');g.currentPage.draw.call(t,s()),p[g.index]=t}g.dialog.getBody().append(p[g.index]),d(),r(g.currentPage,"activate",g.index),g.dialog.getHeader().find(".wizard-header").detach(),g.dialog.getHeader().append($('<h1 class="wizard-header" />').text(g.currentPage.metadata("title",s()))),g.updateButtonState()}).fail(function(t){require("io.ox/core/notifications").yell(t),g.close()}),setTimeout(function(){g.nextPage&&l(g.nextPage,g.index+1),g.previousPage&&l(g.previousPage,g.index-1)},0))}i||(console.error("Please specify options for the wizard. At minimum it needs an id!"),i={id:"defunct"});var f="stopped",h={},p={},g=this,v=!1;this.options=i,this.runOptions=null,this.index=0,this.currentPage=null,this.previousPage=null,this.nextPage=null,this.dialog=null,this.pageData={},this.wizardIsRunning=null,this.navButtons=$("<div/>").append($('<button type="button" class="btn btn-default wizard-next">').text(n("Next")).on("click",function(){g.next()}),$('<button type="button" class="btn btn-primary wizard-done">').text(n("Done")).on("click",function(){g.done()}),$('<button type="button" class="btn wizard-prev">').text(n("Previous")).on("click",function(){g.back()})),i.closeable&&this.navButtons.append($('<button type="button" class="btn btn-default wizard-close">').text(n("Close")).on("click",function(){g.close()})),this.updateButtonState=function(){if(!v){var t=this.navButtons.find(".wizard-next"),e=this.navButtons.find(".wizard-done");a()?(t.prop("disabled",!1),t.addClass("btn-primary"),t.removeClass("btn-disabled")):(t.prop("disabled",!0),t.removeClass("btn-primary"),t.addClass("btn-disabled")),e.prop("disabled",!1),e.removeClass("btn-disabled")}},this.point=function(){return t.point(i.id)},this.titles=function(){var t=[],e=0;_(this.pages()).each(function(n){t.push(n.metadata("title",s(e))),e++})},this.pages=function(){return this.point().list()},this.start=function(t){t=t||{};{if("stopped"===f)return this.dialog=new e.ModalDialog({easyOut:!!this.options.closeable}),this.dialog.getContentControls().append(this.navButtons),t.id&&this.dialog.getPopup().attr("id",t.id),t.cssClass&&this.dialog.getPopup().addClass(t.cssClass),this.runOptions=t||{},c(0),this.wizardIsRunning=this.dialog.show(),this.wizardIsRunning;console.error("Cannot start wizard, when it is in state: ",f)}},this.next=function(){if(a()){var t=$.when();this.currentPage&&(t=r(this.currentPage,"finish",this.index)||$.when()),o(),t.then(function(){d(),c(g.index+1)},function(){d(),c(g.index)})}},this.done=function(){if(a()){var t=$.when();this.currentPage&&(t=r(this.currentPage,"finish",this.index)||$.when()),o(),t.done(function(){d(),g.close()})}},this.back=function(){c(this.index-1)},this.close=function(){"done"!==f&&(f="done",this.dialog.close())},this.busy=o,this.idle=d,this.goToPage=c}return{getWizard:function(t){return new i(t)}}});