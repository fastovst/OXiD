define("io.ox/core/main/stages",["io.ox/core/extensions","io.ox/core/notifications","io.ox/core/capabilities","io.ox/core/api/apps","io.ox/core/folder/api","io.ox/core/main/debug","settings!io.ox/core","settings!io.ox/contacts","gettext!io.ox/core"],function(e,o,i,n,a,t,r,u,c){var s=$("#io-ox-appcontrol"),l=function(e){var o=(e||"").split(/:/),i=o[0],n=o[1]||"";return{app:/\/main$/.test(i)?i:i+"/main",method:n,name:i.replace(/\/main$/,"")}},d=function(){var e=_([].concat(r.get("autoStartMobile","io.ox/mail"))).filter(function(e){return!_.isUndefined(e)&&!_.isNull(e)});return"io.ox/mail"!==e[0]&&e.push("io.ox/mail"),e},p=function(){var e=[];if("none"===r.get("autoStart"))e=[];else{var o=_.map(n.forLauncher(),function(e){return e.get("path")});e=_([].concat(r.get("autoStart"),o)).chain().filter(function(e){return!_.isUndefined(e)&&(!_.isNull(e)&&(!!/^io.ox\/settings(\/main)?$/.test(e)||o.indexOf(/main$/.test(e)?e:e+"/main")>=0))}).first(1).value()}return e};return e.point("io.ox/core/stages").extend({id:"first",index:100,run:function(){t('Stage "first"')}},{id:"app_register",index:105,run:function(){return require(["io.ox/core/main/apps","io.ox/core/main/warning"])}},{id:"appcheck",index:110,run:function(e){t('Stage "appcheck"');var o,n=_.url.hash(),a=!("!!"in n);if("infostore"===n.m&&(n.m="files"),a&&n.app&&n.folder&&n.id&&0!==n.folder.indexOf("virtual/")&&n.id.indexOf(",")<0){var r=/^\d+\./.test(n.id)?n.id.replace(/\./,"/"):n.id;o=/^io.ox\/(mail|contacts|calendar|tasks)$/.test(n.app),_.url.hash({app:o?n.app+"/detail":n.app,folder:n.folder,id:r}),e.isDeepLink=!0}else n.m&&n.f&&n.i?(o=/^(mail|contacts|calendar|tasks)$/.test(n.m),_.url.hash({app:"io.ox/"+(o?n.m+"/detail":n.m),folder:n.f,id:n.i}),e.isDeepLink=!0):n.m&&n.f&&(_.url.hash({app:"io.ox/"+n.m,folder:n.f}),e.isDeepLink=!0);_.url.hash({m:null,f:null,i:null,"!!":void 0,"!":null}),_.device("smartphone")&&d();var u=_.url.hash("app"),c=u&&ox.ui.apps.get(l(u).name),s=a&&c&&c.get("deeplink"),f=void 0!==_.url.hash("mailto")&&u===ox.registry.get("mail-compose")+":compose";c&&(c.get("refreshable")||s)?e.autoLaunch=u.split(/,/):i.has("webmail")&&f?e.autoLaunch=["io.ox/mail/main"]:(c&&_.url.hash({app:null,folder:null,id:null}),e.autoLaunch=p())}},{id:"autoLaunchApps",index:120,run:function(e){t('Stage "autoLaunchApps"'),e.autoLaunchApps=_(e.autoLaunch).chain().map(function(e){return l(e).app}).compact().value()}},{id:"startLoad",index:130,run:function(o){function i(e){return function(i){var n=i&&i.message||"";throw console.error("core: Failed to load:",e,n,i,o),i}}t('Stage "startLoad"'),o.loaded=$.when(e.loadPlugins().fail(i("loadPlugins")),require(o.autoLaunchApps).fail(i("autoLaunchApps")),require(["io.ox/core/api/account"]).then(function(e){var o=$.Deferred();return e.all().always(o.resolve),o},i("account")))}},{id:"secretCheck",index:250,run:function(){if(t('Stage "secretCheck"'),ox.online&&ox.rampup&&ox.rampup.oauth){var e=ox.rampup.oauth.secretCheck;e&&!e.secretWorks&&(require(["io.ox/keychain/secretRecoveryDialog"],function(e){e.show()}),ox.debug&&console.error("Couldn't decrypt accounts: ",e.diagnosis))}}},{id:"drawDesktop",index:500,run:function(){e.point("io.ox/core/desktop").invoke("draw",$("#io-ox-desktop"),{}),ox.ui.windowManager.on("empty",function(o,i,n){if(i){e.point("io.ox/core/desktop").invoke("draw",$("#io-ox-desktop"),{}),ox.ui.screens.show("desktop");var a=l(n||r.get("autoStart","io.ox/mail/main")).app;"none/main"!==a&&ox.launch(a)}else ox.ui.screens.show("windowmanager")})}},{id:"load",index:600,run:function(e){return t('Stage "load"',e),e.loaded}},{id:"topbars",index:610,run:function(){if(t('Stage "load" > loaded.done'),e.point("io.ox/core/appcontrol").invoke("draw",s),_.device("smartphone")&&e.point("io.ox/core/mobile").invoke("draw"),e.point("io.ox/core/topbar").isEnabled("default")||($("#io-ox-screens").css("top","0px"),s.hide()),e.point("io.ox/core/plugins").invoke("draw"),t('Stage "load" > autoLaunch ...'),!ox.tabHandlingEnabled)return ox.ui.App.restore();require(["io.ox/core/api/tab"],function(e){return!e.isParentTab()||ox.ui.App.restore()})}},{id:"restoreLaunch",index:620,run:function(e){var n=_.copy(_.url.hash()),r=e.autoLaunch.length>0;if(_(e.autoLaunch).chain().map(function(e){return l(e)}).each(function(e,c){if(0===c&&(r=!1),!(_.device("smartphone")&&c>0||_.device("smartphone")&&ox.ui.apps.where({restored:!0,name:e.name}).length)){var s,l,d=_(n).pick("folder","id");if(t("Auto launch:",e.app,d),/detail\/main$/.test(e.app)){var p=e.app.replace(/\/detail/,"");(s=ox.launch(p,d)).done(function(){_.delay(function(){ox.launch(e.app,{cid:_.cid(d)})},1e3)})}else s=ox.launch(e.app,d);l=e.method,"io.ox/files"===n.app&&void 0!==n.id&&require(["io.ox/core/viewer/main","io.ox/files/api"],function(e,i){a.get(n.folder).done(function(){i.get(n).done(function(o){(new e).launch({files:[o],folder:n.folder})})}).fail(function(e){_.url.hash("id",null),o.yell(e)})}),l&&s.done(function(){_.isFunction(this[l])&&this[l]()});var f=_.url.hash("reg"),h=_(_.url.hash()).reduce(function(e,o,i){return"showfeedbackdialog"===i.toLowerCase()?o:e});if(f&&ox.registry.get(f)){var x,m=(_.url.hash("regopt")||"").split(","),g={};_.each(m,function(e){x=e.split(":"),g[x[0]]=x[1]}),s.done(function(){ox.registry.call(f,"client-onboarding",{data:g})})}"true"===h&&i.has("feedback")&&s.done(function(){require(["plugins/core/feedback/register"],function(e){e.show()})}),u.get("features/furigana",!1)&&require(["l10n/ja_JP/io.ox/register"])}}),r||ox.rampup&&ox.rampup.errors){var s=_.pluck(ox.rampup.errors,"error").join("\n\n");s=s||c("The requested application is not available at this moment."),o.yell({type:"error",error:s,duration:-1})}}},{id:"curtain",index:700,run:function(){t('Stage "curtain"');var e=$.Deferred();return $("#background-loader").idle().fadeOut(250,e.resolve),e}},{id:"ready",index:1e12,run:function(){t("DONE!"),ox.trigger("core:ready")}}),{restore:function(e){return c.ngettext("The below item was open last time you exited %1$s.","The below items were open last time you exited %1$s.",e,ox.serverConfig.productName)+" "+c('Please click "Continue" if you\'d like to continue editing.')+" "+c.ngettext("If you do not wish to keep the item, please click on the trash icon.","If you do not wish to keep an item, please click on the trash icon.",e)}}});