define("io.ox/core/attachments/backbone",["io.ox/core/folder/title","io.ox/core/capabilities","io.ox/contacts/api","settings!io.ox/mail"],function(e,t,i,n){"use strict";var r=function(){var e,t=0,i=$.Deferred(),n=function(){t=Math.floor(t+e/10),i.notify({loaded:t,total:e}),t/e>=1?i.resolve({data:["133713371337"]}):_.delay(n,1e3)};this.upload=function(t){return e=t.size,n(),i}},o=/\.((?:doc|dot|pot|pps|ppt|xls|xlt)[mx]?|o[dt][cfgipst]|odm|pdf|ppam?|rtf|txt|xlam?|xlsb)$/i,a=/\.(gif|bmp|jpe?g|gmp|png|psd|tif?f|heic?f?)$/i,l={localFile:function(e){var t=2*(_.device("retina")?240:120);return require(["io.ox/contacts/widgets/canvasresize"]).then(function(i){return i(e.fileObj||e.get("originalFile"),{width:t,height:t,crop:!1,quality:80})}).then(function(t){var i=_.clone(e.get("meta"));return i.previewUrl=t,e.set("meta",i),t})},contact:function(e){var t=_.clone(e.get("meta"));return t.previewUrl=e.get("image1_url")||i.getFallbackImage(),e.set("meta",t),$.Deferred().resolve(t.previewUrl)},file:function(e){var t=$.Deferred(),i=_.device("retina")?240:120;return require(["io.ox/files/api"],function(n){var r=_.clone(e.get("meta"));r.previewUrl=n.getUrl(e.toJSON(),"view")+"&scaleType=cover&width="+i+"&height="+i,a.test(e.get("filename"))||(r.previewUrl+="&format=preview_image&session="+ox.session),t.resolve(r.previewUrl),e.set("meta",r)},t.reject),t},mail:function(e){var t=$.Deferred(),i=_.device("retina")?240:120;return require(["io.ox/mail/api"],function(n){var r=_.clone(e.get("meta"));r.previewUrl=n.getUrl(e.toJSON(),"view")+"&scaleType=cover&width="+i+"&height="+i;var o=e.get("security");o&&o.authentication&&(r.previewUrl+="&decrypt=true&cryptoAuth="+encodeURIComponent(o.authentication)),a.test(e.get("filename")||e.get("name"))||(r.previewUrl+="&format=preview_image&session="+ox.session),t.resolve(r.previewUrl),e.set("meta",r)},t.reject),t}},s=Backbone.Model.extend({defaults:function(){return{filename:"",disp:"attachment",uploaded:1,meta:{}}},initialize:function(e){if(e instanceof window.Blob&&(this.fileObj=e,this.set("filename",e.name,{silent:!0}),this.set("uploaded",0,{silent:!0}),this.set("file_size",e.size,{silent:!0})),this.isContact()){var t=(this.get("display_name")||this.get("sort_name")||"vcard").replace(/\s/,"_").concat(".vcf");this.set("filename",t,{silent:!0})}},getTitle:function(){return this.get("com.openexchange.file.sanitizedFilename")||this.get("filename")||this.get("name")},getShortTitle:function(t){return e(this.getTitle(),t||30)},getSize:function(){return this.get("file_size")||this.get("size")||0},getExtension:function(){var e=String(this.get("filename")||this.get("name")||"").split(".");return 1===e.length?"":e.pop().toLowerCase()},isFileAttachment:function(){return("attachment"===this.get("disp")||"ATTACHMENT"===this.get("contentDisposition")||"inline"===this.get("disp"))&&"INLINE"!==this.get("contentDisposition")&&!!this.getTitle()},isContact:function(){return"contact"===this.get("group")},isLocalFile:function(){return"localFile"===this.get("group")},needsUpload:function(){return 0===this.get("uploaded")},previewUrl:function(e){e=e||{};var i,r=t.has("document_preview"),s=this.get("filename")||this.get("name"),c=this.fileObj||this.get("originalFile");if(this.isLocalFile()&&s.match(/psd|tif/))return null;if(!this.isFileAttachment())return null;if(!a.test(s)&&!(r&&o.test(s)||this.isContact()))return null;if("localFile"===this.get("group")&&r&&o.test(s))return null;if("localFile"===this.get("group")&&c.size>=n.get("features/imageResize/fileSizeMax",10485760))return null;if(i=!!this.get("meta")&&this.get("meta").previewUrl)return i;var u=l[this.get("group")];return u?e.delayExecution?u.bind(this,this):u(this):null},upload:function(){if("FormData"in window){(new FormData).append("file",this.fileObj);var e=this;(new r).upload(this.fileObj).then(function(){var t=i.getFallbackImage(),n=_.clone(e.get("meta"));n.previewUrl=n.previewUrl||t,e.set("meta",n),e.trigger("upload:complete")},function(){},function(t){e.set("uploaded",t.loaded/t.total)})}}});return{Model:s,Collection:Backbone.Collection.extend({model:s,fileAttachments:function(){return this.filter(function(e){return e.isFileAttachment()})},mailAttachments:function(){return this.filter(function(e){return"inline"===e.get("disp")||"attachment"===e.get("disp")}).map(function(e,t){var i;return 0===t&&"text/plain"===e.attributes.content_type?(i=e.pick("content_type","content")).raw=!0:i=e.attributes,i})},getSize:function(){return this.reduce(function(e,t){return e+t.getSize()},0)},isValidModel:function(e){return e.isFileAttachment()},getValidModels:function(){return this.filter(this.isValidModel,this)}})}});