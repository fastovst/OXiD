define("io.ox/core/extensions",["io.ox/core/event"],function(n){"use strict";function e(){return!1}function t(){return!0}function i(n,e){_(e).each(function(e,t){_.isArray(e)?_(e).each(function(e){n.disable(t,e)}):n.disable(t,e)})}function r(n){return n instanceof r?n:this instanceof r?(this.data={},this.options={},this.flow={disable:{}},this.$={},void _.extend(this,_(n).omit("isDefaultPrevented","isPropagationStopped"))):new r(n)}var o,s={},a=function(n,e){return"first"===n.index?-1:"first"===e.index?1:"last"===n.index?1:"last"===e.index?-1:n.index-e.index};$(window).on("unload",function(){_(s).each(function(n){n.clear()}),s={}});var u=function(e){function t(n,e){return function(n,t){var i=$.makeArray(arguments).slice(2),r=e[n];if(r)return r.apply(t,i)}}function i(){return Math.round(Math.random())-.5}this.id=String(e.id),this.description=e.description||"";var o=[],s={},u={},c={},d=function(){return _.chain(o).select(function(n){return!c[n.id]&&!c["*"]})},f=function(n){return _(o).select(function(e){return e.id===n}).length>0},h=this,l=function(){function n(e){if(r[e.id])throw new Error("Circular References detected for extension point "+h.id+" and extension "+e.id);r[e.id]=!0;var s=t[e.id];s&&(delete t[e.id],s.sort(a),_(s).each(n)),o.push(e);var u=i[e.id];u&&(delete i[e.id],u.sort(a),_(u).each(n)),delete r[e.id]}var e=[],t=s.before||{},i=s.after||{};_(o).each(function(n){var r;n.before?(r=t[n.before])||(r=t[n.before]=[]):n.after?(r=i[n.after])||(r=i[n.after]=[]):r=e,r.push(n)}),o=[],e.sort(a);var r={};_(e).each(n),s.before=t,s.after=i};n.extend(this),this.has=f,this.extend=function(){var n=_(arguments).flatten();return _(n).each(function(n){if(n.invoke)throw console.error(n),new Error("Extensions must not have their own invoke method");var e=n.id;if(e?n.index=n.index||1e9:(n.id=e="default",n.index=n.index||100),f(e))ox.debug&&_.device("!karma")&&console.warn("Extensions MUST HAVE unique identifiers! Point: %s ID: %s",this.id,n.id);else{if("enabled"in n){if(_.isObject(n.enabled))return console.error("Extending of '"+this.id+"' with '"+e+"' failed. Ensure extensions 'enabled' property is a primitive.");n.enabled||this.disable(e),delete n.enabled}n.invoke=t(0,n),_(u[e]).each(function(e){_.extend(n,_.isFunction(e)?e(_.extend({},n)):e)}),delete u[e],o.push(n),l(),n.metadata||(n.metadata=function(n,e){if(this[n])return _.isFunction(this[n])?this[n].apply(this,e):this[n]}),this.trigger("extended",n)}},this),this},this.replace=function(n,e){var t=2===arguments.length?n:n.id;if(!t)throw new Error("Replacements must have an id!");return _(o).find(function(i){return i.id===t&&(_.extend(i,e?e(_.extend({},i)):n),!0)})?l():(u[t]=u[t]||[]).push(e||n),this},this.clear=function(){o={},u={}},this.all=function(){return o},this.get=function(n,e){var t=_(o).chain().filter(function(e){return e.id===n}).first().value();return _.isFunction(e)?(t&&(e(t),l()),this):t},this.keys=function(){return _(o).pluck("id")},this.sort=function(){return l(),this},this.list=function(){return d().value()},this.chain=function(){return d()},this.each=function(n){return d().each(n),this},this.map=function(n){return d().map(n)},this.filter=this.select=function(n){return d().select(n).value()},this.reduce=this.inject=function(n,e){return d().inject(n,e).value()},this.pluck=function(n){return d().pluck(n).value()},this.invoke=function(n,e,t){function i(t){console.error('point("'+h.id+'").invoke("'+n+'")',t.message,{args:s.slice(3),context:e,exeption:t})}var o=d(),s=["invoke"].concat($.makeArray(arguments));if(t instanceof r){var a=t.invoke;try{return t.invoke={name:n,id:this.id},o.map(function(i){if(!t.isDisabled(h.id,i.id)&&_.isFunction(i[n])&&!(t.isPropagationStopped()||"default"===i.id&&t.isDefaultPrevented()))return t.extension=i,i[n].apply(e,s.slice(3))})}catch(n){i(n)}finally{t.invoke=a}}else try{return o.invoke.apply(o,s)}catch(n){i(n)}},this.disable=function(n){return c[n]=!0,this},this.enable=function(n){return delete c[n],this},this.toggle=function(n,e){return(e=_.isBoolean(e)?e:c[n])?this.enable(n):this.disable(n)},this.isEnabled=function(n){return!c[n]&&!c["*"]},this.inspect=function(){console.debug("Extension point",this.id,{disabled:c,replacements:u,extensions:JSON.stringify(this.all())})},this.cascade=function(n,e){e=r.ensure(e);var t=this;return t.reduce(function(i,r){return i&&i.then||(i=$.when(i)),i.then(function(){if(!e.isPropagationStopped()&&!e.isDisabled(t.id,r.id))return r.perform.apply(n,[e])},function(i){if(!e.catchErrors)throw i;if(i&&i.error&&(e.error=i.error),i&&i.code&&(e.errorCode=i.code),i&&i.warnings&&(e.warning=i.warnings),e.rejected=!0,!e.isPropagationStopped()&&!e.isDisabled(t.id,r.id))return r.perform.apply(n,[e])})},$.when())},this.count=function(){return d().value().length},this.shuffle=function(){return o.sort(i),_(o).each(function(n,e){n.index=100+100*e}),this},this.options=function(n){var e=n||{};return this.each(function(n){e=_.extend(e,n)}),delete e.id,delete e.index,delete e.invoke,delete e.metadata,e},this.prop=function(n){return d().pluck(n).compact().first().value()}};return r.ensure=function(n){return n instanceof r?n:new r("data"in n?n:{data:n})},r.prototype={isDefaultPrevented:e,isPropagationStopped:e,preventDefault:function(){this.isDefaultPrevented=t},stopPropagation:function(){this.isPropagationStopped=t},resumePropagation:function(){this.isPropagationStopped=e},first:function(){return _.isArray(this.data)?this.data[0]:this.data},array:function(){return[].concat(this.data)},set:function(n,e){return _.extend(this[n],e),this},clone:function(n){var e=new r;return _(this).each(function(n,t){e[t]=_.extend({},n)}),_(n||{}).each(function(n,t){e[t]=_.extend({},n)}),e},dispose:function(){for(var n in this)this.hasOwnProperty(n)&&(this[n]=null);this.disposed=!0},enable:function(n,e){arguments.length<2&&console.warn("Baton.enable(pointId, extensionId) needs two arguments!");var t=this.flow.disable;t[n]&&(t[n]=_(t[n]).without(e))},disable:function(n,e){if(_.isObject(n)||!n)return i(this,n);arguments.length<2&&console.warn("Baton.disable(pointId, extensionId) needs two arguments!");var t=this.flow.disable;(t[n]=t[n]||[]).push(e)},isDisabled:function(n,e){var t=this.flow.disable[n];return void 0!==t&&_(t).contains(e)},branch:function(n,e,t){var i=this.$el;return this.$el=t,o.point(this.invoke.id+"/"+n).invoke(this.invoke.name,e||t,this),this.$el=i,t}},r.wrap=function(n){return n instanceof r?n:new r(n)},o={point:function(n){return n=n||"",void 0!==s[n]?s[n]:s[n]=new u({id:n})},keys:function(){return _.keys(s)},getPlugins:function(n){var e=_.extend({name:ox.signin?"signin":"core",prefix:"plugins/",suffix:"register",nameOnly:!1},n),t=ox.serverConfig.plugins||{};return _(t[e.name]||[]).map(function(n){return e.nameOnly?n:e.prefix+n+"/"+e.suffix})},loadPlugins:function(n){return require(this.getPlugins(n)).fail(function(n){console.error(n)})},Baton:r,indexSorter:a}});