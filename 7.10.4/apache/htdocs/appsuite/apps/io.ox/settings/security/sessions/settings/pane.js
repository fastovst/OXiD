define("io.ox/settings/security/sessions/settings/pane",["io.ox/core/extensions","io.ox/backbone/views/extensible","gettext!io.ox/core","io.ox/core/http","io.ox/backbone/mini-views/settings-list-view","io.ox/backbone/views/disposable","io.ox/backbone/mini-views/listutils","settings!io.ox/core","less!io.ox/settings/security/sessions/settings/style"],function(e,i,t,n,o,s,a,c){"use strict";function l(e,i){var n=new $.Deferred;return i=i||t("Ok"),require(["io.ox/backbone/views/modal"],function(t){new t({title:e,async:!0}).build(function(){this.$body.remove()}).addCancelButton().addButton({label:i,action:"ok"}).on("ok",n.resolve).open()}),n.promise()}var d=Backbone.Model.extend({idAttribute:"sessionId",initialize:function(){e.point("io.ox/settings/sessions/deviceType").invoke("customize",this),e.point("io.ox/settings/sessions/operatingSystem").invoke("customize",this),e.point("io.ox/settings/sessions/application").invoke("customize",this)},getDeviceInfo:function(e){return(this.get("device")||{})[e]||{}}});e.point("io.ox/settings/sessions/deviceType").extend({id:"desktop-mobile",index:100,customize:function(){var e=this.getDeviceInfo("os").name||"";"ios"===e||"android"===e?this.set("deviceType","phone"):this.set("deviceType","desktop")}}),e.point("io.ox/settings/sessions/operatingSystem").extend({id:"os",index:100,customize:function(){var e={windows:t("Windows"),linux:t("Linux"),macos:t("Mac"),ios:t("iOS"),android:t("Android")};return function(){var i=this.getDeviceInfo("os").name||"";this.set("operatingSystem",e[i])}}()}),e.point("io.ox/settings/sessions/application").extend({id:"browsers",index:100,customize:function(){var e={chrome:t("Chrome"),safari:t("Safari"),"mobile safari":t("Safari"),firefox:t("Firefox"),edge:t("Edge"),msie:t("Internet Explorer"),opera:t("Opera"),chromium:t("Chromium")};return function(){var i=this.getDeviceInfo("client");if("browser"===i.type){var t=i.family||"",n=i.name||"";this.set("application",e[t]||e[n])}}}()}),e.point("io.ox/settings/sessions/application").extend({id:"oxapp",index:200,customize:function(){var e={oxdriveapp:c.get("productname/oxdrive")||"OXDrive",oxmailapp:c.get("productname/mailapp")||"OX Mail",oxsyncapp:c.get("productname/oxsync")||"OX Sync"};return function(){var i=this.getDeviceInfo("client");if("oxapp"===i.type){var t=i.family||i.name||"",n=i.name||"";this.set("application",e[t]||e[n])}}}()}),e.point("io.ox/settings/sessions/application").extend({id:"dav",index:300,customize:function(){var e={macos_calendar:t("Calendar"),macos_addressbook:t("Addressbook"),"ios_calendar/addressbook":t("Calendar/Addressbook"),thunderbird_lightning:t("Thunderbird Lightning"),emclient:t("eM Client"),emclient_appsuite:t("Appsuite eM Client"),caldav_sync:t("CalDav"),carddav_sync:t("CardDav"),davdroid:t("DAVdroid"),windows_phone:t("CalDav/CardDav"),windows:t("CalDav/CardDav"),generic_caldav:t("CalDav"),generic_carddav:t("CardDav"),webdav:t("WebDAV")};return function(){var i=this.getDeviceInfo("client");if("dav"===i.type){var n=i.family||i.name||"",o=i.name||"";this.set("application",e[n]||e[o]||t("CalDav/CardDav"))}}}()}),e.point("io.ox/settings/sessions/application").extend({id:"eas",index:400,customize:function(){var e={usmeasclient:t("Exchange Active Sync")};return function(){var i=this.getDeviceInfo("client");if("eas"===i.type){var n=i.family||"",o=i.name||"";this.set("application",e[n]||e[o]||t("Exchange Active Sync"))}}}()});var r=Backbone.Collection.extend({model:d,comparator:function(e){return e.get("sessionId")===ox.session?-Number.MAX_VALUE:e.has("lastActive")?-e.get("lastActive"):Number.MAX_VALUE},initialize:function(){this.initial=this.fetch()},fetch:function(){var e=this;return n.GET({url:ox.apiRoot+"/sessionmanagement",params:{action:"all"}}).then(function(i){e.set(i)})}}),p=s.extend({tagName:"li",className:"settings-list-item",events:{'click a[data-action="delete"]':"onDelete"},render:function(){var e=this.model.get("sessionId")===ox.session,i=this.model.has("lastActive")?moment(this.model.get("lastActive")).fromNow():"";return this.$el.empty().append($('<div class="list-item-content">').append($('<div class="fa-stack client-icon">').addClass(this.model.get("deviceType")).addClass(this.model.get("os")).append($('<i class="fa fa-stack-1x device" aria-hidden="true">'),$('<i class="fa fa-stack-1x os" aria-hidden="true">')),$('<div class="primary">').append($("<span>").text(this.model.get("application")||t("Unknown application")),$("<span>").text("("+(this.model.get("operatingSystem")||t("Unknown device"))+")")),$('<div class="secondary">').append($("<span>").text(this.model.get("location")),e?$('<span class="label label-success">').text(t("Now active")):$("<span>").text(i))),$('<div class="list-item-controls">').append(e?"":$('<a href="#" class="action" data-action="delete">').text(t("Sign out")))),this},onDelete:function(e){var i=this,o=this.collection;e.preventDefault(),l(t("Do you really want to sign out from that device?"),t("Sign out")).done(function(){var e=this;n.PUT({url:ox.apiRoot+"/sessionmanagement",params:{action:"delete"},data:[i.model.get("sessionId")]}).fail(function(e){require(["io.ox/core/yell"],function(i){i(e)}),o.fetch()}).always(function(){e.close()}),i.model.trigger("destroy",i.model)})}}),u=Backbone.View.extend({className:"session-list-container",initialize:function(){this.$el.data("view",this),this.collection.on("update",_.bind(this.render,this))},render:function(){var e=this;return this.$el.empty().append(e.listView=new o({collection:e.collection,childView:p,childOptions:{collection:e.collection}}).render().$el),this}});return e.point("io.ox/settings/security/sessions/settings/detail").extend({id:"view",index:100,draw:function(){var e=new r;this.append(new i({point:"io.ox/settings/sessions/settings/detail/view",collection:e}).render().$el),ox.on("refresh^",function(){e.fetch()})}}),e.point("io.ox/settings/sessions/settings/detail/view").extend({id:"title",index:100,render:function(){this.$el.addClass("io-ox-session-settings").append($("<h1>").text(t("You are currently signed in with the following devices")))}}),e.point("io.ox/settings/sessions/settings/detail/view").extend({id:"spinner",index:200,render:function(e){var i;this.$el.append(i=$("<div>").busy()),e.view.collection.initial.always(function(){i.remove()})}}),e.point("io.ox/settings/sessions/settings/detail/view").extend({id:"list",index:300,render:function(e){this.$el.append(new u({collection:e.view.collection}).render().$el)}}),e.point("io.ox/settings/sessions/settings/detail/view").extend({id:"remove-all",index:1e3,render:function(e){var i;this.$el.append(i=$('<button data-action="remove-all" class="btn btn-primary hidden">').text(t("Sign out from all clients")).on("click",function(i){i.preventDefault(),l(t("Do you really want to sign out from all clients except the current one?"),t("Sign out")).done(function(){var i=this;this.busy(),n.GET({url:ox.apiRoot+"/sessionmanagement",params:{action:"clear"}}).fail(function(e){require(["io.ox/core/yell"],function(i){i(e)})}).always(function(){e.view.collection.fetch().always(i.close)})})})),e.view.collection.initial.done(function(){0!==e.view.collection.length&&i.removeClass("hidden")})}}),{Model:d,Collection:r,View:u}});