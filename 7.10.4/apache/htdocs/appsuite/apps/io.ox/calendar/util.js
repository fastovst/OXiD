define("io.ox/calendar/util",["io.ox/core/api/user","io.ox/contacts/api","io.ox/core/api/group","io.ox/core/folder/api","io.ox/core/util","io.ox/backbone/views/modal","settings!io.ox/calendar","settings!io.ox/core","gettext!io.ox/calendar","io.ox/core/a11y"],function(e,t,a,n,r,o,i,l,s,u){"use strict";var c=[s("fifth / last"),"",s("first"),s("second"),s("third"),s("fourth"),s("fifth / last")],d="NEEDS-ACTION ACCEPTED DECLINED TENTATIVE".split(" "),m=[s("unconfirmed"),s("accepted"),s("declined"),s("tentative")],f=["",'<i class="fa fa-check" aria-hidden="true">','<i class="fa fa-times" aria-hidden="true">','<i class="fa fa-question-circle" aria-hidden="true">'],p=[s.pgettext("superessive","Sunday"),s.pgettext("superessive","Monday"),s.pgettext("superessive","Tuesday"),s.pgettext("superessive","Wednesday"),s.pgettext("superessive","Thursday"),s.pgettext("superessive","Friday"),s.pgettext("superessive","Saturday")],g=["","INDIVIDUAL","GROUP","RESOURCE","RESOURCE","INDIVIDUAL"],v={columns:{title:s("Subject"),location:s("Location"),note:s("Description")},days:{SUNDAY:1,MONDAY:2,TUESDAY:4,WEDNESDAY:8,THURSDAY:16,FRIDAY:32,SATURDAY:64},colors:[{label:s("light red"),value:"#FFE2E2"},{label:s("light orange"),value:"#FDE2B9"},{label:s("light yellow"),value:"#FFEEB0"},{label:s("light olive"),value:"#E6EFBD"},{label:s("light green"),value:"#CAF1D0"},{label:s("light cyan"),value:"#CCF4FF"},{label:s("light azure"),value:"#CFE6FF"},{label:s("light blue"),value:"#D4E0FD"},{label:s("light indigo"),value:"#D1D6FE"},{label:s("light purple"),value:"#E2D0FF"},{label:s("light magenta"),value:"#F7CBF8"},{label:s("light pink"),value:"#F7C7E0"},{label:s("light gray"),value:"#EBEBEB"},{label:s("red"),value:"#F5AAAA"},{label:s("orange"),value:"#FFB341"},{label:s("yellow"),value:"#FFCF1A"},{label:s("olive"),value:"#C5D481"},{label:s("green"),value:"#AFDDA0"},{label:s("cyan"),value:"#A2D9E7"},{label:s("azure"),value:"#9BC8F7"},{label:s("blue"),value:"#B1C3EE"},{label:s("indigo"),value:"#949EEC"},{label:s("purple"),value:"#B89AE9"},{label:s("magenta"),value:"#D383D5"},{label:s("pink"),value:"#E18BB8"},{label:s("gray"),value:"#C5C5C5"},{label:s("dark red"),value:"#C84646"},{label:s("dark orange"),value:"#B95900"},{label:s("dark yellow"),value:"#935700"},{label:s("dark olive"),value:"#66761F"},{label:s("dark green"),value:"#376B27"},{label:s("dark cyan"),value:"#396D7B"},{label:s("dark azure"),value:"#27609C"},{label:s("dark blue"),value:"#445F9F"},{label:s("dark indigo"),value:"#5E6AC1"},{label:s("dark purple"),value:"#734EAF"},{label:s("dark magenta"),value:"#9A369C"},{label:s("dark pink"),value:"#A4326D"},{label:s("dark gray"),value:"#6B6B6B"}],PRIVATE_EVENT_COLOR:"#616161",ZULU_FORMAT:"YYYYMMDD[T]HHmmss[Z]",getFirstWeekDay:function(){return moment.localeData().firstDayOfWeek()},getDaysInMonth:function(e,t){return moment([e,t+1]).daysInMonth()},isToday:function(e){return moment().isSame(e,"day")},getTime:function(e){return e.format("LT")},getDate:function(e){return moment(e||void 0).format("ddd, l")},getSmartDate:function(e){return e.getMoment("startDate").calendar()},getEvenSmarterDate:function(e){var t=e.getMoment("startDate").tz(moment().tz()),a=moment().startOf("day");return t.isBefore(a)?t.isAfter(a.subtract(1,"day"))?s("Yesterday")+", "+t.format("l"):t.format("ddd, l"):t.isBefore(a.add(1,"days"))?s("Today")+", "+t.format("l"):t.isBefore(a.add(1,"day"))?s("Tomorrow")+", "+t.format("l"):t.format("ddd, l")},getDateTimeIntervalMarkup:function(e,t){if(e&&e.startDate&&e.endDate){(t=_.extend({timeZoneLabel:{placement:_.device("touch")?"bottom":"top"},a11y:!1,output:"markup"},t)).container&&t.container.parents("#io-ox-core").length<1&&(t.timeZoneLabel.container="body");var a,n,r,o,i=v.getMoment(e.startDate).zoneAbbr(),l=t.a11y?"dddd, l":"ddd, l";return v.isAllday(e)?(a=moment.utc(e.startDate.value).local(!0),n=moment.utc(e.endDate.value).local(!0).subtract(1,"days")):(a=v.getMoment(e.startDate),n=v.getMoment(e.endDate),t.zone&&(a.tz(t.zone),n.tz(t.zone),i=a.zoneAbbr())),a.isSame(n,"day")?(r=a.format(l),o=this.getTimeInterval(e,t.zone)):v.isAllday(e)?(r=this.getDateInterval(e),o=this.getTimeInterval(e,t.zone)):r=a.formatInterval(n,l+" LT"),"strings"===t.output?{dateStr:r,timeStr:o||"",timeZoneStr:i}:$('<div class="date-time">').append($('<span class="date">').text(r),$.txt("   "),$('<span class="time">').append(o?$.txt(o):"",e.startDate.tzid&&!t.noTimezoneLabel?this.addTimezonePopover($('<span class="label label-default pointer" tabindex="0">').text(i),e,t.timeZoneLabel):""))}return""},getDateInterval:function(e,t,a){if(e&&e.startDate&&e.endDate){var n,r,o=a?"dddd, l":"ddd, l";return a=a||!1,v.isAllday(e)?(n=moment.utc(e.startDate.value).local(!0),r=moment.utc(e.endDate.value).local(!0).subtract(1,"days")):(n=v.getMoment(e.startDate),r=v.getMoment(e.endDate),t&&(n.tz(t),r.tz(t))),n.isSame(r,"day")?n.format(o):a&&v.isAllday(e)?s("%1$s to %2$s",n.format(o),r.format(o)):n.formatInterval(r,"yMEd",{alwaysFullDate:!0})}return""},getDateIntervalA11y:function(e,t){return this.getDateInterval(e,t,!0)},getTimeInterval:function(e,t,a){if(!e||!e.startDate||!e.endDate)return"";if(v.isAllday(e))return this.getFullTimeInterval(e,!0);var n=v.getMoment(e.startDate),r=v.getMoment(e.endDate);return t&&(n.tz(t),r.tz(t)),a?s("%1$s to %2$s",n.format("LT"),r.format("LT")):n.formatInterval(r,"time")},getTimeIntervalA11y:function(e,t){return this.getTimeInterval(e,t,!0)},getFullTimeInterval:function(e,t){var a=this.getDurationInDays(e);return a<=1&&t?s("Whole day"):s.format(s.ngettext("%d day","%d days",a),a)},getReminderOptions:function(){var e={},t=[{value:"PT0M",format:"minutes"},{value:"PT5M",format:"minutes"},{value:"PT10M",format:"minutes"},{value:"PT15M",format:"minutes"},{value:"PT30M",format:"minutes"},{value:"PT45M",format:"minutes"},{value:"PT1H",format:"hours"},{value:"PT2H",format:"hours"},{value:"PT4H",format:"hours"},{value:"PT6H",format:"hours"},{value:"PT8H",format:"hours"},{value:"PT12H",format:"hours"},{value:"P1D",format:"days"},{value:"P2D",format:"days"},{value:"P3D",format:"days"},{value:"P4D",format:"days"},{value:"P5D",format:"days"},{value:"P6D",format:"days"},{value:"P1W",format:"weeks"},{value:"P2W",format:"weeks"},{value:"P3W",format:"weeks"},{value:"P4W",format:"weeks"}];return _(t).each(function(t){var a=t.value.match(/\d+/)[0];switch(t.format){case"minutes":e[t.value]=s.format(s.ngettext("%1$d minute","%1$d minutes",a),a);break;case"hours":e[t.value]=s.format(s.ngettext("%1$d hour","%1$d hours",a),a);break;case"days":e[t.value]=s.format(s.ngettext("%1$d day","%1$d days",a),a);break;case"weeks":e[t.value]=s.format(s.ngettext("%1$d week","%1$d weeks",a),a)}}),e},onSameDay:function(e,t){return moment(e).isSame(t,"day")},getDurationInDays:function(e){return v.getMoment(e.endDate).diff(v.getMoment(e.startDate),"days")},getStartAndEndTime:function(e){var t=[];return e&&e.startDate&&e.endDate?(v.isAllday(e)?t.push(this.getFullTimeInterval(e,!1)):t.push(moment.tz(e.startDate.value,e.startDate.tzid||moment().tz()).tz(moment().tz()).format("LT"),moment.tz(e.endDate.value,e.endDate.tzid||moment().tz()).tz(moment().tz()).format("LT")),t):t},addTimezoneLabel:function(e,t,a){var n=moment(t.startDate);return t.startDate.value&&(n=v.getMoment(t[a.attrName||"startDate"])),e.append($.txt(this.getTimeInterval(t)),this.addTimezonePopover($('<span class="label label-default pointer" tabindex="0">').text(n.zoneAbbr()),t,a)),e},addTimezonePopover:function(){function e(e){var t=$('<ul class="list-unstyled">'),a=i.get("favoriteTimezones");return a&&0!==a.length||(a=["America/Los_Angeles","America/New_York","Europe/London","Europe/Berlin","Australia/Sydney"]),_(a).chain().uniq().first(10).each(function(a){var n=/(North|East|South|West|Central)/.test(a)?a:a.replace(/^.*?\//,"");t.append($("<li>").append($("<span>").text(n.replace(/_/g," ")),$('<span class="time">').text(v.getTimeInterval(e,a))))}),t}function t(e){return v.getTimeInterval(e,v.getMoment(e.startDate).tz())+" "+v.getMoment(e.startDate).zoneAbbr()}function a(e){var t=!1;e.on("focusout blur",function(e){t&&(e.preventDefault(),e.stopImmediatePropagation())}).on("show.bs.popover",function(){e.on("keydown.a11y",function(a){if(9===a.which&&!a.shiftKey){var n=e.attr("aria-describedby"),r=$("#"+n);0!==r.length&&(a.preventDefault(),t=!0,r.attr("tabindex",-1).focus(),_.defer(function(){t=!1}),r.on("keydown.a11y",function(a){9===a.which&&(a.preventDefault(),r.off("keydown.a11y"),a.shiftKey?(t=!0,e.focus(),_.defer(function(){t=!1})):(u.getNextTabbable(e).focus(),e.popover("hide")))}).on("blur",function(){t||e.popover("hide")}))}})}).on("hide.bs.popover",function(e){$(e.target).off("keydown.a11y"),t=!1})}return function(n,r,o){return o=_.extend({placement:"left",trigger:"hover focus"},o),a(n),n.popover({container:o.container||"#io-ox-core",viewport:{selector:"#io-ox-core",padding:10},content:e.bind(null,r),html:!0,placement:function(e){return $(e).addClass("timezones"),o.placement},title:t.bind(null,r),trigger:o.trigger}).on("blur dispose",function(){$(this).popover("hide"),$(this).data("bs.popover").inState.click=!1}),o.closeOnScroll&&n.on("shown.bs.popover",function(){n.scrollParent().one("scroll",function(){n.popover("hide"),n.data("bs.popover").inState.click=!1})}),n}}(),getShownAsClass:function(e){return v.hasFlag(e,"transparent")?"free":"reserved"},getShownAsLabel:function(e){return v.hasFlag(e,"transparent")?"free":"label-info"},getShownAs:function(e){return s(v.hasFlag(e,"transparent")?"Free":"Reserved")},getConfirmationSymbol:function(e){return f[(_(e).isNumber()?e:d.indexOf(e))||0]},getConfirmationClass:function(e){return(_(e).isNumber()?d[e]:e||"NEEDS-ACTION").toLowerCase()},getConfirmationLabel:function(e){return m[(_(e).isNumber()?e:d.indexOf(e))||0]},getRecurrenceDescription:function(e){function t(e){return c[e+1]}function a(e,t){t=_.extend({superessive:!1},t);var a=moment.localeData().firstDayOfWeek(),n=_(_.range(7)).chain().map(function(n){if(0!=(e&1<<(n+a)%7))return t.superessive?p[(n+a)%7]:moment().weekday(n).format("dddd")}).compact().value(),r=s(" and "),o=s(", ");return 2===n.length?n.join(r):n.join(o)}function n(e){return moment.months()[e]}var r="",o=e.interval,l=e.days||null,u=e.month,d=e.day_in_month;switch(e.recurrence_type){case 1:r=s.npgettext("daily","Every day.","Every %1$d days.",o,o);break;case 2:r=127===l?s.npgettext("weekly","Every day.","Every %1$d weeks on all days.",o,o):l===function(){var e,t=0;for(e=0;e<i.get("numDaysWorkweek");e++)t+=1<<(i.get("workweekStart")+e)%7;return t}()?s.npgettext("weekly","On workdays.","Every %1$d weeks on workdays.",o,o):65===l?s.npgettext("weekly","Every weekend.","Every %1$d weeks on weekends.",o,o):s.npgettext("weekly","Every %2$s.","Every %1$d weeks on %2$s.",o,o,a(l,{superessive:o>1}));break;case 3:r=null===l?s.npgettext("monthly","Every month on day %2$d.","Every %1$d months on day %2$d.",o,o,d):s.npgettext("monthly","Every month on the %2$s %3$s.","Every %1$d months on the %2$s %3$s.",o,o,t(d),a(l));break;case 4:r=null===l?s("Every year in %1$s on day %2$d.",n(u),d):s("Every year on the %1$s %2$s in %3$d.",t(d),a(l),n(u))}return r},getRecurrenceEnd:function(e){var t;if(e.until)t=s("The series ends on %1$s.",e.startDate.tzid?moment(e.until).utc().format("l"):moment(e.until).format("l"));else if(e.occurrences){var a=e.occurrences;t=s.format(s.ngettext("The series ends after one occurrence.","The series ends after %1$d occurences.",a),a)}else t=s("The series never ends.");return t},getRecurrenceString:function(e){e.rrule&&(e=new(require("io.ox/calendar/model").Model)(e)),e instanceof Backbone.Model&&e.getRruleMapModel&&(e=e.getRruleMapModel()),e instanceof Backbone.Model&&(e=e.toJSON());var t=v.getRecurrenceDescription(e);return e.recurrence_type>0&&(e.until||e.occurrences)&&(t+=" "+v.getRecurrenceEnd(e)),t},updateRecurrenceDate:function(e,t){if(e&&t){var a=e.getRruleMapModel(),n=a.get("recurrence_type");if(0!==n){var r=e.getMoment("startDate");if(2===n){var o=moment(r).startOf("day"),i=moment(t).startOf("day"),l=o.diff(i,"days")%7,s=a.get("days");l<0&&(l+=7);for(var u=0;u<l;u++)(s<<=1)>127&&(s-=127);a.set("days",s)}return 3!==n&&4!==n||(a.has("days")?a.set({day_in_month:1+((r.date()-1)/7>>0),days:1<<r.day()}):a.set("day_in_month",r.date())),4===n&&a.set("month",r.month()),a.get("until")&&moment(a.get("until")).isBefore(r)&&a.set({until:void 0,occurrences:void 0}),a.serialize(),e}}},getAttendeeName:function(e){return e?e.cn||e.email||e.uri:""},getNote:function(e,t){t=t||"description";var a=$.trim(e[t]||(e.get?e.get(t):"")).replace(/\n{3,}/g,"\n\n").replace(/</g,"&lt;");return r.urlify(a).replace(/\n/g,"<br>")},getConfirmations:function(e){var t={};return e&&(_(e.users).each(function(e){t[String(e.id)]={status:e.confirmation||0},e.confirmmessage&&(t[String(e.id)].comment=e.confirmmessage)}),_(e.confirmations).each(function(e){t[e.mail]={status:e.status||0},(e.message||e.confirmmessage)&&(t[String(e.id)].comment=e.message||e.confirmmessage)})),t},getConfirmationStatus:function(e,t){return e instanceof Backbone.Model||(e=new(require("io.ox/calendar/model").Model)(e)),e.hasFlag("accepted")?"ACCEPTED":e.hasFlag("tentative")?"TENTATIVE":e.hasFlag("declined")?"DECLINED":e.hasFlag("needs_action")?"NEEDS-ACTION":e.hasFlag("event_accepted")?"ACCEPTED":e.hasFlag("event_tentative")?"TENTATIVE":e.hasFlag("event_declined")?"DECLINED":t||"NEEDS-ACTION"},getConfirmationMessage:function(e,t){var a=_(e.attendees).findWhere({entity:t||ox.user_id});if(a)return a.comment},getConfirmationSummary:function(e){var t={count:0};return _.each(d,function(e,a){t[a]={icon:f[a]||'<i class="fa fa-exclamation-circle" aria-hidden="true">',count:0,css:e.toLowerCase(),title:m[a]||""}}),_.each(e,function(e){_.isNumber(e.status)?(t[e.status].count++,t.count++):!t[d.indexOf((e.partStat||"NEEDS-ACTION").toUpperCase())]||"INDIVIDUAL"!==e.cuType&&e.cuType||(t[d.indexOf((e.partStat||"NEEDS-ACTION").toUpperCase())].count++,t.count++)}),t},getWeekScaffold:function(e){for(var t,a=moment(e).startOf("week"),n={days:[]},r=0;r<7;r++)n.days.push(t={year:a.year(),month:a.month(),date:a.date(),day:a.day(),timestamp:+a,isToday:moment().isSame(a,"day"),col:r%7}),t.isWeekend=0===t.day||6===t.day,t.isFirst=1===t.date,t.isFirst&&(n.hasFirst=!0),a.add(1,"days"),t.isLast=1===a.date(),t.isLast&&(n.hasLast=!0);return n},resolveAttendees:function(t,n){n=n||{};var r=t.attendees.slice(),o=[],i=[],l=[],s=t.organizer&&!t.organizer.entity&&_.isString(t.organizer.email)&&_.find(r,function(e){return e.mail===t.organizer.email});return t.organizer&&!s&&r.unshift(t.organizer),_.each(r,function(e){switch(e.cuType){case void 0:case"INDIVIDUAL":if(!e.email)return;if(e.entity){if(n.filterSelf&&e.entity===ox.user_id)return;o.push(e.entity)}l.push({display_name:e.cn,mail:e.email});break;case"GROUP":i.push({id:e.entity})}}),i.length?a.getList(i).then(function(t){var a=[];return _.each(t,function(e){a=_.union(e.members,a)}),(a=_(a).difference(o)).length?e.getList(a):l}).then(function(e){return l.concat(_(_(e).map(function(e){return{display_name:e.display_name,mail:e.email1||e.email2||e.email3}})).filter(function(e){return!!e.mail}))}):$.Deferred().resolve(l)},getUserIdByInternalId:function(e){return t.get({id:e,folder:6}).then(function(e){return e.user_id})},getAppointmentColor:function(e,t){var a=v.getFolderColor(e),r=t.get("color"),o=n.is("public",e)||n.is("private",e)?"ACCEPTED":"NEEDS-ACTION",i=v.getConfirmationStatus(t,o);return _.isNumber(r)&&(r=v.colors[r-1].value),/^(needs-action|declined)$/.test(v.getConfirmationClass(i))?"":(v.isPrivate(t)&&(a=v.PRIVATE_EVENT_COLOR),t.hasFlag("organizer")||t.hasFlag("organizer_on_behalf")?r||a:a)},lightenDarkenColor:_.memoize(function(e,t){return _.isString(e)&&(e=this.colorToHex(e)),e=v.hexToHSL(e),e[2]=Math.floor(e[2]*t),e[2]=Math.max(Math.min(100,e[2]),0),"hsl("+e[0]+","+e[1]+"%,"+e[2]+"%)"}),colorToHex:_.memoize(function(e){var t=v.colorToRGB(e);return(t[0]<<16)+(t[1]<<8)+t[2]}),colorToHSL:_.memoize(function(e){var t=v.colorToHex(e);return v.hexToHSL(t)}),colorToRGB:_.memoize(function(){var e=document.createElement("canvas"),t=e.getContext("2d");return e.width=1,e.height=1,function(e){return t.fillStyle="white",t.fillRect(0,0,1,1),t.fillStyle=e,t.fillRect(0,0,1,1),t.getImageData(0,0,1,1).data}}()),hexToHSL:_.memoize(function(e){var t,a,n=(e>>16)/255,r=(e>>8&255)/255,o=(255&e)/255,i=Math.max(n,r,o),l=Math.min(n,r,o),s=(i+l)/2;if(i===l)t=a=0;else{var u=i-l;switch(a=s>.5?u/(2-i-l):u/(i+l),i){case n:t=(r-o)/u+(r<o?6:0);break;case r:t=(o-n)/u+2;break;case o:t=(n-r)/u+4;break;default:t=0}t/=6}return[Math.floor(360*t),Math.floor(100*a),Math.floor(100*s)]}),getRelativeLuminance:function(){function e(e){return(e/=255)<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)}return function(t){var a=.2126*e(t[0])+.7152*e(t[1])+.0722*e(t[2]);return Math.round(1e3*a)/1e3}}(),getForegroundColor:_.memoize(function(e){var t,a=v.getRelativeLuminance(v.colorToRGB(e)),n=v.colorToHSL(e),r=n[0],o=n[1]>0?30:0,i=50;if(a<.18333)return"white";do{t="hsl("+r+", "+o+"%, "+i+"%)",i-=5}while(i>=0&&function(e){var t=v.getRelativeLuminance(v.colorToRGB(e));return(a+.05)/(t+.05)}(t)<5);return t}),canAppointmentChangeColor:function(e,t){var a=t.get("color"),r=v.isPrivate(t),o=n.is("public",e)||n.is("private",e)?"ACCEPTED":"NEEDS-ACTION",i=v.getConfirmationStatus(t,o);return!/^(needs-action|declined)$/.test(v.getConfirmationClass(i))&&(!t.hasFlag("organizer")||!a&&!r)},getFolderColor:function(e){var t=i.get("defaultFolderColor","#CFE6FF"),a=e["com.openexchange.calendar.extendedProperties"]||{},n=a.color?a.color.value||t:t;return _.isNumber(n)&&(n=v.colors[n-1].value),n},getColorName:function(e){if(!e)return s("None");var t=_.findWhere(this.colors,{value:e});return t?t.label:s("Unknown")},getDeepLink:function(e){return[ox.abs,ox.root,"/#app=io.ox/calendar&id=",e.folder_id||e.folder,".",e.recurrence_id||e.id,".",e.recurrence_position||0,"&folder=",e.folder_id||e.folder].join("")},openDeeplink:function(e,t){t=_({}).extend(t),e=new(require("io.ox/calendar/model").Model)(e.toJSON()),ox.launch("io.ox/calendar/main",{folder:e.get("folder")}).done(function(){function a(a){if(a.selectAppointment)a.selectAppointment(e);else if(t.showDetails){var r=$.Event("click",{target:n.perspective.$el});a.showAppointment(r,e.toJSON(),{arrow:!1})}}var n=this,r=t.perspective||_.url.hash("perspective")||n.props.get("layout");n.folders.add(e.get("folder")),n.perspective&&i.get("viewView")===r&&a(n.perspective),n.pages.changePage(r,{disableAnimations:_.device("smartphone")}),n.getWindow().one("change:perspective",function(e,t){a(t)})})},showRecurrenceDialog:function(e,t){if(e instanceof Backbone.Model||(e=new(require("io.ox/calendar/model").Model)(e)),e.get("recurrenceId")){var a=$.Deferred();return require(["io.ox/calendar/api"],function(n){n.get({id:e.get("seriesId"),folder:e.get("folder")},!1).done(function(n){t=t||{};var r,i=s("This appointment is part of a series."),l=new o({width:600}).addCancelButton({left:!0});if(t.dontAllowExceptions||l.addButton({label:s("Edit this appointment"),action:"appointment",className:"btn-default"}),e.hasFlag("first_occurrence")){if(t.dontAllowExceptions)return a.resolve("series",n);r=s("Do you want to edit the whole series or just this appointment within the series?"),l.addButton({label:s("Edit series"),action:"series"})}else{if(e.hasFlag("last_occurrence")&&!t.allowEditOnLastOccurence)return a.resolve("appointment");t.dontAllowExceptions?(r=s("Do you want to edit this and all future appointments or the whole series?"),l.addButton({label:s("Series"),action:"series",className:"btn-default"}),l.addButton({label:s("Edit all future appointments"),action:"thisandfuture"})):(r=s("Do you want to edit this and all future appointments or just this appointment within the series?"),l.addButton({label:s("Edit all future appointments"),action:"thisandfuture"}))}return l.build(function(){this.$title.text(s("Edit appointment")),this.$body.append(i," ",r)}).open(),l.on("action",function(e){a.resolve(e,n)}),a}).fail(function(){a.resolve("appointment")})}),a}return $.when("appointment")},isPrivate:function(e,t){return v.hasFlag(e,"private")||!t&&v.hasFlag(e,"confidential")},returnIconsByType:function(e){var t={type:[],property:[]};return v.hasFlag(e,"tentative")&&t.type.push($('<span class="tentative-flag">').attr("aria-label",s("Tentative")).append($('<i class="fa fa-question-circle" aria-hidden="true">').attr("title",s("Tentative")))),v.hasFlag(e,"private")&&t.type.push($('<span class="private-flag">').attr("aria-label",s("Appointment is private")).append($('<i class="fa fa-user-circle" aria-hidden="true">').attr("title",s("Appointment is private")))),v.hasFlag(e,"confidential")&&t.type.push($('<span class="confidential-flag">').attr("aria-label",s("Appointment is confidential")).append($('<i class="fa fa-lock" aria-hidden="true">').attr("title",s("Appointment is confidential")))),(this.hasFlag(e,"series")||this.hasFlag(e,"overridden"))&&t.property.push($('<span class="recurrence-flag">').attr("aria-label",s("Appointment is part of a series")).append($('<i class="fa fa-repeat" aria-hidden="true">').attr("title",s("Appointment is part of a series")))),this.hasFlag(e,"scheduled")&&t.property.push($('<span class="participants-flag">').attr("aria-label",s("Appointment has participants")).append($('<i class="fa fa-user-o" aria-hidden="true">').attr("title",s("Appointment has participants")))),this.hasFlag(e,"attachments")&&t.property.push($('<span class="attachments-flag">').attr("aria-label",s("Appointment has attachments")).append($('<i class="fa fa-paperclip" aria-hidden="true">').attr("title",s("Appointment has attachments")))),t},getCurrentRangeOptions:function(){var e=ox.ui.apps.get("io.ox/calendar");if(!e)return{};var t=e.perspective;if(!t)return{};var a,n,r=t.model;switch(t.getName()){case"week":a=moment(r.get("startDate")).utc(),n=moment(r.get("startDate")).utc().add(r.get("numColumns"),"days");break;case"month":a=moment(r.get("startDate")).utc(),n=moment(r.get("endDate")).utc();break;case"list":a=moment().startOf("day").utc(),n=moment().startOf("day").add(e.listView.loader.collection.range||1,"month").utc()}return a&&n?{expand:!0,rangeStart:a.format(v.ZULU_FORMAT),rangeEnd:n.format(v.ZULU_FORMAT)}:{}},rangeFilter:function(e,t){return function(a){var n=v.getMoment(a.startDate);return!(v.getMoment(a.endDate)<e)&&!(n>t)}},cid:function(e){if(_.isObject(e)){e.attributes&&(e=e.attributes);var t=e.folder+"."+e.id;return e.recurrenceId&&(t+="."+e.recurrenceId),t}if(_.isString(e)){var a=e.split("."),n={folder:a[0],id:a[1]};return 3===a.length&&(n.recurrenceId=a[2]),n}},createAttendee:function(e,t){if(e){if((e=e instanceof Backbone.Model?e.attributes:e).mark_as_distributionlist)return _(e.distribution_list).map(this.createAttendee);t=t||{};var a={cuType:g[e.type]||"INDIVIDUAL",cn:e.display_name,partStat:"NEEDS-ACTION"};return"RESOURCE"!==a.cuType?(e.guest_created_by||void 0===e.user_id&&!e.contact_id||5===e.type||(a.entity=e.user_id||e.id),a.email=e.field&&e[e.field]?e[e.field]:e.email1||e.mail,a.cn||(a.cn=a.email),a.uri="mailto:"+a.email):(a.partStat="ACCEPTED",e.description&&(a.comment=e.description),a.entity=e.id,a.resource=e,e.mailaddress&&(a.email=e.mailaddress)),"GROUP"===a.cuType&&(a.entity=e.id,a.members=e.members),"INDIVIDUAL"!==a.cuType&&a.cuType||(a.contact={display_name:e.display_name,first_name:e.first_name,last_name:e.last_name}),_.extend(a,t)}},isAllday:function(e){if(!e)return!1;var t=(e=e instanceof Backbone.Model?e.attributes:e).startDate;return this.isLocal(e)&&-1===t.value.indexOf("T")},isLocal:function(e){if(!e)return!1;var t=e instanceof Backbone.Model?e.get("startDate"):e.startDate;return t&&t.value&&!t.tzid},getMoment:function(e){return _.isObject(e)?moment.tz(e.value,e.tzid||moment().tz()):moment(e)},getMomentInLocalTimezone:function(e){return v.getMoment(e).tz(moment().tz())},getDefaultAlarms:function(e){return this.isAllday(e)?i.get("chronos/defaultAlarmDate",[]):i.get("chronos/defaultAlarmDateTime",[])},allowedToEdit:function(e,t){if(!e||!t)return!1;if(!e.id||!e.folder)return!1;if(this.hasFlag(e,"organizer")||this.hasFlag(e,"organizer_on_behalf"))return!0;if(!this.hasFlag(e,"attendee")&&!this.hasFlag(e,"attendee_on_behalf"))return!0;if((this.hasFlag(e,"attendee")||this.hasFlag(e,"attendee_on_behalf"))&&"MODIFY"===e.attendeePrivileges)return!0;var a=i.get("chronos/restrictAllowedAttendeeChanges",!0),n=i.get("chronos/restrictAllowedAttendeeChangesPublic",!0);return a===n?!a:t.is("public")?!n:!a},hasFlag:function(e,t){return _.isArray(e)&&e.length>0?_(e).reduce(function(e,a){return e&&v.hasFlag(a,t)},!0):e instanceof Backbone.Model?e.hasFlag(t):!(!e.flags||!e.flags.length)&&e.flags.indexOf(t)>=0},createUpdateData:function(e,t){e=e instanceof Backbone.Model?e.attributes:e,t=t instanceof Backbone.Model?t.attributes:t;var a=JSON.parse(JSON.stringify(e));return a.recurrenceId=t.recurrenceId,a.startDate.value=this.isAllday(e)?moment(t.recurrenceId).format("YYYYMMDD"):moment(t.recurrenceId).tz(e.startDate.tzid).format("YYYYMMDD[T]HHmmss"),a.endDate.value=this.isAllday(e)?moment(moment(a.startDate.value).valueOf()+moment(e.endDate.value).valueOf()-moment(e.startDate.value).valueOf()).format("YYYYMMDD"):moment.tz(moment(a.startDate.value).valueOf()+moment(e.endDate.value).valueOf()-moment(e.startDate.value).valueOf(),a.startDate.tzid).format("YYYYMMDD[T]HHmmss"),a},cleanupAttendees:function(e){return _(e).map(function(e){var t=_(e).pick("cn","cuType","email","uri","entity","contact","resource");return"RESOURCE"===t.cuType?(t.partStat="ACCEPTED",e.comment&&(t.comment=e.comment)):t.partStat="NEEDS-ACTION",t})}};return v});