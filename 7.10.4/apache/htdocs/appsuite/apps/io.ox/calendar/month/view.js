define("io.ox/calendar/month/view",["io.ox/core/extensions","io.ox/calendar/perspective","io.ox/calendar/util","io.ox/calendar/api","gettext!io.ox/calendar","settings!io.ox/calendar","io.ox/core/print","less!io.ox/calendar/month/style","io.ox/calendar/extensions","io.ox/calendar/month/extensions"],function(t,e,n,o,a,i,s){"use strict";var r=Backbone.View.extend({constructor:function(t){this.opt=_.extend({},this.options||{},t),Backbone.View.prototype.constructor.call(this,t)},mouseDragHelper:function(t){var e=this,n=t.event,o=_.uniqueId(".drag-"),a=!0;1===n.which&&(t.start.call(this,t.event),this.delegate("mousemove"+o,t.updateContext,_.throttle(function(n){1===n.which&&a&&t.update.call(e,n)},100)),$(document).on("mouseup"+o,function(n){a=!1,e.undelegate("mousemove"+o),$(document).off("mouseup"+o),t.end.call(e,n)}))}}),d=r.extend({className:"header",attributes:{role:"toolbar"},events:{"click .control.next, .control.prev":"onClickControl"},initialize:function(){this.monthText=$("<span>"),this.monthInfo=_.device("smartphone")?$('<div class="info">'):$('<button class="info btn btn-link" tabindex="-1">'),this.listenTo(this.model,"change:startOfMonth",this.update),_.device("smartphone")||this.listenTo(this.opt.app.props,"change:showMiniCalendar change:folderview",this.onToggleDatepicker)},update:function(){this.monthText.text(this.model.get("startOfMonth").formatCLDR("yMMMM"))},render:function(){var t=this;return this.$el.empty(),_.device("smartphone")||this.$el.append($('<button href="#" class="control prev">').attr({title:a("Previous Month"),"aria-label":a("Previous Month")}).append($('<i class="fa fa-chevron-left" aria-hidden="true">')),$('<button href="#" class="control next" tabindex="-1">').attr({title:a("Next Month"),"aria-label":a("Next Month")}).append($('<i class="fa fa-chevron-right" aria-hidden="true">'))),this.$el.append(this.monthInfo.append(this.monthText)),this.update(),_.device("smartphone")||(this.monthInfo.attr({"aria-label":a("Use cursor keys to change the date. Press ctrl-key at the same time to change year or shift-key to change month. Close date-picker by pressing ESC key.")}).append($('<i class="fa fa-caret-down fa-fw" aria-hidden="true">')),require(["io.ox/backbone/views/datepicker"],function(e){new e({date:t.model.get("date").clone()}).attachTo(t.monthInfo).on("select",function(e){t.model.set("date",e)}).on("before:open",function(){this.setDate(t.model.get("date"))}),t.onToggleDatepicker()})),this},onToggleDatepicker:function(){var t=this.opt.app.props;this.monthInfo.prop("disabled",t.get("folderview")&&t.get("showMiniCalendar"))},onClickControl:function(t){var e=$(t.currentTarget),n=this.model.get("date").clone();n[e.hasClass("next")?"add":"subtract"](1,"month"),this.model.set("date",n)}}),l=r.extend({tagName:"table",className:"month",events:function(){var t={};return _.extend(t,{"dblclick .day":"onCreateAppointment"}),_.device("smartphone")&&_.extend(t,{"tap .day":"onTapAppointment"}),_.device("touch")&&_.extend(t,{"taphold .day":"onCreateAppointment"}),_.device("desktop")&&_.extend(t,{"mouseenter .appointment":"onHover","mouseleave .appointment":"onHover","mousedown .appointment.modify":"onDrag"}),t},initialize:function(){this.on("collection:add",this.onAddAppointment),this.on("collection:change",this.onChangeAppointment),this.on("collection:remove",this.onRemoveAppointment),this.on("collection:before:reset",this.onBeforeReset),this.on("collection:after:reset",this.onAfterReset),this.listenTo(this.model,"change:startDate",this.render),this.listenTo(this.opt.app.props,"change:showMonthviewWeekend",this.updateWeekends),this.updateWeekends()},updateWeekends:function(){this.$el.toggleClass("weekends",_.device("smartphone")||this.opt.app.props.get("showMonthviewWeekend"))},render:function(){for(var t,e=this,n=this.model.get("startDate").clone(),o=this.model.get("endDate").clone(),i=$("<tbody>");n.isBefore(o);n.add(1,"day")){t&&!n.isSame(n.clone().startOf("week"),"day")||(t=$('<tr class="week">').append($('<td class="day cw">').append($('<span class="number">').text(a("CW %1$d",n.format("w"))))),i.append(t));var s=$("<td>");t.append(s.addClass("day").attr({id:n.format("YYYY-M-D"),title:a("%1$s",n.format("ddd LL"))}).data("date",n.valueOf()).append($('<div class="number" aria-hidden="true">').append(n.isSame(e.model.get("startOfMonth"),"week")?$('<span class="day-label">').text(n.format("ddd")):"",n.date()),$('<div class="list abs">'))),n.isSame(moment(),"day")&&s.addClass("today"),0!==n.day()&&6!==n.day()||s.addClass("weekend"),n.isSame(this.model.get("startOfMonth"),"month")||s.addClass("out")}return this.$el.empty().append($("<thead>").append($("<tr>").append(function(){for(var t=[],e=n.clone().startOf("week"),o=0;o<7;o++,e.add(1,"day"))t.push($("<th>").text(e.format("ddd")));return t})),i),(_.device("firefox")||_.device("ie && ie <= 11"))&&this.$("tbody tr").css("height",100/this.$("tbody tr").length+"%"),_.device("smartphone")&&this.$el.css("min-height",100/7*this.$el.children(":not(.month-name)").length+"%"),_.device("ie && ie <= 11")&&this.calculateHeights(),this},onTapAppointment:function(t){var e=this.opt.app;e.setDate($(t.currentTarget).data("date")),e.pages.changePage("week:day",{animation:"slideleft"})},calculateHeights:_.debounce(function(){var t=Math.floor(this.$el.height()/this.$el.find("tr").length-26)+"px";this.$(".list").css("height",t)},100),renderAppointment:function(e,o){var a=$('<button class="appointment" type="button">').attr({"data-cid":e.cid,"data-master-id":n.cid({id:e.get("id"),folder:e.get("folder")}),"data-extension-point":"io.ox/calendar/appointment","data-composite-id":e.cid}).data("startDate",e.getTimestamp("startDate")),i=t.Baton(_.extend({},this.opt,{model:e,folders:this.opt.app.folders.list(),startDate:o}));return t.point("io.ox/calendar/appointment").invoke("draw",a,i),t.point("io.ox/calendar/month/view/appointment").invoke("draw",a,i),a},onFoldersChange:function(){this.model.get("mergeView")&&this.render()},onCreateAppointment:function(t){if(!($(t.target).closest(".appointment").length>0)&&$(t.target).hasClass("list")){var e=moment($(t.currentTarget).data("date")),n=this.opt.app.folder.get();e.add(30*Math.ceil((60*moment().hours()+moment().minutes())/30),"minutes"),this.opt.view.createAppointment({startDate:{value:e.format("YYYYMMDD[T]HHmmss"),tzid:e.tz()},endDate:{value:e.add(1,"hour").format("YYYYMMDD[T]HHmmss"),tzid:e.tz()},folder:n})}},onHover:function(t){var e=n.cid(String($(t.currentTarget).data("cid"))),o=this.$('[data-master-id="'+e.folder+"."+e.id+'"]:visible'),a=o.data("background-color");switch(t.type){case"mouseenter":o.addClass("hover"),a&&o.css("background-color",n.lightenDarkenColor(a,.9));break;case"mouseleave":o.removeClass("hover"),a&&o.css("background-color",a)}},onDrag:function(t){var e,o,a,i,s=!0,r={x:0,y:0},d=!0;this.mouseDragHelper({event:t,updateContext:".day",start:function(t){d=!0,e=$(t.target).closest(".appointment"),o=this.opt.view.collection.get(e.attr("data-cid")),a=moment(e.closest(".day").data("date")),r.x=t.pageX,r.y=t.pageY},update:function(t){if(d&&(Math.abs(r.x-t.pageX)>5||Math.abs(r.y-t.pageY)>5)&&(d=!1),!d){s&&(this.$('[data-cid="'+o.cid+'"]').addClass("resizing").removeClass("current hover"),this.$el.addClass("no-select"),s=!1);var n,l,h=$(t.currentTarget);i=moment(h.data("date")).diff(a,"days"),l=o.getMoment("startDate").add(i,"days"),n=this.$("#"+l.format("YYYY-M-D")+" .list"),e.parent().is(n)||(e.data("startDate",l.valueOf()),n.append(e),n.append(n.children().sort(this.nodeComparator)),e.get(0).scrollIntoView())}},end:function(){e.removeClass("resizing"),this.$el.removeClass("no-select");var t=o.getMoment("startDate").add(i,"days"),a=o.getMoment("endDate").add(i,"days");if(!t.isSame(o.getMoment("startDate"))){var s={value:t.format("YYYYMMDD[T]HHmmss"),tzid:t.tz()},r={value:a.format("YYYYMMDD[T]HHmmss"),tzid:a.tz()};n.isAllday(o)&&(s={value:t.format("YYYYMMDD")},r={value:a.format("YYYYMMDD")}),this.opt.view.updateAppointment(o,{startDate:s,endDate:r})}}})},nodeComparator:function(t,e){return $(t).data("startDate")-$(e).data("startDate")},onAddAppointment:function(t){if(!1!==i.get("showDeclinedAppointments",!1)||"DECLINED"!==n.getConfirmationStatus(t)){var e=moment.max(t.getMoment("startDate"),this.model.get("startDate")).clone(),o=moment.min(t.getMoment("endDate"),this.model.get("endDate")).clone();if(e.isSame(o)||o.subtract(1,"millisecond"),_.device("smartphone")){var a=$("#"+e.format("YYYY-M-D")+" .list",this.$el).empty();return this.renderAppointmentIndicator(a)}for(;e.isSameOrBefore(o);){var s=this.$("#"+e.format("YYYY-M-D")+" .list");s.append(this.renderAppointment(t,e)),this.onReset||s.append(s.children().sort(this.nodeComparator)),e.add(1,"day").startOf("day")}}},renderAppointmentIndicator:function(e){t.point("io.ox/calendar/month/view/appointment/mobile").invoke("draw",e)},onChangeAppointment:function(t){this.onRemoveAppointment(t),this.onAddAppointment(t)},onRemoveAppointment:function(t){this.$('[data-cid="'+t.cid+'"]').remove()},onBeforeReset:function(){this.$(".appointment").remove(),this.onReset=!0},onAfterReset:function(){this.onReset=!1}});return t.point("io.ox/calendar/month/view/appointment/mobile").extend({id:"default",index:100,draw:function(){this.append('<i class="fa fa-circle" aria-hidden="true">')}}),e.extend({className:"monthview-container",options:{limit:1e3},initialize:function(t){this.app=t.app,this.model=new Backbone.Model({date:t.startDate||moment(this.app.props.get("date")),currentDate:moment()}),this.initializeSubviews(),this.listenTo(o,"process:create update delete",this.onUpdateCache),this.setStartDate(this.model.get("date"),{silent:!0}),e.prototype.initialize.call(this,t)},initializeSubviews:function(){var t=_.extend({app:this.app,view:this,model:this.model},this.options);this.toolbarView=new d(t),this.monthView=new l(t),this.$el.append(this.toolbarView.$el,$('<div class="month-container" role="presentation">').append(this.monthView.$el))},onChangeDate:function(t,e){e=moment(e),this.model.set("date",e),this.setStartDate(e)},onWindowShow:function(){this.$el.is(":visible")&&this.trigger("show")},onUpdateCache:function(){var t=this.collection;o.pool.grep("view=month").forEach(function(e){e!==t&&(e.expired=!0)}),t.sync()},setStartDate:function(t,e){if(_.isString(t)){var n="next"===t?"add":"subtract";t=this.model.get("startOfMonth").clone()[n](1,"month")}var o=moment(this.model.get("startOfMonth")),a=_.extend({propagate:!0,silent:!1},e),i=moment(t);i.startOf("month"),i.isSame(o)||(this.model.set({startDate:i.clone().startOf("week"),endDate:i.clone().endOf("month").endOf("week"),startOfMonth:i},{silent:a.silent}),a.propagate&&this.app.setDate(moment(t)),ox.debug&&console.log("refresh calendar data"),this.refresh())},render:function(){return this.toolbarView.render(),this.monthView.render(),this},rerender:function(){return this.toolbarView.update(),this.monthView.render(),this},getRequestParam:function(){return{start:this.model.get("startDate").valueOf(),end:this.model.get("endDate").valueOf(),view:"month",folders:this.app.folders.list()}},refresh:function(t){var e=this,n=this.getRequestParam(),a=o.getCollection(n);!1===t&&o.pool.grep("view=month").forEach(function(t){t.expired=!0}),this.model.get("currentDate").isSame(moment(),"day")||(this.model.set("currentDate",moment()),this.rerender()),this.setCollection(a),$.when(this.app.folder.getData(),this.app.folders.getData()).done(function(t,n){e.model.set("folders",n),a.folders=_(n).pluck("id"),a.sync()})},onAddAppointment:function(t){this.monthView.trigger("collection:add",t)},onChangeAppointment:function(t){this.monthView.trigger("collection:change",t)},onRemoveAppointment:function(t){this.monthView.trigger("collection:remove",t)},onResetAppointments:function(){this.monthView.trigger("collection:before:reset"),this.collection.forEach(this.monthView.trigger.bind(this.monthView,"collection:add")),this.monthView.trigger("collection:after:reset")},onPrevious:function(){this.toolbarView.$(".prev").trigger("click")},onNext:function(){this.toolbarView.$(".next").trigger("click")},getName:function(){return"month"},print:function(){var t=this.model.get("folders"),e=a("Appointments");1===t.length&&(e=t[0].display_title||t[0].title),s.request("io.ox/calendar/month/print",{current:this.model.get("startOfMonth").valueOf(),start:this.model.get("startDate").valueOf(),end:this.model.get("endDate").valueOf(),folders:_(t).pluck("id"),title:e})},selectAppointment:function(t){this.setStartDate(t.getMoment("startDate"))}})});