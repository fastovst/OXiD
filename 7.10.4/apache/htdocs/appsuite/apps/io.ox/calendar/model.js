define("io.ox/calendar/model",["io.ox/core/extensions","io.ox/calendar/util","io.ox/core/folder/api","gettext!io.ox/calendar","io.ox/backbone/basicModel","io.ox/backbone/validation","io.ox/core/strings","io.ox/participants/model"],function(t,e,i,n,a,s,o,r){"use strict";var d=["FLD-1004","FLD-0008","FLD-0003","CAL-4060","CAL-4030","CAL-4044"],h=Backbone.Collection.extend({modelId:function(t){return t.email||t.entity},initialize:function(t,e){this.options=e||{},this.options.resolveGroups&&(this.oldAdd=this.add,this.add=this.addAsync)},resolveDistList:function(t){var e=[],i=[],n=$.Deferred();return _([].concat(t)).each(function(t){var n=new r.Participant(t);e.push(n),i.push(n.loading)}),$.when.apply($,i).then(function(){n.resolve(_(e).sortBy(function(t){return t.get("last_name")}))}),n},addAsync:function(t,i){var n=[],a=[],s=[],o=[],r=this,d=i&&void 0!==i.previousModels,h=$.Deferred();return t=[].concat(t),_(t).each(function(t){if(!r.options.noInitialResolve&&"GROUP"===t.cuType||t.get&&"GROUP"===t.get("cuType")){var e=t instanceof Backbone.Model?t.get("members"):t.members,i=t instanceof Backbone.Model?t.get("entity"):t.entity;void 0!==i&&(r.usedGroups=_.uniq((r.usedGroups||[]).concat(i))),e?n=_.uniq(n.concat(e)):i?(a=_.uniq(a.concat({id:i})),s.push(t)):o.push(t)}else o.push(t)}),require(["io.ox/core/api/user","io.ox/core/api/group"],function(t,u){u.getList(a).then(function(t){n=_.uniq(n.concat(_(_(t).pluck("members")).flatten()))},function(){o=o.concat(s)}).always(function(){r.options.noInitialResolve=!1,n=_(n).reject(function(t){return _(o).findWhere({entity:t})}),t.getList(n).done(function(t){o=_.compact(_.uniq(_.union(o,_(t).map(function(t){if(t.email1)return e.createAttendee(t)})))),h.resolve(r.oldAdd(o,i)),d&&r.trigger("reset")}).fail(h.reject)})}),h}}),u=Backbone.Model.extend({days:["su","mo","tu","we","th","fr","sa"],initialize:function(){this.model=this.get("model"),this.set("timezone",this.model.get("startDate")&&this.model.get("startDate").tzid?this.model.get("startDate").tzid:moment().tz()),this.unset("model"),this.listenTo(this.model,"change",this.deserialize),this.deserialize(),this.on("change",this.serialize)},serialize:function(){var t=this,i=[],n=_(this.days).chain().map(function(e,i){if(0!=(t.get("days")&1<<i))return e.toUpperCase()}).compact().value().join(",");switch(this.get("recurrence_type")){case 1:i.push("FREQ=DAILY");break;case 2:i.push("FREQ=WEEKLY"),i.push("BYDAY="+n);break;case 3:if(i.push("FREQ=MONTHLY"),t.get("days")){i.push("BYDAY="+n);var a=this.get("day_in_month");i.push("BYSETPOS="+(5===a?-1:a))}else i.push("BYMONTHDAY="+this.get("day_in_month"));break;case 4:i.push("FREQ=YEARLY"),t.get("days")?(i.push("BYMONTH="+(this.get("month")+1)),i.push("BYDAY="+n),i.push("BYSETPOS="+this.get("day_in_month"))):(i.push("BYMONTH="+(this.get("month")+1)),i.push("BYMONTHDAY="+this.get("day_in_month")))}this.get("interval")>1&&i.push("INTERVAL="+this.get("interval")),this.get("until")&&i.push(e.isAllday(this.model)?"UNTIL="+moment(this.get("until")).format("YYYYMMDD"):"UNTIL="+moment(this.get("until")).utc().endOf("day").format(e.ZULU_FORMAT)),this.get("occurrences")&&i.push("COUNT="+this.get("occurrences")),i.length>0?this.model.set("rrule",i.join(";")):this.model.set("rrule",null)},splitRule:function(){var t=this.model.get("rrule").split(";"),e={};return _(t).each(function(t){var i=(t=t.split("="))[0],n=t[1].split(",");1===n.length&&(n=n[0]),e[i]=n,e[i.toLowerCase()]=_.isArray(n)?t[1].toLowerCase().split(","):n.toLowerCase()}),e},deserialize:function(){var t={};if(t.startDate=_.clone(this.model.get("startDate")),!this.model.get("rrule"))return this.set(t);var e=this,i=this.splitRule(),n=this.model.getMoment("startDate");switch(i.freq){case"daily":t.recurrence_type=1;break;case"weekly":t.recurrence_type=2,t.days=_([].concat(i.byday)).reduce(function(t,i){return t+(1<<e.days.indexOf(i))},0);break;case"monthly":if(t.recurrence_type=3,i.bymonthday)t.day_in_month=parseInt(i.bymonthday,10)||0;else if(i.byday){var a=i.bysetpos;-1===a&&(a=5),t.day_in_month=parseInt(a,10)||0,t.days=1<<this.days.indexOf(i.byday)}else t.day_in_month=n.date();break;case"yearly":t.recurrence_type=4,i.bymonthday?(t.month=(parseInt(i.bymonth,10)||0)-1,t.day_in_month=parseInt(i.bymonthday,10)||0):i.byday?(t.month=(parseInt(i.bymonth,10)||0)-1,t.day_in_month=parseInt(i.bysetpos,10)||0,t.days=1<<this.days.indexOf(i.byday)):(t.month=n.month(),t.day_in_month=n.date());break;default:t.recurrence_type=0}i.count&&(t.occurrences=parseInt(i.count,10)||1),i.UNTIL&&(t.until=moment(i.UNTIL).subtract(n.hour(),"hours").valueOf()||0),t.interval=parseInt(i.interval,10)||1,this.set(t)}}),c=a.extend({idAttribute:"cid",ref:"io.ox/chronos/model/",init:function(){this.attributes.folder&&this.attributes.id&&(this.cid=this.attributes.cid=e.cid(this.attributes)),this.onChangeFlags(),this.on({"change:startDate":this.onChangeStartDate,"change:endDate":this.onChangeEndDate,"change:flags":this.onChangeFlags})},onChangeStartDate:function(){if(this.adjustEndDate&&!this.changedAttributes().endDate&&this.has("endDate")){var t=e.getMoment(this.previous("startDate")),i=this.getMoment("endDate");i=this.getMoment("startDate").tz(i.tz()).add(i.diff(t,"ms"),"ms"),this.set("endDate",e.isAllday(this)?{value:i.format("YYYYMMDD")}:{value:i.format("YYYYMMDD[T]HHmmss"),tzid:i.tz()})}},onChangeEndDate:function(){if(!this.changedAttributes().startDate&&this.has("startDate")&&!this.getMoment("startDate").isSameOrBefore(this.getMoment("endDate"))){var t=this.getMoment("startDate"),i=e.getMoment(this.previous("endDate"));t=this.getMoment("endDate").tz(t.tz()).add(t.diff(i,"ms"),"ms"),this.adjustEndDate=!1,this.set("startDate",e.isAllday(this)?{value:t.format("YYYYMMDD")}:{value:t.format("YYYYMMDD[T]HHmmss"),tzid:t.tz()}),this.adjustEndDate=!0}},onChangeFlags:function(){this.flags=_.object(this.get("flags"),this.get("flags"))},getAttendees:function(){if(this._attendees)return this._attendees;var t=this,e=!1,i=this.get("attendees")||[],n=!1;return this._attendees=new h(i,{resolveGroups:!0,silent:!1,noInitialResolve:i.length>1}),this._attendees.on("add remove reset",function(){n||(e=!0,t.set("attendees",this.toJSON(),{validate:!0}),e=!1)}),this.on({"change:attendees":function(){e||(n=!0,t._attendees.reset(t.get("attendees")||[]),n=!1)}}),this._attendees},setDefaultAttendees:function(t){if(!t.create)return $.when();var n=this;return i.get(this.get("folder")).then(function(a){var s=i.is("shared",a);return require(["io.ox/core/api/user"]).then(function(t){return t.get({id:s?a.created_by:void 0})}).then(function(i){n.set("organizer",{cn:i.display_name,email:i.email1,uri:"mailto:"+i.email1,entity:i.id});var a=e.createAttendee(i,{partStat:"ACCEPTED"}),s=a.email?{email:a.email}:{entity:a.entity};t.resetStates&&n.getAttendees().each(function(t){t.set("partStat","NEEDS-ACTION")}),_(n.get("attendees")).findWhere(s)?(_(n.get("attendees")).findWhere(s).partStat="ACCEPTED",n.trigger("change:attendees")):n.getAttendees().add(a)})})},getMoment:function(t){if(this.has(t))return e.getMoment(this.get(t))},getTimestamp:function(t){if(this.get(t))return this.getMoment(t).valueOf()},parse:function(t){if(t.folder&&t.id&&(t.cid=t.cid=e.cid(t)),t.lastModified&&this.get("lastModified")&&t.lastModified!==this.get("lastModified"))for(var i in this.attributes)_.has(t,i)||this.unset(i,{silent:!0});return t},getRruleMapModel:function(){return this.rruleModel?this.rruleModel:(this.rruleModel=new u({model:this}),this.rruleModel)},hasFlag:function(t){return!!this.flags[t]},checkRecurrenceRule:function(){if(!this.get("rrule"))return!0;var t=this.getMoment("startDate").isoWeekday()-1,e=["mo","tu","we","th","fr","sa","su"],i=this.getRruleMapModel().splitRule();return!!_.isEmpty(i.byday)||-1!==_([].concat(i.byday)).map(function(t){return e.indexOf(t)}).indexOf(t)}});return t.point("io.ox/chronos/model/validation").extend({id:"start-date-before-end-date",validate:function(t,e,i){i.getTimestamp("endDate")<i.getTimestamp("startDate")&&this.add("endDate",n("The end date must be after the start date."))}}),t.point("io.ox/chronos/model/validation").extend({id:"upload-quota",validate:function(t){t.quotaExceeded&&this.add("quota_exceeded",n("Files can not be uploaded, because upload limit of %1$s is exceeded.",o.fileSize(t.quotaExceeded.attachmentMaxUploadSize,2)))}}),t.point("io.ox/chronos/model/validation").extend({id:"secret-used-with-resource",validate:function(t){"PRIVATE"===t.class&&_(_(t.attendees).pluck("cuType")).contains("RESOURCE")&&this.add("class",n("You cannot mark the appointment as secret, when blocking a ressource."))}}),s.validationFor("io.ox/chronos/model",{summary:{format:"string",mandatory:!0}}),{Model:c,Collection:Backbone.Collection.extend({model:c,setOptions:function(t){this.folders=t.folders,this.start=t.start,this.end=t.end},comparator:function(t){return t.getTimestamp("startDate")},sync:function(t){var i=this;if(t=t||{},!this.expired&&this.length>0||this.folders&&0===this.folders.length)return _.defer(i.trigger.bind(i,"load")),$.when();var n=require("io.ox/calendar/api"),a={action:"all",rangeStart:moment(this.start).utc().format(e.ZULU_FORMAT),rangeEnd:moment(this.end).utc().format(e.ZULU_FORMAT),fields:n.defaultFields,order:"asc",sort:"startDate",expand:!0};return this.expired=!1,_.defer(this.trigger.bind(this,"before:load")),n.request({module:"chronos",params:a,data:{folders:this.folders}},this.folders?"PUT":"GET").then(function(a){var s=!0===t.paginate?"add":"reset";return a=_(a).chain().map(function(t){return i.folders?t.events?t.events:void(_(d).contains(t.error.code)&&n.trigger("all:fail",t.folder)):t}).compact().flatten().each(function(t){t.cid=e.cid(t)}).sortBy(function(t){return e.getMoment(t.startDate).valueOf()}).value(),i[s](a,{parse:!0}),i.trigger("load"),a},function(t){i.trigger("load:fail",t)})}}),AttendeeCollection:h}});