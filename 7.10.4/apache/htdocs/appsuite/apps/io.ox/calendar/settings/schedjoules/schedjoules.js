define("io.ox/calendar/settings/schedjoules/schedjoules",["io.ox/core/extensions","gettext!io.ox/calendar/settings/schedjoules","io.ox/calendar/settings/schedjoules/api","io.ox/backbone/views/modal","io.ox/backbone/mini-views","io.ox/core/api/user","io.ox/core/folder/api","io.ox/core/folder/breadcrumb","io.ox/core/notifications","io.ox/core/http","less!io.ox/calendar/settings/schedjoules/style"],function(e,t,a,i,o,d,n,s,l,r){"use strict";function c(i){a.get({language:i.user.get("locale").slice(0,2).toLowerCase(),country:i.user.get("locale").slice(3,5).toLowerCase()}).then(function(o){var d=new(Backbone.Model.extend({}))({});d.on("change:language",function(){i.dialog.busy(!0),$.when(a.get({id:_.last(i.dialog.data.pageHistory).item_id,language:d.get("language"),country:d.get("country")}),a.getCountries(d.get("language"))).then(function(t,a){i.data=t[0],i.countries=a,e.point("io.ox/core/folder/add-schedjoules-calendar").invoke("render",i.dialog),i.dialog.idle()})}),d.on("change:country",function(){i.dialog.data.pageHistory=[],i.dialog.busy(!0),a.get({language:d.get("language"),country:d.get("country")}).done(function(t){i.data=t,i.dialog.data.pageHistory.push(t),e.point("io.ox/core/folder/add-schedjoules-calendar").invoke("render",i.dialog),i.dialog.idle()})}),d.set({language:i.user.get("locale").slice(0,2).toLowerCase(),country:i.user.get("locale").slice(3,5).toLowerCase()},{silent:!0}),i.dialog.data=i,i.dialog.requestModel=d,i.dialog.handleClick=function(t){i.dialog.busy(!0),a.get({id:t,language:i.dialog.requestModel.get("language"),country:i.dialog.requestModel.get("country")}).done(function(t){var a=_.findIndex(i.dialog.data.pageHistory,{item_id:t.item_id});i.dialog.data.data=t,i.dialog.idle(),i.dialog.data.pageHistory.splice(a+1),e.point("io.ox/core/folder/add-schedjoules-calendar").invoke("render",i.dialog)})},o.name=t("Start"),i.data=o,i.pageHistory=[o],u(i)})}function u(i){i.dialog.on("subscribe",function(){var e=_.values(this.data.subscriptionsModel.attributes),o=_.copy(this.data.currentSubscriptions);i.dialog.close(),l.yell("success",t("The integration of the subscribed calendars might take a while.")),r.pause(),_.each(e,function(e){!o[e.itemId]||o[e.itemId]&&o[e.itemId].locale!==e.locale?a.subscribeCalendar(e):delete o[e.itemId]}),_.each(o,function(e){n.remove([e.id])}),r.resume()}),e.point("io.ox/core/folder/add-schedjoules-calendar").invoke("render",i.dialog),i.dialog.idle()}function g(e,t){var a=[],i=Backbone.Model.extend({});return _.each(e.items,function(e){a.push(new p({model:new i(e),dialogView:t}).render().$el)}),a}function h(e){return $.when(a.getLanguages(),a.getCountries(),d.getCurrentUser()).then(function(t,a,i){function o(e,t){var a={};return _.each(e,function(e){a[e.get("com.openexchange.calendar.config").itemId]={itemId:e.get("com.openexchange.calendar.config").itemId,name:e.get("folder_name"),locale:e.get("com.openexchange.calendar.config").locale},t&&(a[e.get("com.openexchange.calendar.config").itemId].id=e.get("id"))}),a}var d=_.filter(n.pool.models,function(e){return"schedjoules"===e.get("com.openexchange.calendar.provider")}),s=new(Backbone.Model.extend({}))(o(d));return{dialog:e,languages:t,countries:a,user:i,accountFolders:d,subscriptionsModel:s,currentSubscriptions:o(d,!0)}},function(t){e.idle(),e.$body.append($('<div class="alert alert-warning">').text(t.error_desc)),e.$footer.find('button[data-action="subscribe"]').attr("disabled","disabled")})}var p=Backbone.View.extend({tagName:"li",className:"list-group-item",initialize:function(e){this.opt=_.extend({},e)},events:{click:"onBrowse","keypress .chevron":"onBrowse"},render:function(){var e=o.SwitchView.extend({onChange:function(){"false"===this.getValue()?this.model.unset(this.name):this.model.set(this.name,this.getValue())}}),a="page"===this.model.attributes.item_class?"page":"",i=this.model.attributes.item.country?" ("+this.model.attributes.item.country+")":"";return this.$el.addClass(a),this.$el.append($('<div class="item">').append($('<div class="item-name">').append(void 0!==this.model.attributes.item.icon?$('<div class="schedjoules-icon">').css("background-image","url("+this.model.attributes.item.icon+")"):[],$("<div>").text(this.model.attributes.item.name)),"page"===this.model.attributes.item_class?$('<div class="chevron" tabindex="0">').append($('<i class="fa fa-chevron-right" aria-hidden="true">')):new e({name:this.model.attributes.item.item_id,model:this.opt.dialogView.data.subscriptionsModel,label:"",size:"small",customValues:{true:{itemId:this.model.attributes.item.item_id,name:this.opt.dialogView.data.subscriptionsModel.get(this.model.attributes.item.item_id)?this.opt.dialogView.data.subscriptionsModel.get(this.model.attributes.item.item_id).name:this.model.attributes.item.name+i,locale:this.opt.dialogView.data.dialog.requestModel.get("language")},false:"false"}}).render().$el.attr("title",t("subscribe to calendar")))),this.opt.dialogView.data.subscriptionsModel.get(this.model.attributes.item.item_id)&&this.opt.dialogView.data.subscriptionsModel.get(this.model.attributes.item.item_id).locale!==this.opt.dialogView.data.dialog.requestModel.get("language")&&$(this.$el.find('input[type="checkbox"]')).prop("checked",!0).attr({disabled:!0,"data-state":"manual"}),this},onBrowse:function(t){if(("click"===t.type||13===t.which)&&$(t.currentTarget).closest("li").hasClass("page")){this.opt.dialogView.busy(!0);var i=this;a.get({id:this.model.attributes.item.item_id,language:this.opt.dialogView.requestModel.get("language"),country:this.opt.dialogView.requestModel.get("country")}).done(function(t){i.opt.dialogView.data.data=t,i.opt.dialogView.idle(),i.opt.dialogView.data.pageHistory.push(t),e.point("io.ox/core/folder/add-schedjoules-calendar").invoke("render",i.opt.dialogView),i.opt.dialogView.$body.scrollTop(0)})}}});return e.point("io.ox/core/folder/add-schedjoules-calendar").extend({id:"breadcrumb",index:150,render:function(){var t=this,i=s.extend({initialize:function(e){this.path=e.path,this.handler=e.handler},render:function(){return this.$el.text("Â "),this.renderPath.bind(this),this.renderPath(this.path),this},renderLink:function(e,t,a){var i,o=t===a.length-1;return(i=o&&!this.notail?$('<span class="breadcrumb-tail">'):$('<a href="#" role="button" class="breadcrumb-link">').attr("href","#")).attr({"data-id":e.item_id,"data-module":e.module}).text(o?e.name:_.ellipsis(e.name,{max:20})),o||(i=i.add($('<i class="fa breadcrumb-divider" aria-hidden="true">'))),i.add($('<i class="fa breadcrumb-divider" aria-hidden="true">')),i},onClickLink:function(e){e.preventDefault();var t=$(e.target).attr("data-id"),a=$(e.target).attr("data-module");this.handler&&this.handler(t,a)}}),o=$('<button type="button" class="btn btn-default">').append($('<i class="fa fa-chevron-left" aria-hidden="true">'));o.on("click",function(i){i.preventDefault(),t.busy(!0),t.data.pageHistory.pop();var o=_.last(t.data.pageHistory).item_id;a.get({id:o,language:t.requestModel.get("language"),country:t.requestModel.get("country")}).done(function(a){t.data.data=a,t.idle(),e.point("io.ox/core/folder/add-schedjoules-calendar").invoke("render",t)})}),this.data.pageHistory.length>=2&&this.$body.append($('<div class="row">').append($('<div class="form-group col-xs-12 col-md-1">').append(o),$('<div class="form-group col-xs-12 col-md-11">').append(new i({path:this.data.pageHistory,handler:this.handleClick}).render().$el)))}}),e.point("io.ox/core/folder/add-schedjoules-calendar").extend({id:"settings",index:100,render:function(){this.$body.empty();var e=this.data.data.item_id===this.data.pageHistory[0].item_id||_.isEmpty(this.data.pageHistory);this.$body.append($('<div class="row">').append($('<div class="form-group col-xs-12 col-md-6">').append($('<label for="language">').text(t("Language")),new o.SelectView({list:_.map(this.data.languages[0],function(e){return{label:e.name,value:e.iso_639_1}}),name:"language",model:this.requestModel,id:"language",className:"form-control"}).render().$el),$('<div class="form-group col-xs-12 col-md-6">').append($('<label for="country">').text(t("Country")),new o.SelectView({list:_.map(this.data.countries[0],function(e){return{label:e.name_translation,value:e.iso_3166}}),name:"country",model:this.requestModel,id:"country",className:"form-control"}).render().$el.attr("disabled",!e))))}}),e.point("io.ox/core/folder/add-schedjoules-calendar").extend({id:"sections",index:200,render:function(){var e=this;_.each(this.data.data.page_sections,function(t){e.$body.append($('<div class="item-block">').append($("<h2>").text(t.name),$('<ol class="list-group">').append(g(t,e))))})}}),e.point("io.ox/core/folder/add-schedjoules-calendar").extend({id:"alarms",index:300,render:function(){this.$body.prepend($('<div class="alert alert-info">').text(t("Your default reminders will be applied to these calendars.")))}}),{open:function(){var e=new i({top:60,width:600,center:!1,maximize:!0,help:"ox.appsuite.user.sect.calendar.folder.subscribe.html",async:!0,point:"io.ox/core/folder/add-schedjoules-calendar",title:t("Add calendar"),render:!1});return e.addCancelButton().addButton({label:t("Save"),action:"subscribe"}).build(function(){this.$body.addClass("schedjoules")}),e.open(),e.busy(!0),h(e).then(c)}}});