define("io.ox/calendar/invitations/register",["io.ox/backbone/views/disposable","io.ox/core/extensions","io.ox/core/http","io.ox/calendar/model","io.ox/calendar/util","settings!io.ox/calendar","gettext!io.ox/calendar/main","io.ox/core/notifications","less!io.ox/calendar/style"],function(e,t,i,n,o,a,s,r){"use strict";var c={accept:s("Accept"),accept_and_replace:s("Accept changes"),accept_and_ignore_conflicts:s("Accept"),accept_party_crasher:s("Add new participant"),create:s("Accept"),update:s("Accept changes"),delete:s("Delete"),declinecounter:s("Reject changes"),tentative:s("Tentative"),decline:s("Decline"),ignore:s("Ignore")},l={accept:"btn-success accept",accept_and_replace:"btn-success",accept_and_ignore_conflicts:"btn-success ignore",accept_party_crasher:"",create:"",update:"btn-success",delete:"",declinecounter:"btn-danger",tentative:"btn-warning",decline:"btn-danger",ignore:""},d={accept:s("You have accepted the appointment"),accept_and_replace:s("Changes have been saved"),accept_and_ignore_conflicts:s("You have accepted the appointment"),accept_party_crasher:s("Added the new participant"),create:s("You have accepted the appointment"),update:s("The appointment has been updated"),delete:s("The appointment has been deleted"),declinecounter:s("The changes have been rejected"),tentative:s("You have tentatively accepted the appointment"),decline:s("You have declined the appointment")},h=["update","ignore","create","delete","decline","tentative","accept","declinecounter","accept_and_replace","accept_and_ignore_conflicts","accept_party_crasher"],p=e.extend({className:"itip-item",events:{"click .show-details":"onShowDetails","click .itip-actions button":"onAction",keydown:"onKeydown"},initialize:function(e){this.options=_.extend({},e),this.mailModel=e.mailModel,this.module=e.module,this.api=e.api,this.util=e.util,this.settings=e.settings,this.AlarmsView=e.AlarmsView,this.showDeeplinks=e.showDeeplinks,this.AlarmsView&&(this.alarmsModel=new Backbone.Model(this.model.toJSON()),this.alarmsModel.set("alarms",this.alarmsModel.get("alarms")||o.getDefaultAlarms(this.alarmsModel))),this.listenTo(this.model,"change:flags change:participants",this.render)},onKeydown:function(e){e.stopPropagation()},getFullModel:function(){return this.api.get(this.model.attributes)},onShowDetails:function(e){e.preventDefault();var t=this;ox.load(["io.ox/core/tk/dialogs","io.ox/calendar/view-detail"]).done(function(i,n){new i.SidePopup({tabTrap:!0}).show(e,function(e){e.busy(),t.getFullModel().done(function(i){e.idle().append(n.draw(i,{hideToolbar:!0,noFolderCheck:!0,deeplink:!!t.showDeeplinks}))})})})},renderScaffold:function(){return this.$el.append($('<div class="headline">').append($("<span>").text(this.getInfoText()),$.txt(". "),$('<a href="#" role="button" class="show-details">').text(this.getLinkText())),$('<div class="itip-details">'),$('<div class="itip-annotations">'),$('<div class="itip-changes">'),$('<div class="itip-comment">'),$('<div class="itip-controls">'))},getInfoText:function(){return s("This email contains an appointment")},getLinkText:function(){return s("Show appointment details")},renderConfirmation:function(){var e=this.getConfirmationStatus(),t="";if(this.isOrganizer())return t=s("You are the organizer"),$('<div class="confirmation-status">').addClass("organizer").text(t);switch(e){case"ACCEPTED":t=this.getAcceptedMessage();break;case"DECLINED":t=this.getRejectedMessage();break;case"TENTATIVE":t=this.getTentativeMessage()}return t?$('<div class="confirmation-status">').addClass(e.toLowerCase()).text(t):$()},getAcceptedMessage:function(){return s("You have accepted this appointment")},getRejectedMessage:function(){return s("You declined this appointment")},getTentativeMessage:function(){return s("You tentatively accepted this invitation")},isOrganizer:function(){return this.model.has("organizer")&&this.model.get("organizer").entity===ox.user_id},getConfirmationStatus:function(){return this.util.getConfirmationStatus(this.model)},renderSummary:function(){var e=this.getDateTimeIntervalMarkup(),t=o.getRecurrenceString(this.model),i=this.getTitle(),n=e.dateStr||e.timeStr||t,a=i&&n?$.txt(", "):$.txt("");this.$el.find(".itip-details").append($("<b>").text(i),a,$('<span class="day">').append($.txt(e.dateStr),$.txt(" "),$.txt(e.timeStr),$.txt(t&&t.length?" â€“ "+t:"")),this.renderConfirmation())},getTitle:function(){return this.model.get("summary")},getDateTimeIntervalMarkup:function(){return this.util.getDateTimeIntervalMarkup(this.model.attributes,{output:"strings",zone:moment().tz()})},renderAnnotations:function(){},renderChanges:function(){},renderReminder:function(){if(this.AlarmsView&&this.alarmsModel){var e=new this.AlarmsView.linkView({model:this.alarmsModel});this.$el.find(".itip-actions").before($('<div class="itip-reminder">').append($("<legend>").text(s("Reminder")),e.render().$el))}},getActions:function(){return"ACCEPTED"===this.getConfirmationStatus()?[]:this.model.hasFlag&&this.model.hasFlag("event_cancelled")?[]:["decline","tentative","accept"]},getButtons:function(e){return _(h).chain().filter(function(t){return _(e).contains(t)}).map(function(e){return $('<button type="button" class="btn btn-default">').attr("data-action",e).addClass(l[e]).text(c[e])}).value()},getConfirmationSelector:function(e){return"ACCEPTED"===e?"button.btn-success.accept":"DECLINED"===e?"button.btn-danger":"TENTATIVE"===e?"button.btn-warning":""},disableCurrentButton:function(){if(!this.supportsComment()){var e=this.getConfirmationStatus(),t=this.getConfirmationSelector(e);this.$(".itip-actions").find(t).addClass("disabled").prop("disabled",!0)}},supportsComment:function(){return this.$('[data-action="accept"], [data-action="tentative"], [data-action="decline"]').length>0},getUserComment:function(){return this.$el.find(".itip-comment input").val()},renderComment:function(){this.supportsComment()&&this.$el.find(".itip-comment").append($('<input type="text" class="form-control" data-property="comment">').attr("placeholder",s("Comment")).val(this.util.getConfirmationMessage(this.model.attributes)))},render:function(){if(!this.$el.hasClass("io-ox-busy")){this.$el.empty(),this.$el.is(":hidden")&&this.$el.fadeIn(300);var e,t;return this.renderScaffold(),this.renderAnnotations(),this.model?(this.renderSummary(),this.renderChanges(),0!==parseInt(this.mailModel.get("account_id"),10)?this:(e=this.getActions(),0===(t=this.getButtons(e)).length?this:1===e.length&&"ignore"===e[0]?this:(this.$el.find(".itip-controls").append($('<div class="itip-actions">').append(t)),this.disableCurrentButton(),this.renderComment(),this.renderReminder(),this))):(this.$el.find(".show-details").remove(),this)}}}),u=p.extend({getFullModel:function(){return $.when(this.model)},onAction:function(e){function t(){var e={action:n,dataSource:"com.openexchange.mail.ical",descriptionFormat:"html"};_.isEmpty(o.getUserComment())||(e.message=o.getUserComment()),i.PUT({module:"chronos/itip",params:e,data:{"com.openexchange.mail.conversion.fullname":s.mail.folder_id,"com.openexchange.mail.conversion.mailid":s.mail.id,"com.openexchange.mail.conversion.sequenceid":s.id}}).then(function(e){var t=require(["io.ox/calendar/api"]).then(function(t){t.updatePoolData({updated:e}),t.refresh(),!1!==o.options.yell&&r.yell("success",d[n])});o.settings.get("deleteInvitationMailAfterAction",!1)?require(["io.ox/mail/api"],function(e){e.remove([o.mailModel.toJSON()])}):t.then(function(){"delete"===n&&o.model.set("actions",_(o.model.get("actions")).without("delete")),o.repaint()})},function(e){r.yell(e),o.repaint()})}e.preventDefault();var n=$(e.currentTarget).attr("data-action"),o=this,a="decline"!==n,s=this.imip;ox.load(["io.ox/calendar/actions/change-confirmation"]).done(function(e){e(o.imip,{api:{checkConflicts:function(){if(_.isArray(o.options.conflicts))return $.when(o.options.conflicts);var e=[];return a&&_(o.model.get("changes")).each(function(t){t.conflicts&&(e=e.concat(t.conflicts))}),$.when(e)}}}).done(t).fail(function(e){e&&r.yell(e)})})},initialize:function(e){p.prototype.initialize.call(this,e),this.options=_.extend({},e),this.imip=e.imip,this.$el.hide()},getActions:function(){return this.options.actions},renderAnnotations:function(){var e=this.$el.find(".itip-annotations");this.options.annotations&&_(this.options.annotations).each(function(t){e.append($('<div class="annotation">').text(t.message))})},renderChanges:function(){var e=this.$el.find(".itip-changes");this.options.diffDescription&&_(this.options.diffDescription).each(function(t){e.append($("<p>").html(t))})},repaint:function(){this.options.container.analyzeIMIPAttachment(this.imip).done(function(e){var t=_(e).first()||{},i=t.changes?t.changes[0]:{},n=i.deletedEvent||i.newEvent||i.currentEvent;this.options.actions=t.actions,this.options.introduction=i.introduction,this.options.diffDescription=i.diffDescription,this.options.annotations=t.annotations,n?this.model.set(n):delete this.model,this.render()}.bind(this))}}),m=p.extend({initialize:function(e){p.prototype.initialize.call(this,e),this.listenTo(this.model,"change:headers",this.render),this.cid=e.cid,this.$el.hide(),this.$el.attr({"data-type":this.type,"data-cid":this.cid})}}),f=m.extend({onAction:function(e){function t(e){var l=_.extend({},i.previousConfirmation,{partStat:o[n],comment:c});c&&(l.comment=c),i.api.confirm({attendee:l,id:i.model.get("id"),folder:i.model.get("folder"),alarms:i.alarmsModel.get("alarms")},{checkConflicts:!!e}).then(function(e){if(e&&e.conflicts)ox.load(["io.ox/calendar/conflicts/conflictList"]).done(function(n){n.dialog(e.conflicts).on("cancel",function(){i.$el.idle(),i.render()}).on("ignore",function(){t(!1)})});else if(a.get("deleteInvitationMailAfterAction",!1)){if(!1!==i.options.yell){var o;"accept"===n?o=i.getAcceptedMessage():"tentative"===n?o=i.getTentativeMessage():"decline"===n&&(o=i.getRejectedMessage()),r.yell("success",o)}require(["io.ox/mail/api"],function(e){e.remove([i.mailModel.toJSON()])})}else i.$el.idle(),i.render()},function(e){i.$el.idle().hide(),e&&"CAL-5071"===e.code?r.yell(e):r.yell("error",s("Failed to update confirmation status; most probably the appointment has been deleted."))})}var i=this,n=$(e.currentTarget).attr("data-action"),o={accept:"ACCEPTED",tentative:"TENTATIVE",decline:"DECLINED"},c=this.getUserComment();i.$el.busy(!0),t(!0)}}),g=m.extend({initialize:function(e){m.prototype.initialize.call(this,e),this.isParticipant=!!_(this.model.get("participants")||[]).findWhere({id:ox.user_id})},onShowDetails:function(e){e.preventDefault();var t=this;ox.load(["io.ox/core/tk/dialogs","io.ox/tasks/view-detail"]).done(function(i,n){new i.SidePopup({tabTrap:!0}).show(e,function(e){e.append(n.draw(t.model.toJSON()))})})},getTitle:function(){return this.model.get("title")},isOrganizer:function(){return this.model.get("created_by")===ox.user_id},getConfirmationStatus:function(){var e=["NEEDS-ACTION","ACCEPTED","DECLINED","TENTATIVE"];return function(){var t=this.util.getConfirmationStatus(this.model.attributes);return t>=0&&t<e.length?e[t]:"NEEDS-ACTION"}}(),getInfoText:function(){return s("This email contains a task")},getLinkText:function(){return s("Show task details")},getAcceptedMessage:function(){return s("You have accepted this task")},getRejectedMessage:function(){return s("You declined this task")},getTentativeMessage:function(){return s("You tentatively accepted this task")},renderReminder:function(){if(this.isParticipant){var e=this;this.$el.find(".itip-actions").before($('<div class="itip-reminder inline">').append($('<label class="control-label" for="reminderSelect">').text(s("Reminder")),$('<div class="controls">').append($('<select id="reminderSelect" class="reminder-select form-control" data-property="reminder">').append(function(){var t=$(this),i=e.util.getReminderOptions();_(i).each(function(e,i){t.append($("<option>",{value:i}).text(e))})}).val(this.getDefaultReminder()))))}},renderComment:function(){this.isParticipant&&m.prototype.renderComment.call(this)},getActions:function(){return this.isParticipant?m.prototype.getActions.call(this):[]},getDefaultReminder:function(){return parseInt(this.settings.get("defaultReminder",15),10)},onActionSuccess:function(e,t){var i,n=this.reminder;n&&(i={id:this.model.get("id"),folder_id:this.model.get("folder_id"),alarm:n},this.model.has("recurrence_position")&&(i.recurrence_position=this.model.get("recurrence_position")),i.alarm=_.now()+i.alarm,this.api.update(i));var o=_(this.model.get("users")).findWhere({id:ox.user_id});if(o&&(o.confirmation=t,this.model.trigger("update update:users",this.model)),a.get("deleteInvitationMailAfterAction",!1)){if(!1!==this.options.yell){var s;"accept"===e?s=this.getAcceptedMessage():"tentative"===e?s=this.getTentativeMessage():"decline"===e&&(s=this.getRejectedMessage()),r.yell("success",s)}require(["io.ox/mail/api"],function(e){e.remove([this.mailModel.toJSON()])}.bind(this))}else this.$el.idle(),this.render()},onActionFail:function(){this.$el.idle().hide(),r.yell("error",s("Failed to update confirmation status; most probably the task has been deleted."))},onAction:function(e){var t=this,i=$(e.currentTarget).attr("data-action"),n={accept:1,decline:2,tentative:3}[i],o="ACCEPTED"===this.getConfirmationStatus(),a=this.getUserComment();this.reminder=!o&&parseInt(this.$el.find(".reminder-select").val(),10),t.$el.busy(!0),t.api.confirm({folder:this.model.get("folder_id"),id:this.model.get("id"),data:{confirmation:n,confirmmessage:a}}).then(t.onActionSuccess.bind(t,i,n),t.onActionFail.bind(t,i))}}),v=e.extend({initialize:function(e){this.options=_.extend({},e),this.model.has("headers")?this.analyzeMail():this.listenToOnce(this.model,"change:headers",this.analyzeMail)},analyzeMail:function(){this.hasIMIPAttachment()?this.processIMIPAttachment():this.hasEvent()?this.processEvent():this.hasTask()&&this.processTask()},getIMIPAttachment:function(){var e=/text\/calendar.*?method=(.+)/i;return _(this.model.get("attachments")).find(function(t){var i,n=t.content_type.match(e);return!(!n||"publish"===n[1].toLowerCase())&&(i=n[1].indexOf(";"),"publish"!==(-1!==i?n[1].substr(0,i):n[1]).toLowerCase())})},hasIMIPAttachment:function(){return!!this.getIMIPAttachment()},analyzeIMIPAttachment:function(e){return e&&e.id?i.PUT({module:"chronos/itip",params:{action:"analyze",dataSource:"com.openexchange.mail.ical",descriptionFormat:"html",timezone:"UTC"},data:{"com.openexchange.mail.conversion.fullname":e.mail.folder_id,"com.openexchange.mail.conversion.mailid":e.mail.id,"com.openexchange.mail.conversion.sequenceid":e.id}}):$.Deferred().reject()},processIMIPAttachment:function(){var e=this,t=this.getIMIPAttachment(),i=this.options&&this.options.yell;return t.mail={folder_id:this.model.get("folder_id"),id:this.model.get("id")},this.analyzeIMIPAttachment(t).done(function(o){if(!e.disposed&&0!==o.length){var s,r=_(o).first()||{},c=r.changes?r.changes[0]:{},l=c.deletedEvent||c.newEvent||c.currentEvent;return l&&(s=new n.Model(l)),e.model.set("imipMail",!0),require(["io.ox/calendar/api","io.ox/calendar/util"]).then(function(n,o){var l=new u({model:s,module:"calendar",api:n,util:o,settings:a,actions:r.actions,introduction:c.introduction,diffDescription:c.diffDescription,annotations:r.annotations,imip:t,container:e,yell:i,mailModel:e.model});e.$el.append(l.render().$el),l.trigger("appended")})}})},getCid:function(){var e=this.model.get("headers")||{},t=e["X-OX-Reminder"],i=e["X-Open-Xchange-Module"],n=["X-Open-Xchange-Sequence"];if(t&&i)return t=t.split(/,\s*/),n?{module:i,folder_id:t[1],id:t[0],sequence:n}:{module:i,folder_id:t[1],id:t[0]}},getType:function(){return(this.model.get("headers")||{})["X-Open-Xchange-Type"]},hasEvent:function(){var e=this.getCid();return!!e&&"Appointments"===e.module},processEvent:function(){var e=this,t=this.getCid(),i=this.options&&this.options.yell;return require(["io.ox/calendar/api","io.ox/calendar/util","io.ox/backbone/mini-views/alarms"]).then(function(n,o,s){return n.resolve({id:t.id,sequence:t.sequence},!0).then(function(t){if(!e.disposed){"Deleted"===e.getType()&&(t=t.clone()).set("flags",["event_cancelled"].concat(t.get("flags")));var r=new f({model:t,module:"calendar",api:n,util:o,settings:a,AlarmsView:s,yell:i,mailModel:e.model,showDeeplinks:!0});e.$el.append(r.render().$el),r.trigger("appended")}})})},hasTask:function(){var e=this.getCid();return!!e&&"Tasks"===e.module},processTask:function(){var e=this,t=this.getCid(),i=this.options&&this.options.yell;return require(["io.ox/tasks/api","io.ox/tasks/util","settings!io.ox/tasks"]).then(function(n,o,a){return n.get({folder:t.folder_id,id:t.id}).then(function(t){var s=new Backbone.Model(t);e.$el.append(new g({model:s,module:"tasks",api:n,util:o,settings:a,yell:i,mailModel:e.model}).render().$el)})})}});t.point("io.ox/mail/detail/notifications").extend({index:1e12,id:"accept-decline",draw:function(e){var t=new v(_.extend({model:e.model},e.options));this.append(t.render().$el)}})});