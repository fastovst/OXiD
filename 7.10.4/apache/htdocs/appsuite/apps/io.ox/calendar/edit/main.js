define("io.ox/calendar/edit/main",["io.ox/calendar/model","io.ox/calendar/api","io.ox/core/extPatterns/dnd","io.ox/calendar/edit/view","io.ox/core/notifications","io.ox/core/folder/api","io.ox/calendar/util","io.ox/core/http","gettext!io.ox/calendar/edit/main","settings!io.ox/calendar","less!io.ox/calendar/edit/style","static/3rd.party/jquery-ui.min.js"],function(e,t,i,o,n,d,a,s,l,r){"use strict";return{getApp:function(){var i=ox.ui.createApp({name:"io.ox/calendar/edit",title:l("Edit Appointment"),userContent:!0,closable:!0,floating:!_.device("smartphone"),size:"width-sm"});return _.extend(i,{dispose:function(){this.view.off("save",_.bind(this.onSave,this)),this.model.off()},extendDescription:function(e){e.preventDefault();var t=i.view.$el.find("textarea.note");t.val(t.val()+e.data.description).trigger("change"),n.yell("success",l("Description has been copied"))},edit:function(t,n){function s(){var e=ox.ui.createWindow({name:"io.ox/calendar/edit",chromeless:!0,floating:!_.device("smartphone"),closable:!0,title:l("Edit Appointment")});c.setWindow(e),c.model.setDefaultAttendees({create:"create"===n.mode}).done(function(){"create"===n.mode&&c.model.set("attendeePrivileges",r.get("chronos/allowAttendeeEditsByDefault",!1)&&!d.pool.getModel(c.model.get("folder")).is("public")?"MODIFY":"DEFAULT"),"edit"===n.mode&&a.isAllday(c.model)&&c.model.set("endDate",{value:moment(c.model.get("endDate").value).subtract("1","days").format("YYYYMMDD")}),i.view=c.view=new o({model:c.model,mode:n.mode,app:c,callbacks:{extendDescription:i.extendDescription},usedGroups:n.usedGroups||[]}),c.model.on({"sync:start":function(){c.getWindow().busy()}}),c.considerSaved=!n.initialModelData,c.setTitle(l(c.model.get("summary")||"create"===n.mode?"Create appointment":"Edit appointment")),e.on("show",function(){i.dropZone&&i.dropZone.include&&i.dropZone.include(),c.setState({folder:c.model.attributes.folder,id:c.model.get("id")?c.model.attributes.id:null})}),i.dropZone&&e.on("hide",function(){i.dropZone.remove()}),"edit"===n.mode&&("appointment"===n.action&&(c.model.set("rrule",void 0,{validate:!0}),c.model.mode="appointment"),"series"===n.action&&(c.model.mode="series"),"thisandfuture"===n.action&&(c.model.mode="thisandfuture")),c.model.on("change",function(){c.considerSaved=!1}),c.initialModelData=_.deepClone(n.initialModelData||c.model.toJSON()),$(c.getWindow().nodes.main[0]).append(c.view.render().el),c.getWindow().show(_.bind(c.onShowWindow,c)),$(i).trigger("finishedCreating")})}var c=this,m={};t&&(t instanceof Backbone.Model?m=t.toJSON():_.isObject(t)&&(m=t)),n=_.extend({mode:"edit"},n),i.cid="io.ox/calendar:"+n.mode+"."+a.cid(t),"edit"===n.mode&&m.id?(c.setState({folder:m.folder,id:m.id}),c.model=new e.Model(m)):(m.alarms=m.alarms||a.getDefaultAlarms(m),m.transp=m.transp||(a.isAllday(m)&&r.get("markFulltimeAppointmentsAsFree",!1)?"TRANSPARENT":"OPAQUE"),c.model=new e.Model(m),m.folder&&!/^virtual/.test(m.folder)||c.model.set("folder",m.folder=d.getDefaultFolder("calendar"))),d.get(c.model.get("folder")).always(s)},considerSaved:!1,create:function(e){(e=e instanceof Backbone.Model?e.toJSON():e).class||(e.class="PUBLIC"),this.edit(e,{mode:"create"})},getDirtyStatus:function(){return!this.considerSaved&&!_.isEqual(this.model.toJSON(),this.initialModelData)},getDelta:function(){if("edit"!==this.view.options.mode)return this.model.toJSON();var e=this,t=this.model.toJSON(),i={id:this.initialModelData.id,folder:this.initialModelData.folder,timestamp:this.initialModelData.timestamp},o=_(t).keys();return _(o).each(function(o){("endDate"===o&&a.isAllday(t)?!e.view.tempEndDate||_.isEqual(e.view.tempEndDate,e.initialModelData[o]):_.isEqual(e.initialModelData[o],t[o]))||!e.initialModelData[o]&&!t[o]||(i[o]=t[o])}),this.initialModelData.recurrenceId&&(i.recurrenceId=this.initialModelData.recurrenceId,i.seriesId=this.initialModelData.seriesId),i},cleanUpModel:function(){var e=this.model.toJSON(),t=this;_(e).each(function(e,i){e||_(t.initialModelData).has(i)||t.model.unset(i,{silent:!0})})},onShowWindow:function(){var e=[],t=["keyup","focus"],i=this;i.model.adjustEndDate=!0,i.model.get("summary")&&(i.getWindow().setTitle(i.model.get("summary")),i.setTitle(i.model.get("summary"))),i.model.on("keyup:summary",function(e){e||(e=l(i.model.get("id")?"Edit appointment":"Create appointment")),i.getWindow().setTitle(e),i.setTitle(e)}),_.device("!smartphone && !iOS")&&$(i.getWindow().nodes.main).find("input")[0].focus(),$(i.getWindow().nodes.main[0]).addClass("scrollable");var o=$(i.getWindow().nodes.main).find(".controls"),n=o.find("ul");o.find("input").on("keyup focus",{list:n},function(o){"focus"===o.type&&e.push("focus"),"keyup"===o.type&&e.push("keyup"),2===e.length&&(_.isEmpty(_.difference(t,e))&&o.data.list.css("pointer-events","none"),e=[]),i.getWindow().nodes.main.find(".control-group").on("mousemove",function(){o.data.list.css("pointer-events","auto")})})},onSave:function(e){var i=this;if(e&&e.conflicts)ox.load(["io.ox/calendar/conflicts/conflictList"]).done(function(o){o.dialog(e.conflicts).on("cancel",function(){i.getWindow().idle(),i.view.tempEndDate&&(i.model.set("endDate",i.view.tempEndDate,{silent:!0}),i.view.tempEndDate=null)}).on("ignore",function(){"create"===i.view.options.mode?t.create(i.model,_.extend(a.getCurrentRangeOptions(),{usedGroups:i.model._attendees.usedGroups,attachments:i.attachmentsFormData||[],checkConflicts:!1})).then(_.bind(i.onSave,i),_.bind(i.onError,i)):t.update(i.getDelta(),_.extend(a.getCurrentRangeOptions(),{attachments:i.attachmentsFormData||[],checkConflicts:!1,recurrenceRange:"thisandfuture"===i.view.model.mode?"THISANDFUTURE":void 0,usedGroups:i.model._attendees.usedGroups,showRecurrenceInfo:!0})).then(_.bind(i.onSave,i),_.bind(i.onError,i))})});else if(e&&this.model.set(_(e.toJSON()).omit(function(e){return!e})),"create"===this.view.options.mode?this.model.trigger("create"):this.model.trigger("update"),this.moveAfterSave){var o=_.bind(this.onSave,this),n=_.bind(this.onError,this);t.move(this.model,this.moveAfterSave,a.getCurrentRangeOptions()).then(function(){delete i.moveAfterSave,o()},n)}else this.model.adjustEndDate=!1,this.considerSaved=!0,i.getWindow().idle(),this.quit()},onError:function(e){this.moveAfterSave&&this.model.get("folder")!==this.moveAfterSave&&this.model.set("folder",this.moveAfterSave,{silent:!0}),delete this.moveAfterSave,this.getWindow().idle(),this.tempEndDate&&self.tempStartDate&&(this.model.set("endDate",this.tempEndDate),this.model.set("startDate",this.tempStartDate),this.tempEndDate=this.tempStartDate=null),e&&n.yell(e)},failSave:function(){if(this.model){var e=this.model.get("summary");return{description:l("Appointment")+(e?": "+e:""),module:"io.ox/calendar/edit",point:{data:this.model.attributes,action:this.model.mode,meta:{usedGroups:this.model._attendees.usedGroups},initialModelData:this.initialModelData}}}return!1},failRestore:function(e){var t=e.data||e;return this.edit(t,{mode:_.isUndefined(t.id)?"create":"edit",initialModelData:e.initialModelData,action:e.action,usedGroups:e.meta?e.meta.usedGroups:[]}),$.when()},getContextualHelp:function(){return"ox.appsuite.user.sect.calendar.gui.create.html"}}),i.setQuit(function(){var e=this,t=new $.Deferred;return $(document.activeElement).filter("input").trigger("change"),e.cleanUpModel(),e.getDirtyStatus()?require(["io.ox/backbone/views/modal"],function(o){i.getWindow().floating?i.getWindow().floating.toggle(!0):_.device("smartphone")&&i.getWindow().resume(),new o({title:l("Do you really want to discard your changes?")}).addCancelButton({left:!0}).addButton({label:l.pgettext("dialog","Discard changes"),action:"delete"}).on("action",function(i){"delete"===i?(e.dispose(),t.resolve()):t.reject()}).open()}):(e.dispose(),t.resolve()),_.device("!smartphone && !iOS")&&i.getWindow().nodes.main.find("input")[0].focus(),t}),i},reuse:function(e,t){if("edit"===e)return ox.ui.App.reuse("io.ox/calendar:edit."+a.cid(t))}}});