define("io.ox/calendar/edit/extensions",["io.ox/core/extensions","gettext!io.ox/calendar/edit/main","io.ox/calendar/util","io.ox/contacts/util","io.ox/mail/util","io.ox/core/util","io.ox/core/tk/upload","io.ox/backbone/views","io.ox/backbone/mini-views","io.ox/backbone/mini-views/datepicker","io.ox/core/tk/attachments","io.ox/backbone/views/recurrence-view","io.ox/backbone/mini-views/alarms","io.ox/calendar/api","io.ox/participants/add","io.ox/participants/chronos-views","io.ox/core/capabilities","io.ox/core/folder/picker","io.ox/core/folder/api","settings!io.ox/calendar","settings!io.ox/core","io.ox/calendar/color-picker","io.ox/backbone/mini-views/dropdown","less!io.ox/calendar/style"],function(e,t,a,n,o,i,d,l,r,s,c,p,m,u,f,h,g,x,b,w,v,D,y){"use strict";function k(){var e=this.model;require(["io.ox/calendar/edit/timezone-dialog"],function(t){t.open({model:e})})}function V(e){require(["io.ox/calendar/freetime/main"],function(n){n.showDialog({label:t("Apply changes"),parentModel:e.data.model}).done(function(n){var o=n.view;n.dialog.on("save",function(){var i=o.createAppointment();i?(n.dialog.close(),e.data.model.set({startDate:i.startDate}),e.data.app.view.addParticipantsView.initialRendering=!0,e.data.model.getAttendees().reset(i.attendees),e.data.model.set({endDate:i.endDate},{validate:!0}),e.data.app.view.fullTimeToggleModel.set("allDay",a.isAllday(i))):(n.dialog.idle(),require(["io.ox/core/yell"],function(e){e("info",t("Please select a time for the appointment"))}))})})})}var C=l.point("io.ox/calendar/edit/section");C.basicExtend({index:100,id:"dnd",draw:function(e){e.app.view.$el.append(new d.dnd.FloatingDropzone({app:e.app,point:"io.ox/calendar/edit/dnd/actions"}).render().$el)}}),C.basicExtend({id:"header",index:10,draw:function(t){var a=$('<div class="header">');e.point("io.ox/calendar/edit/section/title").invoke("draw",a,t),e.point("io.ox/calendar/edit/section/buttons").invoke("draw",a,t),t.app.getWindow().setHeader(a)}}),e.point("io.ox/calendar/edit/section/title").extend({index:100,id:"title",draw:function(e){this.append($("<h1>").addClass("sr-only").text(t("edit"===e.mode?"Edit appointment":"Create appointment")))}}),e.point("io.ox/calendar/edit/section/buttons").extend({index:100,id:"save",draw:function(e){var n=e.model.get("folder");this.append($('<button type="button" class="btn btn-primary save" data-action="save">').text(t("edit"===e.mode?"Save":"Create")).on("click",function(){var t=_.bind(e.app.onSave||_.noop,e.app),d=_.bind(e.app.onError||_.noop,e.app),l=e.model.get("folder"),r=[],s=e.parentView.$el.find(".add-participant.tt-input").val();if(e.attachmentList.attachmentsToDelete.length>0&&(e.model.set("attachments",_(e.model.get("attachments")).difference(e.attachmentList.attachmentsToDelete)),e.attachmentList.attachmentsToDelete=[]),e.attachmentList.attachmentsToAdd.length>0&&(r=r.concat(e.attachmentList.attachmentsToAdd)),n!==l&&"edit"===e.mode&&(e.model.set({folder:n},{silent:!0}),e.app.moveAfterSave=l),!_.isEmpty(s.replace(/\s*/,""))&&i.isValidMailAddress(s)&&e.model._attendees.add(new e.model._attendees.model({cuType:"INDIVIDUAL",cn:o.parseRecipient(s)[0],partStat:"NEEDS-ACTION",email:o.parseRecipient(s)[1],uri:"mailto:"+o.parseRecipient(s)[1]})),e.model.isValid({isSave:!0})){if(a.isAllday(e.model)&&(e.parentView.tempEndDate=e.model.get("endDate"),e.model.set("endDate",{value:moment(e.model.get("endDate").value).add(1,"days").format("YYYYMMDD")},{silent:!0})),r.length){var c=[];_(r).each(function(e){c.push({filename:e.filename,fmtType:e.file.type,uri:"cid:file_"+e.cid})}),c=c.concat(_(e.model.get("attachments")).filter(function(e){return void 0!==e.managedId})||[]),e.model.set("attachments",c,{silent:!0})}if(_.isEqual(e.app.initialModelData.attendees,e.model.get("attendees"))||e.model._attendees.remove(e.model._attendees.filter(function(e){return"GROUP"===e.get("cuType")&&e.get("entity")})),e.app.getWindow().busy(),e.app.attachmentsFormData=r,"edit"!==e.mode)u.create(e.model,_.extend(a.getCurrentRangeOptions(),{usedGroups:e.model._attendees.usedGroups,attachments:r,checkConflicts:!0})).then(t,d);else{var p=_.extend(a.getCurrentRangeOptions(),{recurrenceRange:"thisandfuture"===e.model.mode?"THISANDFUTURE":void 0,attachments:r,checkConflicts:!0,usedGroups:e.model._attendees.usedGroups,showRecurrenceInfo:!0}),m=e.app.getDelta();u.update(m,p).then(t,d)}}}))}}),e.point("io.ox/calendar/edit/section/buttons").extend({index:200,id:"discard",draw:function(e){this.append($('<button type="button" class="btn btn-default discard" data-action="discard" >').text(t("Discard")).on("click",function(t){t.stopPropagation(),e.app.quit()}))}}),e.point("io.ox/calendar/edit/section/buttons").extend({id:"metrics",draw:function(){var e=this;require(["io.ox/metrics/main"],function(t){t.isEnabled()&&e.on("mousedown","[data-action]",function(e){var a=$(e.target);t.trackEvent({app:"calendar",target:"edit/toolbar",type:"click",action:a.attr("data-action")||a.attr("data-name"),detail:a.attr("data-value")})})})}}),C.extend({id:"title",index:200,render:function(){var e,a=this,n=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label col-xs-12">').attr("for",n).append($.txt(t("Subject")),e=new r.InputView({id:n,name:"summary",model:a.model,mandatory:!0}).render().$el,new r.ErrorView({name:"summary",model:a.model}).render().$el)),e.on("keyup change",function(){a.model.trigger("keyup:summary",$(this).val())})}}),C.extend({id:"location",index:300,render:function(){var e=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label col-xs-12">').attr("for",e).append($.txt(t("Location")),new r.InputView({id:e,name:"location",model:this.model}).render().$el))}}),C.basicExtend({id:"start-date",index:400,draw:function(e){e.parentView.startDatePicker=new s({model:e.model,className:"col-sm-6 col-xs-12",display:a.isAllday(e.model)?"DATE":"DATETIME",attribute:"startDate",label:t("Starts on"),timezoneButton:!0,closeOnScroll:!0,a11y:{timeLabel:t("Start time")},chronos:!0}).on("click:timezone",k,e).on("click:time",function(){var e=this.$el.find(".dropdown-menu.calendaredit"),t=e.scrollParent(),a=e.offset().top-t.offset().top;(a<0||a+e.height()>t.height())&&t.scrollTop(t.scrollTop()+a-16)}),this.append(e.parentView.startDatePicker.render().$el)}}),C.basicExtend({id:"end-date",index:500,nextTo:"start-date",draw:function(e){e.parentView.endDatePicker=new s({model:e.model,className:"col-sm-6 col-xs-12",display:a.isAllday(e.model)?"DATE":"DATETIME",attribute:"endDate",label:t("Ends on"),timezoneButton:!0,closeOnScroll:!0,a11y:{timeLabel:t("End time")},chronos:!0}).on("click:timezone",k,e).on("click:time",function(){var e=this.$el.find(".dropdown-menu.calendaredit"),t=e.scrollParent(),a=e.offset().top-t.offset().top;(a<0||a+e.height()>t.height())&&t.scrollTop(t.scrollTop()+a-16)}),this.append(e.parentView.endDatePicker.render().$el)}}),C.extend({id:"timezone-hint",index:550,nextTo:"end-date",render:function(){function e(){var e=i.baton.model.getMoment("startDate").utcOffset(),d=i.baton.model.getMoment("endDate").utcOffset(),l=e!==n||d!==n;if(t.toggle(l),l){var r=a.getDateTimeIntervalMarkup(i.baton.model.attributes,{zone:moment().tz(),noTimezoneLabel:!0});r.prepend($("<span>").append(o+": ")),t.empty(),t.append(r)}}var t=$('<div class="col-xs-12 help-block">').hide(),n=moment().utcOffset(),o=moment().tz(),i=this;this.$el.append(t),this.listenTo(this.baton.model,"change:startDate change:endDate",e),e()}}),C.extend({id:"full_time",index:600,className:"col-sm-6",render:function(){var e=_.uniqueId("form-control-label-"),n=this.model,o=this.baton.parentView.fullTimeToggleModel||new Backbone.Model({allDay:a.isAllday(this.model)}),i=new r.CustomCheckboxView({id:e,name:"allDay",label:t("All day"),model:o});if(i.listenTo(o,"change:allDay",function(){if(this.model.get("allDay"))n.set({startDate:{value:n.getMoment("startDate").format("YYYYMMDD")},endDate:{value:n.getMoment("endDate").format("YYYYMMDD")}});else{var e=moment().tz();n.set({startDate:{value:n.getMoment("startDate").format("YYYYMMDD[T]HHmmss"),tzid:e},endDate:{value:n.getMoment("endDate").format("YYYYMMDD[T]HHmmss"),tzid:e}})}}),this.$el.append(i.render().$el),!this.baton.parentView.fullTimeToggleModel&&"create"===this.baton.mode&&JSON.stringify(_(n.attributes.alarms).pluck("action","trigger"))===JSON.stringify(_(a.getDefaultAlarms(n)).pluck("action","trigger"))){var d=function(){n.set("alarms",a.getDefaultAlarms(n))};o.on("change:allDay",d),n.once("userChangedAlarms",function(){o.off("change:allDay",d)})}this.baton.parentView.fullTimeToggleModel=o}}),C.basicExtend({id:"find-free-time-1",index:650,nextTo:"full_time",draw:function(e){g.has("freebusy !alone !guest")&&_.device("desktop")&&this.append($('<div class="hidden-xs col-sm-6 find-free-time">').append($('<button type="button" class="btn btn-link">').text(t("Find a free time")).on("click",{app:e.app,model:e.model},V)))}}),C.extend({id:"recurrence",className:"col-xs-12",index:700,render:function(){if(!this.model.get("recurrenceId")||"appointment"!==this.model.mode){var e=$('<div class="alert">'),a=t("Your recurrence rule does not fit to your start date."),n=t("Your recurrence rule was changed automatically."),o=this,i=new p({model:this.model});this.$el.append(i.render().$el,e.hide()),this.model.on("change:rrule",function(){o.model.get("rrule")?o.model.checkRecurrenceRule()||e.removeClass("alert-info").addClass("alert-warning").text(a).show():e.hide()}),this.model.getRruleMapModel().on("autochanged",function(){e.removeClass("alert-warning").addClass("alert-info").text(n).show()}),i.on("openeddialog",function(){e.hide()})}}}),C.extend({id:"note",index:800,className:"col-xs-12",render:function(){var e=_.uniqueId("form-control-label-");this.$el.append($('<label class="control-label">').text(t("Description")).attr({for:e}),new r.TextView({name:"description",model:this.model}).render().$el.attr({id:e}).addClass("note"))}});var T=r.AbstractView.extend({tagName:"fieldset",dropDown:{},$toggle:$('<button class="btn btn-link dropdown-toggle" data-toggle="dropdown" type="button" aria-haspopup="true">'),getColor:function(e){var n=e["com.openexchange.calendar.extendedProperties"],o=w.get("defaultFolderColor","#CFE6FF");return n&&n.color&&n.color.value&&(o=n.color.value),{value:o,label:(_(a.colors).findWhere({value:o})||{}).label||t("User defined color")}},setup:function(){var e=this;this.listenTo(this.model,"change:folder",function(a,n){var o=b.get(n),i=b.get(e.model.previous("folder"));$.when(o,i).done(function(a,n){var o=e.model.previousAttributes().organizer.entity;if(b.is("shared",a)||b.is("shared",n))e.model.setDefaultAttendees({create:!0,resetStates:!e.model.get("id")}).done(function(){e.model.getAttendees().trigger("reset"),o!==e.model.get("organizer").entity&&require(["io.ox/core/yell"],function(e){b.is("shared",a)?e("info",t("You are using a shared calendar. The calendar owner was added as organizer.")):e("info",t("You are no longer using a shared calendar. You were added as organizer."))})});else if(b.is("public",a)&&!b.is("public",n))e.model.getAttendees().trigger("reset");else if(!b.is("public",a)&&b.is("public",n)){var i=e.model.getAttendees().length;e.model.setDefaultAttendees({create:!0,resetStates:!e.model.get("id")}).done(function(){e.model.getAttendees().trigger("reset"),i!==e.model.getAttendees().length&&require(["io.ox/core/yell"],function(e){e("info",t("You are no longer using a public calendar. You were added as organizer."))})})}}),e.update()})},update:function(){var e=this;b.get(e.model.get("folder")).done(function(t){var a=t.display_title||t.title;e.$toggle.text(a)}),e.dropDown.update()},render:function(){var e=this,a=b.get(e.model.get("folder")),n=b.flat({module:"calendar"});return e.dropDown=new y({caret:!1,model:e.model,$toggle:e.$toggle}),$.when(a,n).done(function(a,n){var o=a.display_title||a.title,i={private:t("My calendars"),public:t("Public calendars"),shared:t("Shared calendars"),hidden:t("Hidden calendars")},d=0;e.$toggle.text(o),_(i).each(function(a,o){var i=n[o];i&&0!==i.length&&0!==(i=_(i).filter(function(t){var a=b.can("create",t),n=!e.model.get("id")||b.is("public",t)||t.created_by===e.model.get("organizer").entity;return a&&n&&!/^virtual/.test(t.id)})).length&&(0!==d&&e.dropDown.divider(),e.dropDown.header(a),_(i).forEach(function(a){var n=e.getColor(a);e.dropDown.option("folder",a.id,function(){return[$.txt(a.display_title||a.title),$('<span class="sr-only">').text(", "+t("Color")+": "+n.label)]},{radio:!0,color:n.value})}),d++)}),e.$el.append($("<legend>").addClass("simple").text(t("Calendar")),e.dropDown.render().$el)}),this}});return C.basicExtend({id:"noteSeparator",index:850,draw:function(e){this.append($('<a href="#">').text(t("Expand form")).addClass("btn btn-link actionToggle").on("click",function(a){a.preventDefault(),e.parentView.collapsed?($(".row.collapsed",e.parentView.$el).css("display",""),$(this).text(t("Expand form"))):($(".row.collapsed",e.parentView.$el).show(),$(this).text(t("Collapse form"))),e.parentView.collapsed=!e.parentView.collapsed}))}}),C.basicExtend({id:"participants_list",index:900,rowClass:"collapsed",draw:function(e){this.append(new h.UserContainer({collection:e.model.getAttendees(),baton:e,hideInternalGroups:!0}).render().$el),e.parentView.options.usedGroups&&(e.model.getAttendees().usedGroups=_.uniq((e.model.getAttendees().usedGroups||[]).concat(e.parentView.options.usedGroups)))}}),C.basicExtend({id:"add-participant",index:1e3,rowClass:"collapsed",draw:function(e){e.parentView.addParticipantsView=e.parentView.addParticipantsView||new f({apiOptions:{contacts:!0,users:!0,groups:!0,resources:!0,distributionlists:!0},convertToAttendee:!0,collection:e.model.getAttendees(),blacklist:w.get("participantBlacklist")||!1,scrollIntoView:!0}),this.append(e.parentView.addParticipantsView.$el),e.parentView.addParticipantsView.render().$el.addClass("col-xs-12")}}),C.extend({id:"folder-selection",index:1100,className:"col-xs-12 col-sm-6 folder-selection",render:function(){var e=new T({model:this.model}).render().$el;this.$el.append(e).addClass("col-xs-12")}},{rowClass:"collapsed form-spacer"}),C.extend({id:"private_flag",index:1200,className:"col-sm-6 col-xs-12",render:function(){var e=this.model.get("folder"),a=_.uniqueId("form-control-label-");!b.pool.getModel(e).is("private")||this.model.get("recurrenceId")&&"appointment"===this.model.mode||this.$el.append($("<div>").append($('<label class="simple">').attr("for",a).text(t("Visibility")),new r.SelectView({id:a,label:t("Visibility"),name:"class",model:this.model,list:[{value:"PUBLIC",label:t("Standard")},{value:"CONFIDENTIAL",label:t("Private")},{value:"PRIVATE",label:t("Secret")}]}).render().$el,new r.ErrorView({name:"class",model:this.model}).render().$el))}},{nextTo:"folder-selection",rowClass:"collapsed"}),C.extend({id:"alarms-container",index:1300,className:"col-xs-12 col-sm-6",render:function(){e.point("io.ox/calendar/edit/section/alarms-container").invoke("render",this)}},{rowClass:"collapsed"}),e.point("io.ox/calendar/edit/section/alarms-container").extend({id:"alarms",index:100,render:function(){this.baton.parentView.alarmsView=this.baton.parentView.alarmsView||new m.linkView({model:this.model}),this.$el.append($("<fieldset>").append($('<legend class="simple">').text(t("Reminder")),this.baton.parentView.alarmsView.render().$el))}}),e.point("io.ox/calendar/edit/section/alarms-container").extend({id:"color",index:200,render:function(){function e(){var e=t("none");if(!n.model.get("color")){var i=(b.pool.getModel(n.model.get("folder"))||new Backbone.Model).get("com.openexchange.calendar.extendedProperties")||{},d="#fff";return i.color&&i.color.value&&(d=i.color.value),l.css({"background-color":d}),_(a.colors).findWhere({value:d})&&(e=_(a.colors).findWhere({value:d}).label),r.text(e),void o.$el.find(":checked").prop("checked",!1)}_(a.colors).findWhere({value:n.model.get("color")})&&(e=_(a.colors).findWhere({value:n.model.get("color")}).label),r.text(e),l.css("background-color",n.model.get("color"))}var n=this,o=new D({model:this.model,attribute:"color",additionalColor:this.model.get("color")?{value:this.model.get("color")}:void 0}),i=$('<button class="btn btn-link dropdown-toggle" data-toggle="dropdown" type="button" aria-haspopup="true">').text(t("Appointment color")),d=$('<ul class="dropdown-menu">'),l=$('<span class="picked-color" aria-hidden="true">'),r=$('<span class="sr-only">'),s=new y({smart:!0,className:"color-picker-dropdown dropdown",$toggle:i.append(l,r),$ul:d,margin:24,model:this.model,carret:!0,allowUndefined:!0});s.option("color","",t("Use calendar color"),{radio:!0}),s.$ul.find('[data-name="color"]').addClass("folder-default-color"),d.append($('<li role="presentation" class="io-ox-calendar-color-picker-container">').append($('<div class="color-picker-scroll">').append(o.render().$el))),this.$el.append(s.render().$el),this.model.on("change:color change:folder",e),e()}}),C.extend({id:"visibility-container",index:1400,className:"col-xs-12 col-sm-6 visibility-container",render:function(){e.point("io.ox/calendar/edit/section/visibility-container").invoke("render",this)}},{nextTo:"alarms-container",rowClass:"collapsed"}),e.point("io.ox/calendar/edit/section/visibility-container").extend({id:"shown_as",index:100,render:function(){this.$el.append(new r.CustomCheckboxView({label:t("Show as free"),name:"transp",model:this.model,customValues:{false:"OPAQUE",true:"TRANSPARENT"},defaultVal:"OPAQUE"}).render().$el)}}),e.point("io.ox/calendar/edit/section/visibility-container").extend({id:"allowAttendeeChanges",index:200,render:function(){var e=b.pool.getModel(this.model.get("folder")).is("public")||"edit"===this.baton.mode&&!(a.hasFlag(this.model,"organizer")||a.hasFlag(this.model,"organizer_on_behalf"))||this.model.get("recurrenceId")&&"appointment"===this.model.mode,n=new r.CustomCheckboxView({label:t("Participants can make changes"),name:"attendeePrivileges",model:this.model,customValues:{false:"DEFAULT",true:"MODIFY"}});this.$el.append(n.render().$el.addClass("attendee-change-checkbox")),e&&n.$el.addClass("disabled").find("input").attr("aria-disabled",!0).prop("disabled","disabled")}}),C.extend({id:"attachments_legend",index:1500,className:"col-md-12",render:function(){this.$el.append($("<fieldset>").append($("<legend>").text(t("Attachments"))))}},{rowClass:"collapsed form-spacer"}),C.extend(new c.EditableAttachmentList({id:"attachment_list",registerAs:"attachmentList",className:"div",index:1600,noUploadOnSave:!0,module:1}),{rowClass:"collapsed"}),C.basicExtend({id:"attachments_upload",index:1700,rowClass:"collapsed",draw:function(e){var t=_.uniqueId("form-control-label-"),a=$('<form class="attachments-form">').appendTo(this).attr("id",t),n=c.fileUploadWidget({multi:!0}),o=n.find('input[type="file"]');o.on("change",function(t){t.preventDefault(),_(o[0].files).each(function(t){e.attachmentList.addFile(t)}),o[0].value="",o.trigger("reset.fileupload"),e.model.validate()}),n.on("change.fileupload",function(){$(this).find('div[data-provides="fileupload"]').addClass("fileupload-new").removeClass("fileupload-exists")}),a.append($("<div>").addClass("col-md-12").append(n)),e.model.on("invalid:quota_exceeded",function(e){require(["io.ox/core/yell"],function(t){t("error",e[0])})})}}),C.basicExtend({id:"attachments_upload_metrics",draw:function(){var e=this;require(["io.ox/metrics/main"],function(t){t.isEnabled()&&e.parent().find(".file-input").on("change",function(){t.trackEvent({app:"calendar",target:"edit",type:"click",action:"add-attachment"})})})}}),e.point("io.ox/calendar/edit/dnd/actions").extend({id:"attachment",index:10,label:t('Drop here to upload a <b class="dndignore">new attachment</b>'),multiple:function(e,t){_(e).each(function(e){t.view.baton.attachmentList.addFile(e)})}}),v.get("features/PIMAttachments",g.has("filestore"))||e.point("io.ox/calendar/edit/section").disable("attachments_legend").disable("attachments_upload"),null});