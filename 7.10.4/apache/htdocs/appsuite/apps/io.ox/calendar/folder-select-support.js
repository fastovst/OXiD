define("io.ox/calendar/folder-select-support",["io.ox/core/folder/api","settings!io.ox/calendar","io.ox/core/capabilities"],function(e,t,i){"use strict";function s(e,i){var s=this;i=i||{},this.folders=_(e).unique(),r.call(this),_.defer(function(){!0!==i.silent&&s.app.trigger("folders:change",s.folders),t.set("selectedFolders",s.folders).save()})}function r(){var t=_(e.pool.models).keys().length,i=[],s=_(this.folders).sortBy(function(s){var r=e.pool.models[s];return r?e.is("private",r.attributes)?r.get("index/flat/event/private"):e.is("public",r.attributes)?r.get("index/flat/event/public")+t:e.is("shared",r.attributes)?r.get("index/flat/event/shared")+t*t:void 0:i.push(s)});0===i.length&&(this.folders=s)}function o(r){_.extend(this,{folders:[],prevFolders:void 0,singleSelection:!1,app:r});var o=this,l=t.get("selectedFolders");l?0===l.length?(l=[e.getDefaultFolder("calendar")],s.call(this,l)):s.call(this,l):e.flat({module:"calendar",all:!0}).then(function(t){l=_(t.private).pluck("id"),!i.has("guest")&&i.has("edit_public_folders")&&l.push("cal://0/allPublic"),r.folder.get()!==e.getDefaultFolder("calendar")&&l.push(r.folder.get()),0===l.length&&(l=_(t.shared).pluck("id")),s.call(o,l),_(o.folders).each(o.repaintNode.bind(o))}),t.on("change:selectedFolders",function(e){_.isEqual(o.folders,e)||s.call(o,e)})}var l=["FLD-1004","FLD-0008","FLD-0003","CAL-4060","CAL-4030"];return o.prototype.isSingleSelection=function(){return this.singleSelection},o.prototype.getData=function(){var t=this;return $.when.apply($,this.folders.map(function(i){return/^(cal:\/\/0\/allPublic)$/.test(i)?{id:i}:e.get(i).then(function(e){if(e.subscribed)return e},function(e){_(l).contains(e.code)&&t.remove(i)})})).then(function(){return _(arguments).chain().toArray().compact().value()})},o.prototype.isSelected=function(e){var t=this.prevFolders?this.prevFolders:this.folders;return _.isObject(e)&&(e=e.id),t.indexOf(e)>=0},o.prototype.list=function(){return this.folders},o.prototype.add=function(e,t){this.singleSelection&&this.reset();var i=[].concat(this.folders);i.push(e),this.repaintNode(e),s.call(this,i,t)},o.prototype.remove=function(e,t){this.singleSelection&&this.reset();var i=_(this.folders).filter(function(t){return String(t)!==String(e)});this.repaintNode(e),s.call(this,i,t)},o.prototype.setOnly=function(e){this.singleSelection=!0,this.prevFolders||(this.prevFolders=this.folders),this.folders=[].concat([e]),this.app.folderView.tree.$el.addClass("single-selection"),_.defer(this.app.trigger.bind(this.app,"folders:change",this.folders))},o.prototype.reset=function(){this.singleSelection=!1,this.prevFolders&&(this.folders=this.prevFolders,this.prevFolders=void 0,this.app.folderView.tree.$el.removeClass("single-selection"),_.defer(this.app.trigger.bind(this.app,"folders:change",this.folders)))},o.prototype.repaintNode=function(e){this.app&&this.app.treeView?this.app.treeView.$('[data-id="'+e+'"]').each(function(){var e=$(this).data("view");e&&_.delay(e.repaint.bind(e),20)}):ox.debug&&console.log("Cannot repaint node: "+e)},function(e){e.folders=new o(e)}});