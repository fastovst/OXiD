define("io.ox/calendar/list/view",["io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/calendar/api","io.ox/core/folder/api","io.ox/calendar/perspective","io.ox/calendar/view-detail","io.ox/calendar/util","gettext!io.ox/calendar","less!io.ox/calendar/list/style"],function(e,t,i,a,n,o,s,l){"use strict";return n.extend({events:{},className:function(){if(!_.device("smartphone"))return"calendar-list-view vsplit"},initialize:function(e){var a=this,o=e.app;this.app=o;var d=[].concat((_.url.hash("id")||"").split(","));o.listView.once("first-reset",function(){o.listView.selection.set(d)}),this.listenTo(o.listView,{"selection:empty":function(){a.drawMessageRight(l("No appointment selected"))},"selection:one":function(e){a.showAppointment(s.cid(e[0]))},"selection:multiple":function(e){var t=$('<span class="number">').text(e.length).prop("outerHTML");a.drawMessageRight(l("%1$s appointments selected",t))},"selection:change":function(e){_.url.hash("id",e.join(","))}}),this.listenTo(i,{beforedelete:function(e){var t=o.listView.selection.get(),i=_.map(e,s.cid);_.intersection(i,t).length&&o.listView.selection.dodge()},"refresh.all":function(){var e=o.listView.loader,t=o.listView.collection;e.collection=t,o.listView.reload()},"process:create":function(e){o.listView.collection.once("reload",function(){o.listView.selection.set([s.cid(e)])})},"show:appointment":this.showAppointment}),o.getWindow().nodes.outer.on("selection:drop",function(e,a){var n=_.map(a.data,s.cid);i.getList(n).then(function(e){a.data=_(e).invoke("toJSON"),t.invoke("io.ox/calendar/detail/actions/move",a)})}),this.listenTo(o,"folders:change",this.onUpdateFolders),$.when(o.folder.getData(),o.folders.getData()).done(function(e,t){a.onUpdateFolders(_(t).pluck("id"))}),o.listView.load(),n.prototype.initialize.call(this,e)},onUpdateFolders:function(e){this.app.listView.model.set("folders",e)},render:function(){return _.device("smartphone")?(this.app.left.addClass("calendar-list-view vsplit"),this.app.right.addClass("default-content-padding calendar-detail-pane f6-target").attr({tabindex:-1,"aria-label":l("Appointment")})):(this.$el.append(this.app.left.addClass("border-right"),this.app.right.addClass("default-content-padding calendar-detail-pane f6-target").attr({tabindex:-1,"aria-label":l("Appointment")})),this.app.right.scrollable()),this},showAppointment:function(e,t){if(t||(t=e),!_.device("smartphone")||!0!==this.app.props.get("checkboxes")){t instanceof Backbone.Model&&(t=t.attributes),this.app.right.busy(!0);var n=this,o=_.lfo(function(e){(n.app.props.get("find-result")?a.get(e.get("folder")):$.when()).always(function(a){e.get("attendees")?n.drawAppointment(e,{noFolderCheck:a&&a.error}):i.get(t).then(function(e){n.drawAppointment(e,{noFolderCheck:a&&a.error})})})});i.get(t).then(o,_.lfo(this.drawMessageRight.bind(this,l("Could't load appointment data."))))}},drawAppointment:function(t,i){var a=e.Baton({model:t,data:t.attributes});if(_.device("smartphone")){this.app.pages.changePage("detailView");var n=this.app,s=n.pages.getPage("detailView");s.one("pagehide",function(){n.listView.selection.clear()}),s.idle().empty().append(o.draw(new e.Baton({model:t}),i)),this.app.pages.getToolbar("detailView").setBaton(a)}else a.disable("io.ox/calendar/detail","inline-actions"),this.app.right.idle().empty().append(o.draw(a,i))},drawMessageRight:function(e){this.app.right.idle().empty().append($('<div class="io-ox-center multi-selection-message">').append($('<div class="message">').append(e)))},beforeUpdateFolder:function(e,t){"calendar"===t.get("module")&&t.changed["com.openexchange.calendar.extendedProperties"]&&this.updateColor(t)},updateColor:function(e){if(e){var t=s.getFolderColor(e.attributes),i=this.$('[data-folder="'+e.get("id")+'"]');this.$('[data-folder="'+e.get("id")+'"]').css({"background-color":t}),i.parent().removeClass("black white"),i.parent().addClass("white"===s.getForegroundColor(t)?"white":"black")}},getName:function(){return"list"}})});