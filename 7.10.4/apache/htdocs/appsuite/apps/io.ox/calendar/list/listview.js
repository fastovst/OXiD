define("io.ox/calendar/list/listview",["io.ox/calendar/util","io.ox/calendar/model","io.ox/calendar/api","io.ox/core/extensions","io.ox/core/folder/api","io.ox/core/tk/list","gettext!io.ox/calendar","settings!io.ox/calendar","io.ox/calendar/list/view-options"],function(t,i,e,o,n,a,s,l){"use strict";return o.point("io.ox/chronos/listview/item").extend({id:"appointment-class",index:100,draw:function(){this.closest("li").addClass("appointment")}}),o.point("io.ox/chronos/listview/item").extend({id:"time",index:200,draw:function(i){var e=this,o=i.model,a=t.getStartAndEndTime(o.attributes),s=$('<div class="time custom_shown_as" aria-hidden="true">'),l=$('<div class="color-label">');this.attr("class","list-item-content"),o.get("folder")&&n.get(o.get("folder")).done(function(i){var n=t.getConfirmationStatus(o);e.addClass(t.getConfirmationClass(n)+(o.get("hard_conflict")?" hardconflict":""));var a=t.getAppointmentColor(i,o);l.css({"background-color":a}).attr({"data-folder":t.canAppointmentChangeColor(i,o)?i.id:""}),s.addClass("white"===t.getForegroundColor(a)?"white":"black")}),this.addClass("calendar "+t.getShownAsClass(o)).append(s.append($('<div class="fragment">').text(a[0]),$('<div class="fragment">').text(a[1]),l))}}),o.point("io.ox/chronos/listview/item").extend({id:"content-container",index:300,draw:function(t){var i=$('<div class="contentContainer" aria-hidden="true">');this.append(i),o.point("io.ox/chronos/listview/item/content").invoke("draw",i,t)}}),o.point("io.ox/chronos/listview/item/content").extend({id:"date",index:100,draw:function(i){var e=i.model;this.append($('<div class="date">').text(t.getDateInterval(e.attributes)).toggle(!t.isAllday(e)&&t.getDurationInDays(e.attributes)>0))}}),o.point("io.ox/chronos/listview/item/content").extend({id:"private",index:200,draw:function(i){t.isPrivate(i.model)&&this.append($('<i class="fa private-flag" aria-hidden="true">').addClass(t.isPrivate(i.model,!0)?"fa-user-circle":"fa-lock"))}}),o.point("io.ox/chronos/listview/item/content").extend({id:"summary",index:300,draw:function(i){var e=i.model,o=e.get("summary")?i.model.get("summary"):s("Private"),a=e.getMoment("startDate"),l=e.getMoment("endDate"),r=[o];t.isPrivate(e)&&e.get("summary")&&r.push(s("Private")),e.get("location")&&r.push(s.format(s.pgettext("a11y","location %1$s"),e.get("location"))),r.push(t.getShownAs(e)),r.push(a.isSame(l,"day")?t.getEvenSmarterDate(e):t.getDateIntervalA11y(e.attributes)),r.push(t.getTimeIntervalA11y(e.attributes)),this.closest("li").attr("aria-label",_.escape(r.join(", "))+"."),this.append($('<div class="title">').text(o)),e.get("folder")&&n.get(e.get("folder")).done(function(i){var o=t.getAppointmentColor(i,e);t.getColorName(o)&&(r.push(s("Category")+": "+t.getColorName(o)),this.closest("li").attr("aria-label",_.escape(r.join(", "))+"."))}.bind(this))}}),o.point("io.ox/chronos/listview/item/content").extend({id:"location",index:400,draw:function(t){this.append($('<span class="gray location">').text(t.model.get("location")||"Â "))}}),o.point("io.ox/chronos/listview/notification/empty").extend({id:"empty-label",index:100,draw:function(t){var i=t.listView.collection,e=moment(i.originalStart).add(i.range||0,"month").startOf("day");i.cid.indexOf("folders")<0||(this.addClass("empty").text(s.format(s("No appointments found until %s"),e.format("LLL"))),t.listView.drawTail())}}),o.point("io.ox/chronos/listview/notification/error").extend({id:"error",index:100,draw:function(t){this.append($('<i class="fa fa-exclamation-triangle" aria-hidden="true">'),$.txt(s("Error: Failed to load appointments")),$('<button type="button" class="btn btn-link">').text(s("Retry")).on("click",{baton:t},function(t){t.data.baton.listView.reload()}))}}),o.point("io.ox/chronos/list-view/toolbar/top").extend({id:"select-all",index:100,draw:function(t){function i(t,i){t.attr("class",i?"fa fa-check-square-o":"fa fa-square-o").parent().attr("aria-pressed",i)}function e(t){if("click"===t.type||32===t.which){t.preventDefault();var i=$(this).find("i"),e=t.data.baton.app.listView.selection;i.hasClass("fa-check-square-o")?e.selectNone():e.selectAll(),$(this).focus()}}var o;this.append($('<button type="button" class="btn btn-link select-all" data-name="select-all">').append(o=$('<i class="fa fa-square-o" aria-hidden="true">'),$.txt(s("Select all"))).on("click",{baton:t},e).on("dblclick",function(t){t.stopPropagation()}).on("keydown",{baton:t},e)),t.view.listView.on({"selection:all":function(){i(o,!0)},"selection:subset":function(){i(o,!1)}})}}),a.extend({ref:"io.ox/chronos/listview",initialize:function(t){a.prototype.initialize.call(this,t),this.$el.addClass("chronos-item").attr("aria-label",s("List view")),this.connect(e.collectionLoader),this.listenTo(l,"change:showDeclinedAppointments",this.rerender),this.on("collection:change:attendees",this.onChangeAttendee)},onChangeAttendee:function(i){"DECLINED"===t.getConfirmationStatus(i)&&(l.get("showDeclinedAppointments",!1)||(this.collection.remove(i),this.selection.dodge()))},rerender:function(){function t(){this.originalCollection&&(this.setCollection(this.originalCollection),this.collection.trigger("reset"))}this.$el.is(":visible")?t.call(this):this.app.getWindow().one("show",t.bind(this))},setCollection:function(e){function o(i){return"DECLINED"!==t.getConfirmationStatus(i)||l.get("showDeclinedAppointments",!1)}function n(t){t.forEach(function(t,i){t.set("index",i)})}var s="search"===this.loader.mode?{comparator:!1}:{};this.originalCollection&&this.stopListening(this.originalCollection),this.originalCollection=e,(e=new i.Collection(e.filter(o),s)).cid=this.originalCollection.cid;var r=!!this.collection;return a.prototype.setCollection.call(this,e),r&&e.length>0&&e.trigger("reset"),this.listenTo(this.originalCollection,{all:function(t){var i=_(arguments).toArray();/(add|remove|reset|sort)/.test(t)||this.collection.trigger.apply(this.collection,i)}.bind(this),add:function(t){o(t)&&this.collection.add(t)}.bind(this),reset:function(t){t&&(this.collection.reset(t.filter(o)),n(this.collection))}.bind(this),remove:function(t){this.collection.remove(t)},"remove sort":function(){this.collection.comparator&&this.collection.sort(),n(this.collection)}.bind(this),"change:startDate":function(i){var e=i.getMoment("startDate"),o=t.getMoment(i.previous("startDate"));if(!e.isSame(o,"day")){var a=moment(this.originalCollection.originalStart).add(this.originalCollection.range,"month");if(e.isAfter(a))return this.originalCollection.remove(i);this.collection.sort(),n(this.collection),_.defer(function(){this.onSort()}.bind(this))}}.bind(this)}),this.listenTo(this.collection,"paginate",_.debounce(this.onPaginatenEvent,20)),this},getLabel:function(i){return t.getEvenSmarterDate(i,!0)},empty:function(){return this.tail&&this.tail.remove(),a.prototype.empty.apply(this,arguments)},onAdd:function(t){if(!(this.$('[data-cid="'+$.escape(t.cid)+'"]').length>0))return a.prototype.onAdd.call(this,t)},renderListItem:function(t){return t===this.collection.last()&&_.defer(this.drawTail.bind(this)),a.prototype.renderListItem.apply(this,arguments)},onPaginatenEvent:function(){this.drawTail(),0===this.collection.length&&this.renderEmpty()},drawTail:function(){if(this.getBusyIndicator().length&&this.removeBusyIndicator(),!(this.collection.cid.indexOf("view=list")<0)){this.tail&&this.tail.remove();var t=moment(this.originalCollection.originalStart).add(this.originalCollection.range,"month");this.$el.append(this.tail=$('<li class="tail" role="presentation">').append($('<a href="#">').text(s("Load appointments until %1$s",t.format("l"))).on("click",this.onLoadMore.bind(this))))}},onLoadMore:function(t){t.preventDefault(),this.tail&&this.tail.remove(),this.loader.collection=this.originalCollection,this.paginate()}})});