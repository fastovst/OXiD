define("io.ox/calendar/main",["io.ox/core/commons","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/folder/api","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/backbone/views/datepicker","settings!io.ox/calendar","gettext!io.ox/calendar","io.ox/core/tk/list-control","io.ox/calendar/list/listview","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/calendar/api","io.ox/calendar/folder-select-support","io.ox/calendar/mobile-navbar-extensions","io.ox/calendar/mobile-toolbar-actions","io.ox/calendar/toolbar","io.ox/calendar/actions","less!io.ox/calendar/style","io.ox/calendar/week/view"],function(e,o,t,a,n,i,r,l,s,c,d,p,g,f,u){"use strict";function w(e){return["week:day","month","list","week:workweek","week:week","year"].indexOf(e)<0&&(e=_.device("smartphone")?"week:day":"week:workweek"),_.device("smartphone")&&_.indexOf(["week:workweek","week:week","calendar"],e)>=0?e="week:day":_.device("smartphone")&&_.indexOf(["week:day","list","month"],e)<0&&(e="week:day"),e}var h,v=ox.ui.createApp({name:"io.ox/calendar",id:"io.ox/calendar",title:"Calendar"});return v.mediator({"pages-mobile":function(e){if(!_.device("!smartphone")){var t=e.getWindow(),a=$('<div class="mobile-navbar">'),n=$('<div class="mobile-toolbar">').on("hide",function(){t.nodes.body.removeClass("mobile-toolbar-visible")}).on("show",function(){t.nodes.body.addClass("mobile-toolbar-visible")}),i=o.Baton({app:e});e.navbar=a,e.toolbar=n,e.pages=new g({appname:e.options.name,toolbar:n,navbar:a,container:t.nodes.main}),t.nodes.body.addClass("classic-toolbar-visible").append(a,n),e.pages.addPage({name:"start",startPage:!0}),e.pages.addPage({name:"folderTree",navbar:new p.NavbarView({baton:i,extension:"io.ox/calendar/mobile/navbarFoldertree"})}),e.pages.addPage({name:"month",navbar:new p.NavbarView({baton:i,extension:"io.ox/calendar/mobile/navbar"}),toolbar:new p.ToolbarView({baton:i,page:"month",extension:"io.ox/calendar/mobile/toolbar"})}),e.pages.addPage({name:"week:day",navbar:new p.NavbarView({baton:i,extension:"io.ox/calendar/mobile/navbar"}),toolbar:new p.ToolbarView({baton:i,page:"week",extension:"io.ox/calendar/mobile/toolbar"})}),e.pages.addPage({name:"list",navbar:new p.NavbarView({baton:i,extension:"io.ox/calendar/mobile/navbar"}),toolbar:new p.ToolbarView({baton:i,page:"list",extension:"io.ox/calendar/mobile/toolbar"}),secondaryToolbar:new p.ToolbarView({baton:i,page:"list/multiselect",extension:"io.ox/calendar/mobile/toolbar"})}),e.pages.addPage({name:"detailView",navbar:new p.NavbarView({baton:i,extension:"io.ox/calendar/mobile/navbar"}),toolbar:new p.ToolbarView({baton:i,page:"detailView",extension:"io.ox/calendar/mobile/toolbar"})}),e.pages.setBackbuttonRules({month:"folderTree","week:day":"month",list:"folderTree"})}},"pages-desktop":function(e){if(!_.device("smartphone")){var o=e.getWindow().nodes.main;e.pages=new g({appname:e.options.name}),e.pages.addPage({name:"start",container:o,startPage:!0}),e.pages.addPage({name:"month",container:o}),e.pages.addPage({name:"week:day",container:o}),e.pages.addPage({name:"week:workweek",container:o}),e.pages.addPage({name:"week:week",container:o}),e.pages.addPage({name:"list",container:o}),e.pages.addPage({name:"listView",classes:"leftside"}),e.pages.addPage({name:"detailView",classes:"rightside"}),e.pages.addPage({name:"year",container:o})}},subscription:function(e){e.subscription={wantedOAuthScopes:["calendar_ro"]}},"list-vsplit":function(e){_.device("smartphone")||(e.left=e.pages.getPage("listView"),e.right=e.pages.getPage("detailView"))},"list-vsplit-mobile":function(e){_.device("!smartphone")||(e.left=e.pages.getPage("list"),e.right=e.pages.getPage("detailView"))},"navbars-mobile":function(e){_.device("!smartphone")||(e.pages.getNavbar("month").on("leftAction",function(){e.pages.goBack()}).setLeft(s("Calendars")),e.pages.getNavbar("week:day").on("leftAction",function(){e.pages.changePage("month",{animation:"slideright"})}).setLeft(s("Back")),e.pages.getNavbar("list").on("leftAction",function(){e.pages.goBack()}).setLeft(s("Folders")).setRight(s("Edit")),e.pages.getNavbar("folderTree").setTitle(s("Folders")).setLeft(s("Edit")).setRight(s("Back")),e.pages.getNavbar("detailView").setTitle("").setLeft(s("Back")),e.pages.getNavbar("detailView").on("leftAction",function(){e.pages.goBack()}),e.pages.getNavbar("list").on("rightAction",function(){!0===e.props.get("checkboxes")?(e.listView.selection.clear(),e.pages.getNavbar("list").setRight(s("Edit")).show(".left")):e.pages.getNavbar("list").setRight(s("Cancel")).hide(".left"),e.props.set("checkboxes",!e.props.get("checkboxes")),e.listView.toggleCheckboxes(e.props.get("checkboxes")),e.listControl.$el.toggleClass("toolbar-top-visible",e.props.get("checkboxes"))}))},"mini-calendar":function(e){o.point("io.ox/calendar/sidepanel").extend({id:"mini-calendar",index:50,draw:function(){if(!_.device("smartphone")){var o={"week:workweek":"week","week:week":"week",month:"month",year:"year"};new r({parent:this.closest("#io-ox-core"),showTodayButton:!1}).on("select",function(o){e.setDate(o,{propagate:!1}),this.setDate(o,!0)}).listenTo(e.props,"change:date",function(t,a){var n=o[e.props.get("layout")];n&&moment(a).startOf(n).valueOf()===moment(this.getDate()).startOf(n).valueOf()||this.setDate(a,!0)}).listenTo(e.props,"change:showMiniCalendar",function(e,o){this.$el.toggle(!!o)}).render().$el.toggle(e.props.get("showMiniCalendar")).appendTo(this)}}})},"folder-view":function(e){_.device("smartphone")||(e.treeView=new n({app:e,contextmenu:!0,flat:!0,indent:!1,module:"calendar",dblclick:!0}),i.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable(),e.folderView.tree.$el.attr("aria-label",s("Calendars")))},"folder-view-mobile":function(e){if(!_.device("!smartphone")){var o=e.pages.getNavbar("folderTree"),t=e.pages.getPage("folderTree");o.on("leftAction",function(){e.toggleFolders()}),o.on("rightAction",function(){e.pages.changePage("month",{animation:"slideleft"})});var a=new n({app:e,contextmenu:!0,flat:!0,indent:!1,module:"calendar"});i.initialize({app:e,tree:a,firstResponder:!1}),t.append(a.render().$el),e.treeView=a}},"folder-create":function(e){a.on("create",function(o){"calendar"===o.module&&(e.folders.add(o.id),e.folder.set(o.id))})},"folder-remove":function(e){a.on("hide remove",function(o){e.folders.remove(o)}),f.on("all:fail",function(o){e.folders.remove(o,{silent:!0}),a.refresh()})},"multi-folder-selection":function(e){u(e),e.on("folder:change",function(){e.folders.reset()}),e.folderView.tree.on("dblclick",function(o,t){t&&($(o.target).hasClass("color-label")||a.isVirtual(t)||(e.folder.set(t),e.folders.isSingleSelection()?e.folders.reset():e.folders.setOnly(t)))})},"toggle-folder-view":function(o){e.addFolderViewToggle(o)},"account-errors":function(e){var o;e.treeView.on("click:account-error",function(e){(o=e["com.openexchange.calendar.accountError"])&&require(["io.ox/backbone/views/modal","io.ox/core/notifications"],function(t,n){var i=/(OAUTH-0013)/.test(o.code);new t({point:"io.ox/calendar/account-errors",title:s("Calendar account error")}).extend({default:function(){this.$body.append($('<div class="info-text">').css("word-break","break-word").text(o.error))}}).addCancelButton().addButton(i?{label:s("Edit accounts"),action:"accounts",className:"btn-primary"}:{label:s("Try again"),action:"retry",className:"btn-primary"}).on("retry",function(){n.yell("warning",s("Refreshing calendar might take some time...")),f.refreshCalendar(e.id).then(function(){n.yell("success",s("Successfully refreshed calendar"))},n.yell).always(function(){a.pool.unfetch(e.id),a.refresh()})}).on("accounts",function(){var e={id:"io.ox/settings/accounts"};ox.launch("io.ox/settings/main",e).done(function(){this.setSettingsPane(e)})}).open()})})},views:function(e){var o=["week:day","month","list"],t=_.device("smartphone")?"week:day":"week:workweek",a={},n=_.url.hash("id");_.device("!smartphone")&&o.push("week:workweek","week:week","year"),o.forEach(function(o){var i=e.pages.getPage(o);i.one("pagebeforeshow",function(){var r=o.split(":"),l=r[0]||"week",s=r[1]||(_.device("smartphone")?"day":"workweek");require(["io.ox/calendar/"+l+"/view"]).then(function(t){var r=new t({mode:s,app:e,deepLink:n});n=null,i.append(r.$el),r.render(),e.getWindow().trigger("change:perspective",r),e.perspective=a[o]=r,e.props.set("layout",o)},function(){if(o!==t)return e.pages.changePage(t)})}),i.on("pagebeforeshow",function(){_.url.hash("perspective",o),a[o]&&(a[o].trigger("show"),e.perspective=a[o],e.getWindow().trigger("change:perspective",a[o]),_.device("!smartphone")&&l.set("viewView",o))}),i.on("pageshow",function(){e&&e.perspective&&e.perspective.appointmentView&&e.perspective.appointmentView.updateHiddenIndicators&&e.perspective.appointmentView.updateHiddenIndicators()})})},listview:function(e){e.listView=new d({app:e,draggable:!1,pagination:!1,labels:!0,ignoreFocus:!0,noPullToRefresh:!0}),e.listView.model.set({view:"list"},{silent:!0}),window.list||(window.list=e.listView)},"list-view-control":function(e){e.listControl=new c({id:"io.ox/chronos",listView:e.listView,app:e}),e.left.append(e.listControl.render().$el.attr("aria-label",s("Appointments")).find(".toolbar").attr("aria-label",s("Appointment options")).end()),e.listControl.resizable()},"premium-area":function(t){o.point("io.ox/calendar/sidepanel").extend({id:"premium-area",index:1e4,draw:function(){this.append(e.addPremiumFeatures(t,{append:!1,upsellId:"folderview/calendar/bottom",upsellRequires:"caldav"}))}})},"toggle-folder-editmode":function(e){if(!_.device("!smartphone")){e.toggleFolders=function(){var o=e.pages.getPage("folderTree"),t=e.props.get("mobileFolderSelectMode"),a=s(t?"Edit":"Cancel");e.props.set("mobileFolderSelectMode",!t),e.pages.getNavbar("folderTree").setLeft(a),e.pages.getNavbar("folderTree").$el.find(".right").toggle(!!t),o.toggleClass("mobile-edit-mode",!t)}}},props:function(e){var o=_.device("!smartphone")?l.get("viewView"):void 0;o||(o="week:week"),e.props=new Backbone.Model({date:moment().valueOf(),layout:o,checkboxes:!_.device("smartphone")&&e.settings.get("showCheckboxes",!1),mobileFolderSelectMode:!1,showMiniCalendar:e.settings.get("showMiniCalendar",!0),showMonthviewWeekend:e.settings.get("showMonthviewWeekend",!0)}),e.getDate=function(){return moment(e.props.get("date"))},e.setDate=function(o,t){if(!_.isArray(o._i))return e.props.set("date",moment(o).valueOf(),t);var a=this.getDate(),n=o._i,i=n.length>0?n[0]:a.year(),r=n.length>1?n[1]:a.month(),l=n.length>2?n[2]:a.date();_.isNaN(moment([i,r,l]).valueOf())&&(l=1),e.props.set("date",moment([i,r,l]).valueOf(),t)}},"listview-checkboxes":function(e){_.device("smartphone")?e.listControl.$el.toggleClass("toolbar-top-visible",e.props.get("checkboxes")):e.listControl.$(".select-all").toggle(e.props.get("checkboxes")),e.listView.toggleCheckboxes(e.props.get("checkboxes"))},"prop-folderview":function(e){_.device("smartphone")||e.props.set("folderview",e.settings.get("folderview/visible/"+_.display(),!0))},"prop-folderview-mobile":function(e){_.device("!smartphone")||e.props.set("folderview",!1)},"store-view-options":function(e){_.device("smartphone")||e.props.on("change",_.debounce(function(o,t){if(t&&!t.fluent&&!e.props.get("find-result")){var a=e.props.toJSON();e.settings.set("viewView",_.device("smartphone")?e.settings.get("viewView"):a.layout).set("showCheckboxes",a.checkboxes).set("showMiniCalendar",a.showMiniCalendar).set("showMonthviewWeekend",a.showMonthviewWeekend).save()}},500))},"change:folderview":function(e){_.device("smartphone")||(e.props.on("change:folderview",function(o,t){e.folderView.toggle(t)}),e.on("folderview:close",function(){e.props.set("folderview",!1)}),e.on("folderview:open",function(){e.props.set("folderview",!0)}))},"change:checkboxes":function(e){function o(o){e.listControl.$el.toggleClass("toolbar-top-visible",o)}_.device("smartphone")||e.props.on("change:checkboxes",function(t,a){e.listView.toggleCheckboxes(a),a&&o(!0),e.listControl.$(".select-all").toggle("value",function(){a||o(!1)})})},"change:layout":function(e){e.props.on("change:layout",function(o,t){e.pages.changePage(t,{disableAnimations:!0})})},"folder-error":function(e){e.folder.handleErrors()},create:function(e){f.on("create move",function(o){var t=a.pool.getModel(o.folder);if(!(e.folders.isSelected("cal://0/allPublic")&&t&&t.is("public")||e.folders.isSingleSelection())){e.folders.add(o.folder);var n=a.pool.getModel(o.folder);n.trigger("change",n)}})},"delete-mobile":function(e){_.device("!smartphone")||f.on("delete",function(){"detailView"===e.pages.getCurrentPage().name&&e.pages.goBack()})},"api-events":function(e){f.on("create update delete refresh.all",function(){a.reload(e.folder.get())})},"inplace-find":function(e){function a(o,t){t.on({"find:query":function(){(n=n||e.props.get("layout")||_.sanitize.option(_.url.hash("perspective")))!==i&&(e.props.set("layout",i,{fluent:!0}),e.props.on("change",t.cancel))},"find:cancel":function(){var o=_.sanitize.option(_.url.hash("perspective"))||e.props.get("layout");n&&n!==o&&e.props.set("layout",n),e.props.off("change",t.cancel),n=void 0}})}if(!_.device("smartphone")&&t.has("search")&&e.isFindSupported()){e.initFind();var n,i="list";return o.point("io.ox/chronos/listview/notification/empty").extend({id:"no-resulsts",index:200,draw:function(){n&&this.text(s("No matching items found."))}}),e.get("find")?a(0,e.get("find")):e.once("change:find",a)}},"show-weekview-mobile":function(e){_.device("!smartphone")||e.pages.getPage("week:day").on("pageshow",function(){e.pages.getNavbar("week:day").setLeft(e.getDate().format("MMMM"))})},"selection-doubleclick":function(e){_.device("smartphone")||e.listView.on("selection:doubleclick",function(e){e.length<1||ox.launch("io.ox/calendar/detail/main",{cid:e[0]})})},"virtual-folders":function(e){t.has("guest")||e.folderView.tree.selection.addSelectableVirtualFolder("cal://0/allPublic")},"contextual-help":function(e){e.getContextualHelp=function(){return"ox.appsuite.user.sect.calendar.gui.html"}},sidepanel:function(e){o.point("io.ox/calendar/sidepanel").extend({id:"tree",index:100,draw:function(e){_.device("smartphone")||this.addClass("border-right").append(e.app.treeView.$el)}});var t=e.getWindow().nodes.sidepanel;o.point("io.ox/calendar/sidepanel").invoke("draw",t,o.Baton({app:e}))},metrics:function(e){require(["io.ox/metrics/main"],function(o){function t(e,t){var a=!!(t=$(t)).attr("data-name"),n=(t.attr("data-action")||"").replace(/^io\.ox\/calendar\/(detail\/)?/,"");o.trackEvent({app:"calendar",target:e,type:"click",action:a?t.attr("data-name"):n,detail:a?t.attr("data-value"):""})}if(o.isEnabled()){var a=e.getWindow().nodes,n=a.sidepanel;a.main.on("mousedown",".calendar-list-view .toolbar.top a a[data-name], .calendar-list-view .toolbar.top a a[data-action]",function(e){var t=$(e.currentTarget),a=t.attr("data-name")||t.attr("data-action");a&&o.trackEvent({app:"calendar",target:"list/toolbar",type:"click",action:a})}),a.body.on("track",".classic-toolbar-container",function(e,o){t("toolbar",o)}),a.outer.on("track",".io-ox-sidepopup",function(e,o){t("detail/toolbar",o)}),_.defer(function(){n.find(".context-dropdown").on("mousedown","a",function(e){o.trackEvent({app:"calendar",target:"folder/context-menu",type:"click",action:$(e.currentTarget).attr("data-action")})})}),n.find(".bottom").on("mousedown","a[data-action]",function(e){$(e.currentTarget).attr("data-action")&&o.trackEvent({app:"calendar",target:"folder/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})}),n.find(".folder-tree").on("mousedown",".folder-shared, .fa.folder-sub",function(){o.trackEvent({app:"calendar",target:"folder",type:"click",action:"permissions"})}),e.on("folder:change folder-virtual:change",function(e){o.getFolderFlags(e).then(function(e){o.trackEvent({app:"calendar",target:"folder",type:"click",action:"select",detail:e.join("/")})})}),e.listView.on({"selection:change":function(e){e.length&&o.trackEvent({app:"calendar",target:"list",type:"click",action:"select",detail:e.length>1?"multiple":"one"})}}),e.on("showAppointment",function(e,t,a){var n=a||"list";o.trackEvent({app:"calendar",target:n,type:"click",action:"select",detail:"one"})}),e.on("createAppointment openCreateAppointment",function(e,t,a){var n=a||"list";o.trackEvent({app:"calendar",target:n,type:"click",action:"create"})})}})}}),v.setLauncher(function(o){function n(t){t=t||a.getDefaultFolder("calendar"),e.addFolderSupport(v,null,"calendar",t).always(function(){v.mediate(),h.show()}).fail(function(e){var o=s("Application may not work as expected until this problem is solved.");e&&e.error&&(o=e.error+" "+o),require(["io.ox/core/notifications"],function(e){e.yell("error",o)})}).done(function(){var e=w(o.perspective||_.sanitize.option(_.url.hash("perspective"))||v.props.get("layout"));v.pages.changePage(e,{disableAnimations:!0})})}v.setWindow(h=ox.ui.createWindow({name:"io.ox/calendar",find:t.has("search"),chromeless:!0})),v.settings=l,h.addClass("io-ox-calendar-main"),!o.folder&&t.has("guest")?a.getFlatCollection("calendar","shared").fetched?n(a.getFlatCollection("calendar","shared").models[0].get("id")):a.flat({module:"calendar"}).done(function(e){n(e.shared[0])}):n(o.folder)}),v.setResume(function(e){var o=$.when();if(e){var t=[],a=this.getWindow();if(a.busy(),e.folder&&e.folder!==this.folder.get()&&t.push(this.folder.set(e.folder)),e.perspective&&e.perspective!==v.props.get("layout")){var n=w(e.perspective);_.device("smartphone")&&t.push(v.props.set("layout",n))}(o=$.when.apply(this,t)).always(function(){a.idle()})}return o}),{getApp:v.getInstance}});