define("io.ox/realtime/groups",["io.ox/realtime/rt","io.ox/core/event"],function(e,r){"use strict";function t(t){function i(e){return function(r,t){c.trigger(e,t)}}function a(e){var r=$.Deferred();if(e)return e.done(r.resolve).fail(r.reject),f.push(r),r.always(function(){f=_(f).without(r)}),r}function s(){if(l)throw new Error("This group has already been destroyed")}var c=this,u=null,d="rt-group-"+n,l=!1,f=[];n++,e.on("receive:"+d,function(e,r){c.trigger("receive",r)}),e.on("error:"+d,function(e,r){var t=r.get("","error");t.data&&1008===t.data.code?(c.trigger("error:notMember"),clearInterval(u),u=null):t.data&&1010===t.data.code?(c.trigger("error:disposed"),clearInterval(u),u=null):t.data&&1012===t.data.code?(c.trigger("error:joinFailed",t),clearInterval(u),u=null):t.data&&1013===t.data.code?c.trigger("error:leaveFailed",t):t.data&&1011===t.data.code&&c.trigger("error:stanzaProcessingFailed",t),c.trigger("error",t)});var g=i("offline"),h=i("online"),v=i("reset"),m=i("highLoad");e.on("offline",g),e.on("online",h),e.on("reset",v),e.on("highLoad",m),this.id=t,this.join=function(r){s(),u||(u=setInterval(function(){e.sendWithoutSequence({element:"message",to:t,payloads:[{element:"command",namespace:"group",data:"ping"}]})},6e4));var n={element:"message",trace:(r=r||{}).trace,selector:d,payloads:_([{element:"command",namespace:"group",data:"join"}]).concat(r.additionalPayloads||[])};if(e.debug&&console.log("JOIN: ",n),r.expectWelcomeMessage)return this.query(n);this.send(n)},this.leave=function(e){if(s(),!u)return $.when();e=e||{},clearInterval(u),u=null;var r={element:"message",trace:e.trace,force:e.force,payloads:_([{element:"command",namespace:"group",data:"leave"}]).concat(e.additionalPayloads||[])};if(e.expectSignOffMessage)return this.query(r);this.send(r)},this.isForceLeavePossible=function(){return!e.hasPendingAcks()},this.forceLeave=function(e){return e=_.extend({},e,{force:!0}),this.leave(e)},this.sendWithoutSequence=function(r){return s(),r.to=t,r.selector=d,a(e.sendWithoutSequence(r))},this.send=function(r){return s(),r.to=t,r.selector=d,a(e.send(r))},this.query=function(r){return s(),r.to=t,r.selector=d,a(e.query(r))},this.destroy=function(){s(),u&&this.leave(),_(f).invoke("reject"),e.off("receive:"+d),e.off("error:"+d),e.off("offline",g),e.off("online",h),e.off("reset",v),e.off("highLoad",m),delete o[t],this.events.destroy(),l=!0},this.isRTWorking=function(){return e.send!==$.noop},this.getUuid=function(){return e.resource},r.extend(this)}var n=0,o={};return{getGroup:function(e){return o[e]?o[e]:(o[e]=new t(e),o[e])},existsGroup:function(e){return _.isObject(o[e])},rtId:e.resource}});