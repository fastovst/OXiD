define("io.ox/participants/views",["io.ox/contacts/api","io.ox/core/util","io.ox/core/folder/api","io.ox/core/capabilities","gettext!io.ox/core","less!io.ox/participants/style"],function(t,i,e,s,o){"use strict";var n={0:o("Unknown"),1:"",2:o("Group"),3:o("Resource"),4:o("Resource group"),5:s.has("gab")?o("External contact"):"",6:o("Distribution list")},a={0:"default-image",1:"contact-image",2:"group-image",3:"resource-image",4:"resource-image",5:"external-user-image",6:"group-image"},l=Backbone.View.extend({tagName:"div",className:"participant-wrapper",events:{"click .remove":"onRemove",keydown:"fnKey"},options:{halo:!1,closeButton:!1,field:!1,customize:$.noop},nodes:{},initialize:function(t){this.options=$.extend({},this.options,t||{}),this.listenTo(this.model,"change",function(t){t&&t.changed&&(this.$el.empty(),this.render())}),this.listenTo(this.model,"remove",function(){this.remove()})},render:function(){return this.$el.append(this.nodes.$img=$("<div>"),this.nodes.$text=$('<div class="participant-name">'),this.options.hideMail?"":$('<div class="participant-email">').append(this.nodes.$mail=this.options.halo?$("<a>"):$("<span>")),this.options.hideMail?"":$('<div class="extra-decorator">').append(this.nodes.$extra=$("<span>")),$('<a href="#" class="remove" role="button">').append($('<div class="icon">').append($('<i class="fa fa-trash-o" aria-hidden="true">').attr("title",o("Remove contact")+" "+this.model.getDisplayName()),$('<span class="sr-only">').text(o("Remove contact")+" "+this.model.getDisplayName())))).attr({"data-cid":this.model.cid}).toggleClass("removable",this.options.closeButton),this.setCustomImage(),this.setDisplayName(),this.setTypeStyle(),this.options.customize.call(this),this.trigger("render"),this},setDisplayName:function(){var t={$el:this.nodes.$text};this.options.asHtml?t.html=this.model.getDisplayName({asHtml:!0,isMail:this.options.isMail}):t.name=this.model.getDisplayName({asHtml:!1,isMail:this.options.isMail}),i.renderPersonalName(t,this.model.toJSON())},setCustomImage:function(){var i=this.model.toJSON();5===i.type&&delete i.id,t.pictureHalo(this.nodes.$img,i,{width:54,height:54}),this.nodes.$img.attr("aria-hidden",!0).addClass("participant-image "+(a[parseInt(this.model.get("type"),10)]||""))},setRows:function(t,i){this.options.hideMail||(i=i||n[this.model.get("type")]||"",this.nodes.$mail.text(t),this.nodes.$extra.text(i),t&&i&&this.$el.addClass("three-rows"))},isOrganizer:function(){if(!this.options.baton)return!1;var t=this.options.baton.model.toJSON();return!!t.organizerId&&this.model.get("id")===t.organizerId},isRemovable:function(){if(!this.options.baton)return!1;var t=this.options.baton.model.toJSON();return this.model.get("id")!==t.organizerId||e.pool.getModel(t.folder_id).is("public")},setTypeStyle:function(){var t=this.model.getTarget({strict:this.options.strict}),i=null;switch(t&&this.options.field&&this.model.getFieldString()&&(t+=" ("+this.model.getFieldString()+")"),this.model.get("type")){case 1:case 5:this.isOrganizer()&&(i=o("Organizer"),this.isRemovable()||this.$el.removeClass("removable")),t&&this.options.halo&&this.nodes.$mail.attr({href:"mailto:"+t}).data({email1:t}).addClass("halo-link");break;case 3:if(this.options.halo&&!this.options.hideMail){var e=this.model.toJSON();e.callbacks={},this.options.baton&&this.options.baton.callbacks&&(e.callbacks=this.options.baton.callbacks);var s=$('<a href="#">').data(e).addClass("halo-resource-link");this.nodes.$extra.replaceWith(s),this.nodes.$extra=s}}this.setRows(t,i)},fnKey:function(t){46!==t.which&&8!==t.which||this.onRemove(t)},onRemove:function(t){t.preventDefault(),this.model.collection.remove(this.model)}}),r=Backbone.View.extend({tagName:"div",className:"participantsrow col-xs-12",initialize:function(t){this.options=_.extend({empty:o("This list has no participants yet")},t),this.listenTo(this.collection,"add",function(t){this.renderLabel(),this.renderEmptyLabel(),this.renderParticipant(t)}),this.listenTo(this.collection,"remove",function(){this.renderLabel(),this.renderEmptyLabel()}),this.listenTo(this.collection,"reset",function(){this.$ul.empty(),this.renderAll()}),this.$empty=$("<li>").text(this.options.empty),this.options.baton||(this.isDistributionList=this.options.baton.model.has("mark_as_distributionlist"))},render:function(){return this.$el.append($("<fieldset>").append($("<legend>").addClass(this.options.labelClass||""),this.$ul=$('<ul class="list-unstyled">'))),this.renderAll(),this},renderLabel:function(){var t=this.collection.length,i=this.options.label||(this.isDistributionList?o("Members (%1$d)",t):o("Participants (%1$d)",t));this.$("fieldset > legend").text(i)},renderParticipant:function(t){var i=new l({tagName:"li",model:t,baton:this.options.baton,halo:void 0===this.options.halo||this.options.halo,closeButton:!0,hideMail:this.options.hideMail,asHtml:this.options.asHtml,isMail:this.options.isMail,strict:this.options.strict});i.on("render",function(){this.collection.trigger("render")}.bind(this)),i.render().$el.addClass(this.options.entryClass||"col-xs-12 col-sm-6"),t.get("id")===this.options.baton.model.get("organizerId")?this.$ul.prepend(i.$el):this.$ul.append(i.$el)},renderAll:function(){var t=this;return this.renderLabel(),this.renderEmptyLabel(),this.collection.each(function(i){t.renderParticipant(i)}),this},renderEmptyLabel:function(){if(!this.options.noEmptyLabel)return 0===this.collection.length?this.$ul.append(this.$empty):this.$empty.remove(),this.$ul.toggleClass("empty",0===this.collection.length)}});return{ParticipantEntryView:l,UserContainer:r}});