define("io.ox/participants/detail",["io.ox/calendar/util","io.ox/core/api/user","io.ox/core/api/group","io.ox/core/api/resource","io.ox/core/extensions","io.ox/contacts/util","io.ox/mail/util","io.ox/core/util","gettext!io.ox/core","less!io.ox/participants/style"],function(a,t,e,n,i,s,r,o,l){"use strict";function p(a,t,e){e=_.extend({halo:!0},e);var n=t[a.mail||a.id]||{status:0,comment:""},s=$('<li class="participant">'),r={name:a.display_name,email:a.mail||a.mailaddress||a.email1,user_id:a.user_id||a.internal_userid,isResource:"mailaddress"in a&&"description"in a},o=new i.Baton({obj:a,data:r,conf:n,options:e});return i.point("io.ox/participants/item").invoke("draw",s,o),s}function c(a){a.preventDefault(),$(this).parent().hasClass("active")?($(this).attr("aria-pressed",!1),$(".active",a.data.participants).removeClass("active"),$(".participant",a.data.participants).show()):($(".participant",a.data.participants).show().find("a.person:not(."+a.data.res.css+")").parent().toggle(),$(".active",a.data.participants).removeClass("active"),$(this).attr("aria-pressed",!0).parent().addClass("active"))}return i.point("io.ox/participants/item").extend({index:100,id:"resource",draw:function(a){var t=a.data;if(t.isResource)return a.options.halo?void this.append($('<a href="#" role="button" class="halo-resource-link">').attr("title",t.name).data(_.extend(a.obj,{email1:t.email})).append($.txt(t.name))):this.append($.txt(t.name))}}),i.point("io.ox/participants/item").extend({index:200,id:"person",draw:function(a){if(!a.data.isResource){var t=a.data,e=r.getDisplayName([t.name,t.email],{showMailAddress:!0}),n=a.obj.full_name?$(a.obj.full_name):$.txt(e),i=_.extend({html:n},t);a.options.halo||(i.$el=$("<span>")),this.append(o.renderPersonalName(i,a.obj))}}}),i.point("io.ox/participants/item").extend({index:300,id:"status",draw:function(t){var e=t.conf,n=a.getConfirmationSymbol(e.status),i=e.comment||e.message||"",s=a.getConfirmationClass(e.status);this.children().first().addClass(s).addClass(t.data.isResource?"":"person"),this.append(t.data.isResource?"":$('<span class="sr-only">').text(", "+a.getConfirmationLabel(e.status)+"."),n?$('<span class="status" aria-hidden="true">').addClass(s).append(n):"",i?$('<div class="comment">').text(i):"")}}),function(r,o){o=_.extend({summary:!0,inlineLinks:!1,halo:!0},o),this.draw=function(){var d=!1;r.data||(r.data=r.model.attributes,d=!0);var u=r.data.participants||{},m=u.length,f=m>0?$('<div class="participants-view">'):$(),h={};if(m>0){f.busy();var x=_(u).chain().select(function(a){return 1===a.type}).map(function(a){return a.id}).value(),v=_(u).chain().select(function(a){return 2===a.type}).map(function(a){return{id:a.id}}).value(),g=_(u).chain().select(function(a){return 3===a.type}).map(function(a){return{id:a.id}}).value(),y=_(u).chain().select(function(a){return 5===a.type}).sortBy(function(a){return a.mail}).value();h=void 0===r.data.confirmations||0===r.data.confirmations.length?a.getConfirmations({users:r.data.users,confirmations:y}):a.getConfirmations(r.data),$.when(t.getList(x),e.getList(v),n.getList(g)).done(function(a,e,n){var i;a.length>0&&f.append($("<fieldset>").append($('<legend class="io-ox-label">').append($("<h2>").text(l("Participants"))),i=$('<ul class="participant-list list-inline">'))),_(a).chain().map(function(a){return a.full_name=s.getFullName(a,!0),a.sort_name=a.last_name||a.first_name||a.display_name||"",a}).sortBy(function(a){return a.sort_name}).each(function(a){i.append(p(a,h,o))});var c;if(y.length>0&&f.append($("<fieldset>").append($('<legend class="io-ox-label">').append($("<h2>").text(l("External participants"))),c=$('<ul class="participant-list list-inline">'))),_(y).each(function(a){c.append(p(a,h,o))}),_(e).chain().sortBy(function(a){return a.display_name}).each(function(a){var e,n;n=_(a.members).difference(x),_.isArray(r.data.users)&&(n=_(n).intersection(_(r.data.users).pluck("id"))),n.length&&(f.append($("<fieldset>").append($('<legend class="group io-ox-label">').append($("<h2>").text(a.display_name+":")),e=$('<ul class="participant-list list-inline">'))),t.getList(n).done(function(a){_(a).chain().map(function(a){return a.full_name=s.getFullName(a,!0),a.sort_name=a.last_name||a.first_name||a.display_name||"",a}).sortBy(function(a){return a.sort_name}).each(function(a){e.append(p(a,h))})}))}),n.length){var d;f.append($("<fieldset>").append($('<legend class="io-ox-label">').append($("<h2>").text(l("Resources"))),d=$('<ul class="participant-list list-inline">'))),_(n).chain().sortBy(function(a){return a.display_name}).each(function(a){d.append(p(a,h,o))})}}).always(function(){var t=a.getConfirmationSummary(h);o.summary&&t.count>3&&f.find("legend").first().append($('<ul class="summary list-inline pull-right">').attr("aria-label",l("Summary")).append(_.map(t,function(a){if(_.isNumber(a.count)&&!(a.count<=0))return $("<li>").append($('<a href="#" role="button" aria-pressed="false">').text(a.count).attr("aria-label",a.title+" "+a.count).prepend($('<span class="status">').addClass(a.css).append(a.icon)).on("click",{participants:f,res:a},c))}))),d&&delete r.data,o.inlineLinks&&i.point(o.inlineLinks).invoke("draw",f,r),f.idle()})}return f}}});