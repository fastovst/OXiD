define("io.ox/participants/model",["io.ox/core/api/user","io.ox/core/api/group","io.ox/core/api/resource","io.ox/contacts/api","io.ox/contacts/model","io.ox/contacts/util"],function(t,i,e,s,n,a){"use strict";function r(e){return $.Deferred().resolve().then(function(){var t=e instanceof Backbone.Model?e.get("members"):e.members;return t?{members:t}:i.get({id:e.id||e.get("id")})}).then(function(i){return t.getList(i.members)}).then(function(t){return _.sortBy(t,"last_name")})}function h(t,i){return(t=t||{}).get?t.get(i):t[i]}var l={UNKNOWN:0,USER:1,USER_GROUP:2,RESOURCE:3,RESOURCE_GROUP:4,EXTERNAL_USER:5,DISTLIST:6},o={0:"unknown",1:"internal",2:"usergroup",3:"resource",4:"resourcegroup",5:"external",6:"distlist"},c=Backbone.Model.extend({idAttribute:"pid",defaults:{display_name:"",email1:"",field:"email1",type:5},loading:null,initialize:function(){var t=this;if(_.isString(this.get("type"))){var i=l.UNKNOWN;switch(this.get("type")){case"user":i=l.USER;break;case"group":i=l.USER_GROUP;break;case"resource":i=l.RESOURCE;break;case"contact":i=this.get("mark_as_distributionlist")?l.DISTLIST:l.EXTERNAL_USER}this.set("type",i)}this.get("mail_field")&&this.set("field","email"+this.get("mail_field")),this.loading=this.fetch().then(function(){t.magic()})},magic:function(){this.is("special-contact")&&this.set({type:l.USER,contact_id:this.get("id"),id:this.get("internal_userid")}),this.is("special-user")&&this.set({type:l.EXTERNAL_USER,internal_userid:this.get("id"),id:this.get("contact_id")}),this.is("contact")&&!this.has("id")&&this.set("id",this.getEmail(),{silent:!0}),this.setPID(),this.value=this.getTarget()||this.getDisplayName()},setPID:function(){var t=[o[this.get("type")],this.get("id"),this.get("field")].join("_");this.set("pid",t,{silent:!0})},is:function(t){switch(t){case"user":return this.get("type")===l.USER;case"contact":return this.get("type")===l.EXTERNAL_USER;case"group":return this.get("type")===l.USER_GROUP;case"resource":return this.get("type")===l.RESOURCE;case"list":return this.get("type")===l.DISTLIST;case"unknown":return this.get("type")===l.UNKNOWN;case"special-contact":return this.is("contact")&&this.get("internal_userid")&&"email1"===this.get("field");case"special-user":return this.is("user")&&this.get("contact_id")&&this.has("field")&&"email1"!==this.get("field")}},getContactID:function(){return this.is("user")&&this.get("contact_id")?this.get("contact_id"):this.get("id")},getDisplayName:function(t){return((t=t||{}).isMail?a.getMailFullName(this.toJSON(),t.asHtml):a.getFullName(this.toJSON(),t.asHtml))||(""!==this.getEmail()?this.getEmail():"")},getEmail:function(){return a.getMail(this.toJSON())},getTarget:function(t){return(t=_.extend({fallback:!1,strict:!1},t)).fallback&&this.is("list")?"distribution_list":!t.strict||0===this.get("mail_field")&&this.get("mail")?this.get(this.get("field"))||this.getEmail():this.get(this.get("field"))},getFieldString:function(){return this.has("field")?n.fields[this.get("field")]:""},getFieldNumber:function(){return _.isNumber(this.get("mail_field"))?this.get("mail_field"):this.get("field")?parseInt(this.get("field").slice(-1),10):0},getAPIData:function(){var t={type:this.get("type")};if(this.get("field")&&(t.field=this.get("field")),5===this.get("type")){t.mail=this.getTarget();var i=this.getDisplayName(this.toJSON());_.isEmpty(i)||(t.display_name=i)}else this.has("id")&&(t.id=this.get("id"));return t},fetch:function(){var n=this,a=function(t){n.set(t)};switch(this.get("type")){case l.USER:if(this.get("display_name")&&"image1_url"in this.attributes)break;return t.get({id:this.get("id")}).then(a);case l.USER_GROUP:if(this.get("display_name")&&this.get("members"))break;return i.get({id:this.get("id")}).then(a);case l.RESOURCE:if(this.get("display_name"))break;return e.get({id:this.get("id")}).then(a);case l.RESOURCE_GROUP:this.set("display_name","resource group");break;case l.EXTERNAL_USER:if(this.get("display_name")&&"image1_url"in this.attributes)break;return this.get("id")&&this.get("folder_id")?s.get(this.pick("id","folder_id")).then(a):s.getByEmailaddress(this.getEmail()).then(function(t){n.get("display_name")&&(t=_(t).omit("first_name","last_name","display_name")),n.has("mail")&&n.get("mail")!==t[n.get("field")]&&_.each(["email1","email2","email3"],function(i){t[i]===n.get("mail")&&(t.field=i)}),n.set(t)});case l.DISTLIST:if(this.get("display_name")&&"distribution_list"in this.attributes)break;return s.get(this.pick("id","folder_id")).then(a)}return $.when()}});return{Participant:c,Participants:Backbone.Collection.extend({model:c,getAPIData:function(){return this.map(function(t){return t.getAPIData()})},initialize:function(t,i){var e=this;this.options=i||{},this.on("change",function(){var t={},i=[];e.each(function(e){e.id&&(t[e.id]?i.push(e):t[e.id]=!0)}),e.remove(i)}),this.oldAdd=this.add,this.add=this.addUniquely,this.processing=[]},resolve:function(){return $.when.apply($,this.processing)},addUniquely:function(t,i){var e,s=this;e=_.map([].concat(t),function(t){if(s.options.splitGroups&&2===h(t,"type"))return r(t).then(s.addUniquely.bind(s));t=h(t,"mark_as_distributionlist")?h(t,"distribution_list"):t;var e=[],n=[],l=[];return _.each([].concat(t),function(t){var i=t instanceof s.model?t:new s.model(t);!s.options.needsMail||void 0===i.get("mail_field")||i.get("mail")?(e.push(i),n.push(i.loading)):l.push(i)}),a.validateDistributionList(l),$.when.apply($,n).then(function(){return e=_(e).sortBy(function(t){return t.get("last_name")}),_(e).each(function(t){s.oldAdd(t,i)}),e})}),this.processing=this.processing.concat(_.flatten(e))}})}});