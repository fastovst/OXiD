define("io.ox/mail/actions",["io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/mail/api","io.ox/mail/util","io.ox/files/api","io.ox/core/folder/api","io.ox/core/print","io.ox/core/api/account","io.ox/core/notifications","io.ox/core/viewer/views/types/typesutil","settings!io.ox/mail","gettext!io.ox/mail"],function(i,e,o,t,n,a,l,c,r,s,m,d){"use strict";function p(i){if(!(i.selection.length>1)&&(!i.collection.has("multiple")||i.isThread)){var e=i.first();return t.hasFrom(e)&&!f(e)}}function f(i){return u(i.folder_id)||(4&i.flags)>0}function u(i){return _.contains(c.getFoldersByType("drafts"),i)}function x(i){return function(e){var o=e.first();require(["io.ox/mail/compose/checks"],function(e){e.replyToMailingList(_.cid(o),i,o).then(function(i){ox.registry.call("mail-compose","open",{type:i,original:{folderId:o.folder_id,id:o.id,security:o.security}})})})}}function v(i,e){return!1!==i&&(!!c.isPrimary(e.folder_id)&&(!c.isUnifiedFolder(e.folder_id)&&!c.is("archive",e.folder_id)))}function y(i,e,o){return function(t){require(["io.ox/mail/actions/copyMove"],function(n){n.multiple({list:t.array(),baton:t,type:i,label:e,success:o})})}}function h(i,e){return!1!==i&&(!!c.isPrimary(e.folder_id)&&(!c.is("spam|confirmed_spam|sent|drafts",e.folder_id)&&!t.isSpam(e)))}function g(i,e){return!1!==i&&(!!c.isPrimary(e.folder_id)&&(!(c.getFoldersByType("spam").concat(c.getFoldersByType("confirmed_spam")).indexOf(e.folder_id)<0)&&(c.is("spam|confirmed_spam",e.folder_id)||t.isSpam(e))))}var w=e.Action;new w("io.ox/mail/actions/compose",{device:"!guest",action:function(i){ox.registry.call("mail-compose","open",null,{folderId:i.app.folder.get()})}}),new w("io.ox/mail/actions/reply-all",{collection:"some && toplevel",matches:p,action:x("replyall")}),new w("io.ox/mail/actions/reply",{collection:"some && toplevel",matches:p,action:x("reply")}),new w("io.ox/mail/actions/forward",{device:"!guest",collection:"some && toplevel",action:function(i){var e=i.selection&&i.selection.length>1?i.selection.map(function(i){return _.cid(_.cid(i).replace(/^thread./,""))}):[i.first()];e=e.map(function(i){return{id:i.id,folderId:i.folder_id,security:i.security}}),ox.registry.call("mail-compose","open",{type:"forward",original:e})}}),new w("io.ox/mail/actions/delete",{collection:"toplevel && some && delete",action:"io.ox/mail/actions/delete"}),new w("io.ox/mail/actions/edit",{collection:"one && toplevel",matches:function(i){var e=i.first();return!(e&&e.security_info&&e.security_info.encrypted)&&(e&&f(e))},action:function(i){var e=i.first(),o=_(ox.ui.apps.models).find(function(i){return i.refId===e.id});if(o)return o.launch();ox.registry.call("mail-compose","open",{type:"edit",original:{folderId:e.folder_id,id:e.id,security:e.security}})}}),new w("io.ox/mail/actions/edit-copy",{collection:"one && toplevel",matches:function(i){var e=i.first();if(!(e&&e.security_info&&e.security_info.encrypted))return e&&f(e)},action:function(i){var e=i.first();ox.registry.call("mail-compose","open",{type:"copy",original:{folderId:e.folder_id,id:e.id}}).done(function(i){var e=i.app.model;e.set("subject",d("[Copy] %1$s",e.get("subject")))})}}),new w("io.ox/mail/actions/source",{collection:"some && toplevel",matches:function(i){if(!(i.selection&&i.selection.length>1))return!(i.collection.has("multiple")&&!i.isThread)},action:"io.ox/mail/actions/source"}),new w("io.ox/mail/actions/filter",{capabilities:"mailfilter_v2",collection:"some && toplevel",matches:function(i){return!(i.collection.has("multiple")&&!i.isThread)},action:function(e){require(["io.ox/mail/mailfilter/settings/filter"],function(o){o.initialize().then(function(o,t,n){var a={data:{obj:n.model.protectedMethods.buildFactory("io.ox/core/mailfilter/model",n.api).create(n.model.protectedMethods.provideEmptyModel())}},l={id:"allof",tests:[_.copy(n.filterDefaults.tests.subject),n.filterDefaults.tests.address?_.copy(n.filterDefaults.tests.address):_.copy(n.filterDefaults.tests.from)]};l.tests[0].values=[e.data.subject],l.tests[1].values=[e.data.from[0][1]],a.data.obj.set("test",l),i.point("io.ox/settings/mailfilter/filter/settings/detail").invoke("draw",void 0,a,t)})})}}),new w("io.ox/mail/actions/print",{device:"!smartphone",collection:"some && (read || !toplevel)",action:function(i){l.request("io.ox/mail/print",i.array())}}),new w("io.ox/mail/actions/flag",{toggle:m.get("features/flag/star"),collection:"some",matches:function(i){return!_(i.array()).every(t.isFlagged)},action:function(i){o.flag(i.data,!0)}}),new w("io.ox/mail/actions/unflag",{toggle:m.get("features/flag/star"),collection:"some",matches:function(i){return _(i.array()).any(t.isFlagged)},action:function(i){o.flag(i.data,!1)}}),new w("io.ox/mail/actions/archive",{capabilities:"archive_emails",collection:"some && delete",matches:function(i){return i.array().reduce(v,!0)},action:function(i){var e=_.isArray(i.data)?i.data:[i.data];o.archive(e)}}),new w("io.ox/mail/actions/triggerFlags",{collection:"some",action:function(i){console.log(i.e);var e=$(".dropdown.flag-picker").data();$(document).trigger("click.bs.dropdown.data-api"),_.delay(function(){e.view.open()},200)}}),new w("io.ox/mail/actions/move",{collection:"toplevel && some && delete",action:y("move",d("Move"),{single:d("Email has been moved"),multiple:d("Emails have been moved")})}),new w("io.ox/mail/actions/copy",{collection:"toplevel && some",action:y("copy",d("Copy"),{single:d("Email has been copied"),multiple:d("Emails have been copied")})}),new w("io.ox/mail/actions/mark-unread",{collection:"toplevel && change:seen",matches:function(i){return i.array().reduce(function(i,e){return i||!t.isUnseen(e)},!1)},action:function(i){var e=a.ignoreSentItems(i.array());o.markUnread(e)}}),new w("io.ox/mail/actions/mark-read",{collection:"toplevel && change:seen",matches:function(i){return i.array().reduce(function(i,e){return i||t.isUnseen(e)},!1)},action:function(i){var e=a.ignoreSentItems(i.array());o.markRead(e)}}),new w("io.ox/mail/actions/spam",{capabilities:"spam",collection:"some && delete && toplevel",matches:function(i){return i.array().reduce(h,!0)},action:function(i){o.markSpam(i.array()).done(function(i){var e=_(i).chain().pluck("error").compact().first().value();e&&r.yell(e)}).fail(function(i){r.yell(i),o.trigger("refresh.all")})}}),new w("io.ox/mail/actions/nospam",{capabilities:"spam",collection:"some && delete && toplevel",matches:function(i){return i.array().reduce(g,!0)},action:function(i){o.noSpam(i.array()).done(function(i){var e=_(i).chain().pluck("error").compact().first().value();e&&r.yell(e)})}}),new w("io.ox/mail/actions/save",{device:"!ios",collection:"some && read",action:function(i){require(["io.ox/mail/actions/save"],function(e){e.multiple(i.array())})}}),new w("io.ox/mail/actions/add-to-portal",{capabilities:"portal",collection:"one && toplevel",action:function(i){require(["io.ox/mail/actions/addToPortal"],function(e){e(i)})}}),new w("io.ox/mail/actions/sendmail",{collection:"some",action:function(i){require(["io.ox/core/api/user"],function(e){c.getAllSenderAddresses().done(function(o){e.getCurrentUser().done(function(e){var t=i.data,n=t.to.concat(t.cc).concat(t.bcc).concat(t.from),a=_.compact([e.get("email1"),e.get("email2"),e.get("email3")]);a=a.concat(_(o).pluck(1));var l=_(n).filter(function(i){return a.indexOf(i[1])<0});0===l.length&&(l=n),l=_(l).uniq(!1,function(i){return i[1]}),ox.registry.call("mail-compose","open",{to:l})})})})}}),new w("io.ox/mail/actions/createdistlist",{capabilities:"contacts",collection:"some",action:function(i){require(["io.ox/mail/actions/create"],function(e){e.createDistributionList(i)})}}),new w("io.ox/mail/actions/invite",{capabilities:"calendar",collection:"some",action:function(i){require(["io.ox/mail/actions/create"],function(e){e.createAppointment(i)})}}),new w("io.ox/mail/actions/reminder",{capabilities:"tasks",collection:"one && toplevel",action:function(i){require(["io.ox/mail/actions/reminder"],function(e){e(i)})}}),new w("io.ox/mail/attachment/actions/view",{collection:"some",matches:function(i){return i.array().some(function(i){var e=new n.Model(i);return s.canView(e)})},action:function(i){var e=i.list||i.array(),o=i.array()[0];ox.load(["io.ox/mail/actions/viewer"]).done(function(t){t({files:e,selection:o,restoreFocus:i.restoreFocus,openedBy:i.openedBy})})}}),new w("io.ox/mail/attachment/actions/download",{device:"!ios || ios >= 11",collection:"some",action:function(i){var e=i.array(),t=1===e.length?o.getUrl(_(e).first(),"download"):o.getUrl(e,"zip");require(["io.ox/core/download"],function(i){i[_.device("ios")?"window":"url"](t)})}}),new w("io.ox/mail/attachment/actions/save",{capabilities:"infostore",collection:"some",action:function(i){require(["io.ox/mail/actions/attachmentSave"],function(e){e.multiple(i.array())})}}),new w("io.ox/mail/attachment/actions/vcard",{capabilities:"contacts",collection:"one",matches:function(i){var e=i.first(),o=/\.vcf$/i.test(e.filename),t=/^text\/(x-)?vcard/i.test(e.content_type),n=/^text\/directory/i.test(e.content_type);return o&&n||t},action:function(i){require(["io.ox/mail/actions/vcard"],function(e){e(i)})}}),new w("io.ox/mail/attachment/actions/ical",{capabilities:"calendar",collection:"some",matches:function(i){var e=i.first(),t=e.filename&&!!e.filename.match(/\.ics$/i),n=e.content_type&&!!e.content_type.match(/^text\/calendar/i),a=e.content_type&&!!e.content_type.match(/^application\/ics/i);return!o.pool.get("detail").get(_.cid(e.mail)).get("imipMail")&&(t||n||a)},action:function(i){require(["io.ox/mail/actions/ical"],function(e){e(i)})}});var b=[{id:"reply",prio:"hi",mobile:"lo",title:d("Reply"),ref:"io.ox/mail/actions/reply",section:"standard"},{id:"reply-all",prio:"hi",mobile:"hi",title:d("Reply all"),ref:"io.ox/mail/actions/reply-all",section:"standard"},{id:"forward",prio:"hi",mobile:"hi",title:d("Forward"),ref:"io.ox/mail/actions/forward",section:"standard"},{id:"edit",prio:"hi",mobile:"lo",title:d("Edit"),ref:"io.ox/mail/actions/edit",section:"standard"},{id:"delete",prio:"hi",mobile:"lo",title:d("Delete"),ref:"io.ox/mail/actions/delete",section:"standard"},{id:"spam",prio:"lo",mobile:"lo",title:d("Mark as spam"),ref:"io.ox/mail/actions/spam",section:"flags"},{id:"nospam",prio:"lo",mobile:"lo",title:d("Not spam"),ref:"io.ox/mail/actions/nospam",section:"flags"},{id:"sendmail",prio:"lo",title:d("Send new email"),ref:"io.ox/mail/actions/sendmail",section:"recipients"},{id:"invite-to-appointment",prio:"lo",title:d("Invite to appointment"),ref:"io.ox/mail/actions/invite",section:"recipients"},{id:"save-as-distlist",prio:"lo",title:d("Save as distribution list"),ref:"io.ox/mail/actions/createdistlist",section:"recipients"},{id:"move",prio:"lo",title:d("Move"),ref:"io.ox/mail/actions/move",section:"file-op"},{id:"copy",prio:"lo",title:d("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"},{id:"archive",prio:"lo",title:d.pgettext("verb","Archive"),ref:"io.ox/mail/actions/archive",section:"file-op"},{id:"print",prio:"lo",mobile:"none",title:d("Print"),ref:"io.ox/mail/actions/print",section:"export"},{id:"save-as-eml",prio:"lo",mobile:"none",title:d("Save as file"),ref:"io.ox/mail/actions/save",section:"export"},{id:"source",prio:"lo",mobile:"lo",title:d("View source"),ref:"io.ox/mail/actions/source",section:"export"},{id:"filter",prio:"lo",mobile:"none",title:d("Create filter rule"),ref:"io.ox/mail/actions/filter",section:"file-op"},{id:"reminder",prio:"lo",mobile:"none",title:d("Reminder"),ref:"io.ox/mail/actions/reminder",section:"keep"},{id:"add-to-portal",prio:"lo",mobile:"none",title:d("Add to portal"),ref:"io.ox/mail/actions/add-to-portal",section:"keep"}];i.point("io.ox/mail/links/inline").extend(b.map(function(i,e){return i.index=100+100*e,i.mobile=i.mobile||i.prio||"none",i})),new w("io.ox/mail/actions/label",{id:"label",collection:"toplevel some",action:$.noop}),i.point("io.ox/mail/attachment/links").extend({id:"vcard",mobile:"hi",index:50,title:d("Add to address book"),ref:"io.ox/mail/attachment/actions/vcard"},{id:"ical",mobile:"hi",index:50,title:d("Add to calendar"),ref:"io.ox/mail/attachment/actions/ical"},{id:"view_new",index:100,mobile:"hi",title:d("View"),ref:"io.ox/mail/attachment/actions/view"},{id:"download",index:400,mobile:"hi",title:d("Download"),ref:"io.ox/mail/attachment/actions/download"},{id:"save",index:500,mobile:"hi",title:d("Save to %1$s",d.pgettext("app","Drive")),ref:"io.ox/mail/attachment/actions/save"},{id:"viewer",index:600,mobile:"hi",label:d("View"),ref:"io.ox/mail/actions/viewer"}),i.point("io.ox/mail/dnd/actions").extend({id:"importEML",index:10,label:d("Drop here to import this email"),action:function(i,e){e.queues.importEML.offer(i,{folder:e.folder.get()})}}),i.point("io.ox/mail/folderview/premium-area").extend({index:100,id:"inline-premium-links",draw:function(i){this.append(i.renderActions("io.ox/mail/links/premium-links",i))}})});