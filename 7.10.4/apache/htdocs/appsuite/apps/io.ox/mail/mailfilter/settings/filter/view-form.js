define("io.ox/mail/mailfilter/settings/filter/view-form",["gettext!io.ox/settings","io.ox/core/extensions","io.ox/backbone/mini-views","io.ox/backbone/mini-views/dropdown","io.ox/mail/mailfilter/settings/filter/tests/util","settings!io.ox/core"],function(t,e,i,s,o,n){"use strict";var a,d="io.ox/mailfilter/settings/filter/detail",l=null,r=function(t){return $(t).find("[data-test-id]")},c=function(t,e,i){var s=i?$(t).find('[data-test-id="'+i+'"]'):$(t);"condition"===e&&s.find((i?"":".main")+".add-condition > a").focus(),"action"===e&&$(t).find(".add-action > a").focus(),"appliesto"===e&&s.find((i?"":".main")+".appliesto > a").focus()},u=function(e){var i=$('<div class="alert alert-info">').text(t("This rule applies to all messages. Please add a condition to restrict this rule to specific messages."));e.append(i)},f=function(e){var i=$("<div>").addClass("alert alert-danger").text(t("Please define at least one action."));e.append(i)},p=function(t,e){var i={};return _.each(e,function(e,s){-1!==_.indexOf(a[t],s)&&(i[s]=e)}),i},g=function(t,e,i){var o=e[t]||t;i.caret&&(o+='<b class="caret">');var n=$('<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="menuitem" aria-haspopup="true" tabindex="0">').html(o),a=$('<ul class="dropdown-menu" role="menu">').append(i.sort?_(i.sort).map(function(t){if(t!==i.skip)return $("<li>").append($('<a href="#" data-action="change-dropdown-value" role="menuitemradio">').attr("data-value",t).data(i).append($.txt(e[t])))}):_(e).map(function(t,e){if(e!==i.skip)return $("<li>").append($('<a href="#" data-action="change-dropdown-value">').attr("data-value",e).data(i).append($.txt(t)))}));return new s({className:"action dropdown value "+(i.classes?i.classes:""),$toggle:n,$ul:a}).render().$el},h=Backbone.View.extend({tagName:"div",className:"io-ox-mailfilter-edit",initialize:function(t){this.conditionsTranslation=t.conditionsTranslation,this.actionsTranslations=t.actionsTranslations,this.defaults=t.defaults,this.config=t.config,a={},_.each(t.config.tests,function(t){a[t.id]=t.comparisons}),this.listView=t.listView},render:function(){var t=e.Baton({model:this.model,view:this});return e.point(d+"/view").invoke("draw",this.$el.empty(),t),t.view.$el.trigger("toggle:saveButton"),this},events:{save:"onSave",apply:"onApply","click [data-action=change-dropdown-value]":"onChangeDropdownValue",'click [data-action="change-color"]':"onChangeColor",'click [data-action="remove-test"]':"onRemoveTest",'click [data-action="remove-action"]':"onRemoveAction","toggle:saveButton":"onToggleSaveButton"},onToggleSaveButton:function(){0===this.$el.find(".has-error, .alert-danger").length?(this.dialog.$el.find('.modal-footer [data-action="save"]').prop("disabled",!1),this.dialog.$el.find('.modal-footer [data-action="apply"]').prop("disabled",!1)):(this.dialog.$el.find('.modal-footer [data-action="save"]').prop("disabled",!0),this.dialog.$el.find('.modal-footer [data-action="apply"]').prop("disabled",!0))},removeTest:function(t,e){if(2===e.split("_").length){var i=e.split("_")[0],s=e.split("_")[1];t.tests[i].tests.splice(s,1),0===t.tests[i].tests.length&&t.tests.splice(i,1),1===t.tests.length&&(t=t.tests[0])}else t.tests&&t.tests.length>2?t.tests=_(t.tests).without(t.tests[e]):t.tests?(t.tests=_(t.tests).without(t.tests[e]),t=t.tests[0]):t={id:"true"};return t},onRemoveTest:function(t){t.preventDefault();var e=$(t.target).closest("li").attr("data-test-id"),i=_.copy(this.model.get("test"));this.model.set("test",this.removeTest(i,e)),this.render()},removeAction:function(t,e){return t.splice(e,1),t},onRemoveAction:function(t){t.preventDefault();var e=$(t.target).closest("li").attr("data-action-id"),i=_.copy(this.model.get("actioncmds"));this.model.set("actioncmds",this.removeAction(i,e)),this.render()},onSave:function(){function t(t){var e;return _.each(t,function(t,i){_.isEqual(t,{id:"stop"})&&(e=i)}),e}function e(t){return moment.tz(t,n.get("timezone")).format("Z").replace(":","")}var i=this,s=this.model.get("test"),o=this.model.get("actioncmds"),a=["exists","not exists"];return function(t,e){var i=!0;return _.has(t,"values")&&t.values&&""===t.values[0]&&!_.contains(a,t.comparison)&&(i=!1),_.has(t,"tests")&&_.each(t.tests,function(t){t.values&&""===t.values[0]&&!_.contains(a,t.comparison)&&(i=!1),t.tests&&_.each(t.tests,function(t){t.values&&""===t.values[0]&&!_.contains(a,t.comparison)&&(i=!1)})}),_.each(e,function(t){""!==t.to&&""!==t.text||(i=!1),t.flags&&"$"===t.flags[0]&&(i=!1)}),i}(s,o)?(null!==l&&i.model.trigger("ChangeProcessSub",l),l=null,s.tests&&0===s.tests.length?this.model.set("test",{id:"true"}):("header"!==s.id||""!==s.values[0].trim()||_.contains(a,s.comparison)||this.model.set("test",{id:"true"}),"size"===s.id&&(""===s.size.toString().trim()?this.model.set("test",{id:"true"}):(delete s.sizeValue,delete s.unit)),"original"===s.zone&&"currentdate"===s.id&&(this.model.attributes.test.zone=e(s.datevalue[0]))),this.model.attributes.test.tests&&_.each(this.model.attributes.test.tests,function(t,s){"original"===t.zone&&"currentdate"===t.id&&(i.model.attributes.test.tests[s].zone=e(t.datevalue[0])),t.tests&&!_.isEmpty(t.tests)&&_.each(t.tests,function(t,o){"original"===t.zone&&"currentdate"===t.id&&(i.model.attributes.test.tests[s].tests[o].zone=e(t.datevalue[0]))}),"size"===t.id&&(delete t.sizeValue,delete t.unit)}),void 0!==t(o)&&(o.splice(t(o),1),o.push({id:"stop"}),this.model.set("actioncmds",o)),this.model.save().then(function(t){_.isUndefined(t)||_.isNull(t)||_.isUndefined(i.listView)?_.isUndefined(t)||_.isNull(t)||_.isUndefined(i.collection)||(i.model.set("id",t),i.collection.add(i.model)):(i.model.set("id",t),i.listView.collection.add(i.model)),i.dialog.close()},i.dialog.idle)):(i.dialog.idle(),void i.render())},onApply:function(){var t=this.model;return this.onSave().then(function(){t.trigger("apply")})},onChangeDropdownValue:function(t){function e(){l.render(),setTimeout(function(){c(l.el,d,o)},100)}t.preventDefault();var i,s,o,n=$(t.target),a=n.data(),d=a.type,l=this;if("id"===a.target)return s=_.copy(this.model.get("test")),s.id=a.value,this.model.set("test",s),void e();if("nestedID"===a.target)return s=this.model.get("test"),o=n.closest("li").attr("data-test-id"),s.tests[o].id=a.value,this.model.set("test",s),void e();if(a.nested&&"condition"===a.type)return i=this.model.get("test"),o=n.closest("li").attr("data-test-id"),i.tests[o].tests.push(_.copy(this.defaults.tests[a.value],!0)),this.model.set("test",i),void e();if("condition"===a.type){if(i=_.copy(this.model.get("test")),r(this.el).length>1)i.tests.push(_.copy(this.defaults.tests[a.value],!0));else if(1===r(this.el).length){var u=[i];u.push(_.copy(this.defaults.tests[a.value],!0)),(i={id:"allof"}).tests=u}else i=_.copy(this.defaults.tests[a.value],!0);return this.model.set("test",i),void e()}if("action"===a.type){var f=this.model.get("actioncmds");f.push(_.copy(this.defaults.actions[a.value],!0)),this.model.set("actioncmds",f),e()}},setModel:function(t,e,i){if("test"===t){var s=_.copy(this.model.get(t));r(this.el).length>1?s.tests[i]=e.attributes:s=e.attributes,this.model.set(t,s)}else{var o=_.copy(this.model.get(t));o[i]=e.attributes,this.model.set(t,o)}},setNestedModel:function(t,e){var i=e.split("_")[0],s=e.split("_")[1],o=this.model.get("test"),n=o.tests[i];n.tests[s]=t.attributes,o.tests[i]=n,this.model.set("test",o)},onChangeColor:function(t){t.preventDefault();var e=$(t.currentTarget).closest("li[data-action-id]"),i=e.attr("data-action-id"),s=e.find("div.flag").attr("data-color-value"),o=_.copy(this.model.get("actioncmds"));o[i].flags[0]="$cl_"+s,this.model.set("actioncmds",o),this.render(),this.$el.find('[data-action-id="'+i+'"] .dropdown-toggle').focus()}});return e.point(d+"/view").extend({index:150,id:"tests",draw:function(i){var s=$('<ol class="widget-list list-unstyled tests">'),n=$('<ol class="widget-list list-unstyled actions">'),a=i.model.get("test"),d=Backbone.Model.extend({validate:function(t){var e=["exists","not exists"];if(_.has(t,"size")){if(!o.validateSize({unit:t.unit,size:t.sizeValue}))return this.trigger("invalid:sizeValue"),"sizeValue";this.trigger("valid:size")}if(_.has(t,"headers")){if(""===$.trim(t.headers[0])&&!_.contains(e,t.comparison))return t.values&&""===$.trim(t.values[0])&&!_.contains(e,t.comparison)?"headers values":(this.trigger("invalid:headers"),"headers");if(""===$.trim(t.headers[0])&&_.contains(e,t.comparison)&&"header"===t.id)return"headers";this.trigger("valid:headers")}if(_.has(t,"source")){if(""===$.trim(t.source[0])&&!_.contains(e,t.comparison))return t.values&&""===$.trim(t.values[0])&&!_.contains(e,t.comparison)?"source values":(this.trigger("invalid:source"),"headers");if(""===$.trim(t.source[0])&&_.contains(e,t.comparison)&&"source"===t.id)return"source";this.trigger("valid:source")}if(_.has(t,"values")){if(t.values&&""===$.trim(t.values[0])&&!_.contains(e,t.comparison))return this.trigger("invalid:values"),"values";this.trigger("valid:values")}if(_.has(t,"tests")&&_.isEmpty(t.tests))return this.trigger("invalid:tests"),"tests"}}),l=0;a=a.tests?a.tests:[a],_(a).each(function(t,o){var n=function(){if(t.tests)return!0},a=n()?"nested":"";if(n()){var l=t.tests;e.point("io.ox/mail/mailfilter/tests").get("nested",function(t){t.invoke("draw",s,i,o,r)}),_(l).each(function(t,n){var l=new d(t),r=o+"_"+n;l.on("change",function(){i.view.setNestedModel(l,r)}),e.point("io.ox/mail/mailfilter/tests").get(l.get("id"),function(e){e.invoke("draw",s,i,r,l,p,t,a)}),l.isValid()||s.find("[data-test-id="+r+"] input").closest(".row").addClass("has-error")})}var r=new d(t);r.on("change",function(){i.view.setModel("test",r,o)}),e.point("io.ox/mail/mailfilter/tests").get(r.get("id"),function(e){e.invoke("draw",s,i,o,r,p,t,a)}),r.isValid()||_.each(r.validationError.split(" "),function(t){s.find("[data-test-id="+o+'] input[name="'+t+'"]').closest(".row").addClass("has-error"),"tests"===t&&s.find("[data-test-id="+o+"]").addClass("has-error")})}),_(i.model.get("actioncmds")).each(function(t,s){var o=new(Backbone.Model.extend({validate:function(t){if(_.has(t,"to")){if(""===$.trim(t.to))return this.trigger("invalid:to"),"error";this.trigger("valid:to")}if(_.has(t,"text")){if(""===$.trim(t.text))return this.trigger("invalid:text"),"error";this.trigger("valid:text")}if(_.has(t,"flags")){if("$"===$.trim(t.flags[0]))return this.trigger("invalid:flags"),"error";this.trigger("valid:flags")}}}))(t);o.on("change",function(){i.view.setModel("actioncmds",o,s)}),"stop"!==t.id&&(e.point("io.ox/mail/mailfilter/actions").get(o.get("id"),function(e){"redirect"===e.id&&(l+=1),e.invoke("draw",n,i,s,o,p,t)}),o.isValid()||n.find("[data-action-id="+s+"] .row").addClass("has-error"))});var r=$("<legend>").addClass("sectiontitle conditions").text(t("Conditions")),c=$("<legend>").addClass("sectiontitle actions").text(t("Actions")),h=$('<div class="notification-for-conditions">'),m=$('<div class="notification-for-actions">');_.isEqual(a[0],{id:"true"})&&u(h),_.isEmpty(i.model.get("actioncmds"))&&f(m),this.append(r,h,s,g(t("Add condition"),i.view.conditionsTranslation,{type:"condition",toggle:"dropdown",skip:"true"===i.model.get("test").id?"nested":"",sort:i.view.defaults.conditionsOrder,classes:"add-condition main"}),c,m,n,g(t("Add action"),i.view.actionsTranslations,{type:"action",toggle:"dropup",skip:l>=i.view.config.options.MAXREDIRECTS?"redirect":"",sort:i.view.defaults.actionsOrder,classes:"add-action"}))}}),e.point(d+"/view").extend({id:"rulename",index:100,draw:function(e){this.append($('<label for="rulename">').text(t("Rule name")),new i.InputView({name:"rulename",model:e.model,className:"form-control",id:"rulename"}).render().$el)}}),e.point(d+"/view").extend({index:100,id:"appliesto",draw:function(e){var i=e.model.get("test"),s={target:"id",toggle:"dropup",classes:"no-positioning appliesto main",caret:!0,type:"appliesto"},o=g(i.id,{allof:t("Apply rule if all conditions are met"),anyof:t("Apply rule if any condition is met")},s);"allof"===i.id||"anyof"===i.id?this.append($("<div>").addClass("line").append(o)):this.append($("<div>").addClass("line").text(t("Apply rule if all conditions are met")))}}),e.point(d+"/view").extend({index:200,id:"stopaction",draw:function(e){function i(t){var i;return void 0===e.model.id||(_.each(t,function(t){"stop"===t.id&&(i=!1)}),void 0===i||i)}var s=this,o=function(){e.model.get("actioncmds").length>=1?s.find(".alert.alert-danger").remove():(s.find(".alert.alert-danger").remove(),f(s.find(".notification-for-actions"))),e.view.$el.trigger("toggle:saveButton")},n=function(t){l=$(t.currentTarget).find('[type="checkbox"]').prop("checked");var i=e.model.get("actioncmds");!0===l?i.splice(function(t){var e;return _.each(t,function(t,i){"stop"===t.id&&(e=i)}),e}(i),1):i.push({id:"stop"}),e.model.set("actioncmds",i),o()},a=function(e){var i=_.uniqueId("form-control-label-");return $('<div class="control-group mailfilter checkbox custom">').append($('<div class="controls">'),$("<label>").attr("for",i).text(t("Process subsequent rules")).prepend($('<input type="checkbox" class="sr-only">').attr("id",i).prop("checked",e),$('<i class="toggle" aria-hidden="true">')))},d=e.view.dialog.$el.find(".modal-footer"),r=e.model.get("actioncmds");o(),d.find('[type="checkbox"]').length||_.defer(function(){d.prepend(a(i(r)).on("change",n)),e.view.$el.trigger("toggle:saveButton")})}}),h});