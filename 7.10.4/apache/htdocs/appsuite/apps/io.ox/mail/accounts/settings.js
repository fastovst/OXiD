define("io.ox/mail/accounts/settings",["io.ox/core/extensions","io.ox/core/api/account","io.ox/mail/accounts/model","io.ox/mail/accounts/view-form","io.ox/backbone/views/modal","io.ox/core/notifications","io.ox/core/a11y","settings!io.ox/mail","gettext!io.ox/mail/accounts/settings","less!io.ox/settings/style"],function(e,o,n,i,a,t,d,r,c){"use strict";function s(e,o,d){var r,s,l,p=!0;return l=$("<div>").addClass("accountDetail"),s=new n(o),(r=new i({model:s,node:l})).listenTo(s,"sync",function(e){d.set(e.attributes)}),r.dialog=new a({width:700,maximize:500,async:!0,point:"io.ox/settings/accounts/mail/settings/detail/dialog",title:c(s.get("id")||0===s.get("id")?"Edit mail account":"Add mail account"),view:r}),r.dialog.extend({text:function(){this.$body.append(this.options.view.render().el)}}).addCancelButton().addButton({action:"save",label:c("Save")}).open(),s.on("validated",function(e,o,n){var i=r.$el;i.find(".error").removeClass("error"),i.find(".help-block").prev().removeAttr("aria-invalid aria-describedby"),i.find(".help-block").remove(),p||_.each(n,function(e,o){var n=r.$el.find("#"+o).parent(),i=n.closest(".form-group"),a=$('<div class="help-block error">').attr("id",_.uniqueId("error-help-"));a.append($.txt(e)),n.append(a),a.prev().attr({"aria-invalid":!0,"aria-describedby":a.attr("id")}),i.addClass("error")})}),s.on("change",function(e){e.validate()}),r.dialog.on("save",function(){p=!1,s.validate(),s.isValid()?r.dialog.$body.find(".settings-detail-pane").trigger("save"):(t.yell("error",c("Account settings could not be saved. Please take a look at the annotations in the form. ")),r.dialog.idle(),0===s.get("id")&&r.$el.find("input, select").not('#personal, #name, [data-property="unified_inbox_enabled"]').prop("disabled",!0))}),r.success=g,r.collection=u,r.node}function l(e){if(r.get("features/accounts/configureUnifiedInboxOnCreate",!1))return e=_.defaults({unified_inbox_enabled:!1},e),$('<div class="form-group checkbox">').append($('<label for="unified_inbox_enabled">').append($('<input type="checkbox" name="unified_inbox_enabled">').prop("checked",e.unified_inbox_enabled),c("Use unified mail for this account")))}e.point("io.ox/settings/accounts/mail/settings/detail").extend({index:200,id:"emailaccountssettings",draw:function(e){e.data.id>=0?o.get(e.data.id).done(function(o){s(0,o,e.data.model)}):s(0,e.data,e.data.model)}}),e.point("io.ox/mail/add-account/preselect").extend({id:"oauth",index:100,draw:function(n){var i=this;i.empty().addClass("mail-account-dialog"),require(["io.ox/oauth/keychain","io.ox/oauth/backbone"]).then(function(a,r){var s=new Backbone.Collection(a.services.filter(function(e){return e.canAdd({scopes:["mail"]})&&a.accounts.forService(e.id,{scope:"mail"}).map(function(e){return e.id}).reduce(function(e,n){return e&&!_(o.cache).chain().values().map(function(e){return e.mail_oauth}).any(n).value()},!0)})),u=new r.Views.ServicesListView({collection:s,model:{mailService:!0}});if(0===s.length)return n.popup.$footer.find('[data-action="add"]').show(),e.point("io.ox/mail/add-account/wizard").invoke("draw",n.popup.$body.empty()),void i.closest(".modal").removeClass("compact");e.point("io.ox/mail/add-account/predefined").invoke("customize",this,s),s.push({id:"mailwizard",type:"wizard",displayName:c("Add other mail account")}),i.append($("<label>").text(c("Please choose your mail account provider.")),u.render().$el,l()),d.getTabbable(i).first().focus(),i.closest(".modal").removeClass("compact"),u.listenTo(u,"select",function(e){if("wizard"!==e.get("type")){var d=new r.Account.Model({serviceId:e.id,displayName:a.chooseDisplayName(e)});d.enableScopes("mail").save().then(function(){n.popup.busy();var e=$('<div class="alert-placeholder">');i.append(e),b(e),o.autoconfig({oauth:d.id}).then(function(e){var o=$.Deferred();return e.primary_address=e.login,e.unified_inbox_enabled=!0===i.find('input[name="unified_inbox_enabled"]').prop("checked"),x(e,n.popup,o),o}).fail(t.yell).always(function(){n.popup.idle()})})}}),u.listenTo(u,"select:wizard",function(){n.popup.$footer.find('[data-action="add"]').show();var o={};o.unified_inbox_enabled=!0===i.find('input[name="unified_inbox_enabled"]').prop("checked"),e.point("io.ox/mail/add-account/wizard").invoke("draw",n.popup.$body.empty(),o)})})}}),e.point("io.ox/mail/add-account/wizard").extend({id:"address",index:100,draw:function(){var e,o=this;this.append($('<div class="form-group">').append($('<label for="add-mail-account-address">').text(c("Your mail address")),e=$('<input id="add-mail-account-address" type="text" class="form-control add-mail-account-address" autocomplete="section-addAccount username">'))),e.on("change",function(){var e=o.find(".alert");e.length&&-1!==e.attr("errorAttributes").indexOf("address")&&e.remove()})}}),e.point("io.ox/mail/add-account/wizard").extend({id:"password",index:200,draw:function(){var e,o=this;this.append($('<div class="form-group">').append($('<label for="add-mail-account-password">').text(c("Your password")),e=$('<input id="add-mail-account-password" type="password" class="form-control add-mail-account-password" autocomplete="section-addAccount new-password">'))),e.on("change",function(){var e=o.find(".alert");e.length&&-1!==e.attr("errorAttributes").indexOf("password")&&e.remove()})}}),e.point("io.ox/mail/add-account/wizard").extend({id:"security-hint",index:300,draw:function(){"https:"===window.location.protocol&&this.append($('<div class="help-block">').text(c("Your credentials will be sent over a secure connection only")))}}),e.point("io.ox/mail/add-account/wizard").extend({id:"unified-mail",index:400,draw:function(e){this.append(l(e))}}),e.point("io.ox/mail/add-account/wizard").extend({id:"feedback",index:1e12,draw:function(){this.append($('<div class="alert-placeholder">'))}});var u,p=new n({}),f=function(o){var n=$("<div>");e.point("io.ox/settings/accounts/mail/settings/detail").invoke("draw",n,o)},m=function(e){return e.$body.find(".alert-placeholder")},v=function(e,o,n){n=n||{},e.find(".alert").remove(),e.find(".busynotice").remove(),e.append($.alert({message:o,dismissable:!0}).attr("errorAttributes",n.errorAttributes||"").one("click",".close",function(){e.empty()}))},b=function(e){e.find(".notice").remove(),e.find(".alert").remove(),e.append($("<div>").addClass("busynotice").text(c("Trying to auto-configure your mail account")).addClass("notice").append($("<div>").addClass("busy_pic")))},h=function(e,o){e.find(".notice").remove(),e.find(".alert").remove(),e.append($("<div>").addClass("alert alert-danger").text(o))},x=function(e,o,n,i){var a=o.$body.find('input[name="unified_inbox_enabled"]');a.length>0&&a.prop("checked")&&(e.unified_inbox_enabled=!0),p.validationCheck(e,{ignoreInvalidTransport:!0}).then(function(a,t){if(!0===a)p.save(e).then(function(e){e.error_id?(o.close(),k(e.error)):(o.close(),u&&u.add([e]),g(),void 0!==e.mail_oauth&&require(["io.ox/oauth/keychain"],function(o){var n=o.accounts.get(e.mail_oauth);n&&n.fetch()}),n.resolve(e))},function(e){o.close(),k(e.error),e.handled=!0,n.reject(e)});else if(i&&i.onValidationError)i.onValidationError(a,t);else{var d=t.error?t.error:c("There was no suitable server found for this mail/password combination");v(m(o),d,{errorAttributes:"address password"}),o.idle(),o.getBody().find("a.close").focus()}},function(){var e=c("Failed to connect.");v(m(o),e),o.idle()})},w=function(e,o){new a({width:400,title:c("Error")}).addCancelButton().addButton({action:"manual",label:c("Manual")}).on("manual",function(){var n={};n.primary_address=o,e&&(e.data=n,f(e))}).open().$body.text(c("Auto-configuration failed. Do you want to configure your account manually?"))},y=function(e,n,i,t,d,r){o.autoconfig({email:n,password:i,force_secure:!!r}).done(function(o){o.login?(o.primary_address=n,o.password=i,delete o.transport_login,delete o.transport_password,x(o,t,d,{onValidationError:function(){w(e,n),t.close(),d.reject()}})):r?(new a({async:!0,width:400,title:c("Warning")}).addCancelButton().addButton({action:"proceed",label:c("Ignore Warnings")}).on("proceed",function(){y(e,n,i,this,d,!1)}).on("cancel",function(){d.reject()}).open().$body.append(c("Cannot establish secure connection. Do you want to proceed anyway?")),t.close()):(w(e,n),t.close(),d.reject())}).fail(function(){w(e,n),t.close(),d.reject()})},g=function(){t.yell("success",c("Account added successfully"))},k=function(e){var o=$("<div>");require(["io.ox/backbone/views/modal"],function(n){new n({title:c("Error"),width:400,async:!0}).addButton({label:c("Close"),action:"cancel"}).build(function(){this.$body.append(o),this.$footer.find(".btn").addClass("closebutton"),h(o,e)}).open()})};return{mailAutoconfigDialog:function(o,n){var i=$.Deferred();n&&(u=n.collection);var a=e.Baton({});return require(["io.ox/backbone/views/modal"],function(n){new n({model:new Backbone.Model,title:c("Add mail account"),enter:"add",async:!0}).build(function(){a.popup=this,e.point("io.ox/mail/add-account/preselect").invoke("draw",this.$body,a)}).addCancelButton().addButton({label:c("Add"),action:"add"}).on("add",function(){var e=this.$body.find(".alert-placeholder"),n=this.$body.find(".add-mail-account-address").val(),a=this.$body.find(".add-mail-account-password").val();if(void 0===p.isMailAddress(n))b(e),y(o,n,a,this,i,!0);else{var t=c("This is not a valid mail address");v(e,t,{errorAttributes:"address"}),this.$body.find(".add-mail-account-password").focus(),this.idle()}}).on("open",function(){this.$footer.find('[data-action="add"]').hide()}).open()}),i}}});