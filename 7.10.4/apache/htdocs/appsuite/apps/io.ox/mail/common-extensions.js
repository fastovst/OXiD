define("io.ox/mail/common-extensions",["io.ox/core/extensions","io.ox/mail/util","io.ox/mail/api","io.ox/core/api/account","io.ox/core/strings","io.ox/core/folder/api","io.ox/core/folder/title","io.ox/core/notifications","io.ox/contacts/api","io.ox/contacts/util","io.ox/core/api/user","io.ox/core/api/collection-pool","io.ox/core/tk/flag-picker","io.ox/core/capabilities","io.ox/backbone/views/toolbar","settings!io.ox/mail","io.ox/core/attachments/view","io.ox/backbone/views/action-dropdown","io.ox/backbone/views/actions/util","gettext!io.ox/mail"],function(e,t,a,i,n,o,s,d,l,r,c,p,f,u,h,g,m,v,b,x){"use strict";function w(e){if(e.app&&e.app.listView&&e.app.listView.loader)return"search"===e.app.listView.loader.mode}function y(e,a,n){var o=n.data.thread?n.data.thread[0]||n.data:n.data,s=t.authenticity("image",o),d=i.is("spam",n.data.folder_id);if(s||d)return e.text("!");var r=k(n.data.from);e.text(r);var c=_.isArray(a)?a&&a[0]&&a[0][1]:a;return l.pictureHalo(e,{email:c},{width:40,height:40,effect:"fadeIn",fallback:!1})}function k(e){if(!_.isArray(e)||!e.length)return"";var a=t.getDisplayName(e[0]);return r.getInitials({display_name:a})}var S={a11yLabel:function(e){var i,n=e.data,o=a.threads.size(n),s=n.from||[["",""]],d=[];t.isUnseen(n)&&d.push(x("Unread")),t.isFlagged(n)&&d.push(x("Flagged")),e.data.color_label&&g.get("features/flag/color")&&d.push(x("Color %1$s",f.colorName(e.data.color_label))),d.push(t.getDisplayName(s[0]),n.subject,t.getTime(n.received_date)),o>1&&d.push(x.format("Thread contains %1$d messages",o)),n.attachment&&d.push(x("has attachments")),i=d.join(", ")+".",this.attr({"aria-hidden":!0}).parent().attr({"aria-label":i.replace(/["<]/g,function(e){return'"'===e?"&quot":"<"===e?"&lt;":e})})},authenticity:function(e){var a=t.authenticity("box",e&&e.model.toJSON());if(a){var i=$('<section class="authenticity">'),n=e.data.from||[],o=_.chain(n).map(function(e){return String(e[1]||"").toLowerCase()}).compact().value().join(", ");i.append($("<div>").addClass("message "+a.toLowerCase()).append($("<b>").text(/(fail|suspicious)/.test(a)?x("Warning:")+" ":x("Note:")+" "),$.txt(t.getAuthenticityMessage(a,o)))),this.append(i)}},picture:function(e){var t=e.data,n=a.threads.size(t)<=1&&!w(e)&&i.is("sent|drafts",t.folder_id)?t.to:t.from,o=$('<div class="contact-picture" aria-hidden="true">');this.append(w(e)&&t.picture?y(o,t.picture):y(o,n,e))},senderPicture:function(e){var t=e.data.from,a=$('<div class="contact-picture" aria-hidden="true">');this.append(y(a,t,e))},date:function(e,a){var i=e.data.received_date;a=_.extend({fulldate:e.app&&e.app.props.get("exactDates"),smart:!(e.app&&e.app.props.get("exactDates"))},a),_.isNumber(i)&&this.append($('<time class="date gray">').attr("datetime",moment(i).toISOString()).text(t.getDateTime(i,a)))},smartdate:function(e){S.date.call(this,e,{fulldate:!1,smart:!0})},fulldate:function(e){S.date.call(this,e,{fulldate:!0,smart:!1})},from:function(e){var a={folder:e.data.folder_id,field:"from",showDisplayName:!0};_.each(S.fromPipeline,function(t){t.call(this,e,a)}),this.append($('<div class="from">').attr("title",a.mailAddress).append($('<span class="flags">'),t.getFrom(e.data,_.pick(a,"field","reorderDisplayName","showDisplayName","unescapeDisplayName"))))},fromDetail:function(e){var a=$('<div class="from">'),n=e.data,o=n.from||[],s=o.length,d=t.authenticity("icon",n);_(o).each(function(e){var o,l=String(e[1]||"").toLowerCase(),r=t.getDisplayName(e);if(l){a.addClass(s>1||_.device("smartphone")?"no-max-height":"").append(o=$('<a href="#" role="button" class="halo-link">').data({email:l,email1:l}).append($('<span class="sr-only">').text(x("From:"))).append($('<span class="person-link person-from ellipsis">').text(r)).addClass(r===l&&d?"authenticity-sender "+d:""));var c=_.device("smartphone")&&!!r&&("pass"===d||i.is("sent",n.folder_id));r!==l&&!c&&o.append($('<span class="address">').text("<"+l+">").addClass(d?"authenticity-sender "+d:"")),d&&o.append($('<span data-toggle="popover" data-container="body" class="authenticity">').attr("aria-label",t.getAuthenticityMessage(d,l)).popover({placement:_.device("smartphone")?"auto":"right",trigger:"focus hover",content:t.getAuthenticityMessage(d,l)}).append($('<i class="fa" aria-hidden="true">').addClass(function(){return/(pass|trusted)/.test(d)?"fa-check":/(fail|suspicious)/.test(d)?"fa-exclamation-triangle":"fa-question"}).addClass(d?"authenticity-icon-"+d:""))),_.device("smartphone")&&r.indexOf("@")>-1&&a.addClass("show-address")}}),a.append('<div class="spacer">'),this.append(a)},fromPipeline:{field:function(e,t){e.data.threadSize>1||i.is("sent|drafts",t.folder)&&(t.field="to")},fieldSearch:function(e,t){if(w(e)){var a=e.app&&e.app.get("find");t.field=a&&i.is("sent|drafts",a.getFolderFacetValue())?"to":"from"}},displayName:function(e,t){if(t.reorderDisplayName=t.unescapeDisplayName="from-to"!==e.options.sort,"from-to"===e.options.sort){var a=o.pool.getModel(t.folder).get("capabilities")||0;t.showDisplayName=!!(4096&a)}},address:function(e,a){a.mailAddress=t.getFrom(e.data,{field:a.field,showDisplayName:!1}).text()}},size:function(e){if(!e.app||608===e.app.props.get("sort")||e.app.props.get("alwaysShowSize")){var a=e.data;if(_.isNumber(a.size)){var i=t.threadFileSize(a.thread||[a]);this.append($('<span class="size">').text(n.fileSize(i,1)))}}},unreadClass:function(e){var a=t.isUnseen(e.data);this.closest(".list-item").toggleClass("unread",a)},deleted:function(e){this.parent().toggleClass("deleted",t.isDeleted(e.data))},colorflag:function(e){if(g.get("features/flag/color")){var t=e.data.color_label,a="fa-bookmark";t<=0||((e.app&&e.app.isThreaded()||e.options.threaded)&&e.data.thread&&t!==e.data.thread[0].color_label&&(a="fa-bookmark-o",t=0),this.append($('<i class="color-flag fa" aria-hidden="true">').addClass(a).addClass(t>0?"flag_"+t:"multiple-colors")))}},flag:function(e){g.get("features/flag/star")&&t.isFlagged(e.data)&&this.append($('<span class="flag">').append(S.flagIcon.call(this).attr("title",x("Flagged"))))},flagIcon:function(){return $('<i class="fa" aria-hidden="true">')},flaggedClass:function(e){g.get("features/flag/star")&&this.closest(".list-item").toggleClass("flagged",t.isFlagged(e.data))},flagToggle:function(){function e(e,a,i){var n=x(t.isFlagged(e)?"Flagged":"Not flagged");$(i).attr("aria-label",n).find(".fa").attr("title",n)}function i(e){e.preventDefault();var i=e.data.model.toJSON();t.isFlagged(i)?a.flag(i,!1):a.flag(i,!0)}function n(t,a){var i=t.$("a.flag.io-ox-action-link");e(a.toJSON(),void 0,i)}return function(a){if(g.get("features/flag/star")&&!t.isEmbedded(a.data)){var s=this;a.view.listenTo(a.view.model,"change:flags",_.partial(n,a.view)),o.get(a.data.folder_id).done(function(t){o.can("write",t)&&!o.is("unifiedfolder",t)&&s.append($('<a href="#" role="button" class="flag io-ox-action-link" data-action="flag">').append(S.flagIcon.call(this)).each(_.partial(e,a.data)).on("click",{model:a.view.model},i))})}}}(),threadSize:function(e){if(e.app&&e.app.isThreaded()||e.options.threaded){var t=a.threads.size(e.data);t<=1||this.append($('<div class="thread-size" aria-hidden="true">').append($('<span class="number drag-count">').text(t)))}},paperClip:function(e){e.data.attachment&&this.append($('<i class="fa fa-paperclip has-attachments" aria-hidden="true">'))},sharedAttachement:function(e){e.model&&_.has(e.model.get("headers"),"X-Open-Xchange-Share-URL")&&this.append($('<i class="fa fa-cloud-download is-shared-attachement" aria-hidden="true">'))},pgp:{encrypted:function(e){(/^multipart\/encrypted/.test(e.data.content_type)||e.model.get("security")&&e.model.get("security").decrypted)&&this.append($('<i class="fa fa-lock encrypted" aria-hidden="true">'))},signed:function(e){(/^multipart\/signed/.test(e.data.content_type)||e.model.get("security")&&e.model.get("security").signatures)&&this.append($('<i class="fa fa-pencil-square-o signed" aria-hidden="true">'))}},priority:function(e){var a=t.getPriority(e.data);a.length&&this.append($('<span class="priority" aria-hidden="true">').append(a))},envelope:function(){return $('<i class="fa seen-unseen-indicator" aria-hidden="true">').appendTo(this)},unread:function(e){t.isUnseen(e.data)&&S.envelope.call(this).attr("title",x("Unread"))},answered:function(e){var i=e.data,n=_.cid(i),o=a.threads.get(n);t.isAnswered(o,i)&&this.append('<i class="icon-answered fa fa-reply" aria-hidden="true">')},forwarded:function(e){var i=e.data,n=_.cid(i),o=a.threads.get(n);t.isForwarded(o,i)&&this.append('<i class="icon-forwarded fa fa-mail-forward" aria-hidden="true">')},subject:function(e){var a=e.data,i=1===e.data.threadSize,n=t.getSubject(a,i);this.append($('<div class="subject" role="presentation">').append($('<span class="flags" role="presentation">'),$('<span class="drag-title" role="presentation">').text(n).attr("title",n)))},title:function(e){var a=t.getSubject(e.data);this.closest(".list-item").attr("title",a)},account:function(e){i.isUnifiedFolder(e.data.folder_id)&&this.append($('<span class="account-name">').text(e.data.account_name||""))},empty:function(){this.attr("role","option").text(x("Empty"))},folder:function(e){if(e.data.original_folder_id){var t=e.app&&e.app.folder&&"virtual/all-unseen"===e.app.folder.get();(w(e)||t)&&this.append($('<span class="original-folder">').append(o.getTextNode(e.data.original_folder_id)))}},recipients:function(){var e=function(e){e.preventDefault(),$(this).parent().children().show(),$(this).hide()};return function(a){var i=a.data,n=i.cc&&i.cc.length>0,o=i.to&&i.to.length>0,s=i.bcc&&i.bcc.length>0,d=o||n||s,l=$('<div class="recipients">');if(d){o&&l.append($('<span class="io-ox-label">').append($.txt(x("To")),$.txt("  ")),t.serializeList(i,"to"),$.txt("   ")),n&&l.append($('<span class="io-ox-label">').append($.txt(x.pgettext("CC","Copy")),"  "),t.serializeList(i,"cc"),$.txt("   ")),s&&l.append($('<span class="io-ox-label">').append($.txt(x("Blind copy")),"  "),t.serializeList(i,"bcc"),$.txt("   ")),this.append(l);var r=l.find(".person-link");r.length>3&&(l.children().slice(4).hide(),l.append($('<a role="button" href="#" class="show-all-recipients">').text(x("and %1$d others",r.length-2)).on("click",e)))}else this.append(l.append($.txt(" ")))}}(),attachmentList:function(){var t,i=function(){var e,t,i=this.model.toJSON();new v({backdrop:!0,caret:!1,data:i,el:this.$(".file"),point:"io.ox/mail/attachment/links",title:this.model.getShortTitle(),list:this.model.collection.toJSON()}),e=a.getUrl(i,"download"),t=(this.model.get("content_type")||"unknown").split(/;/)[0],this.$el.attr({title:this.model.getTitle(),draggable:!0,"data-downloadurl":t+":"+this.model.getTitle().replace(/:/g,"")+":"+ox.abs+e}).on("dragstart",function(e){$(this).css({display:"inline-block"}),e.originalEvent.dataTransfer.setData("DownloadURL",this.dataset.downloadurl)}),t&&!/^image\//.test(t)&&this.$el.addClass("no-image")};return function(a){if(0===a.attachments.length)return $.when();(a.model?a.model.get("headers"):a.data.headers||{})["X-Open-Xchange-Share-Type"]&&this.hide();var n=this;_.once(function(){t=m.View.extend({renderContent:i})})();var o=a.attachments.map(function(e){return e.group="mail",e}),s=new m.Collection(o),d=!!n.data("view"),l=n.data("view")||new m.List({AttachmentView:t,collection:s,el:n,mode:g.get("attachments/layout/detail/"+_.display(),"list")});l.openByDefault=g.get("attachments/layout/detail/open",l.openByDefault),l.$header.empty(),l.render();var r=new h({el:l.$header.find(".links")[0],inline:!0,simple:!0,dropdown:!1,strict:!1,point:"io.ox/mail/attachment/links"});return l.renderInlineLinks=function(){var e=this.getValidModels();e.length&&r.setSelection(_(e).pluck("id"),{data:_(e).invoke("toJSON")})},l.listenTo(l.collection,"add remove reset",l.renderInlineLinks),l.listenTo(a.model,"change:imipMail",l.renderInlineLinks),l.renderInlineLinks(),d||(l.$el.on("click","li.item",function(t){var a,i,n,d=$(t.currentTarget),l=$(t.target);l.hasClass("dropdown-toggle")||(a=d.attr("data-id"),i=s.get(a).toJSON(),a=d.attr("data-id"),i=s.get(a).toJSON(),n=e.Baton({simple:!0,data:i,list:o,restoreFocus:l,openedBy:"io.ox/mail/details"}),b.invoke("io.ox/mail/attachment/actions/view",n))}),l.on("change:layout",function(e){g.set("attachments/layout/detail/"+_.display(),e).save()})),l.$el.find('[role="toolbar"]').find('a[role="menuitem"]').attr("role","button"),l}}(),flagPicker:function(e){g.get("features/flag/color")&&f.draw(this,e)},unreadToggle:function(){function e(e,a,i){var n=x(t.isUnseen(e)?"Mark as read":"Mark as unread");$(i).attr({"aria-label":n}).find(".fa").attr("title",n)}function i(e){e.preventDefault();var i=e.data.model.toJSON();t.isUnseen(i)?a.markRead(i):a.markUnread(i)}function n(t,a){var i=t.$("a.unread-toggle");e(a.toJSON(),void 0,i)}return function(a){if(!t.isEmbedded(a.data)){var s=this;a.view.listenTo(a.view.model,"change:flags",_.partial(n,a.view)),o.get(a.data.folder_id).done(function(t){(o.can("write",t)||o.is("unifiedfolder",t))&&s.append($('<a href="#" role="button" class="unread-toggle io-ox-action-link" data-action="unread-toggle">').append('<i class="fa" aria-hidden="true">').each(_.partial(e,a.data)).on("click",{model:a.view.model},i))})}}}(),disabledLinks:function(){function e(e,t,a){e.options.disable=e.options.disable||{};var i=e.options.disable[t];_.isString(i)&&(e.options.disable[t]=[].concat(i)),e.options.disable[t]=(e.options.disable[t]||[]).concat(a)}function a(t){t.preventDefault();var a=t.data.view;a.trigger("load"),a.$el.find(".disabled-links").remove(),e(a,"io.ox/mail/detail/source","disable-links"),e(a,"io.ox/mail/detail/content-general","disable-links"),e(a,"io.ox/mail/detail/notifications","disabled-links"),a.redraw()}function i(){this.append($('<div class="notification-item disabled-links">').append($('<button type="button" class="btn btn-default btn-sm">').text(x("Enable Links")),$('<div class="comment">').text(x("Links have been disabled to protect you against potential spam!")),$('<button type="button" class="close">').attr("title",x("Close")).append('<i class="fa fa-times" aria-hidden="true">')))}return function(e){t.authenticity("block",e.data)&&!t.isMalicious(e.data)&&(i.call(this,e.model),this.on("click",".disabled-links > .btn-default",{view:e.view},a),this.on("click",".disabled-links > .close",function(e){$(e.target).closest(".disabled-links").remove()}))}}(),externalImages:function(){function t(e){e.preventDefault();var t=e.data.view;return t.trigger("load"),t.$el.find(".external-images").remove(),a.getUnmodified(t.model.pick("id","folder","folder_id","parent","security")).done(function(e){t.trigger("load:done"),t.model.set(e)}),!1}function i(e){if(1!==e.get("modified"))return this.find(".external-images").remove();this.append($('<div class="notification-item external-images">').append($('<button type="button" class="btn btn-default btn-sm">').text(x("Show images")),$('<div class="comment">').text(x("External images have been blocked to protect you against potential spam!")),$('<button type="button" class="close">').attr("title",x("Close")).append('<i class="fa fa-times" aria-hidden="true">')))}return function(a){i.call(this,a.model),this.on("click",".external-images > .btn-default",{view:a.view},function(i){e.point("io.ox/mail/externalImages").cascade(this,a).then(function(){t(i)})}),this.on("click",".external-images > .close",function(e){$(e.target).closest(".external-images").remove()}),a.view.listenTo(a.model,"change:modified",i.bind(this))}}(),phishing:function(){function e(e){this.find(".phishing").length||_(e.get("headers")).find(function(e,a){if(t.contains(a))return this.append($('<div class="alert alert-error phishing">').text(x("Warning: This message might be a phishing or scam mail"))),!0},this)}var t=_(g.get("phishing/headers",["phishing-test"]));return function(t){e.call(this,t.model),t.view.listenTo(t.model,"change:headers",e.bind(this))}}(),plainTextFallback:function(){function e(e){this.find(".warnings").length||e.get("warnings")&&this.append($('<div class="alert alert-error warnings">').text(e.get("warnings").error))}return function(t){e.call(this,t.model),t.view.listenTo(t.model,"change:warnings",e.bind(this))}}(),dispositionNotification:function(){function e(e){e.preventDefault();var t=e.data.view,i=_.cid(t.model.cid);t.model.set("disp_notification_to",""),s[t.model.cid]=!0,a.ack({folder:i.folder_id,id:i.id}).done(function(){d.yell("success",x("A read receipt has been sent"))})}function n(e){e.preventDefault();var t=e.data.view;s[t.model.cid]=!0}function o(e){this.find(".disposition-notification").remove(),s[e.cid]||t.hasUnsendReadReceipt(e.toJSON())&&g.get("sendDispositionNotification",!1)&&(i.is("drafts",e.get("folder_id"))||this.append($('<div class="alert alert-info disposition-notification notification-item">').append($('<button type="button" class="btn btn-primary btn-sm">').text(x("Send a read receipt")),$('<div class="comment">').text(x("The sender wants to get notified when you have read this email")),$('<button type="button" class="close" data-dismiss="alert">').attr("title",x("Close")).append('<i class="fa fa-times" aria-hidden="true">'))))}var s={};return function(t){o.call(this,t.model),this.on("click",".disposition-notification .btn",{view:t.view},e),this.on("click",".disposition-notification .close",{view:t.view},n),t.view.listenTo(t.model,"change:disp_notification_to",o.bind(this))}}()};return S});