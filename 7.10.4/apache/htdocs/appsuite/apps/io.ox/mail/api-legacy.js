define("io.ox/mail/api-legacy",["io.ox/core/http","io.ox/core/folder/api","io.ox/contacts/api","io.ox/core/api/account","settings!io.ox/mail"],function(t,e,n,a,r){"use strict";function o(e,n){var a=new FormData;return a.append("json_0",JSON.stringify(e)),_(n).each(function(t,e){t.name?a.append("file_"+e,t,t.name):a.append("file_"+e,t)}),t.UPLOAD({module:"mail",params:{action:"new",lineWrapAfter:0,force_json_response:!0},data:a,dataType:"json",fixPost:!0})}var i={};i.SENDTYPE={NORMAL:0,REPLY:1,FORWARD:2,EDIT_DRAFT:3,DRAFT:4},i.csid=function(){return _.uniqueId()+"."+_.now()};var c=function(e,n,a){var o=this,c="edit"===e;"alternative"===a&&(a="text/plain"===n.content_type?"text":"html"),"html"!==(a="text/html"===(a="text/plain"===(a=$.trim(a||"text").toLowerCase())?"text":a)?"html":a)||"text/plain"!==n.content_type||c||(a="text"),"text"===a&&"text/plain"===n.content_type&&c&&(a="raw");var s=n.attachOriginalMessage||"text"===a&&_.device("touch")&&!0===r.get("attachOriginalMessage",!1),l=i.csid();return t.PUT({module:"mail",params:$.extend({},{action:c?"get":e||"",attachOriginalMessage:s,view:a,setFrom:/reply|replyall|forward/.test(e),csid:l,embedded:n.embedded,max_size:n.max_size,decrypt:n.security&&n.security.decrypted,process_plain_text:!1}),data:_([].concat(n)).map(function(t){return o.reduce(t)}),appendColumns:!1}).then(function(t){var e="",n="";return t.csid=l,t.attachments&&t.attachments.length?""===t.attachments[0].content||("text/html"===t.attachments[0].content_type?((n=document.createElement("DIV")).innerHTML=t.attachments[0].content,_(n.getElementsByTagName("BLOCKQUOTE")).each(function(t){t.removeAttribute("style")}),e=n.innerHTML,n=null):e=$.trim(t.attachments[0].content)):t.attachments=t.attachments||[{}],t.attachments[0].content=e,t})};return i.replyall=function(t,e){return c.call(this,"replyall",t,e)},i.reply=function(t,e){return c.call(this,"reply",t,e)},i.forward=function(t,e){return c.call(this,"forward",t,e)},i.edit=function(t,e){return c.call(this,"edit",t,e)},i.send=function(t,r,c){var s,l=this,d=function(t){var e=$.trim(t[0]||"").replace(/^["']+|["']+$/g,""),n=String(t[1]||""),a=t[2]||"";return"/TYPE=PLMN"===a&&!/\/TYPE=PLMN$/.test(n)&&(e=null,n+=a),""!==e&&e!==n||(e=null),[e,n]};(t=_.clone(t)).from=_(t.from).map(d),t.to=_(t.to).map(d),t.cc=_(t.cc).map(d),t.bcc=_(t.bcc).map(d),t.share_attachments&&t.share_attachments.expiry_date&&(t.share_attachments=_.clone(t.share_attachments),t.share_attachments.expiry_date=_.now()+parseInt(t.share_attachments.expiry_date,10)),t.contacts_ids&&(t.datasources=_.chain(t.contacts_ids).map(function(t){return{args:[{"com.openexchange.groupware.contact.pairs":[{folder:t.folder_id,id:t.id}]}],identifier:"com.openexchange.contact"}}).value()),l.trigger("beforesend",{data:t,files:r,form:c}),ox.trigger("mail:send:start",t,r),s=o(t,r);var u=i.SEND_REFRESH_DELAY,m=t.flags===i.FLAGS.DRAFT,h=t.csid;return i.queue.add(h,s.abort),s.done(function(){n.trigger("maybeNewContact"),l.trigger("send",{data:t,files:r,form:c}),ox.trigger("mail:send:stop",t,r),t.share_attachments&&ox.trigger("please:refresh refresh^")}).fail(function(){ox.trigger("mail:send:fail")}).progress(function(t){m||i.queue.update(h,t.loaded,t.total)}).always(function(){i.queue.remove(h)}).then(function(t){if(setTimeout(function(){var t=_(["inbox","sent","drafts"]).chain().map(function(t){var e=a.getFoldersByType(t);return l.pool.resetFolder(e),e}).flatten().value();e.multiple(t,{cache:!1}),l.trigger("refresh.all")},u),_.isObject(t))return t;var n=t.indexOf("{"),r=t.lastIndexOf("}");return n>-1&&r>-1?JSON.parse(t.substr(n,r-n+1)):{}}).then(function(n){if(n.error)return $.Deferred().reject(n).promise();if(n.data){var r=_(n.data.toString().split(l.separator)),o=r.last(),i=r.without(o).join(l.separator);$.when(a.getUnifiedMailboxName(),a.getPrimaryAddress()).done(function(n,r){var o=!1;_.chain(_.union(t.to,t.cc,t.bcc)).each(function(t){t[1]!==r[1]||(o=!0)}),setTimeout(function(){null!==n?e.refresh():o?e.reload(i,a.getInbox()):e.reload(i)},u)})}return n})},i.SEND_REFRESH_DELAY=5e3,i.queue=function(){function t(t,e){return e?Math.max(0,Math.min(100,Math.round(t/e*100)))/100:0}return{collection:(new Backbone.Collection).on("add remove change:pct",function(){var e,n=0,a=0;this.each(function(t){n+=t.get("loaded"),a+=t.get("total"),e=t.get("abort")}),this.trigger("progress",{count:this.length,loaded:n,pct:t(n,a),total:a,abort:e})}),add:function(t,e){this.collection.add(new Backbone.Model({id:t,loaded:0,pct:0,total:0,abort:e}))},remove:function(t){var e=this.collection.get(t);this.collection.remove(e)},update:function(e,n,a){var r=this.collection.get(e);r&&r.set({loaded:n,pct:t(n,a),total:a})}}}(),i});