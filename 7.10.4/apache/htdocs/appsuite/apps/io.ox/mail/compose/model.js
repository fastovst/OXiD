define("io.ox/mail/compose/model",["io.ox/mail/compose/api","io.ox/mail/api","io.ox/core/attachments/backbone","settings!io.ox/mail","gettext!io.ox/mail","io.ox/mail/sanitizer","io.ox/mail/util"],function(t,e,n,i,a,r,o){"use strict";var s=t.space.attachments;return Backbone.Model.extend({defaults:function(){return{to:[],cc:[],bcc:[],subject:"",content:"",contentType:"",attachments:[],meta:{type:"new",date:"",originalId:"",originalFolderId:"",security:{encrypt:!1,pgpInline:!1,sign:!1}},requestReadReceipt:!1,priority:"normal",sharedAttachments:{language:"",enabled:!1,autodelete:!1,expiryDate:"",password:""}}},initialize:function(){this.initialized=this.create().then(function(t){["to","cc","bcc"].forEach(function(e){t[e]=_.chain().union(this.get(e),t[e]).uniq(function(t){return t.length>1?t[1]:t[0]}).value()}.bind(this));var e=new n.Collection;return e.space=t.id,e.reset(_(t.attachments).map(function(t){return new n.Model(_.extend({},t,{group:"mail",space:e.space}))})),t.attachments=e,t}.bind(this)).then(function(t){this.set(t),this.prevAttributes||(this.prevAttributes=t),this.listenTo(t.attachments,"remove",this.onRemoveAttachment)}.bind(this))},initialPatch:function(){return this.requestSave=_.throttle(this.save.bind(this,!1),i.get("autoSaveAfter",15e3),{leading:!1}),this.on("change",this.requestSave),this.save(_.device("smartphone"))},sendOrSave:function(e){var n=this.toJSON(),i=(this.get("attachments")||[]).filter(function(t){return"localFile"===t.get("group")}).map(function(t){return t.resized?t.resized:t.get("originalFile")});return n.attachments.forEach(function(t){delete t.meta}),this.destroyed=!0,$.when.apply($,i).then(function(){var i=_(arguments).toArray();return t.space[e](this.get("id"),n,i)}.bind(this)).fail(function(){this.destroyed=!1}.bind(this))},send:function(){return this.sendOrSave("send")},saveDraft:function(){return this.sendOrSave("save")},attachFiles:function(t){this.get("attachments").add(t)},attachVCard:function(){t.space.attachments.vcard(this.get("id")).then(function(t){this.get("attachments").add(t)}.bind(this))},onRemoveAttachment:function(t){this.destroyed||(t.trigger("destroy"),t.get("id")&&s.remove(this.get("id"),t.get("id")))},quoteMessage:function(){function t(t){return t.length<2?t[0]||"":t[0]?t[0]+" <"+t[1]+">":t[1]}return function(n){var s=n.meta,c=s.replyFor||s.forwardsFor;return"text/html"!==n.contentType&&"multipart/alternative"!==n.contentType||(n.content=r.simpleSanitize(n.content)),!(c=[].concat(c)[0])||s.editFor?n:e.get({id:c.originalId,folder:c.originalFolderId},{cache:!i.get("features/fixContentType",!1)}).then(function(e){var r=[];/^(reply|replyall)$/.test(n.meta.type)?r.push(a("On %1$s %2$s wrote:",moment(n.meta.date).format("LLL"),e.from.map(function(t){return o.formatSender(t,!1)}).join(", "))):/^forward-inline$/.test(n.meta.type)&&(r.push(a("---------- Original Message ----------"),a("From: %1$s",e.from.map(t).join(", ")),a("To: %1$s",e.to.map(t).join(", "))),e.cc&&e.cc.length>0&&r.push(a("Cc: %1$s",e.cc.map(t).join(", "))),r.push(a("Date: %1$s",moment(n.meta.date).format("LLL")),a("Subject: %1$s",e.subject))),r.push("","");var s=/^forward-inline$/.test(n.meta.type)&&i.get("forwardunquoted",!1);if("text/html"===n.contentType)n.content=o.getDefaultStyle().node.get(0).outerHTML+$('<blockquote type="cite">').append(r.map(function(t){return t?$("<div>").text(t):"<div><br></div>"}),n.content).prop(s?"innerHTML":"outerHTML");else if("text/plain"===n.contentType){var c=s?"":"> ";n.content="\n"+r.map(function(t){return c+t}).join("\n")+" \n"+n.content.trim().split("\n").map(function(t){return c+t}).join("\n")}return n})}}(),create:function(){if(this.has("id"))return t.space.get(this.get("id"));var e=this.get("type")||"new",n=this.get("original"),a={vcard:!/(edit|copy)/.test(e)&&i.get("appendVcard",!1)};return this.type=e,this.unset("type"),this.unset("original"),t.space.add({type:e,original:n},a).then(function(t){return this.prevAttributes=t,t.content?this.quoteMessage(t):t}.bind(this)).then(function(t){return this.get("attachments")&&this.get("attachments").length?$.when.apply($,this.get("attachments").map(function(e){return s.add(t.id,e)})).then(function(){return t.attachments=(t.attachments||[]).concat(_.toArray(arguments)),t}).catch(function(e){return ox.debug&&console.warn("Could not load initial attachments",e),t}):t}.bind(this))},deepDiff:function(t,e){return _.isUndefined(t)?e:(e=e||this.attributes,_(e).chain().mapObject(function(e,n){if((e instanceof Backbone.Model||e instanceof Backbone.Collection)&&(e=e.toJSON()),!_.isEqual(t[n],e))return _.isUndefined(e)?null:e}).omit(function(t){return _.isUndefined(t)}).value())},save:function(e){if(this.destroyed)return $.when();var n=this.prevAttributes,i=this.toJSON();i.content=i.content.replace(/<img[^>]*data-pending="true"[^>]*>/g,"");var a=this.deepDiff(n,i);return delete a.attachments,_.isEmpty(a)?$.when():(this.prevAttributes=this.toJSON(),e||this.trigger("before:save"),t.space.update(this.get("id"),a).then(function(){e||this.trigger("success:save")}.bind(this),function(){this.prevAttributes=n,ox.debug&&console.warn("Update composition space failed",this.get("id")),e||this.trigger("fail:save")}.bind(this)))},destroy:function(){if(!this.destroyed&&this.get("id"))return this.destroyed=!0,this.get("attachments").forEach(function(t){t.trigger("destroy")}),$.when(_(this.get("attachments")).pluck("done").map(function(t){return $.when(t).catch()})).then(function(){return t.space.remove(this.get("id"))}.bind(this))},toJSON:function(){var t=Backbone.Model.prototype.toJSON.call(this),e=this.get("attachments");return e&&e.toJSON&&(t.attachments=e.toJSON()),t},keepDraftOnClose:function(){return!0===i.get("features/deleteDraftOnClose")&&!!this.get("meta").editFor}})});