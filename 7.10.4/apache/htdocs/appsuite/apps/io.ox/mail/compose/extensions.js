define("io.ox/mail/compose/extensions",["io.ox/mail/api","io.ox/mail/sender","io.ox/backbone/mini-views/common","io.ox/backbone/mini-views/dropdown","io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/core/tk/tokenfield","io.ox/core/dropzone","io.ox/core/capabilities","io.ox/mail/actions/attachmentQuota","io.ox/core/util","io.ox/core/attachments/view","io.ox/mail/compose/util","io.ox/mail/util","settings!io.ox/mail","gettext!io.ox/mail","settings!io.ox/contacts","io.ox/core/attachments/backbone","io.ox/core/strings","io.ox/mail/compose/resize-view","io.ox/mail/compose/resize","static/3rd.party/jquery-ui.min.js"],function(e,t,i,n,o,a,s,l,d,r,c,p,m,u,h,f,g,v,b,w,x){var k="io.ox/mail/compose",y={to:f("To"),pickerto:f("Select contacts"),ariato:f("%1$s autocomplete token field. Use left and right Arrowkeys to navigate between the tokens",f("To")),cc:f("CC"),pickercc:f("Select CC contacts"),ariacc:f("%1$s autocomplete token field. Use left and right Arrowkeys to navigate between the tokens",f("CC")),bcc:f("BCC"),pickerbcc:f("Select BCC contacts"),ariabcc:f("%1$s autocomplete token field. Use left and right Arrowkeys to navigate between the tokens",f("BCC")),reply_to:f.pgettext("compose","Reply to")},C=function(e,t){t=t.target?t.target.files:t;var i=this,n=e.get("attachments").filter(function(e){return void 0!==e.get("size")}).map(function(e){return e.get("size")}).reduce(function(e,t){return e+t},0);if(r.checkQuota(t,n)){i.trigger("aria-live-update",f("Added %s to attachments.",_(t).map(function(e){return e.name}).join(", ")));var o=_(t).map(function(t){var i=new v.Model({filename:t.name,origin:{file:t}});return m.uploadAttachment({model:e,filename:t.filename,origin:{file:t},attachment:i}),i});e.attachFiles(o)}},A=Backbone.Model.extend({initialize:function(e){this.config=e.config,this.model=e.model,this.configFields=e.configFields,this.modelFields=e.modelFields,delete this.attributes.config,delete this.attributes.model,delete this.attributes.configFields,delete this.attributes.modelFields,this.listenTo(this.config,this.configFields.map(this.changeMapper).join(" "),this.getData),this.listenTo(this.model,this.modelFields.map(this.changeMapper).join(" "),this.getData),this.getData(),this.on("change",this.updateModels)},changeMapper:function(e){return"change:"+e},getData:function(){this.configFields.forEach(function(e){this.set(e,this.config.get(e))}.bind(this)),this.modelFields.forEach(function(e){this.set(e,this.model.get(e))}.bind(this))},updateModels:function(){_(this.changed).forEach(function(e,t){return this.configFields.indexOf(t)>=0?this.config.set(t,e):this.modelFields.indexOf(t)>=0?this.model.set(t,e):void 0}.bind(this))}}),D=Backbone.DisposableView.extend({className:"row sender",attributes:{"data-extension-id":"sender"},initialize:function(e){this.config=e.config,this.dropdown=new n({model:new A({model:this.model,config:this.config,configFields:["sendDisplayName","editorMode"],modelFields:["from"]}),label:this.getItemNode.bind(this),aria:f("From"),caret:!0}),this.listenTo(ox,"account:create account:delete",this.onAccountUpdate.bind(this)),this.listenTo(ox,"change:customDisplayNames",this.onSenderUpdate.bind(this)),this.listenTo(this.model,"change:from",this.onSenderUpdate),this.listenTo(this.config,"change:sendDisplayName",function(e,t){h.set("sendDisplayName",t)})},onAccountUpdate:function(){_.delay(function(){this.updateSenderList({useCache:!1}).then(this.renderDropdown.bind(this))}.bind(this),1e3)},onSenderUpdate:function(){this.renderDropdown()},updateSenderList:function(e){var i=_.extend({useCache:!1},e);return t.getAddressesOptions(i).then(function(e){this.list=e,this.list.sortedAddresses.forEach(function(e){var t=e.option;h.get(["customDisplayNames",t[1],"defaultName"])||h.set(["customDisplayNames",t[1],"defaultName"],t[0])})}.bind(this))},render:function(){return this.$el.empty().append($('<label class="maillabel col-xs-2">').text(f("From")),$('<div class="mail-input col-xs-10">').append(this.dropdown.render().$el.attr({"data-dropdown":"from"}))),this.updateSenderList().then(this.renderDropdown.bind(this)),this},renderDropdown:function(){var e=this.model.get("from")?this.model.get("from")[1]:void 0;this.dropdown.$ul.empty().css("width","auto"),this.setDropdownOptions(),this.dropdown.$toggle.find(".dropdown-label").empty().append(this.getItemNode()),this.dropdown.$toggle.attr("href",e?"mailto:"+e:"#"),this.dropdown.$el.hasClass("open")&&this.dropdown.adjustBounds(),this.dropdown.$ul.find('[data-name="sendDisplayName"]').focus()},setDropdownOptions:function(){var e=this;if(this.list&&this.list.sortedAddresses.length){var t=h.get("defaultSendAddress","").trim(),i=_(this.list.sortedAddresses).chain().map(function(t){var i=u.getSender(t.option,e.config.get("sendDisplayName"));return{key:_(i).compact().join(" ").toLowerCase(),array:i}}).sortBy("key").pluck("array").value();i=_(i).filter(function(n){return n[1]!==t||(e.dropdown.option("from",n,function(){return e.getItemNode(n)}),i.length>1&&e.dropdown.divider(),!1)}),_(i).each(function(t){e.dropdown.option("from",t,function(){return e.getItemNode(t)})}),_.device("smartphone")||this.dropdown.divider().option("sendDisplayName",!0,f("Show names"),{keepOpen:!0}).divider().link("edit-real-names",f("Edit names"),this.onEditNames)}},getItemNode:function(e){if(e=e||this.model.get("from")){var t=e[0],i=e[1];return[$('<span class="name">').text(t?t+" ":""),$('<span class="address">').text(t?"<"+i+">":i)]}},onEditNames:function(){require(["io.ox/mail/compose/names"],function(e){e.open()})}});return{header:function(e){if(e.view.app.getWindow()){var t=$('<div data-extension-id="header">');e.$header=t,o.point(k+"/header").invoke("draw",t,e),e.view.app.getWindow().setHeader(t)}},title:function(){this.append($('<h1 class="sr-only">').text(f("Compose new email")))},buttons:{discard:function(e){return $('<button type="button" class="btn btn-default" data-action="discard">').on("click",function(){e.view.app.quit()}).text(f(e.model.keepDraftOnClose()?"Delete":"Discard")).appendTo(this)},send:function(e){this.append($('<button type="button" class="btn btn-primary" data-action="send">').on("click",function(){e.view.send()}).on("keyup",function(t){27===t.which&&e.view.focusEditor()}).text(f("Send")))}},inlineYell:function(){this.append($('<div role="log" aria-live="polite" class="inline-yell">'))},sender:function(e){var t=new D({model:e.model,config:e.config});this.append(t.render().$el)},senderRealName:function(e){function t(){i.toggleClass("no-realname",!n.get("sendDisplayName"))}var i=this,n=e.config;n.on("change:sendDisplayName",t),t(),this.append($('<div class="row sender-realname" data-extension-id="sender-realname">').append($('<div class="mail-input col-xs-10 col-xs-offset-2">').text(f("This email just contains your email address as sender. Your real name is not used."))))},recipientActionLink:function(e){return function(){var t=$('<button type="button" class="btn btn-link" data-action="add">');"cc"===e?t.attr({"data-type":"cc",title:f("Show carbon copy input field")}).text(f("CC")):t.attr({"data-type":"bcc",title:f("Show blind carbon copy input field")}).text(f("BCC")),this.append(t)}},recipientActionLinkMobile:function(){var e=$('<a href="#" data-action="add" role="checkbox" aria-checked="false">').append($('<span class="fa fa-angle-right" aria-hidden="true">'));this.append(e)},recipientActions:function(){var e=$('<div class="recipient-actions">');_.device("!smartphone")?o.point(k+"/recipientActionLink").invoke("draw",e):o.point(k+"/recipientActionLinkMobile").invoke("draw",e),this.append(e)},tokenfield:function(e){function t(e){e.preventDefault();var t=e.data.attr,i=e.data.model;require(["io.ox/contacts/addressbook/popup"],function(e){e.open(function(e){var n=i.get(t)||[];i.set(t,n.concat(_(e).pluck("array")))})})}if("reply_to"!==e||!1!==h.get("showReplyTo/configurable",!1))return function(i){var n,a=_.uniqueId("form-control-label-"),l=i.model.get(e)||[],r="row"+(/cc$/.test(e)&&!l.length?" hidden":""),p=!1,m=new s({id:a,className:e,extPoint:k+"/"+e,isMail:!0,apiOptions:{users:!0,limit:h.get("compose/autocompleteApiLimit",20),contacts:!0,distributionlists:!0,emailAutoComplete:!0},keepInComposeWindow:!0,maxResults:h.get("compose/autocompleteDrawLimit",30),placeholder:y[e],ariaLabel:y["aria"+e]}),u=$('<div class="mail-input col-xs-10">').append(m.$el);"to"===e&&o.point(k+"/recipientActions").invoke("draw",u);var v=!_.device("smartphone")&&d.has("contacts")&&g.get("picker/enabled",!0);v&&u.addClass("has-picker").append($('<a href="#" role="button" class="open-addressbook-popup">').append($('<i class="fa fa-address-book" aria-hidden="true">').attr("title",y["picker"+e])).attr("aria-label",y["picker"+e]).on("click",{attr:e,model:i.model},t));var b=f("Select contacts");this.append(n=$('<div data-extension-id="'+e+'">').addClass(r).append(v?$('<div class="maillabel col-xs-2">').append($('<a href="#" role="button">').text(y[e]).attr({"aria-label":b,title:b}).on("click",{attr:e,model:i.model},t).tooltip({animation:!1,delay:0,placement:"right",trigger:"hover"})):$('<label class="maillabel col-xs-2">').text(y[e]).attr({for:a})).append(u)),m.render().$el.on("tokenfield:createdtoken",function(e){o.point(k+"/createtoken").invoke("action",this,_.extend(i,{event:e}))}).on("tokenfield:next",function(){n.nextAll().find('input.tt-input,input[name="subject"]').filter(":visible").first().focus()}).on("tokenfield:removetoken",function(e){o.point(k+"/removetoken").invoke("action",this,_.extend(i,{event:e}))}),m.listenTo(i.model,"change:"+e,function(e,t){if(!p){var i=_(t).map(function(e){var t=c.removeQuotes(e[0]),i=e[1];return{type:5,display_name:t,email1:i,image1_url:e[2],token:{label:t,value:i}}});this.collection.reset(i)}}),i.model.trigger("change:"+e,i.model,i.model.get(e)),m.collection.on("change reset add remove sort",_.debounce(function(){var t=this.map(function(e){var t=e.get("token");return[c.removeQuotes(t.label),t.value]});p=!0,i.model.set(e,t),p=!1}.bind(m.collection)),20),i.view.on("updateTokens",function(){var t=this.map(function(e){var t=e.get("token");return[c.removeQuotes(t.label),t.value]});p=!0,i.model.set(e,t),p=!1}.bind(m.collection)),i.view.app.getWindow().one("idle",function(){m.$el.data("bs.tokenfield").update()}),o.point(k+"/createtoken").extend({id:"scrolltop",index:10,action:function(e){_.device("!smartphone")||e&&e.view&&setTimeout(function(){e.view.$el[0].scrollIntoView&&e.view.$el[0].scrollIntoView()},10)}})}},subject:function(e){var t=_.uniqueId("form-control-label-");this.append($('<div data-extension-id="subject" class="row subject">').append($('<label class="maillabel" >').addClass(_.device("smartphone")?"hidden-md hidden-sm hidden-xs":"col-xs-2").text(f("Subject")).attr("for",t),$('<div class="mail-input" >').addClass(_.device("smartphone")?"col-xs-12":"col-xs-10").append(new i.InputView({model:e.model,id:t,name:"subject",autocomplete:!1}).render().$el.attr("placeholder",f("Subject")))))},optionsmenu:function(e){var t=new n({model:new A({model:e.model,config:e.config,configFields:["editorMode","vcard"],modelFields:["priority","requestReadReceipt"]}),label:f("Options"),caret:!0});o.point(k+"/menuoptions").invoke("draw",t.$el,e),t.$ul.addClass("pull-right"),this.append(t.render().$el.addClass("text-left"))},attachmentPreviewList:function(e){var t=this,i=e.attachmentsView=new p.List({point:"io.ox/mail/compose/attachment/header",collection:e.model.get("attachments"),editable:!0,model:e.model,mode:h.get("attachments/layout/compose/"+_.display(),"preview")}),n=new l.Inplace({caption:f("Drop attachments here")});n.on({show:function(){t.css("minHeight","100px"),$(window).trigger("resize")},hide:function(){t.css("minHeight",0),$(window).trigger("resize")},drop:function(t){C.call(e.view.$el.find('[data-extension-id="add_attachments"]'),e.model,t),$(window).trigger("resize")}}),i.listenTo(e.model,"change:attachments",function(){i.$list.empty(),i.$preview.empty(),i.renderList(),i.updateScrollControls()}),i.listenToOnce(i.collection,"add remove reset",_.debounce(function(){this.getValidModels().length>0&&(this.$el.addClass("open"),this.isListRendered||(this.renderList(),i.updateScrollControls()))})),i.listenTo(i.collection,"add remove reset",_.debounce(function(){e.resizeView&&e.resizeView.update(),this.getValidModels().length<=1&&$(window).trigger("resize")})),i.on("change:expanded",function(){$(window).trigger("resize")}),i.render(),i.getValidModels().length>0&&(i.renderList(),i.$el.addClass("open")),t.append(n.render().$el.addClass("abs"),i.$el),i.$el.on("click","li.item",function(e){var t,n,s,l,d=$(e.currentTarget);d.attr("data-original")&&(t=d.attr("data-id"),"localFile"===(n=i.collection.get(t).toJSON()).group&&(n.fileObj=i.collection.get(t).fileObj,n.id="localFileAttachment-"+t),l=i.collection.filter(function(e){return"attachment"===e.get("disp")}).map(function(e){var t=e.toJSON();return t.filename=t.filename||t.name,"localFile"===t.group&&(t.fileObj=e.fileObj,t.id="localFileAttachment-"+e.cid),t}),s=o.Baton({simple:!0,data:n,list:l,restoreFocus:$(e.target),openedBy:"io.ox/mail/compose"}),a.invoke("io.ox/mail/attachment/actions/view",s))}),e.app.once("ready",i.updateScrollControls.bind(i,void 0)),i.on("change:layout",function(e){h.set("attachments/layout/compose/"+_.display(),e).save()})},attachmentSharing:function(e){h.get("compose/shareAttachments/enabled",!1)&&d.has("infostore")&&(_.device("smartphone")||require(["io.ox/mail/compose/sharing"],function(t){var i=e.sharingView=new t({model:e.model});e.attachmentsView.$header.find(".links").before(i.render().$el)}))},mailSize:function(t){function i(){var i=t.model.get("content").replace(/src="data:image[^"]*"/g,"").length,n=t.model.get("attachments").reduce(function(i,n){if("INLINE"===n.get("contentDisposition")){var o=t.model.get("id"),a=e.getUrl(_.extend({space:o},n),"view").replace("?","\\?"),s=new RegExp('<img[^>]*src="'+a+'"[^>]*>').test(t.model.get("content")),l=new RegExp('<img[^>]*src="[^"]*'+n.get("id")+'"[^>]*>').test(t.model.get("content"));if(!s&&!l)return i}return i+(n.getSize()||0)},0);return b.fileSize(i+n,1)}var n=t.attachmentsView,o=$('<span class="mail-size">');n.$footer.append(o);var a=_.debounce(function(){var e=t.model.get("attachments").some(function(e){return"mail"===e.get("group")}),n=!!(t.model.get("sharedAttachments")||{}).enabled,a=e&&!n;o.text(f("Mail size: %1$s",i())).toggleClass("invisible",!a)},10),s=_.throttle(a,5e3);a(),n.listenTo(n.collection,"add remove reset change:size",a),n.listenTo(t.model,"change:sharedAttachments",a),n.listenTo(t.model,"change:content",s)},imageResizeOption:function(e){function t(){var t=e.model.get("attachments").models;x.containsResizables(t).then(function(e){n.$el.toggle(e)})}var i=e.attachmentsView,n=new w({model:e.config,collection:i.collection});i.$footer.append(n.render().$el),i.listenTo(i.collection,"add remove reset",_.debounce(t,0)),t()},attachment:function(){function e(e){var t=this;require(["io.ox/files/filepicker"],function(i){new i({primaryButtonText:f("Add"),cancelButtonText:f("Cancel"),header:f("Add attachments"),multiselect:!0,createFolderButton:!1,extension:"io.ox/mail/mobile/navbar",uploadButton:!0}).done(function(i){t.trigger("aria-live-update",f("Added %s to attachments.",_(i).map(function(e){return e.filename}).join(", ")));var n=i.map(function(t){var i=new v.Model({filename:t.filename});return m.uploadAttachment({model:e,filename:t.filename,origin:{origin:"drive",id:t.id,folderId:t.folder_id},attachment:i}),i});e.attachFiles(n)})})}return function(t){var i=$('<input type="file" name="file">').css("display","none").on("change",C.bind(this,t.model)).prop("multiple",_.device("!smartphone"));if(d.has("infostore")){var o=new n({label:f("Attachments"),caret:!0});this.append(i,o.append($('<a href="#">').append($.txt(f("Add local file"))).on("click",function(){i[0].value="",i.trigger("click")})).link("add-file",f("Add from Drive"),e.bind(this,t.model)).render().$el)}else this.append(i,$('<button type="button" class="btn btn-link">').text(f("Attachments")).on("click",function(){i[0].value="",i.trigger("click")}))}}(),body:function(){var e=this,t=_.uniqueId("tmce-"),i=_.uniqueId("tmcetoolbar-");e.append($('<div class="row">').append($('<div class="col-sm-12">').append($('<div class="editable-toolbar">').attr("id",i),$('<div class="editable">').attr("id",t).css("min-height","400px"))))},mailto:function(){if(h.get("features/registerProtocolHandler",!0)&&navigator.registerProtocolHandler){var e=location,t=e.href.indexOf("#"),i=e.href.substr(0,t);navigator.registerProtocolHandler("mailto",i+"#app="+ox.registry.get("mail-compose")+":compose&mailto=%s",ox.serverConfig.productNameMail)}}}});