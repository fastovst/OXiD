define("io.ox/mail/compose/resize",["io.ox/contacts/widgets/canvasresize","io.ox/core/tk/image-util","settings!io.ox/mail"],function(e,i,t){"use strict";var n={getDimensions:function(e){return i.getImageFromFile(e,{exif:!0}).then(function(e){return{width:e.width,height:e.height}})},addDimensionsProperty:function(e){return e._dimensions?$.Deferred().resolve(e._dimensions):n.getDimensions(e).then(function(i){return e._dimensions=i,e})},getTargetDimensions:function(e,i){var t=e._dimensions;if(t){var n=Math.max(t.width||-1,t.height||-1),r=i/n;return i>=n?t:{width:Math.round(t.width*r),height:Math.round(t.height*r)}}},resizeRecommended:function(e){return n.matches("type",e)&&n.matches("size",e)&&n.matches("dimensions",e)},matches:function(){var e=/^image\/(jpg|jpeg|png)/i,i=t.get("features/imageResize/imageSizeThreshold",1024),n=t.get("features/imageResize/fileSizeMax",10485760);return function(t,r,s){var a=_.extend({dimensions:r._dimensions||{},target:void 0},s),o=Math.max(a.dimensions.width||-1,a.dimensions.height||-1);switch(t){case"type":return e.test(r.type);case"size":return r.size<=n;case"dimensions":return!(a.target&&a.target>=o)&&i<o}}}(),containsResizables:function(e){var i=[],t=_.chain(e).map(function(e){return e.get?e.get("originalFile"):e}).compact().filter(function(e){return n.matches("type",e)}).value();return _.each(t,function(e){i.push(n.addDimensionsProperty(e))}),$.when.apply($,i).then(function(){return _.some(t,function(e){return n.resizeRecommended(e)})})},resizeImage:function(i,n){if(n){var r=$.Deferred(),s=t.get("features/imageResize/quality",.75);return e(i,{width:n.width,height:n.height,crop:!1,quality:100*s}).then(function(e){for(var t,n=atob(e.split(",")[1]),s=n.length,a=new window.Uint8Array(s),o=i.type||"image/png",h=_(o.split("/")).last(),m=_(i.name.split(".")).initial(),u=0;u<s;u++)a[u]=n.charCodeAt(u);(t=new Blob([a],{type:o,filename:m+"."+h})).lastModifiedDate=new Date,t.name=m+"."+h,t.filename=m+"."+h,t.group="localFile",r.resolve(t)}),r}}};return n});