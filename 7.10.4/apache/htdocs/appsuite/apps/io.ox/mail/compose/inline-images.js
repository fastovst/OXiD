define("io.ox/mail/compose/inline-images",["io.ox/core/extensions","io.ox/backbone/views/modal","io.ox/core/tk/attachments","io.ox/core/notifications","io.ox/core/http","gettext!io.ox/mail"],function(e,i,t,n,o,a){"use strict";var r={inlineImage:function(e){try{var i=e.editor||window.tinyMCE&&window.tinyMCE.activeEditor;if("FormData"in window){if(0===e.file.size&&""===e.file.type&&!e.file.name)return $.Deferred().reject({error:{},message:a("One of the embedded images could not be used.")});var t=new FormData;if(e.file.name)t.append("file",e.file);else{var n=e.file.type.replace("image/","")||"png";t.append("file",e.file,"image."+n)}return o.UPLOAD({module:"file",params:{action:"new",module:"mail",type:"image"},data:t,fixPost:!0}).done(function(e){i&&$(i.getElement()).trigger("addInlineImage",e.data[0])})}return o.FORM({module:"file",form:e.form,params:{module:"mail",type:"image"}}).done(function(e){i&&$(i.getElement()).trigger("addInlineImage",e.data[0])})}catch(e){return console.debug(e),$.Deferred().reject({error:e,message:a("Error while uploading your image")})}},getInsertedImageUrl:function(e){return ox.apiRoot+"/file"+"?"+$.param({action:"get",id:e.data[0],session:ox.session})}},l="io.ox/mail/compose/inline-images/";return e.point(l+"title").extend({id:"default",draw:function(){this.$title.text(a("Insert inline image"))}}),e.point(l+"file_upload").extend({id:"default",draw:function(e){e.$.file_upload=t.fileUploadWidget(),this.append(e.$.file_upload)}}),e.point(l+"buttons").extend({id:"default",draw:function(){this.addCancelButton().addButton({label:a("Insert"),action:"insert"})}}),{api:r,show:function(){var t,o=new i({async:!0}),d=new e.Baton({$:{}}),s=$.Deferred();return o.build(function(){t=$('<form accept-charset="UTF-8" enctype="multipart/form-data" method="POST">'),this.$body.append(t),e.point(l+"title").invoke("draw",this.$title,d),e.point(l+"file_upload").invoke("draw",t,d),e.point(l+"buttons").invoke("draw",this,d),this.$el.addClass("inline-images").parent().css("z-index",999999)}),o.on("insert",function(){var e=d.$.file_upload.find("input[type=file]"),i=this;if(i.busy(),/\.(gif|bmp|tiff|jpe?g|gmp|png|heic?f?)$/i.test(e.val()))return r.inlineImage({file:e[0].files?e[0].files[0]:[],form:t}).then(function(e){i.close(),s.resolve(r.getInsertedImageUrl(e))}).fail(function(e){e&&e.error&&n.yell("error",e.error),i.idle()});n.yell("error",a("Please select a valid image File to insert")),i.idle(),s.reject()}).open(),s}}});