define("io.ox/mail/compose/signatures",["io.ox/core/extensions","io.ox/backbone/mini-views/dropdown","io.ox/mail/util","io.ox/core/tk/textproc","settings!io.ox/mail","gettext!io.ox/mail"],function(t,e,i,n,r,s){"use strict";var o={getRaw:function(t){var e=$("<div>").html(t.content).text();return o.stripWhitespace(e)},stripWhitespace:function(t){return t.replace(/\s+/g,"")},looksLikeHTML:function(t){return/(<\/?\w+(\s[^<>]*)?>)/.test(t)},lookLikePlainTextWithHTML:function(t){return/^([^<>]|<\/?a>|<a [^>]+>)*$/.test(t)},cleanUpWhiteSpace:function(t){return String(t||"").replace(/(\r\n|\n|\r)/g,"\n").replace(/[\t\f\v ][\t\f\v ]+/g," ").trim()},cleanUp:function(t,e){var i=o.looksLikeHTML(t),r=$("<div>")[i?"html":"text"](o.cleanUpWhiteSpace(t)).html();return o.lookLikePlainTextWithHTML(r)&&(r="<pre>"+r+"</pre>"),!e&&i?n.htmltotext(r):r}};return{extensions:{menu:function(t){function i(e){r.prepareReuse(),r.option("signatureId","",s("No signature")),r.$ul.addClass("pull-right"),e.each(function(t){r.option("signatureId",t.get("id"),t.get("displayname"))}),r.divider(),r.link("settings",s("Manage signatures"),function(){var e={id:"io.ox/mail/settings/signatures"};ox.launch("io.ox/settings/main",e).done(function(){t.view.app.getWindow().floating&&t.view.app.getWindow().floating.onMinimize(),this.setSettingsPane(e)})}),r.$ul.addClass("pull-right"),r.render()}if(!_.device("smartphone")){var n=this,r=new e({model:t.config,label:s("Signatures"),caret:!0});t.view.signaturesLoading.done(function(e){var n=i.bind(null,e);t.view.listenTo(e,"add remove reset",n),n()}),n.append(r.$el.addClass("signatures text-left"))}}},util:o,model:{setInitialSignature:function(t){var e,i=this.get("signatures"),n=t.get("content");this.is("edit|copy")||t.restored?(e=i.find(function(t){var e=o.getRaw(t.toJSON());if(!_.isEmpty(e)){if("html"===this.get("editorMode")){var i=$("<div>").append(n).children('div[class$="io-ox-signature"]:last');return o.stripWhitespace(i.text())===e}return o.stripWhitespace(n).indexOf(e)>-1}}.bind(this)))&&(this.set("signatureIsRendered",!0),this.set("signatureId",e.id,{silent:!1})):this.set("signatureId",this.getDefaultSignatureId())},getDefaultSignatureId:function(){return _.device("smartphone")?"custom"===r.get("mobileSignatureType","none")?"0":"":i.getDefaultSignature(this.get("type"))},getSignatureById:function(t){return t=String(t),this.get("signatures").find(function(e){return e.get("id")===t})}},view:{getSignatureContent:function(){return r.get("forwardunquoted",!1)&&this.config.is("forward")?this.editor.find('div[class$="io-ox-signature"]'):this.editor.children('div[class$="io-ox-signature"]')},updateSignatures:function(){var t=this.config.get("signature");if(t){var e=this.config.getSignatureById(t.id);if(t.content!==e.content){if(!!this.editor.find)this.getSignatureContent().each(function(){var t=$(this),i=t.text();o.getRaw(e)===o.stripWhitespace(i)&&t.empty().append($(e.content))});else{var i=o.cleanUp(t.content,!1),n=o.cleanUp(e.content,!1);this.editor.replaceParagraph(i,n)}this.config.set("signature",e)}}},setSignature:function(t,e){var i=this.config.get("signatures").findWhere({id:e}),n=""===e;(i||n)&&(this.config.set("signature",i?i.toJSON():null,{silent:!!this.config.get("signatureIsRendered")}),this.config.unset("signatureIsRendered"))},redrawSignature:function(t,e){var i=this.config&&this.config.previous("signature");i&&this.removeSignature(i),e&&this.appendSignature(e)},removeSignature:function(t){if(!(t=_.isString(t)?this.config.getSignatureById(t):t)){if(!this.config.get("signature"))return;t=this.config.get("signature")}var e=this,i=!!this.editor.find,n=o.cleanUp(t.content,i);if(i)this.getSignatureContent().each(function(){var t=$(this),i=t.text();e.config.get("signatures").find(function(t){return o.getRaw(t.toJSON())===o.stripWhitespace(i)})?t.remove():t.removeAttr("class")});else if(n){var r="below"===t.misc.insertion?"\n\n"+n:n+"\n\n";this.editor.replaceParagraph(r,"")}},appendSignature:function(t){var e,i=!!this.editor.find;!(!/<img\s[^>]*?src\s*=\s*['"]([^'"]*?)['"][^>]*?>/.test(t.content||"")&&!n.htmltotext(t.content).trim())&&this.config.get("signatures").length&&(e=o.cleanUp(t.content,i),i&&(e=this.getParagraph(e,o.looksLikeHTML(e))),"below"===t.misc.insertion?(_.bind(this.editor.insertPostCite||this.editor.appendContent,this.editor)(e),this.editor.scrollTop("bottom")):(_.bind(this.editor.insertPrevCite||this.editor.prependContent,this.editor)(e),this.editor.scrollTop("top")))}}}});