define("io.ox/mail/compose/bundle",[],function(){"use strict";var e=define.amd;delete define.amd,define("io.ox/mail/compose/actions",["io.ox/backbone/views/actions/util","io.ox/core/download"],function(e,t){new e.Action("io.ox/mail/compose/actions/download",{device:"!ios || ios >= 12",collection:"some",action:function(e){t.composeAttachment(e.first())}})}),define("io.ox/mail/compose/actions/extensions",["io.ox/mail/actions/attachmentEmpty","io.ox/mail/api","io.ox/mail/compose/api","gettext!io.ox/mail","settings!io.ox/mail","io.ox/core/yell"],function(e,t,i,n,o,a){var s={};return s.emptyAttachmentCheck=function(t){var i=t.model.get("attachments").chain().pluck("originalFile").compact().value();return e.emptinessCheck(i).then(_.identity,function(){throw t.stopPropagation(),arguments})},s.waitForPendingUploads=function(e){var t=e.model.get("attachments").chain().map(function(t){if(!(t.get("uploaded")>=1)){var i=new $.Deferred;return t.trigger("force:upload"),t.once("upload:complete",i.resolve),t.once("upload:failed",function(t){e.stopPropagation(),i.reject(t)}),i}}).compact().value();if(!(t.length<=0))return $.when.apply($,t).then(function(){e.view.syncMail()})},s.removeUnusedInlineImages=function(e){var n=e.model.get("attachments").where({contentDisposition:"INLINE"}),o=_(n).chain().map(function(n){var o=e.model.get("id"),a=t.getUrl(_.extend({space:o},n),"view").replace("?","\\?");if(!new RegExp('<img[^>]*src="'+a+'"[^>]*>').test(e.model.get("content"))&&!new RegExp('<img[^>]*src="[^"]*'+n.get("id")+'"[^>]*>').test(e.model.get("content")))return i.space.attachments.remove(o,n.get("id"))}).compact().value();return $.when.apply($,o)},s.checkForAutoEnabledDriveMail=function(e){return e=_.extend({yell:!1,restoreWindow:!1,stopPropagation:!1,removeQueue:!1},e),function(t){if(o.get("compose/shareAttachments/threshold",0)>0){var s=t.model,r=s.get("sharedAttachments")||{};if(s.get("attachments").getSize()>o.get("compose/shareAttachments/threshold",0)&&!1===r.enabled)throw e.yell&&a("info",n("Attachment file size too large. You have to use %1$s or reduce the attachment file size.",o.get("compose/shareAttachments/name"))),s.set("sharedAttachments",_.extend({},r,{enabled:!0})),e.stopPropagation&&t.stopPropagation(),e.restoreWindow&&t.app.getWindow().idle().show(),e.removeQueue&&i.queue.remove(t.model.get("id")),arguments}}},s.attachmentMissingCheck=function(e){if(!(e.model.get("attachments").length>=1)){var t=n("see attached|see attachment|see included|is attached|attached is|are attached|attached are|attached to this email|attached to this message|I'm attaching|I am attaching|I've attached|I have attached|I attach|I attached|find attached|find the attached|find included|find the included|attached file|see the attached|see attachments|attached files|see the attachment"),i=_((t+"|see attached|see attachment|see included|is attached|attached is|are attached|attached are|attached to this email|attached to this message|I'm attaching|I am attaching|I've attached|I have attached|I attach|I attached|find attached|find the attached|find included|find the included|attached file|see the attached|see attachments|attached files|see the attachment|siehe Anhang|angehängt|anbei|hinzugefügt|ist angehängt|angehängt ist|sind angehängt|angehängt sind|an diese E-Mail angehängt|an diese Nachricht angehängt|Anhang hinzufügen|Anhang anbei|Anhang hinzugefügt|anbei finden|anbei|im Anhang|mit dieser E-Mail sende ich|angehängte Datei|siehe angehängte Datei|siehe Anhänge|angehängte Dateien|siehe Anlage|siehe Anlagen").split("|")).chain().compact().uniq().value().join("|"),o=(e.model.get("subject")||"")+"|";"html"===e.view.editor.getMode()?o+=$(e.view.editor.getContent()).not("blockquote,.io-ox-signature").text():o+=e.view.editor.getContent().replace(/^>.*\n/gm,"");var a=new RegExp("("+i+")","i").exec(o);if(a){var s=$.Deferred();return require(["io.ox/backbone/views/modal"],function(t){new t({title:n("Forgot attachment?"),focus:".btn-primary"}).on("add",function(){this.previousFocus=$('[data-extension-id="add_attachments"] > div > a[role="button"]'),e.stopPropagation(),s.reject()}).on("send",function(){s.resolve()}).addButton({action:"send",label:n("Send without attachment")}).addAlternativeButton({action:"add",label:n("Cancel")}).build(function(){this.$body.append($("<div>").append($("<p>").text(n("It appears as if you forgot to attach a file.")),$("<p>").text(n.format(n('You mentioned "%s" in your email, but there are no files attached.'),a[1]))))}).open()}),s}}},s}),define("io.ox/mail/compose/actions/save",["io.ox/core/extensions","io.ox/mail/compose/actions/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/notifications"],function(e,t,i,n,o){e.point("io.ox/mail/compose/actions/save").extend({id:"metrics",index:100,perform:function(){require(["io.ox/metrics/main"],function(e){e.trackEvent({app:"mail",target:"compose/toolbar",type:"click",action:"saveDraft"})})}},{id:"check:attachment-empty",index:150,perform:t.emptyAttachmentCheck},{id:"wait-for-pending-uploads",index:200,perform:t.waitForPendingUploads},{id:"remove-unused-inline-images",index:300,perform:t.removeUnusedInlineImages},{id:"check-for-auto-enabled-drive-mail",index:400,perform:t.checkForAutoEnabledDriveMail({yell:!0})},{id:"send",index:1e3,perform:function(e){return e.model.saveDraft().then(function(t){e.msgref=t.data})}},{id:"error",index:1100,perform:function(e){if(e.error)return o.yell("error",e.error),e.stopPropagation(),(new $.Deferred).reject(e.error)}},{id:"reload",index:1200,perform:function(e){var t=n.parseMsgref(i.separator,e.msgref);switch(e.model.get("contentType")){case"text/plain":t.view="raw";break;case"text/html":case"ALTERNATIVE":t.view="html"}return i.get(t).then(function(t){e.mail=t})}},{id:"reloadError",index:1300,perform:function(e){if(e.error)return o.yell("error",e.error),e.stopPropagation(),(new $.Deferred).reject(e.error)}})}),define("io.ox/mail/compose/actions/send",["io.ox/core/extensions","io.ox/mail/compose/actions/extensions","io.ox/mail/compose/api","io.ox/mail/api","settings!io.ox/mail","io.ox/core/notifications","gettext!io.ox/mail"],function(e,t,i,n,o,a,s){e.point("io.ox/mail/compose/actions/send").extend({id:"metrics",index:100,perform:function(){require(["io.ox/metrics/main"],function(e){e.trackEvent({app:"mail",target:"compose/toolbar",type:"click",action:"send"})})}},{id:"check:no-recipients",index:200,perform:function(e){if(_.isEmpty(e.model.get("to"))&&_.isEmpty(e.model.get("cc"))&&_.isEmpty(e.model.get("bcc")))return a.yell("error",s("Mail has no recipient.")),e.view.$el.find(".tokenfield:first .token-input").focus(),e.stopPropagation(),$.Deferred().reject()}},{id:"check:no-subject",index:300,perform:function(e){if(""===$.trim(e.model.get("subject"))){var t=$.Deferred();return require(["io.ox/backbone/views/modal"],function(i){new i({title:s("Empty subject"),description:s("This email has no subject. Do you want to send it anyway?")}).addAlternativeButton({label:s("Send without subject"),className:"btn-default",action:"send"}).addButton({label:s("Add subject"),action:"subject"}).on("send",function(){t.resolve()}).on("subject",function(){e.stopPropagation(),setTimeout(function(){e.view.$el.find('input[name="subject"]').focus()},200),t.reject()}).open()}),t}}},{id:"check:attachment-empty",index:350,perform:t.emptyAttachmentCheck},{id:"check:attachment-missing",index:400,perform:t.attachmentMissingCheck},{id:"busy:start",index:500,perform:function(e){var t=e.app.getWindow();i.queue.add(e.model,function(){e.stopPropagation(),a.yell(s("error","The sending of the message has been canceled.")),i.queue.remove(e.model.get("id")),e.app.getWindow().idle().show()}),t&&(t.busy(),t.preQuit())}},{id:"wait-for-pending-uploads",index:600,perform:t.waitForPendingUploads},{id:"remove-unused-inline-images",index:700,perform:t.removeUnusedInlineImages},{id:"check-for-auto-enabled-drive-mail",index:800,perform:t.checkForAutoEnabledDriveMail({yell:!0,restoreWindow:!0,stopPropagation:!0,removeQueue:!0})},{id:"send",index:2e3,perform:function(e){return e.model.send()}},{id:"errors",index:3e3,perform:function(e){if(!e.error||e.warning);else{var t=e.app.getWindow(),i="abort"===e.error?s("The sending of the message has been canceled."):e.error;if(t&&(e.close&&e.close.show(),e.launcherClose&&e.launcherClose.show(),t.idle().show()),"MSGCS-0007"===e.errorCode||"MSGCS-0011"===e.errorCode)return;a.yell("error",i)}}},{id:"warnings",index:3100,perform:function(e){if(!e.errors&&e.warning){var t=e.warning.error||e.warning;a.yell("warning",t),e.view.dirty(!1),e.app.quit()}}},{id:"success",index:4e3,perform:function(e){e.error||e.warning||(o.get("features/notifyOnSent",!1)&&a.yell("success",s("The email has been sent")),e.view.dirty(!1),e.config.set("autoDismiss",!0),e.app.quit())}},{id:"update-caches",index:4100,perform:function(e){var t=e.model.get("meta"),i=!!t.replyFor,o=!!t.forwardsFor;(i||o)&&[].concat(t.replyFor,t.forwardsFor).filter(Boolean).forEach(function(e){var t=n.pool.get("detail").get(_.cid({id:e.originalId,folder_id:e.originalFolderId}));if(t){var a=t.get("flags");i&&(a|=1),o&&(a|=256),t.set("flags",a)}})}})}),define("io.ox/mail/compose/api",["io.ox/core/http","io.ox/contacts/api"],function(e,t){function i(t,i,n){var o=new FormData;o.append("contentDisposition",(n||"attachment").toUpperCase()),i.file?i.file.name?o.append("file",i.file,i.file.name):o.append("file",i.file):o.append("JSON",JSON.stringify(i));var a=e.UPLOAD({url:t,data:o}),s=a.then(function(e){return e.data});return s.abort=a.abort,s}var n={};return _.extend(n,Backbone.Events),n.queue=function(){function e(e,t){return t?Math.max(0,Math.min(100,Math.round(e/t*100)))/100:0}return{collection:(new Backbone.Collection).on("add remove change:pct",function(){var t=0,i=0,n=[];this.each(function(e){t+=e.get("loaded"),i+=e.get("total"),e.get("loaded")<e.get("total")&&n.push({abort:e.get("abort")})}),this.trigger("progress",{count:this.length,loaded:t,pct:e(t,i),total:i,abort:_.invoke.bind(_,n,"abort")})}),add:function(t,i){if(!this.collection.get(t.get("id"))){var n=t.get("id"),o=t.get("attachments"),a=o.filter(function(e){return e.get("uploaded")<1}),s=a.reduce(function(e,t){return e+t.get("uploaded")},0),r=a.length+1,l=new Backbone.Model({id:n,loaded:s,pct:e(s,r),total:r,abort:i});o.on("change:uploaded",function(t){var i=l.get("loaded");i+=t.get("uploaded")-t.previous("uploaded"),l.set({loaded:i,pct:e(i,r)})}),this.collection.add(l)}},remove:function(e){var t=this.collection.get(e);this.collection.remove(t)},update:function(t,i,n,o){var a=this.collection.get(t);if(a){var s=a.get("total")-1+i/n;o=o||a.get("abort"),a.set({loaded:s,pct:e(s,a.get("total")),abort:o})}}}}(),n.space={add:function(t,i){var n=JSON.stringify([].concat(t.original||[]));return e.POST({module:"mail/compose",data:n,params:{type:t.type,vcard:!!i.vcard,originalAttachments:i.attachments},contentType:"application/json"})},get:function(t){return e.GET({url:"api/mail/compose/"+t})},list:function(){return e.GET({url:"api/mail/compose"})},remove:function(t){return e.DELETE({url:"api/mail/compose/"+t}).then(function(e){return e&&e.success?e:$.Deferred().reject({action:"remove",error:"unknown",id:t})})},reset:function(){return n.space.list().then(function(e){return _(e).map(function(e){return n.space.remove(e)}),$.when.apply($,e)})},send:function(i,o,a){o=_(o).clone(),n.trigger("before:send",i,o),ox.trigger("mail:send:start",o),o.sharedAttachments&&o.sharedAttachments.expiryDate&&(o.sharedAttachments=_(o.sharedAttachments).clone(),o.sharedAttachments.expiryDate=_.now()+parseInt(o.sharedAttachments.expiryDate,10));var s=new FormData;s.append("JSON",JSON.stringify(o)),(a||[]).forEach(function(e,t){e.name?s.append("file_"+t,e,e.name):s.append("file_"+t,e)});var r=e.UPLOAD({url:"api/mail/compose/"+i+"/send",data:s,params:{force_json_response:!0}});return r.progress(function(e){n.queue.update(i,e.loaded,e.total,r.abort)}).fail(function(){ox.trigger("mail:send:fail")}).always(function(){n.queue.remove(i)}).done(function(e){t.trigger("maybeNewContact"),n.trigger("after:send",o,e),ox.trigger("mail:send:stop",o),o.sharedAttachments&&o.sharedAttachments.enabled&&ox.trigger("please:refresh refresh^")}),r},save:function(t,i,o){n.trigger("before:save",t,i);var a=new FormData;return a.append("JSON",JSON.stringify(i)),(o||[]).forEach(function(e,t){e.name?a.append("file_"+t,e,e.name):a.append("file_"+t,e)}),e.UPLOAD({url:"api/mail/compose/"+t+"/save",data:a}).done(function(e){n.trigger("after:save",i,e)})},update:function(t,i){return e[_.browser.ie?"PUT":"PATCH"]({url:"api/mail/compose/"+t,data:$.extend({},i)})}},n.space.attachments={original:function(t){return e.POST({url:ox.apiRoot+"/mail/compose/"+t+"/attachments/original"})},vcard:function(t){return e.POST({url:ox.apiRoot+"/mail/compose/"+t+"/attachments/vcard"})},add:function(e,t,n){return i(ox.apiRoot+"/mail/compose/"+e+"/attachments",t,n)},update:function(e,t,n,o){return i(ox.apiRoot+"/mail/compose/"+e+"/attachments/"+o,t,n)},get:function(t,i){return e.GET({url:ox.apiRoot+"/mail/compose/"+t+"/attachments/"+i})},remove:function(t,i){return e.DELETE({url:ox.apiRoot+"/mail/compose/"+t+"/attachments/"+i})}},n}),define("io.ox/mail/compose/checks",["io.ox/mail/api","io.ox/mail/util","io.ox/backbone/views/modal","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,n,o){function a(e){if(!e)return null;var t=s(e.headers);return t||(_.isEmpty(e.from)?null:e.from[0])}function s(e){if(!e)return null;var i=$.trim(e["Reply-To"]);return i?t.parseRecipient(i):null}function r(e){return e&&e.headers&&_.isString(e.headers["List-Post"])?e.headers["List-Post"].replace(/^.*<mailto:(.+)>.*$/i,"$1").toLowerCase():""}return{isMailingList:function(e){if(!e||!e.headers)return!1;for(var t in e.headers)if(/^list-(id|archive|owner)$/i.test(t))return!0;return!1},replyToMailingList:function(s,l){if(!n.get("confirmReplyToMailingLists",!0))return $.when(l);var d=e.pool.get("detail").get(s);if(!d)return $.when(l);if(!this.isMailingList(d.toJSON()))return $.when(l);var c=a(d.toJSON());if(!c)return $.when(l);var u=$.Deferred(),h="<b>"+_.escape(r(d.toJSON()))+"</b>",p="<b>"+_.escape(t.getDisplayName(c,{showMailAddress:!0}))+"</b>";return new i({title:o("Reply to mailing list"),easyOut:!1,description:[$("<p>").html(h?o("This message was sent via the mailing list %1$s.",h):o("This message was sent via a mailing list.")),$("<p>").html(o("Do you really want to reply all or just %1$s?",p))]}).addCancelButton({left:!0}).addButton({label:o("Reply all"),action:"reply-all"}).addButton({label:o("Reply to sender"),action:"reply"}).on("reply-all",function(){u.resolve("replyall")}).on("reply",function(){u.resolve("reply")}).on("cancel",function(){u.reject()}).open(),u}}}),define("io.ox/mail/compose/config",["settings!io.ox/mail","io.ox/mail/util","io.ox/mail/compose/signatures"],function(e,t,i){return Backbone.Model.extend({defaults:function(){return{type:"new",autoDiscard:!0,autoDismiss:!1,preferredEditorMode:_.device("smartphone")?"html":e.get("messageFormat","html"),editorMode:_.device("smartphone")?"html":e.get("messageFormat","html"),sendDisplayName:!!e.get("sendDisplayName",!0),defaultSignatureId:"",signatureId:"",signature:"",signatureIsRendered:void 0,imageResizeOption:""}},initialize:function(){_.extend(this,i.model,this)},is:function(e){return new RegExp("^("+e+")$").test(this.get("type"))}})}),define("io.ox/mail/compose/extensions",["io.ox/mail/api","io.ox/mail/sender","io.ox/backbone/mini-views/common","io.ox/backbone/mini-views/dropdown","io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/core/tk/tokenfield","io.ox/core/dropzone","io.ox/core/capabilities","io.ox/mail/actions/attachmentQuota","io.ox/core/util","io.ox/core/attachments/view","io.ox/mail/compose/util","io.ox/mail/util","settings!io.ox/mail","gettext!io.ox/mail","settings!io.ox/contacts","io.ox/core/attachments/backbone","io.ox/core/strings","io.ox/mail/compose/resize-view","io.ox/mail/compose/resize","static/3rd.party/jquery-ui.min.js"],function(e,t,i,n,o,a,s,r,l,d,c,u,h,p,m,f,g,v,b,x,y){var w="io.ox/mail/compose",k={to:f("To"),pickerto:f("Select contacts"),ariato:f("%1$s autocomplete token field. Use left and right Arrowkeys to navigate between the tokens",f("To")),cc:f("CC"),pickercc:f("Select CC contacts"),ariacc:f("%1$s autocomplete token field. Use left and right Arrowkeys to navigate between the tokens",f("CC")),bcc:f("BCC"),pickerbcc:f("Select BCC contacts"),ariabcc:f("%1$s autocomplete token field. Use left and right Arrowkeys to navigate between the tokens",f("BCC")),reply_to:f.pgettext("compose","Reply to")},C=function(e,t){t=t.target?t.target.files:t;var i=this,n=e.get("attachments").filter(function(e){return void 0!==e.get("size")}).map(function(e){return e.get("size")}).reduce(function(e,t){return e+t},0);if(d.checkQuota(t,n)){i.trigger("aria-live-update",f("Added %s to attachments.",_(t).map(function(e){return e.name}).join(", ")));var o=_(t).map(function(t){var i=new v.Model({filename:t.name,origin:{file:t}});return h.uploadAttachment({model:e,filename:t.filename,origin:{file:t},attachment:i}),i});e.attachFiles(o)}},S=Backbone.Model.extend({initialize:function(e){this.config=e.config,this.model=e.model,this.configFields=e.configFields,this.modelFields=e.modelFields,delete this.attributes.config,delete this.attributes.model,delete this.attributes.configFields,delete this.attributes.modelFields,this.listenTo(this.config,this.configFields.map(this.changeMapper).join(" "),this.getData),this.listenTo(this.model,this.modelFields.map(this.changeMapper).join(" "),this.getData),this.getData(),this.on("change",this.updateModels)},changeMapper:function(e){return"change:"+e},getData:function(){this.configFields.forEach(function(e){this.set(e,this.config.get(e))}.bind(this)),this.modelFields.forEach(function(e){this.set(e,this.model.get(e))}.bind(this))},updateModels:function(){_(this.changed).forEach(function(e,t){return this.configFields.indexOf(t)>=0?this.config.set(t,e):this.modelFields.indexOf(t)>=0?this.model.set(t,e):void 0}.bind(this))}}),A=Backbone.DisposableView.extend({className:"row sender",attributes:{"data-extension-id":"sender"},initialize:function(e){this.config=e.config,this.dropdown=new n({model:new S({model:this.model,config:this.config,configFields:["sendDisplayName","editorMode"],modelFields:["from"]}),label:this.getItemNode.bind(this),aria:f("From"),caret:!0}),this.listenTo(ox,"account:create account:delete",this.onAccountUpdate.bind(this)),this.listenTo(ox,"change:customDisplayNames",this.onSenderUpdate.bind(this)),this.listenTo(this.model,"change:from",this.onSenderUpdate),this.listenTo(this.config,"change:sendDisplayName",function(e,t){m.set("sendDisplayName",t)})},onAccountUpdate:function(){_.delay(function(){this.updateSenderList({useCache:!1}).then(this.renderDropdown.bind(this))}.bind(this),1e3)},onSenderUpdate:function(){this.renderDropdown()},updateSenderList:function(e){var i=_.extend({useCache:!1},e);return t.getAddressesOptions(i).then(function(e){this.list=e,this.list.sortedAddresses.forEach(function(e){var t=e.option;m.get(["customDisplayNames",t[1],"defaultName"])||m.set(["customDisplayNames",t[1],"defaultName"],t[0])})}.bind(this))},render:function(){return this.$el.empty().append($('<label class="maillabel col-xs-2">').text(f("From")),$('<div class="mail-input col-xs-10">').append(this.dropdown.render().$el.attr({"data-dropdown":"from"}))),this.updateSenderList().then(this.renderDropdown.bind(this)),this},renderDropdown:function(){var e=this.model.get("from")?this.model.get("from")[1]:void 0;this.dropdown.$ul.empty().css("width","auto"),this.setDropdownOptions(),this.dropdown.$toggle.find(".dropdown-label").empty().append(this.getItemNode()),this.dropdown.$toggle.attr("href",e?"mailto:"+e:"#"),this.dropdown.$el.hasClass("open")&&this.dropdown.adjustBounds(),this.dropdown.$ul.find('[data-name="sendDisplayName"]').focus()},setDropdownOptions:function(){var e=this;if(this.list&&this.list.sortedAddresses.length){var t=m.get("defaultSendAddress","").trim(),i=_(this.list.sortedAddresses).chain().map(function(t){var i=p.getSender(t.option,e.config.get("sendDisplayName"));return{key:_(i).compact().join(" ").toLowerCase(),array:i}}).sortBy("key").pluck("array").value();i=_(i).filter(function(n){return n[1]!==t||(e.dropdown.option("from",n,function(){return e.getItemNode(n)}),i.length>1&&e.dropdown.divider(),!1)}),_(i).each(function(t){e.dropdown.option("from",t,function(){return e.getItemNode(t)})}),_.device("smartphone")||this.dropdown.divider().option("sendDisplayName",!0,f("Show names"),{keepOpen:!0}).divider().link("edit-real-names",f("Edit names"),this.onEditNames)}},getItemNode:function(e){if(e=e||this.model.get("from")){var t=e[0],i=e[1];return[$('<span class="name">').text(t?t+" ":""),$('<span class="address">').text(t?"<"+i+">":i)]}},onEditNames:function(){require(["io.ox/mail/compose/names"],function(e){e.open()})}});return{header:function(e){if(e.view.app.getWindow()){var t=$('<div data-extension-id="header">');e.$header=t,o.point(w+"/header").invoke("draw",t,e),e.view.app.getWindow().setHeader(t)}},title:function(){this.append($('<h1 class="sr-only">').text(f("Compose new email")))},buttons:{discard:function(e){return $('<button type="button" class="btn btn-default" data-action="discard">').on("click",function(){e.view.app.quit()}).text(f(e.model.keepDraftOnClose()?"Delete":"Discard")).appendTo(this)},send:function(e){this.append($('<button type="button" class="btn btn-primary" data-action="send">').on("click",function(){e.view.send()}).on("keyup",function(t){27===t.which&&e.view.focusEditor()}).text(f("Send")))}},inlineYell:function(){this.append($('<div role="log" aria-live="polite" class="inline-yell">'))},sender:function(e){var t=new A({model:e.model,config:e.config});this.append(t.render().$el)},senderRealName:function(e){function t(){i.toggleClass("no-realname",!n.get("sendDisplayName"))}var i=this,n=e.config;n.on("change:sendDisplayName",t),t(),this.append($('<div class="row sender-realname" data-extension-id="sender-realname">').append($('<div class="mail-input col-xs-10 col-xs-offset-2">').text(f("This email just contains your email address as sender. Your real name is not used."))))},recipientActionLink:function(e){return function(){var t=$('<button type="button" class="btn btn-link" data-action="add">');"cc"===e?t.attr({"data-type":"cc",title:f("Show carbon copy input field")}).text(f("CC")):t.attr({"data-type":"bcc",title:f("Show blind carbon copy input field")}).text(f("BCC")),this.append(t)}},recipientActionLinkMobile:function(){var e=$('<a href="#" data-action="add" role="checkbox" aria-checked="false">').append($('<span class="fa fa-angle-right" aria-hidden="true">'));this.append(e)},recipientActions:function(){var e=$('<div class="recipient-actions">');_.device("!smartphone")?o.point(w+"/recipientActionLink").invoke("draw",e):o.point(w+"/recipientActionLinkMobile").invoke("draw",e),this.append(e)},tokenfield:function(e){function t(e){e.preventDefault();var t=e.data.attr,i=e.data.model;require(["io.ox/contacts/addressbook/popup"],function(e){e.open(function(e){var n=i.get(t)||[];i.set(t,n.concat(_(e).pluck("array")))})})}if("reply_to"!==e||!1!==m.get("showReplyTo/configurable",!1))return function(i){var n,a=_.uniqueId("form-control-label-"),r=i.model.get(e)||[],d="row"+(/cc$/.test(e)&&!r.length?" hidden":""),u=!1,h=new s({id:a,className:e,extPoint:w+"/"+e,isMail:!0,apiOptions:{users:!0,limit:m.get("compose/autocompleteApiLimit",20),contacts:!0,distributionlists:!0,emailAutoComplete:!0},keepInComposeWindow:!0,maxResults:m.get("compose/autocompleteDrawLimit",30),placeholder:k[e],ariaLabel:k["aria"+e]}),p=$('<div class="mail-input col-xs-10">').append(h.$el);"to"===e&&o.point(w+"/recipientActions").invoke("draw",p);var v=!_.device("smartphone")&&l.has("contacts")&&g.get("picker/enabled",!0);v&&p.addClass("has-picker").append($('<a href="#" role="button" class="open-addressbook-popup">').append($('<i class="fa fa-address-book" aria-hidden="true">').attr("title",k["picker"+e])).attr("aria-label",k["picker"+e]).on("click",{attr:e,model:i.model},t));var b=f("Select contacts");this.append(n=$('<div data-extension-id="'+e+'">').addClass(d).append(v?$('<div class="maillabel col-xs-2">').append($('<a href="#" role="button">').text(k[e]).attr({"aria-label":b,title:b}).on("click",{attr:e,model:i.model},t).tooltip({animation:!1,delay:0,placement:"right",trigger:"hover"})):$('<label class="maillabel col-xs-2">').text(k[e]).attr({for:a})).append(p)),h.render().$el.on("tokenfield:createdtoken",function(e){o.point(w+"/createtoken").invoke("action",this,_.extend(i,{event:e}))}).on("tokenfield:next",function(){n.nextAll().find('input.tt-input,input[name="subject"]').filter(":visible").first().focus()}).on("tokenfield:removetoken",function(e){o.point(w+"/removetoken").invoke("action",this,_.extend(i,{event:e}))}),h.listenTo(i.model,"change:"+e,function(e,t){if(!u){var i=_(t).map(function(e){var t=c.removeQuotes(e[0]),i=e[1];return{type:5,display_name:t,email1:i,image1_url:e[2],token:{label:t,value:i}}});this.collection.reset(i)}}),i.model.trigger("change:"+e,i.model,i.model.get(e)),h.collection.on("change reset add remove sort",_.debounce(function(){var t=this.map(function(e){var t=e.get("token");return[c.removeQuotes(t.label),t.value]});u=!0,i.model.set(e,t),u=!1}.bind(h.collection)),20),i.view.on("updateTokens",function(){var t=this.map(function(e){var t=e.get("token");return[c.removeQuotes(t.label),t.value]});u=!0,i.model.set(e,t),u=!1}.bind(h.collection)),i.view.app.getWindow().one("idle",function(){h.$el.data("bs.tokenfield").update()}),o.point(w+"/createtoken").extend({id:"scrolltop",index:10,action:function(e){_.device("!smartphone")||e&&e.view&&setTimeout(function(){e.view.$el[0].scrollIntoView&&e.view.$el[0].scrollIntoView()},10)}})}},subject:function(e){var t=_.uniqueId("form-control-label-");this.append($('<div data-extension-id="subject" class="row subject">').append($('<label class="maillabel" >').addClass(_.device("smartphone")?"hidden-md hidden-sm hidden-xs":"col-xs-2").text(f("Subject")).attr("for",t),$('<div class="mail-input" >').addClass(_.device("smartphone")?"col-xs-12":"col-xs-10").append(new i.InputView({model:e.model,id:t,name:"subject",autocomplete:!1}).render().$el.attr("placeholder",f("Subject")))))},optionsmenu:function(e){var t=new n({model:new S({model:e.model,config:e.config,configFields:["editorMode","vcard"],modelFields:["priority","requestReadReceipt"]}),label:f("Options"),caret:!0});o.point(w+"/menuoptions").invoke("draw",t.$el,e),t.$ul.addClass("pull-right"),this.append(t.render().$el.addClass("text-left"))},attachmentPreviewList:function(e){var t=this,i=e.attachmentsView=new u.List({point:"io.ox/mail/compose/attachment/header",collection:e.model.get("attachments"),editable:!0,model:e.model,mode:m.get("attachments/layout/compose/"+_.display(),"preview")}),n=new r.Inplace({caption:f("Drop attachments here")});n.on({show:function(){t.css("minHeight","100px"),$(window).trigger("resize")},hide:function(){t.css("minHeight",0),$(window).trigger("resize")},drop:function(t){C.call(e.view.$el.find('[data-extension-id="add_attachments"]'),e.model,t),$(window).trigger("resize")}}),i.listenTo(e.model,"change:attachments",function(){i.$list.empty(),i.$preview.empty(),i.renderList(),i.updateScrollControls()}),i.listenToOnce(i.collection,"add remove reset",_.debounce(function(){this.getValidModels().length>0&&(this.$el.addClass("open"),this.isListRendered||(this.renderList(),i.updateScrollControls()))})),i.listenTo(i.collection,"add remove reset",_.debounce(function(){e.resizeView&&e.resizeView.update(),this.getValidModels().length<=1&&$(window).trigger("resize")})),i.on("change:expanded",function(){$(window).trigger("resize")}),i.render(),i.getValidModels().length>0&&(i.renderList(),i.$el.addClass("open")),t.append(n.render().$el.addClass("abs"),i.$el),i.$el.on("click","li.item",function(e){var t,n,s,r,l=$(e.currentTarget);l.attr("data-original")&&(t=l.attr("data-id"),"localFile"===(n=i.collection.get(t).toJSON()).group&&(n.fileObj=i.collection.get(t).fileObj,n.id="localFileAttachment-"+t),r=i.collection.filter(function(e){return"attachment"===e.get("disp")}).map(function(e){var t=e.toJSON();return t.filename=t.filename||t.name,"localFile"===t.group&&(t.fileObj=e.fileObj,t.id="localFileAttachment-"+e.cid),t}),s=o.Baton({simple:!0,data:n,list:r,restoreFocus:$(e.target),openedBy:"io.ox/mail/compose"}),a.invoke("io.ox/mail/attachment/actions/view",s))}),e.app.once("ready",i.updateScrollControls.bind(i,void 0)),i.on("change:layout",function(e){m.set("attachments/layout/compose/"+_.display(),e).save()})},attachmentSharing:function(e){m.get("compose/shareAttachments/enabled",!1)&&l.has("infostore")&&(_.device("smartphone")||require(["io.ox/mail/compose/sharing"],function(t){var i=e.sharingView=new t({model:e.model});e.attachmentsView.$header.find(".links").before(i.render().$el)}))},mailSize:function(t){function i(){var i=t.model.get("content").replace(/src="data:image[^"]*"/g,"").length,n=t.model.get("attachments").reduce(function(i,n){if("INLINE"===n.get("contentDisposition")){var o=t.model.get("id"),a=e.getUrl(_.extend({space:o},n),"view").replace("?","\\?"),s=new RegExp('<img[^>]*src="'+a+'"[^>]*>').test(t.model.get("content")),r=new RegExp('<img[^>]*src="[^"]*'+n.get("id")+'"[^>]*>').test(t.model.get("content"));if(!s&&!r)return i}return i+(n.getSize()||0)},0);return b.fileSize(i+n,1)}var n=t.attachmentsView,o=$('<span class="mail-size">');n.$footer.append(o);var a=_.debounce(function(){var e=t.model.get("attachments").some(function(e){return"mail"===e.get("group")}),n=!!(t.model.get("sharedAttachments")||{}).enabled,a=e&&!n;o.text(f("Mail size: %1$s",i())).toggleClass("invisible",!a)},10),s=_.throttle(a,5e3);a(),n.listenTo(n.collection,"add remove reset change:size",a),n.listenTo(t.model,"change:sharedAttachments",a),n.listenTo(t.model,"change:content",s)},imageResizeOption:function(e){function t(){var t=e.model.get("attachments").models;y.containsResizables(t).then(function(e){n.$el.toggle(e)})}var i=e.attachmentsView,n=new x({model:e.config,collection:i.collection});i.$footer.append(n.render().$el),i.listenTo(i.collection,"add remove reset",_.debounce(t,0)),t()},attachment:function(){function e(e){var t=this;require(["io.ox/files/filepicker"],function(i){new i({primaryButtonText:f("Add"),cancelButtonText:f("Cancel"),header:f("Add attachments"),multiselect:!0,createFolderButton:!1,extension:"io.ox/mail/mobile/navbar",uploadButton:!0}).done(function(i){t.trigger("aria-live-update",f("Added %s to attachments.",_(i).map(function(e){return e.filename}).join(", ")));var n=i.map(function(t){var i=new v.Model({filename:t.filename});return h.uploadAttachment({model:e,filename:t.filename,origin:{origin:"drive",id:t.id,folderId:t.folder_id},attachment:i}),i});e.attachFiles(n)})})}return function(t){var i=$('<input type="file" name="file">').css("display","none").on("change",C.bind(this,t.model)).prop("multiple",_.device("!smartphone"));if(l.has("infostore")){var o=new n({label:f("Attachments"),caret:!0});this.append(i,o.append($('<a href="#">').append($.txt(f("Add local file"))).on("click",function(){i[0].value="",i.trigger("click")})).link("add-file",f("Add from Drive"),e.bind(this,t.model)).render().$el)}else this.append(i,$('<button type="button" class="btn btn-link">').text(f("Attachments")).on("click",function(){i[0].value="",i.trigger("click")}))}}(),body:function(){var e=this,t=_.uniqueId("tmce-"),i=_.uniqueId("tmcetoolbar-");e.append($('<div class="row">').append($('<div class="col-sm-12">').append($('<div class="editable-toolbar">').attr("id",i),$('<div class="editable">').attr("id",t).css("min-height","400px"))))},mailto:function(){if(m.get("features/registerProtocolHandler",!0)&&navigator.registerProtocolHandler){var e=location,t=e.href.indexOf("#"),i=e.href.substr(0,t);navigator.registerProtocolHandler("mailto",i+"#app="+ox.registry.get("mail-compose")+":compose&mailto=%s",ox.serverConfig.productNameMail)}}}}),define("io.ox/mail/compose/inline-images",["io.ox/core/extensions","io.ox/backbone/views/modal","io.ox/core/tk/attachments","io.ox/core/notifications","io.ox/core/http","gettext!io.ox/mail"],function(e,t,i,n,o,a){var s={inlineImage:function(e){try{var t=e.editor||window.tinyMCE&&window.tinyMCE.activeEditor;if("FormData"in window){if(0===e.file.size&&""===e.file.type&&!e.file.name)return $.Deferred().reject({error:{},message:a("One of the embedded images could not be used.")});var i=new FormData;if(e.file.name)i.append("file",e.file);else{var n=e.file.type.replace("image/","")||"png";i.append("file",e.file,"image."+n)}return o.UPLOAD({module:"file",params:{action:"new",module:"mail",type:"image"},data:i,fixPost:!0}).done(function(e){t&&$(t.getElement()).trigger("addInlineImage",e.data[0])})}return o.FORM({module:"file",form:e.form,params:{module:"mail",type:"image"}}).done(function(e){t&&$(t.getElement()).trigger("addInlineImage",e.data[0])})}catch(e){return console.debug(e),$.Deferred().reject({error:e,message:a("Error while uploading your image")})}},getInsertedImageUrl:function(e){return ox.apiRoot+"/file"+"?"+$.param({action:"get",id:e.data[0],session:ox.session})}},r="io.ox/mail/compose/inline-images/";return e.point(r+"title").extend({id:"default",draw:function(){this.$title.text(a("Insert inline image"))}}),e.point(r+"file_upload").extend({id:"default",draw:function(e){e.$.file_upload=i.fileUploadWidget(),this.append(e.$.file_upload)}}),e.point(r+"buttons").extend({id:"default",draw:function(){this.addCancelButton().addButton({label:a("Insert"),action:"insert"})}}),{api:s,show:function(){var i,o=new t({async:!0}),l=new e.Baton({$:{}}),d=$.Deferred();return o.build(function(){i=$('<form accept-charset="UTF-8" enctype="multipart/form-data" method="POST">'),this.$body.append(i),e.point(r+"title").invoke("draw",this.$title,l),e.point(r+"file_upload").invoke("draw",i,l),e.point(r+"buttons").invoke("draw",this,l),this.$el.addClass("inline-images").parent().css("z-index",999999)}),o.on("insert",function(){var e=l.$.file_upload.find("input[type=file]"),t=this;if(t.busy(),/\.(gif|bmp|tiff|jpe?g|gmp|png|heic?f?)$/i.test(e.val()))return s.inlineImage({file:e[0].files?e[0].files[0]:[],form:i}).then(function(e){t.close(),d.resolve(s.getInsertedImageUrl(e))}).fail(function(e){e&&e.error&&n.yell("error",e.error),t.idle()});n.yell("error",a("Please select a valid image File to insert")),t.idle(),d.reject()}).open(),d}}}),define("io.ox/mail/compose/main",["io.ox/core/extensions","io.ox/mail/api","io.ox/core/api/account","io.ox/mail/util","settings!io.ox/mail","gettext!io.ox/mail","io.ox/mail/actions","io.ox/mail/compose/actions"],function(e,t,i,n,o,a){var s=e.point("io.ox/mail/compose/boot"),r=0;return s.extend({id:"bundle",index:r+=100,perform:function(){return require(["io.ox/mail/compose/bundle"])}},{id:"compose-model",index:r+=100,perform:function(e){var t=this;return require(["io.ox/mail/compose/model"]).then(function(i){return t.model=e.model=new i(e.data),e.data&&e.data.id&&(e.model.restored=!0),t.model.initialized})}},{id:"compose-view",index:r+=100,perform:function(e){var t=this;return require(["io.ox/mail/compose/config","io.ox/mail/compose/view"]).then(function(i,n){t.config=new i(_.extend({},e.config,{type:t.model.type})),t.view=e.view=new n({app:t,model:t.model,config:t.config})})}},{id:"fix-custom-displayname",index:r+=100,perform:function(){if(!o.get("customDisplayNames"))return i.getPrimaryAddressFromFolder(this.config.get("folderId")).catch(function(){return i.getPrimaryAddressFromFolder(t.getDefaultFolder())}).then(function(e){o.set(["customDisplayNames",e[1],"defaultName"],e[0])})}},{id:"fix-from",index:r+=100,perform:function(){var e=this.model;if(!e.get("from"))return i.getPrimaryAddressFromFolder(this.config.get("folderId")).catch(function(){return i.getPrimaryAddressFromFolder(t.getDefaultFolder())}).then(function(t){o.get(["customDisplayNames",t[1],"overwrite"])&&(t[0]=o.get(["customDisplayNames",t[1],"name"],"")),o.get("sendDisplayName",!0)||(t[0]=null),e.set("from",t)})}},{id:"fix-displayname",index:r+=100,perform:function(){function e(){var e=t.get("from");e&&t.set("from",n.getSender(e,i.get("sendDisplayName")))}var t=this.model,i=this.config;e(),this.view.listenTo(i,"change:sendDisplayName",e),this.view.listenTo(ox,"change:customDisplayNames",e)}},{id:"load-signature",index:r+=100,perform:function(){var e=this,t=this.view.signaturesLoading=$.Deferred();if(_.device("smartphone")){var i=o.get("mobileSignature",a("Sent from %s via mobile",ox.serverConfig.productName)),n=new Backbone.Collection([{id:"0",content:i,misc:{insertion:"below"}}]);this.config.set("signatures",n),t.resolve(n)}else require(["io.ox/core/api/snippets"],function(i){var n=i.getCollection();e.config.set("signatures",n),i.getAll().always(function(){t.resolve(n)})});return t.then(function(e){return this.config.set("signatures",e),e}.bind(this))}},{id:"render-view",index:r+=100,perform:function(e){e.win.nodes.main.addClass("scrollable").append(this.view.render().$el)}},{id:"editor-mode",index:r+=100,perform:function(){this.model.get("meta").editFor&&this.config.set("editorMode","text/plain"===this.model.get("contentType")?"text":"html"),("alternative"===this.config.get("preferredEditorMode")||"alternative"===this.config.get("editorMode"))&&this.config.set("editorMode","text/plain"===this.model.get("contentType")?"text":"html")}},{id:"auto-bcc",index:r+=100,perform:function(){o.get("autobcc")&&!this.config.is("edit")&&this.model.set("bcc",n.parseRecipients(o.get("autobcc"),{localpart:!1}))}},{id:"auto-discard",index:r+=100,perform:function(){this.config.set("autoDiscard",!this.config.is("edit"))}},{id:"set-mail",index:r+=100,perform:function(){return this.view.setMail()}},{id:"initial-signature",index:r+=100,perform:function(){return this.view.signaturesLoading.then(function(){this.config.setInitialSignature(this.model)}.bind(this))}},{id:"initial-patch",index:r+=100,perform:function(){this.view.dirty(!!this.model.restored),this.model.initialPatch()}},{id:"finally",index:r+=100,perform:function(e){var t=e.win;t.nodes.main.find(".tokenfield").css("padding-right",14+t.nodes.main.find(".recipient-actions").width()+20*t.nodes.main.find('[data-extension-id="to"] .has-picker').length),this.view.$el.find(".mail-input>.tokenfield>input.tokenfield").each(function(){var t=$(this).data("bs.tokenfield"),i=$(this).closest("[data-extension-id]").data("extension-id");delete t.maxTokenWidth,e.model.trigger("change:"+i,e.model,e.model.get(i))}),t.nodes.header.removeClass("sr-only"),t.nodes.body.removeClass("sr-only").find(".scrollable").scrollTop(0).trigger("scroll"),t.idle(),$(window).trigger("resize"),t.setTitle(this.model.get("subject")||a("Compose")),this.trigger("ready")}}),ox.on("http:error:MSGCS-0007 http:error:MSGCS-0011",function(e){var t=_.extend({},e);switch(e.code){case"MSGCS-0007":t.message=a("The mail draft could not be found on the server. It was sent or deleted in the meantime.");break;case"MSGCS-0011":var i=t.error_params[0]||20;t.message=a("You cannot open more than %1$s drafts at the same time.",i)}require(["io.ox/core/notifications"],function(e){e.yell(t)})}),{getApp:function(){var e,t=ox.ui.createApp({name:"io.ox/mail/compose",title:a("Compose"),userContent:!0,closable:!0,floating:!_.device("smartphone"),size:"width-xs height-md"});return t.setLauncher(function(){t.setWindow(e=ox.ui.createWindow({name:"io.ox/mail/compose",chromeless:!0,floating:!_.device("smartphone"),closable:!0,title:a("Compose")}))}),t.failRestore=function(e){var i={id:e};if(_.isObject(e)){if(e.restoreById)return t.open({type:"edit",original:{folderId:e.folder_id,id:e.id,security:e.security}});i=_(e).pick("to","cc","bcc","subject"),e.from&&e.from[0]&&(i.from=e.from[0]),e.attachments&&e.attachments[0]&&(i.content=e.attachments[0].content,i.contentType=e.attachments[0].content_type),i.meta={},i.meta.security=e.security,i.requestRqe=e.disp_notification_to,i.priority=["high","medium","low"][(i.priority||1)-1]}return t.open(i)},t.getContextualHelp=function(){return"ox.appsuite.user.sect.email.gui.create.html"},t.open=function(i,n){var o=$.Deferred();return"edit"===(i=_.extend({},i)).type&&(t.cid="io.ox/mail/compose:"+_.cid(i.original)+":"+i.type),e.nodes.header.addClass("sr-only"),e.nodes.body.addClass("sr-only"),e.busy().show(function(){s.cascade(t,{data:i||{},config:n,win:e}).then(function(){o.resolve({app:t}),ox.trigger("mail:"+t.model.get("meta").type+":ready",i,t)},function(e){t.view&&(t.view.dirty(!1),t.view.removeLogoutPoint()),t.quit(),o.reject(e)})}),o},t.setQuit(function(){if(t.view)return t.view.discard()}),t.on("quit",function(){t.model&&t.model.destroy()}),window.compose=t,t},reuse:function(e,t){return!(!t||"edit"!==t.type)&&ox.ui.App.reuse("io.ox/mail/compose:"+_.cid(t.original)+":edit")}}}),define("io.ox/mail/compose/model",["io.ox/mail/compose/api","io.ox/mail/api","io.ox/core/attachments/backbone","settings!io.ox/mail","gettext!io.ox/mail","io.ox/mail/sanitizer","io.ox/mail/util"],function(e,t,i,n,o,a,s){var r=e.space.attachments;return Backbone.Model.extend({defaults:function(){return{to:[],cc:[],bcc:[],subject:"",content:"",contentType:"",attachments:[],meta:{type:"new",date:"",originalId:"",originalFolderId:"",security:{encrypt:!1,pgpInline:!1,sign:!1}},requestReadReceipt:!1,priority:"normal",sharedAttachments:{language:"",enabled:!1,autodelete:!1,expiryDate:"",password:""}}},initialize:function(){this.initialized=this.create().then(function(e){["to","cc","bcc"].forEach(function(t){e[t]=_.chain().union(this.get(t),e[t]).uniq(function(e){return e.length>1?e[1]:e[0]}).value()}.bind(this));var t=new i.Collection;return t.space=e.id,t.reset(_(e.attachments).map(function(e){return new i.Model(_.extend({},e,{group:"mail",space:t.space}))})),e.attachments=t,e}.bind(this)).then(function(e){this.set(e),this.prevAttributes||(this.prevAttributes=e),this.listenTo(e.attachments,"remove",this.onRemoveAttachment)}.bind(this))},initialPatch:function(){return this.requestSave=_.throttle(this.save.bind(this,!1),n.get("autoSaveAfter",15e3),{leading:!1}),this.on("change",this.requestSave),this.save(_.device("smartphone"))},sendOrSave:function(t){var i=this.toJSON(),n=(this.get("attachments")||[]).filter(function(e){return"localFile"===e.get("group")}).map(function(e){return e.resized?e.resized:e.get("originalFile")});return i.attachments.forEach(function(e){delete e.meta}),this.destroyed=!0,$.when.apply($,n).then(function(){var n=_(arguments).toArray();return e.space[t](this.get("id"),i,n)}.bind(this)).fail(function(){this.destroyed=!1}.bind(this))},send:function(){return this.sendOrSave("send")},saveDraft:function(){return this.sendOrSave("save")},attachFiles:function(e){this.get("attachments").add(e)},attachVCard:function(){e.space.attachments.vcard(this.get("id")).then(function(e){this.get("attachments").add(e)}.bind(this))},onRemoveAttachment:function(e){this.destroyed||(e.trigger("destroy"),e.get("id")&&r.remove(this.get("id"),e.get("id")))},quoteMessage:function(){function e(e){return e.length<2?e[0]||"":e[0]?e[0]+" <"+e[1]+">":e[1]}return function(i){var r=i.meta,l=r.replyFor||r.forwardsFor;return"text/html"!==i.contentType&&"multipart/alternative"!==i.contentType||(i.content=a.simpleSanitize(i.content)),!(l=[].concat(l)[0])||r.editFor?i:t.get({id:l.originalId,folder:l.originalFolderId},{cache:!n.get("features/fixContentType",!1)}).then(function(t){var a=[];/^(reply|replyall)$/.test(i.meta.type)?a.push(o("On %1$s %2$s wrote:",moment(i.meta.date).format("LLL"),t.from.map(function(e){return s.formatSender(e,!1)}).join(", "))):/^forward-inline$/.test(i.meta.type)&&(a.push(o("---------- Original Message ----------"),o("From: %1$s",t.from.map(e).join(", ")),o("To: %1$s",t.to.map(e).join(", "))),t.cc&&t.cc.length>0&&a.push(o("Cc: %1$s",t.cc.map(e).join(", "))),a.push(o("Date: %1$s",moment(i.meta.date).format("LLL")),o("Subject: %1$s",t.subject))),a.push("","");var r=/^forward-inline$/.test(i.meta.type)&&n.get("forwardunquoted",!1);if("text/html"===i.contentType)i.content=s.getDefaultStyle().node.get(0).outerHTML+$('<blockquote type="cite">').append(a.map(function(e){return e?$("<div>").text(e):"<div><br></div>"}),i.content).prop(r?"innerHTML":"outerHTML");else if("text/plain"===i.contentType){var l=r?"":"> ";i.content="\n"+a.map(function(e){return l+e}).join("\n")+" \n"+i.content.trim().split("\n").map(function(e){return l+e}).join("\n")}return i})}}(),create:function(){if(this.has("id"))return e.space.get(this.get("id"));var t=this.get("type")||"new",i=this.get("original"),o={vcard:!/(edit|copy)/.test(t)&&n.get("appendVcard",!1)};return this.type=t,this.unset("type"),this.unset("original"),e.space.add({type:t,original:i},o).then(function(e){return this.prevAttributes=e,e.content?this.quoteMessage(e):e}.bind(this)).then(function(e){return this.get("attachments")&&this.get("attachments").length?$.when.apply($,this.get("attachments").map(function(t){return r.add(e.id,t)})).then(function(){return e.attachments=(e.attachments||[]).concat(_.toArray(arguments)),e}).catch(function(t){return ox.debug&&console.warn("Could not load initial attachments",t),e}):e}.bind(this))},deepDiff:function(e,t){return _.isUndefined(e)?t:(t=t||this.attributes,_(t).chain().mapObject(function(t,i){if((t instanceof Backbone.Model||t instanceof Backbone.Collection)&&(t=t.toJSON()),!_.isEqual(e[i],t))return _.isUndefined(t)?null:t}).omit(function(e){return _.isUndefined(e)}).value())},save:function(t){if(this.destroyed)return $.when();var i=this.prevAttributes,n=this.toJSON();n.content=n.content.replace(/<img[^>]*data-pending="true"[^>]*>/g,"");var o=this.deepDiff(i,n);return delete o.attachments,_.isEmpty(o)?$.when():(this.prevAttributes=this.toJSON(),t||this.trigger("before:save"),e.space.update(this.get("id"),o).then(function(){t||this.trigger("success:save")}.bind(this),function(){this.prevAttributes=i,ox.debug&&console.warn("Update composition space failed",this.get("id")),t||this.trigger("fail:save")}.bind(this)))},destroy:function(){if(!this.destroyed&&this.get("id"))return this.destroyed=!0,this.get("attachments").forEach(function(e){e.trigger("destroy")}),$.when(_(this.get("attachments")).pluck("done").map(function(e){return $.when(e).catch()})).then(function(){return e.space.remove(this.get("id"))}.bind(this))},toJSON:function(){var e=Backbone.Model.prototype.toJSON.call(this),t=this.get("attachments");return t&&t.toJSON&&(e.attachments=t.toJSON()),e},keepDraftOnClose:function(){return!0===n.get("features/deleteDraftOnClose")&&!!this.get("meta").editFor}})}),define("io.ox/mail/compose/names",["io.ox/mail/sender","io.ox/backbone/views/modal","io.ox/backbone/mini-views/common","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,n,o){var a={},s=Backbone.View.extend({className:"form-group",initialize:function(){this.listenTo(this.model,"change:overwrite",function(){var e=this.model.get("overwrite"),t=e?"":this.model.get("defaultName"),i=this.$('input[name="name"]');i.attr("placeholder",t).prop("disabled",!e),e?i.val(this.model.get("name")).focus():i.val("")})},render:function(){return this.$el.append($("<h5>").text(this.model.id),$('<div class="input-group">').append($('<span class="input-group-addon">').append(this.renderCheckbox()),this.renderField())),this},renderCheckbox:function(){return new i.CheckboxView({name:"overwrite",model:this.model}).render().$el.attr("title",o("Use custom name")).prop("checked",this.model.get("overwrite"))},renderField:function(){var e=this.model.get("overwrite"),t=e?"":this.model.get("defaultName");return new i.InputView({name:"name",model:this.model}).render().$el.attr("title",o("Custom name")).attr("placeholder",t).prop("disabled",!e).val(e?this.model.get("name"):"")}}),r=Backbone.View.extend({render:function(){return this.$el.append($('<div class="help-block">').css("margin","0 0 1em 0").text(o("Select a checkbox to define a custom name for that address; otherwise the mail account's default name will be used. If you want to use an address anonymously, select the checkbox and leave the field empty.")),this.collection.map(function(e){return new s({model:e}).render().$el})),this},save:function(){var e={};this.collection.each(function(t){e[t.id]=t.pick("name","overwrite","defaultName")}),n.set("customDisplayNames",e).save(),ox.trigger("change:customDisplayNames")}}),l=Backbone.Model.extend({constructor:function(e){Backbone.Model.call(this,{id:e,defaultName:a[e],overwrite:n.get(["customDisplayNames",e,"overwrite"],!1),name:n.get(["customDisplayNames",e,"name"],"")})}}),d=Backbone.Collection.extend({model:l});return{EditRealNamesView:r,NameView:s,open:function(){e.getAddresses().done(function(e,i){var n=_([].concat([i],e)).chain().map(function(e){return a[e[1]]=e[0],e[1]}).uniq().value();new t({title:o("Edit real names")}).build(function(){this.view=new r({collection:new d(n),el:this.$body.get(0)}),this.view.render()}).addCancelButton().addButton({label:o("Save"),action:"save"}).on("save",function(){this.view.save(),this.view=null}).open()})}}}),define("io.ox/mail/compose/resize-view",["io.ox/mail/compose/resize","settings!io.ox/mail","gettext!io.ox/mail","io.ox/backbone/mini-views/dropdown"],function(e,t,i,n){function o(t,n){var o=n.get("originalFile");return o?0===o.size?(require(["io.ox/core/notifications"],function(e){e.yell("warning",i("The image cannot not be resized because it was not found on your hard drive."))}),$.when()):"original"===t?(delete n.resized,n.trigger("image:resized",o),$.when()):e.matches("type",o)&&e.matches("size",o)?(n.resized=new $.Deferred,e.addDimensionsProperty(o).then(function(){if(o._dimensions&&e.matches("dimensions",o,{target:t})){var i=e.getTargetDimensions(o,t);return e.resizeImage(o,i)}}).then(function(e){e&&(n.resized.resolve(e),n.trigger("image:resized",e))})):$.when():$.when()}var a=i("Image size");return n.extend({settings:{small:t.get("features/imageResize/small",320),medium:t.get("features/imageResize/medium",640),large:t.get("features/imageResize/large",1280)},initialize:function(e){var i=t.get("features/imageResize/default","original");this.model.set("imageResizeOption",this.settings[i]||"original"),e=_({label:"",caret:!0}).extend(e),n.prototype.initialize.call(this,e)},setup:function(){n.prototype.setup.apply(this,arguments),this.$el.addClass("resize-options"),_.device("smartphone")&&(this.header(a),this.divider()),this.option("imageResizeOption",this.settings.small,i("Small (%1$s px)",this.settings.small),{radio:!0}),this.option("imageResizeOption",this.settings.medium,i("Medium (%1$s px)",this.settings.medium),{radio:!0}),this.option("imageResizeOption",this.settings.large,i("Large (%1$s px)",this.settings.large),{radio:!0}),this.option("imageResizeOption","original",i("Original"),{radio:!0}),this.listenTo(this.model,"change:imageResizeOption",this.onChange),this.listenTo(this.collection,"add reset",this.onAddReset),_.device("smartphone")||this.$el.prepend($('<span class="image-resize-label">').text(a+": "))},onChange:function(){this.collection.each(o.bind(null,this.model.get("imageResizeOption")))},onAddReset:function(e){o(this.model.get("imageResizeOption"),e)},label:function(){var e=i("Original");switch(this.model.get("imageResizeOption")){case this.settings.small:e=i("Small");break;case this.settings.medium:e=i("Medium");break;case this.settings.large:e=i("Large");break;default:e=i("Original")}this.$el.find(".dropdown-label").text(e+" "),this.$toggle.attr("aria-label",i("Image size")+": "+e)}})}),define("io.ox/mail/compose/resize",["io.ox/contacts/widgets/canvasresize","io.ox/core/tk/image-util","settings!io.ox/mail"],function(e,t,i){var n={getDimensions:function(e){return t.getImageFromFile(e,{exif:!0}).then(function(e){return{width:e.width,height:e.height}})},addDimensionsProperty:function(e){return e._dimensions?$.Deferred().resolve(e._dimensions):n.getDimensions(e).then(function(t){return e._dimensions=t,e})},getTargetDimensions:function(e,t){var i=e._dimensions;if(i){var n=Math.max(i.width||-1,i.height||-1),o=t/n;return t>=n?i:{width:Math.round(i.width*o),height:Math.round(i.height*o)}}},resizeRecommended:function(e){return n.matches("type",e)&&n.matches("size",e)&&n.matches("dimensions",e)},matches:function(){var e=/^image\/(jpg|jpeg|png)/i,t=i.get("features/imageResize/imageSizeThreshold",1024),n=i.get("features/imageResize/fileSizeMax",10485760);return function(i,o,a){var s=_.extend({dimensions:o._dimensions||{},target:void 0},a),r=Math.max(s.dimensions.width||-1,s.dimensions.height||-1);switch(i){case"type":return e.test(o.type);case"size":return o.size<=n;case"dimensions":return!(s.target&&s.target>=r)&&t<r}}}(),containsResizables:function(e){var t=[],i=_.chain(e).map(function(e){return e.get?e.get("originalFile"):e}).compact().filter(function(e){return n.matches("type",e)}).value();return _.each(i,function(e){t.push(n.addDimensionsProperty(e))}),$.when.apply($,t).then(function(){return _.some(i,function(e){return n.resizeRecommended(e)})})},resizeImage:function(t,n){if(n){var o=$.Deferred(),a=i.get("features/imageResize/quality",.75);return e(t,{width:n.width,height:n.height,crop:!1,quality:100*a}).then(function(e){for(var i,n=atob(e.split(",")[1]),a=n.length,s=new window.Uint8Array(a),r=t.type||"image/png",l=_(r.split("/")).last(),d=_(t.name.split(".")).initial(),c=0;c<a;c++)s[c]=n.charCodeAt(c);(i=new Blob([s],{type:r,filename:d+"."+l})).lastModifiedDate=new Date,i.name=d+"."+l,i.filename=d+"."+l,i.group="localFile",o.resolve(i)}),o}}};return n}),define("io.ox/mail/compose/sharing",["io.ox/backbone/views/extensible","io.ox/backbone/mini-views/common","io.ox/backbone/mini-views/dropdown","io.ox/core/extensions","io.ox/core/yell","gettext!io.ox/mail","settings!io.ox/mail","settings!io.ox/core","static/3rd.party/jquery-ui.min.js"],function(e,t,i,n,o,a,s,r){var l=function(e){var t,i=e.slice(0,e.length-1),n="";switch(e.slice(e.length-1,e.length)){case"m":n=a.format(a.ngettext("%1$d minute","%1$d minutes",i),i),t=6e4*i;break;case"h":n=a.format(a.ngettext("%1$d hour","%1$d hours",i),i),t=36e5*i;break;case"d":n=a.format(a.ngettext("%1$d day","%1$d days",i),i),t=864e5*i;break;case"w":n=a.format(a.ngettext("%1$d week","%1$d weeks",i),i),t=6048e5*i;break;case"M":n=a.format(a.ngettext("%1$d month","%1$d months",i),i),t=2592e6*i;break;case"y":n=a.format(a.ngettext("%1$d year","%1$d years",i),i),t=31536e6*i}return{label:n,value:t}};return n.point("io.ox/mail/compose/sharing").extend({id:"expire",index:100,render:function(){var e,i=[];_(s.get("compose/shareAttachments/expiryDates",[])).each(function(e){var t=l(e);i.push(t),this.sharingModel.get("expiryDate")||e!==s.get("compose/shareAttachments/defaultExpiryDate","")||this.sharingModel.set("expiryDate",t.value)}.bind(this)),s.get("compose/shareAttachments/requiredExpiration")||s.get("compose/shareAttachments/forceAutoDelete",!1)||(i.push({label:a("Never"),value:""}),this.sharingModel.get("expiryDate")||""!==s.get("compose/shareAttachments/defaultExpiryDate","")||this.sharingModel.set("expiryDate","")),e=new t.SelectView({model:this.sharingModel,name:"expiryDate",list:i,id:"expiration-select-box"}),this.dialogNode.append($('<label for="expiration-select-box">').text(a("Expiration")),e.render().$el)}},{index:200,render:function(){function e(){n.toggleClass("hidden",""===i.sharingModel.get("expiryDate"))}var i=this,n=new t.CustomCheckboxView({model:this.sharingModel,name:"autodelete",label:a("Delete files after expiration")}).render().$el;if(s.get("compose/shareAttachments/forceAutoDelete",!1))return n.prop("disabled",!0).addClass("disabled");this.listenTo(this.sharingModel,"change:expiryDate",e),e(),this.dialogNode.append(n)}},{id:"password",index:300,render:function(){function e(){if(o.get("usepassword"))return i.find("input").prop("disabled",!1);i.find("input").prop("disabled",!0)}var i,n,o=this.sharingModel;this.dialogNode.append($('<div class="password-wrapper">').append(new t.CustomCheckboxView({name:"usepassword",model:o,label:a("Use password")}).render().$el.addClass("use-password"),$('<label class="control-label sr-only">').text(a("Enter Password")).attr({for:n=_.uniqueId("share-password-label-")}),i=new t.PasswordViewToggle({name:"password",model:o,placeholder:a("Password"),autocomplete:!1}).render().$el.find("input").attr("id",n))),o.on("change:usepassword",e),e()}},{id:"notifications",index:400,render:function(){s.get("compose/shareAttachments/enableNotifications",!1)&&(this.notificationModel=new Backbone.Model({download:_(this.sharingModel.get("notifications")).contains("download"),expired:_(this.sharingModel.get("notifications")).contains("expired"),visit:_(this.sharingModel.get("notifications")).contains("visit")}),this.dialogNode.append($("<fieldset>").append($("<legend>").append($("<h2>").text(a("Email notifications"))),new t.CustomCheckboxView({model:this.notificationModel,name:"download",label:a("Receive notification when someone finished downloading file(s)")}).render().$el,new t.CustomCheckboxView({model:this.notificationModel,name:"expired",label:a("Receive notification when the link expires")}).render().$el,new t.CustomCheckboxView({model:this.notificationModel,name:"visit",label:a("Receive notification when someone accesses the file(s)")}).render().$el)),this.listenTo(this.notificationModel,"change",function(){this.sharingModel.set("notifications",_.allKeys(_(this.notificationModel.attributes).pick(function(e){return!0===e})))}))}}),e.extend({tagName:"div",className:"share-attachments",point:"io.ox/mail/compose/sharing",initialize:function(){var e=s.get("compose/shareAttachments/forceAutoDelete",!1),t=_.extend({language:r.get("language"),enabled:!1,autodelete:e},this.model.get("sharedAttachments"));e&&(t.autodelete=!0),s.get("compose/shareAttachments/requiredExpiration")&&(t.expiryDate=l(s.get("compose/shareAttachments/defaultExpiryDate","1w")).value),this.sharingModel=new Backbone.Model(t),this.listenTo(this.model.get("attachments"),"add remove reset change:size",this.updateVisibility),this.listenTo(this.model,"change:sharedAttachments",this.syncToSharingModel),this.listenTo(this.sharingModel,"change:enabled",this.updateVisibility),this.listenTo(this.sharingModel,"change:enabled",this.syncToMailModel)},updateVisibility:function(){this.optionsButton&&(!this.model.saving&&s.get("compose/shareAttachments/threshold",0)>0&&this.model.get("attachments").getSize()>s.get("compose/shareAttachments/threshold",0)&&!1===this.sharingModel.get("enabled")&&(o("info",a("Attachment file size too large. You have to use %1$s or reduce the attachment file size.",s.get("compose/shareAttachments/name"))),this.sharingModel.set("enabled",!0)),this.$el.toggle(!!this.model.get("attachments").getValidModels().length),this.optionsButton.toggleClass("hidden",!this.sharingModel.get("enabled")))},syncToSharingModel:function(){var e=this.model.get("sharedAttachments");s.get("compose/shareAttachments/forceAutoDelete",!1)&&(e.autodelete=!0),this.sharingModel.set(e)},syncToMailModel:function(){if(!this.sharingModel.get("enabled"))return this.model.set("sharedAttachments",{enabled:!1});var e=this.sharingModel.toJSON(),t=["usepassword"];this.sharingModel.get("usepassword")&&!_.isEmpty(this.sharingModel.get("password"))||t.push("password"),this.model.set("sharedAttachments",_.omit(e,t))},render:function(){return this.isRendered?this:(this.$el.append(new t.CustomCheckboxView({model:this.sharingModel,name:"enabled",label:a("Use %1$s",s.get("compose/shareAttachments/name"))}).render().$el,this.optionsButton=$('<button type="button" class="btn btn-link hidden">').text(a("Options")).on("click",_(this.openDialog).bind(this))),this.updateVisibility(),this.isRendered=!0,this)},openDialog:function(){var e=this,t=this.sharingModel.toJSON();require(["io.ox/backbone/views/modal"],function(i){new i({title:a("%1$s options",s.get("compose/shareAttachments/name")),width:400}).build(function(){e.dialogNode=this.$body,this.$el.addClass("share-attachments-view-dialog"),e.invoke("render")}).addCancelButton().addButton({action:"apply",label:a("Apply")}).on("apply",function(){e.syncToMailModel()}).on("cancel",function(){e.sharingModel.clear().set(t)}).open()})}})}),define("io.ox/mail/compose/signatures",["io.ox/core/extensions","io.ox/backbone/mini-views/dropdown","io.ox/mail/util","io.ox/core/tk/textproc","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,n,o,a){var s={getRaw:function(e){var t=$("<div>").html(e.content).text();return s.stripWhitespace(t)},stripWhitespace:function(e){return e.replace(/\s+/g,"")},looksLikeHTML:function(e){return/(<\/?\w+(\s[^<>]*)?>)/.test(e)},lookLikePlainTextWithHTML:function(e){return/^([^<>]|<\/?a>|<a [^>]+>)*$/.test(e)},cleanUpWhiteSpace:function(e){return String(e||"").replace(/(\r\n|\n|\r)/g,"\n").replace(/[\t\f\v ][\t\f\v ]+/g," ").trim()},cleanUp:function(e,t){var i=s.looksLikeHTML(e),o=$("<div>")[i?"html":"text"](s.cleanUpWhiteSpace(e)).html();return s.lookLikePlainTextWithHTML(o)&&(o="<pre>"+o+"</pre>"),!t&&i?n.htmltotext(o):o}};return{extensions:{menu:function(e){function i(t){o.prepareReuse(),o.option("signatureId","",a("No signature")),o.$ul.addClass("pull-right"),t.each(function(e){o.option("signatureId",e.get("id"),e.get("displayname"))}),o.divider(),o.link("settings",a("Manage signatures"),function(){var t={id:"io.ox/mail/settings/signatures"};ox.launch("io.ox/settings/main",t).done(function(){e.view.app.getWindow().floating&&e.view.app.getWindow().floating.onMinimize(),this.setSettingsPane(t)})}),o.$ul.addClass("pull-right"),o.render()}if(!_.device("smartphone")){var n=this,o=new t({model:e.config,label:a("Signatures"),caret:!0});e.view.signaturesLoading.done(function(t){var n=i.bind(null,t);e.view.listenTo(t,"add remove reset",n),n()}),n.append(o.$el.addClass("signatures text-left"))}}},util:s,model:{setInitialSignature:function(e){var t,i=this.get("signatures"),n=e.get("content");this.is("edit|copy")||e.restored?(t=i.find(function(e){var t=s.getRaw(e.toJSON());if(!_.isEmpty(t)){if("html"===this.get("editorMode")){var i=$("<div>").append(n).children('div[class$="io-ox-signature"]:last');return s.stripWhitespace(i.text())===t}return s.stripWhitespace(n).indexOf(t)>-1}}.bind(this)))&&(this.set("signatureIsRendered",!0),this.set("signatureId",t.id,{silent:!1})):this.set("signatureId",this.getDefaultSignatureId())},getDefaultSignatureId:function(){return _.device("smartphone")?"custom"===o.get("mobileSignatureType","none")?"0":"":i.getDefaultSignature(this.get("type"))},getSignatureById:function(e){return e=String(e),this.get("signatures").find(function(t){return t.get("id")===e})}},view:{getSignatureContent:function(){return o.get("forwardunquoted",!1)&&this.config.is("forward")?this.editor.find('div[class$="io-ox-signature"]'):this.editor.children('div[class$="io-ox-signature"]')},updateSignatures:function(){var e=this.config.get("signature");if(e){var t=this.config.getSignatureById(e.id);if(e.content!==t.content){if(!!this.editor.find)this.getSignatureContent().each(function(){var e=$(this),i=e.text();s.getRaw(t)===s.stripWhitespace(i)&&e.empty().append($(t.content))});else{var i=s.cleanUp(e.content,!1),n=s.cleanUp(t.content,!1);this.editor.replaceParagraph(i,n)}this.config.set("signature",t)}}},setSignature:function(e,t){var i=this.config.get("signatures").findWhere({id:t}),n=""===t;(i||n)&&(this.config.set("signature",i?i.toJSON():null,{silent:!!this.config.get("signatureIsRendered")}),this.config.unset("signatureIsRendered"))},redrawSignature:function(e,t){var i=this.config&&this.config.previous("signature");i&&this.removeSignature(i),t&&this.appendSignature(t)},removeSignature:function(e){if(!(e=_.isString(e)?this.config.getSignatureById(e):e)){if(!this.config.get("signature"))return;e=this.config.get("signature")}var t=this,i=!!this.editor.find,n=s.cleanUp(e.content,i);if(i)this.getSignatureContent().each(function(){var e=$(this),i=e.text();t.config.get("signatures").find(function(e){return s.getRaw(e.toJSON())===s.stripWhitespace(i)})?e.remove():e.removeAttr("class")});else if(n){var o="below"===e.misc.insertion?"\n\n"+n:n+"\n\n";this.editor.replaceParagraph(o,"")}},appendSignature:function(e){var t,i=!!this.editor.find;!(!/<img\s[^>]*?src\s*=\s*['"]([^'"]*?)['"][^>]*?>/.test(e.content||"")&&!n.htmltotext(e.content).trim())&&this.config.get("signatures").length&&(t=s.cleanUp(e.content,i),i&&(t=this.getParagraph(t,s.looksLikeHTML(t))),"below"===e.misc.insertion?(_.bind(this.editor.insertPostCite||this.editor.appendContent,this.editor)(t),this.editor.scrollTop("bottom")):(_.bind(this.editor.insertPrevCite||this.editor.prependContent,this.editor)(t),this.editor.scrollTop("top")))}}}}),define("io.ox/mail/compose/util",["io.ox/mail/compose/api","io.ox/mail/compose/resize","settings!io.ox/mail"],function(e,t,i){return{getGroup:function(e){return"drive"===e.origin?"file":"mail"},uploadAttachment:function(n){function o(){if(d&&!1!==c)return a=e.space.attachments[l.has("id")?"update":"add"](s,d,r,l.get("id")),d=void 0,l.set("uploaded",0),a.progress(function(e){l.set("uploaded",Math.min(e.loaded/e.total,.999))}).then(function(e){e=_({group:"mail",space:s,uploaded:1}).extend(e),l.set(e),l.trigger("upload:complete",e)},function(e){"abort"!==e.error&&(l.trigger("upload:failed",e),require(["io.ox/core/yell"],function(t){t(e)}),l.destroy())}).always(function(){delete l.done,o()})}var a,s=n.model.get("id"),r=(n.contentDisposition||"attachment").toLowerCase(),l=n.attachment,d=n.origin,c=i.get("features/instantAttachmentUpload",!0)||"inline"===r;return l.on("destroy",function(){d=void 0,a&&"pending"===a.state()&&a.abort()}),l.done=a,d.file&&"attachment"===r&&(l.set({group:"localFile",originalFile:d.file}),t.matches("type",d.file)&&t.matches("size",d.file)&&!1!==c)?(l.set("uploaded",0),l.on("image:resized",function(e){a&&"pending"===a.state()&&l.get("uploaded")<1&&a.abort(),d={file:e},a&&a.always(function(){_.defer(o)})}),l.on("force:upload",o),_.delay(o,5e3)):_.defer(o)}}}),define("io.ox/mail/compose/view",["io.ox/mail/compose/extensions","io.ox/core/extensions","io.ox/mail/compose/api","io.ox/mail/api","io.ox/mail/util","settings!io.ox/mail","io.ox/core/notifications","gettext!io.ox/mail","io.ox/core/attachments/backbone","io.ox/core/tk/dialogs","io.ox/mail/compose/signatures","io.ox/mail/sanitizer","io.ox/mail/compose/util","less!io.ox/mail/style","less!io.ox/mail/compose/style","io.ox/mail/compose/actions/send","io.ox/mail/compose/actions/save"],function(e,t,i,n,o,a,s,r,l,d,c,u,h){var p=0,m="io.ox/mail/compose";return t.point(m+"/buttons").extend({index:100,id:"send",draw:e.buttons.send},{index:300,id:"discard",draw:e.buttons.discard}),t.point(m+"/mailto").extend({id:"mailto",index:100,setup:e.mailto}),t.point(m+"/header").extend({index:100,id:"title",draw:e.title},{index:200,id:"buttons",draw:function(e){t.point(m+"/buttons").invoke("draw",this,e)}},{index:200,id:"inlineYell",draw:e.inlineYell}),t.point(m+"/fields").extend({id:"header",index:p+=100,draw:e.header},{id:"sender",index:p+=100,draw:e.sender},{id:"sender-realname",index:p+=100,draw:e.senderRealName},{id:"to",index:p+=100,draw:e.tokenfield("to")},{id:"cc",index:p+=100,draw:e.tokenfield("cc")},{id:"bcc",index:p+=100,draw:e.tokenfield("bcc")},{id:"replyto",index:p+=100,draw:e.tokenfield("reply_to")},{id:"subject",index:p+=100,draw:e.subject},{id:"composetoolbar",index:p+=100,draw:function(e){var i=$('<div data-extension-id="composetoolbar" class="row composetoolbar">');t.point(m+"/composetoolbar").invoke("draw",i,e),this.append(i)},redraw:function(e){var i=this.find(".row.composetoolbar");t.point(m+"/composetoolbar").invoke("redraw",i,e)}},{id:"attachments",index:p+=100,draw:function(e){var i=$('<div data-extension-id="attachments" class="row attachments">');t.point(m+"/attachments").invoke("draw",i,e),this.append(i)}},{id:"arialive",index:p+=100,draw:function(){var e=$('<div data-extension-id="arialive" class="sr-only" role="alert" aria-live="assertive">');this.append(e)}}),t.point(m+"/recipientActionLink").extend({id:"cc",index:100,draw:e.recipientActionLink("cc")},{id:"bcc",index:200,draw:e.recipientActionLink("bcc")}),t.point(m+"/recipientActionLinkMobile").extend({id:"mobile",index:100,draw:e.recipientActionLinkMobile}),t.point(m+"/recipientActions").extend({id:"recipientActions",index:100,draw:e.recipientActions}),t.point(m+"/menu").extend({id:"security",index:100,draw:e.security},{id:"signatures",index:200,draw:c.extensions.menu},{id:"options",index:300,draw:e.optionsmenu}),t.point(m+"/editors").extend({id:"plain-text",label:r("Plain Text"),mode:"text"},{id:"tinymce",label:r("HTML"),mode:"html"}),t.point(m+"/menuoptions").extend({id:"editor",index:100,draw:function(){if(!_.device("smartphone")){var e=this.data("view").header(r("Editor"));t.point(m+"/editors").each(function(t){(t.mode||t.label)&&e.option("editorMode",t.mode,t.label,{prefix:r("Editor"),radio:!0})})}}},{id:"priority",index:200,draw:function(){this.data("view").header(r.pgettext("E-Mail","Priority")).option("priority","high",r.pgettext("E-Mail priority","High"),{prefix:r.pgettext("E-Mail","Priority"),radio:!0}).option("priority","normal",r.pgettext("E-Mail priority","Normal"),{prefix:r.pgettext("E-Mail","Priority"),radio:!0}).option("priority","low",r.pgettext("E-Mail priority","Low"),{prefix:r.pgettext("E-Mail","Priority"),radio:!0})}},{id:"options",index:300,draw:function(){this.data("view").header(r("Options")).option("vcard",1,r("Attach Vcard"),{prefix:r("Options"),toggleValue:0}).option("requestReadReceipt",!0,r("Request read receipt"),{prefix:r("Options")})}}),t.point(m+"/composetoolbar").extend({id:"add_attachments",index:100,draw:function(t){var i=$('<div data-extension-id="add_attachments" class="mail-input">');i.addClass(_.device("smartphone")?"col-xs-5":"col-xs-offset-2 col-xs-3"),e.attachment.call(i,t),this.append(i)}},{id:"menus",index:200,draw:function(e){var i=$('<div class="pull-right text-right">');t.point(m+"/menu").invoke("draw",i,e),this.append($('<div data-extension-id="composetoolbar-menu" class="col-xs-7">').append(i))}}),t.point(m+"/attachments").extend({id:"attachmentPreview",index:100,draw:function(t){var i=$('<div data-extension-id="attachmentPreview" class="col-xs-12">');e.attachmentPreviewList.call(i,t),e.attachmentSharing.call(i,t),e.mailSize.call(i,t),e.imageResizeOption.call(i,t),i.appendTo(this)}}),t.point(m+"/attachments").disable("attachmentList"),t.point(m+"/editor/load").extend({id:"options",index:100,perform:function(e){e.options={useFixedWithFont:a.get("useFixedWithFont"),app:this,config:e.config,view:e.view,model:e.model,oxContext:{view:e.view}}}},{id:"image-loader",index:200,perform:function(e){var t=this;"html"===this.config.get("editorMode")&&(e.options.imageLoader={upload:function(e){var i=new l.Model({filename:e.name,uploaded:0,contentDisposition:"INLINE"}),n=new $.Deferred;return h.uploadAttachment({model:t.model,filename:e.name,origin:{file:e},attachment:i,contentDisposition:"inline"}),i.once("upload:complete",n.resolve),t.model.attachFiles([i]),n},getUrl:function(e){return n.getUrl(_.extend({space:t.model.get("id")},e),"view",{session:!1})}})}},{id:"editor",index:300,perform:function(e){var t=$.Deferred();return ox.manifests.loadPluginsFor("io.ox/mail/compose/editor/"+e.config.get("editorMode")).then(function(i){new i(e.view.editorContainer,e.options).done(function(i){e.editor=i,t.resolve()})},function(){t.reject({error:r("Couldn't load editor")})}),t}},{id:"pick",index:400,perform:function(e){return e.editor}}),t.point(m+"/editor/use").extend({id:"register",index:100,perform:function(e){var t=e.view;t.editor&&t.stopListening(t.editor),t.listenTo(e.editor,"change",t.syncMail),t.listenTo(e.config,"change:signature",t.syncMail)}},{id:"content",index:200,perform:function(e){var t=e.model,i=e.editor,n="text/html"===t.get("contentType")&&"text"===i.getMode(),o="text/plain"===t.get("contentType")&&"html"===i.getMode(),a=n||o?"setPlainText":"setContent";return $.when(i[a](e.content))}},{id:"model",index:300,perform:function(e){var t=e.editor.content_type;"alternative"===t.toLowerCase()&&(t="multipart/alternative"),e.model.set({content:e.editor.getContent(),contentType:t})}},{id:"show",index:400,perform:function(e){var t=e.editor;t.show(),e.view.editor=t}},{id:"pick",index:400,perform:function(e){return e.editor}}),Backbone.View.extend({className:"io-ox-mail-compose container f6-target",events:{'click [data-action="add"]':"toggleTokenfield",'keydown [data-extension-id="subject"]':"flagSubjectField",'keyup [data-extension-id="subject"] input':"setSubject",keydown:"focusSendButton","aria-live-update":"ariaLiveUpdate"},initialize:function(e){_.extend(this,c.view,this),this.app=e.app,this.config=e.config,this.editorHash={},this.messageFormat=e.messageFormat||a.get("messageFormat","html"),this.editor=null,this.composeMode="compose",this.editorId=_.uniqueId("editor-"),this.editorContainer=$('<div class="editor">').attr({"data-editor-id":this.editorId}),this.baton=t.Baton({model:this.model,config:this.config,view:this,app:this.app}),this.$el.on("dispose",function(e){this.dispose(e)}.bind(this)),_.device("tablet && ios < 13")&&$(document.body).on("touchstart",this.onTouchStart),this.listenTo(this.model,"keyup:subject change:subject",this.setTitle),this.listenTo(this.model,"change",_.throttle(this.onChangeSaved.bind(this,"dirty"),100)),this.listenTo(this.model,"before:save",this.onChangeSaved.bind(this,"saving")),this.listenTo(this.model,"success:save",this.onChangeSaved.bind(this,"saved")),this.listenTo(this.config,"change:editorMode",this.toggleEditorMode),this.listenTo(this.config,"change:vcard",this.onAttachVcard),this.listenTo(this.model,"change:content",this.onChangeContent),this.listenTo(this.config,"change:signatureId",this.setSignature),this.listenTo(this.config,"change:signatures",this.updateSignatures),this.listenTo(this.config,"change:signature",this.redrawSignature);var n,o,s=this;if(n=_.url.hash("mailto")){var r=function(e){return e.split(",").map(function(e){var t=_.compact(e.replace(/^("([^"]*)"|([^<>]*))?\s*(<(\s*(.*?)\s*)>)?/,"$2//$3//$5").split("//")).map(function(e){return e.trim()});return 1===t.length?[t[0],t[0]]:t})},l=n.replace(/^mailto:/,"").split(/\?/,2),d=decodeURIComponent(l[0]);o=_.deserialize(l[1]);for(var h in o)o[h.toLowerCase()]=o[h];d&&this.model.set("to",r(d),{silent:!0}),o.cc&&this.model.set("cc",r(o.cc),{silent:!0}),o.bcc&&this.model.set("bcc",r(o.bcc),{silent:!0}),o.body=u.sanitize({content:o.body,content_type:"text/html"},{WHOLE_DOCUMENT:!1}).content,this.setSubject(o.subject||""),this.model.set("content",o.body||""),_.url.hash("mailto",null)}this.listenTo(i.queue.collection,"change:pct",this.onSendProgress),t.point(m+"/mailto").invoke("setup"),this.logoutPointId="saveMailOnDraft_"+this.app.id,t.point("io.ox/core/logout").extend({id:this.logoutPointId,index:1e3+this.app.guid,logout:function(){return s.model.save()}})},onSendProgress:function(e,t){this.model.get("id")===e.get("id")&&t>=0&&this.app.getWindow().busy(t)},onChangeContent:function(e,t){t&&'<div style="" class="default-style"><br></div>'!==t||this.config.set("signatureId","")},ariaLiveUpdate:function(e,t){this.$('[data-extension-id="arialive"]').text(t)},setSubject:function(e){var t=e.target?$(e.target):void 0,i=t?t.val():e;e.which&&13===e.which&&t.attr("data-enter-keydown")&&(e.preventDefault(),this.editor.focus(),t.removeAttr("data-enter-keydown")),this.model.set("subject",i,{silent:_.device("safari")}).trigger("keyup:subject",i)},setTitle:function(){this.app.setTitle(this.model.get("subject")||r("Compose"))},saveDraft:function(){var e=this.app.getWindow();this.trigger("updateTokens"),e&&e.busy();var i=this,n=new t.Baton({model:this.model,config:this.config,app:this.app,view:i,catchErrors:!0}),o=$.Deferred();return t.point("io.ox/mail/compose/actions/save").cascade(this,n).then(function(e){if(n.rejected)return o.reject(n.error),e;o.resolve(e)},o.reject).always(function(){e&&e.idle()}),o},onChangeSaved:function(e){this.autoSaveState!==e&&("dirty"===e?this.inlineYell(""):"saving"===e?this.inlineYell(r("Saving...")):"saved"===e&&"saving"===this.autoSaveState&&this.inlineYell(r("Saved")),this.autoSaveState=e)},inlineYell:function(e){this.$el.is(":visible")&&(_.device("smartphone")||this.$el.closest(".io-ox-mail-compose-window").find(".inline-yell").text(e).fadeIn())},dirty:function(e){if(!1===e)this.editor&&this.model.set("content",this.editor.getContent()),this.initialModel=this.model.toJSON();else{if(!0!==e)return!_.isEmpty(this.model.deepDiff(this.initialModel));this.initialModel={}}},clean:function(){this.dirty(!1);for(var e in this.editorHash)this.editorHash[e].then(function(e){e.setContent(""),e.destroy()}),delete this.editorHash[e]},removeLogoutPoint:function(){t.point("io.ox/core/logout").disable(this.logoutPointId)},dispose:function(){i.queue.remove(this.model.get("id")),this.removeLogoutPoint(),this.stopListening(),this.model=null,$(document.body).off("touchstart",this.onTouchStart),delete this.editor},discard:function(){var e=this,t=$.when(),i=this.model.keepDraftOnClose();if((this.dirty()||i)&&!this.config.get("autoDismiss")){var o=i?r.pgettext("dialog","Delete draft"):r.pgettext("dialog","Discard message"),a=r(i?"Keep draft":"Save as draft"),s=r(i?"Do you really want to delete this draft?":"Do you really want to discard your message?");this.app.getWindow&&this.app.getWindow().floating?this.app.getWindow().floating.toggle(!0):_.device("smartphone")&&this.app.getWindow().resume(),t=$.Deferred(),new d.ModalDialog({width:550,container:_.device("smartphone")?e.$el.closest(".window-container-center"):$("#io-ox-core")}).text(s).addPrimaryButton("delete",o,"delete").addAlternativeButton("savedraft",a,"savedraft").addButton("cancel",r("Cancel"),"cancel").show().then(function(o){if("delete"===o){var a=e.config.get("autoDiscard"),s=e.model.get("meta").editFor;if(t.resolve(),!i||!a||!s)return;n.remove([{id:s.originalId,folder_id:s.originalFolderId}])}else"savedraft"===o?e.saveDraft().then(t.resolve,t.reject):t.reject()})}return t.then(function(){e.clean()})},send:function(){var e=r("[Copy] ");if(0===(this.model.get("subject")||"").indexOf(e)){var i=this.model.get("subject");i=i.replace(e,""),this.model.set("subject",i)}this.trigger("updateTokens");var n=this,o=new t.Baton({model:this.model,config:this.config,app:this.app,view:n,catchErrors:!0}),a=this.app.getWindow(),s=t.point("io.ox/mail/compose/actions/send");return a.busy(),this.model.saving=!0,s.cascade(this,o).then(function(){}).always(function(){(o.rejected||o.error)&&o.config.set("autoDismiss",!1),this.model&&(this.model.saving=!1),a.idle()}.bind(this))},onTouchStart:function(){$(document.activeElement).is("iframe")&&$(document.activeElement).blur()},toggleTokenfield:function(e){var t,i="string"==typeof e,n=i?e:$(e.target).attr("data-type");if(_.device("smartphone"))return i||e.preventDefault(),(t=this.$el.find('[data-extension-id="cc"], [data-extension-id="bcc"]')).hasClass("hidden")?(t.removeClass("hidden"),this.$el.find('[data-action="add"] span').removeClass("fa-angle-right").addClass("fa-angle-down")):_.isEmpty(this.model.attributes.cc)&&_.isEmpty(this.model.attributes.bcc)&&(this.model.set("cc",[]),this.model.set("bcc",[]),t.addClass("hidden"),this.$el.find('[data-action="add"] span').removeClass("fa-angle-down").addClass("fa-angle-right")),t;var o=this.$el.find('[data-type="'+n+'"]');return t=this.$el.find('[data-extension-id="'+n+'"]'),i||e.preventDefault(),t.hasClass("hidden")||i?(t.removeClass("hidden"),o.addClass("active"),"cc"===n&&o.attr("title",r("Hide carbon copy input field")),"bcc"===n&&o.attr("title",r("Hide blind carbon copy input field"))):this.model.has(n)&&!_.isEmpty(this.model.get(n))||(this.model.set(n,[]),t.addClass("hidden"),o.removeClass("active"),"cc"===n&&o.attr("title",r("Show carbon copy input field")),"bcc"===n&&o.attr("title",r("Show blind carbon copy input field"))),$(window).trigger("resize"),t},loadEditor:function(e){var i=this.config.get("editorMode"),n=new t.Baton({view:this,model:this.model,config:this.config,content:e});return(this.editorHash[i]=this.editorHash[i]||t.point(m+"/editor/load").cascade(this.app,n)).then(function(e){return n.editor=e,t.point(m+"/editor/use").cascade(this.app,n)}.bind(this))},getEditor:function(){var e=$.Deferred();return this.editor?(e.resolve(this.editor),e):this.loadEditor()},toggleEditorMode:function(){var e,t=this;return this.editor?(e=this.editor.getPlainText(),this.editor.hide()):e="text/html"===this.model.get("contentType")&&"text"===this.config.get("editorMode")?require(["io.ox/core/tk/textproc"]).then(function(e){return e.htmltotext(t.model.get("content"))}):this.model.get("content"),this.editorContainer.busy(),$.when(e).then(function(e){return t.loadEditor(e)}).then(function(){this.editorContainer.idle(),_.isFunction(this.editor.tinymce)&&this.editor.tinymce().undoManager.clear()}.bind(this))},onAttachVcard:function(){1===this.config.get("vcard")&&this.model.attachVCard(),this.config.set("vcard",0)},syncMail:function(){this.editor&&this.model.set("content",this.editor.getContent())},setBody:function(e){this.model.get("initial")&&(e=(e=String(e||"").replace(/^[\s\xA0]*\n([\s\xA0]*\S)/,"$1")).replace(/[\s\uFEFF\xA0]+$/,"")),"new"!==this.model.get("meta").type&&(e=e.replace(/\n<br>&nbsp;$/,"\n")),this.setSimpleMail(e),this.editor.setContent(e),this.model.get("initial")&&this.prependNewLine()},getParagraph:function(e,t){var i=$('<div class="io-ox-signature">').append(t?e:this.editor.ln2br(e));return $("<div>").append(i).html()},prependNewLine:function(){if("edit"!==this.config.get("type")){var e=this.editor.getContent().replace(/^\n+/,"").replace(/^(<div[^>]*class="default-style"[^>]*><br><\/div>)+/,""),t="html"===this.config.get("editorMode")?o.getDefaultStyle().node.get(0).outerHTML:"\n";this.editor.setContent(t+e)}},setMail:function(){var e=this,t=this.model,i=this.config;return this.toggleEditorMode().then(function(){return e.signaturesLoading}).done(function(){var n;if(_.device("!ios")&&(n=i.is("new|forward")?e.$(".tokenfield:first .token-input"):e.editor),i.is("replyall|edit")&&(_.isEmpty(t.get("cc"))||e.toggleTokenfield("cc")),_.isEmpty(t.get("bcc"))||e.toggleTokenfield("bcc"),e.setBody(t.get("content")),_.device("!ios")&&e.editor.tinymce){var o=a.get("defaultFontStyle",{}),s=(o.family||"").split(",")[0];_.isEmpty(o)||(s&&"browser-default"!==s&&e.editor.tinymce().execCommand("fontName",!1,s),o.size&&"browser-default"!==o.size&&e.editor.tinymce().execCommand("fontSize",!1,o.size))}n&&n.focus()})},setSimpleMail:function(e){"text"!==this.config.get("editorMode")&&(/<table/.test(e)||this.editorContainer.find(".editable.mce-content-body").addClass("simple-mail"))},focusEditor:function(){this.editor.focus()},flagSubjectField:function(e){var t=$(e.target);if(13===e.which)return t.attr("data-enter-keydown",!0)},focusSendButton:function(e){(e.metaKey||e.ctrlKey)&&13===e.which&&(e.preventDefault(),this.$el.parents().find('button[data-action="send"]').focus())},render:function(){var e=this,i=$('<div class="mail-compose-fields">');return t.point(m+"/fields").invoke("draw",i,this.baton),this.$el.append(i),this.setTitle(),this.$el.find("input.tokenfield").each(function(){$(this).data("bs.tokenfield").$input.on({compositionstart:function(){$(this).attr("data-ime","active")},compositionend:function(){$(this).attr("data-ime","inactive")},keydown:function(e){13===e.which&&"active"!==$(this).attr("data-ime")&&$(this).val("")},keyup:function(t){if(13!==t.which&&!_.device("smartphone")){var i=$(this).val();/^to:?\s/i.test(i)?$(this).typeahead("val",""):/^cc:?\s/i.test(i)?($(this).typeahead("val",""),e.toggleTokenfield("cc").find(".token-input").focus()):/^bcc:?\s/i.test(i)&&($(this).typeahead("val",""),e.toggleTokenfield("bcc").find(".token-input").focus())}}})}),this.$el.append(this.editorContainer),this}})}),define("io.ox/mail/sender",["io.ox/mail/util","io.ox/core/api/account","io.ox/core/api/user","io.ox/contacts/api","io.ox/core/capabilities","settings!io.ox/mail"],function(e,t,i,n,o,a){function s(e,t){return e=e.value,t=t.value,e<t?-1:1}function r(t){return{text:e.formatSender(t[0],t[1],!1),value:e.formatSender(t[0],t[1])}}var l={getUser:function(){return i.get({id:ox.user_id})},getDefaultSendAddress:function(){return $.trim(a.get("defaultSendAddress",""))},getAccounts:function(e){return t.getAllSenderAddresses(e)},getDisplayName:function(){return t.getDefaultDisplayName()},getPrimaryAddress:function(){return t.getPrimaryAddress()},getAddresses:function(e){return $.when(l.getAccounts(e),l.getPrimaryAddress())},getAddressesOptions:function(e){var t=a.get("defaultSendAddress","").trim();return l.getAddresses(e).then(function(e,i){var n=t||i[1],o=[].concat(e);return o=_(o).map(function(e){return{value:r(e).value,option:e}}),{sortedAddresses:o.sort(s),defaultAddress:n}})}};return l}),define("io.ox/backbone/mini-views/common",["io.ox/backbone/mini-views/abstract","io.ox/backbone/mini-views/dropdown","gettext!io.ox/core"],function(e,t,i){var n=function(e){if(e.originalEvent.dataTransfer.getData("text")){var t=this;this.$el.one("input",function(){t.$el.trigger("change")})}},o=function(e){if(e&&"paste"===e.type&&-1!==e.originalEvent.clipboardData.types.indexOf("text/plain")){var t=this;this.$el.one("input",function(){t.$el.trigger("change")})}},a=e.extend({el:'<input type="text" class="form-control">',events:_.device("firefox")?{change:"onChange",drop:"onDrop",paste:"onPaste"}:{blur:"onChange",change:"onChange",paste:"onPaste"},onChange:function(){this.model.set(this.name,this.$el.val(),{validate:this.options.validate})},onDrop:n,onPaste:o,setup:function(){this.listenTo(this.model,"change:"+this.name,this.update)},update:function(){var e=_.isString(this.model.get(this.name))?this.model.get(this.name).replace(/^\s+/,""):this.model.get(this.name);this.$el.val(e),this.model.set(this.name,e),this.trigger("update",this.$el)},render:function(){return this.$el.attr({name:this.name}),this.id&&this.$el.attr("id",this.id),this.attributes&&this.$el.attr(this.attributes),this.options.maxlength&&this.$el.attr("maxlength",this.options.maxlength),this.options.mandatory&&this.$el.attr("aria-required",!0),_.isBoolean(this.options.autocomplete)&&!this.options.autocomplete&&this.$el.attr("autocomplete","off"),this.update(),this}}),s=e.extend({el:'<input type="password" class="form-control">',events:{change:"onChange",paste:"onPaste"},onChange:function(){var e=this.$el.val();/^\*$/.test(e)&&(e=null),this.model.set(this.name,e,{validate:this.options.validate,_event:"change"})},onPaste:o,setup:function(){this.listenTo(this.model,"change:"+this.name,this.update)},update:function(){var e=this.model.get(this.name);this.$el.val(null!==e?$.trim(e):"********")},toggle:function(e){e=_.isBoolean(e)?e:"password"===this.$el.attr("type"),this.$el.attr("type",e?"text":"password")},render:function(){return this.$el.attr({autocomplete:"off",autocorrect:"off",name:this.name,placeholder:this.options.placeholder}),this.id&&this.$el.attr("id",this.id),this.options.maxlength&&this.$el.attr("maxlength",this.options.maxlength),this.options.mandatory&&this.$el.attr("aria-required",!0),_.isBoolean(this.options.autocomplete)&&!this.options.autocomplete&&this.$el.attr("autocomplete","new-password").removeAttr("name"),this.update(),this}}),r=e.extend({el:'<div class="password-container has-feedback">',events:{"click .toggle-asterisks":"toggle",keydown:"onKeyPress",keyup:"onKeyPress",focusin:"onFocusChange",focusout:"onFocusChange"},icons:{password:"fa-eye",text:"fa-eye-slash"},initialize:function(e){this.passwordView=new s(e)},onFocusChange:_.debounce(function(){this.$el.toggleClass("has-focus",$(document.activeElement).closest(".password-container").length>0)},200),onKeyPress:function(e){(_.device("macos")?18===e.which:91===e.which)&&this.toggle(e,"keydown"===e.type)},toggle:function(e){e=_.isBoolean(e)?e:void 0,this.passwordView.toggle(e),this.$el.find("i.fa").removeClass("fa-eye fa-eye-slash").addClass(this.icons[this.passwordView.$el.attr("type")]),_.device("safari")&&this.$el.find(".toggle-asterisks").focus()},render:function(){return this.$el.empty().append(this.passwordView.render().$el,$('<button type="button" class="btn form-control-feedback toggle-asterisks center-childs">').attr({title:i("toggle password visibility")}).append($('<i class="fa" aria-hidden="true">').addClass(this.icons.password))),this}}),l=e.extend({el:'<textarea class="form-control">',events:_.device("firefox")?{change:"onChange",drop:"onDrop"}:{change:"onChange"},onChange:function(){this.model.set(this.name,this.$el.val(),{validate:this.options.validate})},onDrop:n,setup:function(e){this.rows=e.rows,this.listenTo(this.model,"change:"+this.name,this.update)},update:function(){this.$el.val(this.model.get(this.name))},render:function(){return this.$el.attr({name:this.name}),this.attributes&&this.$el.attr(this.attributes),this.options.id&&this.$el.attr("id",this.options.id),this.rows&&this.$el.attr("rows",this.rows),this.options.maxlength&&this.$el.attr("maxlength",this.options.maxlength),this.update(),this}}),d=e.extend({el:'<input type="checkbox">',events:{change:"onChange"},getValue:function(){return this.options.customValues&&this.options.customValues.true&&this.options.customValues.false?this.options.customValues[this.isChecked()]:this.isChecked()},setValue:function(){var e=this.model.get(this.name)||this.options.defaultVal;return e=this.options.customValues&&this.options.customValues.true&&this.options.customValues.false?_.isEqual(this.options.customValues.true,e):!!e},onChange:function(){this.model.set(this.name,this.getValue())},isChecked:function(){return!!this.$input.prop("checked")},setup:function(e){this.$input=this.$el,this.nodeName=e.nodeName,this.listenTo(this.model,"change:"+this.name,this.update)},update:function(){this.$input.prop("checked",this.setValue())},render:function(){return this.$input.attr({name:this.nodeName||this.name}),this.options.id&&this.$input.attr("id",this.options.id),this.update(),this}}),c=d.extend({el:'<div class="checkbox custom">',render:function(){var e=this.options.id||_.uniqueId("custom-");return this.$el.addClass(this.options.size||"small").append($("<label>").attr("for",e).append(this.$input=$('<input type="checkbox" class="sr-only">').attr({id:e,name:this.nodeName||this.name}),$('<i class="toggle" aria-hidden="true">'),$.txt(this.options.label||" "))),this.update(),this}}),u=c.extend({el:'<div class="checkbox switch">',events:{change:"onChange","swipeleft .toggle":"onSwipeLeft","swiperight .toggle":"onSwipeRight"},onSwipeLeft:function(){this.isChecked()&&this.$input.prop("checked",!1)},onSwipeRight:function(){this.isChecked()||this.$input.prop("checked",!0)}}),h=e.extend({tagName:"div",className:"controls",events:{change:"onChange"},onChange:function(){this.model.set(this.name,this.$('[name="'+this.name+'"]:checked').val())},setup:function(){this.listenTo(this.model,"change:"+this.name,this.update)},update:function(){var e=this.model.get(this.name);this.$('[name="'+this.name+'"]').each(function(){this.value===e&&$(this).prop("checked",!0)})},render:function(){return this.$el.append(_(this.options.list).map(this.renderOption,this)),this.update(),this},renderOption:function(e){return $('<div class="radio custom">').addClass(this.options.size||"small").append(this.renderLabel(e))},renderLabel:function(e){return $("<label>").append(this.renderInput(e),$.txt(e.label))},renderInput:function(e){return $('<input type="radio">').attr("name",this.name).val(e.value)}}),p=h.extend({renderLabel:function(e){var t=_.uniqueId("custom-");return $("<label>").attr("for",t).append(this.renderInput(e).attr("id",t),this.renderToggle(e),$.txt(e.label))},renderToggle:function(){return $('<i class="toggle" aria-hidden="true">')},renderInput:function(){return h.prototype.renderInput.apply(this,arguments).addClass("sr-only")}}),m=e.extend({tagName:"select",className:"form-control",events:{change:"onChange"},onChange:function(){var e=this.$el.val();this.model.set(this.name,this.options.integer?parseInt(e,10):e)},setup:function(){this.listenTo(this.model,"change:"+this.name,this.update)},update:function(){this.$el.val(this.model.get(this.name))},render:function(){return this.$el.attr({name:this.name}),this.id&&this.$el.attr({id:this.id}),this.rerender(),this},renderOptionGroups:function(e){return _(e).chain().map(function(e){return!1===e.label?this.renderOptions(e.options):$("<optgroup>").attr("label",e.label).append(this.renderOptions(e.options))},this).flatten(!0).value()},renderOptions:function(e){return _(e).map(function(e){return $("<option>").attr({value:e.value}).text(e.label)})},rerender:function(){this.$el.empty().append(this.options.groups?this.renderOptionGroups(this.options.list):this.renderOptions(this.options.list)),this.update()},setOptions:function(e){this.options.list=e,this.rerender()}}),f=_.device("smartphone")?a.extend({el:'<input type="date" class="form-control">'}):a.extend({format:"l",onChange:function(){var e=+moment(this.$el.val(),this.format);this.model.set(this.name,e)},update:function(){var e=this.model.get(this.name);this.$el.val(e||this.options.mandatory?this.getFormattedDate(e):"")},getFormattedDate:function(e){return moment(e).format(this.format)},render:function(){a.prototype.render.call(this);var e=this;return require(["io.ox/backbone/views/datepicker"],function(t){setTimeout(function(){new t({parent:e.$el.closest(".modal, #io-ox-core"),mandatory:e.options.mandatory}).attachTo(e.$el).on("select",function(t){e.model.set(e.name,t.valueOf())})})}),this}}),g=e.extend({tagName:"span",className:"help-block",setup:function(e){this.focusSelector=e.focusSelector||"input"},getContainer:function(){return this.options.selector?_.isString(this.options.selector)?this.$el.closest(this.options.selector):_.isObject(this.options.selector)?this.options.selector:void 0:this.$el.closest('.form-group, [class*="col-"]')},render:function(){var e=this;return _.defer(function(){var t=e.getContainer(),i=_.uniqueId("error-help_");t.on({invalid:function(n,o){$(this).hasClass("has-error")||($(this).addClass("has-error"),e.$el.attr({id:i}),e.$el.text(o).show().end(),$(this).find("input").attr({"aria-invalid":!0,"aria-describedby":i}),_.defer(function(){$(t).find(e.focusSelector).focus()}))},valid:function(){$(this).removeClass("has-error"),e.$el.removeAttr("id role"),e.$el.text("").hide().end(),$(this).find("input").removeAttr("aria-invalid aria-describedby")}})}),this.$el.attr({"aria-live":"assertive"}).hide(),this}}),v=e.extend({tagName:"form",setup:function(){this.listenTo(this.model,"change")},render:function(){return this.id&&this.$el.attr({id:this.id}),this}}),b=t.extend({tagName:"div",className:"dropdownlink",update:function(){this.updateLabel(),t.prototype.update.apply(this,arguments)},updateLabel:function(){this.$el.find(".dropdown-label").text(this.options.values[this.model.get(this.name)])},render:function(){var e=this;return t.prototype.render.apply(this,arguments),_(this.options.values).each(function(t,i){var n=e.options.tooltips&&e.options.tooltips[i]?e.options.tooltips[i]:t;e.option(e.name,i,t,{radio:!0,title:n})}),this.updateLabel(),this}});return{AbstractView:e,InputView:a,PasswordView:s,PasswordViewToggle:r,TextView:l,CheckboxView:d,CustomCheckboxView:c,SwitchView:u,RadioView:h,CustomRadioView:p,SelectView:m,DateView:f,ErrorView:g,FormView:v,DropdownLinkView:b,getInputWithLabel:function(e,t,i){var n=_.uniqueId("form-control-label-");return[$("<label>").attr("for",n).text(t),new a({name:e,model:i,id:n}).render().$el]}}}),define("io.ox/core/tk/tokenfield",["io.ox/core/extensions","io.ox/core/tk/typeahead","io.ox/participants/model","io.ox/participants/views","io.ox/contacts/api","io.ox/core/http","io.ox/core/util","io.ox/contacts/util","gettext!io.ox/core","static/3rd.party/bootstrap-tokenfield.js","css!3rd.party/bootstrap-tokenfield/css/bootstrap-tokenfield.css","less!io.ox/core/tk/tokenfield","static/3rd.party/jquery-ui.min.js"],function(e,t,i,n,o,a,s,r,l){$.fn.tokenfield.Constructor.prototype.getTokensList=function(e,t,i){var n=(e=e||this._firstDelimiter)+((t=void 0!==t&&null!==t?t:this.options.beautify)&&" "!==e?" ":""),o=this;return $.map(this.getTokens(i),function(e){if(e.model){var t=e.model.getDisplayName({isMail:o.options.isMail}),i=e.model.getEmail?e.model.getEmail():void 0;return t===i?i:'"'+s.removeQuotes(t)+'" <'+i+">"}return e.value}).join(n)},$.fn.tokenfield.Constructor.prototype.setTokens=function(e,t,i){if(e){t||this.$wrapper.find(".token").remove(),void 0===i&&(i=!0),"string"==typeof e&&(e=this._delimiters.length?s.getAddresses(e):[e]);var n=this;return $.each(e,function(e,t){n.createToken(t,i)}),this.$element.get(0)}};var d=!1;$.fn.tokenfield.Constructor.prototype.blur=function(e){d?this.$input.focus():(this.focused=!1,this.$wrapper.removeClass("focus"),this.preventDeactivation||this.$element.is(document.activeElement)||(this.$wrapper.find(".active").removeClass("active").attr({tabindex:-1,"aria-selected":!1}),this.$firstActiveToken=null),(!this.preventCreateTokens&&this.$input.data("edit")&&!this.$input.is(document.activeElement)||this.options.createTokensOnBlur)&&this.createTokensFromInput(e),this.preventDeactivation=!1,this.preventCreateTokens=!1)},$.fn.tokenfield.Constructor.prototype.keypress=function(e){if(-1!==$.inArray(e.which,this._triggerKeys)&&this.$input.is(document.activeElement)){var t=this.$input.val();if(/^"[^"]*$/.test(t))return;if(t){if(this.$input.data("edit")){var i=this;return void this.$input.one("input",function(){i.createTokensFromInput(e)})}this.createTokensFromInput(e)}return!1}};var c=i.Participant.extend({setPID:function(){c.__super__.setPID.call(this),this.set("pid",this.get("pid")+"_"+_.uniqueId(),{silent:!0})}});return t.extend({className:"test",events:{dispose:"dispose"},initialize:function(i){var o=this;i=_.extend({},{harmonize:function(e){return _(e).map(function(e){var t=new c(e);return{value:t.getTarget({fallback:!0}),label:t.getDisplayName({isMail:i.isMail}).trim()||t.getEmail(),model:t}})},delayedautoselect:!1,allowEditing:!0,createTokensOnBlur:!0,dnd:!0,html:!1,init:!1,customDefaultModel:!1,extPoint:"io.ox/core/tk/tokenfield",leftAligned:!1},i),e.point(i.extPoint+"/token").extend({id:"token",index:100,draw:function(){}}),e.point(i.extPoint+"/autoCompleteItem").extend({id:"view",index:100,draw:function(e){var t=new n.ParticipantEntryView({model:e.model,closeButton:!1,halo:!1,isMail:i.isMail});this.append(t.render().$el)}}),e.point(i.extPoint+"/tokenfield/customize").invoke("customize",this,i),t.prototype.initialize.call(this,i);var a=Backbone.Collection.extend({model:c});this.collection=i.collection||new a,this.collection.comparator=function(e){return e.index||null},this.redrawLock=!1,this.listenTo(this.collection,"reset change:display_name",_.throttle(o.redrawTokens.bind(o),100))},dispose:function(){this.$el.tokenfield("destroy"),this.stopListening(),this.collection=null,this.api=null},register:function(){var t=this;this.$el.tokenfield().parent().on("click mousedown",".token",function(e){var i=$.extend(!0,{},e,{type:"tokenfield:clickedtoken",attrs:$(e.currentTarget).data().attrs,originalEvent:e});t.$el.tokenfield().trigger(i)}),this.options.delayedautoselect&&(t.autoselect={},t.model.on("change:query",function(e,i){t.autoselect[i]&&(t.input.trigger($.Event("keydown",{keyCode:13,which:13})),delete t.autoselect[i])})),this.$el.parent().find(".token-input").on("typeahead:close typeahead:closed",function(){t.$el.trigger("aria-live-update","")}),this.on("typeahead-custom:dropdown-rendered",function(e){var i,n=e.find(".tt-suggestions").children().length;0===n&&(i=l("No autocomplete entries found")),i||(i=l.format(l.ngettext("One autocomplete entry found","%1$d autocomplete entries found",n),n)),t.$el.trigger("aria-live-update",i)}),this.$el.tokenfield().on({"tokenfield:createtoken":function(e){if(!t.redrawLock){if(t.options.customDefaultModel&&!e.attrs.model)return e.preventDefault(),!1;var i,n=t.getInput().data();if(!0===n.edit)return i=/^"(.*?)"\s*(<\s*(.*?)\s*>)?$/.exec(e.attrs.value),_.isArray(i)?e.attrs.label=s.removeQuotes(i[1]):i=["",e.attrs.value,"",e.attrs.value],e.attrs.model=n.editModel.set("token",{label:i[1],value:i[3]}),e.attrs.value=e.attrs.model.cid,void(n.edit=!1);var o=t.hiddenapi.dropdown.getDatumForTopSuggestion();if(!e.attrs.model&&o&&e.attrs.value===o.value&&o.raw&&o.raw.model&&(e.attrs.model=o.raw.model,e.attrs.label=e.attrs.model.getDisplayName({isMail:t.options.isMail})),e.attrs.model||(i=/^"(.*?)"\s*(<\s*(.*?)\s*>)?$/.exec(e.attrs.value),_.isArray(i)?(e.attrs.label=s.removeQuotes(i[1]),e.attrs.value=i[3]):i=["",e.attrs.value,"",e.attrs.value],e.attrs.model=new c({type:5,display_name:i[1],email1:i[3]})),e.attrs.model.has("distribution_list")){a.pause(),r.validateDistributionList(e.attrs.model.get("distribution_list"));var d=_.chain(e.attrs.model.get("distribution_list")).filter(function(e){return!!e.mail}).map(function(e){return e.type=5,new c({type:5,display_name:e.display_name,email1:e.mail}).set("token",{label:e.display_name,value:e.mail},{silent:!0})}).value(),u=e.attrs.model.get("display_name"),h=_(d).map(function(e){return[e.get("token").label+", "+e.get("token").value]});return t.$el.trigger("aria-live-update",1===h.length?l("Added distribution list %s with %s member. The only member of the distribution list is %s.",u,h.length,h.join(", ")):l("Added distribution list %s with %s members. Members of the distribution list are %s.",u,h.length,h.join(", "))),t.collection.add(d),t.redrawTokens(),t.input.data("ttTypeahead").input.$input.val(""),a.resume(),!1}e.attrs.model.set("token",{label:e.attrs.label,value:e.attrs.value},{silent:!0}),e.attrs.value=e.attrs.model.cid;var p;e.attrs.model.get("display_name")?p=e.attrs.model.value&&e.attrs.model.value!==e.attrs.model.get("display_name")?l("Added %1$s, %2$s.",e.attrs.model.get("display_name"),e.attrs.model.value):l("Added %1$s.",e.attrs.model.get("display_name")):e.attrs.model.get("name")&&e.attrs.model.get("detail")?p=l("Added %1$s, %2$s.",e.attrs.model.get("name"),e.attrs.model.get("detail")):e.attrs.model.get("name")&&(p=l("Added %1$s.",e.attrs.model.get("name"))),p&&t.$el.trigger("aria-live-update",p),t.collection.add(e.attrs.model)}},"tokenfield:createdtoken":function(i){if(i.attrs){var n=i.attrs.model||t.getModelByCID(i.attrs.value),o=$(i.relatedTarget),a=o.find(".token-label"),s=n.get("token"),r=s.label&&s.label!==s.value?s.label+" "+s.value:s.value;"0px"===a.css("max-width")&&a.css("max-width","none"),a.attr({"aria-hidden":!0,title:r}),o.attr("aria-label",l("%1$s. Press backspace to delete.",r)),e.point(t.options.extPoint+"/token").invoke("draw",i.relatedTarget,n,i,t.getInput())}},"tokenfield:edittoken":function(e){if(e.attrs&&e.attrs.model){var i=e.attrs.model.get("token");t.getInput().data("editModel",e.attrs.model),e.attrs.value=i.label,i.value!==i.label&&(e.attrs.value=i.label?'"'+s.removeQuotes(i.label)+'" <'+i.value+">":i.value),t.getInput().one("blur",function(){for(var e=t.$el.parent().find(".token"),i=t.getInput().data().editModel.cid,n=!1,o=0;o<e.length;o++)if($(e[o]).data("attrs").value===i)return void(n=!0);n||t.collection.remove(t.getModelByCID(i))})}},"tokenfield:removetoken":function(e){_([].concat(e.attrs)).each(function(e){var i=t.getModelByCID(e.value);if(i){var n;i.get("display_name")?n=i.value&&i.value!==i.get("display_name")?l("Removed %1$s, %2$s.",i.get("display_name"),i.value):l("Removed %1$s.",i.get("display_name")):i.get("name")&&i.get("detail")?n=l("Removed %1$s, %2$s.",i.get("name"),i.get("detail")):i.get("name")&&(n=l("Removed %1$s.",i.get("name"))),n&&t.$el.trigger("aria-live-update",n),t.collection.remove(i)}})}})},render:function(){var e=this.options,i=this;this.$el.addClass("tokenfield").tokenfield({createTokensOnBlur:e.createTokensOnBlur,minLength:e.minLength,delimiter:_.isUndefined(e.delimiter)?void 0:e.delimiter,allowEditing:e.allowEditing,typeahead:i.typeaheadOptions,html:this.options.html||!1,inputType:this.options.inputtype||"email",isMail:e.isMail,minWidth:0}),this.register(),this.input=$(this.$el).data("bs.tokenfield").$input,t.prototype.render.call({$el:this.input,model:this.model,options:this.options}),this.hiddenapi=this.input.data("ttTypeahead");var n=_.extend(this.hiddenapi.dropdown,{onDropdownMouseEnter:function(){d=!0},onDropdownMouseLeave:function(){d=!1}});return(_.browser.IE||_.browser.Edge<79)&&(this.input.off("blur.tt").on("blur.tt",function(){d||(this.resetInputValue(),this.trigger("blurred"))}.bind(this.hiddenapi.input)),n.$menu.on("mouseenter.tt",n.onDropdownMouseEnter.bind(n)).on("mouseleave.tt",n.onDropdownMouseLeave.bind(n))),(_.device("smartphone")||e.leftAligned)&&(this.hiddenapi.dropdown._show=function(){var t="auto",n=0;_.device("smartphone")?(n=-1*i.input.offset().left,t=window.innerWidth):e.leftAligned&&(n=i.input.position().left,n=-1*Math.round(n)+17),this.$menu.css({left:n,width:t}).show()}),this.hiddenapi.input._callbacks.enterKeyed.sync[0]=function(e,t){var i=this.dropdown.getDatumForCursor(),n=this.dropdown.getDatumForTopSuggestion(),o=this.input.getHint();i&&_.isEmpty(o)?(this._select(i),t.preventDefault()):this.autoselect&&n&&(this._select(n),t.preventDefault())}.bind(this.hiddenapi),this.hiddenapi.input.$input.on("keydown",function(e){var t=!!this.hiddenapi.dropdown.getDatumForCursor();32===e.which&&t&&this.hiddenapi._onEnterKeyed("ox.spaceKeyed",e)}.bind(this)),this.options.delayedautoselect&&this.input.on("keydown",function(t){var n=13===t.which,o=32===t.which,a=!!i.input.val()&&i.input.val().length>=e.minLength,s=i.model.get("query")!==i.input.val(),r=38===t.which||40===t.which;!s||n||o||r||(i.hiddenapi.dropdown.empty(),i.hiddenapi.dropdown.close()),n&&a&&s&&(i.autoselect[i.input.val()]=!0)}),this.$el.parent().addClass(this.options.className),this.options.dnd&&this.$el.closest("div.tokenfield").sortable({items:"> .token",connectWith:"div.tokenfield",cancel:"a.close",placeholder:"token placeholder",revert:0,tolerance:"pointer",forcePlaceholderSize:!0,stop:function(e,t){this.isMultisort&&t.item.after($(this).find(".active")),i.resort()},start:function(e,t){t.item.hasClass("active")&&$(this).find(".active").length>1?(_($(this).find(".active")).each(function(e){e!==t.item[0]&&$(e).hide()}),t.item.append($('<span class="drag-counter badge">').text($(this).find(".active").length)),this.isMultisort=!0,this.multisortData=_($(this).find(".active")).map(function(e){return $(e).data().attrs.model})):(this.isMultisort=!1,this.multisortData=[])},receive:function(e,t){var n=t.sender[0].isMultisort?t.sender[0].multisortData:t.item.data().attrs.model;i.collection.add(n),i.resort()},remove:function(e,t){var n=this.isMultisort?this.multisortData:t.item.data().attrs.model;i.collection.remove(n),i.resort()}}).droppable({hoverClass:"drophover"}),this.$el.closest("div.tokenfield").on("copy",function(e){var t=e.target.value.split(", "),n="";_(t).each(function(e){var t=i.collection.get(e);t&&(n=n+(""===n?"":", ")+t.value)}),""!==n&&(e.originalEvent.clipboardData.setData("text/plain",n),e.preventDefault())}),this.getInput().on("focus blur updateWidth",function(e){var t=i.$el.data("bs.tokenfield");t.options.minWidth="focus"===e.type?1:0,t.update()}),this},getModelByCID:function(e){return this.collection.get({cid:e})},redrawTokens:function(){var e=[],t=this;this.redrawLock=!0,this.collection.each(function(i){e.push({label:i.getDisplayName({isMail:t.options.isMail}),value:i.cid,model:i})}),this.$el.tokenfield("setTokens",e,!1),this.redrawLock=!1},resort:function(){var e=this.collection;_(this.$el.tokenfield("getTokens")).each(function(t,i){e.get({cid:t.value})&&(e.get({cid:t.value}).index=i)}),e.sort(),this.redrawTokens()},getInput:function(){return this.input},setFocus:function(){this.$el.parent().find(".token-input").focus()}})}),define("io.ox/core/tk/typeahead",["io.ox/core/extensions","io.ox/core/api/autocomplete","settings!io.ox/contacts","settings!io.ox/core","static/3rd.party/typeahead.jquery.js","css!3rd.party/bootstrap-tokenfield/css/tokenfield-typeahead.css"],function(e,t,i,n){function o(e,t){return this.model.set({source:e}),t}return Backbone.View.extend({el:'<input type="text" class="form-control">',options:{apiOptions:{contacts:!1,users:!1,groups:!1,resources:!1,distributionlists:!1},source:function(e){return this.api.search(e)},click:$.noop,autoselect:!0,hint:!0,reduce:_.identity,harmonize:_.identity,init:!0,extPoint:"io.ox/core/tk/typeahead"},initialize:function(a){var s=this;if(this.model=new Backbone.Model({source:"idle",query:void 0,dropdown:"closed"}),a.apiOptions){var r=void 0!==a.apiOptions.limit?a.apiOptions.limit:n.get("autocompleteApiLimit",10);a.apiOptions.limit=r,a.maxResults||(a.maxResults=n.get("autocompleteDrawLimit",r*_(a.apiOptions).filter(function(e){return!0===e}).length))}else a.maxResults=n.get("autocompleteDrawLimit",25);a=this.options=$.extend({},this.options,a||{}),this.api=new t(_.extend({extPoint:/^io\.ox\/core\/tk\/(typeahead|tokenfield)$/.test(a.extPoint)?void 0:a.extPoint},a.apiOptions)),this.listenTo(ox,"refresh^",function(){this.api.cache={}}),this.process=function(e,t,i){$.when(i).then(o.bind(s,"processing")).then(a.reduce).then(function(e){return a.maxResults&&(e=e.slice(0,a.maxResults)),"top"===a.placement?e.reverse():e}).then(a.harmonize).then(o.bind(s,"finished")).then(o.bind(s,"idle")).then(t)},this.typeaheadOptions=[{autoselect:a.autoselect,minLength:Math.max(1,i.get("search/minimumQueryLength",2)),highlight:!0,hint:a.hint},{source:function(e,t){if(o.call(s,"requesting"),a.source.call(s,e).then(_.lfo(s.process,e,t)),!s.registered){var i=this;i.onSync("rendered",function(){var e=i.$el.closest(".twitter-typeahead").find(".tt-dropdown-menu"),t=e.find(".tt-dataset-0").is(":empty"),n=e.find("span.info").attr("data-query");t||s.model.set("query",n),e.is(":visible")&&s.model.set("dropdown","opened"),n&&s.trigger("typeahead-custom:dropdown-rendered",e)}),s.registered=!0}},templates:{suggestion:a.suggestion||function(t){var i=$('<div class="autocomplete-item">');return e.point(a.extPoint+"/autoCompleteItem").invoke("draw",i,t,a),i},header:function(e){return $('<span class="info hidden">').attr("data-query",e.query)}}}],e.point(a.extPoint+"/typeahead/customize").invoke("customize",this)},render:function(){function e(e){if(!e||!e.originalEvent)return!0;var t=e.originalEvent.movementX,i=e.originalEvent.movementY;return 0!==t||0!==i||void 0}var t=this.options,i=this;this.$el.attr({placeholder:this.options.placeholder,"aria-label":this.options.ariaLabel}).on({"typeahead:closed":function(){i.$el.closest(".twitter-typeahead").find(".tt-dropdown-menu").is(":visible")||i.model.set("dropdown","closed")},"typeahead:selected typeahead:autocompleted":function(e,n){t.click.call(this,e,n),i.$el.trigger("select",n),i.$el.typeahead("val","")}}),this.$el.on({"typeahead:cursorchanged":function(){var e=i.$el.closest(".twitter-typeahead").find(".tt-cursor").attr("id");i.$el.attr("aria-activedescendant",e)}}),this.model.on("change:dropdown",function(e,t){if("closed"===t)return i.$el.removeAttr("aria-activedescendant");var n=i.$el.closest(".twitter-typeahead").find(".tt-dropdown-menu"),o=$('<div class="tt-suggestions" role="listbox">'),a=n.find(".tt-suggestions").children();o.append(a.each(function(){$(this).attr({id:_.uniqueId("option_"),role:"option"})})),n.find(".tt-suggestions").replaceWith(o),n.scrollTop(0)}),this.options.init&&(this.$el.typeahead.apply(this.$el,this.typeaheadOptions),this.$el.data("ttTypeahead").input._callbacks.enterKeyed.sync[0]=function(e,t){var i=this.dropdown.getDatumForCursor(),n=this.dropdown.getDatumForTopSuggestion(),o=this.input.getHint();i&&_.isEmpty(o)?(this._select(i),t.preventDefault()):this.autoselect&&n&&(this._select(n),t.preventDefault())}.bind(this.$el.data("ttTypeahead"))),ox.debug&&ox.debug_typeahead&&(this.$el.data("ttTypeahead").dropdown.close=$.noop,this.$el.data("ttTypeahead").dropdown.empty=$.noop);var n=_.extend(this.$el.data("ttTypeahead").dropdown,{_onSuggestionMouseEnter:function(t){e(t)&&(this._removeCursor(),this._setCursor($(t.currentTarget),!0))},_onSuggestionMouseLeave:function(t){e(t)&&this._removeCursor()}});return this.options.keepInComposeWindow&&_.extend(n,{_show:function(){this.$menu.css({left:0,display:"block"}),this.$menu.css("left",Math.min(0,this.$menu.closest(".io-ox-mail-compose").offset().left+this.$menu.closest(".io-ox-mail-compose").outerWidth()-(this.$menu.offset().left+this.$menu.outerWidth()+15)))}}),n.$menu.off("mouseenter.tt mouseleave.tt").on("mouseenter.tt mousemove.tt",".tt-suggestion",n._onSuggestionMouseEnter.bind(n)).on("mouseleave.tt",".tt-suggestion",n._onSuggestionMouseLeave.bind(n)),this}})}),define("io.ox/participants/model",["io.ox/core/api/user","io.ox/core/api/group","io.ox/core/api/resource","io.ox/contacts/api","io.ox/contacts/model","io.ox/contacts/util"],function(e,t,i,n,o,a){function s(i){return $.Deferred().resolve().then(function(){var e=i instanceof Backbone.Model?i.get("members"):i.members;return e?{members:e}:t.get({id:i.id||i.get("id")})}).then(function(t){return e.getList(t.members)}).then(function(e){return _.sortBy(e,"last_name")})}function r(e,t){return(e=e||{}).get?e.get(t):e[t]}var l={UNKNOWN:0,USER:1,USER_GROUP:2,RESOURCE:3,RESOURCE_GROUP:4,EXTERNAL_USER:5,DISTLIST:6},d={0:"unknown",1:"internal",2:"usergroup",3:"resource",4:"resourcegroup",5:"external",6:"distlist"},c=Backbone.Model.extend({idAttribute:"pid",defaults:{display_name:"",email1:"",field:"email1",type:5},loading:null,initialize:function(){var e=this;if(_.isString(this.get("type"))){var t=l.UNKNOWN;switch(this.get("type")){case"user":t=l.USER;break;case"group":t=l.USER_GROUP;break;case"resource":t=l.RESOURCE;break;case"contact":t=this.get("mark_as_distributionlist")?l.DISTLIST:l.EXTERNAL_USER}this.set("type",t)}this.get("mail_field")&&this.set("field","email"+this.get("mail_field")),this.loading=this.fetch().then(function(){e.magic()})},magic:function(){this.is("special-contact")&&this.set({type:l.USER,contact_id:this.get("id"),id:this.get("internal_userid")}),this.is("special-user")&&this.set({type:l.EXTERNAL_USER,internal_userid:this.get("id"),id:this.get("contact_id")}),this.is("contact")&&!this.has("id")&&this.set("id",this.getEmail(),{silent:!0}),this.setPID(),this.value=this.getTarget()||this.getDisplayName()},setPID:function(){var e=[d[this.get("type")],this.get("id"),this.get("field")].join("_");this.set("pid",e,{silent:!0})},is:function(e){switch(e){case"user":return this.get("type")===l.USER;case"contact":return this.get("type")===l.EXTERNAL_USER;case"group":return this.get("type")===l.USER_GROUP;case"resource":return this.get("type")===l.RESOURCE;case"list":return this.get("type")===l.DISTLIST;case"unknown":return this.get("type")===l.UNKNOWN;case"special-contact":return this.is("contact")&&this.get("internal_userid")&&"email1"===this.get("field");case"special-user":return this.is("user")&&this.get("contact_id")&&this.has("field")&&"email1"!==this.get("field")}},getContactID:function(){return this.is("user")&&this.get("contact_id")?this.get("contact_id"):this.get("id")},getDisplayName:function(e){return((e=e||{}).isMail?a.getMailFullName(this.toJSON(),e.asHtml):a.getFullName(this.toJSON(),e.asHtml))||(""!==this.getEmail()?this.getEmail():"")},getEmail:function(){return a.getMail(this.toJSON())},getTarget:function(e){return(e=_.extend({fallback:!1,strict:!1},e)).fallback&&this.is("list")?"distribution_list":!e.strict||0===this.get("mail_field")&&this.get("mail")?this.get(this.get("field"))||this.getEmail():this.get(this.get("field"))},getFieldString:function(){return this.has("field")?o.fields[this.get("field")]:""},getFieldNumber:function(){return _.isNumber(this.get("mail_field"))?this.get("mail_field"):this.get("field")?parseInt(this.get("field").slice(-1),10):0},getAPIData:function(){var e={type:this.get("type")};if(this.get("field")&&(e.field=this.get("field")),5===this.get("type")){e.mail=this.getTarget();var t=this.getDisplayName(this.toJSON());_.isEmpty(t)||(e.display_name=t)}else this.has("id")&&(e.id=this.get("id"));return e},fetch:function(){var o=this,a=function(e){o.set(e)};switch(this.get("type")){case l.USER:if(this.get("display_name")&&"image1_url"in this.attributes)break;return e.get({id:this.get("id")}).then(a);case l.USER_GROUP:if(this.get("display_name")&&this.get("members"))break;return t.get({id:this.get("id")}).then(a);case l.RESOURCE:if(this.get("display_name"))break;return i.get({id:this.get("id")}).then(a);case l.RESOURCE_GROUP:this.set("display_name","resource group");break;case l.EXTERNAL_USER:if(this.get("display_name")&&"image1_url"in this.attributes)break;return this.get("id")&&this.get("folder_id")?n.get(this.pick("id","folder_id")).then(a):n.getByEmailaddress(this.getEmail()).then(function(e){o.get("display_name")&&(e=_(e).omit("first_name","last_name","display_name")),o.has("mail")&&o.get("mail")!==e[o.get("field")]&&_.each(["email1","email2","email3"],function(t){e[t]===o.get("mail")&&(e.field=t)}),o.set(e)});case l.DISTLIST:if(this.get("display_name")&&"distribution_list"in this.attributes)break;return n.get(this.pick("id","folder_id")).then(a)}return $.when()}});return{Participant:c,Participants:Backbone.Collection.extend({model:c,getAPIData:function(){return this.map(function(e){return e.getAPIData()})},initialize:function(e,t){var i=this;this.options=t||{},this.on("change",function(){var e={},t=[];i.each(function(i){i.id&&(e[i.id]?t.push(i):e[i.id]=!0)}),i.remove(t)}),this.oldAdd=this.add,this.add=this.addUniquely,this.processing=[]},resolve:function(){return $.when.apply($,this.processing)},addUniquely:function(e,t){var i,n=this;i=_.map([].concat(e),function(e){if(n.options.splitGroups&&2===r(e,"type"))return s(e).then(n.addUniquely.bind(n));e=r(e,"mark_as_distributionlist")?r(e,"distribution_list"):e;var i=[],o=[],l=[];return _.each([].concat(e),function(e){var t=e instanceof n.model?e:new n.model(e);!n.options.needsMail||void 0===t.get("mail_field")||t.get("mail")?(i.push(t),o.push(t.loading)):l.push(t)}),a.validateDistributionList(l),$.when.apply($,o).then(function(){return i=_(i).sortBy(function(e){return e.get("last_name")}),_(i).each(function(e){n.oldAdd(e,t)}),i})}),this.processing=this.processing.concat(_.flatten(i))}})}}),define("io.ox/participants/views",["io.ox/contacts/api","io.ox/core/util","io.ox/core/folder/api","io.ox/core/capabilities","gettext!io.ox/core","less!io.ox/participants/style"],function(e,t,i,n,o){var a={0:o("Unknown"),1:"",2:o("Group"),3:o("Resource"),4:o("Resource group"),5:n.has("gab")?o("External contact"):"",6:o("Distribution list")},s={0:"default-image",1:"contact-image",2:"group-image",3:"resource-image",4:"resource-image",5:"external-user-image",6:"group-image"},r=Backbone.View.extend({tagName:"div",className:"participant-wrapper",events:{"click .remove":"onRemove",keydown:"fnKey"},options:{halo:!1,closeButton:!1,field:!1,customize:$.noop},nodes:{},initialize:function(e){this.options=$.extend({},this.options,e||{}),this.listenTo(this.model,"change",function(e){e&&e.changed&&(this.$el.empty(),this.render())}),this.listenTo(this.model,"remove",function(){this.remove()})},render:function(){return this.$el.append(this.nodes.$img=$("<div>"),this.nodes.$text=$('<div class="participant-name">'),this.options.hideMail?"":$('<div class="participant-email">').append(this.nodes.$mail=this.options.halo?$("<a>"):$("<span>")),this.options.hideMail?"":$('<div class="extra-decorator">').append(this.nodes.$extra=$("<span>")),$('<a href="#" class="remove" role="button">').append($('<div class="icon">').append($('<i class="fa fa-trash-o" aria-hidden="true">').attr("title",o("Remove contact")+" "+this.model.getDisplayName()),$('<span class="sr-only">').text(o("Remove contact")+" "+this.model.getDisplayName())))).attr({"data-cid":this.model.cid}).toggleClass("removable",this.options.closeButton),this.setCustomImage(),this.setDisplayName(),this.setTypeStyle(),this.options.customize.call(this),this.trigger("render"),this},setDisplayName:function(){var e={$el:this.nodes.$text};this.options.asHtml?e.html=this.model.getDisplayName({asHtml:!0,isMail:this.options.isMail}):e.name=this.model.getDisplayName({asHtml:!1,isMail:this.options.isMail}),t.renderPersonalName(e,this.model.toJSON())},setCustomImage:function(){var t=this.model.toJSON();5===t.type&&delete t.id,e.pictureHalo(this.nodes.$img,t,{width:54,height:54}),this.nodes.$img.attr("aria-hidden",!0).addClass("participant-image "+(s[parseInt(this.model.get("type"),10)]||""))},setRows:function(e,t){this.options.hideMail||(t=t||a[this.model.get("type")]||"",this.nodes.$mail.text(e),this.nodes.$extra.text(t),e&&t&&this.$el.addClass("three-rows"))},isOrganizer:function(){if(!this.options.baton)return!1;var e=this.options.baton.model.toJSON();return!!e.organizerId&&this.model.get("id")===e.organizerId},isRemovable:function(){if(!this.options.baton)return!1;var e=this.options.baton.model.toJSON();return this.model.get("id")!==e.organizerId||i.pool.getModel(e.folder_id).is("public")},setTypeStyle:function(){var e=this.model.getTarget({strict:this.options.strict}),t=null;switch(e&&this.options.field&&this.model.getFieldString()&&(e+=" ("+this.model.getFieldString()+")"),this.model.get("type")){case 1:case 5:this.isOrganizer()&&(t=o("Organizer"),this.isRemovable()||this.$el.removeClass("removable")),e&&this.options.halo&&this.nodes.$mail.attr({href:"mailto:"+e}).data({email1:e}).addClass("halo-link");break;case 3:if(this.options.halo&&!this.options.hideMail){var i=this.model.toJSON();i.callbacks={},this.options.baton&&this.options.baton.callbacks&&(i.callbacks=this.options.baton.callbacks);var n=$('<a href="#">').data(i).addClass("halo-resource-link");this.nodes.$extra.replaceWith(n),this.nodes.$extra=n}}this.setRows(e,t)},fnKey:function(e){46!==e.which&&8!==e.which||this.onRemove(e)},onRemove:function(e){e.preventDefault(),this.model.collection.remove(this.model)}}),l=Backbone.View.extend({tagName:"div",className:"participantsrow col-xs-12",initialize:function(e){this.options=_.extend({empty:o("This list has no participants yet")},e),this.listenTo(this.collection,"add",function(e){this.renderLabel(),this.renderEmptyLabel(),this.renderParticipant(e)}),this.listenTo(this.collection,"remove",function(){this.renderLabel(),this.renderEmptyLabel()}),this.listenTo(this.collection,"reset",function(){this.$ul.empty(),this.renderAll()}),this.$empty=$("<li>").text(this.options.empty),this.options.baton||(this.isDistributionList=this.options.baton.model.has("mark_as_distributionlist"))},render:function(){return this.$el.append($("<fieldset>").append($("<legend>").addClass(this.options.labelClass||""),this.$ul=$('<ul class="list-unstyled">'))),this.renderAll(),this},renderLabel:function(){var e=this.collection.length,t=this.options.label||(this.isDistributionList?o("Members (%1$d)",e):o("Participants (%1$d)",e));this.$("fieldset > legend").text(t)},renderParticipant:function(e){var t=new r({tagName:"li",model:e,baton:this.options.baton,halo:void 0===this.options.halo||this.options.halo,closeButton:!0,hideMail:this.options.hideMail,asHtml:this.options.asHtml,isMail:this.options.isMail,strict:this.options.strict});t.on("render",function(){this.collection.trigger("render")}.bind(this)),t.render().$el.addClass(this.options.entryClass||"col-xs-12 col-sm-6"),e.get("id")===this.options.baton.model.get("organizerId")?this.$ul.prepend(t.$el):this.$ul.append(t.$el)},renderAll:function(){var e=this;return this.renderLabel(),this.renderEmptyLabel(),this.collection.each(function(t){e.renderParticipant(t)}),this},renderEmptyLabel:function(){if(!this.options.noEmptyLabel)return 0===this.collection.length?this.$ul.append(this.$empty):this.$empty.remove(),this.$ul.toggleClass("empty",0===this.collection.length)}});return{ParticipantEntryView:r,UserContainer:l}}),define("io.ox/core/api/autocomplete",["io.ox/core/http","io.ox/core/capabilities","io.ox/contacts/api","io.ox/core/api/resource","io.ox/core/api/group","io.ox/core/extensions","settings!io.ox/contacts"],function(e,t,i,n,o,a,s){function r(e){var t=this;this.options=$.extend({users:!1,contacts:!1,distributionlists:!1,resources:!1,groups:!1,split:!0,limit:0},e),this.cache={},this.apis=[],e.users&&this.apis.push({type:"user",api:i}),e.contacts&&this.apis.push({type:"contact",api:i}),e.resources&&this.apis.push({type:"resource",api:n}),e.groups&&this.apis.push({type:"group",api:o}),this.fields=this.options.split?["email1","email2","email3"]:["email1"],e.extPoint&&a.point(e.extPoint+"/autocomplete/customize").invoke("customize",this),a.point("io.ox/core/api/autocomplete/customize").invoke("customize",this),i.on("maybeNewContact",function(){t.cache={}})}return r.prototype={search:function(t){t="string"!=typeof t?"":$.trim(t).toLowerCase();var i=this,n={admin:s.get("showAdmin",!1),emailAutoComplete:!1,limit:this.options.limit};if(t in this.cache)return $.Deferred().resolve(this.cache[t]);try{return e.pause(),$.when.apply($,_(i.apis).map(function(e){return(e.api.autocomplete||e.api.search)(t,n)})).then(function(){var e=[],o=_(arguments).toArray();return _(i.apis).each(function(a,s){var r=_(o[s]).map(function(e){return e.type=a.type,e});e=e.concat(r),/contact|custom|user/.test(a.type)&&(e=i.processContactResults(e,t),n.limit&&(e=e.slice(0,n.limit)))}),i.cache[t]=e})}finally{e.resume()}},processContactResults:function(e,t){function i(e,t){return("contact"!==t||!s[e])&&(!o[e]&&(o[e]=!0))}var n=[],o={},a=this,s={};return _(e).each(function(e){/contact|custom|user/.test(e.type)?e.mark_as_distributionlist?a.options.distributionlists&&n.push(e):_.each(a.fields,function(i){if(e[i]){if(6!==e.folder_id&&"user"===e.type)return;if(a.options.users&&6===e.folder_id&&"contact"===e.type)return;"user"===e.type&&e.internal_userid&&(e.contact_id=e.id,e.id=e.internal_userid,delete e.internal_userid);var o=_.extend({},e);o.field=i,e[i]===t?n.unshift(o):n.push(o),"user"===e.type&&(s[e.sort_name+"_"+e[i]]=!0)}}):n.push(e)}),n=_(n).filter(function(e){return e.mark_as_distributionlist?i(_.cid(e)):i(e.sort_name+"_"+e[e.field],e.type)}),o=null,s=null,n}},r}),define("io.ox/contacts/model",["io.ox/backbone/modelFactory","io.ox/backbone/validation","io.ox/core/extensions","io.ox/contacts/api","io.ox/settings/util","io.ox/core/strings","gettext!io.ox/contacts"],function(e,t,i,n,o,a,s){function r(n,r){var l="io.ox/core/user/model"===n,d=new e({api:r,ref:n,updateEvents:["edit"],create:function(e){var t=e.toJSON(),i=t.pictureFileEdited||t.pictureFile;return t=_.omit(t,["crop","pictureFile","pictureFileEdited","image1"]),r.create(t,i)},update:function(e){var t=e.changedSinceLoading(),i=t.pictureFileEdited||t.pictureFile,n=l?o.yellOnReject:_.identity;return t=_.omit(t,["crop","pictureFile","pictureFileEdited"]),i?r.editNewImage({id:e.id,folder_id:e.get("folder_id")},_.omit(t,"image1"),i):n(r.update({id:e.id,folder:e.get("folder_id"),last_modified:e.get("last_modified"),data:t}))},destroy:function(e){return r.remove({id:e.id,folder_id:e.get("folder_id")})}});return t.validationFor(n,{display_name:{format:"string"},first_name:{format:"string"},last_name:{format:"string"},second_name:{format:"string"},suffix:{format:"string"},title:{format:"string"},street_home:{format:"string"},postal_code_home:{format:"string"},city_home:{format:"string"},state_home:{format:"string"},country_home:{format:"string"},birthday:{format:"date"},marital_status:{format:"string"},number_of_children:{format:"string"},profession:{format:"string"},nickname:{format:"string"},spouse_name:{format:"string"},anniversary:{format:"date"},note:{format:"text"},department:{format:"string"},position:{format:"string"},employee_type:{format:"string"},room_number:{format:"string"},street_business:{format:"string"},postal_code_business:{format:"string"},city_business:{format:"string"},state_business:{format:"string"},country_business:{format:"string"},number_of_employees:{format:"string"},sales_volume:{format:"string"},tax_id:{format:"string"},commercial_register:{format:"string"},branches:{format:"string"},business_category:{format:"string"},info:{format:"string"},manager_name:{format:"string"},assistant_name:{format:"string"},street_other:{format:"string"},city_other:{format:"string"},postal_code_other:{format:"string"},country_other:{format:"string"},telephone_business1:{format:"phone"},telephone_business2:{format:"phone"},fax_business:{format:"phone"},telephone_callback:{format:"phone"},telephone_car:{format:"phone"},telephone_company:{format:"phone"},telephone_home1:{format:"phone"},telephone_home2:{format:"phone"},fax_home:{format:"phone"},cellular_telephone1:{format:"phone"},cellular_telephone2:{format:"phone"},telephone_other:{format:"phone"},fax_other:{format:"phone"},email1:{format:"email"},email2:{format:"email"},email3:{format:"email"},url:{format:"url"},telephone_isdn:{format:"phone"},telephone_pager:{format:"phone"},telephone_primary:{format:"phone"},telephone_radio:{format:"phone"},telephone_telex:{format:"phone"},telephone_ttytdd:{format:"phone"},instant_messenger1:{format:"string"},instant_messenger2:{format:"string"},telephone_ip:{format:"phone"},telephone_assistant:{format:"phone"},company:{format:"string"},image1:{format:"string"},userfield01:{format:"string"},userfield02:{format:"string"},userfield03:{format:"string"},userfield04:{format:"string"},userfield05:{format:"string"},userfield06:{format:"string"},userfield07:{format:"string"},userfield08:{format:"string"},userfield09:{format:"string"},userfield10:{format:"string"},userfield11:{format:"string"},userfield12:{format:"string"},userfield13:{format:"string"},userfield14:{format:"string"},userfield15:{format:"string"},userfield16:{format:"string"},userfield17:{format:"string"},userfield18:{format:"string"},userfield19:{format:"string"},userfield20:{format:"string"},links:{format:"array"},distribution_list:{format:"array"},number_of_links:{format:"number"},number_of_images:{format:"number"},image_last_modified:{format:"number"},state_other:{format:"string"},file_as:{format:"string"},image1_content_type:{format:"string"},mark_as_distributionlist:{format:"boolean"},default_address:{format:"number"},image1_url:{format:"url"},internal_userid:{format:"number"},useCount:{format:"number"},yomiFirstName:{format:"string"},yomiLastName:{format:"string"},yomiCompany:{format:"string"},addressHome:{format:"string"},addressBusiness:{format:"string"},addressOther:{format:"string"},private_flag:{format:"boolean"}}),i.point(n+"/validation").extend({id:"upload_quota",validate:function(e){e.quotaExceeded&&this.add("attachments_list",s("Files can not be uploaded, because upload limit of %1$s is exceeded.",a.fileSize(e.quotaExceeded.attachmentMaxUploadSize,2)))}}),i.point(n+"/validation").extend({id:"birthday",validate:function(e){"birthday"in e&&null!==e.birthday&&!_.isNumber(e.birthday)&&this.add("birthday",s("Please set day and month properly"))}}),i.point(n+"/validation").extend({id:"first_name",validate:function(e){!e.user_id||e.first_name&&!_.isEmpty(String(e.first_name).trim())||this.add("first_name",s("First name must not be empty for internal users"))}}),i.point(n+"/validation").extend({id:"last_name",validate:function(e){!e.user_id||e.last_name&&!_.isEmpty(String(e.last_name).trim())||this.add("last_name",s("Last name must not be empty for internal users"))}}),d}var l={display_name:s("Display name"),first_name:s("First name"),last_name:s("Last name"),second_name:s("Middle name"),suffix:s("Suffix"),title:s.pgettext("salutation","Title"),street_home:s("Street"),postal_code_home:s("Postcode"),city_home:s("City"),state_home:s("State"),country_home:s("Country"),birthday:s("Birthday"),marital_status:s("Marital status"),number_of_children:s("Children"),profession:s("Profession"),nickname:s("Nickname"),spouse_name:s("Spouse's name"),anniversary:s("Anniversary"),note:s("Comment"),department:s("Department"),position:s("Position"),employee_type:s("Employee type"),room_number:s("Room number"),street_business:s("Street"),postal_code_business:s("Postcode"),city_business:s("City"),state_business:s("State"),country_business:s("Country"),number_of_employees:s("Employee ID"),sales_volume:s("Sales Volume"),tax_id:s("TAX ID"),commercial_register:s("Commercial Register"),branches:s("Branches"),business_category:s("Business category"),info:s("Info"),manager_name:s("Manager"),assistant_name:s("Assistant"),street_other:s("Street"),city_other:s("City"),postal_code_other:s("Postcode"),country_other:s("Country"),telephone_business1:s("Phone (business)"),telephone_business2:s("Phone (business alt)"),fax_business:s("Fax"),telephone_callback:s("Telephone callback"),telephone_car:s("Phone (car)"),telephone_company:s("Phone (company)"),telephone_home1:s("Phone (home)"),telephone_home2:s("Phone (home alt)"),fax_home:s("Fax (Home)"),cellular_telephone1:s("Cell phone"),cellular_telephone2:s("Cell phone (alt)"),telephone_other:s("Phone (other)"),fax_other:s("Fax (alt)"),email1:s("Email 1"),email2:s("Email 2"),email3:s("Email 3"),url:s("URL"),telephone_isdn:s("Telephone (ISDN)"),telephone_pager:s("Pager"),telephone_primary:s("Telephone primary"),telephone_radio:s("Telephone radio"),telephone_telex:s("Telex"),telephone_ttytdd:s("TTY/TDD"),instant_messenger1:s("Instant Messenger 1"),instant_messenger2:s("Instant Messenger 2"),telephone_ip:s("IP phone"),telephone_assistant:s("Phone (assistant)"),company:s("Company"),image1:s("Image 1"),userfield01:s("Optional 01"),userfield02:s("Optional 02"),userfield03:s("Optional 03"),userfield04:s("Optional 04"),userfield05:s("Optional 05"),userfield06:s("Optional 06"),userfield07:s("Optional 07"),userfield08:s("Optional 08"),userfield09:s("Optional 09"),userfield10:s("Optional 10"),userfield11:s("Optional 11"),userfield12:s("Optional 12"),userfield13:s("Optional 13"),userfield14:s("Optional 14"),userfield15:s("Optional 15"),userfield16:s("Optional 16"),userfield17:s("Optional 17"),userfield18:s("Optional 18"),userfield19:s("Optional 19"),userfield20:s("Optional 20"),links:s("Links"),distribution_list:s("Distribution list"),state_other:s("State"),mark_as_distributionlist:s("Mark as distributionlist"),default_address:s("Default address"),addressHome:s("Address Home"),addressBusiness:s("Address Business"),addressOther:s("Address Other"),private_flag:s("This contact is private and cannot be shared"),number_of_links:"Number of links",number_of_images:"Number of images",image_last_modified:"Image last modified",file_as:"File as",image1_content_type:"Image1 content type",image1_url:"Image1 url",internal_userid:"Internal userid",useCount:"use Count",yomiFirstName:"yomi First Name",yomiLastName:"yomi Last Name",yomiCompany:"yomi Company"},d=r("io.ox/contacts/model",n);return{Contact:d.model,Contacts:d.collection,factory:d,api:n,fields:l,protectedMethods:{buildFactory:r}}}),define("io.ox/backbone/modelFactory",["io.ox/backbone/basicModel","io.ox/core/extensions"],function(e,t){function i(e,t){var i={},n={},o=this,a=0;this.internal={cachedServerAttributes:function(e){return n[e]||{}}},this.create=function(e){var o=new t.model(e),a=t.internal.toUniqueIdFromObject(e);return i[a]=o,n[a]=JSON.parse(JSON.stringify(o.toJSON())),o},this.get=function(){var e=$.makeArray(arguments),a=t.internal.toUniqueIdFromGet.apply(t,e),s=$.Deferred();return i[a]?$.Deferred().resolve(i[a]):(t.internal.load.apply(t.internal,e).done(function(e){e._realm=o;var a=new t.model(e);i[a.id]=a,n[a.id]=JSON.parse(JSON.stringify(a.toJSON())),s.resolve(a)}).fail(s.reject),s)},this.getAll=function(){var e=$.Deferred();return t.internal.loadAll.apply(t.internal,$.makeArray(arguments)).done(function(){o.getList.apply(o,$.makeArray(arguments)).done(e.resolve).fail(e.reject)}).fail(e.reject),e},this.getList=function(){function e(){var e=_(s).map(function(e){return i[e.uid]});a.resolve(e)}var a=$.Deferred(),s=t.internal.componentizeList.apply(t.internal,$.makeArray(arguments)),r=[];return _(s).each(function(e){i[e.uid]||r.push(e.id)}),_.isEmpty(r)?(e(),a):(t.internal.loadBulk(r).done(function(a){_(a).each(function(e){e._realm=o;var a=t.create(e);i[a.id]=a,n[a.id]=JSON.parse(JSON.stringify(a.toJSON()))}),e()}).fail(a.reject),a)},this.refresh=function(e,t){if(i[e]){var o=i[e];_(o.attributes).each(function(e,t){/^_/.test(t)||o.unset(t,{silent:!0})}),o.set(t),n[e]=JSON.parse(JSON.stringify(o.toJSON()))}},this.markDestroyed=function(e){if(i[e]){var t=i[e];delete i[e],t.trigger("destroy",t)}},this.destroy=function(){_(i).each(function(e){e.off()}),i={}},this.retain=function(){return a++,this},this.release=function(){--a<=0&&(a=0,this.destroy())},t.point("realm").invoke("extend",this)}var n=e.extend({idAttribute:"_uid",initialize:function(){e.prototype.initialize.apply(this,$.makeArray(arguments)),this.realm=this.get("_realm")||this.factory.realm("default"),delete this.attributes._realm,this.syncer=this.factory.internal;var t=this;this.on("sync",function(){t.touchedAttributes={}})},point:function(e){return this.factory.point(e)},touch:function(){var e=this;this.touchedAttributes=this.touchedAttributes||{},_(arguments).each(function(t){e.touchedAttributes[t]=!0})},changedSinceLoading:function(){var e=this,t=this.realm.internal.cachedServerAttributes(this.id)||{},i=this.attributes,n={},o={};return _(t).chain().keys().each(function(e){n[e]=1}),_(i).chain().keys().each(function(e){n[e]=1}),_(n).chain().keys().each(function(n){var a=t[n],s=i[n],r=!1;e.touchedAttributes&&e.touchedAttributes[n]?o[n]=s:a!==s&&(_.isArray(a)&&_.isArray(s)?0===_(a).difference(s).length&&0===_(s).difference(a).length||(a.length!==s.length?r=!0:_.each(s,function(e,t){_.each(s[t],function(e,i){void 0===a[t]?r=!0:e!==a[t][i]&&(r=!0)})}),!0===r&&(o[n]=s)):o[n]=s)}),o},isDirty:function(){return!_.isEmpty(this.changedSinceLoading())},getCompositeId:function(){return(this.get("folder")||this.get("folder_id"))+"."+(this.get("id")||"new-object")}});return function(e){function o(e){var t=a.internal.toUniqueIdFromObject(e);return e._uid=t,e}this.internal={};var a=this,s={};this.realm=function(e){return e?s[e]||(s[e]=new i(e,this)):this.realm("default")},this.model=n.extend(_.extend({factory:this},e.model||{})),this.collection=Backbone.Collection.extend({model:this.model,sync:function(){return a.point("collection/sync").invoke("sync",this,$.makeArray(arguments))}}),this.api=e.api,this.ref=e.ref,this.internal.load=e.load||function(){var e=$.makeArray(arguments);return a.api.get.apply(a.api,e).then(o)},this.internal.loadAll=e.loadAll||function(){return a.api.getAll.apply(a.api,$.makeArray(arguments))},this.internal.loadBulk=e.loadBulk||function(e){return a.api.getList(e).then(function(e){return _(e).each(o),e})},this.internal.create=e.create||function(e){return a.api.create(e.toJSON())},this.internal.read=e.read||function(e){return a.api.get({id:e.get("id"),folder:e.get("folder")||e.get("folder_id")}).done(function(t){e.realm.refresh(a.internal.toUniqueIdFromObject(t),t)})},this.internal.update=e.update||function(t){var i=null;return e.getUpdatedAttributes?i=e.getUpdatedAttributes(t):((i=t.changedSinceLoading()).id=t.id,i.last_modified=t.get("last_modified"),i.folder||(i.folder=t.get("folder")||t.get("folder_id"))),a.api.update(i)},this.internal.destroy=e.destroy||function(e){return a.api.remove({id:e.id,folder:e.get("folder_id")||e.get("folder")})},this.internal.toUniqueId=e.toUniqueId||function(e){return e.id},this.internal.toUniqueIdFromGet=e.toUniqueIdFromGet||this.internal.toUniqueId,this.internal.toUniqueIdFromObject=e.toUniqueIdFromObject||this.internal.toUniqueId,this.internal.eventToGetArguments=e.eventToGetArguments||function(e,t){return[{id:t.id,folder:t.folder||t.folder_id}]},this.internal.componentizeList=e.componentizeList||function(e){return _(e).map(function(e){return{uid:a.internal.toUniqueIdFromObject(e),id:e}})},/\/$/.test(this.ref)||(this.ref=this.ref+"/"),this.point=this.point||function(e){return/^\//.test(e)&&(e=e.substring(1)),t.point(this.ref+e)},this.get=this.get||function(){var e=this.realm("default");return e.get.apply(e,$.makeArray(arguments))},this.getAll=this.getAll||function(){var e=this.realm("default");return e.getAll.apply(e,$.makeArray(arguments))},this.getList=this.getList||function(){var e=this.realm("default");return e.getList.apply(e,$.makeArray(arguments))},this.create=this.create||function(e){return(e=e||{}).id?this.realm("default").create(e):new this.model(e)},this.createCollection=this.createCollection||function(e){return new this.collection(e)},this.internal.updateEvents=e.updateEvents||["update"],this.internal.destroyEvents=e.destroyEvents||["delete"],_(this.internal.updateEvents).each(function(e){a.api.on(e,function(){var e=a.internal.eventToGetArguments.apply(a,$.makeArray(arguments)),t=a.internal.toUniqueIdFromGet.apply(a,e);a.api.get.apply(a.api,e).done(function(e){_(s).each(function(i){i.refresh(t,e)})})})}),_(this.internal.destroyEvents).each(function(e){a.api.on(e,function(){var e=a.internal.eventToGetArguments.apply(a,$.makeArray(arguments)),t=a.internal.toUniqueIdFromGet.apply(a,e);_(s).each(function(e){e.markDestroyed(t)})})}),this.point("validation").extend({id:"generic",validate:function(e,t){_(e).each(function(i,n){var o=a.point("validation/"+n).invoke("validate",t,i,t,e,n).value();_(o).each(function(e){e&&(_.isArray(e)?_(e).each(function(e){t.add(n,e)}):t.add(n,e))})})}}),this.wrap=function(e){return arguments.length>1?this.createCollection(_(arguments).map(function(e){return a.wrap(e)})):e.attributes&&e.factory===this?e:this.create(e)},_($.makeArray(arguments).splice(1)).each(function(e){_.extend(a,e)})}}),define("io.ox/backbone/validation",["io.ox/core/extensions","io.ox/core/util","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,n){var o=function(e){return _.isUndefined(e)||null===e||""===e},a={string:function(){return!0},text:function(){return!0},anyFloat:function(e){return!!o(e)||(e=String(e).replace(/,/g,".").replace(/\.0*$/,""),!isNaN(parseFloat(e,10))&&parseFloat(e,10).toString().length===e.toString().length||n("Please enter a valid number"))},number:function(e){return o(e)||!isNaN(parseFloat(e,10))&&parseFloat(e,10).toString().length===e.toString().length||n("Please enter a valid number")},array:function(e){return _.isArray(e)||"Please enter a valid array"},boolean:function(e){return _.isBoolean(e)||"Please enter a bool"},date:function(e){return!(null!==e&&!_.isNumber(e)||e>0xe677ccf98008)||n("Please enter a valid date")},pastDate:function(e){return _.isString(e)&&""!==e?n("Please enter a valid date"):_.now()>e||n("Please enter a date in the past")},email:function(e){return!1===i.get("features/validateMailAddresses",!0)||t.isValidMailAddress(e)||n("Please enter a valid email address")},phone:function(e){return!1===i.get("features/validatePhoneNumbers",!1)||t.isValidPhoneNumber(e)||n("Please enter a valid phone number. Allowed characters are: %1$s","0-9 , . - ( ) # + ; /")},url:function(){return!0},object:function(e){return _.isObject(e)||n("Please enter a valid object")}};return e.point("io.ox/backbone/validation/formats").invoke("customize",a,a),e.point("io.ox/backbone/validation/formats").on("extended",function(e){e.invoke("customize",a,a)}),{validationFor:function(t,i){var s=t+(/\/$/.test(t)?"validation":"/validation");_(i).each(function(t,i){e.point(s+"/"+i).extend({id:t.id||i,validate:function(e,n,o){var s=[];if(t.format&&a[t.format]){var r=a[t.format].call(n,e);!0!==r&&s.push(r)}if(t.fn){var l=t.fn.apply(n,e,n,o,i);l&&(_.isArray(l)?_(l).each(function(e){s.push(e)}):s.push(l))}return s}}),t.mandatory&&e.point(s+"/save").extend({id:i+"-is-mandatory",validate:function(e,t){var a=e[i];o(a)&&t.add(i,n("Please enter a value"))}})})},formats:a}}),define("io.ox/backbone/basicModel",["io.ox/core/extensions","gettext!io.ox/core"],function(e,t){function i(){this.errors={},this.add=function(e,t){return(this.errors[e]||(this.errors[e]=[])).push(t),this},this.hasErrors=function(){return!_.isEmpty(this.errors)},this.errorsFor=function(e){return this.errors[e]},this.each=function(){var e=_(this.errors);return e.each.apply(e,$.makeArray(arguments))}}return Backbone.Model.extend({initialize:function(e){var t=this;this._valid=!0,this.attributeValidity={},this.id=e.id,this.on("change:id",function(){t.id=t.get("id")}),this.init&&this.init(),this.url=this.url||"invalidURL"},point:function(t){return/^\//.test(t)&&(t=t.substring(1)),e.point(this.ref+t)},validate:function(e,t,n){n=n||{};var o=this,a=o.errors=new i;if(e=e||this.toJSON(),this.point("validation").invoke("validate",a,e,a,this),n.isSave&&this.point("validation/save").invoke("validate",a,e,a,this),a.hasErrors()){var s={};_(e).chain().keys().each(function(e){s[e]=!0}),a.each(function(e,t){s[t]=!1,o.trigger("invalid:"+t,e,a,o)}),_(o.attributeValidity).each(function(e,t){!e&&s[t]&&o.trigger("valid:"+t,o)}),o.attributeValidity=s,o.trigger("invalid",a,o),o._valid=!1}else o._valid||(_(o.attributeValidity).each(function(e,t){e||o.trigger("valid:"+t,o)}),_(e).chain().keys().each(function(e){o.attributeValidity[e]=!0}),o._valid=!0,this.trigger("valid"))},parse:function(){return{}},sync:function(e,i,n){var o=this;if("delete"===e&&(e="destroy"),("update"===e||"create"===e)&&!this.isValid({isSave:!0})){var a=t("The dialog contains invalid data"),s=this.errors.errors;return 1===_(s).size()&&_.isString(s[_(s).keys()[0]][0])&&(a=s[_(s).keys()[0]]),$.Deferred().reject({error:a,model:this})}if(this.syncer)return this.trigger(e+":start"),this.trigger("sync:start"),this.syncer[e](i).done(function(t){n.success(i,t),o.trigger(e,t),o.trigger("sync",t)}).fail(function(a,s){!s||404!==s.status&&0!==s.status||(a.error=t("Server unreachable")),n.error(i,a),o.trigger("backendError",a,s),o.trigger(e+":fail",a),o.trigger("sync:fail",a)}).always(function(){o.trigger(e+":always"),o.trigger("sync:always")});throw new Error("No Syncer specified!")},isSet:function(){var e=this;return _(arguments).all(function(t){return e.has(t)&&""!==e.get(t)})},isAnySet:function(){var e=this;return _(arguments).any(function(t){return e.has(t)&&""!==e.get(t)})},isValid:function(e){return this.validate(this.toJSON(),null,e),this._valid},hasValidAttributes:function(){var e=this;return _(arguments).all(function(t){return e.attributeValidity[t]})},invalidAttributes:function(){var e=this;return _(this.attributeValidity).chain().keys().filter(function(t){return!e.attributeValidity[t]}).values()._wrapped}})}),define("io.ox/settings/util",["io.ox/core/notifications","gettext!io.ox/core"],function(e,t){return{destroy:function(){e.yell("destroy")},yellOnReject:function(i,n){return i&&i.promise&&i.done?($.extend({debug:!1},n||{}).debug&&i.always(function(){var e=_.isArray(this)?this:[this];_.each(e,function(e){e.state?console.warn("NOTIFIY: "+e.state()):i.state&&console.warn("NOTIFIY: "+i.state())})}),i.fail(function(i){var n=$.extend({type:"error",error:"unknown",error_params:[]},i||{});"MAIL_FILTER-0015"===n.code?n.message=t("Unable to load mail filter settings."):n.error&&(n.message=n.error),e.yell(n)})):$.when()}}}),define("io.ox/core/api/snippets",["io.ox/core/http","io.ox/core/event","settings!io.ox/mail"],function(e,t,i){function n(e){return _.isString(e.misc)&&(e.misc=JSON.parse(e.misc)),e.misc=$.extend({insertion:i.get("defaultSignaturePosition","below")},e.misc||{}),e}var o={},a=null,s=new Backbone.Collection;return t.extend(o),o.getCollection=function(){return s},o.getAll=function(){return a?$.Deferred().resolve(a):e.GET({module:"snippet",params:{action:"all"},timeout:15e3}).then(function(e){return a=_(e).map(n),s.reset(a),a},function(){return a=null,[]})},o.create=function(t){return e.PUT({module:"snippet",params:{action:"new"},data:t}).done(function(e){a=null,s.add(_({},t,{id:e})),o.trigger("refresh.all")})},o.update=function(t){return e.PUT({module:"snippet",params:{action:"update",id:t.id},data:t}).done(function(){a=null,s.add(t,{merge:!0}),o.trigger("refresh.all")})},o.get=function(t){return e.GET({module:"snippet",params:{action:"get",id:t}})},o.list=function(t){return e.PUT({module:"snippet",params:{action:"list"},data:t})},o.destroy=function(t){return e.GET({module:"snippet",params:{action:"delete",id:t}}).done(function(){a=null,s.remove(t),o.trigger("refresh.all")})},o}),define("io.ox/core/tk/contenteditable-editor",["io.ox/core/capabilities","io.ox/core/extensions","io.ox/core/tk/textproc","io.ox/mail/api","io.ox/mail/util","static/3rd.party/purify.min.js","settings!io.ox/core","settings!io.ox/mail","gettext!io.ox/core","less!io.ox/core/tk/contenteditable-editor-content","less!io.ox/core/tk/contenteditable-editor"],function(e,t,i,n,o,a,s,r,l,d){function c(e){var t=e.contentWindow.getSelection().getRangeAt(0);t.collapsed||(e.execCommand("Delete",!1,null),t=e.contentWindow.getSelection().getRangeAt(0));var i,n=t.commonAncestorContainer,a=null;for(i=function(e){var t;if(e)if(e.hasChildNodes())for(t=0;t<e.childNodes.length;t++){if(1===e.childNodes[t].nodeType)return void i(e.childNodes[t]);3===e.childNodes[t].nodeType&&(e.childNodes[t].nodeValue=e.childNodes[t].nodeValue.replace("​",""))}else"BR"===e.nodeName&&(a=e)};n&&!/mce-content-body/.test(n.className);){t.setEndAfter(n);var s=n.parentNode,r=t.extractContents();i(r.firstChild),$(r).text().length>0&&s.insertBefore(r,n.nextSibling);try{var l,d=$(s).children("ol + ol");d.length>0&&(l=d.prev().children("li").length+1,d.attr("start",l))}catch(e){ox.debug&&console.error(e)}n=s}if(a)try{a.parentNode.removeChild(a)}catch(e){ox.debug&&console.error(e)}var c=o.getDefaultStyle().node.get(0);t.insertNode(c),t.setStart(c,0),t.setEnd(c,0),e.contentWindow.getSelection().empty(),e.contentWindow.getSelection().addRange(t)}function u(e){var t=e.commonAncestorContainer||e.parentElement();return $(t).parents("blockquote").last().length>0}function h(e,t){var i=e.contentWindow.getSelection().getRangeAt(0);u(i)&&i.startContainer&&(c(e),e.dom.events.cancel(t),e.focus())}function p(e){var t=$(e.container).closest(".scrollable"),i=e.contentWindow.getSelection(),n=i.getRangeAt(0),o=_.device("safari")?n.getClientRects()[0]:n.getBoundingClientRect(),a=o?o.top:0,s=t.find(".mail-compose-fields").height(),r=t.parents(".window-container-center").find(".window-footer").outerHeight(),l=t.find(".contenteditable-editor").css("margin-bottom")||"0px",d=parseInt(l.replace("px",""),10)||0,c=t.height()-r-2*d;if(0===a)if(i.modify)i.modify("extend","backward","character"),o=(n=i.getRangeAt(0)).getBoundingClientRect(),n.collapse(),a=o.top+o.height,i.collapseToEnd();else{var u=n.commonAncestorContainer;a=$(u).offset().top+u.clientHeight}return{pos:a-t.scrollTop()+s,top:a,bottom:c,scrollable:t}}function m(){var e=ox.language,t=["ar","ar_SA","az","be","bg_BG","bn_BD","bs","ca","cs","cy","da","de","de_AT","dv","el","en_CA","en_GB","es","et","eu","fa","fi","fo","fr_FR","gd","gl","he_IL","hr","hu_HU","hy","id","is_IS","it","ja","ka_GE","kk","km_KH","ko_KR","lb","lt","lv","ml","ml_IN","mn_MN","nb_NO","nl","pl","pt_BR","pt_PT","ro","ru","si_LK","sk","sl_SI","sr","sv_SE","ta","ta_IN","tg","th_TH","tr_TR","tt","ug","uk","uk_UA","vi","vi_VN","zh_CN","zh_TW"],i=_.indexOf(t,e,!0);return"fr_CA"===e?"fr_FR":i>-1?t[i]:(i=_.indexOf(t,e.substr(0,2),!0))>-1?t[i]:"en"}l("Drop inline images here"),l("Please only drop images here. If you want to send other files, you can send them as attachments.");var f="io.ox/core/tk/contenteditable-editor",g=0;t.point(f+"/setup").extend({id:"default",index:g+=100,draw:function(e){e.on("keydown",function(t){t.shiftKey||13!==t.which||h(e,t),(13===t.which&&!t.shiftKey||40===t.which)&&setTimeout(y,0,e),38!==t.which&&8!==t.which||setTimeout(x,0,e)})}}),t.point(f+"/setup").extend({id:"list-style-position",index:g+=100,draw:function(e){e.on("NodeChange",function(e){"LI"===e.element.nodeName&&"left"!==e.element.style.textAlign&&""!==e.element.style.textAlign&&$(e.element).css("list-style-position","inside")})}}),t.point(f+"/setup").extend({id:"sanitize",index:g+=100,draw:function(e){e.on("PastePreProcess",function(e){e.content&&(e.content=a.sanitize(e.content)+"")})}}),t.point(f+"/setup").extend({id:"retrigger-change",index:g+=100,draw:function(e){e.on("keyup input SetContent Change",_.throttle(this.trigger.bind(this,"change"),50))}}),t.point(f+"/setup").extend({id:"ios-focus",index:g+=100,draw:function(e){_.device("!tablet && ios >= 13")||e.on("touchstart",function(){$(document.activeElement).is("iframe")||$(document.activeElement).blur()})}});var v=300,b="swing",x=_.throttle(function(e){var t=p(e);t.top>0&&t.pos<0&&t.scrollable.animate({scrollTop:t.top},v,b),t.top<16&&t.scrollable.animate({scrollTop:0},v,b)},v),y=_.throttle(function(e){var t=p(e);t.pos>=t.bottom&&t.scrollable.animate({scrollTop:t.top},v,b)},v);return function(a,c){function u(e){return String(e||"").replace(/[\s\xA0]+$/g,"")}function h(e){var t=Math.round(.9*s.get("maxUploadIdleTimeout",2e5));I.push(setInterval(c.keepalive||n.keepalive,t,e))}function p(){_(I).each(clearInterval)}var g,v,b,x=$.Deferred(),w=this,k=a.data("editorId"),C=o.getDefaultStyle();_.extend(this,Backbone.Events),a.append(g=$('<div class="contenteditable-editor">').attr("data-editor-id",k).on("keydown",function(e){27===e.which&&e.preventDefault()}).append(b=$('<div class="editable" tabindex="0" role="textbox" aria-multiline="true">').attr("aria-label",l("Rich Text Area. Press ALT-F10 for toolbar")).toggleClass("simple-linebreaks",r.get("compose/simpleLineBreaks",!1)))),c=_.extend({toolbar1:"*undo *redo | bold italic underline | bullist numlist outdent indent",advanced:"*styleselect | *fontselect fontsizeselect | link image *emoji | forecolor backcolor",toolbar2:"",toolbar3:"",plugins:"autoresize autolink oximage oxpaste oxdrop link paste textcolor emoji lists code",theme:"modern",height:null,imageLoader:null},c),b.addClass(c.class),c.toolbar1+=" | "+c.advanced,c.toolbar1=s.get("tinyMCE/theme_advanced_buttons1",c.toolbar1),c.toolbar2=s.get("tinyMCE/theme_advanced_buttons2",c.toolbar2),c.toolbar3=s.get("tinyMCE/theme_advanced_buttons3",c.toolbar3),e.has("emoji")||(c.toolbar1=c.toolbar1.replace(/( \| )?\*?emoji( \| )?/g," | "),c.toolbar2=c.toolbar2.replace(/( \| )?\*?emoji( \| )?/g," | "),c.toolbar3=c.toolbar3.replace(/( \| )?\*?emoji( \| )?/g," | "),c.plugins=c.plugins.replace(/emoji/g,"").trim());var S=c.toolbar1.replace(/\s*\|\s*/g," ");c.toolbar1=c.toolbar1.replace(/\*/g,"");var A='.contenteditable-editor[data-editor-id="'+k+'"] > .mce-tinymce > .mce-stack-layout > .mce-top-part',T={script_url:(window.cordova?ox.localFileRoot:ox.base)+"/apps/3rd.party/tinymce/tinymce.min.js",extended_valid_elements:"blockquote[type]",invalid_elements:"object,iframe,script,embed",height:c.height,autoresize_bottom_margin:0,menubar:!1,statusbar:!1,skin:c.skin,body_class:"ox-mce",content_style:d,toolbar1:c.toolbar1,toolbar2:c.toolbar2,toolbar3:c.toolbar3,relative_urls:!1,remove_script_host:!1,entity_encoding:"raw",font_formats:o.getFontFormats(),fontsize_formats:"8pt 10pt 11pt 12pt 13pt 14pt 16pt 18pt 24pt 36pt",forced_root_block:"div",forced_root_block_attrs:{style:C.string,class:"default-style"},browser_spellcheck:!0,plugins:c.plugins,link_title:!1,target_list:!1,link_assume_external_targets:!0,language:m(),hidden_input:!1,theme:c.theme,mobile:{theme:"modern",toolbar:!1},init_instance_callback:function(e){v=e,x.resolve()},execcommand_callback:function(e,t,i){"createlink"===i&&_.defer(function(){$(tinyMCE.get(e).getBody()).find("a").attr({target:"_blank",rel:"noopener"})})},paste_preprocess:i.paste_preprocess,paste_postprocess:i.paste_postprocess,setup:function(e){c.oxContext&&(e.oxContext=c.oxContext),t.point(f+"/setup").invoke("draw",w,e),e.on("init",function(){this.oxContext&&this.oxContext.signature&&$(this.contentDocument.getElementsByTagName("html")[0]).addClass("signature-editor"),$(A).find("span.mce-txt").attr("tabindex",-1);var t=$(A).find(".mce-widget");S.split(" ").forEach(function(e,i){t.eq(i).attr("data-name",e),/^\*/.test(e)&&t.eq(i).attr("data-hidden","xs")}),$(A).find(".mce-btn-group").each(function(){$(this).toggleClass("mce-btn-group-visible-xs",$(this).has(".mce-widget:not([data-hidden])").length>0)}),e.on("SetContent",function(t){t.paste&&setTimeout(y,0,e)})})},oxImageLoader:c.imageLoader};t.point(f+"/options").invoke("config",T,c.oxContext),require(["3rd.party/tinymce/jquery.tinymce.min"]).then(function(){b.tinymce(T)});var D=function(e){return e.replace(/<[a-z][^>]*\sdata-mce.*?>/gi,function(e){return e.replace(/\sdata-mce-\S+=("[^"]*"|'[^']*')/g,"")})},M=_.debounce(function(){if(null!==a){var e=a.find(".mce-btn").filter('[data-hidden="xs"]');e.filter(":hidden").attr({role:"presentation","aria-hidden":!0}),e.filter(":visible").removeAttr("aria-hidden").attr("role","button");var t=0,i=0,n=a.find("iframe"),o=n.contents().height(),s=a.closest(".window-container"),r=s.find(".window-header:visible").outerHeight()||0,l=s.find(".window-footer:visible").outerHeight()||0,d=0;_.device("smartphone")?(t=$(window).height(),i=a.offset().top):(t=a.closest(".window-content").height(),i=a.parent().find(".mail-compose-fields").outerHeight(),d=8);var u=t-i-r-l-d;_.device("smartphone")&&o>u&&(u=o),b.css("min-height",u+"px"),n.css("min-height",u+"px"),c.css&&b.css(c.css)}},30),E=function(e){v.setContent(e),/position:(\s+)?absolute/i.test(e)&&$(v.getBody()).find("[style*=absolute]").css("position","static"),/white-space:(\s+)?nowrap/i.test(e)&&$(v.getBody()).find("[style*=nowrap]").css("white-space","normal")},N=function(e){return String(e||"").replace(/\r/g,"").replace(new RegExp("\\n","g"),e.indexOf("io-ox-signature")>-1?"\n":"<br>")};this.content_type=c.config&&"alternative"===c.config.get("preferredEditorMode")?"ALTERNATIVE":"text/html",this.done=function(e){return $.when(x).then(function(){return e(this),this}.bind(this))},this.focus=function(){_.device("ios")||_.defer(function(){v&&(v.focus(),v.execCommand("mceFocus",!1,k))})},this.ln2br=N,this.clear=function(){E("")},this.getContent=function(e){e=e||{},$(v.getBody()).find(".mce-resizehandle").remove();var t=v.getContent({format:e.format||"raw"});return t=D(t),t=t.replace(/<(\w+)[ ]?\/>/g,"<$1>").replace(/(<div>(<br>)?<\/div>)+$/,""),t=t.replace(/(\s|&nbsp;|\0x20|<br\/?>|<div( class="io-ox-signature")>(&nbsp;|\s|<br\/?>)*<\/div>)*$/g,""),u(t)},this.getPlainText=function(){return i.htmltotext($(v.getBody()).html())},this.setContent=E,this.setPlainText=function(e){e=u(e),_.isUndefined(e)||require(["io.ox/mail/detail/content"],function(t){E(t.text2html(e)),v.undoManager.clear()})},this.paste=function(e){v.execCommand("mceInsertClipboardContent",!1,{content:e})},this.scrollTop=function(e){var t=$(v.getDoc());if(void 0===e)return t.scrollTop();"top"===e?t.scrollTop(0):"bottom"===e&&t.scrollTop(t.get(0).body.scrollHeight)},this.setCaretPosition=function(){$(v.getDoc()).scrollTop(0)},this.appendContent=function(e){var t=this.getContent();e=/^<div/i.test(e)?e:"<div>"+N(e)+"</div>",t=t.replace(/^(<div><br><\/div>){2,}/,"").replace(/(<div><br><\/div>)+$/,"")+"<div><br></div>"+e,/^<blockquote/.test(t)&&(t="<div><br></div>"+t),this.setContent(t)},this.prependContent=function(e){var t=this.getContent();t="<div><br></div>"+(t=(e=/^<div/i.test(e)?e:"<div>"+N(e)+"</div>")+"<div><br></div>"+t.replace(/^(<div><br><\/div>)+/,"").replace(/(<div><br><\/div>){2,}$/,"")),this.setContent(t)},this.setContentParts=function(e,t){var i="";(e=_.isString(e)?{content:e}:e).content=e.content.replace(/^(<div><br><\/div>)+/,"").replace(/(<div><br><\/div>){2,}$/,""),e.content?i+=e.content:i+='<div class="default-style" style="'+C.string+'"><br></div>',"above"===t&&e.cite&&(i+=e.cite),e.quote&&(e.quote=e.quote.replace(/<div><br>(&nbsp;|&#160;)<\/div>/,""),i+=e.quote||""),"below"===t&&e.cite&&(!/<div><br><\/div>$/i.test(i)&&/<\/blockquote>$/.test(i)&&(i+='<div class="default-style" style="'+C.string+'"><br></div>'),i+=e.cite),this.setContent(i)},this.getContentParts=function(){var e=this.getContent(),t="forward"===c.view.model.get("mode")&&r.get("forwardunquoted",!1),i=e.indexOf(t?"----":'<blockquote type="cite">');return'<blockquote type="cite"><div>'===e.substring(0,15)&&(i=0),'<div><br></div><blockquote type="cite">'===e.substring(0,23)&&(i=0),i<0?{content:e}:{content:e.substring(0,i).replace(/\s+$/g,""),quote:e.substring(i),cite:void 0}},this.insertPrevCite=function(e){var t=this.getContentParts();e=/^<div/i.test(e)?e:"<div>"+N(e)+"</div>",t.cite=e,this.setContentParts(t,"above")},this.insertPostCite=function(e){var t=this.getContentParts();e=/^<div/i.test(e)?e:"<div>"+N(e)+"</div>",t.cite=e,this.setContentParts(t,"below")},this.replaceParagraph=function(e,t){var i,n,o=this.getContent();return e=/^<div/i.test(e)?e:"<div>"+N(e)+"</div>",(i=o.indexOf(e))>-1&&(n=this.scrollTop(),this.setContent(o.substr(0,i)+(t||"")+o.substr(i+e.length)),this.scrollTop(n),!0)},this.removeContent=function(e){this.replaceContent(e,"")},this.find=function(e){return $(v.getBody()).find(e)},this.children=function(e){return $(v.getBody()).children(e)},this.replaceContent=function(e,t){function i(){v.selection.setContent(t||"")}var n,o=v.getWin(),a=!1;if(v.selection.select(v.getBody(),!0),v.selection.collapse(!0),_.browser.IE)for(v.focus(),n=v.getDoc().selection.createRange();n.findText(e,1,0);)n.scrollIntoView(),n.select(),i(),a=!0;else for(;o.find(e,0,0,!1,!1,!1,!1);)i(),a=!0;return a},this.getMode=function(){return"html"},this.tinymce=function(){return b.tinymce?b.tinymce():{}},this.show=function(){g.show(),$(A).css("display",""),window.toolbar=$(A),$(window).on("resize.tinymce xorientationchange.tinymce changefloatingstyle.tinymce",M),$(window).trigger("resize")},this.hide=function(){g.hide(),$(window).off("resize.tinymce xorientationchange.tinymce changefloatingstyle.tinymce",M)},function(){if(!_.device("smartphone")){var e=c.scrollpane||c.app&&c.app.getWindowNode(),t=e.find(".mail-compose-fields"),i=!1;c.app&&c.app.get("floating")&&c.app.get("window").floating&&c.app.get("window").floating.on("move",function(){i&&$(A).css("top",c.view.$el.parent().offset().top)}),e.on("scroll",function(){var n=e.scrollTop()||0;i=n>t.height()+14,$(A).css("top",i?c.view.$el.parent().offset().top:0),t.css("margin-bottom",i?40:0),g.toggleClass("toolbar-fixed",i)})}}(),this.destroy=function(){this.hide(),p(),delete tinyMCE.EditorManager.activeEditor,tinyMCE.EditorManager.remove(v),v=void 0};var I=[];b.on("addInlineImage",function(e,t){h(t)})}}),define("io.ox/core/tk/textproc",["settings!io.ox/mail","static/3rd.party/purify.min.js"],function(e,t){function i(e,t){var i,n=$(t),o=t.tagName,a=n.children(),s=!0;if("DIV"===o&&n.attr("id")&&-1!==n.attr("id").indexOf("ox-text-p")&&(s=!1),n.removeAttr("id title alt rel"),/^(BR|HR|IMG)$/.test(o))return e;if(n.attr("align")&&n.css("textAlign",n.attr("align")).removeAttr("align"),n.contents().each(function(){3===t.nodeType&&(t.nodeValue=t.nodeValue.replace(/:$/,": "))}),0===a.length)if(""===(i=n.text().match(/^[ \u00A0\t]$/)?n.text:$.trim(n.text()))){if("TD"!==o)return n.remove(),!1;n.text(" ")}else{if(/^(SPAN|SMALL|PRE)$/.test(o)&&!n.attr("class")&&!n.attr("style"))return n.replaceWith($.txt(n.text())),!1;/^".+"$/.test(i)&&n.text(i.replace(/^"/,"“").replace(/"$/,"”"))}else if("DIV"===o&&!n.attr("class")&&!n.attr("style")&&s)return a.eq(0).unwrap(),!1;return e}function n(){$(this).children().first().unwrap()}function o(){var e=$(this);e.replaceWith($("<em>").text(e.text()))}function a(){var e,t=$(this);t.attr("href")?(t.removeAttr("title target"),/^\[\d+\]$/.test(t.text())&&/^#/.test(t.attr("href"))&&(e=String(t.text()).match(/^\[(\d+)\]$/),t.replaceWith($("<sup>").text(e[1]).add($.txt(" "))))):t.replaceWith(t.contents())}function s(){var e=$(this);e.removeAttr("width").attr({border:"0",cellSpacing:"0",cellPadding:"0"}).css({lineHeight:"1em",margin:"0.5em auto 0.5em auto"}),e.find("th").css({fontWeight:"bold",textAlign:"center",borderBottom:"1px solid #555",padding:"0.4em 1em 0.4em 1em"}),e.find("td").css({borderBottom:"1px solid #aaa",padding:"0.4em 1em 0.4em 1em"}),e.find("tr").first().find("td, th").css({borderTop:"1px solid #555"}),e.find("tr").last().find("td, th").css({borderBottom:"1px solid #555"})}function r(){var e=$(this),t=e.attr("style"),i=$("<div>");t&&i.attr("style",t),e.replaceWith(i.append(e.contents()),$("<div><br></div>"))}return{paste_preprocess:function(e,t){t.content=t.content.replace(/<!--(.*?)-->/g,"")},paste_postprocess:function(e,t){var l,d=$(t.node);d.find("iframe, object, applet, input, textarea, button, select, canvas, script, noscript, audio, video, img").filter(":not("+["img.emoji",'img[src*="'+ox.abs+ox.root+'/api/file"]','img[src*="'+ox.root+'/api/file"]','img[src*="'+ox.abs+ox.root+'/api/image"]','img[src*="'+ox.root+'/api/image"]','img[data-pending="true"]'].join(", ")+")").remove(),d.find("sup").css("lineHeight","0"),d.find("article, header, footer, section, form").each(n),d.find("a").each(a),d.find("code").each(o);do{l=_(d.find("*")).inject(i,!0)}while(!l);d.find("table").each(s),d.find("p").each(r)},htmltotext:function(e){function i(e,t){return l(_(e.childNodes).map(n.bind(null,t)).join(""))}function n(e,t,i,n){if(3===t.nodeType){if(e.preserveWhitespace)return t.nodeValue;var l=t.nodeValue;return(0===i||r(n[i-1]))&&(l=l.replace(/^\s+/g,"")),(i===n.length-1||r(n[i+1]))&&(l=l.replace(/\s+$/g,"")),l.replace(/[\n\t]/g," ").replace(/\s{2,}/g," ")}return o(t,i,n.length)||s(t,a(t,e))}function o(e,t,i){switch(e.nodeName){case"BR":var n=t===i-1,o=1===i;return 0===t&&o||n?"​":"";case"HR":return"\0------------------------------\0";case"INPUT":switch(e.getAttribute("type")){case"checkbox":case"radio":return"["+(e.hasAttribute("checked")?"X":" ")+"]";default:return"["+(e.getAttribute("value")||"")+"]"}}}function a(e,t){var n=i(e,{preserveWhitespace:t.preserveWhitespace||"PRE"===e.nodeName});switch(e.nodeName){case"DIV":return e.classList.contains("io-ox-signature")?"\0"+n+"\n":n;case"A":var o=e.getAttribute("href");return/^https?:\/\//i.test(o)?n&&n!==o?n+" ("+o+")":o:n;case"BLOCKQUOTE":return n.replace(/^/gm,"> ").replace(/\u0001/gm,"\n> ");case"UL":return n.replace(/^/gm,"  ");case"OL":var a=parseInt(e.getAttribute("start")||"1",10);return n.replace(/^\* /gm,function(){return"  "+a+++". "});case"LI":return"* "+n.replace(/\u0001/g,"\n  ");case"TD":return n+"\t";case"H1":case"H2":case"H3":return"\n"+n;default:return n}}function s(e,t){return r(e)?"\0"+t+"\0":t}function r(e){return/^(P|DIV|BLOCKQUOTE|UL|OL|LI|PRE|H\d|DL|ADDRESS|FIELDSET|FORM|NOSCRIPT|SECTION|TABLE|TR)$/.test(e.nodeName)}function l(e){return e.replace(/(^\0+|\0+$)/g,"").replace(/\0\0?/g,"\n")}return function(e){return e.replace(/\u200B/g,"").replace(/\u0001+/g,"\n")}(i(t.sanitize(e,{FORBID_TAGS:["STYLE","SCRIPT","TITLE"],ALLOWED_ATTR:["href","type","value","checked","start","class"],RETURN_DOM:!0}),{}))}}}),function(){var e,t,i,n,o,a=[];o="undefined"!=typeof global?global:window;var s=function(){return o.tinymce};(n=o.jQuery).fn.tinymce=function(e){var l,d,c,u=this,h="";if(!u.length)return u;if(!e)return s()?s().get(u[0].id):null;u.css("visibility","hidden");var p=function(){var t=[],o=0;i||(r(),i=!0),u.each(function(i,n){var a,r=n.id,l=e.oninit;r||(n.id=r=s().DOM.uniqueId()),s().get(r)||(a=s().createEditor(r,e),t.push(a),a.on("init",function(){var e,i=l;u.css("visibility",""),l&&++o==t.length&&("string"==typeof i&&(e=-1===i.indexOf(".")?null:s().resolve(i.replace(/\.\w+$/,"")),i=s().resolve(i)),i.apply(e||s(),t))}))}),n.each(t,function(e,t){t.render()})};if(o.tinymce||t||!(l=e.script_url))1===t?a.push(p):p();else{t=1,d=l.substring(0,l.lastIndexOf("/")),-1!=l.indexOf(".min")&&(h=".min"),o.tinymce=o.tinyMCEPreInit||{base:d,suffix:h},-1!=l.indexOf("gzip")&&(c=e.language||"en",l=l+(/\?/.test(l)?"&":"?")+"js=true&core=true&suffix="+escape(h)+"&themes="+escape(e.theme||"modern")+"&plugins="+escape(e.plugins||"")+"&languages="+(c||""),o.tinyMCE_GZ||(o.tinyMCE_GZ={start:function(){var t=function(e){s().ScriptLoader.markDone(s().baseURI.toAbsolute(e))};t("langs/"+c+".js"),t("themes/"+e.theme+"/theme"+h+".js"),t("themes/"+e.theme+"/langs/"+c+".js"),n.each(e.plugins.split(","),function(e,i){i&&(t("plugins/"+i+"/plugin"+h+".js"),t("plugins/"+i+"/langs/"+c+".js"))})},end:function(){}}));var m=document.createElement("script");m.type="text/javascript",m.onload=m.onreadystatechange=function(i){i=i||window.event,2===t||"load"!=i.type&&!/complete|loaded/.test(m.readyState)||(s().dom.Event.domLoaded=1,t=2,e.script_loaded&&e.script_loaded(),p(),n.each(a,function(e,t){t()}))},m.src=l,document.body.appendChild(m)}return u},n.extend(n.expr[":"],{tinymce:function(e){var t;return!!(e.id&&"tinymce"in o&&(t=s().get(e.id))&&t.editorManager===s())}});var r=function(){var t=function(e){"remove"===e&&this.each(function(e,t){var i=a(t);i&&i.remove()}),this.find("span.mceEditor,div.mceEditor").each(function(e,t){var i=s().get(t.id.replace(/_parent$/,""));i&&i.remove()})},i=function(e){var i,n=this;if(null!=e)t.call(n),n.each(function(t,i){var n;(n=s().get(i.id))&&n.setContent(e)});else if(0<n.length&&(i=s().get(n[0].id)))return i.getContent()},a=function(e){var t=null;return e&&e.id&&o.tinymce&&(t=s().get(e.id)),t},r=function(e){return!!(e&&e.length&&o.tinymce&&e.is(":tinymce"))},l={};n.each(["text","html","val"],function(t,o){var s=l[o]=n.fn[o],d="text"===o;n.fn[o]=function(t){var o=this;if(!r(o))return s.apply(o,arguments);if(t!==e)return i.call(o.filter(":tinymce"),t),s.apply(o.not(":tinymce"),arguments),o;var l="",c=arguments;return(d?o:o.eq(0)).each(function(e,t){var i=a(t);l+=i?d?i.getContent().replace(/<(?:"[^"]*"|'[^']*'|[^'">])*>/g,""):i.getContent({save:!0}):s.apply(n(t),c)}),l}}),n.each(["append","prepend"],function(t,i){var o=l[i]=n.fn[i],s="prepend"===i;n.fn[i]=function(t){var i=this;return r(i)?t!==e?("string"==typeof t&&i.filter(":tinymce").each(function(e,i){var n=a(i);n&&n.setContent(s?t+n.getContent():n.getContent()+t)}),o.apply(i.not(":tinymce"),arguments),i):void 0:o.apply(i,arguments)}}),n.each(["remove","replaceWith","replaceAll","empty"],function(e,i){var o=l[i]=n.fn[i];n.fn[i]=function(){return t.call(this,i),o.apply(this,arguments)}}),l.attr=n.fn.attr,n.fn.attr=function(t,o){var s=this,d=arguments;if(!t||"value"!==t||!r(s))return l.attr.apply(s,d);if(o!==e)return i.call(s.filter(":tinymce"),o),l.attr.apply(s.not(":tinymce"),d),s;var c=s[0],u=a(c);return u?u.getContent({save:!0}):l.attr.apply(n(c),d)}}}(),define.amd=e});