define("io.ox/emoji/main",["io.ox/emoji/categories","io.ox/emoji/conversions","settings!io.ox/mail"],function(e,t,n){"use strict";function i(){var e=n.get("emoji/availableCollections","");return _(e.split(",")).chain().map(function(e){return e.trim()}).compact().value()}function o(e){var t;return 6===e.length?o(e.substr(0,2))+o(e.substr(2)):10===e.length?o(e.substr(0,5))+o(e.substr(5)):(t="&#x"+e+";",$("<div>").html(t).text())}function r(e){return window.escape(e).replace(/%u/g,"\\u").toLowerCase()}function c(e){e=e||{},this.icons=[],this.collections=i(),this.category_map={},this.settings=n;var t=n.get("emoji/defaultCollection",this.collections[0]);this.currentCollection=e.collection||n.get("emoji/userCollection",t),this.createCategoryMap()}var a={};return _.extend(c.prototype,{iconInfo:function(e){var t=a.EMOJI_MAP[e];if(e&&t&&t[1]&&t[2])return{css:this.cssFor(e),unicode:e,desc:t[1],category:this.category_map[e]}},cssFor:function(e){var t=a.EMOJI_MAP[e];if(this.category_map[e]&&t)return"softbank"===this.currentCollection||"japan_carrier"===this.currentCollection?"emoji-"+this.currentCollection+" sprite-emoji-"+t[5][1].substring(2).toLowerCase():"emoji-"+this.currentCollection+" emoji"+t[2]},recent:function(e){var t=n.get("emoji/recently",{}),i=r(e);i in t?(t[i].count++,t[i].time=_.now()):t[i]={count:1,time:_.now()},n.set("emoji/recently",t).save()},getRecently:function(){return _(e[this.currentCollection].meta).find(function(e){return"recently"===e.name})||e.recently},resetRecents:function(){n.set("emoji/recently",{}).save()},iconsForCategory:function(e){if("recently"===e){var t=n.get("emoji/recently",{});return _(this.icons).chain().filter(function(e){return r(e.unicode)in t&&!!e.category}).map(function(e){var n=r(e.unicode);return[e,t[n]]}).sortBy(function(e){return 0-e[1].time}).first(40).sortBy(function(e){return e[1].count}).pluck(0).value().reverse()}return _(this.icons).filter(function(t){return t.category===e})},getCategories:function(){return(e[this.currentCollection].meta||[]).slice().filter(function(e){return"recently"!==e.name})},getDefaultCategory:function(){return(_(this.getCategories()).first()||{}).name},hasCategory:function(t){return _(e[this.currentCollection].meta).chain().pluck("name").indexOf(t).value()>-1},getTitle:function(t){return e.translations[t]},setCollection:function(e){_(this.collections).contains(e)&&(this.currentCollection=e,n.set("emoji/userCollection",e).save(),this.createCategoryMap())},getCollection:function(){return this.currentCollection},createCategoryMap:function(){var t=e[this.currentCollection];this.category_map=_.object(_(t).chain().values().flatten(!0).value(),_(t).chain().pairs().map(function(e){var t=e[0];return _(e[1]).map(function(){return t})}).flatten(!0).value()),this.icons=_(t).chain().values().flatten(!0).map(this.iconInfo,this).compact().value()}}),_.extend({getInstance:function(e){return new c(e)},unifiedToImageTag:function(e,t){var i,r=-1,c=this;if(!0!==(t=t||{}).forceEmojiIcons&&_.device("emoji"))return e;e=a.unifiedToHTML(e);for(;e.indexOf('<span class="emoji',r+1)>=0&&r<e.indexOf('<span class="emoji',r+1);){r=i=e.indexOf('<span class="emoji',r+1);var s=e.indexOf(">",i)+1,u=$("<div>").append(e.slice(i,s)),l=o(_.find(u.find("span").attr("class").split("emoji"),function(e){return e.trim()})),f=null,m=c.getInstance();if(l){n.get("emoji/overrideUserCollection",!1)||(f=m.cssFor(l)),f=f||m.collections.map(function(e){return function(t){return c.getInstance({collection:t}).cssFor(e)}}(l)).filter(_.isString)[0],"</span>"===e.substr(s,7)&&(s+=7);var d=new RegExp(e.slice(i,s)+"(?=[^<]*?>)","g");e=e.replace(d,l).replace(e.slice(i,s),function(e,t){return $("<div>").append($('<img src="apps/themes/login/1x1.gif" class="emoji '+e+'">').attr({"data-emoji-unicode":t,"data-mce-resize":"false",alt:t})).html()}(f,l))}}return e},imageTagsToUnified:function(e){var t=$("<div>").append(e);return t.find("img[data-emoji-unicode]").each(function(){$(this).replaceWith($(this).attr("data-emoji-unicode"))}),t.html()},imageTagsToPUA:function(e){for(var t,n=-1;e.indexOf("<img ",n+1)>=0&&n<e.indexOf("<img ",n+1);){n=t=e.indexOf("<img ",n+1);var i=$("<div>").append(e.slice(t,e.indexOf(">",t)+1)),o=i.find("img").attr("data-emoji-unicode");if(o){var r,c=a.EMOJI_MAP[o];c&&c[5]&&"-"!==c[5][0]&&(r=c[5][0]),o=r||o,e=e.replace(i.html(),o)}}return e},converterFor:function(e,t){var n=this;return t=t||"html",(e=_.extend({from:"unified",to:"unified"},e)).from===e.to?_.identity:"unified"===e.from&&"pua"===e.to?function(e,i){return n.imageTagsToPUA(n.unifiedToImageTag(e,{forceEmojiIcons:!0}),i||t)}:"all"===e.from&&"unified"===e.to?function(e){return e=e||"",e=n.softbankToUnified(e),e=n.jisToUnified(e)}:void 0},sendEncoding:function(){return n.get("emoji/sendEncoding","unified")}},t,a)});