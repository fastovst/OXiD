define("io.ox/preview/main",["io.ox/core/extensions","io.ox/core/capabilities","io.ox/files/mediasupport","gettext!io.ox/core"],function(e,i,t,n){"use strict";var r=!!_.browser.Chrome,a=$.noop,o=$.noop;r?(a=function(e){e.on("dragstart",function(e){e.originalEvent.dataTransfer.setData("DownloadURL",this.dataset.downloadurl)})},o=function(e,i){var t=$('<a draggable="true">').attr({"data-downloadurl":e.mimetype+":"+e.name+":"+ox.abs+e.downloadURL});return i?t.on("click",i):t.attr({href:e.dataURL+"&delivery=view",target:"_blank"}),t}):o=function(e,i){var t=$('<a target="_blank">',{href:e.dataURL+"&delivery=view"});return i&&t.on("click",i),t};var s={point:e.point("io.ox/preview/engine"),getByExtension:function(e,i){return this.point.chain().find(function(t){var n,r=t.metadata("supports",e,i);return r=_.isArray(r)?r:[r],(n=_(r).contains(e))&&_.isFunction(t.verify)?t.verify(i):n}).value()}},d=function(e){_.extend(this,e),e.omitDragoutAndClick||(this.draw=function(i){var t;if(e.omitClick)t=$("<div>");else{t=o(i);var s=n(r?"Open file. Drag to your desktop to download.":"Open file");t.attr({title:s,"aria-label":t.attr("aria-label")||s})}e.draw.apply(t,arguments),a(t,i),this.append(t)})};s.point.extend(new d({id:"image",index:10,supports:["image/png","png","image/jpeg","jpg","jpeg","image/gif","gif","bmp"],draw:function(e,i){var t,r=e.previewURL||e.dataURL;!1!==i.resize&&(t={width:i.width||400,height:i.height||400,scaleType:i.scaleType||"contain",delivery:"view"},"auto"===i.height&&delete t.height,"auto"===i.width&&delete t.width,r+="&"+$.param(t)),this.append($("<img>",{src:r,alt:n("Preview")}))}})),s.point.extend(new d({id:"eml",supports:["eml","message/rfc822"],verify:function(e){return!e.pim},draw:function(e){var i=this.busy();require(["io.ox/mail/detail/view"],function(t){var n=e.data.nested_message;if(n.parent=e.parent,!n.parent&&n.msgref){var r=n.msgref.split("/"),a=r.pop(),o=r.join("/");n.parent={id:a,folder:o,folder_id:o,needsfix:!0}}var s=new t.View({data:n,loaded:!0});i.idle().append(s.render().expand().$el.addClass("no-padding"))})},omitClick:!0})),s.point.extend(new d({id:"text",supports:["txt","plain/text","asc","js","md","json","csv"],draw:function(e){var i=this;require(["less!io.ox/preview/style"],function(){$.ajax({url:e.dataURL,dataType:"text"}).done(function(e){i.text(e)})})},omitClick:!0}));var p=function(e,i){var t=this;this.file=_.copy(e,!0),this.options=i||{},this.options.width&&_.isNumber(this.options.width)&&(this.options.width=Math.floor(this.options.width)),this.options.height&&_.isNumber(this.options.height)&&(this.options.height=Math.floor(this.options.height)),this.renderer=null,this.file.file_mimetype?this.file.mimetype=this.file.file_mimetype:this.file.mimetype||(this.file.mimetype="application/octet-stream"),this.file.filename&&(this.file.name=this.file.filename),this.extension=function(){var e=String(t.file.name||"").match(/\.([a-z0-9]{2,})$/i);return e&&e.length>0?String(e[1]).toLowerCase():""}(),this.renderer=this.extension&&s.getByExtension(this.extension,this.file)||this.file.mimetype&&s.getByExtension(this.file.mimetype,this.file)||void 0};return p.prototype={getRenderer:function(){return this.renderer},supportsPreview:function(){return!!this.renderer},appendTo:function(e){this.supportsPreview()&&this.renderer.invoke("draw",e,this.file,this.options)}},{Preview:p,Renderer:s,Engine:d,Extension:function(e){_.extend(this,e);var i=this;this.isEnabled||(this.isEnabled=function(t){return e.parseArguments&&(t=e.parseArguments.apply(i,arguments)),!!t&&new p(t,e).supportsPreview()}),this.draw||(this.draw=function(t){if(e.parseArguments&&(t=e.parseArguments.apply(i,arguments)),!t)return!1;new p(t,e).appendTo(this)})},protectedMethods:{clickableLink:o,dragOutHandler:a},getPreviewImage:function(e){var i=new p(e);return window.preview=i,i&&i.renderer&&i.renderer.getUrl?i.renderer.getUrl(e):""}}});