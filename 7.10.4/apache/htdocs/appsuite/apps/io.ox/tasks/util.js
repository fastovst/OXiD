define("io.ox/tasks/util",["gettext!io.ox/tasks","settings!io.ox/core","io.ox/core/capabilities"],function(t,e,a){"use strict";$(document).on("click",".ox-internal-mail-link",function(t){t.preventDefault();var e=decodeURIComponent($(this).attr("data-cid").replace(/:/g,"."));ox.launch("io.ox/mail/detail/main",{cid:e})});var r=[t("this morning"),t("by noon"),t("this afternoon"),t("tonight"),t("late in the evening")],n=[6,12,15,18,22],o={computePopupTime:function(t,e){e=e||!1;var a,r=moment().milliseconds(0).seconds(0);if(isNaN(parseInt(t,10))?(r.startOf("hour"),0===t.indexOf("d")?r.hours(n[parseInt(t.charAt(1),10)]):(r.hours(6),"t"===t?r.add(1,"day"):"ww"===t?r.add(1,"week"):0===t.indexOf("w")&&(r.day(parseInt(t.charAt(1),10)),r.valueOf()<_.now()&&r.add(1,"week")))):r.add(parseInt(t,10),"minutes"),a=moment(r),e){var o=a.day();a.day(o<1||o>5?8:12)}return r.valueOf()>a.valueOf()&&a.add(1,"week"),a.startOf("day"),{endDate:a.utc(!0).valueOf(),alarmDate:r.utc().valueOf()}},buildDropdownMenu:function(t){t=t||{};var e=this.buildOptionArray(t),a=[];return _(e).each(function(e){var r=e[1],n=e[0],o={"data-name":"change-due-date","data-value":r.toLowerCase()};a.push(t.bootstrapDropdown?$("<li>").append($('<a href="#" role="menuitem">').attr(o).val(n).text(r)):$("<option>").val(n).text(r))}),a},buildOptionArray:function(e){e=e||{};var a=[],n=moment(),o=n.hours();if(!e.daysOnly)for(a=[[5,t("in 5 minutes")],[15,t("in 15 minutes")],[30,t("in 30 minutes")],[60,t("in one hour")]],o<6?o=0:o<12?o=1:o<15?o=2:o<18?o=3:o<22&&(o=4);o<r.length;)a.push(["d"+o,r[o]]),o++;for(a.push(["t",t("tomorrow")]),o=(n.day()+2)%7;o!==n.day();o=++o%7)a.push(["w"+o,moment.weekdays(o)]);return a.push(["ww",t("in one week")]),a},isOverdue:function(t){return void 0!==t.end_time&&null!==t.end_time&&t.end_time<_.now()&&3!==t.status},getSmartEnddate:function(e){var a=e.full_time?moment.utc(e.end_time).local(!0):moment(e.end_time),r=moment().startOf("day");return a.isBefore(r)?a.isAfter(r.subtract(1,"day"))?t("Yesterday")+", "+a.format(e.full_time?"l":"l, LT"):a.format("ddd, "+a.format(e.full_time?"l":"l, LT")):a.isBefore(r.add(1,"days"))?t("Today")+", "+a.format(e.full_time?"l":"l, LT"):a.isBefore(r.add(1,"day"))?t("Tomorrow")+", "+a.format(e.full_time?"l":"l, LT"):a.format("ddd, "+a.format(e.full_time?"l":"l, LT"))},checkMailLinks:function(e){var r,n=e.match(/mail:\/\/\S*/g);if(n&&n[0]&&a.has("webmail")){for(var o=0;o<n.length;o++)r='<a href="#" role="button" data-cid="'+n[o].replace(/^mail:\/\//,"")+'" class="ox-internal-mail-link label label-primary">'+t("Original mail")+"</a>",e=e.replace(n[o],r);e=e.replace(/(<br>)+-+(<br>)*/,"<br>").replace(/^-+(<br>)*/,"")}return e},interpretTask:function(a,r){function n(t,a){return void 0===t||null===t?"":a?moment.utc(t).format("l"):moment.tz(t,e.get("timezone")).format("l, LT")}if(r=r||{},a=_.copy(a,!0),!r.noOverdue&&this.isOverdue(a))a.status=t("Overdue"),a.badge="badge badge-overdue";else if(a.status)switch(a.status){case 1:a.status=t("Not started"),a.badge="badge badge-notstarted";break;case 2:a.status=t("In progress"),a.badge="badge badge-inprogress";break;case 3:a.status=t("Done"),a.badge="badge badge-done";break;case 4:a.status=t("Waiting"),a.badge="badge badge-waiting";break;case 5:a.status=t("Deferred"),a.badge="badge badge-deferred"}else a.status="",a.badge="";return void 0!==a.title&&null!==a.title||(a.title="—"),a.end_time=n(a.end_time,a.full_time),a.start_time=n(a.start_time,a.full_time),a.alarm=n(a.alarm),a.date_completed=n(a.date_completed),a},sortTasks:function(t,e){t=_.copy(t,!0),e||(e="asc");for(var a=[],r=[],n=[],o=function(t,e){return t.title?e.title?t.title.toLowerCase()>e.title.toLowerCase()?1:-1:1:-1},i=function(t,e){return t.end_time>e.end_time?1:t.end_time===e.end_time||void 0===t.end_time&&null===e.end_time||null===t.end_time&&void 0===e.end_time?o(t,e):-1},s=0;s<t.length;s++)3===t[s].status?a.push(t[s]):null===t[s].end_time||void 0===t[s].end_time?n.push(t[s]):r.push(t[s]);return a.sort(i),n.sort(o),r.sort(i),"desc"===e?(a.push(n.reverse(),r.reverse()),a=_.flatten(a)):(a.unshift(r,n),a=_.flatten(a)),a},getPriority:function(e){if(e){var a=parseInt(e.priority,10)||0,r=$("<span>");switch(a){case 0:r.addClass("noprio").attr("title",t("No priority"));break;case 1:r.addClass("low").attr("title",t("Low priority"));break;case 2:r.addClass("medium").attr("title",t("Medium priority"));break;case 3:r.addClass("high").attr("title",t("High priority"))}for(var n=0;n<a;n++)r.append($('<i class="fa fa-exclamation" aria-hidden="true">'));return r}},getConfirmations:function(t){var e={};return t&&(_(t.users).each(function(t){e[String(t.id)]={status:t.confirmation||0,comment:t.confirmmessage||""}}),_(t.confirmations).each(function(t){e[t.mail]={status:t.status||0,comment:t.message||t.confirmmessage||""}})),e},getConfirmationStatus:function(t,e){var a=o.getConfirmations(t),r=e||ox.user_id;return a[r]?a[r].status:0},getConfirmationMessage:function(t,e){var a=o.getConfirmations(t),r=e||ox.user_id;return a[r]?a[r].comment:""},getDateTimeIntervalMarkup:function(t,e){if(t&&t.start_date&&t.end_date){(e=_.extend({timeZoneLabel:{placement:_.device("touch")?"bottom":"top"},a11y:!1,output:"markup"},e)).container&&e.container.parents("#io-ox-core").length<1&&(e.timeZoneLabel.container="body");var a,r,n,i,s=moment(t.start_date).zoneAbbr(),d=e.a11y?"dddd, l":"ddd, l";return t.full_time?(a=moment.utc(t.start_date).local(!0),r=moment.utc(t.end_date).local(!0).subtract(1,"days")):(a=moment(t.start_date),r=moment(t.end_date)),a.isSame(r,"day")?(n=a.format(d),i=o.getTimeInterval(t,e.zone)):t.full_time?(n=o.getDateInterval(t),i=o.getTimeInterval(t,e.zone)):n=a.formatInterval(r,d+" LT"),"strings"===e.output?{dateStr:n,timeStr:i||"",timeZoneStr:s}:$('<div class="date-time">').append($('<span class="date">').text(n),$.txt("   "),$('<span class="time">').append(i?$.txt(i):""))}return""},getDateInterval:function(e,a){if(e&&e.start_date&&e.end_date){var r,n,o=a?"dddd, l":"ddd, l";return a=a||!1,e.full_time?(r=moment.utc(e.start_date).local(!0),n=moment.utc(e.end_date).local(!0).subtract(1,"days")):(r=moment(e.start_date),n=moment(e.end_date)),r.isSame(n,"day")?r.format(o):a&&e.full_time?t("%1$s to %2$s",r.format(o),n.format(o)):r.formatInterval(n,o)}return""},getTimeInterval:function(e,a,r){if(!e||!e.start_date||!e.end_date)return"";if(e.full_time)return o.getFullTimeInterval(e,!0);var n=moment(e.start_date),i=moment(e.end_date);return a&&(n.tz(a),i.tz(a)),r?t("%1$s to %2$s",n.format("LT"),i.format("LT")):n.formatInterval(i,"time")},getFullTimeInterval:function(e,a){var r=o.getDurationInDays(e);return r<=1&&a?t("Whole day"):t.format(t.ngettext("%d day","%d days",r),r)},getDurationInDays:function(t){return moment(t.end_date).diff(t.start_date,"days")},getReminderOptions:function(){var e={},a=[{value:-1,format:"string"},{value:0,format:"minutes"},{value:5,format:"minutes"},{value:10,format:"minutes"},{value:15,format:"minutes"},{value:30,format:"minutes"},{value:45,format:"minutes"},{value:60,format:"hours"},{value:120,format:"hours"},{value:240,format:"hours"},{value:360,format:"hours"},{value:480,format:"hours"},{value:720,format:"hours"},{value:1440,format:"days"},{value:2880,format:"days"},{value:4320,format:"days"},{value:5760,format:"days"},{value:7200,format:"days"},{value:8640,format:"days"},{value:10080,format:"weeks"},{value:20160,format:"weeks"},{value:30240,format:"weeks"},{value:40320,format:"weeks"}];return _(a).each(function(a){var r;switch(a.format){case"string":e[a.value]=t("No reminder");break;case"minutes":e[a.value]=t.format(t.ngettext("%1$d Minute","%1$d Minutes",a.value),a.value);break;case"hours":r=Math.floor(a.value/60),e[a.value]=t.format(t.ngettext("%1$d Hour","%1$d Hours",r),r);break;case"days":r=Math.floor(a.value/60/24),e[a.value]=t.format(t.ngettext("%1$d Day","%1$d Days",r),r);break;case"weeks":r=Math.floor(a.value/60/24/7),e[a.value]=t.format(t.ngettext("%1$d Week","%1$d Weeks",r),r)}}),e}};return o});