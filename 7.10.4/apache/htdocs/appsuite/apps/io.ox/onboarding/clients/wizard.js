define("io.ox/onboarding/clients/wizard",["io.ox/core/tk/wizard","io.ox/onboarding/clients/config","io.ox/onboarding/clients/api","io.ox/core/extensions","io.ox/core/capabilities","settings!io.ox/core","gettext!io.ox/core/onboarding","io.ox/onboarding/clients/views","less!io.ox/onboarding/clients/style"],function(t,e,i,a,n,s,o){"use strict";function r(){var t=arguments;require(["io.ox/core/yell"],function(e){e.apply(void 0,t)})}function l(t){t.preventDefault();var e=$(t.currentTarget).closest("li").attr("data-value"),i=this.parent,a=this.$el.attr("data-type");if("back"===e)return i.model.unset("platform"),i.trigger("step:back");this.parent.model.set(a,e),i.trigger(a+":select",e),this.trigger("next")}function d(){this.$(".wizard-content").find('button[tabindex!="-1"][disabled!="disabled"]:not(.navigation):visible:first').focus()}function c(){var t=this.parent.config,e=_.uniqueId("description");this.$(".wizard-title").text(m),this.$(".wizard-content").empty().addClass("onboarding-platform").append(v.getNode("platform",t.getPlatforms()).on("click","button",l.bind(this)),$('<p class="teaser">').attr("id",e).text(o("Please select the platform of your device."))),this.$el.attr("aria-labelledby",e+"  dialog-title"),this.$(".link").attr("aria-describedby",e),this.$(".options").attr("aria-label",o("list of available platforms"))}function u(){var t=this.parent.config.getDevices(),e=_.uniqueId("description");this.$(".wizard-title").text(m),this.$(".wizard-content").empty().append(v.getNode("device",t).on("click","button",l.bind(this)),$('<p class="teaser">').attr("id",e).text(o("What type of device do you want to configure?"))),this.$el.attr("aria-labelledby",e+"  dialog-title"),this.$(".link").attr("aria-describedby",e),this.$(".options").attr("aria-label",o("list of available devices")),this.$(".title.sr-only").text(o("choose a different platform"))}function p(t){t.preventDefault();var e=$(t.target),i=t.data.wizard,a=e.closest("[data-type]").attr("data-type"),n=e.closest("[data-value]").attr("data-value");if(e.closest(".link").find(".premium").length)return i.trigger("scenario:upsell",t);if(!e.closest(".link").hasClass("disabled")){if("back"===n)return i.model.unset("device"),i.model.unset("scenario"),i.trigger("step:back");i.trigger("scenario:select",n),i.trigger("selected",{type:a,value:n})}}function f(){var t=this.parent.config,e=t.getScenarios(),i=this.parent,n=_.uniqueId("description"),s=this.$(".wizard-content").empty(),r=this;this.$(".wizard-title").attr("id",n).text(o("What do you want to use?")),s.append(v.getNode("scenario",e).on("click","button",{wizard:this.parent},p)),s.append($('<ul class="descriptions">').append(function(){return _.map(e,function(t){var e=_.uniqueId("description");return r.$('.option[data-value="'+t.id+'"]>.link').attr("aria-labelledby",e),$('<li class="description hidden">').attr({"data-parent":t.id}).append($('<div class="">').text(t.description||t.id||" ").attr({id:e}))})})),a.point(b).invoke("draw",s,{$step:this.$el,scenarios:e,config:t,wizard:i});var l=160*(e.length+1)+32;s.find(".descriptions").css("max-width",l>560?l:560),this.$el.attr("aria-labelledby",n+"  dialog-title"),this.$(".options").attr("aria-label",o("list of available devices")),this.$(".actions-scenario").attr("aria-label",o("list of available actions")),this.$(".title.sr-only").text(o("choose a different scenario"));var d=t.model.get("scenario"),c=_.where(e,{enabled:!0});0!==e.length&&0!==c.length&&(d||t.model.set("scenario",d=_.first(c).id),c.length&&i.trigger("selected",{type:"scenario",value:d}))}var h,g,b="io.ox/onboarding/clients/views",m=o("Take %1$s with you! Stay up-to-date on your favorite devices.",ox.serverConfig.productName),v={_getListItems:function(t,e){return _.chain(e).filter(_.partial(v._getValid,_,t)).map(v._getListItem).value()},_getListItem:function(t){return $('<li class="option">').attr("data-value",t.id).attr("data-missing-capabilities",t.missing_capabilities).append(v._getLink(t))},_getListItemBack:function(t){if(_.contains(["device","scenario"],t))return $('<li class="option centered" data-value="back">').append($('<button class="link box navigation" role="menuitem">').append($('<div class="icon-list">').append(v._getIcons("fa-angle-left")),v._getTitle({title:o("back")}).addClass("sr-only")))},_getLink:function(t){return $('<button class="link box" role="menuitem">').addClass(t.enabled?"":"disabled").append(v._getPremium(t),v._getIcons(t.icon),v._getTitle(t))},_getPremium:function(t){if(!t.enabled&&s.get("features/upsell/client.onboarding/enabled",!0)){var e,i,a=$('<div class="premium-container">'),n=s.get("features/upsell/client.onboarding/color"),r=s.get("features/upsell/client.onboarding/icon")||s.get("upsell/defaultIcon");return a.append($('<div class="premium">').append(e=$("<span>").text(o("Premium")),i=$('<i class="fa">'))),n&&e.css("color",n),r&&i.addClass(r),a}},_getTitle:function(t){return t=t||{},$('<div class="title">').text(t.title||t.name||t.id||" ")},_getIcons:function(t){var e=[].concat(t);return $('<div class="icon-list">').append(_.map(e,function(t){return $('<i class="icon fa">').attr("aria-hidden",!0).addClass(t)}))},_getValid:function(t,e){return"device"!==e||t.scenarios.length>0},getNode:function(t,e){return $('<ul class="options" role="menu">').append(v._getListItemBack(t),v._getListItems(t,e))}},x=Backbone.View.extend({initialize:function(e,i){var a=_.extend({id:"client-onboarding",title:o("Client onboarding"),type:"onboarding",data:{}},i);this.config=e,this.model=e.model,this.opt=a,this.set(a.data),t.registry.add(a,this.render.bind(this))},set:function(t){var e={platform:"platforms",device:"devices",scenario:"scenarios"},i={};_.each(t,function(t,a){var n=e[a];n&&this.config.hash[n][t]&&(i[a]=t)}.bind(this)),this.model.set(i)},run:function(){if(!n.has("!client-onboarding"))return _.device("smartphone")?(require(["io.ox/onboarding/clients/view-mobile"],function(t){t.get().open(),s.set("features/clientOnboardingHint/remaining",0).save()}),this):(t.registry.run(this.opt.id),this)},track:function(t,e,i){require(["io.ox/metrics/main"],function(a){a.isEnabled()&&e&&a.trackEvent({app:"core",target:"client-onboarding",type:"click",action:t+"/"+e,detail:(i||"").toLowerCase().replace(/\s/g,"-")})})},_onStepBeforeShow:function(){var t=this.wizard.currentStep,e=this.wizard.steps[t];this.setElement(e.$el),this.$el.addClass("selectable-text")},_reset:function(){var t=this.model;_.each(["platform","device","scenario"],function(e){t.unset(e)})},_onSelect:function(t){var e=this.wizard.getCurrentStep().$el,i=e.find(".options");this.model.set(t.type,t.value),i.find("li").removeClass("selected").filter('[data-value="'+t.value+'"]').addClass("selected"),e.find("[data-parent]").addClass("hidden").filter('[data-parent="'+t.value+'"]').removeClass("hidden"),e.find('.actions > [data-parent="'+t.value+'"] > .action').hasClass("expanded")||e.find('.actions > [data-parent="'+t.value+'"] > .action').first().addClass("expanded")},upsell:function(t){var e=$(t.target).closest("li"),i=e.attr("data-missing-capabilities");i&&require(["io.ox/core/upsell"],function(t){t.enabled(i.replace(/,/g," "))&&(this.wizard.trigger("step:close"),t.trigger({type:"custom",id:e.attr("data-value"),missing:i}))}.bind(this))},register:function(){this.wizard.on({"step:before:show":_.bind(this._onStepBeforeShow,this),selected:_.bind(this._onSelect,this),"before:stop":_.bind(this._reset,this),"platform:select":_.bind(this.track,this,"platform/select"),"device:select":_.bind(this.track,this,"device/select"),"scenario:select":_.bind(this.track,this,"scenario/select"),"action:select":_.bind(this.track,this,"action/select"),"action:execute":_.bind(this.track,this,"action/execute"),"scenario:upsell":_.bind(this.upsell,this),"mode:toggle":_.bind(this.track,this,"mode/toggle")})},render:function(){var e=this.wizard=new t({model:this.model}),i=this;e.config=this.config,e.model=this.model,e.container.addClass("client-onboarding"),e.step({attributes:{"data-type":"platform"},id:"platform",back:!1,next:!1,minWidth:"540px"}).on("before:show",c).on("show",d).end().step({attributes:{"data-type":"device"},id:"device",back:!1,next:!1,minWidth:"540px"}).on("before:show",u).on("show",d).end().step({attributes:{"data-type":"scenario","data-mode":"simple"},id:"scenario",back:!1,next:!1,width:"auto",minWidth:"540px"}).on("show",d).on("before:show",f).end(),_.each(e.steps,function(t){_.extend(t,{view:i})}),this.register(),e.start()}});return g={load:function(){return h||(h=e.load().promise()),h.fail(r),h},render:function(t,e){if(!t.isIncomplete())return new x(t,e).run();require(["io.ox/core/yell"],function(t){t("error",o("Incomplete configuration."))})},run:function(t){var e=_.partial(g.render,_,t);return g.load().then(e)}}});