define("plugins/core/feedback/register",["io.ox/backbone/views/modal","io.ox/core/api/apps","gettext!io.ox/core","io.ox/core/yell","io.ox/backbone/views/disposable","settings!io.ox/core","io.ox/core/api/user","io.ox/core/extensions","io.ox/core/http","less!plugins/core/feedback/style"],function(e,t,n,a,i,r,o,s,d){"use strict";function c(){var e=r.get("feedback/timeLimit","nps-v1"===x?"6M":void 0),t=r.get("feedback/maxFeedbacks",e?1:void 0),n=r.get("feedback/usedFeedbacks",0),a=r.get("feedback/firstFeedbackTime");if(!t)return!0;if(a&&e){var i;-1!==e.indexOf("-")?(i=moment(e).valueOf())<_.now()&&i>a&&0!==n&&(n=0,r.set("feedback/usedFeedbacks",0).save()):(i=moment(a).add(e.substring(0,e.length-1),e.substring(e.length-1)).valueOf())<_.now()&&0!==n&&(n=0,r.set("feedback/usedFeedbacks",0).save())}return n<t}function p(e){$("#io-ox-screens .feedback-button").toggle(e),$('#topbar-settings-dropdown [data-action="feedback"]').parent().toggle(e)}function l(e){var n=ox.ui.App.getCurrentApp(),a=t.forLauncher().map(function(t){if(!e||_(h).contains(t.id))return $("<option>").val(t.id).text(t.get("title"))});return a=_(a).compact(),{currentApp:n,apps:a}}function u(e){return g?g.sendFeedback(e):$.when()}var g,f={1:n.pgettext("rating","It's really bad"),2:n.pgettext("rating","I don't like it"),3:n.pgettext("rating","It's ok"),4:n.pgettext("rating","I like it"),5:n.pgettext("rating","It's awesome")},h=["io.ox/mail","io.ox/contacts","io.ox/calendar","io.ox/files"],b=[n("What is the primary reason for your score?"),n("How can we improve your experience?"),n("Which features do you value or use the most?"),n("What is the one thing we could do to make you happier?")],v=i.extend({className:"star-rating rating-view",name:"simple-star-rating-v1",events:{"change input":"onChange","mouseenter label":"onHover","mouseleave label":"onHover"},initialize:function(e){this.options=_.extend({hover:!0},e),this.value=0,this.$el.attr("tabindex",-1)},render:function(){return this.$el.append(_.range(1,6).map(function(e){return $("<label>").append($('<input type="radio" name="star-rating" class="sr-only">').val(e).attr("title",n("%1$d of 5 stars",e)+". "+f[e]),$('<i class="fa fa-star star" aria-hidden="true">'))}),$('<caption aria-hidden="true">').text(" ").addClass(_.browser.IE?"IE11":"")),this},renderRating:function(e){this.$(".star").each(function(t){$(this).toggleClass("checked",t<e)}),this.$("caption").text(f[e]||" ")},getValue:function(){return this.value},setValue:function(e){e<1||e>5||(this.value=e,this.renderRating(e))},onChange:function(){var e=this.$("input:checked").val()||1;this.setValue(e)},onHover:function(e){if(this.options.hover){var t="mouseenter"===e.type?$(e.currentTarget).find("input").val():this.value;this.renderRating(t)}}}),k=v.extend({name:"star-rating-v1",render:function(e){var t=l(!0);if(r.get("feedback/showModuleSelect",!0)){var a=t.apps.filter(function(e){return e.val()===t.currentApp.id});t.apps.unshift($("<option>").val("general").text(n("General"))),e.append(this.appSelect=$('<select class="feedback-select-box form-control">').append(t.apps)),this.appSelect.val(a.length>0&&a[0].val()||t.apps[0].val())}else t.currentApp?e.append($('<div class="form-control">').text(t.currentApp.get("title")),this.appSelect=$('<div aria-hidden="true">').val(t.currentApp.get("name")).hide()):e.append($('<div class="form-control">').text(n("General")),this.appSelect=$('<div aria-hidden="true">').val("general").hide());return k.__super__.render.call(this),this}}),m=v.extend({className:"nps-rating rating-view",name:"nps-rating-v1",initialize:function(){v.prototype.initialize.apply(this,arguments),this.value=-1},render:function(){return this.$el.append($('<div class="score-wrapper">').append(_.range(0,11).map(function(e){return $("<label>").append($('<input type="radio" name="nps-rating" class="sr-only">').val(e).attr("title",n("%1$d of 10 points.",e)),$('<span class="score" aria-hidden="true">').text(e))})),$('<div class="caption-wrapper">').append($("<caption>").text(n("Not likely at all")),$("<caption>").text(n("Very likely")))),this},renderRating:function(e){var t=parseInt(e,10);this.$(".score").each(function(e){$(this).toggleClass("checked",e===t)})},setValue:function(e){(e=parseInt(e,10))<0||e>11||(this.value=e,this.renderRating(e))}});s.point("plugins/core/feedback").extend({id:"api",index:100,initialize:function(){g={sendFeedback:function(e){if(!e)return $.when();var t=r.get("feedback/mode","star-rating-v1");return d.PUT({module:"userfeedback",params:{action:"store",type:"stars"===t?"star-rating-v1":t},data:e})}}}}),s.point("plugins/core/feedback").extend({id:"process",index:200,process:$.noop});var w={"nps-v1":{ratingView:m,title:n("How likely are you to recommend %1$s to a friend or colleague?",ox.serverConfig.productName)},stars:{ratingView:v,title:n("Please rate this product")},"star-rating-v1":{ratingView:k,title:n("Please rate the following application:")}},x=_.url.hash("feedbackMode")||r.get("feedback/mode","star-rating-v1");-1===_(_(w).keys()).indexOf(x)&&(x="star-rating-v1");var y={allowedToGiveFeedback:c,show:function(){var t={async:!0,enter:"send",point:"plugins/core/feedback",title:n("We appreciate your feedback")};"nps-v1"===x&&(t.width=580),new e(t).extend({title:function(){this.$body.append($('<div class="feedback-welcome-text">').text(w[x].title))},ratingView:function(){this.ratingView=new w[x].ratingView({hover:r.get("feedback/showHover",!0)}),this.$body.addClass(x+"-feedback-view").append(this.ratingView.render(this.$body).$el)},comment:function(){if("nps-v1"!==x||r.get("feedback/showQuestion",!1)){var e=_.uniqueId("feedback-note-"),t="nps-v1"===x?b[r.get("feedback/questionIndex")||0]||n("What is the primary reason for your score?"):n("Comments and suggestions");this.$body.append($("<label>").attr("for",e).text(t),$('<textarea class="feedback-note form-control" rows="5">').attr("id",e))}},infotext:function(){"nps-v1"!==x&&this.$body.append($("<div>").text(n("Please note that support requests cannot be handled via the feedback form. If you have questions or problems please contact our support directly.")))},supportlink:function(){""!==r.get("feedback/supportlink","")&&this.$body.append($("<a>").attr("href",r.get("feedback/supportlink","")))}}).addCancelButton().addButton({action:"send",label:n("Send")}).on("send",function(){var e="nps-v1"===x,t=this.ratingView.getValue();if(e&&-1===t||!e&&0===t)return a("error",n("Please select a rating.")),void this.idle();var i=l().currentApp,o=!1,d=["iOS","MacOS","Android","Windows","Windows8"],g={score:t,app:this.ratingView.appSelect?this.ratingView.appSelect.val():"general",entry_point:i?i.get("name"):"general",comment:this.$(".feedback-note").val()||"",operating_system:"Other",browser:"Other",browser_version:"Unknown",user_agent:window.navigator.userAgent,screen_resolution:screen.width+"x"+screen.height,language:ox.language,client_version:ox.serverConfig.version+"-"+(ox.serverConfig.revision?ox.serverConfig.revision:"Rev"+ox.revision)};switch(e&&ox.trigger("feedback:nps",t),e&&r.get("feedback/showQuestion",!1)&&(g.questionId=b[r.get("feedback/questionIndex")||0]?r.get("feedback/questionIndex")||0:0),_(_.browser).each(function(e,t){e&&-1!==_(d).indexOf(t)&&(g.operating_system=t),!o&&_.isNumber(e)&&("IE"===t&&_.browser.edge?(g.browser="Edge",g.browser_version=parseInt(10*_.browser.Edge,10)/10):(g.browser=t,g.browser_version=e),o=!0)}),g.operating_system){case"MacOS":if(!navigator.userAgent.match(/Mac OS X (\d+_?)*/))break;g.operating_system=navigator.userAgent.match(/Mac OS X (\d+_?)*/)[0];break;case"iOS":if(!navigator.userAgent.match(/iPhone OS (\d+_?)*/))break;g.operating_system=navigator.userAgent.match(/iPhone OS (\d+_?)*/)[0];break;case"Android":g.operating_system="Android "+_.browser.Android;break;case"Windows":if(navigator.userAgent.match(/Windows NT 5\.1/)){g.operating_system="Windows XP";break}if(navigator.userAgent.match(/Windows NT 6\.0/)){g.operating_system="Windows Vista";break}if(navigator.userAgent.match(/Windows NT 6\.1/)){g.operating_system="Windows 7";break}if(navigator.userAgent.match(/Windows NT 6\.2/)){g.operating_system="Windows 8";break}if(navigator.userAgent.match(/Windows NT 6\.3/)){g.operating_system="Windows 8.1";break}if(navigator.userAgent.match(/Windows NT [10.0|6.4]?/)){g.operating_system="Windows 10";break}break;case"Other":if(!navigator.userAgent.match(/Linux/))break;g.operating_system="Linux"}var f=s.Baton.ensure(g);s.point("plugins/core/feedback").invoke("process",this,f),u(g=f.data).done(function(){r.set("feedback/usedFeedbacks",r.get("feedback/usedFeedbacks",0)+1).save(),1===r.get("feedback/usedFeedbacks",0)&&r.set("feedback/firstFeedbackTime",_.now()).save(),c()||p(!1),a("success",n("Thank you for your feedback"))}).fail(function(){a("error",n("Feedback could not be sent"))}),this.close()}).open()},drawButton:function(){var e,t,a=r.get("feedback/position","right");e=$('<div role="region" class="feedback-button">').attr("aria-label",n("Feedback")).addClass("feedback-"+a).append(t=$('<button type="button">').text(n("Feedback")).on("click",this.show)),$("#io-ox-screens").append(e),"right"===a&&e.css("bottom",t.width()+128+"px")}};return s.point("io.ox/core/appcontrol/right/dropdown").extend({id:"feedback",index:240,extend:function(){var e=r.get("feedback/show","both");"both"!==e&&"topbar"!==e||(this.append($('<a href="#" data-action="feedback" role="menuitem" tabindex="-1">').text(n("Give feedback")).on("click",function(e){e.preventDefault(),y.show()})),this.$ul.find('[data-action="feedback"]').parent().toggle(c()))}}),s.point("io.ox/core/plugins").extend({id:"feedback",draw:function(){if(!_.device("smartphone")){var e=r.get("feedback/show","both");"both"!==e&&"side"!==e||(y.drawButton(),p(c()))}}}),ox.on("refresh^",function(){p(c())}),s.point("plugins/core/feedback").invoke("initialize",this),y});