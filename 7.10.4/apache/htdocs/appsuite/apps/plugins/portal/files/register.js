define("plugins/portal/files/register",["io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/files/api","io.ox/preview/main","io.ox/portal/widgets","gettext!plugins/portal"],function(e,t,a,i,o,n){"use strict";e.point("io.ox/portal/widget/stickyfile").extend({type:"files",load:function(e){function t(t){var a=e.model.node;a.find(".title").text(t),a.attr("aria-label",t),a.find("a.disable-widget").attr({"aria-label":t+", "+n("Disable widget")}),a.find(".content.pointer").attr({"aria-label":n.format("Press [enter] to jump to %1$s",t)})}var i=e.model.get("props")||{};return a.get({folder:i.folder_id,id:i.id}).then(function(n){function d(o){a.get(o.toJSON(),{cache:!1}).then(function(a){e.data=a;var o=a["com.openexchange.file.sanitizedFilename"]||a.filename||a.title;i.title!==o&&(i.title=o,e.model.unset("props",{silent:!0}),e.model.set("props",i),t(o))})}function l(){e.fileModel&&e.fileModel.off("change:com.openexchange.file.sanitizedFilename change:filename change:title",d),o.getCollection().remove(e.model)}e.data=n;var r=n["com.openexchange.file.storage.mail.mailMetadata"];r&&require(["io.ox/mail/api"],function(e){e.on("remove:"+_.ecid(r),l)}),e.fileModel=a.pool.get("detail").get(_.cid(n))||null,e.fileModel&&e.fileModel.on("change:com.openexchange.file.sanitizedFilename change:filename change:title",d),a.on("remove:file:"+_.ecid(n),l)},function(e){throw/^(FILE_STORAGE-0026|IFO-0300)$/.test(e.code)?"remove":e})},preview:function(o){var d,l,r,s=o.data["com.openexchange.file.sanitizedFilename"]||o.data.filename,c=$('<div class="content pointer" tabindex="0" role="button">').attr("aria-label",n.format("Press [enter] to jump to %1$s",s));_.isEmpty(s)?(d={folder_id:o.data.folder_id,id:o.data.id},c.html(_.escape(o.data.description).replace(/\n/g,"<br>"))):/(png|jpe?g|gif|bmp)$/i.test(s)?(d={folder_id:o.data.folder_id,id:o.data.id,version:o.data.version},l={width:300,height:300,scaleType:"cover"},r=a.getUrl(d,"view")+"&"+$.param(l),this.addClass("photo-stream"),c.addClass("decoration"),c.css("backgroundImage","url("+r+")")):/(mpeg|m4a|mp3|ogg|oga|x-m4a)$/i.test(s)?(d={folder_id:o.data.folder_id,id:o.data.id},l={width:300,height:300},r=a.getUrl(d,"cover",l),this.addClass("photo-stream"),c.addClass("decoration"),c.css("backgroundImage","url("+r+")")):/(txt|json|md|csv)$/i.test(s)?(d={folder_id:o.data.folder_id,id:o.data.id},$.ajax({type:"GET",url:a.getUrl(d,"view")+"&"+_.now(),dataType:"text"}).done(function(e){c.html(_.escape(e).replace(/\n/g,"<br>"))})):o.data.encrypted?c.addClass("encrypted"):(l={width:300,height:300,scaleType:"cover"},o.data.url=a.getUrl(o.data,"bare"),(r=i.getPreviewImage(o.data)||a.getUrl(o.data,"preview",l))&&(this.addClass("preview"),c.addClass("decoration"),c.css("backgroundImage","url("+r+")"))),c.on("click keypress",{file:o.data},function(i){"keypress"===i.type&&13!==i.which||(i.stopPropagation(),require(["io.ox/files/actions"],function(){a.get(i.data.file).then(function(o){var n=a.pool.get("detail").get(_.cid(o)),d=new Backbone.Collection(n),l=new e.Baton({data:i.data.file,model:n,all:d});t.invoke("io.ox/files/actions/viewer",l)})}))}),this.append(c)},draw:function(){}})});