define("plugins/portal/twitter/register",["io.ox/core/extensions","io.ox/core/strings","io.ox/keychain/api","gettext!plugins/portal","io.ox/core/notifications","plugins/portal/twitter/network","io.ox/core/cache","plugins/portal/twitter/util","less!plugins/portal/twitter/style"],function(t,e,n,r,o,i,s,a){"use strict";var l,d=0,c=$("<ul>").addClass("twitter list-unstyled"),u=$("<div>").html("&nbsp;"),f=new s.SimpleCache("twitter-cache"),p=!1;a.setup({$tweets:c,tweetCache:f});var w=function(t){void 0!==t&&void 0!==t.offline&&t.offline!==p&&(p=t.offline,void 0!==l&&$(l).is(":visible")&&l.replaceWith(m()))},h=function(t){var e=new $.Deferred;return i.loadFromTwitter(t).then(function(t){t.errors&&t.errors.length>0?88===t.errors[0].code?f.keys().done(function(n){var r=_(n).map(function(t){return f.get(t)});$.when.apply($,r).then(function(){var n=_(arguments).toArray().filter(function(t){return t});n.length>0?(w({offline:!0}),e.resolve(n)):e.reject(t)},function(){e.reject(t)})}).fail(function(){e.reject(t)}):e.reject(t):f.clear().done(function(){_(t).each(function(t){f.add(t.id_str,t)}),w({offline:!1}),e.resolve(t)})},function(t){e.reject(t)}),e},v=function(t,e,n){var r={include_entities:!0};return e&&(r.max_id=e,r.count=t+1),n?r.since_id=n:r.count=t,h(r)},g=function(t){var e=t.data;void 0!==c&&$(c).is(":visible")&&(c.empty(),_(e).each(function(t){d=t.id_str,a.showTweet(t,{offline:p}).appendTo(c)}))},m=function(){return l=p?$("<div>").attr({style:"color: #FF0000; padding: 15px; "}).text(r("This widget is currently offline because the twitter rate limit exceeded.")):new a.TwitterTextBox("Tweet",{open:function(t){t.textArea.attr({rows:"4",placeholder:""}).removeClass("io-ox-twitter-tweet-textarea-small"),t.buttonContainer.removeClass("io-ox-twitter-hidden")},close:function(t){""===t.textArea.val()&&(t.textArea.attr({rows:"1",placeholder:"Compose new tweet..."}).addClass("io-ox-twitter-tweet-textarea-small").css("height",""),t.buttonContainer.addClass("io-ox-twitter-hidden"))},success:function(t,e){$.when(i.sendTweet({status:t})).then(function(t){var n=JSON.parse(t);n.errors?_.isArray(n.errors)?o.yell("error",n.errors[0].message):o.yell("error",n.errors):(c.prepend(a.renderTweet(n)),f.add(n.id_str,n)),e.textArea.attr({rows:"1",placeholder:"Compose new tweet..."}).addClass("io-ox-twitter-tweet-textarea-small").css("height",""),e.buttonContainer.addClass("io-ox-twitter-hidden")},function(){o.yell("error",r("An internal error occurred"))})}}).get()},x=function(){d=0;var t=$("li.tweet:first"),e=t.data("entry").id_str;c.addClass("pulltorefresh-refreshing"),$.when(v(0,0,e),_.wait(500)).done(function(e){e.reverse(),_(e).each(function(t){a.showTweet(t,{offline:p}).prependTo(c)});var n=$("div.io-ox-sidepopup-pane"),r=n.scrollTop()-n.offset().top+t.offset().top;n.animate({scrollTop:r},250,"swing"),c.removeClass("pulltorefresh-refreshing")}).fail(function(){c.removeClass("pulltorefresh-refreshing"),o.yell("error",r("Could not load new Tweets."))})},C=function(t){var e=t.contentNode;if(0===t.data.length)e.append($('<li class="paragraph">').text(r("No Tweets yet.")));else if(t.data.errors&&t.data.errors.length>0)e.removeClass("pointer"),$('<div class="paragraph">').text(r("Twitter reported the following errors:")).appendTo(e),_(t.data.errors).each(function(n){$('<div class="error">').text("("+n.code+") "+n.message).appendTo(e),T(n.code,this,t).appendTo(e)});else{var n=t.data.slice(0,_.device("smartphone")?1:10);e.addClass("pointer"),_(n).each(function(t){var n=String(t.text).replace(/((#|@)[\wäöüß]+)/gi,'<span class="accent">$1</span>');e.append($('<li class="paragraph">').append($('<span class="bold">').text("@"+t.user.name+": "),$('<span class="normal">').html(n)))})}},T=function(t){if(32===t||89===t||135===t){var e=n.getStandardAccount("twitter");return $('<a class="solution">').text(r("Authorize your account again")).on("click",function(){n.submodules.twitter.reauthorize(e).done(function(){console.log(r("You have reauthorized this %s account.","Twitter"))}).fail(function(){console.error(r("Something went wrong reauthorizing the %s account.","Twitter"))})})}return 88===t||130===t?$('<a class="solution">').text(r("Retry later.")).on("click",function(){n.submodules.twitter.trigger("update")}):$('<a class="solution">').text(r("Retry")).on("click",function(){n.submodules.twitter.trigger("update")})},y=function(){require(["io.ox/portal/main"],function(t){var e=t.getApp(),n=e.getWidgetCollection().filter(function(t){return/^twitter_\d*/.test(t.id)});n.length>0&&e.refreshWidget(n[0],0)})};t.point("io.ox/portal/widget/twitter").extend({title:r("Twitter"),stopLoadingOnError:!0,initialize:function(){n.submodules.twitter.on("update delete",y),i.fetchUserID().then(function(t){a.setCurrentUserID(t)})},isEnabled:function(){return n.isEnabled("twitter")},requiresSetUp:function(){return n.isEnabled("twitter")&&!n.hasStandardAccount("twitter")},drawDefaultSetup:function(t){n.submodules.twitter.off("create",null,this),n.submodules.twitter.on("create",function(){t.model.node.find("h2 .fa-twitter").replaceWith($('<span class="title">').text(r("Twitter"))),t.model.node.find("h2 .sr-only").remove(),t.model.node.removeClass("requires-setup widget-color-custom color-twitter"),y()},this),this.hasClass("widget-color-custom")||(this.find("h2:first").append($('<i class="fa fa-twitter" aria-hidden="true">')),this.find("h2 .title").removeClass("title").addClass("sr-only"),this.addClass("widget-color-custom color-twitter"))},performSetUp:function(){var t=window.open(ox.base+"/busy.html","_blank","height=400, width=600");return n.createInteractively("twitter",t)},load:function(t){return n.hasStandardAccount("twitter")?h({count:10,include_entities:!0}).done(function(e){t.data=e,g(t)}):$.Deferred().reject({code:"OAUTH-0006"})},preview:function(t){if(t.data){var e=$('<ul class="content pointer list-unstyled" tabindex="0" role="button">').attr("aria-label",r("Press [enter] to jump to the twitter feed."));t.contentNode=e,C(t),this.append(e)}},draw:function(t){var e=t.data;if($(this).on("onResume",function(){$(this).on("onPullToRefresh",x)}).on("onPause",function(){$(this).off("onPullToRefresh",x)}).on("onPullToRefreshDown",function(){$("li.tweet > div.text").addClass("pulltorefresh-unselectable"),$("li.tweet > div.text > span").addClass("pulltorefresh-unselectable")}).on("onPullToRefreshUp",function(){$("li.tweet > div.text").removeClass("pulltorefresh-unselectable"),$("li.tweet > div.text > span").removeClass("pulltorefresh-unselectable")}).on("onAppended",function(){}),e){var n=document.createElement("script");window.twttr||(n.onload=function(){window.twttr.ready(function(e){e.events.bind("tweet",function(){h({count:10,include_entities:!0}).done(function(e){t.data=e,g(t)})})})}),n.type="text/javascript",n.src="https://platform.twitter.com/widgets.js",this.empty().append($("<div>").addClass("clear-title io-ox-twitter-title").text("Twitter"),m()),this[0].appendChild(n),this.append(c.empty(),u),g(t)}else this.remove()},loadMoreResults:function(t){u.addClass("io-ox-busy"),$.when(v(10,d),_.wait(500)).done(function(e){e=e.slice(1),_(e).each(function(t){d=t.id_str,a.showTweet(t,{offline:p}).appendTo(c)}),t(u)}).fail(function(){t(u)})},drawCreationDialog:function(){$(this).append($("<h1>").text("Twitter"),$('<div class="io-ox-portal-preview centered">').append($("<div>").text(r("Add your account"))))}}),t.point("io.ox/portal/widget/twitter/settings").extend({title:r("Twitter"),type:"twitter",editable:!1,unique:!0})});