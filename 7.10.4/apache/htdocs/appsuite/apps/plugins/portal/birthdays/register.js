define("plugins/portal/birthdays/register",["io.ox/core/extensions","io.ox/contacts/api","io.ox/contacts/util","gettext!plugins/portal","settings!io.ox/core","less!plugins/portal/birthdays/style"],function(t,e,a,i,n){"use strict";function d(t){return String(t).toLowerCase().replace(/ä/g,"ae").replace(/ö/g,"oe").replace(/ü/g,"ue").replace(/ß/g,"ss")}function r(t,e){return d(t)+":"+e.format("YYYYMMDD")}function o(t,e,a){a[r(t,e)]=!0}function s(t,e,a){return r(t,e)in a}function l(t){return moment.utc(t.birthday).startOf("day")}var c;t.point("io.ox/portal/widget/birthdays").extend({title:i("Birthdays"),initialize:function(t){e.on("update create delete",function(){require(["io.ox/portal/main"],function(e){var a=e.getApp(),i=a.getWidgetCollection()._byId[t.model.id];i&&a.refreshWidget(i,0)})})},load:function(t){var a=moment().utc(!0).startOf("day").subtract(1,"day");return e.birthdays({start:a.valueOf(),end:a.add(12,"weeks").valueOf(),right_hand_limit:25}).done(function(e){t.data=e})},preview:function(t){var n=$('<ul class="content list-unstyled io-ox-portal-birthdays" tabindex="0">'),d={},r=t.data,c=_.device("smartphone")?5:8;0===(r=_(r).filter(function(t){return _.isNumber(t.birthday)})).length?n.append($('<li class="line no-padding">').text(i("No birthdays within the next %1$d weeks",12))):(n.addClass("pointer").attr({role:"button","aria-label":i("Press [enter] to jump to complete list of Birthdays.")}),_(r.slice(0,c)).each(function(t){var r=l(t),c="",p=moment().utc(!0).startOf("day").year(r.year()),u=a.getFullName(t);c=r.isSame(p,"day")?i("Today"):1===r.diff(p,"day")?i("Tomorrow"):-1===r.diff(p,"day")?i("Yesterday"):a.getBirthday(r),s(u,r,d)||(n.append($('<li class="item">').append(e.pictureHalo($('<div class="picture">').text(a.getInitials(t)),t,{width:32,height:32,fallback:!1}),$('<div class="bold ellipsis">').text(u).prepend(r.isSame(p,"day")?$('<div class="cake">').append('<i class="fa fa-birthday-cake">'):$()),$('<div class="accent">').text(c))),o(u,r,d))})),this.append(n)},draw:function(t){var d,r={};if(d=$('<div class="io-ox-portal-birthdays">').append($("<h1>").text(i("Birthdays"))),0===t.data.length)d.append($("<div>").text(i("No birthdays within the next %1$d weeks",12)));else{var p=$.trim(n.get("customLocations/buy-a-gift","http://www.amazon.com/"));"none"!==p&&""!==p&&d.append($('<div class="buy-a-gift">').append($("<a>",{href:p,target:"_blank",title:i("External link")}).text(i("Buy a gift")),$.txt(" "),$('<i class="fa fa-external-link" aria-hidden="true">'))),_(t.data).each(function(t){var n=l(t),c=a.getFullName(t),p=moment();if(!s(c,n,r)){var u=p.clone().month(n.month()).date(n.date()),f=u.diff(p,"day");f<-1&&(u.add(1,"year"),f=u.diff(p,"day")),f=0===f?i("Today"):1===f?i("Tomorrow"):-1===f?i("Yesterday"):i("In %1$d days",Math.ceil(f)),d.append($('<div class="birthday" tabindex="0">').data("contact",t).append(e.pictureHalo($('<div class="picture">'),t,{width:48,height:48}),$('<div class="name">').text(c),$("<div>").append($('<span class="date">').text(1===n.year()||1604===n.year()?n.formatCLDR("Md"):n.format("l")),$.txt(" "),$('<span class="distance">').text(f)))),o(c,n,r)}}),require(["io.ox/core/tk/dialogs"],function(t){(c=c||new t.SidePopup({modal:!1,tabTrap:!0})).delegate(d,".birthday",function(t,a,i){var n=i.data("contact");require(["io.ox/contacts/view-detail"],function(a){e.get(e.reduce(n)).done(function(e){t.append(a.draw(e))})})})})}this.append(d)}}),t.point("io.ox/portal/widget/birthdays/settings").extend({title:i("Birthdays"),type:"birthdays",editable:!1,unique:!0})});