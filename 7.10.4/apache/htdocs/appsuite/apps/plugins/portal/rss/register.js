define("plugins/portal/rss/register",["io.ox/core/extensions","io.ox/core/strings","io.ox/messaging/accounts/api","io.ox/messaging/services/api","io.ox/messaging/messages/api","io.ox/keychain/api","io.ox/rss/api","io.ox/backbone/views/modal","io.ox/mail/sanitizer","gettext!io.ox/portal"],function(e,t,i,a,s,n,r,o,l,d){"use strict";e.point("io.ox/portal/widget/rss").extend({title:d("RSS Feed"),stopLoadingOnError:!0,load:function(e){var t=e.model.get("props").url||[],i=e.model.attributes.title;return t=_(t).filter(function(e){return""!==$.trim(e)}),r.getMany(t).done(function(a){if(a=a.slice(0,100),_(a).each(function(e){e.subject=e.subject.replace(/&nbsp;/g," ").replace("&amp;","&")}),e.data={items:a,title:"",link:"",urls:t},void 0!==i&&""!==i)e.data.title=i;else{var s=_(a).first();void 0!==s&&void 0!==s.feedTitle?e.data.title=s.feedTitle:e.data.title=d("RSS Feed")}})},preview:function(e){var t=e.data,i=_.device("smartphone")?5:10,a=$('<ul class="content pointer list-unstyled" tabindex="0" role="button" aria-label="'+d("Press [enter] to jump to the rss stream.")+'">');0===t.items.length?$('<li class="item">').text(d("No RSS feeds found.")).appendTo(a):$(t.items).slice(0,i).each(function(e,i){a.append($('<li class="paragraph">').append(function(){return t.urls.length>1?$('<span class="gray">').text(i.feedTitle+" "):""},$("<span>").text(i.subject),$.txt("")))}),this.append(a)},draw:function(){function e(e){var t=$('<div class="text-body noI18n">').html(l.simpleSanitize(e.body));t.find("a").attr({target:"_blank",rel:"noopener"}),t.find('img[src=""][data-original-src^="https://"]').each(function(e,t){$(t).attr("src",$(t).attr("data-original-src")).css({"max-width":"300px","max-height":"300px"})}),this.append($('<div class="text">').append($("<h4>").text(e.subject),t,$('<div class="rss-url">').append($('<a target="_blank" rel="noopener">').attr("href",e.url).text((e.feedTitle?e.feedTitle+" - ":"")+moment(e.date).format("l")))))}return function(t){var i=t.data,a=$('<div class="portal-feed">');i.title&&a.append($("<h2>").text(i.title)),_(i.items).each(e,a),this.append(a)}}()}),e.point("io.ox/portal/widget/rss/settings").extend({title:d("RSS Feed"),type:"rss",editable:!0,edit:function(e,t){e.set("candidate",!0,{silent:!0,validate:!0});var i=new o({title:d("RSS Feeds"),async:!0}),a=$('<textarea id="rss_url" class="form-control" rows="5" placeholder="http://">'),s=$('<input id="rss_desc" type="text" class="form-control">'),n=$('<div class="alert alert-danger">').css("margin-top","15px").hide(),r=e.get("props")||{};i.build(function(){this.$body.append($('<div class="form-group">').append($('<label for="rss_url">').text(d("URL")),a.val((r.url||[]).join("\n"))),$('<div class="form-group">').append($('<label for="rss_desc">').text(d("Description")),s.val(r.description),n))}).addCancelButton().addButton({label:d("Save"),action:"save"}).on("cancel",function(){e.has("candidate")&&_.isEmpty(e.attributes.props)&&t.removeWidget()}).on("save",function(){var t=$.trim(a.val()),r=$.trim(s.val()),o=$.Deferred();n.hide(),0===t.length?(n.text(d("Please enter a feed URL.")),o.reject()):o.resolve(),o.done(function(){t=_(t.split(/\n/)).filter(function(e){return""!==$.trim(e)}),i.close(),e.set({title:r,props:{url:t,description:r}},{validate:!0}),e.unset("candidate")}),o.fail(function(){n.show(),i.idle()})}).open()}})});