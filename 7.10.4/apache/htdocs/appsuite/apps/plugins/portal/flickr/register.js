define("plugins/portal/flickr/register",["io.ox/core/extensions","io.ox/portal/feed","io.ox/backbone/views/modal","settings!io.ox/portal","gettext!plugins/portal"],function(e,t,o,r,i){"use strict";function a(e,t){var o="https://www.flickr.com/services/rest/?api_key="+n+"&format=json&method=flickr.people.findByUsername&username="+e+"&jsoncallback=getFlickerNsid",r=$.Deferred();return $.ajax({url:o,dataType:"jsonp",jsonp:!1,jsonpCallback:"getFlickerNsid",success:function(e){e&&e.stat&&"ok"===e.stat?r.resolve(e.user.nsid):(r.reject(),t.text(i("Cannot find user with given name.")))},error:function(){r.reject(),t.text(i("Cannot find user with given name."))}}),r}var n=r.get("apiKeys/flickr"),l=["url_l","url_c","url_z","url_o","url_n","url_m","url_q","url_s","url_sq","url_t"],s="l m n o q s sq t z".split(" "),c="https://www.flickr.com/services/rest/?api_key="+n+"&format=json&extras=date_upload,"+l.join(",");_.isUndefined(n)||(e.point("io.ox/portal/widget/flickr").extend({title:"Flickr",stopLoadingOnError:!0,initialize:function(e){function o(){var o,r=e.model.get("props"),a=r.method;a&&(o="flickr.photos.search"===a?c+"&method=flickr.photos.search&text="+encodeURIComponent(r.query):c+"&method=flickr.people.getPublicPhotos&user_id="+encodeURIComponent(r.nsid),e.feed=new t({url:o+="&jsoncallback="}),e.feed.process=function(e){return e&&"ok"===e.stat?e.photos:{error:i("Could not load data")}})}e.model.on("change:props",o),o()},load:function(e){return e.feed?e.feed.load().done(function(t){e.data=t}):(e.data=[],$.when())},preview:function(e){var t,o,r="";this.find("h2 .title").text(e.model.get("props").query||"Flickr"),e.data.error?this.append($('<div class="content">').text(e.data.error)):(_.isArray(t=e.data.photo)&&t.length>0&&(t=t[Math.min(t.length-1,10*Math.random()>>0)]),t&&(_(s).each(function(e){(""===r||t["width_"+e]>250&&t["width_"+e]<1e3)&&t["url_"+e]&&(r=e,o=t["url_"+e])}),this.addClass("photo-stream").append($('<div class="content pointer" tabindex="0" role="button" class="decoration">').attr("aria-label",i("Press [enter] to jump to the flicker stream.")).css("backgroundImage","url("+o+")"))))},draw:function(){function e(e,t){var o,r,i="";_(s).each(function(t){(""===i||e["width_"+t]>=500&&e["width_"+t]<1200)&&e["url_"+t]&&(i=t,o=e["url_"+t])}),i&&(e.title&&this.append($("<caption>").text(e.title)),this.append(r=$('<div class="photo">').css("backgroundImage","url("+o+")")),t&&r.wrap($('<a target="_blank" rel="noopener">').attr("href",t+"/"+e.owner+"/"+e.id+"/")))}return function(t){var o=$('<div class="portal-feed">'),r="flickr.photos.search"===t.model.get("props").method?"http://www.flickr.com/photos":"";o.append($("<h1>").text(t.model.get("props").query)),_(t.data.photo).each(function(t){e.call(o,t,r)}),this.append(o)}}()}),e.point("io.ox/portal/widget/flickr/settings").extend({title:i("Flickr"),type:"flickr",editable:!0,edit:function(e,t){e.set("candidate",!0,{silent:!0,validate:!0});var r=new o({title:i("Edit Flickr photo stream"),async:!0,width:400}),n=$('<input id="flickr_search" type="text" class="form-control" tabindex="0">'),l=$('<input id="flickr_desc" type="text" class="form-control" tabindex="0">'),s=$('<select id="flickr_option" class="form-control" tabindex="0">').append($("<option>").attr("value","flickr.photos.search").text(i("Search photos")),$("<option>").attr("value","flickr.people.getPublicPhotos").text(i("Public photos by user"))),c=$("<div>").addClass("alert alert-danger").css("margin-top","15px").hide(),d=e.get("props")||{};r.build(function(){this.$body.append($('<div class="row">').append($('<div class="col-sm-12">').append($('<label for="flickr_search">').text(i("Search")),n.val(d.query))),$('<div class="row">').append($('<div class="col-sm-12">').append($('<label for="flickr_option">').text(i("Type")),s.val(d.method))),$('<div class="row">').append($('<div class="col-sm-12">').append($('<label for="flickr_desc">').text(i("Description")),l.val(d.description),c)))}).addCancelButton().addButton({label:i("Save"),action:"save"}).on("cancel",function(){e.has("candidate")&&_.isEmpty(e.get("props"))&&t.removeWidget()}).open(),r.on("save",function(){c.hide();var t,o=String($.trim(n.val())),p=$.trim(s.val()),u=$.trim(l.val());return(t="flickr.people.getPublicPhotos"===p?a(o,c):$.Deferred().resolve()).done(function(t){0===o.length?(c.text(i("Please enter a search query")),c.show(),r.idle()):0===u.length?(c.text(i("Please enter a description")),c.show(),r.idle()):(d={method:p,query:o,description:u},t&&(d.nsid=t),e.set({title:u,props:d},{validate:!0}),e.unset("candidate"),r.close())}),t.fail(function(){c.show(),r.idle()}),t})}}))});