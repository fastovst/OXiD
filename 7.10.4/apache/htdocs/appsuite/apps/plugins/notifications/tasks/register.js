define("plugins/notifications/tasks/register",["io.ox/core/extensions","gettext!plugins/notifications","io.ox/tasks/api","io.ox/core/api/reminder","io.ox/core/notifications/subview","settings!io.ox/core","io.ox/tasks/util","less!plugins/notifications/tasks/style"],function(t,e,i,o,a,n,s){"use strict";var d=n.get("autoOpenNotification",!0);return"always"===d||"noEmail"===d?(d=!0,n.set("autoOpenNotification",!0),n.save()):"Never"===d&&(d=!1,n.set("autoOpenNotification",!1),n.save()),t.point("io.ox/core/notifications/due-tasks/item").extend({draw:function(t){var o=this,a=s.interpretTask(t.model.attributes);o.addClass("taskNotification").attr({"data-cid":_.cid(a),"aria-label":e("Overdue Task %1$s.",a.title)}).append($('<a class="notification-info" role="button">').append($('<span class="span-to-div title">').text(a.title),$('<div class"clearfix">').append($('<span class="end_date">').text(a.end_time),$('<span class="status pull-right">').text(a.status).addClass(a.badge),$('<span class="sr-only">').text(e("Press to open Details")))),$('<div class="actions">').append($('<button type="button" class="btn btn-default" data-action="done">').attr("aria-label",e("Mark as done")+" "+t.model.get("title")).text(e("Done")).on("click",function(e){e.stopPropagation(),i.update({id:a.id,folder_id:a.folder_id,status:3,percent_completed:100,date_completed:_.now()}).done(function(t){i.trigger("update:"+_.ecid(a),t)}),t.view.removeNotifications(a.id)})))}}),t.point("io.ox/core/notifications/register").extend({id:"dueTasks",index:500,register:function(){var t={id:"io.ox/duetasks",api:i,apiEvents:{reset:"new-tasks",remove:"delete unmark:overdue",add:"mark:overdue"},useListRequest:!0,title:e("Overdue Tasks"),extensionPoints:{item:"io.ox/core/notifications/due-tasks/item"},detailview:"io.ox/tasks/view-detail",autoOpen:d,genericDesktopNotification:{title:e("New overdue tasks"),body:e("You have overdue tasks"),icon:""},specificDesktopNotification:function(t){var i=s.interpretTask(t.attributes),o=_.isEmpty(i.end_time)?"":", "+i.end_time;return{title:e("New overdue task"),body:i.title+o,icon:""}},hideAllLabel:e("Hide all notifications for overdue tasks.")},o=new a(t);n.on("change:autoOpenNotification",function(t){o.model.set("autoOpen",t)}),i.getTasks()}}),t.point("io.ox/core/notifications/task-reminder/item").extend({draw:function(t){var e=this.addClass("taskNotification");e.attr("data-cid",String(_.cid(t.requestedModel.attributes))),require(["io.ox/core/tk/reminder-util"],function(a){var n=s.interpretTask(t.model.attributes);a.draw(e,new Backbone.Model(n),s.buildOptionArray(),!0),e.on("click",'[data-action="ok"]',function(a){a.stopPropagation();var n=t.model,d=e.find('[data-action="selector"]').val(),r=[n.get("folder_id")+"."+n.get("id")];"0"!==d?o.remindMeAgain(s.computePopupTime(d).alarmDate,t.requestedModel.get("id")).then(function(){return $.when(i.caches.get.remove(r),i.caches.list.remove(r))}).done(function(){i.trigger("update:"+_.ecid(r[0]))}):o.deleteReminder(t.requestedModel.attributes),t.view.removeNotifications([t.requestedModel])})})}}),t.point("io.ox/core/notifications/register").extend({id:"reminderTasks",index:200,register:function(){var t={id:"io.ox/remindertasks",api:o,apiEvents:{reset:"set:tasks:reminder"},title:e("Task reminders"),extensionPoints:{item:"io.ox/core/notifications/task-reminder/item"},detailview:"io.ox/tasks/view-detail",autoOpen:d,genericDesktopNotification:{title:e("New task reminders"),body:e("You have new task reminders"),icon:""},specificDesktopNotification:function(t){var i=s.interpretTask(t.attributes),o=_.isEmpty(i.end_time)?"":", "+i.end_time;return{title:e("New task reminder"),body:i.title+o,icon:""}},hideAllLabel:e("Hide all task reminders.")},i=new a(t);n.on("change:autoOpenNotification",function(t){i.model.set("autoOpen",t)}),o.getReminders()}}),t.point("io.ox/core/notifications/task-confirmation/item").extend({draw:function(t){var o=this.addClass("taskNotification"),a=t.model,n=t.view,d=s.interpretTask(t.model.toJSON());o.attr({role:"listitem","data-cid":_.cid(t.model.attributes),"focus-id":"task-invitation-"+_.ecid(t.model.attributes),"aria-label":e("Invitation for %1$s.",d.title),tabindex:0}).append($('<a class="notification-info" role="button">').append($('<span class="span-to-div title">').text(d.title),$('<div class="clearfix">').append($('<span class="end_date">').text(d.end_time),$('<span class="status">').text(d.status).addClass(d.badge)),$('<span class="sr-only">').text(e("Press to open Details"))),$('<div class="actions">').append($('<button type="button" class="accept-decline-button refocus btn btn-default" data-action="change_state">').attr({"focus-id":"task-invitation-accept-decline"+_.ecid(t.model.attributes),"aria-label":e("Accept/Decline")+" "+d.title}).css("margin-right","14px").text(e("Accept/Decline")).on("click",function(e){if(e.stopPropagation(),"click"===e.type||13===e.which){var i=t.model.attributes;ox.load(["io.ox/calendar/actions/acceptdeny","io.ox/tasks/api"]).done(function(t,e){t(i,{taskmode:!0,api:e,callback:function(){e.trigger("update:"+_.ecid({id:i.id,folder_id:i.folder_id}))}})})}}),$('<button type="button" class="refocus btn btn-success" data-action="accept">').attr({"aria-label":e("Accept invitation")+" "+d.title,"focus-id":"task-invite-accept-"+_.ecid(t.model.attributes)}).append('<i class="fa fa-check" aria-hidden="true">').on("click",function(e){if(e.stopPropagation(),"click"===e.type||13===e.which){var o={id:t.model.get("id"),folder_id:t.model.get("folder_id"),data:{confirmmessage:"",confirmation:1}};n.responsiveRemove(a),i.confirm(o).done(function(){n.hiddenCollection.remove(a),i.trigger("update:"+_.ecid(o))}).fail(function(){n.unHide(a)})}}))),d=null}}),t.point("io.ox/core/notifications/register").extend({id:"confirmationTasks",index:400,register:function(){var t={id:"io.ox/confirmationtasks",api:i,apiEvents:{reset:"set:tasks:to-be-confirmed",remove:"delete mark:task:confirmed",add:"mark:task:to-be-confirmed"},useListRequest:!0,title:e("Task invitations"),extensionPoints:{item:"io.ox/core/notifications/task-confirmation/item"},detailview:"io.ox/tasks/view-detail",autoOpen:d,genericDesktopNotification:{title:e("New task invitations"),body:e("You have new task invitations"),icon:""},specificDesktopNotification:function(t){var i=s.interpretTask(t.attributes),o=_.isEmpty(i.end_time)?"":", "+i.end_time;return{title:e("New task invitation"),body:i.title+o,icon:""}},hideAllLabel:e("Hide all task invitations.")},o=new a(t);n.on("change:autoOpenNotification",function(t){o.model.set("autoOpen",t)})}}),!0});