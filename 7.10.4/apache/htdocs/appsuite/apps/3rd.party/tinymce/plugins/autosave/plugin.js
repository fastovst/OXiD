!function(t){"use strict";function e(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=e.concat(n);return t.apply(null,o)}}var n=function(t){var e=t,r=function(){return e};return{get:r,set:function(t){e=t},clone:function(){return n(r())}}},r=tinymce.util.Tools.resolve("tinymce.PluginManager"),o=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),a=tinymce.util.Tools.resolve("tinymce.util.Tools"),i=function(t){return t.fire("RestoreDraft")},u=function(t){return t.fire("StoreDraft")},c=function(t){return t.fire("RemoveDraft")},s=function(t,e){var n={s:1e3,m:6e4},r=t||e,o=/^(\d+)([ms]?)$/.exec(""+r);return(o[2]?n[o[2]]:1)*parseInt(r,10)},f=function(t){return t.getParam("autosave_ask_before_unload",!0)},l=function(e){var n=e.getParam("autosave_prefix","tinymce-autosave-{path}{query}{hash}-{id}-");return n=n.replace(/\{path\}/g,t.document.location.pathname),n=n.replace(/\{query\}/g,t.document.location.search),n=n.replace(/\{hash\}/g,t.document.location.hash),n=n.replace(/\{id\}/g,e.id)},m=function(t){return t.getParam("autosave_restore_when_empty",!1)},d=function(t){return s(t.settings.autosave_interval,"30s")},v=function(t){return s(t.settings.autosave_retention,"20m")},g=function(t,e){var n=t.settings.forced_root_block;return""===(e=a.trim(void 0===e?t.getBody().innerHTML:e))||new RegExp("^<"+n+"[^>]*>((Â |&nbsp;|[ \t]|<br[^>]*>)+?|)</"+n+">|<br>$","i").test(e)},y=function(t){var e=parseInt(o.getItem(l(t)+"time"),10)||0;return!((new Date).getTime()-e>v(t))||(p(t,!1),!1)},p=function(t,e){var n=l(t);o.removeItem(n+"draft"),o.removeItem(n+"time"),!1!==e&&c(t)},h=function(t){var e=l(t);!g(t)&&t.isDirty()&&(o.setItem(e+"draft",t.getContent({format:"raw",no_events:!0})),o.setItem(e+"time",(new Date).getTime().toString()),u(t))},D=function(t){var e=l(t);y(t)&&(t.setContent(o.getItem(e+"draft"),{format:"raw"}),i(t))},_=function(t,e){var n=d(t);e.get()||(setInterval(function(){t.removed||h(t)},n),e.set(!0))},w=function(t){t.undoManager.transact(function(){D(t),p(t)}),t.focus()},b=function(t){return{hasDraft:e(y,t),storeDraft:e(h,t),restoreDraft:e(D,t),removeDraft:e(p,t),isEmpty:e(g,t)}},I=tinymce.util.Tools.resolve("tinymce.EditorManager");I._beforeUnloadHandler=function(){var t;return a.each(I.get(),function(e){e.plugins.autosave&&e.plugins.autosave.storeDraft(),!t&&e.isDirty()&&f(e)&&(t=e.translate("You have unsaved changes are you sure you want to navigate away?"))}),t};var R=function(e){t.window.onbeforeunload=I._beforeUnloadHandler},T=function(t,e){return function(n){var r=n.control;r.disabled(!y(t)),t.on("StoreDraft RestoreDraft RemoveDraft",function(){r.disabled(!y(t))}),_(t,e)}},P=function(t,e){t.addButton("restoredraft",{title:"Restore last draft",onclick:function(){w(t)},onPostRender:T(t,e)}),t.addMenuItem("restoredraft",{text:"Restore last draft",onclick:function(){w(t)},onPostRender:T(t,e),context:"file"})};r.add("autosave",function(t){var e=n(!1);return R(),P(t,e),t.on("init",function(){m(t)&&t.dom.isEmpty(t.getBody())&&D(t)}),b(t)})}(window);