define(ox.base+"/precore.js",["io.ox/core/boot/config","io.ox/core/manifests"],function(e){"use strict";var t=$.Deferred();ox.session?e.user().then(t.resolve,t.reject):ox.once("login:success",function(){e.user().then(t.resolve,t.reject)}),t.then(function(){define("io.ox/find/main",["io.ox/find/view-placeholder","io.ox/core/folder/api","io.ox/core/extensions","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,o,n){var a=$.Deferred().reject("please launch app first"),r=function(e){var t=[e.getName(),e.get("inplace")?"inplace":"standalone",e.getModule()];return _.compact(t).join(":")},s=function(s){function l(){var e=c.model.manager,t="files"===c.getModuleParam();c.listenTo(e,{active:_.debounce(function(e){c.model.manager.isFolderOnly()&&(e=0),t&&c.model.manager.isAccountOnly()&&(e=0),c.trigger(e?"find:query":"find:idle")},10)}),c.listenTo(e,{"change:list-of-actives":_.debounce(function(e,t,i){require(["io.ox/metrics/main"],function(t){var o=c.get("parent").get("name")||"unknown",n=_.last(o.split("/")),a=i.get("facet").get("id").split(":")[0],r="deactivate"===e||i.get("facet")&&"disabled"===i.get("facet").getValue().getOption().id;t.trackEvent({app:n,target:"search/filter/"+a,action:r?"remove":"add"})})},10)}),c.listenTo(c.view,{cancel:function(){c.trigger("find:cancel")},show:function(){c.updateConfig()}})}function d(){var e=c.get("parent");return $.when(e.folder.getData(),e.folder.isDefault()).then(function(e,t){var i=[],o=c.model.manager;if(t&&!c.isMandatory("folder")||i.push({facet:"folder",filter:null,value:e.id}),!c.isMandatory("account")||o.findWhere({id:"account"})&&o.findWhere({id:"account"}).getActive().length||i.push({facet:"account",filter:null,value:e.account_id}),i.length)return{data:{facets:i}}})}var c;return s=_.extend({},{inplace:!0},s),(c=ox.ui.createApp(_.extend({name:"io.ox/find",title:n("Search"),state:"created"},s))).mediator({props:function(e){e.props=new Backbone.Model},"props-mandatory":function(e){var t=o.get("search/mandatory",{});t.account=t.account||[],t.account.push("drive"),e.props.set("mandatory",t)},"props-default":function(e){e.props.set("default",o.get("search/default","io.ox/mail"))},"props-mapping":function(e){var t=e.props.get("default-app");e.props.set("mapping",{"io.ox/mail/compose":"io.ox/mail","com.voiceworks/ox-messenger":t,"io.ox/drive":"io.ox/files","io.ox/office/text":"io.ox/files","io.ox/office/portal":"io.ox/files","io.ox/office/spreadsheet":"io.ox/files","io.ox/office/presentation":"io.ox/files","io.ox/office/portal/text":"io.ox/files","io.ox/office/portal/spreadsheet":"io.ox/files","io.ox/office/portal/presentation":"io.ox/files","io.ox/portal":t,"io.ox/settings":t})},cid:function(e){e.cid=r(e)},"window-inplace":function(e){e.get("inplace")&&e.set("window",e.get("parent").getWindow())},state:function(e){if(e.get("inplace")){var t=e.get("parent");e.on({"find:query:result":function(){!0===e.isActive()&&t.props.set("find-result",!0)},"find:idle":function(){t.props.set("find-result",!1)}})}},reset:function(e){e.get("inplace")&&(e.listenTo(e.get("parent"),"folder:change folder-virtual:change",e.cancel),e.listenTo(e.get("parent").props,"change:folderview",e.cancel))},"enable-disable-toggle":function(e){e.get("inplace")&&e.listenTo(e.get("parent").treeView,"selection:action",function(t,i){var o=$(t[i]);o.hasClass("selected")||e.updateState(o.attr("data-id"))})},vgrid:function(e){if(e.get("inplace")){var t,i=e.get("parent").grid;i&&i.addTemplate&&(i.setAllRequest("search",function(){var t={sort:i.prop("sort"),order:i.prop("order")};return e.getSearchResult(t,!0).then(function(e){return e&&e.results?e.results:[]})}),i.setListRequest("search",function(t){var i=[t];return $.Deferred().resolveWith(e,i)}),e.on({"find:query":function(){i.setMode("search"),t=i.getEmptyMessage(),i.setEmptyMessage(function(){return n("No matching items found.")})},"find:idle":function(){"all"!==i.getMode()&&(i.setMode("all"),i.setEmptyMessage(t))}}))}},"listview-empty-message":function(e){if(e.get("parent").listView){var t=e.get("parent").listView.ref;i.point(t+"/notification/empty").extend({id:"search",index:100,draw:function(e){e.app.props.get("find-result")&&this.text(n("No matching items found."))}})}},"listview-empty-message-action":function(e){if(e.get("parent").listView&&!e.isMandatory("folder")){var t=e.get("parent").listView.ref;i.point(t+"/notification/empty").extend({id:"search-action",index:200,draw:function(e){if(e.app.props.get("find-result")){var t=e.app.get("find").model.manager;t.get("folder")&&"disabled"===t.get("folder").get("values").get("custom").getOption().id||this.append($('<button type="button" class="btn btn-link" data-action="search-button">').text(n("Search in all folders")).on("click",function(){t.activate("folder","custom","disabled"),require(["io.ox/metrics/main"],function(t){var i=e.app.get("name")||"unknown",o=_.last(i.split("/"));t.trackEvent({app:o,target:"list/empty/search/filter/folder",action:"remove"})})}))}}})}},listview:function(e){e.get("inplace")&&e.on("change:state",function(t,i){if("launched"===i){var o=e.get("parent");o.listView&&require(["io.ox/core/api/collection-loader"],function(t){var i=e.view.model.manager,n=_.bind(i.getResponseCid,i),a=o.listView.loader,r="default",s=new t({module:"calendar"===e.getModuleParam()?"chronos":e.getModuleParam(),mode:"search",PRIMARY_PAGE_SIZE:a.PRIMARY_SEARCH_PAGE_SIZE||a.PRIMARY_PAGE_SIZE,SECONDARY_PAGE_SIZE:a.SECONDARY_SEARCH_PAGE_SIZE||a.SECONDARY_PAGE_SIZE,isBad:$.noop,fetch:function(t){var i=this,o=t.limit.split(","),n=parseInt(o[0],10),a=parseInt(o[1],10)-n;e.model.set({start:n,size:a,extra:1},{silent:!0});var r={sort:e.props.get("sort"),order:e.props.get("order")};return e.getSearchResult(r,!0).then(function(e){var t=(e=e||{}).results||[],o=e.request||{};if(i.collection.search={next:0!==t.length&&t.length===o.data.size},!t.length)return t;var n=t[0];return n.original_folder_id?n.original_folder_id===n.folder_id?t:(t.forEach(function(e){_.extend(e,{id:e.original_id||e.id,folder_id:e.original_folder_id||e.folder_id})}),t):t})},cid:n});o.listView.on("collection:load",function(){"search"===this.loader.mode&&s.collection&&(s.collection.expired=!0)}),e.trigger("collectionLoader:created",s);var l=function(){o.listView.connect(s),r="search"};e.on({"find:idle":function(){"search"===r&&(o.listView.connect(a),o.listView.load()),r="default"},"find:query":_.debounce(function(){"search"!==o.listView.loader.mode&&l(),o.listView.load()},10)})})}})},quit:function(e){e.get("inplace")&&e.listenTo(e.get("parent"),"quit",e.quit)},"window-standalone":function(e){if(!e.get("inplace")){var t;e.setWindow(t=ox.ui.createWindow({name:"io.ox/find",chromeless:!0})),t.show()}},"file-storages":function(e){if(!("files"===e.getModuleParam()))return e.set("storages",[]);require(["io.ox/core/api/filestorage"],function(t){t.rampup().then(function(){e.set("storages",t.getAccountsCache()),e.get("storages").on({change:$.noop,add:$.noop,remove:$.noop})})})}}),c.cancel=function(){this.view&&this.view.cancel()},c.updateState=function(e){c.trigger(t.isVirtual(e)?"view:disable":"view:enable")},c.getModule=function(){return c.get("parent").get("name")},c.getModuleParam=function(){return c.getModule().split("/")[1]},c.isActive=function(){return!!c.view&&c.view.isActive()},c.isMandatory=function(e){var t=c.props.get("mandatory"),i=c.getModuleParam();return"files"===i&&(i="drive"),(t[e]||[]).indexOf(i)>=0},c.getFolderFacetValue=function(){if(c.isActive())return(_(c.model.manager.getRequest()).findWhere({facet:"folder"})||{}).value},c.prepare=function(){c.set("state","preparing"),c.mediate(),c.placeholder=new e({app:c});var t=c.get("parent").folder.get();c.updateState(t),c.listenToOnce(c.placeholder,"launch",c.launch),c.set("state","prepared")},c.getProxy=function(){var e;return function(){var t=$.Deferred();return e||(require(["io.ox/find/apiproxy"],function(i){e=t.resolve(i.init(c))}),t)}}(),c.getConfig=function(e){return c.getProxy().then(function(t){return t.config(e)})},c.getSuggestions=function(e){return"launched"!==c.get("state")?a:$.when(c.getProxy(),c.configReady).then(function(t){return t.search(e)})},c.getSearchResult=function(e,t){return"launched"!==c.get("state")?a:c.getProxy().then(function(i){return i.query(e,t)})},c.configReady=$.Deferred(),c.updateConfig=function(){d().then(c.getConfig).then(function(e){e=_.reject(e,function(e){return"contact"===e.id}),c.model.manager.update(e),c.trigger("find:config-updated"),c.configReady.resolve()},function(e){require(["io.ox/core/yell"],function(t){t(e)}),c.cancel()})},c.launch=function(){"prepared"===c.get("state")&&(c.set("state","launching"),c.placeholder&&(c.placeholder.destroy(),delete c.placeholder),require(["io.ox/find/bundle"],function(){require(["io.ox/find/model","io.ox/find/view"],function(e,t){c.model=new e({app:c}),c.view=new t({app:c,model:c.model}),l(),c.view.render(),c.set("state","launched"),ox.trigger("search:load",c)}),require(["io.ox/contacts/api"],function(e){e.on("refresh.all",function(){c.getProxy().done(function(e){e.resetCache()})})})}))},c};return{getApp:s,reuse:function(e){return ox.ui.App.reuse(r(e))||s(e)}}}),define("io.ox/find/view-placeholder",["io.ox/backbone/views/disposable","gettext!io.ox/core"],function(e,t){return e.extend({events:{focusin:"focused",keyup:"showSpinner"},initialize:function(e){var t=e.app.getWindow();this.setElement(t.nodes.sidepanel.find(".io-ox-find")),this.ui={field:this.$el.find(".search-field"),action:this.$el.find(".action-show")},this.options=e,this.listenTo(e.app,"view:disable",this.disable),this.listenTo(e.app,"view:enable",this.enable)},hideSpinner:function(){this.ui.action.removeClass("io-ox-busy")},showSpinner:function(){this.ui.action.addClass("io-ox-busy")},disable:function(){!0!==this.ui.field.prop("disabled")&&(this.ui.field.prop("disabled",!0),this.ui.action.prop("disabled",!0),this.ui.field.find("input.token-input.tt-input").removeAttr("tabindex"),this.$el.find(".arialive").text(t("Search function not supported in this folder")))},enable:function(){!1!==this.ui.field.prop("disabled")&&(this.ui.field.prop("disabled",!1),this.ui.action.prop("disabled",!1),this.ui.field.find("input.token-input.tt-input").attr("tabindex",0),this.$el.find(".arialive").text(""))},focused:function(){this.trigger("launch"),this.destroy()},destroy:function(){this.disposed||(this.hideSpinner(),this.trigger("destroy"),this.dispose())}})}),define("io.ox/core/desktop",["io.ox/core/event","io.ox/backbone/views/window","io.ox/core/extensions","io.ox/core/cache","io.ox/core/notifications","io.ox/core/upsell","io.ox/core/adaptiveLoader","io.ox/core/folder/api","io.ox/core/api/apps","io.ox/find/main","io.ox/core/main/icons","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,o,n,a,r,s,l,d,c,u,p){function f(e){var t=u.get("search/modules")||[];return e=e.replace(/^io\.ox\//,"").replace(/files/,"drive"),t.indexOf(e)>-1}function h(){var e=void 0!==_.url.hash("restore")&&/^(0|false)$/i.test(_.url.hash("restore"));return void 0!==_.url.hash("restore")&&/^(1|true)$/i.test(_.url.hash("restore"))||!e&&u.get("features/storeSavePoints",!0)}var g=null,m=0,v=new o.SimpleCache("app-cache",!0),x=Backbone.Model.extend({defaults:{title:""},initialize:function(e){var t=this;this.options=e||{},this.guid=this.options.guid||m++,this.id=this.id||(this.options.refreshable?this.options.name:"")||"app-"+this.guid,this.set("path",this.options.path?this.options.path:this.getName()+"/main"),this.set("id",this.id),this.set("openInTab",this.options.openInTab),this.set("tabUrl",this.options.tabUrl),this.getInstance=function(){return t}},getName:function(){return this.get("name")},setTitle:function(e){this.set("title",e);{if(!this.options.floating)return this;this.getWindow().floating&&this.getWindow().floating.setTitle(e)}},getTitle:function(){return this.get("title")},getWindow:$.noop,saveRestorePoint:$.noop,call:$.noop});ox.ui.AppPlaceholder=x;var b={LIMIT:265e3,length:function(e){return JSON.stringify(e).length},crop:function(e,t,i){var o=b.length,a=e[i];return b.LIMIT<o(e)-o(a||"")+o(t)?(a?t=a:t.point.data={},"exceeded"in t||"io.ox/mail/compose"===t.module||(n.yell("warning",p("Failed to automatically save current stage of work. Please save your work to avoid data loss in case the browser closes unexpectedly.")),t.exceeded=!0)):delete t.exceeded,t}};return ox.ui.App=x.extend({defaults:{window:null,state:"ready",saveRestorePointTimer:null,launch:function(){return $.when()},resume:function(){return $.when()},quit:function(){return $.when()}},initialize:function(){var e=this;x.prototype.initialize.apply(this,arguments),this.set("uniqueID",_.now()+"."+String(Math.random()).substr(3,4));var t=$.proxy(this.saveRestorePoint,this);$(window).on("unload",t),this.disableRestorePointTimer||this.set("saveRestorePointTimer",setInterval(t,1e4)),this.folder=function(){var t,i,o=null,a=null,r=null,l=$.Deferred();return s.on("after:rename",function(e,t){a&&a.setTitle(t.title||"")}),t={initialized:l.promise(),unset:function(){o=null,_.url.hash("folder",null),a&&a.setTitle(""),r&&r.clear()},set:function(){function t(t,i,n,d,c){var u=_.url.hash("app")!==n;o=String(t),u||(a&&(a.setTitle(i.display_title||i.title||""),a.updateToolbar()),r&&r.prop("folder")!==o&&(r.busy().prop("folder",o),r.refresh(),s.reload(t)),_.url.hash("folder",o),e.trigger("folder:change",o,i,c)),d.resolve(i,u),"resolved"!==l.state()&&l.resolve(o,i)}return function(e,i){var n=$.Deferred();if(void 0!==e&&null!==e&&String(e)!==o){var a=_.url.hash("app"),r=s.pool.getModel(e),l=r.toJSON();r.has("title")?t(e,l,a,n,i):s.get(e).then(function(o){t(e,o,a,n,i)},function(){console.warn("Failed to change folder",e),n.reject()})}else String(e)===o?n.resolve(s.pool.getModel(e).toJSON(),!1):n.reject();return n}}(),setType:function(e){return i=e,this},setDefault:function(){return $.when().then(function(){var e=s.getDefaultFolder(i);return e?t.set(e):s.getExistingFolder(i).then(function(e){return t.set(e)},function(){return $.Deferred().reject({error:p("Could not get a default folder for this application.")})})})},isDefault:function(){return $.when().then(function(){var e=s.getDefaultFolder(i);return String(o)===String(e)})},get:function(){return o},getData:function(){if(null===o)return $.Deferred().resolve({});var e=s.pool.getModel(o);return $.Deferred().resolve(e.toJSON())},getModel:function(){return s.pool.getModel(o)},can:function(e){return null===o?$.when(!1):require(["io.ox/core/folder/api"]).then(function(t){return t.get(o).then(function(i){return t.can(e,i)})})},updateTitle:function(e){return a=e,this},updateGrid:function(e){return r=e,this},destroy:function(){t=a=r=null},handleErrors:function(){var t=_.debounce(function(t){var i=s.pool.getModel(e.folder.get());i&&s.list(i.get("folder_id"),{cache:!1}),e.folder.setDefault(),n.yell(t)},1e3,!0),i=new RegExp("(APP-0013|CON-0104|FLD-0003|FLD-0008|FLD-1004|CAL-4060|IMAP-1002|IMAP-2041|IFO-0400|FILE_STORAGE-0005|FILE_STORAGE-0055|TSK-0023)");return function(){e.listenTo(ox,"http:error",function(o,n){var a=n.params.folder||n.data.folder||o.folder||n.params.id;if(a===e.folder.get()&&("IMAP-1002"!==o.code&&"FLD-0008"!==o.code||!s.isBeingDeleted(a))&&i.test(o.code))return/(IMAP-2041|IFO-0400|APP-0013|CON-0104|TSK-0023)/.test(o.code)?s.get(e.folder.get(),{cache:!1}):void t(o)})}}()}}()},setLauncher:function(e){return this.set("launch",e),this},setResume:function(e){return this.set("resume",e),this},setQuit:function(e){return this.set("quit",e),this},setWindow:function(e){if(this.set("window",e),e.app=this,this.options.floating){var i=this.options.floatingWindowModel||new t.Model(_.extend(_(this.options).pick("closable","displayStyle","size","taskbarIcon","title","name"),{win:e}));e.floating=new t.View({el:e.nodes.outer,model:i}).render(),e.floating.listenTo(i,"quit",function(){e.app.quit().done(function(){i.trigger("close")})}),e.floating.listenTo(i,"change:active change:minimized",function(t){if(e.app.dropZone){if(!(t.get("active")&&!t.get("minimized"))&&e.app.dropZone.remove)return e.app.dropZone.remove();e.app.dropZone.include&&e.app.dropZone.include()}}),e.app.once("quit",function(){i.trigger("close")})}return this.has("name")&&e.nodes.outer.attr("data-app-name",this.get("name")),this},getWindow:function(){return this.get("window")},isFindSupported:function(){return f(this.getName())},initFind:function(){if(this.get("find"))return!0;var e=d.getApp({parent:this});return e.prepare(),this.set("find",e),e},getWindowNode:function(){return this.has("window")?this.get("window").nodes.main:$()},getWindowTitle:function(){return this.has("window")?this.get("window").getTitle():""},mediator:function(e){ox.ui.App.mediator(this.getName(),e)},mediate:function(){var e=this;return i.point(this.getName()+"/mediator").each(function(t){try{t.setup&&t.setup(e)}catch(e){console.error("mediate",t.id,e.message,e)}})},registerGlobalEventHandler:function(e,t,i){function o(){a.on(t,i)}function n(){a.off(t,i)}var a=$(e),r=this.getWindow();r.on({show:o,hide:n,quit:n}),r.state.visible&&o()},registerWindowResizeHandler:function(e){var t=this.getWindow();this.registerGlobalEventHandler(window,"resize",e),t.on("show",e),t.state.visible&&e()},setState:function(e){if(!this.options.floating&&!this.options.plugged)for(var t in e)_.url.hash(t,null!==e[t]?String(e[t]):null)},getState:function(){return _.url.hash()},launch:function(e){var o=$.when(),n=this,a=this.getName();if(this.options.floating||this.options.plugged||(a!==_.url.hash("app")&&_.url.hash({folder:null,perspective:null,id:null}),a&&_.url.hash("app",a)),"ready"===this.get("state")){this.set("state","initializing"),ox.trigger("app:init",this),_.extend(this.options,e),a&&i.point(a+"/main").invoke("launch",this,this.options);try{o=this.get("launch").call(this,this.options)||$.when()}catch(e){console.error("Error while launching application:",e.message,e,this)}o.then(function(){l.add(n),n.set("state","running"),n.trigger("launch",n),ox.trigger("app:start",n),!n.get("closable")||n.get("floating")||_.device("smartphone")||t.addNonFloatingApp(n)},function(){var e=require("settings!io.ox/core").get("autoStart");throw"none"!==e&&ox.launch(e),arguments})}else if("initializing"!==this.get("state")&&this.has("window")){this.get("window").show(),this.trigger("resume",this),ox.trigger("app:resume",this),a&&i.point(a+"/main").invoke("resume",this,e);try{o=this.get("resume").call(this,e)||$.when()}catch(e){console.error("Error while resuming application:",e.message,e,this)}$(window).trigger("resize.lazyload")}return o.then(function(){return $.Deferred().resolveWith(n,arguments)})},quit:function(e){var t,i=this;return(e?$.when():this.get("quit").call(this)||$.when()).done(function(){e&&i.destroy&&i.destroy(),i.floating||!i.getWindow()||!i.getWindow().state.visible||_.url.hash("app")&&i.getName()!==_.url.hash("app").split(":",1)[0]||_.url.hash({app:null,folder:null,perspective:null,id:null}),clearInterval(i.get("saveRestorePointTimer")),i.removeRestorePoint(),$(window).off("unload",$.proxy(i.saveRestorePoint,i)),i.folder.destroy(),i.has("window")&&((t=i.get("window")).trigger("quit"),ox.ui.windowManager.trigger("window.quit",t),t.destroy()),i.dropZone&&i.dropZone.remove&&i.dropZone.remove(),l.remove(i),i.trigger("quit"),ox.trigger("app:stop",i),i.set("state","stopped");for(var o in i)delete i[o];i=t=null})},saveRestorePoint:function(){var e=this,t=e.get("uniqueID");return this.failSave&&("io.ox/mail/compose"!==this.get("name")||u.get("features/storeMailSavePoints",!0))?ox.ui.App.getSavePoints().then(function(i){i=i||[];var o,n,a;try{o=e.failSave(),n=_(i).pluck("id"),a=_(n).indexOf(t),o&&(o.floating=e.get("floating"),o.id=t,o.timestamp=_.now(),o.version=ox.version,o.ua=navigator.userAgent,o=b.crop(i,o,a),a>-1?i.splice(a,1,o):i.push(o))}catch(t){a>-1&&(i.splice(a,1),delete e.failSave)}return i.length>0?ox.ui.App.setSavePoints(i):$.when()}):$.when()},removeRestorePoint:function(){var e=this.get("uniqueID");return ox.ui.App.removeRestorePoint(e)}}),_.extend(ox.ui.App,{mediator:function(e,t){var o=i.point(e+"/mediator"),n=0;_(t).each(function(e,t){o.extend({id:t,index:n+=100,setup:e})})},canRestore:function(){return this.getSavePoints().then(function(e){return e&&e.length>0})},cleanupSavepoints:function(){u.get("savepointCleanup",!1)||u.set("savepoints",[]).save().then(function(){u.set("savepointCleanup",ox.version).save()})},getSavePoints:function(){return h()?v.get("savepoints").then(function(e){e=e||[];var t=u.get("savepoints",[]).filter(function(e){return e.restoreById});return e=[].concat(e,t),_(e||[]).filter(function(e){var t="point"in e,i=e.ua===navigator.userAgent;return t&&(i||e.restoreById)})}):$.when([])},storeSavePoints:_.noop,setSavePoints:function(e){if(!h())return $.Deferred().resolve([]);e=e||[];var t=_(e).filter(function(e){return e.restoreById});return e=_(e).filter(function(e){return!e.restoreById}),u.set("savepoints",t),v.add("savepoints",e)},removeAllRestorePoints:function(){return this.setSavePoints([])},removeRestorePoint:function(){function e(e,t){var i=_(e).pluck("id");return e[_(i).indexOf(t)]}function t(t){_(i).each(function(o,n){e(t,n)||delete i[n]})}var i={};return function(e){var o=this;return i[e]=!0,this.getSavePoints().then(function(e){t(e=(e||[]).slice());var n=_(e).pluck("id");return _(i).each(function(t,i){var o=_(n).indexOf(i),a=e[o];if(o>-1&&e.splice(o,1),a&&a.restoreById){var r=u.get("savepoints",[]);n=_(r).pluck("id"),(o=_(n).indexOf(i))>-1&&(r.splice(o,1),u.set("savepoints",r).save())}}),o.setSavePoints(e).then(function(){return e})})}}(),restore:function(){var e=this;return this.cleanupSavepoints(),$.when(this.getSavePoints(),ox.rampup.compositionSpaces).then(function(i,o){return $.when.apply($,_([].concat(i,o||[])).map(function(i){r.stop();var o=r.startAndEnhance(i.module,[i.module+"/main"]);return ox.load(o).then(function(o){var n=o.getApp(i.passPointOnGetApp?i.point:void 0);if(_.device("!smartphone")&&(n.options.floating||n.options.closable)){var a,r;return n.options.floating?(a=new t.Model({minimized:!0,id:i.id,title:i.description,closable:!0,lazy:!0,taskbarIcon:n.options.taskbarIcon,name:n.options.name}),r=new t.TaskbarElement({model:a}).render(),t.collection.add(a)):(r=t.addNonFloatingApp(n,{lazyload:!0}),a=r.model),r.listenToOnce(a,"lazyload",function(){var t=i.id;if(i=_.clone(i),n.options.floating)return a.set(_(n.options).pick("closable","displayStyle","size","taskbarIcon","title")),void n.launch({floatingWindowModel:a}).then(function(){return i.id=this.get("uniqueID"),this.failRestore?this.failRestore(i.point):$.when()}).done(function(){e.removeRestorePoint(t).then(e.getSavePoints).then(function(t){t.push(i),!1!==i.keepOnRestore&&e.setSavePoints(t),a.get("quitAfterLaunch")&&a.trigger("quit")})}).fail(function(e){e&&"MSG-0032"===e.code&&_.delay(function(){ox.ui.App.removeRestorePoint(t),a.trigger("close")})});n.launch().then(function(){return i.id=this.get("uniqueID"),this.failRestore?this.failRestore(i.point):$.when()}).done(function(){e.removeRestorePoint(t).then(e.getSavePoints).then(function(t){t.push(i),e.setSavePoints(t)})})}),$.when()}var s=i.id;return n.launch().then(function(){if(i.id=this.get("uniqueID"),this.failRestore)return this.failRestore(i.point).then(function(){n.set("restored",!0)})}).fail(function(e){e&&"MSG-0032"===e.code&&_.delay(function(){ox.ui.App.removeRestorePoint(s)})})})})).done(function(){e.setSavePoints(i)})})},get:function(e){return l.where({name:e})},getByCid:function(e){return l.get(e)},reuse:function(e){var t=ox.ui.apps.find(function(t){return t.cid===e});return!!t&&(t.launch(),!0)},isCurrent:function(e){var t=ox.ui.App.getCurrentApp();return!(!t||t.get("name")!==(_.isString(e)?e:e.model.get("name")))},getCurrentApp:function(){return null!==g?g.app:null},getCurrentFloatingApp:function(){return _.chain(ox.ui.apps.pluck("window")).compact().map(function(e){if("io.ox/help"!==e.app.get("name"))return e.floating&&e.floating.model&&e.floating.model.get("active")?e.app:void 0}).compact().first().value()},getCurrentWindow:function(){return g}}),$("#io-ox-core").show(),window.onbeforeunload=function(){var e=l.some(function(e){return _.isFunction(e.hasUnsavedChanges)&&e.hasUnsavedChanges()});if(ox.trigger("beforeunload",e),e)return p("There are unsaved changes.")},ox.ui.createApp=function(e){if(a.visible(e.requires)&&_.device(e.device))return l.add(new ox.ui.App(e))},ox.ui.screens=function(){var t=null,i={add:function(e){return $("<div>",{id:"io-ox-"+e}).addClass("abs").hide().appendTo("#io-ox-screens")},get:function(e){return $("#io-ox-screens").find("#io-ox-"+e)},current:function(){return t},hide:function(e){this.get(e).hide(),this.trigger("hide-"+e)},show:function(e){$("#io-ox-screens").children().each(function(){var t=$(this).attr("id"),o=String(t||"").substr(6);o!==e&&"ad-skyscraper"!==o&&i.hide(o)}),this.get(e).show(),t=e,this.trigger("show-"+e)}};return e.extend(i),i}(),ox.ui.Perspective=function(){function e(e,t,i,o){var n=e.getWindow().getPerspective();n&&_.isFunction(n.save)&&n.save(),i&&(i.show(e,_.extend({perspective:t},o)),_.isFunction(i.restore)&&i.restore())}var t=function(e){this.main=$(),this.name=e,this.rendered=!1,this.render=$.noop,this.save=$.noop,this.restore=$.noop,this.afterShow=$.noop,this.afterHide=$.noop,this.show=function(t,i){var o=t.getWindow(),n=i.animation?{animation:i.animation}:{},a=this,r=i.perspective.split(":")[0];i.disableAnimations&&(n.disableAnimations=!0),i.perspective!==o.currentPerspective&&(this.main=t.pages.getPage(r),t.pages.getPageObject(r).perspective||(t.pages.getPageObject(r).perspective=this),o.addPerspective(this),"main"!==o.currentPerspective?o.trigger("change:perspective",e,i.perspective):o.trigger("change:initialPerspective",e),_.url.hash("perspective",i.perspective),this.rendered||(this.render(t,i),this.rendered=!0),t.pages.getPage(r).one("pageshow",function(){a.afterShow(t,i),o.currentPerspective=i.perspective,o.updateToolbar()}),t.pages.getCurrentPage().name===r&&(this.afterShow(t,i),o.currentPerspective=i.perspective,o.updateToolbar()),t.pages.changePage(r,n))},this.hide=function(){this.afterHide()}};return t.show=function(t,i,o){return require([t.get("name")+"/"+i.split(":")[0]+"/perspective"],function(n){e(t,i,n,o)})},t}(),ox.ui.windowManager=function(){var t=e.extend({}),i=[],o=function(){return _(i).inject(function(e,t){return e+(t.state.open?1:0)},0)};return t.getWindows=function(){return i.slice()},ox.ui.screens.on("hide-windowmanager",function(){g&&g.hide()}),t.hide=function(){ox.ui.screens.hide("windowmanager")},t.show=function(){ox.ui.screens.show("windowmanager")},t.on("window.open window.show",function(e,t){if(this.show(),i=_(i).without(t),t.options.floating?t.nodes.body.attr("role","region"):(_(i).each(function(e){e.nodes.body.removeAttr("role")}),"io.ox/settings"!==t.options.name&&t.nodes.body.attr("role","main")),i.unshift(t),i.length>1){var o=_(i).map(function(e){return e.name});v.add("windows",o||[])}}),t.on("window.beforeshow",function(){t.trigger("empty",!1)}),t.on("window.close window.quit window.pre-quit",function(e,n,a){a||(a=e.type+"."+e.namespace);var r,s,l,d=_(i).indexOf(n);if(-1!==d){for("window.quit"===a?i.splice(d,1):"window.close"!==a&&"window.pre-quit"!==a||(i=_(i).without(n)).push(n),r=0,s=i.length;r<s;r++)if((l=i[r])!==n&&l.state.open&&!l.floating){l.resume();break}v.get("windows").done(function(e){var t=_.indexOf(e,n.name);t>-1&&(e.splice(t,1),v.add("windows",e||[]))})}0===o()?v.get("windows").done(function(e){t.trigger("empty",!0,e?e[1]||null:null)}):t.trigger("empty",!1)}),t}(),ox.ui.createWindow=function(){var t=0,o=$("#io-ox-windowmanager-pane"),n=function(e){function t(e){var t=$('<div style="width: 100px; visibility: hidden; overflow-y: scroll;">').appendTo("body"),i=100-t[0].clientWidth;t.remove(),e.css("padding-right",i)}this.options=e||{},this.id=e.id,this.name=e.name||"generic",this.nodes={title:$(),toolbar:$(),controls:$(),closeButton:$(),disabled:$()},this.state={visible:!1,running:!1,open:!1},this.app=null,this.detachable=!1,this.simple=!1,this.page=e.page;var n=this.page?this.page:o,a=!1,r={},s=this,d=!0,c=$.Deferred(),p=this.name;this.updateToolbar=function(){var e=this.app&&this.app.folder?this.app.folder.get():null,t=i.Baton({window:this,$:this.nodes,app:this.app,folder:e});i.point(p+"/toolbar").invoke("draw",this.nodes.toolbar.empty(),t)},i.point(p+"/window-title").extend({id:"default",draw:function(){return $('<h1 class="window-title">').append(i.point(p+"/window-title-label").invoke("draw",this).first().value()||$())}}),i.point(p+"/window-title-label").extend({id:"default",draw:function(){return $('<span class="window-title-label">')}}),i.point(p+"/window-body").extend({id:"default",draw:function(){return this.body.append(this.main=$('<div class="abs window-content">'))}}),this.shown=c.promise(),this.setHeader=function(e){return"top"===(_.device("!desktop")?"top":u.get("features/windowHeaderPosition","bottom"))?(this.nodes.header.append(e.addClass("container")),this.nodes.outer.addClass("header-top")):(this.nodes.footer.append(e.addClass("container")),this.nodes.outer.addClass("header-bottom")),t(this.nodes.header),this.nodes.header},this.resume=function(){this.show(_.noop,!0)},this.show=function(e,t){var i=!1,o=this.app&&this.app.options.plugged;!this.floating&&!o&&g&&_.url.hash("app")&&s.name!==_.url.hash("app").split(":",1)[0]&&(i=!0),ox.trigger("change:document:title",this.app.get("title"));var a=this.nodes.outer,r=a.parent();if(i&&!t||!s||g===this&&0!==r.length)_.call(e);else{if(0===a.parent().length&&(this.floating?this.floating.open(!0):this.simple?(a.insertAfter("#io-ox-appcontrol"),document.body.style.setProperty("overflow-y","auto","important")):a.appendTo(n)),ox.ui.windowManager.trigger("window.beforeshow",s),this.trigger("beforeshow"),this.updateToolbar(),this.floating||o||_.url.hash("app")&&s.app.getName()===_.url.hash("app").split(":",1)[0]||_.url.hash("app",s.app.getName()),a.show(),null===s)return;this.floating||!g||g===s||this.page||g.hide(),this.floating||o||(g=s),_.call(e),s.state.visible=!0,s.state.open=!0,s.trigger("show"),d&&(c.resolve(),s.trigger("show:initial"),s.trigger("open"),s.state.running=!0,ox.ui.windowManager.trigger("window.open",s),ox.trigger("app:ready",s.app),d=!1),ox.ui.windowManager.trigger("window.show",s),l.trigger("resume",s.app)}return this},this.hide=function(){if(!this.floating)return this.trigger?(this.trigger("beforehide"),this.simple||this.detachable&&0===this.nodes.outer.find("iframe").length?(this.nodes.outer.detach(),$("body").css("overflowY","")):this.nodes.outer.hide(),this.state.visible=!1,this.trigger("hide"),ox.ui.windowManager.trigger("window.hide",this),g===this&&(g=null),this):this},this.toggle=function(){return g===this?this.hide():this.show(),this},this.preQuit=function(){return window.cordova||this.hide(),this.state.open=!1,this.floating&&this.floating.minimize(),ox.ui.windowManager.trigger("window.pre-quit",this),this},this.close=function(){var e=this;return this.trigger?(a&&null!==this.app?(this.trigger("beforequit"),this.app.quit().done(function(){e.state.open=!1,e.state.running=!1,e=null})):(this.hide(),this.state.open=!1,this.trigger("close"),ox.ui.windowManager.trigger("window.close",this)),this):this};this.busy=function(e,t,i){var o;return s&&(o=s.nodes.blocker,$("body").focus(),s.nodes.disabled=s.nodes.disabled.add(s.nodes.main.find('input:not([type="file"], [type="hidden"]), select, textarea, button').not(":disabled").prop("disabled",!0)),_.isNumber(e)?(e=Math.max(0,Math.min(e,1)),o.idle().find(".progress-bar").eq(0).css("width",100*e+"%").parent().show(),_.isNumber(t)?o.find(".progress-bar").eq(1).css("width",100*t+"%").parent().show():_.isString(t)&&o.find(".footer").text(t),o.show()):(o.find(".progress").hide(),o.busy().show()),_.isFunction(i)&&i.call(o),s.trigger("busy")),this},this.idle=function(){return s&&(s.nodes.blocker.find(".progress").hide().end().idle().hide().find(".header, .footer").empty(),s.nodes.disabled.prop("disabled",!1),s.nodes.disabled=$(),s.trigger("idle")),this},this.destroy=function(){return this.hide(),this.trigger("destroy"),null!==this.app&&(this.app.win=null,this.app=null),this.events.destroy(),this.show=this.busy=this.idle=$.noop,this.nodes.outer.remove(),this.nodes=s=null,this},this.setQuitOnClose=function(e){return a=!!e,this};this.getTitle=function(){return""},this.setTitle=function(e){return ox.trigger("change:document:title",[e,this.app.get("title")]),this},this.addClass=function(){var e=this.nodes.outer;return e.addClass.apply(e,arguments)},this.addButton=function(e){var t=$.extend({label:"Action",action:$.noop},e||{});return $("<div>").addClass("io-ox-toolbar-link").text(String(t.label)).on("click",t.action).appendTo(this.nodes.toolbar)},this.addPerspective=function(e){r[e.name]||(r[e.name]=e)},this.getPerspective=function(){var e=this.currentPerspective.split(":")[0];return r[e]},this.currentPerspective="main",this.setChromeless=function(e){e?(this.nodes.outer.addClass("chromeless-window"),this.nodes.body.css("left","0px")):(this.nodes.outer.removeClass("chromeless-window"),this.nodes.body.css("left",""))}};return function(o){var a=$.extend({chromeless:!1,classic:!1,id:"window-"+t,name:"",title:"",toolbar:!1,width:0,floating:!1},o),r=(String(a.width).match(/^(\d+)(px|%)$/)||["","100","%"]).splice(1),s=r[0],l=r[1],d=new n(a);return d.nodes.outer=$('<div class="window-container">').attr({id:a.id,"data-window-nr":t}),a.simple?(d.simple=!0,d.nodes.outer.addClass("simple-window").append(d.nodes.main=$('<div class="window-content" tabindex="-1">')),d.nodes.blocker=$(),d.nodes.head=$(),d.nodes.body=$()):(d.nodes.outer.append($('<div class="window-container-center">').data({width:s+l}).css({width:s+l}).append(d.nodes.blocker=$('<div class="abs window-blocker">').hide().append($('<div class="abs header">'),$('<div class="progress first"><div class="progress-bar" style="width:0"></div></div>').hide(),$('<div class="progress second"><div class="progress-bar" style="width: 0"></div></div>').hide(),$('<div class="abs footer">')),d.nodes.header=$('<div class="window-header">'),d.nodes.sidepanel=$('<div class="window-sidepanel collapsed">'),d.nodes.body=$('<div class="window-body">'),d.nodes.footer=$('<div class="window-footer">')).on("controller:quit",function(){d.app&&d.app.quit()})),a.classic&&d.nodes.outer.addClass("classic"),a.name&&d.nodes.outer.addClass(a.name.replace(/[./]/g,"-")+"-window"),i.point(a.name+"/window-body").invoke("draw",d.nodes)),e.extend(d),a.search&&console.warn("search is deprecated with 7.6.0. Please use io.ox/find instead"),a.facetedsearch&&console.warn("io.ox/search is deprecated with 7.8.0. Please use io.ox/find instead"),a.find&&f(a.name)&&(i.point("io.ox/find/view").extend({id:"view",index:100,draw:function(e){e.$.viewnode=$('<div class="generic-toolbar top io-ox-find" role="search">'),this.nodes.sidepanel.append(e.$.viewnode).addClass("top-toolbar")}}),i.point("io.ox/find/view").extend({id:"subviews",index:200,draw:function(e){e.$.viewnode.append($('<div class="sr-only arialive" role="status" aria-live="polite">'),e.$.box=$('<form class="search-box">'),e.$.boxfilter=$('<div class="search-box-filter">'))}}),i.point("io.ox/find/view").extend({id:"form",index:300,draw:function(e){_.extend(e.data,{label:p("Search"),id:_.uniqueId("search")}),e.$.group=$('<div class="form-group has-feedback">').append($('<input type="text" class="form-control has-feedback search-field tokenfield-placeholder f6-target">').attr({"aria-labelledby":e.data.id,placeholder:e.data.label+"..."})),e.$.box.append(e.$.group)}}),i.point("io.ox/find/view").extend({id:"buttons",index:400,draw:function(e){e.$.group.append($('<button type="button" class="btn btn-link form-control-feedback action action-show" data-toggle="tooltip" data-placement="bottom" data-animation="false" data-container="body">').attr({"data-original-title":p("Start search"),"aria-label":p("Start search"),id:e.data.id}).append($('<i class="fa fa-search" aria-hidden="true">')).tooltip(),$('<button type="button" class="btn btn-link form-control-feedback action action-cancel" data-toggle="tooltip" data-placement="bottom" data-animation="false" data-container="body">').attr({"data-original-title":p("Cancel search"),"aria-label":p("Cancel search")}).append($('<i class="fa fa-times-circle" aria-hidden="true">')).tooltip())}}),i.point("io.ox/find/view").invoke("draw",d,i.Baton.ensure({}))),a.chromeless&&d.setChromeless(!0),t++,d}}(),ox.load=function(){function e(){var e=setTimeout(function(){ox.busy(!0),n=setTimeout(function(){if(!r[0].firstChild){var i=$('<button type="button" class="btn btn-primary">').text(p("Cancel")).fadeIn();i.on("click",function(){o.reject(!0),t(e)}),r.append(i),i.focus()}},5e3)},1e3);return e}function t(e){clearTimeout(e),clearTimeout(n),e=null,n=null,setTimeout(function(){null===e&&ox.idle()},0)}function i(e){a.always(function(){t(e)})}var o,n,a,r=$("#background-loader");return function(t,n){assert(arguments.length<=1||2===arguments.length&&!_.isFunction(n),"ox.load does not support callback params."),o=$.Deferred(),a=n&&n.launched?n.launched:$.Deferred().resolve(),r.hasClass("secure")||ox.busy();var s=e();return require(t).always(i(s)).then(o.resolve,function(e){if(console.error(e),o.reject(!1),_.isArray(t))for(var i=0;i<t.length;i++)requirejs.undef(t[i])}),o}}(),ox.launch=function(e,t){var i=$.Deferred(),o=Date.now();if(_.isString(e)){r.stop();var a=r.startAndEnhance(e.replace(/\/main$/,""),[e]);ox.load(a,t).then(function(n){if(!n||!n.getApp)return console.error("Couldn't launch app",e,n),void i.resolve({});n.getApp(t).launch(t).done(function(){i.resolveWith(this,arguments),ox.trigger("loadtime",{app:this,id:e,loadStart:o,loadEnd:Date.now()})})},function(){n.yell("error",p("Failed to start application. Maybe you have connection problems. Please try again.")),requirejs.undef(e)})}else i.resolve({});return i},l.on("resume",function(e){r.stop(),r.listen(e.get("name"))}),ox.ui}),define("io.ox/core/api/apps",["io.ox/core/extensions","io.ox/core/manifests","io.ox/core/capabilities","settings!io.ox/core"],function(e,t,i,o){function n(e){return e&&!this.blacklist[e.id]}var a=["io.ox/mail","io.ox/calendar","io.ox/contacts","io.ox/files","io.ox/portal","io.ox/tasks","io.ox/office/portal/text","io.ox/office/portal/spreadsheet","io.ox/office/portal/presentation"];ox.debug&&a.push("io.ox/notes");var r=Backbone.Model.extend({constructor:function(e,t){Backbone.Model.call(this,{id:e},t)}}),s=Backbone.Collection.extend({model:r}),l=Backbone.Collection.extend({initialize:function(){if(this.blacklist=_.reduce(o.get("apps/blacklist","").split(","),function(e,t){return e[t]=!0,e},{}),this.launcher=new s(a),o.contains("apps/list")){var e=o.get("apps/list").split(",");this._launcher=new s(e)}else this._launcher=this.launcher;this._launcher.on("all",function(){var e=Array.prototype.slice.call(arguments);e[0]="launcher:"+e[0],this.trigger.apply(this,e)},this)},forLauncher:function(){return _.filter(this._launcher.map(this.get.bind(this)),n,this)}});return ox.ui.apps=new l,ox.ui.apps}),define("io.ox/core/yell",["gettext!io.ox/core"],function(e){function t(e,t){var i,o,n=t;this.pause=function(){window.clearTimeout(i),n-=new Date-o},this.resume=function(){o=new Date,window.clearTimeout(i),i=window.setTimeout(e,n)},this.clear=function(){window.clearTimeout(i)},this.resume()}function i(){p&&p.clear(),$(".io-ox-alert").trigger("notification:removed").remove(),$("body").off(".yell")}function o(e){var t=$(".io-ox-alert");if(0!==t.length){if(_.device("smartphone"))return i();if("keydown"!==e.type)return $.contains(t.get(0),e.target)?$(e.target).closest(".close").length?i():void 0:i();if(($(e.target).closest(".close").length||27===e.which)&&(13===e.which||32===e.which||27===e.which))return i()}}function n(){p&&p.pause()}function a(){p&&p.resume()}function r(e){var t=$("#sr-alert-text").removeAttr("role").attr("role","alert"),i=$.txt(e);t.contents().filter(function(){return 3===this.nodeType}).remove(),$("#io-ox-alert-screenreader").css("clip","auto"),t.append(i).hide().css("display","inline")}function s(s,f,h){if("destroy"===s||"close"===s)return i();var g={duration:0,focus:!1,type:"info",closeOnClick:!0},m=!1,v={warnings:[]};if(_.isObject(s))if("error"in s)if("CONFLICT"!==s.categories||"FILE_STORAGE-0045"!==s.code&&"FLD-1038"!==s.code){if(!0===s.handled)return;g.type="error",g.message=s.message||s.error,g.headline=e("Error")}else m=!0,g.type="error",v.title||(v.title=s.error),v.warnings.push(s.warnings.error);else g=_.extend(g,s);else g.type=s||"info",g.message=f,g.focus=h;if(l.test(g.type)){var x=[];if("screenreader"===g.type)return r(g.message);if(!m){if(!g.message)return;p&&p.clear(),p=-1===g.duration?null:new t(i,g.duration||d[g.type]||5e3),x=$(".io-ox-alert"),$("body").off(".yell"),g.closeOnClick&&_.defer(function(){$("body").on(_.device("touch")?"tap.yell":"mousedown.yell keydown.yell",o)});var b,w,y,k=$('<div tabindex="-1" class="io-ox-alert">').addClass("io-ox-alert-"+g.type);return g.message instanceof $?y=(b=g.message).text():(b=$.parseHTML(_.escape(g.message).replace(/\n/g,"<br>")),y=g.message),w=y.indexOf("http")>=0?"break-all":"normal",x.length&&(k.addClass("appear"),x.trigger("notification:removed"),x.remove()),k.append($('<div class="icon">').append($('<i aria-hidden="true">').addClass(u[g.type]||"fa fa-fw"))).mouseover(n).mouseout(a),_.defer(function(){k.append($('<div role="alert" aria-live="polite" class="message user-select-text">').append(c[g.type]&&g.headline&&g.type!==g.headline.toLowerCase()?$('<span class="sr-only">').text(e(c[g.type])):[],g.headline?$('<h2 class="headline">').text(g.headline):[],$("<div>").css("word-break",w).append(b)))}),g.closeOnClick&&k.append($('<button type="button" class="btn btn-link close">').attr("title",e("Close this notification")).append($('<i class="fa fa-times" aria-hidden="true">'))),$(document.body).hasClass("modal-open")||$(".wizard-container").length>0?$(document.body).append(k):$("#io-ox-core").append(k),setTimeout(function(){k.trigger("notification:appear").addClass("appear"),g.focus&&k.attr("tabindex",0).focus()},_.device("touch")?300:2),k}require(["io.ox/core/tk/filestorageUtil"],function(e){e.displayConflicts(v)})}}var l=/^(busy|error|info|success|warning|screenreader)$/,d={busy:1e4,error:3e4,info:1e4,success:4e3,warning:1e4,screenreader:5e3},c={error:"Error",info:"Info",success:"Success",warning:"Warning"},u={busy:"fa fa-refresh fa-spin",error:"fa fa-exclamation",info:"fa fa-exclamation",success:"fa fa-check",warning:"fa fa-exclamation"},p=null;return s.done=function(){s("success",e("Done"))},s.close=function(){s("close")},s}),define("io.ox/core/notifications",["io.ox/core/extensions","io.ox/backbone/mini-views/dropdown","io.ox/core/yell","io.ox/core/desktopNotifications","io.ox/core/capabilities","settings!io.ox/core","gettext!io.ox/core","io.ox/core/a11y"],function(e,t,i,o,n,a,r,s){var l=Backbone.Model.extend({defaults:{subviews:{},sidepopup:null,markedForRedraw:{},count:0}});return new(Backbone.View.extend({tagName:"a",className:"dropdown-toggle",initialize:function(){var e=this;this.$el.attr("role","menu"),this.$el.attr({"data-toggle":"dropdown",href:"#"}).append($('<span class="badge" aria-hidden="true">').append($('<span class="number">'))),this.listNode=$('<ul href="#" id="io-ox-notifications-display" class="dropdown-menu dropdown-menu-right">').on("focus","*",this.focusHover.bind(this)).on("keydown",this.onKeydown.bind(this)).on("click blur focusout",this.keepOpen),this.dropdown=new t({tagName:"li",attributes:{role:"presentation"},id:"io-ox-notifications-icon",className:"launcher dropdown notifications-icon",$ul:this.listNode,$toggle:this.$el,smart:!1,dontProcessOnMobile:!0}),this.dropdown.$el.on("hidden.bs.dropdown",function(){e.closeSidepopup(),0===e.model.get("count")&&$("#io-ox-launcher .launcher-btn").focus()}),this.sidepopupNode=$('<div id="io-ox-notifications-sidepopup">'),this.delayedRender=_.debounce(this.render,100),this.model.on("change:count",_(this.onChangeCount).bind(this)),this.onChangeCount()},keepOpen:function(e){e.preventDefault(),e.stopPropagation()},registerSubview:function(e){var t=this.model.get("subviews"),i=this;return t[e.model.get("id")]||(t[e.model.get("id")]=e,this.model.get("markedForRedraw")[e.model.get("id")]=!0,e.collection.on("add reset remove",function(e){e.subviewId||(e=e.collection),i.model.set("count",_(t).reduce(function(e,t){return e+t.collection.length},0)),i.model.get("markedForRedraw")[e.subviewId]=!0,i.delayedRender()}),e.on("responsive-remove",function(){var e=_(t).reduce(function(e,t){return e+t.collection.length},0),o=Math.min(e,99),n=parseInt(i.$el.find(".number").text(),10);if(i.model.set("count",e),o!==n)return 0===e?i.render():void i.$el.attr("title",r.format(r.ngettext("%1$d notification.","%1$d notifications.",e),e)).find(".number").text(o+(e>100?"+":""))}),e.on("autoopen",_.bind(function(){i.render(),i.dropdown.open()},i)),i.delayedRender()),e},render:function(){var e=this,t=this.model.get("subviews"),i=Math.min(this.model.get("count"),99),o=this.model.get("markedForRedraw");return this.$el.attr("title",r.format(r.ngettext("%1$d notification.","%1$d notifications.",this.model.get("count")),this.model.get("count"))).find(".number").text(i+(this.model.get("count")>100?"+":"")),this.model.set("markedForRedraw",{}),e.listNode.find(".no-news-message,.notification-area-header,.desktop-notification-info").remove(),_(o).each(function(i,o){i&&t[o].render(e.listNode)}),e.listNode.css({"max-height":_.device("smartphone")?"none":$("#io-ox-screens").height()-5}),0===this.listNode.children(".notifications").length?this.listNode.prepend($("<div class=notification-area-header>").append($('<h1 class="section-title no-news-message">').text(r("No notifications")),$('<button type="button" class="btn btn-link clear-area-button fa fa-times">').attr("aria-label",r("Close notification area")).on("click",_(e.dropdown.close).bind(e.dropdown)))):this.listNode.prepend($("<div class=notification-area-header>").append($('<h1 class="notification-area-title">').text(r("Notifications")),$('<button type="button" class="btn btn-link clear-area-button fa fa-times">').attr("aria-label",r("Close notification area")).on("click",_(e.dropdown.close).bind(e.dropdown)),$('<button type="button" class="btn btn-link hide-area-button">').text(r("Notify me again later")).on("click",_(e.hideAll).bind(e)))),this.drawNotificationInfo(),this},onChangeCount:function(){this.$el.toggle(0!==this.model.get("count")),0===this.model.get("count")&&this.dropdown.close()},drawNotificationInfo:function(){if("default"===o.getPermissionStatus()&&!1!==a.get("showDesktopNotifications",!0)&&!this.handledNotificationInfo){var e=this,t=$("<div>").text(r("Would you like to enable desktop notifications?")),i=$('<button type="button" class="later-button btn btn-warning">').text(r("Later")).on("click",function(e){e.stopPropagation(),l()}),n=$('<button type="button" class="disable-button btn btn-danger">').text(r("Never")).on("click",function(e){a.set("showDesktopNotifications",!1).save(),e.stopPropagation(),l()}),s=$('<button type="button" class="enable-button btn btn-success">').text(r("Decide now")).on("click",function(e){e.stopPropagation(),o.requestPermission(function(e){"granted"===e?a.set("showDesktopNotifications",!0).save():"denied"===e&&a.set("showDesktopNotifications",!1).save()}),l()}),l=function(){t.text(r("You can manage desktop notifications at any time, by visiting your settings")).on("click",function(){var e={id:"io.ox/core"};ox.launch("io.ox/settings/main",e).done(function(){this.setSettingsPane(e)})}),d.addClass("clickable"),i.remove(),s.remove(),n.remove(),e.dropdown.$el.one("hidden.bs.dropdown",function(){d.remove()})},d=$('<div class="desktop-notification-info clearfix">').append(t,$('<div class="button-wrapper">').append(s,n,i));this.listNode.prepend(d)}},openSidepopup:function(e,t,i,o){var n=this,a=function(){require(["io.ox/core/tk/dialogs"],function(a){n.sidepopupNode.attr("data-cid",e).appendTo(_.device("smartphone")?"body":"#io-ox-windowmanager-pane"),n.dropdown.forceOpen(!0);var r=$.Event("click",{target:n.sidepopupNode.empty()}),s=new a.SidePopup({arrow:!1,side:"left",focus:!1}).setTarget(n.sidepopupNode.empty()).show(r,function(e){var n=e.closest(".io-ox-sidepopup");_.device("smartphone")||n.css({right:"585px"}),n.addClass("io-ox-notifications-sidepopup first");var a=function(i){if(i=i&&i.get?i.attributes:i,t.View){var n=new t.View({data:i},o);e.idle().append(n.render().expand().$el.addClass("no-padding"))}else e.idle().append(t.draw({data:i},o).addClass("no-padding"));return i};i.then?(e.busy(),i.then(a)):a(i)});n.model.set("sidepopup",s),s.on("close",$.proxy(n.onCloseSidepopup,n))})};n.model.get("sidepopup")&&n.sidepopupIsClosing?n.model.get("sidepopup").one("close",a):a()},onKeydown:function(e){var t=[],i=null;switch(e.which){case 37:case 38:t=this.listNode.find(".item"),i=$(e.target).closest(".item",this.listNode);var o=t.length-1;i.length&&(o=(_(t).indexOf(i[0])-1+t.length)%t.length),t[o].focus();break;case 39:case 40:t=this.listNode.find(".item");var n=0;(i=$(e.target).closest(".item",this.listNode)).length&&(n=(_(t).indexOf(i[0])+1)%t.length),t[n].focus();break;case 9:t=s.getTabbable(this.listNode),e.shiftKey&&t[0]===e.target&&(e.preventDefault(),t[t.length-1].focus()),!e.shiftKey&&t.length&&t[t.length-1]===e.target&&(e.preventDefault(),t[0].focus())}t=null},focusHover:function(e){this.listNode.find(".item").removeClass("has-focus"),$(e.target).closest(".item",this.listNode).addClass("has-focus")},onCloseSidepopup:function(){this.dropdown.forceOpen(!1),this.sidepopupIsClosing=!1,this.listNode.find(".item:visible")&&(this.listNode.find(".item.has-focus")?this.listNode.find(".item.has-focus").focus():this.sidepopupNode.attr("data-cid")&&this.listNode.find('.item:visible[data-cid="'+this.sidepopupNode.attr("data-cid")+'"]')?this.listNode.find('.item[data-cid="'+this.sidepopupNode.attr("data-cid")+'"]').focus():this.listNode.find(".item").first().focus());var e=this,t=this.model.get("sidepopup");t&&(t.off("close"),e.sidepopupNode.attr("data-cid",null).detach()),this.model.set("sidepopup",null)},hideAll:function(){_(this.model.get("subviews")).each(function(e){e.hideAll(a.get("notificationsHidingTimer",18e5))})},closeSidepopup:function(){this.model.get("sidepopup")&&(this.sidepopupIsClosing=!0,this.model.get("sidepopup").close())},attach:function(t,i){var o=this;return this.drawNotificationInfo(),setTimeout(function(){ox.manifests.loadPluginsFor("io.ox/core/notifications").done(function(){e.point("io.ox/core/notifications/register").invoke("register",o,o)}),o.listNode.css({top:o.listNode.css("top")+$("#io-ox-appcontrol")[0].offsetTop,left:o.listNode.css("left")+window.outerWidth-$("#io-ox-appcontrol").outerWidth()})},i||5e3),this.render(),this.dropdown.render().$el},yell:i}))({model:new l})}),define("io.ox/core/commons",["io.ox/core/extensions","gettext!io.ox/core","io.ox/core/folder/api","io.ox/core/api/account","io.ox/backbone/mini-views/helplink","settings!io.ox/core","settings!io.ox/contacts","io.ox/backbone/mini-views/upsell","io.ox/backbone/views/actions/util","io.ox/core/capabilities"],function(e,t,i,o,n,a,r,s,l,d){var c={showWindow:function(e){return function(){var t=$.Deferred();return e.show(t.resolve),t}},simpleMultiSelection:function(e,i,o){var n=i.length;n<=1||e.idle().empty().append($('<div class="io-ox-center multi-selection-message">').append($('<div class="message" id="'+o.multiselectId+'">').append(t.format(t.ngettext("%1$s item selected","%1$s items selected",n),$('<span class="number">').text(n).prop("outerHTML")))))},wireGridAndSelectionChange:function(e,i,o,n,a){var r,s="";e.selection.on("change",function(i,a){var l=a.length,d=JSON.stringify(_([].concat(a)).map(function(e){return{folder_id:String(e.folder_id||e.folder),id:String(e.id),recurrence_position:String(e.recurrence_position||0)}}));if(d!==s){if(1===l)n.css("height",""),o(a[0]);else if(l>1)o.cancel&&o.cancel(),n.css("height","100%"),c.simpleMultiSelection(n,this.unique(this.unfold()),e);else if(o.cancel&&o.cancel(),n.css("height","100%").idle().empty().append($('<div class="io-ox-center">').append($('<div class="io-ox-multi-selection">').append($('<div class="summary empty">').text(t("No elements selected"))))),_.device("smartphone")){var u=n.closest(".vsplit");u.hasClass("vsplit-reverse")||u.find(".rightside-navbar a>i").last().trigger("click")}!function(){var e=n.parent();l<=1&&r?e.attr("aria-label",_.escape(r)):l>1&&(r=r||e.attr("aria-label"),e.attr("aria-label",t("Selection Details")))}(),s=d}}),a&&a.on("change:id",function(t,i,o){var n=e.selection.get();n.length&&n[0].id===o&&e.selection.set({id:i.id,folder_id:i.folder_id})})},wireGridAndAPI:function(e,t,i,o){e.setAllRequest(function(){return t[i||"getAll"]({folder:this.prop("folder")})}),e.setListRequest(function(e){return t[o||"getList"](e)}),t.on("beforedelete",function(t,i){e.selection.removeFromIndex(i);var o,n=e.selection.get();n.length>0&&(_.device("smartphone")?e.selection.clear(!0):(o=e.selection.getIndex(n[0]),e.selection.clear(!0).selectIndex(o+1),e.getIds().length===n.length&&e.selection.trigger("change",[])))})},wireGridAndWindow:function(e,t){var i=0,o=function(){e.keyboard(!0),e.selection.get().length&&e.selection.retriggerUnlessEmpty()};e.setApp(t.app),t.on("show idle",o).on("hide busy",function(){e.keyboard(!1)}).on("beforeshow",function(){null!==i&&e.scrollTop(i)}).on("beforehide",function(){i=e.scrollTop()}),t.app&&(t.app.getGrid=function(){return e}),t.state.visible&&o()},addGridToolbarFolder:function(o,n){function a(){return o.getWindow&&o.getWindow().state.visible?n.getToolbar().find(".grid-info"):$()}function s(e){e&&(a().empty().attr("data-folder-id",e).append($('<span class="folder-name">'),$.txt(" "),$('<span class="folder-count">')),i.get(e).done(function(t){var o=!i.supports("count_total",t)?n.getIds().length:t.total,a=n.getToolbar().find('[data-folder-id="'+e+'"]');i.is("contacts",t)&&"6"===t.id&&!r.get("showAdmin",!1)&&(o-=1),n.meta={total:o,title:t.title},n.trigger("meta:update"),a.find(".folder-name").text(t.title),o>0&&a.find(".folder-count").text("("+o+")")}))}function l(){var e=n.prop("folder"),i=n.getMode();if("all"===i)s(e);else if("search"===i){var o=a();o.find(".folder-name").text(t("Results")),o.find(".folder-count").text("("+n.getIds().length+")")}}e.point(o.get("name")+"/vgrid/toolbar").extend({id:"info",index:200,draw:function(){this.append($('<div class="grid-info">'))}}),n.on("change:prop:folder change:mode change:ids",l),i.on("after:rename",l),i.on("update:total",function(e){e===o.folder.get()&&s(e)}),e.point(o.get("name")+"/vgrid/toolbar").invoke("draw",n.getToolbar()),$.when(o.folder.initialized,o.getWindow().shown).done(function(e){s(e[0])})},wireFirstRefresh:function(e,t){!1!==ox.serverConfig.persistence&&e.getWindow().on("open",function(){t.needsRefresh(e.folder.get())&&t.trigger("refresh^",e.folder.get())})},wireGridAndRefresh:function(e,t,i){var o=function(){e.refresh(!0),_.device("smartphone")&&e.selection.retrigger()},n=function(){e.repaint(),e.selection.retrigger()},a=function(){e.pending()},r=function(){t.off("refresh.all refresh:all:local",o).off("refresh.pending",a).off("refresh.list",n)},s=function(){r(),t.on("refresh.all refresh:all:local",o).on("refresh.pending",a).on("refresh.list",n).trigger("refresh.all")};i.on({show:s,hide:r}),i.state.visible&&s()},wirePerspectiveEvents:function(e){var t=e.getWindow(),i=null;t.on("show",function(){i=t.currentPerspective,t.currentPerspective&&e.trigger("perspective:"+t.currentPerspective+":show")}),t.on("hide",function(){i=t.currentPerspective,t.currentPerspective&&e.trigger("perspective:"+t.currentPerspective+":hide")}),t.on("change:perspective",function(t,o){i&&e.trigger("perspective:"+i+":hide"),i=o,e.trigger("perspective:"+o+":show")}),t.on("change:initialPerspective",function(t,o){i=o,e.trigger("perspective:"+o+":show")})},addFolderSupport:function(e,t,i,n){function a(t){return e.folder.set(t).then(_.identity,function(){return $.when(e.folder.setDefault())})}return e.folder.updateTitle(e.getWindow()).setType(i),t&&e.folder.updateGrid(t),e.getWindow().on("show",function(){t&&t.selection.retriggerUnlessEmpty(),_.url.hash("folder",e.folder.get())}),void 0!==(n=_.url.hash("folder")||n)?a(n):"mail"===i?o.getUnifiedInbox().then(function(t){return null===t?e.folder.setDefault():a(t)}):e.folder.setDefault()},addPropertyCaching:function(e,t){function i(e,t){var i;e===a.keyprop&&void 0!==t&&t!==n(a.keyprop)&&(i=n(a.keyprop))&&(s.remove(i),_.each(a.props,function(e){s.set(i,e,n(e))}))}var o={},n=(e=e||{prop:$.noop()}).prop,a=$.extend({keyprop:"folder",props:["sort","order"]},t||{}),r={},s={set:function(e,t,i){r[e]=r[e]||{},r[e][t]=i},get:function(e,t){return t?(r[e]||{})[t]:r[e]||{}},remove:function(e){r[e]={}},clear:function(){r={}}};a.props=[].concat(a.props),_.each(a.props,function(e){o[e]=!0}),_.isUndefined(e.propcache)&&(e.propcache=function(e,t,i){return i=i||n(a.keyprop),o[e]?s.get(i,e)||t:t},e.prop=function(t,o){return i(t,o),n.call(e,t,o)})},addGridFolderSupport:function(e,t){e.folder.updateGrid(t),e.getWindow().on("show",function(){t.selection.retriggerUnlessEmpty()})},vsplit:function(){var e=!1,i=function(t){t.preventDefault(),e&&(e=!1),$(this).parent().find(".rightside-inline-actions").empty(),$(this).closest(".vsplit").addClass("vsplit-reverse").removeClass("vsplit-slide"),t.data.app&&t.data.app.getGrid&&(_.device("smartphone")&&t.data.app.getGrid().selection.trigger("changeMobile"),t.data.app.getGrid().selection.clear()),_.device("smartphone")&&$(this).closest(".vsplit").find(".leftside .tree-container").trigger("changeMobile")},o=function(){var t=$(this);e=!0,setTimeout(function(){e&&(t.closest(".vsplit").addClass("vsplit-slide").removeClass("vsplit-reverse"),e=!1)},100)};return function(e,n){var a={};return e.addClass("vsplit").append(a.left=$('<div class="leftside">').attr({role:"complementary","aria-label":t("Item list")}).on("select",o),$('<div class="rightside-navbar">').append($('<div class="rightside-inline-actions">'),$('<a href="#" tabindex="-1">').append($('<i class="fa fa-chevron-left" aria-hidden="true">'),$.txt(" "),$.txt(t("Back"))).on("click",{app:n},i)),a.right=$('<div class="rightside">')),a}}(),help:function(e){if(!_.device("smartphone")){var t=new n({href:function(e){return"io.ox/mail"===e?"ox.appsuite.user.sect.email.gui.foldertree.html":"io.ox/files"===e?"ox.appsuite.user.sect.drive.gui.foldertree.html":"io.ox/contacts"===e?"ox.appsuite.user.sect.contacts.gui.foldertree.html":"io.ox/calendar"===e?"ox.appsuite.user.sect.calendar.gui.foldertree.html":"io.ox/tasks"===e?"ox.appsuite.user.sect.tasks.gui.foldertree.html":"ox.appsuite.user.sect.dataorganisation.folder.html"}(e&&e.app&&e.app.id)});this.find(".generic-toolbar.bottom").append(t.render().$el)}},mediateFolderView:function(i){function o(e){if(e.data.app.folderView.toggle(e.data.state),e.data.state)e.data.app.folderView.tree.getNodeView(e.data.app.folder.get()).$el.focus();else{var t=e.data.app.grid;if(0===t.getIds().length)return t.getContainer().focus();t.selection.focus()}}function n(e){e.getWindow().nodes.sidepanel.show(),e.getWindow().nodes.main.find(".vgrid").removeClass("bottom-toolbar")}function a(e){e.getWindow().nodes.sidepanel.hide(),e.getWindow().nodes.main.find(".vgrid").addClass("bottom-toolbar")}e.point(i.get("name")+"/vgrid/second-toolbar").extend({id:"default",index:100,draw:function(){this.addClass("visual-focus").append($('<button type="button" class="btn btn-link toolbar-item" data-action="open-folder-view">').attr("aria-label",t("Open folder view")).append($('<i class="fa fa-angle-double-right" aria-hidden="true">').attr("title",t("Open folder view"))).on("click",{app:i,state:!0},o))}}),e.point(i.get("name")+"/sidepanel").extend({id:"toggle-folderview",index:1e3,draw:function(){var e=_.uniqueId("control");this.addClass("bottom-toolbar").append($('<div class="generic-toolbar bottom visual-focus" role="region">').attr("aria-labelledby",e).append($('<button type="button" class="btn btn-link toolbar-item" data-action="close-folder-view">').attr({id:e,"aria-label":t("Close folder view")}).append($('<i class="fa fa-angle-double-left" aria-hidden="true">').attr("title",t("Close folder view"))).on("click",{app:i,state:!1},o)))}}),e.point(i.get("name")+"/sidepanel").extend({id:"help",index:1100,draw:c.help}),i.on({"folderview:open":n.bind(null,i),"folderview:close":a.bind(null,i)});var r=i.getGrid(),s=r.getTopbar();e.point(i.get("name")+"/vgrid/second-toolbar").invoke("draw",s,e.Baton({grid:r})),a(i),i.folderViewIsVisible()&&_.defer(n,i)},addFolderViewToggle:function(i){_.device("smartphone")||(i.toggleFolderView=function(e){e.preventDefault(),i.trigger("before:change:folderview"),i.folderView.toggle(e.data.state),e.data.state?i.folderView.tree.getNodeView(i.folder.get()).$el.focus():require("io.ox/core/a11y").getTabbable(i.getWindow().nodes.body.find(".classic-toolbar"))[0].focus()},e.point(i.get("name")+"/sidepanel").extend({id:"toggle-folderview",index:1e3,draw:function(){if(!_.device("smartphone")){var e=_.uniqueId("control");this.addClass("bottom-toolbar").append($('<div class="generic-toolbar bottom visual-focus" role="region">').attr("aria-labelledby",e).append($('<button type="button" class="btn btn-link toolbar-item" data-action="close-folder-view">').attr({id:e,"aria-label":t("Close folder view")}).append($('<i class="fa fa-angle-double-left" aria-hidden="true">').attr("title",t("Close folder view"))).on("click",{state:!1},i.toggleFolderView)))}}}),e.point(i.get("name")+"/sidepanel").extend({id:"help",index:1100,draw:c.help}))},addPremiumFeatures:function(i,o){if(!_.device("smartphone")&&d.has("client-onboarding")&&a.get("upsell/premium/folderView/visible")&&!a.get("upsell/premium/folderView/closedByUser")){var n=$('<div class="premium-toolbar generic-toolbar bottom visual-focus in">').append($('<div class="header">').append(t("Premium features"),$('<a href="#" role="button" class="pull-right">').append($('<i class="fa fa-times" aria-hidden="true">'),$('<span class="sr-only">').text(t("Close premium features"))).on("click",function(e){e.preventDefault(),$(this).closest(".premium-toolbar").collapse("hide"),a.set("upsell/premium/folderView/closedByUser",!0).save()}))),r=l.getBaton([],{app:i,renderActions:function(t,i){return e.point(t).list().map(function(e){return $("<p>").append($('<a href="#" role="button">').attr("data-action",e.action).data({baton:i}).text(e.title))})}});if(e.point(i.get("name")+"/folderview/premium-area").invoke("draw",n,r),0!==n.find("a[data-action]").length){n.on("click","a[data-action]",l.invokeByEvent);var c=new s({id:o.upsellId||"folderview/"+i.get("name")+"/bottom",requires:o.upsellRequires,icon:"",title:t("Try now!"),customize:function(){this.$("a").addClass("btn btn-default")}});return c.visible&&(n.append(c.render().$el),$(".header a",n).remove()),!1!==o.append&&i.getWindow().nodes.sidepanel.append(n),n}}}},u=$.cleanData,p=function(e){$(e).triggerHandler("dispose")};return $.cleanData=function(e){return _(e).map(p),u.call(this,e)},$.createViewContainer=function(t,o,n,a){var r=(a=a||{}).cidGetter||_.ecid,s=t instanceof e.Baton?t.data:t,l=_.cid(s),d=r(s),c="recurrenceID"in s?r({id:s.id,folder:s.folder_id||s.folder}):null,u=$("<div>").attr("data-cid",_([].concat(s)).map(_.cid).join(",")),p=function(i,a){a&&(a.former_id||a.id&&a.id!==s.id)&&(s=a),(n=n||(o?o.get:null))&&(s.id||(s.id=arguments[1].id),n(o.reduce(s)).done(function(i){t instanceof e.Baton?i instanceof Backbone.Model&&t.model instanceof Backbone.Model?(t.model=i,t.data=i.toJSON()):t.data=i:t=i,a&&a.updateData?t.updateData=a.updateData:delete t.updateData,u&&u.triggerHandler("redraw",t)}))},f=function(e,t){s&&(s.folder_id=t),p&&p()},h=_.debounce(function(){u&&u.triggerHandler("redraw",t)},10),g=function(){u&&u.trigger("view:remove").remove()},m=function(e){var t=this;e===t.folder.toString()&&o&&o.trigger("update:"+t.cid)};return _.isArray(s)?(i.on("update",h),o.on("delete update",h)):(i.on("update",m,{cid:l,folder:s.folder_id||s.folder}),o.on("delete:"+d+(c?" delete:"+c:""),g),o.on("create update:"+d+(c?" update:"+c:""),p),o.on("move:"+d,f)),u.one("dispose",function(){_.isArray(s)?(i.off("update",h),o.off("delete update",h)):(i.off("update",m),o.off("delete:"+d,g),o.off("create update:"+d+(c?" update:"+c:""),p),o.off("move:"+d,f)),o=p=s=u=n=l=d=null})},$.fail=function(e,i){var o=$("<div>").addClass("io-ox-fail").append($("<span>").text(e));return i&&o.append($("<span>").text(" ")).append($("<a>",{href:"#"}).text(t("Retry")).on("click",function(e){e.preventDefault(),$(this).closest(".io-ox-center").remove(),i.apply(this,arguments)})),o.center()},c}),define("io.ox/core/upsell",["io.ox/core/capabilities","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i){function o(e){console.debug("upsell:requires-upgrade",e),require(["io.ox/backbone/views/modal"],function(t){new t({title:i("Upgrade required"),description:i("This feature is not available. In order to use it, you need to upgrade your account now.")+" "+i("The first 90 days are free.")}).addCancelButton().addButton({label:i("Get free upgrade"),action:"upgrade"}).on("upgrade",function(){ox.trigger("upsell:upgrade",e)}).on("open",function(){ox.off("upsell:requires-upgrade",o),this.$el.next(".modal-backdrop.in:visible").css({opacity:.7,backgroundColor:"#08C"})}).on("close",function(){ox.on("upsell:requires-upgrade",o)}).open()})}function n(e){console.debug("upsell:upgrade",e),alert("User decided to upgrade! (global event: upsell:upgrade)")}var a=t.get("upsell/enabled")||{},r={},s={},l={trigger:function(e){ox.trigger("upsell:requires-upgrade",e||{})},click:function(e){e.preventDefault(),l.trigger()},any:function(e){return!e||_([].concat(e)).reduce(function(e,t){return e||void 0===t||l.has(t)},!1)},missing:function(e){return e?(e=[].concat(e).join(" "),_(e.match(/!?[a-z_:-]+/gi)).filter(function(e){return!l.has(e)}).join(" ")):""},has:function(t){return!t||(t in r?r[t]:r[t]=e.has(t))},visible:function(){function e(e){return!!_.isString(e)&&!!a[e]}function t(t){var i=t.replace(/([^&|]) ([^&|])/gi,"$1 && $2");return ox.debug&&/,/.test(i)?!!console.error("You can't use a comma in a condition use space instead."):(i=i.replace(/[\w:-]+/gi,function(t){return t=t.toLowerCase(),e(t)||l.has(t)}),new Function("return !!("+i+")")())}return function(e){var i=_.compact([].concat(e));return!i.length||_.reduce(i,function(e,i){return e||t(i)},!1)}}(),enabled:function(){function e(e){return!!_.isString(e)&&!!a[e]}return function(){var t=_(arguments).flatten().join(" || ").replace(/([^&|]) ([^&|])/gi,"$1 && $2");return ox.debug&&/,/.test(t)?!!console.error("You can't use a comma in a condition use space instead."):(t=t.replace(/[a-z0-9_:-]+/gi,function(t){return t=t.toLowerCase(),e(t)}),new Function("return !!("+t+")")())}}(),captureRequiresUpgrade:function(){ox.on("upsell:requires-upgrade",o),l.captureRequiresUpgrade=$.noop},captureUpgrade:function(){ox.on("upsell:upgrade",n),l.captureUpgrade=$.noop},useDefaults:function(){l.captureRequiresUpgrade(),l.captureUpgrade()},debug:function(){console.debug("enabled",a,"capabilityCache",r,"enabledCache",s)},demo:function(e){var i=a,o=r;i.portal=i.webmail=i.contacts=i.calendar=i.infostore=i.tasks=i.publication=i.subscription=i.carddav=i.active_sync=!0,o.portal=o.webmail=o.contacts=!0,o.calendar=o.infostore=o.tasks=o.active_sync=o["active_sync || caldav || carddav"]=!1,o.publication=o.subscription=!1,t.set("features/upsell/secondary-launcher",{icon:"fa-star fa-star fa-star",color:"#ff0"}),t.set("features/upsell/portal-widget",{imageURL:"http://lorempixel.com/400/300/"}),t.set("features/upsell/folderview/mail/i18n/en_US",{title:"Custom english title for synchronizing mails."}),t.set("features/upsell/topbar-dropdown",{color:"#df0000"}),t.set("features/upsell/mail-folderview-quota",{upsellLimit:10485760}),console.debug("Disabled inline actions regarding calendar, tasks, and files; enabled upsell instead"),e||l.useDefaults()},setEnabled:function(e){a[e]=!0}};return(_.url.hash("demo")||"").indexOf("upsell")>-1&&l.demo(),l}),define("io.ox/core/ping",["io.ox/core/http","settings!io.ox/core"],function(e,t){function i(){!ox.session||"unset"===ox.session||!ox.online||_.device("phantomjs || karma")||_.now()-ox.t0<1e4||e.ping()}function o(){l&&clearInterval(l)}function n(){"normal"!==s&&(o(),s="normal",ox.reachable=!0,ox.trigger("reachableChange"),a&&(i(),l=setInterval(i,1e3*r)))}var a=t.get("ping/enabled",!1),r=t.get("ping/interval",30),s="none",l=null;e.on("unreachable",function(){"hectic"!==s&&(o(),ox.reachable=!1,ox.trigger("reachableChange"),s="hectic",i(),l=setInterval(i,200*r))}),e.on("reachable",n),n()}),define("io.ox/core/relogin",["io.ox/core/extensions","io.ox/core/session","io.ox/core/notifications","io.ox/core/capabilities","io.ox/core/boot/util","io.ox/backbone/views/modal","gettext!io.ox/core","settings!io.ox/core"],function(e,t,i,o,n,a,r,s){function l(e){return r(e&&"SES-0205"===e.code?"Your IP address has changed":"Your session is expired")}function d(){var e=o.has("guest")?s.get("customLocations/guestLogin")||ox.serverConfig.guestLoginLocation:s.get("customLocations/login")||ox.serverConfig.loginLocation;return _.url.vars(e||ox.loginLocation||"")}function c(){var e=o.has("guest")?s.get("customLocations/guestLogout")||ox.serverConfig.guestLogoutLocation:s.get("customLocations/logout")||ox.serverConfig.logoutLocation;return _.url.vars(e||ox.logoutLocation||"")}function u(){_.url.redirect(d())}function p(){_.url.redirect(c())}function f(e){var t=$.Deferred();return new a({async:!0,enter:"relogin",backdrop:"static",focus:"input",title:l(e),point:"io.ox/core/relogin"}).build(function(){this.$el.addClass("relogin")}).on("open",function(){$("html").addClass("relogin-required"),$("#io-ox-core").addClass("blur")}).on("relogin:continue",function(){t.resolve({reason:"relogin:continue"})}).on("relogin:success",function(){t.resolve({reason:"relogin:success"})}).open(),t.done(function(){$("html").removeClass("relogin-required"),$("#io-ox-core").removeClass("blur")})}function h(t,i,o){if(ox.online)if(m)t&&i&&g.push({request:t,deferred:i});else{g=t&&i?[{request:t,deferred:i}]:[],m=!0;var n=require("io.ox/core/extPatterns/stage"),a=e.Baton.ensure({error:o,reloginState:"pending"});n.run("io.ox/core/boot/login",a,{methodName:"relogin"}).then(function(){if("success"===a.data.reloginState){for(var e,t=0,i=require("io.ox/core/http");e=g[t];t++)e.request.noRetry||i.retry(e.request).done(e.deferred.resolve).fail(e.deferred.fail);m=!1}})}}e.point("io.ox/core/relogin").extend({id:"default",render:function(){this.$body.append($("<div>").text(r("You have to sign in again"))),this.addButton({action:"ok",label:r("Ok")}),this.on("ok",function(){this.trigger("relogin:continue")})}},{id:"password",index:100,render:function(e){if(s.get("features/reloginPopup",!ox.serverConfig.oidcLogin&&!ox.serverConfig.samlLogin)&&!o.has("guest && anonymous")){var n=_.uniqueId("form-control-label-");this.$header.append($("<div>").text(r("Please sign in again to continue"))),this.$body.append($("<label>").attr("for",n).text(r("Password")),$('<input type="password" name="relogin-password" class="form-control">').attr("id",n)),this.addButton({className:"btn-default",label:r("Cancel"),placement:"left",action:"cancel"}).addButton({action:"relogin",label:r("Sign in")}).on("cancel",function(){ox.trigger("relogin:cancel"),p()}).on("relogin",function(){var e=this.busy();t.login({name:ox.user,password:this.$body.find("input").val(),rampup:!1,staySignedIn:ox.secretCookie}).then(function(){i.yell("close"),e.$body.find("input").val(""),e.trigger("relogin:success"),e.close()},function(t){"LGI-0006"===t.code&&(t.error=r("Please enter correct password")),i.yell({headline:r("Failed to sign in"),type:"error",message:t.error}),e.idle(),e.$body.find("input").focus().select(),e.trigger("relogin:fail",t)})}),e.preventDefault()}}}),e.point("io.ox/core/boot/login").replace({id:"default",relogin:function(e){if("success"!==e.data.reloginState)return u();n.checkTabHandlingSupport()&&require(["io.ox/core/api/tab"],function(e){e.propagate("propagateLogin",{session:ox.session,language:ox.language,theme:ox.theme,user:ox.user,user_id:ox.user_id,context_id:ox.context_id,relogin:!0,exceptWindow:e.getWindowName(),storageKey:e.DEFAULT_STORAGE_KEYS.SESSION})})}}),e.point("io.ox/core/boot/login").extend({id:"userPrompt",index:5e3,relogin:function(e){return f(e.data.error).then(function(t){t&&"relogin:success"===t.reason&&(e.data.reloginState="success")})}});var g=[],m=!1;return ox.off("relogin:required",ox.relogin),ox.on("relogin:required",h),h}),define("io.ox/core/uuids",function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return{randomUUID:function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}}),define("io.ox/core/tk/wizard",["io.ox/backbone/views/disposable","io.ox/core/tk/hotspot","gettext!io.ox/core"],function(e,t,i){function o(e,t){t=t||0;var i=e.offset();return i.width=e.outerWidth()+2*t,i.height=e.outerHeight()+2*t,i.availableWidth=$(window).width(),i.availableHeight=$(window).height(),i.right=i.availableWidth-i.width-i.left+t,i.bottom=i.availableHeight-i.height-i.top+t,i.top-=t,i.left-=t,i}function n(e){return function(){var t=this.$(e);return t.append.apply(t,arguments),this}}function a(e){return function(t,i){return t.append($(e).attr("data-action",i.action).addClass(i.className).text(i.label||"਀")),this}}function r(e){return(e=$(e).filter(":visible")).length?e.first():null}function s(e){this.options=e||{},this.currentStep=0,this.steps=[],this.closed=!1,this.options.model=this.options.model||new Backbone.Model,_.extend(this,Backbone.Events),this.on({"step:next":this.next,"step:back":this.back,"step:close":this.close,"step:done":this.close}),this.on("step:hide",function(){_(d).invoke("detach"),c.detach(),t.removeAll()}),$(document).on("click.wizard",".wizard-overlay, .wizard-backdrop",function(){$(".wizard-step:visible").find("button.btn-primary:first").focus()}),this.container=u.clone(),_.device("smartphone")&&l.call(this)}function l(){this.container.find(".wizard-title").text(this.options.title||i("Welcome")),this.container.on("tap","[data-action]",{parent:this},function(e){e.preventDefault();var t=$(this).attr("data-action");e.data.parent.trigger("step:"+t)}),this.options.model.on("change:paused",function(){s.getCurrentStep().toggleNext(!s.isStepPaused())}),this.shift=function(e){this.setCurrentStep(this.currentStep+e),this.withCurrentStep(function(e){e.renderNavBar()});var t=this.container.find(".wizard-pages"),i=t.position().left/o*100,n=0-100*this.currentStep;return t.stop().velocity({translateX:[n+"%",i+"%"]},500,[150,15]),this};var e,t,o,n,a,r,s=this,l=0,d=0;this.container.find(".wizard-pages").on({touchstart:function(e){var i=e.originalEvent.targetTouches;1===i.length&&($(e.target).is("input")?r=!0:(d=i[0].pageX,t=!1,o=$(window).width(),l=$(this).position().left,a=s.hasBack()?+o:+o/3,n=s.hasNext()?-o:-o/3))},touchmove:function(i){var c=i.originalEvent.targetTouches;if(1===c.length&&!r){if(i.preventDefault(),e=c[0].pageX-d,!t){if(Math.abs(e)<20)return;return t=!0,d=c[0].pageX,void(e=0)}e=Math.min(e,a),e=Math.max(e,n),s.isStepPaused()&&(l+e)/o*100<-100||$(this).css("transform","translateX("+(l+e)/o*100+"%)")}},touchend:function(){if(r=!1,t){var i=e/o*100;s.isStepPaused()&&i<0||s.shift(i<0?i>-50?0:1:i<50?0:-1)}}})}var d=[$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay abs">'),$('<div class="wizard-overlay wizard-spotlight abs">')],c=$('<div class="wizard-backdrop abs">'),u=_.device("smartphone")?$('<div class="wizard-container abs">  <div class="wizard-navbar">    <div class="wizard-back"></div>    <div class="wizard-title"></div>    <div class="wizard-next"></div>  </div>  <div class="wizard-pages"></div>  <div class="wizard-animation"></div></div>'):$('<div class="wizard-container abs">');_.extend(s.prototype,{step:function(e){var t=new p(e,this);return this.steps.push(t),t},getCurrentStep:function(){return this.steps[this.currentStep]},withCurrentStep:function(e){var t=this.getCurrentStep();return t&&e.call(this,t),this},setCurrentStep:function(e){this.currentStep!==e&&(e<0||e>=this.steps.length||(this.currentStep=e,this.trigger("change:step")))},get:function(e){return this.steps[e]},getContainer:function(){return this.container},shift:function(e){if(this.withCurrentStep(function(e){e.hide()}),this.isInvalidShift(e))return this.trigger("skip:step"),this.shift(e<0?e-1:e+1);this.setCurrentStep(this.currentStep+e),this.withCurrentStep(function(e){e.show()})},next:function(){return this.hasNext()&&this.shift(1),this},back:function(){return this.hasBack()&&this.shift(-1),this},hasNext:function(){return this.currentStep<this.steps.length-1},hasBack:function(){return this.currentStep>0},close:function(){if(!this.closed)return this.trigger("before:stop"),this.withCurrentStep(function(e){e.hide()}),_(this.steps).each(function(e){e.dispose()}),this.container.remove().empty(),$(document).off("click.wizard"),this.steps=[],this.container=null,this.trigger("stop"),this.off(),this.closed=!0,$("body").removeClass("wizard-open"),this},isInvalidShift:function(e){var t=this.currentStep+(e||0),i=this.get(t);return!!i&&(t!==this.steps.length-1&&i.hasValue())},isStepPaused:function(){var e=this.currentStep;return(this.options.model.get("paused")||[]).indexOf(e)>-1},start:function(){return _.device("smartphone")?(this.trigger("before:start"),_(this.steps).invoke("show"),this.container.appendTo("body"),this.withCurrentStep(function(e){e.renderNavBar()}),this.trigger("start")):(this.trigger("before:start"),this.container.appendTo("body"),this.showFirst(),this.trigger("start")),$("body").addClass("wizard-open"),window.wizard=this,this},showFirst:function(){this.currentStep=0,this.shift(0)},spotlight:function(e,t){if(e){_.isFunction(e)&&(e=e());var i=$(e).filter(":visible");if(i.length){var n=o(i,t?t.padding:0);d[0].css({width:n.left,right:"auto"}),d[1].css({left:n.left,height:n.top,bottom:"auto"}),d[2].css({left:n.left+n.width,top:n.top}),d[3].css({left:n.left,top:n.top+n.height,right:n.right}),d[4].css(_(n).pick("top","right","bottom","left")),$("body").append(d)}}},toggleBackdrop:function(e,t){c.css("backgroundColor",t||""),$("body").append(c.toggle(!!e))}});var p=e.extend({className:"wizard-step center middle",events:{"click [data-action]":"onAction",keydown:"onKeyDown",keyup:"onKeyUp"},onAction:function(e){e.preventDefault();var t=$(e.currentTarget).attr("data-action");e.stopImmediatePropagation(),this.trigger(t)},onKeyDown:function(e){if(9===e.which&&this.$el.is(":visible")){var t=this.$('button[tabindex!="-1"][disabled!="disabled"]:visible'),i=e.shiftKey&&document.activeElement===t.get(0),o=!e.shiftKey&&document.activeElement===t.get(-1);(i||o)&&(e.preventDefault(),t.get(i?-1:0).focus())}},onKeyUp:function(e){function t(e){return $(e.target).is("input, textarea, select")}switch(e.which){case 27:this.$el.find(".wizard-close").length&&this.trigger("close");break;case 37:!t(e)&&this.$el.find('[data-action="back"]:enabled').length&&this.trigger("back");break;case 39:!t(e)&&this.$el.find('[data-action="next"]:enabled').length&&this.trigger("next")}},initialize:function(e,t){this.parent=t,this.options=_.extend({id:void 0,modal:!0,focusWatcher:!0,back:!0,next:!0,enableBack:!0,labelBack:i("Back"),labelDone:i.pgettext("tour","Finish"),attributes:{}},e),this.on("all",function(e){this.parent.trigger("step:"+e,this.parent.currentStep)}),_(["width","minWidth"]).each(function(e){this.options[e]&&this.$el.css(e,this.options[e])},this),_.device("smartphone")||this.once("before:show",this.renderButtons),this.$el.attr(this.options.attributes),this.render()},title:n(".wizard-title"),content:n(".wizard-content"),footer:n(".wizard-footer"),getModel:function(){return this.parent.options.model},getId:function(){return this.options.id},setValue:function(e){return this.getModel.set(this.getId(),e)},getValue:function(){return this.getModel().get(this.getId())},hasValue:function(){return void 0!==this.getValue()},render:function(){return this.$el.attr({role:"dialog",tabindex:-1,"aria-labelledby":"dialog-title"}).append($('<div role="document">').append($('<div class="wizard-header">').append($('<h1 class="wizard-title" id="dialog-title">'),$('<button type="button" class="wizard-close close" data-action="close">').attr("aria-label",i("Close")).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",i("Close")))),$('<div class="wizard-content" id="dialog-content">'),$('<div class="wizard-footer">'))),this},renderButtons:function(){var e=this.getDirections(),t=this.$(".wizard-footer").empty();e.back&&this.addButton(t,{action:"back",className:"btn-default",label:this.getLabelBack()}),e.next&&this.addButton(t,{action:"next",className:"btn-primary",label:this.getLabelNext()}),e.done&&this.addButton(t,{action:"done",className:"btn-primary",label:this.getLabelDone()})},renderNavBar:function(){var e=this.getDirections(),t=this.parent.container.find(".wizard-back").empty(),i=this.parent.container.find(".wizard-next").empty();e.back&&this.addLink(t,{action:"back",label:this.getLabelBack()}),e.next&&this.addLink(i,{action:"next",label:this.getLabelNext()}),e.done&&this.addLink(i,{action:"done",label:this.getLabelDone()}),this.parent.isStepPaused()&&this.toggleNext(!1)},addButton:a('<button type="button" class="btn">'),addLink:a('<a href="#" role="button">'),getLabelNext:function(){return void 0===this.options.labelNext?i(this.isFirst()?"Start tour":"Next"):this.options.labelNext},getLabelBack:function(){return this.options.labelBack},getLabelDone:function(){return this.options.labelDone},getDirections:function(){return{back:this.options.back&&this.parent.hasBack(),next:this.options.next&&this.parent.hasNext(),done:this.options.next&&this.isLast()}},mandatory:function(){return this.$(".wizard-header .wizard-close").remove(),this},toggleNext:function(e){return _.device("smartphone")?this.parent.container.find('[data-action="next"]').attr({disabled:!e,"aria-disabled":!e}):(this.$('.btn[data-action="next"]').prop("disabled",!e),this)},toggleBack:function(e){return this.$('.btn[data-action="back"]').prop("disabled",!e),this},isFirst:function(){return 0===this.parent.currentStep},isLast:function(){return this.parent.currentStep===this.parent.steps.length-1},indexOf:function(){return _(this.parent.steps).indexOf(this)},show:function(){function e(){this.trigger("before:navigate"),ox.launch(this.options.navigateTo.id,this.options.navigateTo.options).done(function(){this.trigger("navigate"),i.call(this,0)}.bind(this))}function i(e){if(0===e&&this.trigger("wait"),_.isFunction(this.options.waitFor.selector)&&(this.options.waitFor.selector=this.options.waitFor.selector()),r(this.options.waitFor.selector))return n.call(this);e<(_.isNumber(this.options.waitFor.timeout)?10*this.options.waitFor.timeout:50)?setTimeout(i.bind(this,e+1),100):(console.error("Step.show(). Stopped waiting for:",this.options.waitFor.selector),this.parent.close())}function o(){_(this.options.hotspot).each(function(e){_.isString(e)&&(e=[e,{}]),t.add(e[0],e[1]||{})},this)}function n(){if(this.$el.addClass("invisible").appendTo(this.parent.container),this.trigger("ready"),this.align(),$(window).on("resize.wizard-step",_.debounce(this.align.bind(this,null),100)),this.options.spotlight?(this.parent.toggleBackdrop(!1),this.parent.spotlight(this.options.spotlight.selector,this.options.spotlight.options),$(window).on("resize.wizard.spotlight",_.debounce(function(){this.parent.spotlight(this.options.spotlight.selector)}.bind(this),100))):this.parent.toggleBackdrop(this.options.modal,this.options.backdropColor),this.options.hotspot&&o.call(this),this.options.scrollIntoView){var e=$(this.options.scrollIntoView);e.length&&e.get(0).scrollIntoView()}this.$el.removeClass("invisible").find('button[tabindex!="-1"][disabled!="disabled"]:visible:last').focus(),this.options.focusWatcher&&(this.focusWatcher=setInterval(function(){$.contains(this.el,document.activeElement)||this.$el.find('button[tabindex!="-1"][disabled!="disabled"]:visible:last').focus()}.bind(this),100)),this.trigger("show")}function a(){return this.$el.css("left",100*this.indexOf()+"%").removeClass("center middle").appendTo(this.parent.container.find(".wizard-pages")),this.trigger("show"),this}return function(){return this.trigger("before:show"),_.device("smartphone")?a.call(this):(this.parent.toggleBackdrop(!0),this.options.navigateTo?e.call(this):this.options.waitFor?i.call(this,0):n.call(this),this)}}(),hide:function(){return this.trigger("before:hide"),_.device("smartphone")||(this.focusWatcher&&clearInterval(this.focusWatcher),$(window).off("resize.wizard.spotlight resize.wizard.hotspot resize.wizard-step"),this.$el.detach()),this.trigger("hide"),this},beforeShow:function(e){return this.once("before:show",e),this},referTo:function(e,t){return this.options.referTo={selector:e,options:t},this},spotlight:function(e,t){return this.options.spotlight={selector:e,options:t},this},hotspot:function(e,t){return _.isFunction(e)&&(e=e()),this.options.hotspot=_.isArray(e)?e:[[e,t]],this.options.backdropColor="rgba(255, 255, 255, 0.01)",this},modal:function(e){return this.options.modal=!!e,this},backdrop:function(e){return this.options.backdropColor=e,this},waitFor:function(e,t){return this.options.waitFor={selector:e,timeout:t},this},navigateTo:function(e,t){return this.options.navigateTo={id:e,options:t},this},scrollIntoView:function(e){return this.options.scrollIntoView=e,this},align:function(e){function t(e,t,i,o){t=Math.min(Math.max(16,t),o-i-16),f.css(e,t)}function i(e){t("left",e,g,h.availableWidth)}function n(e){t("top",e,m,h.availableHeight)}function a(){if(h.left+h.width+g<h.availableWidth)return i(h.left+h.width+16),n(h.top),!0}function s(){if(h.left-g>0)return i(h.left-g-16),n(h.top),!0}function l(){if(h.top+h.height+m<h.availableHeight)return i(h.left),n(h.top+h.height+16),!0}function d(){if(h.top-m>0)return i(h.left),n(h.top-m-16),!0}function c(){f.addClass("center middle").css({top:"",right:"",bottom:"",left:""})}if(e||!this.options){var u,p;if(_.isString(e)?u=r(e):_.isObject(e)&&(u=r(e.selector),p=e.options),u){var f=this.$el,h=o(u),g=f.width(),m=f.height();switch(f.removeClass("center middle").css({top:"auto",right:"auto",bottom:"auto",left:"auto"}),p&&p.position||"right"){case"right":a()||l()||s()||d()||c();break;case"left":s()||l()||a()||d()||c();break;case"bottom":l()||d()||a()||s()||c();break;case"top":d()||l()||a()||s()||c();break;default:c()}return this.trigger("align"),this}}else{if(this.options.referTo)return this.align(this.options.referTo);if(this.options.spotlight)return this.align(this.options.spotlight.selector)}},end:function(){return this.parent}});return s.registry={collection:new Backbone.Collection,add:function(e,t){e.run=t;var i=new Backbone.Model(e);return this.collection.add(i),i},get:function(e){return this.collection.get(e)},list:function(e){return void 0===e?this.collection:this.collection.where({type:e})},run:function(e){var t=this.get(e);t&&t.get("run")()}},s}),define("io.ox/tours/get-started",["io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/tk/wizard","gettext!io.ox/core"],function(e,t,i,o){var n=Backbone.View.extend({tagName:"a",events:{click:"onClick",start:"onStart"},onClick:function(e){e.preventDefault();var t=$(e.target).closest("li"),o=t.attr("data-path"),n=o&&o.split(",");require(n,function(){var e=ox.ui.App.getCurrentApp();this.$el.trigger("start",e),i.registry.run(t.attr("data-id"))}.bind(this))},onStart:function(e,t){require(["io.ox/metrics/main"],function(e){e.trackPage({id:"io.ox/guidedtour"});var i=t.get("trackingId")||t.get("name")||t.get("id");e.trackEvent({app:"core",target:"toolbar",type:"click",action:"guided-tour",detail:i.substr(i.lastIndexOf("/")+1)})})},hide:function(){if(this.$el.parent().length>0)return this.$el.parent().toggle(!1)},show:function(){if(this.$el.parent().length>0)return this.$el.parent().toggle(!0)},onAppChange:function(){if(t.has("guest"))return this.hide();var e=ox.ui.App.getCurrentApp();if(null===e)return this.hide();var i=e&&_.isFunction(e.getTour),o=i&&e.getTour();if(i&&!_.isEmpty(o))return console.warn("guided tours: getTour is deprecated. Please use a manifest entry instead."),this.show().attr({"data-id":o.id,"data-path":o.path});var n="default/"+e.getName(),a=ox.manifests.pluginsFor(n);if(a.length)return this.show().attr({"data-id":n,"data-path":a});this.hide()},initialize:function(){this.listenTo(ox,"app:ready app:resume app:stop",this.onAppChange)},render:function(){return this.$el.attr({href:"#",role:"menuitem","data-action":"guided-tour"}).text(o("Guided tour for this app")),this}});_.device("smartphone")||e.point("io.ox/core/appcontrol/right/dropdown").extend({id:"get-started",index:250,extend:function(){if(!t.has("guest")){var e=new n;this.append(e.render().$el),e.hide()}}})}),define("io.ox/core/adaptiveLoader",["io.ox/core/extensions","io.ox/core/capabilities","settings!io.ox/core"],function(e,t,i){var o;if(localStorage&&t.has("lab:adaptiveLoading")){var n=_(ox.serverConfig.capabilities).pluck("id").sort().join(","),a=i.get("language"),r=i.get("theme");o={log:function(){o.debug,console.log.apply(console,arguments)},listen:function(e){o.log("listen",e),o.cache||o.init(),o.currentChunk=e,o.modules=o.cache[e]||[]},startAndLoad:function(e){if(o.log("startAndLoad",e),o.cache||o.init(),o.listen(e),o.cache[e])return require(o.cache[e])},startAndEnhance:function(e,t){return o.log("startAndEnhance",e,t),o.cache||o.init(),o.listen(e),o.cache[e]&&_(o.cache[e]).each(function(e){_(t).contains(e)||t.push(e)}),o.log("enhanced",t),t},stop:function(){o.log("stop",o.currentChunk),o.cache||o.init(),o.currentChunk&&(o.cache[o.currentChunk]=_.uniq(o.modules),o.log(o.cacheKey,o.cache),localStorage.setItem(o.cacheKey,JSON.stringify(o.cache)),delete o.modules,delete o.currentChunk)},record:function(e){return o.log("record",e),o.cache||o.init(),setTimeout(function(){o.currentChunk===e&&o.stop()}),o.listen(e)},init:function(){o.log("init"),o.cacheKey="ox-adaptiveload-"+ox.base+"["+(ox.user||"anon")+"]["+n+"]["+a+"]["+r+"]",o.cache=JSON.parse(localStorage.getItem(o.cacheKey)),o.cache||(o.cache={}),o.log("cache",o.cache),$(window).on("require:require",function(e,t){o.modules&&o.modules.push(t.replace(/\.js$/,"")),o.dirty||(o.dirty=!0,setTimeout(function(){o.currentChunk&&(o.cache[o.currentChunk]=_.uniq(o.modules),o.log(o.cacheKey,o.cache),localStorage.setItem(o.cacheKey,JSON.stringify(o.cache))),o.dirty=!1},3e3))})}}}else o={listen:$.noop,startAndLoad:function(){return $.Deferred().resolve()},startAndEnhance:function(e,t){return t},stop:$.noop,record:$.noop,init:$.noop};return o}),define("io.ox/core/a11y",[],function(){function e(){var e=$(".folder-tree:visible .folder.selected");e.is(":visible")?e.focus():$(".window-container:visible").length>0&&a($(".window-container:visible"))}function t(e){(e=$(e)).is(".scrollable[tabindex],.listbox[tabindex]")?_.device("ie")?(e.css("border-style","none").on("blur",n),e.hasClass("default-content-padding")&&e.addClass("no-padding-adjustment")):e.css("box-shadow","none").on("blur",o):e.is(".focusable")&&e.css("outline",0).on("blur",i)}function i(){$(this).css("outline","")}function o(){$(this).css("box-shadow","")}function n(){$(this).css("border-style",""),$(this).removeClass("no-padding-adjustment")}function a(e){return e.find(".list-item.selectable.selected, .list-item.selectable:first, .vgrid-cell.selectable.selected, .vgrid-cell.selectable:first, .vgrid-scrollpane-container, .rightside, .scrollpane.f6-target").first().visibleFocus()}function r(e){var t={},i=$(e).find("input, select, textarea, button, a[href], [tabindex], iframe"),o=i.filter(function(){if(!$(this).is(":radio"))return!0;var e=$(this).attr("name");if(this===document.activeElement||$(this).is(":checked"))return t[e]=!0;if(t[e])return!1;var o=i.filter('[name="'+$.escape(e)+'"]:radio');return!(o.index(document.activeElement)>-1||o.filter(":checked").length)&&(t[e]=!0)}).filter(function(){return!$(this).closest('[contenteditable="true"]').length}).filter(":visible");return $($.map(o,function(e){return $(e).is("iframe")?r($(e).contents().find("html")).toArray():e}))}function s(e){var t=arguments[1]||e.parent(),i=r(t).filter('[tabindex!="-1"]'),o=i.index(e);return o>0?i.eq(o-1):t.is("body")?i.eq(i.length-1):(t=t.parent(),s(e,t))}function l(e){var t=arguments[1]||e.parent(),i=r(t).filter('[tabindex!="-1"]'),o=i.index(e);return o<i.length-1?i.eq(o+1):t.is("body")?i.eq(0):(t=t.parent(),l(e,t))}function d(e){if(9!==e.which){var t=$(e.target).closest("ul.dropdown-menu").find("li:visible > a"),i=t.first(),o=t.last(),n=$(e.target).is(o),a=$(e.target).is(i);if(1!==t.length)return 38===e.which&&a||34===e.which||35===e.which?(e.stopImmediatePropagation(),o.focus()):40===e.which&&n||33===e.which||36===e.which?(e.stopImmediatePropagation(),i.focus()):void c(e,t)}}function c(e,t){if(t.filter(":focus").length){var i,o=t.map(function(){var t=$(this).text()||$(this).attr("aria-label");if(t)return t.substring(0,1).toLowerCase()===String.fromCharCode(e.which).toLowerCase()?$(this):void 0});if(o.length){if(1===o.length)return o[0].focus();_.find(o,function(e,t){e.is(":focus")&&t>=0&&t<o.length-1&&(i=o[t+1])}),(i||o[0]).focus()}}}function u(e,t){if(/^(37|39)$/.test(e.which)){var i=t.index(t.filter(":focus"));37===e.which?i--:i++,i<0&&(i=t.length-1),i===t.length&&(i=0);var o=t.eq(i).removeAttr("tabindex");return $(e.currentTarget).is("ul")?o.parent().siblings().find("> a,> button").attr("tabindex",-1):o.siblings().attr("tabindex",-1),o.focus()}}function p(e){if(!($(e.currentTarget).parents(".mce-tinymce").length>0||9===e.which||16===e.which&&e.shiftKey)){var t=$(e.currentTarget).is("ul"),i=$(e.currentTarget).find(t?"> li > a, > li > button:not([disabled])":"> a, > button:not([disabled])").filter(":visible");u(e,i),c(e,i)}}$(document).on("keydown.role.button",'a[role="button"]',function(e){!/32/.test(e.which)||13===e.which&&e.isDefaultPrevented()||(e.preventDefault(),$(this).click())}),$(document).on("click",".skip-links",function(t){t.preventDefault(),e()}),$(document).on("keydown.quicklaunch","#io-ox-quicklaunch button",function(t){var i=ox.ui.App.getCurrentApp();13===t.which&&i.get("name")===$(this).attr("data-app-name")&&e()}),$(document).on("keydown.foldertree",".folder-tree .folder.selected",function(e){if(/13|32|27/.test(e.which)&&"false"!==$(e.target).attr("aria-expanded")&&("true"!==$(e.target).attr("aria-expanded")||!$(e.target).hasClass("virtual"))&&$(e.target).is("li")){var t=$(e.target).closest(".window-container");if(27===e.which&&$('#io-ox-quicklaunch button:not([tabindex="-1"])').focus(),/^(13|32)$/.test(e.which)){if(t.hasClass("io-ox-mail-window")||t.hasClass("io-ox-files-window"))return;e.preventDefault(),a(t)}}}),$(document).on("keydown.focusFolderTree",".list-item, .vgrid-scrollpane-container",function(e){if(/13|32|27/.test(e.which)){var t=$(e.target).closest(".window-container");t.hasClass("io-ox-mail-window")||t.hasClass("io-ox-files-window")||(27===e.which&&(ox.ui.App.getCurrentApp().folderView.isVisible()?t.find(".folder-tree .folder.selected").focus():$('#io-ox-quicklaunch button:not([tabindex="-1"])').focus()),/13|32/.test(e.which)&&t.find(".rightside, .list-item.focusable:first").last().visibleFocus())}}),$(document).on("keydown.rightside",".rightside,.scrollpane.f6-target",function(e){if(27===e.which){var t=$(e.target).closest(".window-container");t.hasClass("io-ox-mail-window")||t.hasClass("io-ox-files-window")||t.find(".folder-tree .folder.selected, .list-item.selectable.selected, .vgrid-cell.selectable.selected:first, .vgrid-scrollpane-container").last().focus()}}),$(document).on("keydown.bs.dropdown.data-api",'ul.dropdown-menu[role="menu"]',d),$(document).on("keydown.launchers",'ul[role="menubar"], ul[role="tablist"], [role="toolbar"], ul.launchers',p),$(document).on("blur.listbox",'ul[role="listbox"].listbox',function(){$(this).removeAttr("aria-activedescendant")}),$(document).on("keydown.listbox",'ul[role="listbox"].listbox',function(e){var t=$(e.target).closest(".window-container"),i=$(this),o=$("#"+i.attr("aria-activedescendant"));if(/^27$/.test(e.which))return t.find(".folder-tree .folder.selected").focus();if(/^(13|32)$/.test(e.which))return e.preventDefault(),a(t);if(/^(8|46)$/.test(e.which)){var n=o.attr("data-cid");n&&i.trigger("remove",n)}else if(/^(37|38|39|40)$/.test(e.which)){var r=i.children(),s=/39|40/.test(e.which)?o.next():o.prev(),l=/39|40/.test(e.which)?r.first():r.last();return s.length||(s=l),s.addClass("focussed").attr("aria-selected",!0).trigger("click",{inputdevice:"keyboard"}).siblings().removeClass("focussed").removeAttr("aria-selected"),i.attr("aria-activedescendant",s.attr("id"))}}),$(document).on("click.listbox",'ul[role="listbox"].listbox li',function(){$(this).parent().attr("aria-activedescendant",$(this).attr("id"))}),$(document).on("mousedown",".focusable, .scrollable[tabindex]",function(e){t(e.currentTarget)}),$(document).on("click",".expandable-toggle",function(e){e.preventDefault();var t=$(this).closest(".expandable").toggleClass("open"),i=t.hasClass("open");i&&t.trigger("open"),$(this).attr("aria-expanded",i)});var f=$.fn.focus;return $.fn.focus=function(){return f.apply(this,arguments),document.activeElement===this[0]&&t(this[0]),this},$.fn.visibleFocus=function(){return f.apply(this)},$(document).on("keydown.f6",function(e){if(117===e.which&&(_.device("macos")||e.ctrlKey)){e.preventDefault();var t,i=$("#io-ox-core .f6-target:visible"),o=$(document.activeElement).closest(".f6-target"),n=i.index(o)||0,a=n;do{if((a+=e.shiftKey?-1:1)>=i.length&&(a=0),a<0&&(a=i.length-1),(t=i.eq(a)).is("input, select, textarea, button, .launcher a[href], [tabindex]:visible")){t.visibleFocus();break}if((t=r(t).first()).length){t.visibleFocus();break}}while(n!==a)}}),{collapse:function(e,t,i){i=_.extend({expanded:!1},i);var o=_.uniqueId("action"),n=_.uniqueId("content");e.addClass("collapsed").prop("id",o).attr({"data-target":"#"+n,"data-toggle":"collapse","aria-expanded":!1,"aria-controls":n}),t.addClass("collapse").addClass(i.expanded?"in":"").prop("id",n).attr({role:"region","aria-labelledby":o}).append(t),i.onChange&&_.isFunction(i.onChange)&&(t.on("show.bs.collapse shown.bs.collapse hide.bs.collapse hidden.bs.collapse",function(e){i.onChange.call(t,e.type)}),i.onChange.call(t,i.expanded?"show":"hide"))},dropdownTrapFocus:d,focusListSelection:a,getTabbable:r,getPreviousTabbable:s,getNextTabbable:l,menubarKeydown:p,trapFocus:function(e,t){var i=r(e);if(i.length){var o=$(document.activeElement).is("iframe")?i.index($(document.activeElement).contents()[0].activeElement):i.index(document.activeElement),n=t.shiftKey&&0===o,a=o===i.length-1;(n||a)&&(t.preventDefault(),o=((o+=t.shiftKey?-1:1)+i.length)%i.length,i.eq(o).focus())}}}}),define("io.ox/core/tk/dialogs",["io.ox/core/event","io.ox/core/extensions","io.ox/core/a11y","io.ox/backbone/mini-views/helplink","gettext!io.ox/core"],function(e,t,i,o,n){function a(){return $('<div class="modal-backdrop in" aria-hidden="true">').hide()}function r(){return $('<div class="io-ox-dialog-popup" role="dialog" aria-labelledby="dialog-title">').hide().append($('<div role="document">').append($('<div class="modal-header" id="dialog-title">'),$('<div class="modal-body">'),$('<div class="clearfix">'),$('<div class="modal-footer">')))}var s=function(n){var s=_.extend({width:500,underlayAction:null,defaultAction:null,easyOut:!0,center:!0,async:!1,noBusy:!1,maximize:!1,top:"50%",container:$("body>.io-ox-sidepopup-overlay").length?$("body"):$("#io-ox-core"),tabTrap:!0,focus:!0},n),l={buttons:[],underlay:a(),popup:r(),wrapper:$('<div class="abs io-ox-dialog-wrapper">')},d=$(),c=$(),u=$.Deferred(),p=!1,f=this,h={},g=function(e){$(e.target).closest(".io-ox-dialog-popup, .io-ox-sidepopup, .mce-window, .date-picker, .addressbook-popup").length>0||$("body > .smart-dropdown-container").length>0||l.popup.is(":visible")&&(e.stopPropagation(),l.popup.focus())},m=function(){if(f){s.container.removeClass("blockscroll"),f.trigger("close"),document.removeEventListener("focus",g,!0),l.popup.empty().remove(),l.underlay.remove(),l.wrapper.remove(),d=d.closest(":visible"),s.focus&&(d.hasClass("dropdown")?d.children().first().focus():d.focus()),f.events.destroy();for(var e in f)delete f[e];$(window).off("resize.mobile-dialog"),f.close=f.idle=$.noop,l.header=l.body=l.footer=l.underlay=l.wrapper=null,l.buttons=d=c=null,l=u=f=h=s=null}},v=function(){l.footer.find("input, select, button").add(l.body.css("opacity",.5).find("input, select, button, textarea")).each(function(e,t){t=$(t),_.isUndefined(t.data("wasDisabled"))&&(t.data("wasDisabled",t.prop("disabled")),t.prop("disabled",!0))}),c=$(document.activeElement),l.popup.focus(),p=!0},x=function(){l.footer.find("input, select, button").add(l.body.css("opacity","").find("input, select, button, textarea")).each(function(e,t){t=$(t),_.isUndefined(t.data("wasDisabled"))||(t.prop("disabled",t.data("wasDisabled")),t.removeData("wasDisabled"))}),c.focus(),p=!1},b=function(e){var t=e.data?e.data.action:e,i=s.async&&"cancel"!==t;i&&!s.noBusy&&v(),f.trigger("action "+t,h,f),!i&&f&&(u.resolveWith(l.popup,[t,h,f.getContentNode().get(0)]),m()),_.isObject(e)&&!_.browser.Safari&&(e.processed=!0)},w=function(e){switch(e.which){case 27:p||0!==f.getBody().find(".open > .dropdown-menu").length||(e.stopPropagation(),s.easyOut&&b("cancel"));break;case 13:if(!p&&$(e.target).is("input:text, input:password"))return!!s.enter&&(_.isFunction(s.enter)?s.enter.call(f):(b(s.enter),!1));break;case 9:s.tabTrap&&i.trapFocus(this,e)}},y=function(){$(l.wrapper).parentsUntil("body").add(l.wrapper).siblings(":not(script,noscript)").each(function(){var e=$(this);e.data("ox-restore-aria-hidden",e.attr("aria-hidden"))}).attr("aria-hidden",!0),f.on("close",function(){$(l.wrapper).parentsUntil("body").add(l.wrapper).siblings(":not(script,noscript)").removeAttr("aria-hidden").each(function(){var e=$(this);e.data("ox-restore-aria-hidden")&&e.attr("aria-hidden",e.data("ox-restore-aria-hidden")),e.removeData("ox-restore-aria-hidden")})})};t.point("io.ox/core/dialogs").invoke("customize",this,s),s.container.append(l.wrapper.append(l.popup,l.underlay)),_(["header","body","footer"]).each(function(e){l[e]=l.popup.find(".modal-"+e)}),s.addClass&&l.popup.addClass(s.addClass),e.extend(this),this.resizeBody=function(){var e=f.getPopup().position().top,t=$(document).height(),i=f.getBody().height(),o=f.getPopup().height(),n=f.getBody().find(".vgrid-cell").eq(0).outerHeight(),a=o+e+30;if(a>=t){var r=i+(t-a);r>=n?f.getBody().css("height",r+"px"):f.getBody().css("height",n+"px")}},this.data=function(e){return h=void 0!==e?e:{},this},this.header=function(){return l.header.append.apply(l.header,arguments),this},this.getHeader=function(){return l.header},this.getPopup=function(){return l.popup},this.getContentNode=this.getBody=function(){return l.body},this.getContentControls=this.getFooter=function(){return l.footer},this.text=function(e){var t=l.body,i=_.uniqueId("label-");return t.find(".plain-text").remove(),t.append($('<h4 class="plain-text">').attr("id",i).text(e||"")),l.popup.attr({"aria-labelledby":i,role:"alertdialog"}),this},this.build=function(e){return _.isFunction(e)&&e.call(this),this},this.append=function(){return l.body.append.apply(l.body,arguments),this},this.prepend=function(e){return l.body.prepend(e),this};var k=function(e,t,i,o){var n={label:t,data:{action:e},click:(o=o||{}).click||b,dataaction:i,purelink:o.purelink,inverse:o.inverse};o.type&&(n[o.type]=!0);var a=$.button(n);return l.buttons.push(a),a.addClass(o.classes).attr({type:"button"})};this.addButton=function(e,t,i,o){return l.footer.prepend(k(e,t,i,o).addClass("btn-default")),this},this.addDangerButton=function(e,t,i,o){return l.footer.prepend(k(e,t,i,o).addClass("btn-danger")),this},this.addSuccessButton=function(e,t,i,o){return l.footer.prepend(k(e,t,i,o).addClass("btn-success")),this},this.addWarningButton=function(e,t,i,o){return l.footer.prepend(k(e,t,i,o).addClass("btn-warning")),this},this.addPrimaryButton=function(e,t,i,o){return l.footer.prepend(k(e,t,i,o).addClass("btn-primary")),this},this.addAlternativeButton=function(e,t,i,o){return l.footer.prepend(k(e,t,i,o).addClass("btn-default").css({float:"left",marginLeft:0})),this},this.addButtonMobile=function(e,t,i,o){return k(e,t,i,o)},this.addCheckbox=function(e,t,i){var o=_.uniqueId("form-control-label-");return l.footer.prepend($('<div class="checkbox">').append($('<div class="controls">'),$("<label>").attr("for",o).text(e).prepend($('<input type="checkbox">').attr({id:o,"data-action":t}).prop("checked",i)))),this},this.close=function(){!s||s.async?m():b("cancel")},this.invoke=function(e){return b(e),this},this.idle=function(){return x(),this},this.busy=function(){return v(),this},this.show=function(e){function t(){l.body.css("max-height",$("#io-ox-core").height()-40-l.header.outerHeight()-l.footer.outerHeight())}s.container.addClass("blockscroll"),s.focus&&(d=$(document.activeElement),document.addEventListener("focus",g,!0)),0===l.header.children().length&&l.header.remove(),s.help&&l.header.addClass("help").append(new o({href:s.help,modal:!0}).render().$el),l.underlay.show().addClass("in"),l.popup.addClass("invisible").show();var i=function(){var e={width:parseInt(s.width||1.1*l.popup.width(),10),height:parseInt(s.height||l.popup.height(),10)};return _(["width","height"]).each(function(t){var i=s[$.camelCase("max-"+t)];s[i]&&e[t]>s[i]&&(e[t]=s[i]);var o=$(document)[t]();e[t]&&e[t]>o&&(e[t]=o)}),e},n=function(){if(l){var e=i();l.popup.css({"max-width":e.width,top:s.top||0});var t=$("#io-ox-core").height()-2*s.top-l.header.outerHeight()-l.footer.outerHeight();l.body.css({height:t,"max-height":t})}},a=i();if(_.device("!smartphone")){var r={"max-width":a.width+"px"};if(s.center){r.top="50%";var c=function(){if(l){var e=l.popup.height(),t=$(window).height();t<l.popup.height()&&(e=t,r.overflow="auto",r.maxHeight="100%"),r.marginTop=0-(e/2>>0)+"px",l.popup.css(r)}};$(window).off("resize.checkTop").on("resize.checkTop",c),c()}else l.popup.css("top",s.top||"0px"),s.maximize&&(n(),$(window).off("resize.maximizedpopup").on("resize.maximizedpopup",n))}return _.device("smartphone")&&(l.popup.addClass("mobile-dialog"),l.footer.rowfluid=$('<div class="row">'),l.footer.append(l.footer.rowfluid),_.each(l.buttons,function(e){l.footer.rowfluid.prepend(e.addClass("btn-medium")),e.wrap('<div class="col-xs-12 col-md-3">')})),this.trigger("beforeshow"),l.popup.removeClass("invisible"),_.device("smartphone")&&(t(),$(window).on("resize.mobile-dialog",t)),_.device("!smartphone")&&(l.popup.find(".btn-primary").first().focus().length||l.popup.find(".btn").not(".btn-danger").first().focus()),l.popup.on("keydown",w),e&&e.call(l.popup,this),y(),this.trigger("show"),u},l.underlay.click(function(){s&&s.underlayAction&&b(s.underlayAction)}),l.popup.click(function(){s&&s.defaultAction&&b(s.defaultAction)}),this.setUnderlayAction=function(e){return s.underlayAction=e,this},this.topmost=function(){return l.underlay.addClass("topmost"),l.popup.addClass("topmost"),this},this.setUnderlayStyle=function(e){return l.underlay.css(e||{}),this},this.setDefaultAction=function(e){return s.defaultAction=e,this}};$(document).on("click",function(e){var t,i=$(e.target);if(0!==(t=i.hasClass("apptitle")?$(".io-ox-sidepopup:not(.preserve-on-appchange)"):$(".io-ox-sidepopup:not(.preserve-on-appchange), .preserve-on-appchange:visible")).length&&!function(e){var t=[".io-ox-dialog-popup",".modal.in",".modal-backdrop.in",".modal-footer",".floating-window",".participant-wrapper.removable",".autocomplete-item",".io-ox-dialog-sidepopup-toggle"].join(", ");return e.closest(t).length>0}(i)){var o=$(e.target).closest(".io-ox-sidepopup"),n=t.index(o);t.slice(n+1).trigger("close")}}),$(document).on("keydown",function(e){27===e.which&&$(".io-ox-sidepopup:not(.preserve-on-appchange), .preserve-on-appchange:visible").last().trigger("close")});return{ModalDialog:s,CreateDialog:function(e){e=$.extend({top:"50px",center:!1},e||{}),s.call(this,e)},SidePopup:function(t){function o(e){var t=e/$("body").width()*100>>0;return Math.max(0,Math.min(100,t))}t=_.extend({modal:!1,arrow:!0,closely:!1,tabTrap:!0,focus:!0},t||{});var a,r,s,l,d,c=null,u=$(),p=$('<div class="io-ox-sidepopup-pane f6-target default-content-padding abs">'),f=_.uniqueId("sidepopup-"),h=$('<div class="io-ox-sidepopup-close">').append($('<a href="#" class="close" data-action="close" role="button">').attr({"aria-label":n("Close"),"aria-controls":f}).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",n("Close")))),g=$('<div class="io-ox-sidepopup abs" role="dialog">').attr("id",f).append($('<div role="document">').append(h,p)),m=!1===t.arrow?$():$('<div class="io-ox-sidepopup-arrow">').append($('<div class="border">'),$('<div class="triangle">')),v=null,x=this,b=p.scrollable();e.extend(this),t.modal&&(d=$('<div class="io-ox-sidepopup-overlay abs">').append(g,m)),t.preserveOnAppchange&&g.addClass("preserve-on-appchange"),this.nodes={},this.lastTrigger=null,s=function(e){r(e)},r=function(){x.nodes.closest&&(t.saveOnClose&&b.find(".settings-detail-pane").trigger("save"),x.nodes.closest.prop("sidepopup",l),g.off("view:remove remove close",s),x.lastTrigger=l=null,c=setTimeout(function(){if(x.nodes.simple.length){var e,i=x.nodes.simple.find(".io-ox-sidepopup");i.length>1?((e=i.eq(-2)).show(),$("body").scrollTop(e.attr("data-scrolltop")||0)):(x.nodes.simple.find("[data-hidden-by-sidepopup]").removeAttr("data-hidden-by-sidepopup").show(),$("body").scrollTop(x.lastSimpleScrollPos||0)),x.nodes.simple=null}t.modal?d.detach():(m.detach(),g.detach()),b.empty(),t.focus&&(u=u.closest(":visible")).focus(),x.trigger("close")},100))},g.on("close",r),g.on("keydown",function(e){9===e.which&&t.tabTrap&&i.trapFocus(this,e)}),h.find(".close").on("click",function(e){return b.trigger("click"),r(e),!1}).on("keydown",function(e){13===e.which&&$(this).trigger("click")}),a=function(e,i){var n,a,p=$(this);if(u=$(document.activeElement),x.nodes={closest:v||p.parents(".io-ox-sidepopup-pane, .window-content, .window-container-center, .io-ox-dialog-popup, .notifications-overlay, body").first(),click:p.parents(".io-ox-sidepopup-pane, .io-ox-dialog-popup, .notifications-overlay, body").first(),target:v||p.parents(".simple-window, .window-container-center, .notifications-overlay, #io-ox-notifications-sidepopup, body").first(),simple:p.closest(".simple-window")},a=x.nodes.closest.prop("sidepopup")||null,x.lastTrigger=a?a.lastTrigger:null,n=p.parents(".io-ox-sidepopup, .window-content, .io-ox-dialog-popup, .window-container-center, .notifications-overlay, body").css("zIndex"),n=parseInt(n,10),n=_.isNumber(n)?n+2:100,x.lastTrigger===this)r(e);else{a&&a.close(),e&&e.stopPropagation(),x.lastTrigger=this,l=a,x.nodes.closest.prop("sidepopup",x),clearTimeout(c),g.on("view:remove remove",s);var f,w,y,k=$("body").width(),C=p.parents(".io-ox-sidepopup").first(),S=0===C.length;/^(left|right)$/.test(t.side)?f=t.side:x.nodes.target.is(".notifications-overlay")?f=C.hasClass("right")?"left":"right":(f=e.pageX>k/2?"left":"right",S&&(t.closely=!0,g.add(m).addClass("first"))),g.add(m).removeClass("left right").addClass(f).css("z-index",n),m.css("zIndex",n+1),t.closely&&_.device("!smartphone")&&("left"===f?(w="",y=Math.min(54,100-o(e.pageX-100))+"%"):(w=Math.min(54,o(e.pageX+100))+"%",y=""),g.add(m).css({left:w,right:y})),x.nodes.simple.length&&(x.lastSimpleScrollPos=$("body").scrollTop(),x.nodes.simple.find(".window-content:visible").attr("data-hidden-by-sidepopup","true").hide(),x.nodes.simple.find(".io-ox-sidepopup:visible").each(function(){$(this).attr("data-scrolltop",$("body").scrollTop()).hide()}),$("body").scrollTop(0)),_.defer(function(){x.nodes.target.append((t.modal?d:g).css("visibility","hidden")),(i||$.noop).call(x,b.empty(),e,p);var o=p.outerHeight(!0)/2>>0,n=x.nodes.target.offset()?x.nodes.target.offset().top:0,a=p.offset().top+o-n;m.css("top",a),(t.modal?d:g).css("visibility",""),t.modal||x.nodes.target.append(m),h.find(".close").focus(),x.trigger("show")})}},this.delegate=function(e,t,i){return $(e).on("click.sidepopup",t,function(e){!0!==(e.originalEvent||e).processed&&a.call(this,e,i)}),$(e).on("keypress.sidepopup",t,function(e){13===e.which&&!0!==(e.originalEvent||e).processed&&(a.call(this,e,i),e.preventDefault())}),this},this.undelegate=function(e){return $(e).off(".sidepopup"),this},this.setTarget=function(e){return v=$(e),this},this.show=function(e,t){return setTimeout(function(){a.call(e.target,e,t)},0),this},this.close=function(e){r(e)},this.destroy=function(){return r(),this.nodes=d=b=h=g=m=null,this}},busy:function(e){e.find("button, input").each(function(e,t){(t=$(t)).prop("disabled")?t.data("disabled",!0):t.prop("disabled",!0)})},idle:function(e){e.find("button, input").each(function(e,t){(t=$(t)).data("disabled")?t.removeData("disabled"):t.prop("disabled",!1)})}}}),define("io.ox/core/tk/draghelper",["io.ox/core/extensions"],function(e){e.point("io.ox/core/tk/draghelper").extend({id:"counter",index:100,draw:function(e){this.append($('<span class="drag-counter">').text(e.count))}}).extend({id:"text",index:200,draw:function(e){this.append($("<span>").text(e.source.attr("data-drag-message")||e.dragMessage.call(e.container,e.data,e.source)))}})}),define("io.ox/core/page-controller",[],function(){return function(e){function t(e){var t={tag:"<div>",classes:"io-ox-pagecontroller page",container:$()};e=_.extend(t,e),d.container&&(e.container=d.container),n[e.name]={$el:$(e.tag).addClass(e.classes),navbar:e.navbar,toolbar:e.toolbar,secondaryToolbar:e.secondaryToolbar,name:e.name},a.push(e.name),n[e.name].$el.attr("data-page-id",l.options.name+"/"+e.name),$(e.container).append(n[e.name].$el),e.startPage&&s.setCurrentPage(e.name)}var i,o,n={},a=[],r=[],s=this,l={navbar:e.navbar||$(),toolbar:e.toolbar||$(),options:{name:e.appname}},d=e||{};this.showPage=function(e){e!==i&&s.setCurrentPage(e)},this.changePage=function(e,t){if(n[e]){if(e!==i){var o=_.extend({from:i,animation:_.device("smartphone")?"slideleft":"pop",disableAnimations:!1},t||{}),a=n[e].$el,s=n[o.from].$el,d=$.Deferred();if(o.animation=_.device("android")?"pop":o.animation,a.trigger("pagebeforeshow",{frompage:o.from}),s.trigger("pagebeforehide",{topage:o.to}),_.device("smartphone"))try{document.activeElement&&"body"!==document.activeElement.nodeName.toLowerCase()?$(document.activeElement).blur():$("input:focus, textarea:focus, select:focus").blur()}catch(e){}r=i,i=e;var p=$('<div class="taptrap">');return _.device("!smartphone")&&(p=$()),Modernizr.cssanimations&&!o.disableAnimations?(_.defer(function(){a.append(p).addClass("io-ox-core-animation in current "+o.animation).one("webkitAnimationEnd mozAnimationEnd animationend",function(){$(this).removeClass("io-ox-core-animation in "+o.animation),a.trigger("pageshow",{from:o.from,to:o.to}),$(this).find(".taptrap").remove(),d.resolve()}),p=null},1),_.defer(function(){s.removeClass("current").addClass("io-ox-core-animation out inmotion "+o.animation).one("webkitAnimationEnd mozAnimationEnd animationend",function(){$(this).removeClass("io-ox-core-animation out inmotion "+o.animation),s.trigger("pagehide",{from:o.from,to:o.to})})},1)):(a.addClass("current").trigger("pageshow",{from:o.from,to:o.to}),s.removeClass("current").trigger("pagehide",{from:o.from,to:o.to})),c(e),u(e),ox.ui.apps.trigger("layout",l),d}}else console.warn("target page does not exist: ",e)},this.setBackbuttonRules=function(e){o=e},this.goBack=function(e){var t=r,n=_.extend({animation:"slideright"},e||{});o&&o[i]&&(t=o[i]),this.changePage(t,n)},this.addPage=function(e){if(e)return t(e),this},this.getPage=function(e){return n[e]?n[e].$el:(console.error("PageController: Page "+e+" does not exist."),void console.error("PageController: Available pages are "+a.join()))},this.getPageObject=function(e){return n[e]?n[e]:(console.error("PageController: Page "+e+" does not exist."),void console.error("PageController: Available pages are "+a.join()))},this.getNavbar=function(e){if(n[e])return n[e].navbar;console.error("PageController: Page "+e+" does not exist.")},this.getAll=function(){return n},this.getToolbar=function(e){if(n[e])return n[e].toolbar;console.error("PageController: Page "+e+" does not exist.")},this.getSecondaryToolbar=function(e){if(n[e]){if(n[e].secondaryToolbar)return n[e].secondaryToolbar;console.error("PageController: Page "+e+" does not own a secondary toolbar.")}else console.error("PageController: Page "+e+" does not exist.")},this.getCurrentPage=function(){return n[i]},this.setCurrentPage=function(e){i&&n[i].$el.removeClass("current"),n[e].$el.addClass("current"),c(e),u(e),i=e},this.getPages=function(){return n};var c=function(e){var t=n[e].navbar,i=n[r];i&&i.navbar&&i.navbar.toggle(!1),t?(t.rendered||t.render(),l.navbar.append(t.$el),l.navbar.toggle(!0),t.toggle(!0)):(l.navbar.hide(),n[e].$el.addClass("fullscreen"))},u=function(e,t){var i;t&&n[e].secondaryToolbar?i=n[e].secondaryToolbar:n[e].toolbar&&(i=n[e].toolbar),i?(l.toolbar.children().detach(),l.toolbar.append(i.$el).show(),l.toolbar.trigger("show"),t||i.render()):l.toolbar&&(l.toolbar.children().detach(),l.toolbar.hide(),l.toolbar.trigger("hide"))};this.toggleSecondaryToolbar=u}}),define("io.ox/core/toolbars-mobile",["io.ox/core/extensions"],function(e){var t=Backbone.View.extend({show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}});return{BarView:t,NavbarView:t.extend({tagName:"div",className:"toolbar-content",events:{"touchstart .navbar-action":"cantTouchThis","touchend .navbar-action":"cantTouchThis","tap .navbar-action.right:not(.custom)":"onRightAction","tap .navbar-action.left:not(.custom)":"onLeftAction"},initialize:function(e){this.title=e.title?e.title:"",this.left=!!e.left&&e.left,this.right=!!e.right&&e.right,this.baton=e.baton,this.extension=e.extension,this.hiddenElements=[],this.rendered=!1},render:function(){return this.$el.empty(),this.rendered=!0,e.point(this.extension).invoke("draw",this,{left:this.left,right:this.right,title:this.title,baton:this.baton}),this.$el.find(this.hiddenElements.join()).hide(),this},cantTouchThis:function(e){"touchstart"===e.type&&$(e.currentTarget).addClass("tapped"),"touchend"===e.type&&$(e.currentTarget).removeClass("tapped")},setLeft:function(e){return this.left=e,this.render(),this},setTitle:function(e){return this.title=e,this.render(),this},setRight:function(e){return this.right=e,this.render(),this},onRightAction:function(e){e.preventDefault(),e.stopImmediatePropagation(),this.trigger("rightAction")},onLeftAction:function(e){e.preventDefault(),e.stopImmediatePropagation(),this.trigger("leftAction")},hide:function(e){return this.hiddenElements.push(e),this.hiddenElements=_.uniq(this.hiddenElements),this.render(),this},show:function(e){return this.hiddenElements=_.without(this.hiddenElements,e),this.render(),this},setBaton:function(e){return this.baton=e,this.render(),this},toggle:function(e){this.$el.toggle(e)}}),ToolbarView:t.extend({initialize:function(e){this.page=e.page,this.baton=e.baton,this.extension=e.extension},render:function(){return this.$el.empty(),e.point(this.extension+"/"+this.page).invoke("draw",this.$el,this.baton),this},setBaton:function(e){return this.baton=e,this.render(),this}})}}),define("io.ox/core/folder/util",["io.ox/core/api/account","settings!io.ox/mail","settings!io.ox/core","settings!io.ox/calendar"],function(e,t,i,o){function n(e,t){return e>>t&(t>=28?1:127)}function a(e){return"calendar"===(e=e||"mail")?o.get("chronos/defaultFolderId"):"mail"===e?t.get("folder/inbox"):i.get("folder/"+e)}function r(e,t){return!!p&&(t=t||[],!(!e||-1!==_(e).indexOf(t))&&(e.id.toString()===a("infostore").toString()||!(!e.folder_id||!p.models[e.folder_id])&&(t.push(e.id),r(p.models[e.folder_id].attributes,t))))}function s(o,n){var a,l,d,c=0,u="";if(!n||!o)return!1;if(_.isArray(n))return _(n).reduce(function(e,t){return e&&s(o,t)},!0);if(o.search(/\|/)>-1){var p=o.split(/\|/);for(l=p.length,a=!1;c<l;c++)if(s(p[c],n)){a=!0;break}return a}switch(o){case"private":return 1===n.type;case"public":return"infostore"!==n.module||2!==n.type||/^(10|14|15)$/.test(n.id)?2===n.type||/^(10|14|15)$/.test(n.id):!r(n);case"shared":return 3===n.type;case"system":return 5===n.type||"system"===n.module;case"trash":return 16===n.type||12===n.standard_folder_type;case"mail":return"mail"===n.module;case"messaging":return"messaging"===n.module;case"calendar":return"calendar"===n.module;case"contacts":return"contacts"===n.module;case"tasks":return"tasks"===n.module;case"infostore":case"files":case"drive":return"infostore"===n.module;case"account":return"system"===n.module&&/^default(\d+)?/.test(String(n.id));case"unifiedfolder":return n&&(u=void 0!==n.id?n.id:n),e.isUnifiedFolder(u);case"external":return/^(default[1-9]|\w+:\/\/)/.test(String(n.id))&&!s("unifiedmail",n);case"defaultfolder":if(e.getType(n.id))return!0;d=t.get("folder");for(u in d)if(d[u]===n.id)return!0;return!1;case"insideDefaultfolder":d=t.get("folder");for(u in d)if(0===n.id.indexOf(d[u]))return!0;return!1;case"published":return!!n["com.openexchange.publish.publicationFlag"];case"subscribed":return!!n["com.openexchange.subscribe.subscriptionFlag"];case"unlocked":case"shared-by-me":var f;if(n.permissions&&n.permissions.length>=1&&(f=_(n.permissions).filter(function(e){if(1===e.bits)return!0})),!n.permissions||n.permissions.length<=1||f.length>0)return;return 1===n.type||7===n.type||"infostore"===n.module&&n.created_by===ox.user_id;case"hidden":var h=i.get(["folder/hidden"],{});return u=_.isObject(n)?n.id:n,!0===h[u];case"attachmentView":var g=i.get("folder/mailattachments",{});return!_.isEmpty(g)&&_.values(g).indexOf(n.id)>-1;default:return!1}}function l(e,t){var i=s("external",e)&&e.virtual_parents[0];return _.isEmpty(t)&&!i?d("remove:folder",e):e.folder_id!==t.id&&(e.id!==t.id&&(3!==e.type&&3!==t.type&&(5!==e.type&&(!s("defaultfolder",e)&&((1!==e.type||1===t.type||1===t.id||7===t.type)&&((2!==e.type||2===t.type||t.id in{2:1,10:1,15:1})&&(e.module===t.module&&!(!d("create:folder",e)||!d("create:folder",t)))))))))}function d(e,t,i){if(_.isArray(t))return _(t).reduce(function(t,o){return t&&d(e,o,i)},!0);var o,a=t.own_rights,r=t.standard_folder||s("system",t),u=1===n(a,28),p="mail"===t.module,f=i?_.firstOf(i.created_by,i.createdBy?i.createdBy.entity:void 0,0):void 0,h=i&&ox.user_id!==f?1:0;switch(e){case"read":return"9"===t.id||n(a,7)>0&&1!==a;case"create":return!s("system",t)&&(!s("subscribed",t)&&(!(p&&!d("read",t))&&n(a,0)>1));case"write":return!s("subscribed",t)&&n(a,14)>h;case"delete":return!s("subscribed",t)&&n(a,21)>h;case"rename":case"rename:folder":return p?1===n(a,30):u&&!r;case"create:folder":return 4==(4&(o=n(a,0)))||64==(64&o);case"delete:folder":case"remove:folder":case"restore:folder":return u&&!r&&!s("defaultfolder",t);case"move:folder":return l(t,i);case"import":return(127&a)>=2&&s("calendar|contacts|tasks",t);case"export":return!s("shared",t)&&s("contacts|calendar|tasks",t);case"empty":return a>>21&127&&s("mail",t);case"changepermissions":case"change:permissions":return u&&!!(1&t.capabilities);case"viewproperties":return!p&&!s("account",t)&&1&t.capabilities;case"publish":return!!c("publication",t)&&("contacts"===t.module||"infostore"===t.module&&d("create",t)&&1!==a&&4!==a);case"subscribe":return!!c("subscription",t)&&(/^(contacts|calendar|infostore)$/.test(t.module)&&d("write",t));case"subscribe:imap":return!!p&&(0!==a&&((!t.standard_folder||!/^(7|9|10|11|12)$/.test(t.standard_folder_type))&&Boolean(t.capabilities&Math.pow(2,4))));case"change:seen":return c("STORE_SEEN",t);case"add:version":return c("file_versions",t);case"sync:cache":return c("cached",t);default:return!1}}function c(e,t){return t instanceof Backbone.Model?_(t.get("supported_capabilities")).indexOf(e)>-1:_(t.supported_capabilities).indexOf(e)>-1}function u(e){e&&e.toggle&&(e.toggle("open",!0),e.options&&u(e.options.parent))}var p;return{registerPool:function(e){p=e},perm:n,bits:function(e,t){return n(_.firstOf(e.own_rights,e,0),t||0)},supports:c,is:s,can:d,getDefaultFolder:a,open:u}}),define("io.ox/core/folder/sort",["io.ox/core/extensions","io.ox/core/api/account"],function(e,t){var i=e.point("io.ox/core/folder/sort");return i.extend({id:"1",sort:function(e){if("1"===e.id){var i=e.data,o=new Array(6),n="inbox sent drafts trash spam".split(" ");_(i).find(function(e){return t.isUnified(e.id)&&!!(o[0]=e)}),_(i).each(function(e){_(n).find(function(i,n){return t.is(i,e.id)&&!!(o[n+1]=e)})}),(i=_(i).reject(function(e){return t.isUnified(e.id)||t.isStandardFolder(e.id)})).sort(function(e,i){var o=t.isExternal(e.id),n=t.isExternal(i.id),a=e.title.toLowerCase()>i.title.toLowerCase()?1:-1;return o&&n?a:o?1:n?-1:a}),i.unshift.apply(i,_(o).compact()),e.data=i}}}),{apply:function(t,o){var n=e.Baton({id:t,data:o});return i.invoke("sort",null,n),n.data}}}),define("io.ox/core/folder/blacklist",["io.ox/core/extensions","settings!io.ox/core","settings!io.ox/files"],function(e,t,i){function o(e,t){return e&&!!t}var n=e.point("io.ox/core/folder/filter"),a=t.get("folder/blacklist",{}),r={},s=_(a).keys().sort();return ox.debug&&s.length>0&&console.info("Blacklisted folders:",s),n.extend({id:"blacklist",index:100,visible:function(e){var i=e.data,o=String(i.id);return!(a=_.extend(t.get("folder/blacklist",{}),r))[o]}},{id:"dot-folders",index:200,visible:function(e){return"infostore"!==e.data.module||(!0===i.get("showHidden",!1)||!/^\./.test(e.data.title))}}),{hash:a,filter:function(t){var i=e.Baton({data:t});return n.invoke("visible",null,i).reduce(o,!0).value()},visible:function(e){return this.filter(e)},apply:function(e){return _(e).filter(this.filter,this)},add:function(e){r[e]=!0}}}),define("io.ox/core/folder/title",[],function(){return function(e,t){if((e=String(e||"").trim()).length<t)return e;var i=!!/[_-]/.test(e[0])&&e[0],o=!!/[_-]/.test(e[e.length-1])&&e[e.length-1],n=e.split(/[ _-]+/),a=e.split(/[^ _-]+/),r=e.length;for(i&&(n[1]=i+n[1],n.splice(0,1)),o&&(n[n.length-1]=o+n[n.length-1],n.splice(n.length-1,1));r>t&&n.length>2;){var s=Math.floor(n.length/2);r-=n[s].length+2,n.splice(s,1),a.splice(s+1,1),a[Math.floor(a.length/2)]="…"}return r>t?_.ellipsis(e,{charpos:"middle",max:t,length:Math.floor(t/2-1)}):_(n).map(function(e,t){return e+a[t+1]}).join("")}}),define("io.ox/core/folder/bitmask",[],function(){var e={folder:0,read:7,write:14,modify:14,delete:21,admin:28},t=function(t){if(_.isString(t)){if(t in e)return e[t];console.error("Typo!?",t)}return t||0};return function(e){e=e||0;var i={get:function(i){return 0===arguments.length?e:e>>t(i)&127},set:function(i,o){return i=t(i),o=o||0,e&=536870911^127<<i,e|=o<<i,this}};return i}}),define("io.ox/core/folder/api",["io.ox/core/http","io.ox/core/folder/util","io.ox/core/folder/sort","io.ox/core/folder/blacklist","io.ox/core/folder/title","io.ox/core/folder/bitmask","io.ox/core/api/account","io.ox/core/api/user","io.ox/core/api/jobs","io.ox/core/capabilities","io.ox/contacts/util","settings!io.ox/core","settings!io.ox/mail","settings!io.ox/calendar","io.ox/core/api/filestorage","gettext!io.ox/core"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f,h,g){function m(e){return"1"===(e=String(e))||/^default\d+/.test(e)?0:1}function v(e,t,i){return t["index/"+e]=i,t}function x(e){var i=[].concat(e).filter(function(e){return!!/^(contacts|calendar|tasks|event)$/.test(e.module)&&(e.id===String(f.get("chronos/defaultFolderId"))||t.is("shared",e))}),o=_(i).chain().pluck("created_by").compact().uniq().value();return 0===o.length?$.when(e):s.getList(o).then(function(t){var n=_.object(o,t);return _(i).each(function(e){e.id===String(f.get("chronos/defaultFolderId"))||e.title===g("Calendar")?e.display_title=c.getFullName(n[e.created_by])||g("Default calendar"):e.display_title=g("%1$s: %2$s",c.getFullName(n[e.created_by]),e.title)}),e})}function b(e){delete ee.models[e.previous("id")],ee.models[e.id]=e}function w(e){ee.unfetch(e.id)}function y(e){return"cal://0/allPublic"===e||/^virtual/.test(e)}function k(e){return/^(contacts|calendar|tasks|event)$/.test(e)}function C(e,t){return(t?"all/":"")+String(e)}function S(e){return ee.getCollection(e.id).reduce(function(e,t){var i=r.getType(t.get("id"));return"trash"===i||"spam"===i||"confirmed_spam"===i?e:e+(t.get("subtotal")||0)+(t.get("unread")||0)},0)}function T(e,t,i){var o=t-(void 0!==e._previousAttributes[i]&&null!==e._previousAttributes[i]?e._previousAttributes[i]:0),n=ee.models[e.get("folder_id")],a=e.get("virtual_parents");0!==o&&n&&"system"!==n.get("module")&&ee.collections[n.get("id")]&&(n.is("unifiedfolder")||n.set("subtotal",S(n))),0!==o&&a&&a.length>0&&_(a).each(function(t){ee.models[t]&&ee.collections[t]._byId[e.get("id")]?ee.models[t].set("subtotal",S(ee.models[t])):e.set("virtual_parents",_(e.get("virtual_parents")).without(t))})}function D(e,t){T(e,t,"subtotal")}function A(e,t){T(e,t,"unread"),te.trigger("change:unread",e,t)}function M(){this.models={},this.collections={}}function E(e,t){return t=o.apply(t),t=i.apply(e,t),_(t).each(v.bind(null,e)),t}function N(e){if(e instanceof Backbone.Model){var t=e,i=t.toJSON(),o=i.id;return void 0!==t.changed.total&&null!==t.changed.total&&(te.trigger("update:total",o,i),te.trigger("update:total:"+o,i)),void(void 0!==t.changed.unread&&null!==t.changed.unread&&(te.trigger("update:unread",o,i),te.trigger("update:unread:"+o,i)))}return/^account:(create|delete|unified-enable|unified-disable)$/.test(e)?L("1",{cache:!1}).done(function(){re.refresh(),te.trigger("refresh")}):ae}function F(e,t){this.id=e,this.getter=t}function I(e){return e={error:e,code:"UI-FOLDER"},console.warn("folder/api",e),te.trigger("error error:"+e.code,e),$.Deferred().reject(e)}function P(t,i){if(void 0===t)return I("Cannot fetch folder with undefined id");t=String(t),i=_.extend({cache:!0},i);var o=ee.models[t];return!0===i.cache&&void 0!==o&&o.has("title")?$.when(o.toJSON()):y(t)?$.when({id:t}):"6"!==t||d.has("gab")?e.GET({module:"folders",params:{action:"get",altNames:!0,id:t,timezone:"UTC",tree:m(t)}}).pipe(function(e){return x(e)},function(e){return te.trigger("error error:"+e.code,e,t),e}).pipe(function(e){var t=ee.addModel(e);return _(t.changed).size()&&te.trigger("changesAfterReloading:"+t.get("module"),t),N(t),e}):I(g("Accessing global address book is not permitted"))}function L(t,i){t=String(t),i=_.extend({all:!1,cache:!0},i);var o=C(t,i.all),n=ee.getCollection(o);if(n.fetched&&!n.expired&&!0===i.cache)return $.when(n.toJSON());if(ne[t]&&!i.all){var a=E(t,ne[t]);return delete ne[t],x(a).then(function(e){return ee.addCollection(t,e),e})}var r,s,l=/^flat\/([^/]+)\/([^/]+)$/.exec(t);return l?(r=l[1],s=l[2],B({module:r,cache:i.cache}).then(function(e){return e[s]})):y(t)?re.list(t):e.GET({module:"folders",params:{action:"list",all:i.all?"1":"0",altNames:!0,parent:t,timezone:"UTC",tree:m(t)},appendColumns:!0}).then(x,function(e){throw te.trigger("error error:"+e.code,e,t),e}).then(function(e){return e=E(t,e),ee.addCollection(o,e,{all:i.all}),e})}function z(t){return e.makeObject(t,"folders")}function q(e,t){return"flat/"+e+"/"+t}function O(e,t){return ee.getCollection(q(e,t))}function V(){return _(ee.collections).chain().keys().filter(function(e){return/^flat/.test(e)}).map(function(e){return e.split("/")[1]}).uniq().value()}function R(e){e.unshift(ee.getModel("cal://0/allPublic").toJSON())}function B(i){if("calendar"===(i=_.extend({module:void 0,cache:!0},i)).module&&(i.module="event"),ox.debug&&!i.module)return console.warn("Folder API > flat() - Missing module",i),$.Deferred().reject();var o=i.module,n=O(o,"private"),a={};return n.fetched&&!0===i.cache?(a.private=n.toJSON(),["public","shared","sharing","hidden"].forEach(function(e){var t=O(o,e);t.fetched&&(a[e]=t.toJSON())}),$.when(a)):(te.trigger("before:flat:"+i.module),e.GET({module:"folders",appendColumns:!0,params:{action:"allVisible",altNames:!0,content_type:o,timezone:"UTC",tree:1,all:!!i.all}}).then(function(e){var i=[],o=_(e).chain().map(function(e,o){var n=_(e).chain().map(z).filter(function(e){return!(!t.can("read",e)&&!t.can("change:permissions",e))}).value();return i.push(n),[o,n]}).object().value();return x(_(i).flatten()).then(function(){return o})}).then(function(e){var n,a={},r=[],s=[],l=u.get(["folder/hidden"],{});return"event"!==o||e.public||(e.public=[]),_(e).each(function(e,i){var d=_(e).filter(function(e){return l[e.id]?(r.push(e),!1):(t.is("shared-by-me",e)&&s.push(e),!0)});"event"===o&&"public"===i&&R(d),d=E(n=q(o,i),d),ee.addCollection(n,a[i]=d,{reset:!0})}),n=q(o,"hidden"),r=E(n,r),ee.addCollection(n,a.hidden=r,{reset:!0}),n=q(o,"sharing"),s=E(n,s),ee.addCollection(n,a.sharing=s,{reset:!0}),te.trigger("after:flat:"+i.module),a}))}function U(t,i,n){if(_.isObject(i)&&!_.isEmpty(i)){n=_.extend({silent:!1},n);var a=ee.getModel(t).set(i,{silent:n.silent});if(y(t))return $.when();n.silent||te.trigger("before:update before:update:"+t,t,a);var r={folder:i},s=function(e){if(t!==e&&a.set("id",e),n.cascadePermissions&&Q(),n.silent||(te.trigger("update update:"+t,t,e,a.toJSON()),"permissions"in i&&te.trigger("change:permissions",t)),t!==e||i.title||i.folder_id)return L(a.get("folder_id"),{cache:!1}).then(function(){return ee.getCollection(a.get("folder_id")).sort(),"title"in i&&te.trigger("rename",t,a.toJSON()),"title"in i&&te.trigger("after:rename",t,a.toJSON()),e})},d=function(e){throw te.get(t,{cache:!1}),e&&e.code&&"FLD-0018"===e.code&&(e.error=g("Could not save settings. There have to be at least one user with administration rights.")),n.silent||te.trigger("update:fail",e,t),e};return n.notification&&!_.isEmpty(n.notification)&&(r.notification=n.notification),e.PUT({module:"folders",params:{action:"update",id:t,timezone:"UTC",tree:m(t),cascadePermissions:n.cascadePermissions,ignoreWarnings:n.ignoreWarnings,allow_enqueue:n.enqueue},data:r,appendColumns:!1}).done(function(){var e=a.toJSON();o.visible(e)||te.trigger("warn:hidden",e)}).then(function(e){return e&&n.enqueue&&("JOB-0003"===e.code||e.job)?(l.addJob({module:"folders",action:"update",done:!1,showIn:a.get("module"),id:e.job||e.data.job,successCallback:s,failCallback:d}),e):s(e)},d)}}function j(e){_(ee.collections).invoke("remove",e)}function H(e){this.nodeValue=e.display_title||e.title||e.id}function W(e){return _(e).chain().pluck("folder_id").uniq().value().length<=1}function G(e){return!r.is("sent",e.folder_id)}function J(e){return _.isString(e)?e:e?e.folder_id:null}function K(){_.chain(arguments).flatten().map(J).compact().uniq().each(function(e){K.hash[e]||(K.hash[e]=_.debounce(P.bind(null,e,{cache:!1}),K.wait)),te.trigger("reload:"+e),K.hash[e]()})}function Y(e){var t=ee.getModel(e).get("module");u.set(["folder/hidden",e],!0).save(),te.trigger("hide",e),B({module:t,cache:!1})}function X(e){var t=ee.getModel(e).get("module");u.remove(["folder/hidden",e]).save(),te.trigger("show",e),B({module:t,cache:!1})}function Q(){ee.expire(),e.pause();var t=[];return _(te.pool.models).chain().filter(function(e){return!k(e.get("module"))}).invoke("get","folder_id").uniq().compact().without("0").each(function(e){t.push(L(e,{cache:!1}))}),_(V()).each(function(e){t.push(B({module:e,all:"event"===e,cache:!1}))}),$.when.apply($,t).always(function(){re.refresh()}),e.resume()}function Z(){return p.get("defaultseparator","/")}var ee,te={};_.extend(te,Backbone.Events);var ie=Backbone.Model.extend({constructor:function(){Backbone.Model.apply(this,arguments),this.set("virtual_parents",[]),"mail"!==this.get("module")&&void 0!==this.get("module")||this.on({"change:id":b,"change:subtotal":D,"change:unread":A})},isAdmin:function(){return!!new a(this.get("own_rights")).get("admin")},supportsInternalSharing:function(){return!!this.is("drive")||(this.is("mail")?d.has("gab")&&this.can("change:permissions"):!(this.is("calendar")&&this.is("private")&&!this.supportsShares())&&(this.is("public")?d.has("edit_public_folders"):d.has("read_create_shared_folders")))},supportsInviteGuests:function(){return!this.is("mail")&&d.has("invite_guests")&&this.supportsInternalSharing()},supportsShares:function(){return!(!this.is("mail")||1!=(1&this.get("capabilities")))||this.supports("permissions")},isShareable:function(){return this.isAdmin()&&this.supportsShares()},supports:function(e){return t.supports(e,this.attributes)},is:function(e){return t.is(e,this.attributes)},can:function(e){return t.can(e,this.attributes)}}),oe=Backbone.Collection.extend({model:ie,constructor:function(e){Backbone.Collection.apply(this,arguments),this.id=e,this.fetched=!1,this.on("remove",this.onRemove,this),(/^flat\/(contacts|calendar|tasks|event)\/shared$/.test(this.id)||/^flat\/(contacts|calendar|tasks|event)\/hidden$/.test(this.id))&&(this.comparator=function(e){return(e.get("display_title")||e.get("title")).toLowerCase()})},comparator:function(e){return e.get("index/"+this.id)||0},onRemove:function(e){k(e.get("module"))||(ee.getModel(this.id).set("subscr_subflds",this.length>0),te.trigger("collection:remove",this.id,e))}});_.extend(M.prototype,{addModel:function(e){if(e.attributes)return e;var t=e.id,i=this.models[t];return void 0===i?(this.models[t]=i=new ie(e),te.trigger("pool:add",i)):i.set(e),i},removeModels:function(e){e&&_.each(this.models,function(t,i){return!t.get("account_id")||(t.get("account_id")!==e||(te.trigger("remove",i,this.models[i].toJSON()),void delete this.models[i]))}.bind(this))},addCollection:function(e,t,i){i&&!i.all&&_(t).each(function(e){delete e.subfolders});var o=_(t).map(this.addModel,this);i=i||{};var n=this.getCollection(e),a=n.fetched?"set":"reset";if(n.expired=!1,this.models[e]&&y(e)&&_(n.models).each(function(t){t.set("virtual_parents",_(t.get("virtual_parents")).without(e))}),n[a](o),n.fetched=!0,this.models[e]&&("mail"===this.models[e].get("module")||void 0===this.models[e].get("module"))&&!this.models[e].is("unifiedfolder")){for(var s=0,l=0;l<o.length;l++){var d=r.getType(o[l].get("id"));if("trash"!==d&&"spam"!==d&&"confirmed_spam"!==d&&(s+=(o[l].get("subtotal")||0)+(o[l].get("unread")||0),y(e))){var c=o[l].get("virtual_parents");c&&(c.push(e),o[l].set("virtual_parents",_.uniq(c)))}}this.models[e].set("subtotal",s)}i.reset&&n.trigger("reset")},removeCollection:function(e,t){t=t||{};var i=this.collections[e],o=this,n=i?i.models:[];if(i&&(i=null,delete this.collections[e],_(n).each(function(e){j(e.id),o.removeCollection(e.id,t)}),t.removeModels&&this.models[e])){var a=this.models[e].toJSON();this.models[e]=null,delete this.models[e],te.trigger("remove",e,a),te.trigger("remove:"+e,a),te.trigger("remove:"+a.module,a)}},getModel:function(e){return this.models[e]||(this.models[e]=new ie({id:e}))},getCollection:function(e,t){return e=C(e,t),this.collections[e]||(this.collections[e]=new oe(e))},expire:function(){_(this.collections).each(function(e){e.expired=!0})},unfetch:function(e){if(0===arguments.length||"0"===e)return _(this.collections).each(function(e){e.fetched=!1});var t=this.collections[e];t&&(t.fetched=!1,t.each(w))}}),ee=new M,_(ox.rampup.folder).chain().keys().each(function(e){ee.addModel(ox.rampup.folder[e])});var ne={};_(ox.rampup.folderlist||{}).each(function(t,i){ne[i]=_(t).map(function(t){return _.isArray(t)?e.makeObject(t,"folders"):t})}),d.has("webmail")&&ee.addModel({folder_id:"default0/INBOX",id:"virtual/all-unseen",module:"mail",title:g("Unread")}),!d.has("guest")&&d.has("edit_public_folders")&&ee.addModel({folder_id:"1",id:"cal://0/allPublic",module:"calendar",permissions:[{bits:0,entity:ox.user_id,group:!1}],standard_folder:!0,supported_capabilities:[],title:g("All my public appointments"),total:-1,type:1,subscribed:!0});var ae=$.when();F.prototype.concat=function(){return _.whenSome.apply(void 0,arguments).then(function(e){return e.rejected.length&&_.each(e.rejected,function(e){console.error(e)}),_(e.resolved).chain().flatten().compact().value()})},F.prototype.list=function(){var e=this.id;return this.getter().done(function(t){_(t).chain().map(function(e){return y(e.id)?_.extend(e,ee.getModel(e.id).toJSON()):e}).each(v.bind(null,e)).value(),ee.addCollection(C(e),t),ee.getModel(e).set("subscr_subflds",t.length>0)})};var re={hash:{},list:function(e){var t=this.hash[e];return void 0!==t?t.list():$.Deferred().reject()},add:function(e,t){this.hash[e]=new F(e,t),ee.getModel(e).set("subscr_subflds",!0)},concat:function(){return ox.debug&&console.warn("Deprecated! Please use this.concat()"),$.when.apply($,arguments).then(function(){return _(arguments).chain().flatten().map(v.bind(null,"concat")).value()})},reload:function(e){ee.getCollection(C(e)).fetched=!1,this.list(e)},refresh:function(){_(this.hash).invoke("list")},getCollections:function(){return _(this.hash).keys().map(function(e){return te.pool.getCollection(e)})}},se=[];K.hash={},K.wait=2e3;var le=function(){function e(e){delete i[e],K(e)}function t(t){i[t]&&clearTimeout(i[t]),i[t]=setTimeout(e,o,t)}var i={},o=500;return function(e,i){var o=ee.getModel(e);o.set("unread",Math.max(0,o.get("unread")+i)),t(e)}}();ox.on("please:refresh refresh^",Q),ox.on("account:delete",ee.removeModels.bind(ee)),h.on("create update",Q);var de=""===p.get("namespace","INBOX/");return t.registerPool(ee),_.extend(te,{FolderModel:ie,FolderCollection:oe,Pool:M,pool:ee,calculateSubtotal:S,get:P,list:L,multiple:function(t,i){function o(t){return $.Deferred().reject({error:e.messages[t],code:t.toUpperCase()})}if(!t||!t.length)return $.when([]);i=_.extend({cache:!0,errors:!1},i);try{return e.pause(),$.when.apply($,_(t).map(function(e){return P(e,{cache:i.cache}).pipe(null,function(t){return t.id=e,$.when(i.errors?t:void 0)})})).pipe(function(){return _(arguments).toArray()}).pipe(function(e){return e.length?_(e).all({code:"OFFLINE"})?o("offline"):_(e).all({code:"NOSERVER"})?o("noserver"):e:[]})}finally{e.resume()}},path:function(t){var i,o=[],n=t,a=!1;if(void 0===t)return $.when([]);do{o.push(i=ee.getModel(n).toJSON()),n=i.folder_id,a="1"===String(n)}while(n&&!a);return a?$.when(o.reverse()):y(t)?ee.getModel(t).toJSON()?$.when([ee.getModel(t).toJSON()]):$.when([]):e.GET({module:"folders",params:{action:"path",altNames:!0,id:t,tree:m(t)},appendColumns:!0}).then(function(e){return _(e).filter(function(e){return ee.addModel(e),"1"!==e.id}).reverse()})},flat:B,update:U,move:function(e,t,i){if(e===t)return $.when();i=i||{};var o=ee.getModel(e),n=o.get("folder_id");return j(o),te.trigger("before:move",o.toJSON(),t),o.set("unread",0),U(e,{folder_id:t},i).then(function(i){var a=function(i){if(i.error)throw ee.getModel(n).set("subscr_subflds",!0),re.refresh(),ee.getCollection(n).add(o),i;ee.getModel(t).set("subscr_subflds",!0),re.refresh(),ee.getCollection(t).add(o),te.trigger("move",e,i)};if(i&&("JOB-0003"===i.code||i.job))return te.trigger("new:longrunningjob"),void l.on("finished:"+(i.job||i.data.job),a);a(i)},function(e){throw ee.getModel(n).set("subscr_subflds",!0),ee.getCollection(n).add(o),re.refresh(),e})},create:function(i,n){return i=String(i),P(i).then(function(a){k((n=_.extend({module:a.module,subscribed:1,title:g("New Folder")},n)).module)&&"calendar"!==n.module&&"event"!==n.module&&"2"!==a.id&&!t.is("public",a)&&(n.permissions=_(a.permissions).filter(function(e){return!!(268435456&e.bits)}));var r={action:"new",autorename:!0,folder_id:i};return"event"!==n.module&&(r.tree=m(i)),e.PUT({module:"folders",params:r,data:n,appendColumns:!1}).then(function(e){return P(e)}).then(function(e){return(k(n.module)?B({module:n.module,cache:!1}):L(i,{cache:!1})).then(function(){return e})}).done(function(e){o.visible(e)||te.trigger("warn:hidden",e)}).done(function(e){ee.getModel(i).set("subscr_subflds",!0),re.refresh(),te.trigger("create",e),te.trigger("create:"+i.replace(/\s/g,"_"),e)}).fail(function(e){te.trigger("create:fail",e,i)})})},remove:function(t){_.isArray(t)||(t=[t]);var i,o={};return _(t).each(function(e){var t=ee.getModel(e),i=o[e]=t.toJSON();te.trigger("before:remove",i),t.set("unread",0),j(t),delete ee.models[e],t.trigger("destroy")}),i={action:"delete",failOnError:!0,tree:m(t[0]),extendedResponse:!0},e.PUT({module:"folders",params:i,data:t,appendColumns:!1}).done(function(e){e=e||[],_(t).each(function(t,i){var n=o[t];if(te.trigger("remove",t,n),te.trigger("remove:"+t,n),te.trigger("remove:"+n.module,n),!k(n.module))if(te.is("trash",n)||e[i]&&_.isEmpty(e[i].new_path))te.pool.removeCollection(t,{removeModels:!0});else{se.push(t);var a=e[i]?e[i].new_path:t;te.get(a,{cache:!1}).fail(function(e){"FLD-0008"!==e.code&&"IMAP-1002"!==e.code||te.pool.removeCollection(t,{removeModels:!0})}).always(function(){se=_(se).without(t)})}r.is("trash",t)&&te.trigger("cleared-trash")})}).fail(function(){_(t).each(function(e){te.trigger("remove:fail",e)}),Q()})},restore:function(t){_.isArray(t)||(t=[t]);var i=[];return _(t).each(function(e){var t=e.get("id");i.push(t),_(te.pool.collections).invoke("remove",e),e.set("unread",0)}),e.PUT({module:"folders",params:{action:"restore",tree:m(i[0])},data:i,appendColumns:!1}).done(function(){_(t).each(function(e){var t=e.get("id");te.get(t,{cache:!1}).done(function(){Q(),te.trigger("restore",e.toJSON())}).fail(function(t){"FLD-0008"!==t.code&&"IMAP-1002"!==t.code||j(e)})})}).fail(function(){_(t).each(function(e){te.propagate("restore:fail",e.toJSON())})})},isBeingDeleted:function(e){return _(se).contains(e)},clear:function(t){return te.trigger("before:clear",t),e.PUT({module:"folders",appendColumns:!1,params:{action:"clear",tree:m(t)},data:[t]}).done(function(){(te.pool.models[t]&&te.pool.models[t].is("trash")||r.is("trash",t))&&(te.pool.collections[t]&&te.pool.collections[t].each(function(e){te.pool.removeCollection(e.id,{removeModels:!0})}),te.trigger("cleared-trash")),te.trigger("clear",t),Q()})},reload:K,hide:Y,show:X,toggle:function(e,t){!0===t?X(e):Y(e)},refresh:Q,bits:t.bits,is:t.is,can:t.can,supports:t.supports,virtual:re,isVirtual:y,isExternalFileStorage:function(e){return 14===(e instanceof Backbone.Model?e.get("type"):e.type)},isFlat:k,isNested:function(e){return/^(mail|infostore)$/.test(e)},getFlatCollection:O,getFlatViews:V,getDefaultFolder:t.getDefaultFolder,getExistingFolder:function(e){var i=t.getDefaultFolder(e);return i?$.Deferred().resolve(i):"mail"===e?$.Deferred().resolve("default0"+Z()+"INBOX"):"infostore"===e?$.Deferred().resolve(10):B({module:e}).then(function(e){for(var t in e)if("hidden"!==t){var i=e[t];if(i&&i[0]&&i[0].id)return i[0].id}return null})},getStandardMailFolders:function(){var e=_(r.getStandardFolders()).filter(function(e){return!/^default0/.test(e)}),t=r.getInbox(),i=ee.getCollection(t);return _(i.pluck("id")).filter(r.isStandardFolder).concat(e)},getDefaultSeparator:Z,getMailFolderSeparator:function(e){var t=e.split(Z())[0],i=p.get("separators")||{};return/^default\d+$/.test(t)?(t=t.replace("default",""),i[t]?i[t]:Z()):"/"},getTextNode:function(e){var t=document.createTextNode("");return P(e).done(H.bind(t)),t},getDeepLink:function(e){var t="io.ox/"+("infostore"===e.module?"files":e.module),i=encodeURIComponent(e.id);return ox.abs+ox.root+"/#!&app="+t+"&folder="+i},getFolderTitle:n,ignoreSentItems:function(e){return _.isArray(e)&&1!==e.length?W(e)?e:_(e).filter(G):e},processListResponse:E,changeUnseenCounter:le,setUnseenCounter:function(e,t){ee.getModel(e).set("unread",Math.max(0,t))},setUnseenMinimum:function(e,t){var i=ee.getModel(e);i.set("unread",Math.max(t||0,i.get("unread")))},getSection:function(e){return 3===e?"shared":2===e?"public":"private"},Bitmask:a,propagate:N,altnamespace:de,injectIndex:v,multipleLists:function(t,i){try{return e.pause(),$.when.apply($,_(t).map(function(e){return L(e).then(null,function(t){return t.id=e,$.when(i.errors?t:void 0)})})).then(function(){var e=[];return _(arguments).toArray().forEach(function(t){Array.prototype.push.apply(e,t)}),e})}finally{e.resume()}}}),te}),define("io.ox/core/folder/node",["io.ox/backbone/views/disposable","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/api/account","settings!io.ox/core","settings!io.ox/contacts","gettext!io.ox/core"],function(e,t,i,o,n,a,r){var s=e.extend({tagName:"li",className:"folder selectable",indentation:_.device("smartphone")?15:30,events:{"click .folder-options":"onOptions","click .folder-arrow":"onArrowClick","dblclick .folder-label":"onToggle","mousedown .folder-arrow":"onArrowMousedown",keydown:"onKeydown"},addA11yDescription:function(e){this.options.a11yDescription.push(e),this.options.a11yDescription=_.uniq(this.options.a11yDescription),this.renderTooltip()},getA11yDescription:function(){return _.isEmpty(this.options.a11yDescription)?"":". "+this.options.a11yDescription.join(".")},list:function(){var e=this.options;return t.list(e.model_id,{all:e.tree.all})},reset:function(){if(this.isReset)return this.trigger("reset");this.collection.fetched?this.onReset():this.list()},getFilter:function(){var e=this.options,t=e.filter?this:e.tree;return(e.filter||e.tree.filter).bind(t,e.model_id)},onReset:function(){var e=this.options,t=this.collection.filter(this.getFilter()),i={};this.$.subfolders.children().each(function(){i[$(this).attr("data-id")]=$(this).detach().data("view")}),this.$.subfolders.append(t.map(function(e){return(i[e.id]||this.getTreeNode(e).render()).$el},this)),"1"!==this.folder&&"default0"!==this.folder&&this.modelSetSubfolders(t.length>0),this.renderEmpty(),this.$.subfolders.children().each(function(){var t=$(this).data("view");t&&!i[t.folder]&&e.tree.appear(t)}),this.isReset=!0,this.trigger("reset")},onAdd:function(e){if(this.getFilter()(e)){var t=this.getTreeNode(e);this.$.subfolders.append(t.render().$el),this.options.tree.appear(t),this.modelSetSubfolders(!0),this.renderEmpty()}else this.renderEmpty()},onRemove:function(e){this.$.subfolders.children('[data-id="'+$.escape(e.attributes&&e.attributes.id?e.attributes.id:e.id)+'"]').remove(),this.renderEmpty()},onChangeId:function(e){var i=String(e.get("id")),o=String(e.previous("id")),n=this.options.tree.selection.get();this.folder===o&&(this.folder=i),this.options.model_id===o&&(this.options.model_id=i),this.options.contextmenu_id===o&&(this.options.contextmenu_id=i),this.renderAttributes(),o===n&&this.options.tree.trigger("change",i),this.options.open=!1,this.collection&&(this.collection=t.pool.getCollection(i),this.isReset=!1,this.reset()),this.onChangeSubFolders()},onChange:function(e){void 0!==e.changed.title&&this.renderFolderLabel(),void 0!==e.changed.id&&this.onChangeId(e),e.changed.subfolders&&(e.changed.subfolders||(this.open=!1),this.onChangeSubFolders()),this.repaint()},toggle:function(e,t){if(null!==this.options){var i=this.options.open!==e;this.options.open=e,this.onChangeSubFolders(),this.renderCounter(),i&&this.options.tree.trigger(e?"open":"close",this.folder,t)}},onToggle:function(e){e.isDefaultPrevented()||(e.preventDefault(),this.toggle(!this.options.open))},isOpen:function(){return this.options.open&&this.hasSubFolders()},hasArrow:function(){return 0===this.$.arrow.find("i.fa-fw").length},onArrowClick:function(e){$(e.target).closest(this.$.arrow).length&&this.hasArrow()?this.onToggle(e):e.preventDefault()},onArrowMousedown:function(e){$(e.target).closest(this.$.arrow).length&&this.hasArrow()&&e.preventDefault()},onOptions:function(e){e.preventDefault()},hasSubFolders:function(){var e=/^virtual\/flat/.test(this.folder);return this.options.subfolders&&(e||!0===this.modelGetSubfolders())},modelGetSubfolders:function(){return this.model.get(this.options.tree.all?"subfolders":"subscr_subflds")},modelSetSubfolders:function(e){return this.model.set(this.options.tree.all?"subfolders":"subscr_subflds",e)},onChangeSubFolders:function(){var e=this.hasSubFolders(),t=this.isOpen(),i="fa-fw";e&&(i=t?"fa-caret-down":"fa-caret-right"),this.$.arrow.toggleClass("invisible",!e).html($('<i class="fa" aria-hidden="true">').addClass(i)),e&&!this.options.headless?this.$el.attr("aria-expanded",t):this.$el.removeAttr("aria-expanded"),this.$el.toggleClass("open",t),this.renderEmpty(),t&&this.reset()},onKeydown:function(e){if(!e.isDefaultPrevented()&&/^(13|32|37|39)$/.test(e.which)&&(e.preventDefault(),this.hasSubFolders()||!/^(13|32|39)$/.test(e.which))){var t=this.options;/^(13|32)$/.test(e.which)&&this.isVirtual?this.toggle(!t.open):39===e.which?t.open||39!==e.which?this.$el.find("ul.subfolders:first > li:first-child").trigger("click"):this.toggle(!0):37===e.which&&(t.open?this.toggle(!1):t.indent&&t.level>=0&&t.parent.$el.trigger("click"))}},getTreeNode:function(e){var t=e.id||e.attributes.id,i=this.options,o=i.headless||!1===i.indent?i.level:i.level+1,n=i.namespace||0===i.folder.indexOf("virtual/favorites")?"favorite":"",a={folder:t,icons:this.options.icons,iconClass:this.options.iconClass,level:o,tree:i.tree,parent:this,namespace:n};return new s(i.tree.getTreeNodeOptions(a,e))},functions:function(){this.onSort=_.debounce(function(){if(this.$){var e={};this.$.subfolders.children().each(function(){e[$(this).attr("data-id")]=$(this)}),this.$.subfolders.append(this.collection.map(function(t){return e[t.id]}))}},10),this.repaint=_.throttle(function(){null!==this.model&&this.render()},10)},initialize:function(e){this.functions(),this.folder=String(e.folder);var o=this.options=_.extend({arrow:!0,count:void 0,empty:!0,headless:!1,icons:!1,iconClass:void 0,indent:!0,level:0,model_id:this.folder,namespace:"",contextmenu_id:this.folder,open:!1,sortable:!1,subfolders:!0,title:"",a11yDescription:[]},e);this.model=t.pool.getModel(o.model_id),this.noSelect=!this.model.can("read"),this.isVirtual=this.options.virtual||/^virtual/.test(this.folder)||"cal://0/allPublic"===this.folder,this.collection=t.pool.getCollection(o.model_id,o.tree.all),this.isReset=!1,this.realNames=e.tree.realNames,this.id=_.uniqueId(o.tree.id+"-node-"),this.$={},this.$el.data("view",this),_(o.tree.open).contains((o.namespace?o.namespace+":":"")+this.folder)&&(o.open=!0),o.subfolders&&(this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,"change:subscribed":this.onReset,reset:this.onReset,sort:this.onSort}),this.listenTo(t,"create:"+String(o.model_id).replace(/\s/g,"_"),function(){this.open=!0,this.onChangeSubFolders()})),this.listenTo(this.model,{change:this.onChange,"change:subfolders":this.onChangeSubFolders,destroy:this.destroy.bind(this)});var n=0;"visible-selection-smartphone"===o.tree.options.highlightclass&&(n=22),this.$el.attr({id:this.id,"data-id":this.folder,"data-model":o.model_id,"data-contextmenu-id":o.contextmenu_id,"data-namespace":o.namespace,"aria-label":this.getTitle()}).append(this.$.selectable=$('<div class="folder-node" aria-hidden="true">').css("padding-left",o.level*this.indentation+n).append(this.$.arrow=o.arrow?$('<div class="folder-arrow invisible"><i class="fa fa-fw" aria-hidden="true"></i></div>'):[],this.$.icon=$('<div class="folder-icon"><i class="fa fa-fw" aria-hidden="true"></i></div>'),$('<div class="folder-label">').append(this.$.label=$('<div role="presentation">').text(this.getTitle())),this.$.counter=$('<div class="folder-counter">'),this.$.buttons=$('<div class="folder-buttons">')),this.$.subfolders=$('<ul class="subfolders" role="group">')),o.headless?(this.$el.removeClass("selectable"),this.$.selectable.remove(),this.$.subfolders.attr("role","presentation")):this.$el.attr({"aria-selected":!1,role:"treeitem",tabindex:"-1"}),o.sortable&&this.$el.attr("data-sortable",!0),this.noSelect&&o.level>0&&this.$el.addClass("no-select"),this.isVirtual&&this.$el.addClass("virtual"),(!this.isVirtual||o.contextmenu)&&o.tree.options.contextmenu&&o.tree.app&&this.renderContextControl(),this.isVirtual||t.get(o.model_id),(!1===o.empty&&!1===o.open||this.isVirtual)&&this.reset();var a=this.model.toJSON(),r=i.Baton({view:this,data:a});i.point("io.ox/core/foldertree/node").invoke("initialize",this.$el,r),o.tree.options.customize.call(this.$el,r),o.tree.options.disable(a,o)&&this.$el.addClass("disabled"),this.$el.on("dispose",this.remove.bind(this))},getCounter:function(){var e=0;return!this.options.open&&this.options.subfolders&&this.model.get("subtotal")&&(e=this.model.get("subtotal")),void 0!==this.options.count?this.options.count:(this.model.get("unread")||0)+e},showStatusIcon:function(e,t,i){var o=this;this.$.accountLink?e&&this.$.accountLink.attr("title",e):(this.$.selectable.append(this.$.accountLink=$('<a href="#" class="account-link">').attr("data-id",this.options.model_id).append('<i class="fa fa-exclamation-triangle">')),this.$.accountLink.on("click",function(e){e.preventDefault(),o.options.tree.trigger(t,i)}),e&&this.$.accountLink.attr("title",e))},hideStatusIcon:function(){this.$.accountLink&&(this.$.accountLink.remove(),this.$.accountLink=null)},renderCounter:function(){var e=this.getCounter();this.$.selectable.toggleClass("show-counter",e>0),e>999&&(e="999+"),this.$.counter.text(0===e?"":e)},getTitle:function(){var e=this.model.get("display_title")||this.options.title||this.model.get("title")||"";return!0===this.realNames?this.model.get("folder_name")||e:e},renderTooltip:function(){if(!this.options.title&&this.model.has("title")){var e=[],i=[];if(this.model.supports("count_total")){var n=this.model.toJSON();o.isUnifiedRoot(this.model.get("id"))&&(n=_.pick(n,"title")),_.isNumber(n.total)&&n.total>=0&&(t.is("contacts",n)&&"6"===n.id&&!a.get("showAdmin",!1)&&(n.total=n.total-1),e.push(r("Total: %1$d",n.total)),n.total>0&&i.push(r("%1$d total",n.total))),_.isNumber(n.unread)&&n.unread>=0&&(e.push(r("Unread: %1$d",n.unread)),n.unread>0&&i.push(r("%1$d unread",n.unread))),e=e.join(", "),i=i.reverse().join(", "),e&&(e=" ("+e+")"),i&&(i=", "+i+". "+r("Right click for more options."))}this.$el.attr("aria-label",this.getTitle()+i+this.getA11yDescription()),this.$.selectable.attr("title",this.getTitle()+e)}},renderContextControl:function(){if(_.device("smartphone"))return this.$el.attr("data-contextmenu",this.options.contextmenu||"default");var e=this.getTitle();this.$el.attr("aria-haspopup",!0),this.$.selectable.append($('<a tabindex="-1" href="#" role="button" class="folder-options contextmenu-control" data-toggle="dropdown">').attr({"data-contextmenu":this.options.contextmenu||"default",title:e?r("Actions for %1$s",e):r("Folder-specific actions")}).append($('<i class="fa fa-bars" aria-hidden="true">')))},renderFolderLabel:function(){this.$.label.text(this.getTitle())},renderAttributes:function(){this.$el.attr({"data-id":this.folder,"data-model":this.options.model_id,"data-contextmenu-id":this.options.contextmenu_id,"data-favorite":this.options.inFavorites})},isEmpty:function(){return 0===this.$.subfolders.children().length},renderEmpty:function(){!1===this.options.empty&&(this.$el.toggleClass("empty",this.isEmpty()),"virtual/favorites/infostore"===this.model.get("id")&&this.$el.toggleClass("show-anyway",!!this.collection.length))},renderIcon:function(){var e,i,a,r,s=this.options,l=s.iconClass;if(("infostore"===s.tree.module||s.icons)&&/^(mail|infostore|notes)$/.test(s.tree.module)){if("mail"===s.tree.module)return e=o.getType(this.folder)||"default",void this.$.icon.addClass("visible "+e);if(l)l="visible "+l;else{switch(i=String(t.getDefaultFolder("infostore")),a=n.get("folder/mailattachments",{}),r=String(a.all),this.folder){case"virtual/myshares":l="visible myshares";break;case"virtual/favorites/infostore":l="visible myfavorites";break;case r:l="visible attachments";break;case i:l="visible myfiles"}!l&&t.is("trash",this.model.attributes)&&this.model.get("standard_folder")&&(l="visible trash")}this.$.icon.addClass(l)}},render:function(){if(this.renderAttributes(),this.renderEmpty(),this.renderTooltip(),this.renderCounter(),this.renderIcon(),this.onChangeSubFolders(),this.model)return i.point("io.ox/core/foldertree/node").invoke("draw",this.$el,i.Baton({view:this,data:this.model.toJSON()})),this},destroy:function(){var e=this.options.parent;this.$el.remove(),e.renderEmpty&&e.renderEmpty()},remove:function(){this.stopListening(),this.collection=this.model=this.options=this.$=null}});return s}),define("io.ox/core/folder/selection",[],function(){function e(e){this.view=e,this.view.$el.on("click contextmenu",".selectable",$.proxy(this.onClick,this)).on("keydown",".selectable",$.proxy(this.onKeydown,this)).on("mousedown contextmenu",".selectable",function(e){e.preventDefault()}),e.options.dblclick&&this.view.$el.on("dblclick",$.proxy(this.onDblClick,this)),this.view.$el.addClass("dropzone").attr("data-dropzones",".selectable").on("drop",function(t,i){i&&(i.dropType=e.module,e.selection.trigger("selection:drop",i))}),this.selectableVirtualFolders={},this.unselectableFolders={}}return _.extend(e.prototype,{byId:function(e,t,i){var o=(t=t||this.getItems()).filter('[data-id="'+$.escape(e)+'"]'),n=o.first();return 1!==o.length&&o.each(function(){i&&$(this).parentsUntil(".tree-container",".folder.favorites").length?n=$(this):i||$(this).parentsUntil(".tree-container",".folder.favorites").length||(n=$(this))}),n},get:function(e){return this.view.$el.find(".selectable.selected").attr(e||"data-id")},set:function(e,t){var i=this.getItems(),o=this.byId(e,i,t),n=i.index(o);-1!==n&&this.get()!==e&&(this.uncheck(i),this.pick(n,i,{focus:!1}))},preselect:function(e){var t=this.check(this.byId(e));return t.length>0&&(this.view.$container.attr("aria-activedescendant",t.attr("id")),!0)},scrollIntoView:function(e){var t=this.byId(e);t.length&&(t[0].scrollIntoView(!0),this.view.trigger("scrollIntoView",e))},onClick:function(e){if(!$(e.target).is(":checkbox")&&!e.isDefaultPrevented()&&(e.preventDefault(),(!this.view.app||!this.view.app.props||!0!==this.view.app.props.get("mobileFolderSelectMode")||$(e.target).parent().hasClass("folder-label"))&&("contextmenu"===e.type&&e.stopPropagation(),"contextmenu"!==e.type||0!==e.which))){var t=this.getItems(),i=$(e.currentTarget),o=t.index(i)||0;this.view.trigger("selection:action",t,o),this.view.app&&"io.ox/files"===this.view.app.get("name")&&"9"===this.view.app.folder.get()&&i.removeClass("selected"),i.hasClass("selected")||(this.resetTabIndex(t,t.eq(o)),this.uncheck(t),this.pick(o,t))}},onDblClick:function(e){if(!($(e.target).is(":checkbox")||$(e.target).closest(".contextmenu-control").length>0)){var t=$(e.target).closest(".folder").attr("data-id");this.triggerEvent("dblclick",e,t)}},onKeydown:function(e){if(/38|40/.test(e.which))return $(e.target).hasClass("contextmenu-control")?e.preventDefault():void($(e.target).hasClass("selectable")&&this.onCursorUpDown(e))},onCursorUpDown:function(e){var t=this.getItems().filter(":visible"),i=$(document.activeElement),o=38===e.which,n=(t.index(i)||0)+(o?-1:1);if(!(n>=t.length||n<0||e.isDefaultPrevented())){if(e.preventDefault(),this.view.trigger("selection:action",t,n),e.altKey&&"true"===i.parent().parent().attr("data-sortable"))return this.move(i,o);this.resetTabIndex(t,t.eq(n)),this.uncheck(t),this.pick(n,t)}},move:function(e,t){t?e.insertBefore(e.prev()):e.insertAfter(e.next()),e.focus();var i=e.parent().parent().attr("data-id"),o=_(e.parent().children(".selectable")).map(function(e){return $(e).attr("data-id")});this.view.trigger("sort sort:"+i,o)},pick:function(e,t,i){var o=_.extend({focus:!0},i).focus?this.focus(e,t):(t||this.getItems()).eq(e);this.check(o),this.view.$container.attr("aria-activedescendant",o.attr("id")),this.triggerEvent("change",t)},resetTabIndex:function(e,t){(e=e.filter('[tabindex="0"]')).not(t).attr("tabindex",-1)},focus:function(e,t){var i=(t=t||this.getItems()).eq(e).attr("tabindex","0").focus();return _.device("chrome")&&i.hide(0,function(){$(this).css("display","")}),i},check:function(e){if(this.view.disposed)return $();var t=this.view.$el.width();return e.addClass("selected").attr({"aria-selected":!0,tabindex:0}).find(".folder-label:first").each(function(){if(1!==e.length||!e.first().attr("data-id")||0!==e.first().attr("data-id").indexOf("virtual/settings")){var i=$(this).position().left,o=t-i-76;$(this).css("max-width",Math.max(o,80))}}).end()},uncheck:function(e){return(e=e||this.getItems()).filter(".selected").removeClass("selected").attr({"aria-selected":!1,tabindex:-1}).find(".folder-label").css("max-width","initial"),this},getItems:function(){return this.view.disposed?$():this.view.$(".selectable")},addSelectableVirtualFolder:function(e){this.selectableVirtualFolders[e]=!0},addUnselectableFolder:function(e){this.unselectableFolders[e]=!0},triggerEvent:_.debounce(function(e){"change"===e?this.triggerChange.apply(this,_(arguments).toArray().splice(1)):this.view.trigger.apply(this.view,arguments)},300),triggerChange:function(e){var t=this,i=(e||this.getItems()).filter(".selected").first(),o=i.attr("data-id"),n=i.attr("data-show-in-drive"),a=/^virtual/.test(o);n?require(["io.ox/core/extensions","io.ox/files/api","io.ox/backbone/views/actions/util"]).then(function(e,i,n){var a=i.pool.get("detail").get(o);n.invoke("io.ox/files/actions/show-in-folder",e.Baton({models:[a],app:t.view.app,alwaysChange:!0}))}):t.view&&!t.unselectableFolders[o]&&t.view.trigger(a&&!t.selectableVirtualFolders[o]?"virtual":"change",o,i)}}),e}),define("io.ox/core/folder/tree",["io.ox/backbone/views/disposable","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/contextmenu-utils","io.ox/core/folder/selection","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/a11y","settings!io.ox/core","gettext!io.ox/core","io.ox/core/folder/favorites","io.ox/files/favorites","io.ox/core/folder/extensions"],function(e,t,i,o,n,a,r,s,l){return e.extend({attributes:{role:"navigation"},className:"folder-tree",events:{"click .contextmenu-control":"onToggleContextMenu",'contextmenu .folder.selectable[aria-haspopup="true"]':"onContextMenu",'keydown .folder.selectable[aria-haspopup="true"]':"onKeydownMenuKeys","keydown .folder.selectable":"onKeydown","click .folder.selectable.selected":"onClick"},initialize:function(e){e=_.extend({context:"app",contextmenu:!1,customize:$.noop,disable:$.noop,abs:!0,icons:s.get("features/folderIcons",!1),root:"default0/INBOX",highlight:_.device("!smartphone"),highlightclass:"visible-selection",hideTrashfolder:!1,realNames:!1},e),this.all=!!e.all,this.app=e.app,this.context=e.context,this.flat=!!e.flat,this.module=e.module,this.open=e.open,this.root=e.root,this.realNames=e.realNames,this.id=_.uniqueId("folder-tree-"),this.$el.data("view",this),this.$container=$('<ul class="tree-container f6-target" role="tree">').attr("id",this.id),this.$el.attr("aria-label",l("Folders")),this.$dropdownMenu=$(),this.options=e,this.$el.toggleClass(e.highlightclass,!!e.highlight),this.$el.append(this.$container),this.selection=new o(this),e.abs&&this.$el.addClass("abs"),e.contextmenu&&_.defer(this.renderContextMenu.bind(this))},appear:function(e){var t=e.folder.replace(/\s/g,"_");this.trigger("appear:"+t,e)},onClick:function(e){$(document.activeElement).is(".folder.selectable.selected")||$(e.currentTarget).focus()},onAppear:function(e,t){var i=this.getNodeView(e);if(i)return t.call(this,i);e=String(e).replace(/\s/g,"_"),this.once("appear:"+e,t)},preselect:function(e){void 0!==e&&this.onAppear(e,function(){_.defer(this.selection.set.bind(this.selection,e)),this.trigger("afterAppear")})},traversePath:function(e,t){var i=this;n.path(e).then(function(e){return _(e).pluck("id").forEach(t.bind(i))})},select:function(e){function t(){var e=i.shift(),n=o.getNodeView(e);if(!i.length)return o.selection.set(e);n&&(n.once("reset",t),n.toggle(!0))}var i=[],o=this;n.path(e).done(function(e){i=_(e).pluck("id"),t()})},getNodeView:function(e){return this.$('.folder[data-id="'+$.escape(e)+'"]').data("view")},filter:function(e,t){if(this.options.hideTrashfolder&&n.is("trash",t.attributes))return!1;var i=this.options.filter,o=_.isFunction(i)?i.apply(this,arguments):void 0;if(void 0!==o)return o;var a=t.get("module");return"event"===a&&(a="calendar"),a===this.module||"mail"===this.module&&/^default\d+(\W|$)/i.test(t.id)},getOpenFolders:function(){return _(this.$el.find(".folder.open")).chain().map(function(e){return($(e).attr("data-namespace")?$(e).attr("data-namespace")+":":"")+$(e).attr("data-id")}).uniq().value().sort()},getTreeNodeOptions:function(e,t){return"default0/INBOX"===t.get("id")&&"virtual/standard"===e.parent.folder&&(e.subfolders=!!n.altnamespace),this.flat&&e.parent!==this&&(e.subfolders=!1),"virtual/standard"===e.parent.folder&&(e.icons=!0),"virtual/favorites/infostore"===e.parent.folder&&(e.inFavorites=!0),e},toggleContextMenu:function(e){this.dropdown.$el.hasClass("open")||_.device("smartphone")||(e.target.is("a.contextmenu-control")||(e.target=e.target.find(".contextmenu-control").first()),_.defer(function(){this.$dropdownMenu.css({top:e.top,left:e.left,bottom:"auto"}).empty().busy(),this.dropdown.$toggle=e.target,this.$dropdownToggle.dropdown("toggle")}.bind(this)))},onToggleContextMenu:function(e){var t=$(e.target).is("a")&&"keydown"===e.type?$(e.target):$(e.currentTarget),i=t.offset(),o=i.top-7,n=i.left+t.outerWidth()+7;this.toggleContextMenu({target:t,top:o,left:n})},onKeydown:function(e){/35|36/.test(e.which)&&(36===e.which?this.$el.find("li.folder.selectable:visible:first").trigger("click"):35===e.which&&this.$el.find("li.folder.selectable:visible:last").trigger("click"))},onKeydownMenuKeys:function(e){if(i.macOSKeyboardHandler(e),"keydown"===e.type){var t=e.shiftKey&&121===e.which,o=93===e.which;(/13|32|38|40/.test(e.which)||t||o)&&(this.focus=/38/.test(e.which)?"li:last > a":"li:first > a"),t&&e.isKeyboardEvent&&this.onContextMenu(e)}},onContextMenu:function(e){e.stopPropagation(),this.toggleContextMenu(i.positionForEvent(e))},getContextMenuId:function(e){return"io.ox/core/foldertree/contextmenu/"+(e||"default")},renderContextMenuItems:function(e){var t=this.selection.get("data-contextmenu-id"),i=this.app,o=this.module,r=this.$dropdownMenu.empty(),s=this.getContextMenuId(e),d=this,c=this.selection.get("data-favorite");n.get(t).done(function(e){var t=new a.Baton({app:i,data:e,view:d,module:o,originFavorites:c});a.point(s).invoke("draw",r,t),_.device("smartphone")&&(r.append($("<li>").append($('<a href="#" class="io-ox-action-link" data-action="close-menu">').text(l("Close")))),0===r.find("[role=menuitem]").length&&r.prepend($("<li>").append($('<div class="custom-dropdown-label">').text(l("No action available"))))),_.device("smartphone")&&r.find(".divider").remove(),r.find(".divider").each(function(){var e=$(this),t=e.next();(0===e.prev().length||t.hasClass("divider")||0===t.length)&&e.remove()}),_.device("smartphone")||d.dropdown.setDropdownOverlay(),d.focus&&r.find(d.focus).focus(),d.focus=!1})},renderContextMenu:function(){function e(e){this.$dropdownMenu.idle(),this.renderContextMenuItems(e)}function i(){var t=this.dropdown.$toggle.attr("data-contextmenu")||this.selection.get("data-contextmenu");require(["io.ox/core/folder/contextmenu"],_.lfo(e.bind(this,t))),this.$dropdownMenu.attr("role","menu")}function o(){this.dropdown.$toggle.parents("li").first().focus()}return function(){this.$dropdownToggle=$('<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true">').attr("aria-label",l("Folder options")),this.$dropdownMenu=$('<ul class="dropdown-menu">'),this.dropdown=new t({smart:!1,className:"context-dropdown dropdown",$toggle:this.$dropdownToggle,$ul:this.$dropdownMenu,margin:24}),this.$el.after(this.dropdown.render().$el.on("show.bs.dropdown",i.bind(this)).on("hidden.bs.dropdown",o.bind(this))),this.$dropdownMenu.removeAttr("role")}}(),render:function(){return a.point("io.ox/core/foldertree/"+this.module+"/"+this.context).invoke("draw",this.$container,this),this}})}),define("io.ox/core/folder/favorites",["io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/extensions","io.ox/core/upsell","settings!io.ox/core","gettext!io.ox/core","io.ox/files/favorites"],function(e,t,i,o,n,a){function r(e){return"calendar"===e&&void 0===n.get("favorites/chronos")&&l(),n.get(s(e),[])}function s(e){return"favorites/"+("calendar"===e?"chronos":e)}function l(){var e=_(n.get("favorites/calendar",[])).map(function(e){return"cal://0/"+e});n.set("favorites/chronos",e).save()}function d(e,i){return e.filter(function(e){var o=e.get("id");if(o)return 0===o.indexOf(i+t.getMailFolderSeparator(o))})}function c(e,i,o){if(i=i||t.pool.getModel(e),o=o||i.get("module")){var n="virtual/favorites/"+o;t.pool.getCollection(n).remove(i),t.trigger("favorite:remove")}}function u(e,i){if((i=i||t.pool.getModel(e)).get("module")){var o="virtual/favorites/"+i.get("module"),n=t.pool.getCollection(o);i.set("index/"+o,!0,{silent:!0}),n.add(i),n.sort(),t.trigger("favorite:add")}}function p(e){u(e.data.id)}function f(e){c(e.data.id,void 0,e.data.module)}function h(e,t){return $('<a href="#" role="menuitem" tabindex="-1">').attr("data-action",e).text(t).on("click",$.preventDefault)}function g(e){return e.attr("aria-disabled",!0).removeAttr("tabindex").addClass("disabled")}function m(e,t){if("infostore"!==t.data.module){var i=h(t.action,t.text);return t.enabled?i.on("click",t.data,t.handler):g(i),e.append($('<li role="presentation">').append(i)),i}}return _("mail contacts calendar tasks".split(" ")).each(function(l){function c(e){n.set(s(l),e).save()}function u(){c(_(h.pluck("id")).filter(function(e){return!g[e]}))}if(("mail"!==l||o.has("webmail"))&&("mail"===l||o.has(l))){var p="virtual/favorites/"+l,f=t.pool.getModel(p),h=t.pool.getCollection(p),g={};t.virtual.add(p,function(){var e=!h.expired&&h.fetched;return t.multiple(r(l),{errors:!0,cache:e}).then(function(e){var i=_(e).filter(function(e){return e.error&&/^(FLD-0008|FLD-0003|ACC-0002|FLD-1004|IMAP-1002|FILE_STORAGE-0004)$/.test(e.code)?(g[e.id]=!0,!1):(delete g[e.id],!0)});return _(i).each(t.injectIndex.bind(t,p)),f.set("subscr_subflds",i.length>0),i.length!==e.length&&_.defer(u),i})}),h.on("add",function(e){delete g[e.id]}),h.on("add remove change:id",u),"mail"===l?(t.on("rename",function(e,t){"mail"===t.module&&d(h,e).forEach(function(i){i.set("id",t.id+i.get("id").substr(e.length)),u()})}),t.on("remove:mail",function(e){d(h,e.id).forEach(function(e){h.remove(e),u()})})):"infostore"===l&&(f.set("title",a("Favorites")),f.set("folder_id","9"),f.set("own_rights",1),f.set("standard_folder",!0));var m={id:"favorites",index:1,draw:function(i){this.append(new e({empty:!1,folder:p,indent:!t.isFlat(l),open:!1,parent:i,sortable:!0,title:a("Favorites"),tree:i,icons:i.options.icons}).render().$el.addClass("favorites")),i.on("sort:"+p,c)}};i.point("io.ox/core/foldertree/"+l+"/app").extend(_.extend({},m)),i.point("io.ox/core/foldertree/"+l+"/popup").extend(_.extend({},m))}}),t.on("collection:remove",function(e,t){c(e,t)}),i.point("io.ox/core/foldertree/contextmenu/default").extend({id:"toggle-favorite",index:1010,draw:function(e){var i=e.data.id,o=e.module,n=r(o),s=_(n).indexOf(i)>-1;t.is("trash",e.data)||m(this,{action:"toggle-favorite",data:{id:i,module:o},enabled:!0,handler:s?f:p,text:a(s?"Remove from favorites":"Add to favorites")})}}),{add:u,remove:c}}),define("io.ox/core/folder/view",["io.ox/core/extensions","io.ox/core/folder/api","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,o){return{initialize:function(n){function a(){p.settings.set("folderview/visible/"+_.display(),m).save()}function r(e){void 0===e?p.settings.remove("folderview/width/"+_.display()):p.settings.set("folderview/width/"+_.display(),e),p.settings.save()}function s(){return p.settings.get("folderview/width/"+_.display(),k)}function l(e){var t=void 0===e?"":e+"px";x.body.css("left",t),x.sidepanel.css("width",t)}function d(){l(s())}function c(){var e=p.getWindow().options.chromeless,t=$(document).width()<=p.folderView.resize.autoHideThreshold;x.body.css("left",e||t?0:50)}function u(e,t,i){if(0!==t)return t!==i.length-1?this.onAppear(e,function(e){e.isOpen()||e.toggle(!0)}):void this.onAppear(e,function(e){e.$el.intoView(this.$el,{ignore:"bottom:partial"})})}var p=(n=_.extend({firstResponder:"listView",autoHideThreshold:700},n)).app,f=n.tree,h=f.options.module,g=p.get("name")+"/folderview",m=!1,v=p.settings.get("folderview/open",{}),x=p.getWindow().nodes,b=x.sidepanel,w=!1,y=!1,k=280;v||(v={},/^(contacts|calendar|event|tasks)$/.test(h)&&(v[_.display()]=["virtual/flat/"+h+"/private","virtual/flat/"+h+"/public"]));var C=function(){$(document).trigger("resize")};if(p.folderView={tree:f,forceOpen:y,isVisible:function(){return m},show:function(){m=!0,w||a(),d(),b.addClass("visible"),p.trigger("folderview:open"),C(),b.css("display","flex")},hide:function(){m=!1,y=!1,w||a(),c(),b.removeClass("visible").css("width",""),p.trigger("folderview:close"),C()},toggle:function(e){void 0===e&&(e=!m),e?this.show():this.hide()},resize:function(){function e(e){var t=e.pageX-o;t>s||t<d||(p.trigger("folderview:resize"),l(a=t),C())}function t(e){$(this).off("mousemove.resize mouseup.resize"),C(),e.pageX-o<.75*d?p.folderView.hide():r(a||k)}function i(i){i.preventDefault(),o=i.pageX-b.width(),s=$(document).width()/2,$(document).on({"mousemove.resize":e,"mouseup.resize":t})}var o,a,s=0,d=240;return{enable:function(){b.append($('<div class="resizebar">').on("mousedown.resize",i))},autoHideThreshold:n.autoHideThreshold}}()},p.folderViewIsVisible=function(){return m},$(window).on("resize",_.throttle(function(){var e=$(document).width();if(x.outer.is(":visible")){var t=p.folderView.resize.autoHideThreshold;!p.folderView.forceOpen&&!w&&m&&e<=t?(p.folderView.hide(),w=!0):w&&e>t&&(p.folderView.show(),w=!1)}},200)),e.point(g+"/options").extend({id:"defaults",index:100,rootFolderId:"1",type:void 0,view:"ApplicationFolderTree",visible:!_.device("smartphone")&&p.settings.get("folderview/visible/"+_.display(),!0)}),h){var S=i.get(["folder/hidden"]);void 0===S&&(S=p.settings.get("folderview/blacklist",{}),_.isObject(S)&&i.set(["folder/hidden"],S).save())}v&&v[_.display()]&&(v=v[_.display()]),v=_.isArray(v)?v:[],f.open=v;var T=p.folder.get();_.device("smartphone")?(f.$el.on("click",".folder",_.debounce(function(e){if("calendar"===f.module){if($(e.target).is(".folder-arrow, .fa, .color-label"))return;if(!i)return void $(e.target).siblings().click()}var t=$(e.target).closest(".folder"),i=p.props.get("mobileFolderSelectMode");if(i){if(!$(e.target).parent().hasClass("folder-label")||!$(e.target).closest(".folder").attr("data-contextmenu"))return;return f.dropdown.$(".dropdown-toggle").trigger("click","foldertree")}t.is(".virtual")&&!0!==f.selection.selectableVirtualFolders[t.data().id]||(n.firstResponder&&p.pages.changePage(n.firstResponder),n.respondCallback&&n.respondCallback())},10)),T&&_.defer(f.selection.preselect.bind(f.selection,T))):T?_.defer(function(){t.path(T).done(function(e){var i=_(e).pluck("id").slice(0,-1),o=_(e).where({id:T})[0],n="6"===o.id?"public":t.getSection(o.type,o.id);if(n&&/(mail|contacts|calendar|tasks|infostore)/.test(f.module)&&f.flat&&"app"===f.context){var a="calendar"===f.module?"event":f.module;i.push("virtual/flat/"+a+"/"+n)}f.open=_(f.open.concat(i)).uniq()}).always(function(){f.onAppear(T,function(){_.defer(function(){f.selection.preselect(T),f.selection.scrollIntoView(T),t.isVirtual(T)&&f.selection.triggerChange()})}),f.render()})}):f.render(),f.$(".tree-container").attr({"aria-label":o("Folders")}),f.$(".tree-container").toggleClass("flat-tree",t.isFlat(f.options.module)),_(e.point(g+"/options").all()).each(function(e){n=_.extend(e,n||{})}),function(){var e=!1;p.on("folder:change",function(t,i,o){e||(f.traversePath(t,u),f.$el.find('[data-id="'+t+'"]').length?f.selection.set(t,o):f.on("appear:"+t,function(){f.selection.set(t,o),f.off("appear:"+t)}))}),f.on("change",function(t){e=!0,p.folder.set(t),e=!1}),f.on("virtual",function(e){p.trigger("folder-virtual:change",e)}),t.on("create",_.debounce(function(e){f.traversePath(e.id,u)},15))}(),t.on("before:remove",function(e){var i=/^(1|2)$/.test(e.folder_id)?t.getDefaultFolder(e.module)||"1":e.folder_id;f.selection.set(i)}),t.on("move",function(e,t){f.traversePath(t,u),f.selection.set(t)}),f.on("open close",function(){var e=this.getOpenFolders();p.settings.set("folderview/open/"+_.display(),e).save()}),window.tree=f,n.visible&&p.folderView.show()}}}),define("io.ox/core/folder/extensions",["io.ox/core/folder/node","io.ox/core/folder/api","io.ox/core/api/account","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/upsell","io.ox/contacts/util","io.ox/core/api/user","io.ox/mail/api","gettext!io.ox/core","io.ox/backbone/mini-views/upsell","io.ox/backbone/mini-views/dropdown","io.ox/core/folder/blacklist","settings!io.ox/core","settings!io.ox/mail","io.ox/core/http","io.ox/core/folder/favorites","io.ox/files/favorites"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f,h,g){function m(){var e=f.get("folder/infostore");return e?t.get(e):null}function v(){if(!n.has("guest")&&n.has("gab || share_links"))return $.when({id:"virtual/myshares",folder_id:"9",module:"infostore",own_rights:403710016,permissions:[{bits:403710016,entity:ox.user_id,group:!1}],standard_folder:!0,supported_capabilities:[],title:d("My shares")})}function x(){var e=F.all;return e?t.get(e):null}function b(e){e.preventDefault(),ox.launch("io.ox/files/main",{folder:F.all}).done(function(){this.folder.set(F.all)})}function w(){return t.list("9").then(function(e){return _(e).filter(function(e){return t.is("trash",e)})})}function y(e){e.preventDefault(),require(["io.ox/mail/accounts/settings"],function(t){t.mailAutoconfigDialog(e)})}function k(e){e.preventDefault(),require(["io.ox/core/settings/user"],function(e){e.openModalDialog()})}function C(){var e=["google","dropbox","boxcom","graph"];return o.point("io.ox/core/folder/storage-accounts/list").invoke("customize",e),require(["io.ox/core/api/filestorage"]).then(function(e){var t=e.rampup().then(function(){return _(e.isStorageAvailable()).map(function(e){return e.match(/\w*?$/)[0]})});return $.when(require(["io.ox/keychain/api"]),t)}).then(function(t,i){return _(t.submodules).filter(function(t){return!(e.indexOf(t.id)<0)&&((!t.canAdd||t.canAdd.apply(this))&&i.indexOf(t.id)>=0)})})}function S(e){e.preventDefault(),require(["io.ox/files/actions/add-storage-account"],function(e){e()})}function T(e){if(e.preventDefault(),n.has("subscription"))"calendar"===e.data.baton.module?require(["io.ox/calendar/actions/subscribe-calendar"],function(t){t(e.data.baton)}):require(["io.ox/core/sub/subscriptions"],function(t){t.buildSubscribeDialog({module:e.data.baton.module,app:e.data.baton.view.app})});else{if(!a.enabled(["subscription"]))return;a.trigger({type:"inline-action",id:"io.ox/core/foldertree/contextmenu/default/subscribe",missing:a.missing(["subscription"])})}}function D(e){e.preventDefault(),ox.load(["io.ox/core/folder/actions/add"]).done(function(t){t(e.data.folder,{module:e.data.module})})}function A(e){require(["io.ox/files/share/permissions"],function(t){t.showFolderPermissions(e.data.id)})}function M(e){var t={id:"io.ox/core/sub",data:e.data.folder,refresh:!0};ox.launch("io.ox/settings/main",t).done(function(){this.setSettingsPane(t)})}function E(e){if("keydown"===e.type){if(32!==e.which)return;e.stopImmediatePropagation()}var t=e.data.target,i=e.data.app,o=e.data.folder;t.closest(".single-selection").length>0||(e.preventDefault(),i.folders.isSelected(o.id)?i.folders.remove(o.id):i.folders.add(o.id),t.toggleClass("selected",i.folders.isSelected(o.id)),t.closest(".folder").attr("aria-checked",i.folders.isSelected(o.id)))}var N="default0"+l.separator+"INBOX";n.has("webmail")&&(t.virtual.add("virtual/standard",function(){var e=h.get("defaultFolder")||{},i=[],o={};return g.pause(),i.push(t.get(N)),o[N]=!0,h.get("features/unseenFolder",!1)&&i.push(t.get("virtual/all-unseen")),["drafts","sent","spam","trash","archive"].forEach(function(a){var r=e[a];r&&!o[r]&&("archive"!==a||n.has("archive_emails"))&&(i.push(t.get(r)),o[r]=!0)}),g.resume(),this.concat.apply(this,i)}),t.virtual.add("virtual/myfolders",function(){var e=t.altnamespace?"default0":N;return t.list(e).then(function(e){return _(e).filter(function(e){return 0!==e.id.indexOf("default0/External accounts")&&(!i.isStandardFolder(e.id)&&!t.is("public|shared",e))})})}),t.on("after:rename",function(e,i){i.folder_id===N&&t.virtual.reload("virtual/myfolders")}),t.virtual.add("virtual/remote",function(){return t.list("1").then(function(e){return _(e).filter(function(e){return i.isExternal(e.id)})})})),n.has("filestore")&&t.virtual.add("virtual/filestorage",function(){return t.list("1").then(function(e){return _(e).filter(function(e){return t.isExternalFileStorage(e)})})});var F=f.get("folder/mailattachments",{});F.all&&p.add(F.all),n.has("infostore")&&(t.virtual.add("virtual/drive/private",function(){return this.concat(m(),v(),x(),w())}),t.virtual.add("virtual/drive/private-without-myshares",function(){return this.concat(m(),x(),w())}),t.virtual.add("virtual/drive/public",function(){return t.list("9").then(function(e){return _(e).filter(function(e){return String(e.id)!==String(f.get("folder/infostore"))&&(!t.is("trash",e)&&!t.isExternalFileStorage(e))})})}));var I={unifiedFolders:function(t){this.append(new e({empty:!1,filter:function(e,t){return/^default/.test(t.id)&&i.isUnified(t.id)},folder:"1",headless:!0,open:!0,tree:t,parent:t}).render().$el.addClass("unified-folders"))},standardFolders:function(t){var o=new e({filter:function(e,t){return!("virtual/all-unseen"!==t.id||!h.get("unseenMessagesFolder"))||i.isStandardFolder(t.id)},folder:"virtual/standard",headless:!0,open:!0,tree:t,parent:t});this.append(o.render().$el.addClass("standard-folders").attr("role","presentation")),o.listenTo(h,"change:unseenMessagesFolder",function(){o.onReset()})},getLocalFolderName:function(){return h.get("features/usePrimaryAccountNameInTree",!0)?i.getPrimaryName()||d("My folders"):d("My folders")},localFolders:function(o){if(!n.has("guest")){var a=t.altnamespace?"default0":N,r=new e({contextmenu:"myfolders",empty:!!t.altnamespace,folder:"virtual/myfolders",icons:o.options.icons,contextmenu_id:a,parent:o,title:I.getLocalFolderName(),tree:o});i.on("update",function(e,t){0===t.id&&(r.options.title=I.getLocalFolderName(),r.renderFolderLabel())}),t.on("create:"+a,function(){r.toggle(!0)}),this.append(r.render().$el)}},remoteAccounts:function(t){this.append(new e({folder:"virtual/remote",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t,isRemote:!0,empty:!1}).render().$el.addClass("remote-folders").attr("role","presentation"))},fileStorageAccounts:function(t){this.append(new e({folder:"virtual/filestorage",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("filestorage-folders").attr("role","presentation"))},addStorageAccount:function(){function e(){C().done(function(e){e.length>0?t.empty().show().append($('<a href="#" data-action="add-storage-account" role="treeitem">').text(d("Add storage account")).on("click",S)):t.hide()})}var t=$('<li class="links" role="presentation">');return function(){this.append(t),require(["io.ox/core/api/filestorage"],function(t){t.off("create delete update",e),t.on("create delete update",e),e()})}}(),subscribe:function(e){if(!e.extension.capabilities||a.visible(e.extension.capabilities)){var t,i=this;require(["io.ox/core/sub/subscriptions"],function(o){"contacts"===e.module&&o.availableServices.contacts&&(t=d("Subscribe to address book"),i.append($('<li role="presentation">').append($('<a href="#" data-action="subscribe-external-account" role="treeitem">').text(t).on("click",{baton:e},T))))})}},treeLinks:function(){if(0!==o.point("io.ox/core/foldertree/mail/treelinks").list().length){var e=$('<ul class="list-unstyled" role="group">');o.point("io.ox/core/foldertree/mail/treelinks").invoke("draw",e),this.append($('<li class="links list-unstyled" role="treeitem">').append(e))}},allAttachments:function(){F.all&&this.append($('<li role="presentation">').append($('<a href="#" data-action="all-attachments" role="treeitem">').text(d("View all attachments")).on("click",b)))},addRemoteAccount:function(){n.has("multiple_mail_accounts")&&this.append($('<li role="presentation">').append($('<a href="#" data-action="add-mail-account" role="treeitem">').text(d("Add mail account")).on("click",y)))},synchronizeAccount:function(){this.append(new c({id:"folderview/mail",className:"links",requires:"active_sync",title:d("Synchronize with your tablet or smartphone")}).render().$el)},otherFolders:function(o){this.append(new e({empty:!1,filter:function(e,o){return!i.isStandardFolder(o.id)&&("default0/virtual"!==o.id&&(!t.altnamespace||t.is("public|shared",o.toJSON())))},folder:"default0",headless:!0,open:!0,icons:o.options.icons,tree:o,parent:o}).render().$el.addClass("other-folders").attr("role","treeitem"))},myContactData:function(){!1!==f.get("user/internalUserEdit",!0)&&this.append($('<li role="presentation">').append($('<a href="#" data-action="my-contact-data" role="treeitem">').text(d("My contact data")).on("click",k)))},rootFolders:function(i){var o={folder:i.root,headless:!0,open:!0,tree:i,parent:i};if(i.options.hideTrashfolder&&(o.filter=function(e,i){return!t.is("trash",i.attributes)}),"infostore"===i.module){var n=o.filter;o.filter=function(e,i){return(!n||n.apply(this,arguments))&&!t.isExternalFileStorage(i)}}this.append(new e(o).render().$el.addClass("root-folders"))},privateDriveFolders:function(t){this.append(new e({folder:"virtual/drive/private",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("private-drive-folders").attr("role","presentation"))},privateDriveFoldersWithoutMyShares:function(t){this.append(new e({folder:"virtual/drive/private-without-myshares",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("private-drive-folders").attr("role","presentation"))},publicDriveFolders:function(t){this.append(new e({folder:"virtual/drive/public",headless:!0,open:!0,icons:t.options.icons,tree:t,parent:t}).render().$el.addClass("public-drive-folders").attr("role","presentation"))}},P=100;return o.point("io.ox/core/foldertree/mail/app").extend({id:"unified-folders",index:P+=100,draw:I.unifiedFolders},{id:"standard-folders",index:P+=100,draw:I.standardFolders},{id:"local-folders",index:P+=100,draw:I.localFolders},{id:"other",index:P+=100,draw:I.otherFolders},{id:"remote-accounts",index:P+=100,draw:I.remoteAccounts},{id:"tree-links",index:P+=100,draw:I.treeLinks},{id:"upsell-mail",index:P+=100,draw:I.synchronizeAccount}),o.point("io.ox/core/foldertree/mail/treelinks").extend({id:"all-attachments",index:P+=100,draw:I.allAttachments},{id:"add-account",index:P+=100,draw:I.addRemoteAccount}),o.point("io.ox/core/foldertree/mail/popup").extend({id:"standard-folders",draw:I.standardFolders},{id:"local-folders",draw:I.localFolders},{id:"other",draw:I.otherFolders},{id:"remote-accounts",draw:I.remoteAccounts}),o.point("io.ox/core/foldertree/mail/subscribe").extend({id:"root-folders",draw:I.rootFolders}),o.point("io.ox/core/foldertree/mail/account").extend({id:"root-folders",draw:I.rootFolders}),o.point("io.ox/core/foldertree/mail/filter").extend({id:"standard-folders",draw:I.standardFolders},{id:"local-folders",draw:I.localFolders},{id:"other",draw:I.otherFolders}),o.point("io.ox/core/foldertree/infostore/app").extend({id:"private-folders",index:100,draw:I.privateDriveFolders},{id:"public-folders",index:200,draw:I.publicDriveFolders},{id:"remote-accounts",index:300,draw:I.fileStorageAccounts},{id:"add-external-account",index:400,draw:I.addStorageAccount}),o.point("io.ox/core/foldertree/infostore/popup").extend({id:"private-folders",index:100,draw:I.privateDriveFoldersWithoutMyShares},{id:"public-folders",index:200,draw:I.publicDriveFolders},{id:"remote-accounts",index:300,draw:I.fileStorageAccounts}),o.point("io.ox/core/foldertree/contacts/links").extend({id:"subscribe",index:300,capabilities:["subscription"],draw:I.subscribe},{id:"my-contact-data",index:400,draw:I.myContactData}),_("contacts calendar tasks".split(" ")).each(function(i){function n(e,t){return a[e][t]}var a={contacts:{private:d("My address books"),public:d("Public address books"),shared:d("Shared address books"),hidden:d("Hidden address books")},calendar:{private:d("My calendars"),public:d("Public calendars"),shared:d("Shared calendars"),hidden:d("Hidden calendars")},tasks:{private:d("My tasks"),public:d("Public tasks"),shared:d("Shared tasks"),hidden:d("Hidden tasks")}},r={id:"standard-folders",index:100,draw:function(a){var r,s,l="calendar"===i?"event":i,d=$('<ul class="list-unstyled" role="group">'),c=o.Baton({module:i,view:a,context:a.context}),u="virtual/flat/"+l,p="flat/"+l,f={count:0,empty:!1,indent:!1,open:!1,tree:a,parent:a,filter:function(e,t){return!!t.get("subscribed")}},h=$('<li role="treeitem">');a.options.noLinks||o.point("io.ox/core/foldertree/"+i+"/links").invoke("draw",d,c),this.append(h),t.flat({module:l,all:"event"===l}).always(function(){r=new e(_.extend({},f,{folder:u+"/private",model_id:p+"/private",title:n(i,"private"),filter:function(e,t){return!!t.get("subscribed")}})),t.pool.getCollection("flat/"+l+"/private").on("add",function(){r.toggle(!0)}),t.pool.getCollection("flat/"+l+"/public").on("add",function(){r.toggle(!0)}),s=new e(_.extend({},f,{folder:u+"/public",model_id:p+"/public",title:n(i,"public")})),h.replaceWith(r.render().$el.addClass("section"),$('<li class="links list-unstyled" role="treeitem">').append(d),s.render().$el.addClass("section"),new e(_.extend({},f,{folder:u+"/shared",model_id:p+"/shared",title:n(i,"shared")})).render().$el.addClass("section"),new e(_.extend({},f,{folder:u+"/hidden",model_id:p+"/hidden",title:n(i,"hidden")})).render().$el.addClass("section"))})}};o.point("io.ox/core/foldertree/"+i+"/app").extend(_.extend({},r)),o.point("io.ox/core/foldertree/"+i+"/popup").extend(_.extend({},r)),"calendar"!==i&&o.point("io.ox/core/foldertree/"+i+"/links").extend({index:200,id:"private",draw:function(e){if("app"===e.context){var i=e.module,o=t.getDefaultFolder(i),n=d("Add new folder");"contacts"===i&&(n=d("Add new address book")),o&&this.append($('<li role="presentation">').append($('<a href="#" data-action="add-subfolder" role="treeitem">').text(n).on("click",{folder:o,module:i},D)))}}})}),o.point("io.ox/core/foldertree/calendar/links/subscribe").extend({id:"default",index:100,draw:function(){var e=t.getDefaultFolder("calendar");e&&this.link("folder",d("Personal calendar"),function(t){t.data={folder:e,module:"event"},D(t)})}},{id:"divider-1",index:200,draw:function(){(n.has("calendar_schedjoules")||n.has("calendar_google")||n.has("calendar_ical"))&&(this.divider(),this.header(d("Subscribe to calendar")))}},{id:"schedjoules",index:300,draw:function(){n.has("calendar_schedjoules")&&this.link("schedjoules",d("Browse calendars of interest"),function(){require(["io.ox/calendar/settings/schedjoules/schedjoules"],function(e){e.open()})})}},{id:"google",index:400,draw:function(){if(n.has("calendar_google")){var e,t;require(["io.ox/calendar/actions/subscribe-google"],function(i){e=i,t.removeClass("hidden")}),this.link("google",d("Google calendar"),function(){e()}),t=this.$ul.find("li").last().addClass("hidden")}}},{id:"ical",index:500,draw:function(){n.has("calendar_ical")&&this.link("ical",d("Subscribe via URL (iCal)"),function(){require(["io.ox/calendar/actions/subscribe-ical"],function(e){e()})})}},{id:"shared",index:500,draw:function(){this.link("shared",d("Subscribe shared Calendar"),function(){require(["io.ox/calendar/actions/subscribe-shared"],function(e){e.open()})})}},{id:"import",index:600,draw:function(){_.device("ios || android")||(this.divider(),this.header(d("Import calendar")),this.link("import",d("Upload file"),function(){require(["io.ox/core/import/import"],function(e){e.show("calendar")})}))}}),o.point("io.ox/core/foldertree/calendar/links").extend({index:200,id:"private",draw:function(e){if("app"===e.context&&!n.has("guest")){var t=new u({attributes:{role:"presentation"},tagName:"li",className:"dropdown",$toggle:$('<a href="#" data-action="add-subfolder" data-toggle="dropdown">').append(d("Add new calendar"),$('<i class="fa fa-caret-down" aria-hidden="true">'))});o.point("io.ox/core/foldertree/calendar/links/subscribe").invoke("draw",t),0!==t.$ul.children().length&&(this.append(t.render().$el),t.$toggle.attr("role","treeitem"))}}}),o.point("io.ox/core/foldertree/contacts/links").extend({index:1e3,id:"upsell-contacts",draw:function(e){"app"===e.context&&this.append(new c({id:"folderview/contacts",requires:"carddav",title:d("Synchronize with your tablet or smartphone")}).render().$el)}}),o.point("io.ox/core/foldertree/calendar/links").extend({index:1e3,id:"upsell-calendar",draw:function(e){"app"===e.context&&this.append(new c({id:"folderview/calendar",requires:"caldav",title:d("Synchronize with your tablet or smartphone")}).render().$el)}}),o.point("io.ox/core/foldertree/node").extend({id:"shared-by",index:100,draw:function(e){var i=e.view.model.toJSON();/^(contacts|calendar|tasks)$/.test(i.module)&&t.is("shared",i)&&e.view.addA11yDescription(d("Shared by other users"))}},{id:"shared",index:200,draw:function(e){this.find(".folder-node:first .folder-shared:first").remove(),_.device("smartphone")||"infostore"!==e.data.module&&t.is("unlocked",e.data)&&(e.view.$.buttons.append($('<i class="fa folder-shared" aria-hidden="true">').attr("title",d("You share this folder with other users")).on("click",{id:e.data.id},A)),e.view.addA11yDescription(d("You share this folder with other users")))}},{id:"sub",index:300,draw:function(e){t.isVirtual(e.view.folder)||this.find(".folder-sub:first").remove(),t.is("shared",e.data)||t.is("subscribed",e.data)&&(e.view.$.buttons.append($('<i class="fa folder-sub">').attr("title",d("This folder has subscriptions")).on("click",{folder:e.data},M)),e.view.addA11yDescription(d("This folder has subscriptions")))}},{id:"is-selected",index:400,draw:function(e){if(/^calendar$/.test(e.data.module)){var t=this,i=this.find(".folder-label"),o=ox.ui.apps.get("io.ox/calendar");o&&(this.attr("aria-checked",o.folders.isSelected(e.data.id)),require(["io.ox/calendar/util"],function(n){var a=n.getFolderColor(e.data),r=i.find(".color-label"),s=n.getColorName(a);s&&e.view.addA11yDescription(d("Category")+": "+s),0===r.length&&(r=$('<div class="color-label" aria-hidden="true">')),r.toggleClass("selected",o.folders.isSelected(e.data.id)),r.css({"background-color":a,color:n.getForegroundColor(a)}),r.off("click",E).on("click",{folder:e.data,app:o,target:r},E),t.off("keydown",E).on("keydown",{folder:e.data,app:o,target:r},E),i.prepend(r)}))}}},{id:"account-errors",index:500,draw:function(e){if(/^calendar$/.test(e.data.module)){var t=e.data["com.openexchange.calendar.accountError"];t?(e.view.showStatusIcon(t.error,"click:account-error",e.data),ox.trigger("http:error:"+t.code,t)):e.view.hideStatusIcon()}}}),I}),define("io.ox/core/settings/defaults",function(){var e;if(ox.serverConfig&&ox.serverConfig.languages){var t=Object.keys(ox.serverConfig.languages);e=_(t).contains("en_US")?"en_US":t[0]}else e="en_US";var i=_.getCookie("language");return i&&(e=i),{language:e,region:"",refreshInterval:3e5,design:"primary",autoStart:"io.ox/mail/main",coloredIcons:!1,autoOpenNotification:"noEmail",autoLogout:0,showDesktopNotifications:!0,settings:{downloadsDisabled:!1}}}),define("io.ox/core/settingOptions/settings/defaults",function(){return{}}),define("io.ox/mail/settings/defaults",[],function(){return{removeDeletedPermanently:!1,contactCollectOnMailTransport:!1,contactCollectOnMailAccess:!1,useFixedWidthFont:!1,appendVcard:!1,sendDispositionNotification:!1,appendMailTextOnReply:!0,forwardMessageAs:"Inline",messageFormat:"html",lineWrapAfter:"0",defaultSendAddress:"",allowHtmlMessages:!0,allowHtmlImages:!1,isColorQuoted:!1,defaultSignature:!1,defaultReplyForwardSignature:!1,mobileSignature:void 0,mobileSignatureType:"none",threadSupport:!0,sort:"thread",order:"desc",unread:!1,notificationSoundName:"bell",playSound:!0,confirmReplyToMailingLists:!0,unseenMessagesFolder:!0,showCheckboxes:!0,authenticity:{level:"fail_trusted",domains:""}}}),define("io.ox/contacts/settings/defaults",function(){return{showAdmin:!1,fullNameFormat:"auto",startInGlobalAddressbook:!0,mapService:"google",contactsPrintLayout:"simple"}}),define("io.ox/calendar/settings/defaults",function(){return{interval:30,startTime:8,endTime:18,defaultReminder:15,viewView:"week:workweek",showDeclinedAppointments:!0,markFulltimeAppointmentsAsFree:!1,notifyNewModifiedDeleted:!0,notifyAcceptedDeclinedAsCreator:!1,notifyAcceptedDeclinedAsParticipant:!1,deleteInvitationMailAfterAction:!0,numDaysWorkweek:5,workweekStart:1}}),define("io.ox/tasks/settings/defaults",function(){return{interval:30,notifyNewModifiedDeleted:!0,notifyAcceptedDeclinedAsCreator:!1,notifyAcceptedDeclinedAsParticipant:!1}}),define("io.ox/files/settings/defaults",function(){return{view:"fluid:icon",videoEnabled:!0,audioEnabled:!0,rootFolderId:9,showHidden:!1,uploadHandling:"announceNewVersion",autoplayPause:5,autoplayLoopMode:"loopEndlessly"}}),define("io.ox/metrics/main",["io.ox/core/extensions","settings!io.ox/core","io.ox/metrics/util","io.ox/core/capabilities","io.ox/core/http","io.ox/metrics/extensions","io.ox/metrics/adapters/default","io.ox/metrics/adapters/pro","io.ox/metrics/adapters/analytics","io.ox/metrics/adapters/console","io.ox/metrics/adapters/context"],function(e,t,i,o,n){function a(){return!i.doNotTrack()&&(!_.device("karma")&&(!ox.debug&&!!t.get("tracking/enabled",!1)))}function r(e){var t=e.data,i=t.action?t.action.replace(/^io\.ox\//,""):t.action,o=_.isBoolean(t.detail)?String(t.detail):t.detail,n=_.compact([t.app,t.target,i,o]).join("/");return n?(e.id=n,e):e}function s(t){var i=!!t.preventDefault;return r(e.Baton.ensure(i?{data:t.data,event:t}:{data:t}))}function l(e){var t="drive"===e.app?"files":e.app,i=n.getColumnMapping(t);return e.detail=i[e.detail]||e.detail}var d,c,u=e.point("io.ox/metrics/adapter");return c={trackEvent:function(e){"sort"===e.action&&l(e),u.invoke("trackEvent",c,s(e))},trackPage:function(e){u.invoke("trackPage",c,s(e))},trackVariable:function(e){u.invoke("trackVariable",c,e)},watch:function(e,t){e.node.on(e.type,e.selector,t,c.trackEvent)},getUserHash:function(){return d=d||i.getUserHash()},getFolderFlags:i.getFolderFlags,isEnabled:a},a()?(u.invoke("setup",c),u.invoke("trackVisit",c,[{id:"language",value:ox.language},{id:"version",value:ox.version},{id:"capabilities",value:o.getFlat().enabled}]),e.point("io.ox/metrics/extensions").invoke("register",c),c):(_.each(c,function(e,t){c[t]=$.noop}),c)}),define("io.ox/metrics/util",["io.ox/core/folder/api"],function(e){function t(e,i,o){o=o||[];var n=String(e);if(n.length<=i)return o.push(n.split(",")),o;for(var a=i-1;a>=0;a--)if(","===n[a]){var r=n.substr(0,a),s=n.substr(a+1);return o.push(r.split(",")),t(s,i,o)}}var i;!function(){function e(e,t){var i=e[0],s=e[1],l=e[2],d=e[3];s=r(s=r(s=r(s=r(s=a(s=a(s=a(s=a(s=n(s=n(s=n(s=n(s=o(s=o(s=o(s=o(s,l=o(l,d=o(d,i=o(i,s,l,d,t[0],7,-680876936),s,l,t[1],12,-389564586),i,s,t[2],17,606105819),d,i,t[3],22,-1044525330),l=o(l,d=o(d,i=o(i,s,l,d,t[4],7,-176418897),s,l,t[5],12,1200080426),i,s,t[6],17,-1473231341),d,i,t[7],22,-45705983),l=o(l,d=o(d,i=o(i,s,l,d,t[8],7,1770035416),s,l,t[9],12,-1958414417),i,s,t[10],17,-42063),d,i,t[11],22,-1990404162),l=o(l,d=o(d,i=o(i,s,l,d,t[12],7,1804603682),s,l,t[13],12,-40341101),i,s,t[14],17,-1502002290),d,i,t[15],22,1236535329),l=n(l,d=n(d,i=n(i,s,l,d,t[1],5,-165796510),s,l,t[6],9,-1069501632),i,s,t[11],14,643717713),d,i,t[0],20,-373897302),l=n(l,d=n(d,i=n(i,s,l,d,t[5],5,-701558691),s,l,t[10],9,38016083),i,s,t[15],14,-660478335),d,i,t[4],20,-405537848),l=n(l,d=n(d,i=n(i,s,l,d,t[9],5,568446438),s,l,t[14],9,-1019803690),i,s,t[3],14,-187363961),d,i,t[8],20,1163531501),l=n(l,d=n(d,i=n(i,s,l,d,t[13],5,-1444681467),s,l,t[2],9,-51403784),i,s,t[7],14,1735328473),d,i,t[12],20,-1926607734),l=a(l,d=a(d,i=a(i,s,l,d,t[5],4,-378558),s,l,t[8],11,-2022574463),i,s,t[11],16,1839030562),d,i,t[14],23,-35309556),l=a(l,d=a(d,i=a(i,s,l,d,t[1],4,-1530992060),s,l,t[4],11,1272893353),i,s,t[7],16,-155497632),d,i,t[10],23,-1094730640),l=a(l,d=a(d,i=a(i,s,l,d,t[13],4,681279174),s,l,t[0],11,-358537222),i,s,t[3],16,-722521979),d,i,t[6],23,76029189),l=a(l,d=a(d,i=a(i,s,l,d,t[9],4,-640364487),s,l,t[12],11,-421815835),i,s,t[15],16,530742520),d,i,t[2],23,-995338651),l=r(l,d=r(d,i=r(i,s,l,d,t[0],6,-198630844),s,l,t[7],10,1126891415),i,s,t[14],15,-1416354905),d,i,t[5],21,-57434055),l=r(l,d=r(d,i=r(i,s,l,d,t[12],6,1700485571),s,l,t[3],10,-1894986606),i,s,t[10],15,-1051523),d,i,t[1],21,-2054922799),l=r(l,d=r(d,i=r(i,s,l,d,t[8],6,1873313359),s,l,t[15],10,-30611744),i,s,t[6],15,-1560198380),d,i,t[13],21,1309151649),l=r(l,d=r(d,i=r(i,s,l,d,t[4],6,-145523070),s,l,t[11],10,-1120210379),i,s,t[2],15,718787259),d,i,t[9],21,-343485551),e[0]=u(i,e[0]),e[1]=u(s,e[1]),e[2]=u(l,e[2]),e[3]=u(d,e[3])}function t(e,t,i,o,n,a){return t=u(u(t,e),u(o,a)),u(t<<n|t>>>32-n,i)}function o(e,i,o,n,a,r,s){return t(i&o|~i&n,e,i,a,r,s)}function n(e,i,o,n,a,r,s){return t(i&n|o&~n,e,i,a,r,s)}function a(e,i,o,n,a,r,s){return t(i^o^n,e,i,a,r,s)}function r(e,i,o,n,a,r,s){return t(o^(i|~n),e,i,a,r,s)}function s(t){/[\x80-\xFF]/.test(t)&&(t=unescape(encodeURI(t)));var i,o=t.length,n=[1732584193,-271733879,-1732584194,271733878];for(i=64;i<=t.length;i+=64)e(n,l(t.substring(i-64,i)));t=t.substring(i-64);var a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<t.length;i++)a[i>>2]|=t.charCodeAt(i)<<(i%4<<3);if(a[i>>2]|=128<<(i%4<<3),i>55)for(e(n,a),i=0;i<16;i++)a[i]=0;return a[14]=8*o,e(n,a),n}function l(e){var t,i=[];for(t=0;t<64;t+=4)i[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return i}function d(e){for(var t="",i=0;i<4;i++)t+=p[e>>8*i+4&15]+p[e>>8*i&15];return t}function c(e){for(var t=0;t<e.length;t++)e[t]=d(e[t]);return e.join("")}var u,p="0123456789abcdef".split("");u=function(e,t){return e+t&4294967295},"5d41402abc4b2a76b9719d911017c592"!==(i=function(e){return c(s(e))})("hello")&&(u=function(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i})}();var o="metrics-userhash-v2",n=function(){function t(e){if("infostore"!==e.module||"9"===e.folder_id)return a[e.standard_folder_type]}function i(e){if("contacts"===e.module&&"6"===e.id)return"gab";var t=e.id.match(d);return t?"section-"+t[2]:l[e.id]||r[e.type]||s[e.standard_folder_type]}function o(o){var n={};return"infostore"===(o=o||{}).module&&o.account_id&&(n.account=o.account_id.split("://")[0]),_.each(["shared","private","public","system"],function(t){"infostore"!==o.module&&!n.type&&e.is(t,o)&&(n.type=t)}),e.isVirtual(o.id)&&(n.virtual="virtual"),n.content=i(o)||(e.is("trash",o)?"trash":void 0),n.default=t(o),n}function n(e){return _.compact([e.account,e.type,e.virtual,e.content,e.default])}var a={1:"default",2:"default",3:"default",8:"default"},r={20:"pictures",21:"documents",22:"music",23:"videos",24:"templates"},s={7:"inbox",9:"drafts",10:"sent",11:"spam",12:"trash"},l={"virtual/myshares":"all-my-shares","virtual/favorites/infostore":"favorites","virtual/favorites/contacts":"favorites","virtual/favorites/mail":"favorites","virtual/myfolders":"my-folders"},d=/virtual\/flat\/(\D+)\/(private|public|shared|hidden)/;return function(t){return e.get(t).then(o).then(n)}}();return{md5:i,doNotTrack:function(){return[navigator.doNotTrack,navigator.msDoNotTrack,window.doNotTrack].indexOf("1")>-1},getUserHash:function(){if(!(t=_.getCookie(o))){var e=(Math.random()+1).toString(36).substring(2),t=i(e);_.setCookie(o,t)}return t},getFolderFlags:n,toChunks:t}}),define("io.ox/metrics/extensions",["io.ox/core/extensions"],function(e){var t=e.point("io.ox/metrics/extensions");t.extend({id:"upsell",register:function(){var e=this;ox.on("upsell:requires-upgrade",function(t){e.trackEvent({app:"core",target:"upsell/"+t.type,action:t.id,detail:t.missing})})}}),t.extend({id:"app",register:function(){function e(e){e&&t!==e.id&&(t=e.id,i.trackPage({name:e.get("name"),id:e.get("id"),trackingId:e.get("trackingId")}))}var t,i=this;_.defer(function(){ox.ui.App&&e(ox.ui.App.getCurrentApp())}),ox.on("app:start app:resume",e)}}),t.extend({id:"loadtime",register:function(){var e=this;ox.on("loadtime",function(t){var i=t.app,o=i&&i instanceof Backbone.Model?i.get("trackingId")||i.get("name")||i.get("id"):t.id;e.trackEvent({app:"core",target:"loadtime",action:o,value:t.loadEnd-t.loadStart})})}}),t.extend({id:"topbar-logo",register:function(){this.watch({node:$("#io-ox-appcontrol"),selector:"#io-ox-top-logo",type:"click"},{app:"core",target:"topbar/logo",type:"click",action:""})}}),t.extend({id:"topbar-quicklaunch",register:function(){var e=this;$("#io-ox-appcontrol #io-ox-quicklaunch").on("mousedown","button",function(t){e.trackEvent({app:"core",target:"topbar/quicklaunch",type:"click",action:$(t.currentTarget).attr("data-id")})})}}),t.extend({id:"topbar-taskbar",register:function(){var e=this;$("#io-ox-appcontrol .taskbar").on("mousedown","li",function(t){if(!($(t.currentTarget).is("#io-ox-topbar-dropdown-icon")||$(t.currentTarget).hasClass("dropdown")&&$(t.currentTarget).hasClass("open"))){var i=$(t.currentTarget).hasClass("launcher")||$(t.currentTarget).hasClass("dropdown")?$(t.currentTarget).attr("id"):$(t.currentTarget).find("a").attr("data-id");i&&e.trackEvent({app:"core",target:"topbar/taskbar",type:"click",action:i})}})}}),t.extend({id:"topbar-settings-dropdown",register:function(){var e=this;$("#io-ox-topbar-dropdown-icon").on("mousedown",function(){$(this).hasClass("open")||e.trackEvent({app:"core",target:"topbar/settings",type:"click",action:"dropdown/open"})}),$("#topbar-settings-dropdown").on("mousedown","a",function(t){var i=$(t.target).closest("a"),o=i.attr("data-name")||i.attr("data-action")||i.attr("class")||i.parent().attr("class");e.trackEvent({app:"core",target:"topbar/settings",type:"click",action:o})})}}),t.extend({id:"halo",register:function(){var e=this;$(document.documentElement).on("mousedown",".halo-link",function(){var t=ox.ui.App.getCurrentApp()||new Backbone.Model({name:"unknown"});e.trackEvent({app:"core",type:"click",action:"halo",detail:_.last(t.get("name").split("/"))})})}}),t.extend({id:"filestorages",register:function(){var e=this;require(["io.ox/core/api/filestorage"],function(t){var i={create:"created",delete:"deleted",update:"updated"};t.on("create delete update",function(t,o){e.trackEvent({app:"data",target:"drive/account/"+i[t.type],type:"click",action:o.get("filestorageService")})})})}})}),define("io.ox/metrics/adapters/default",["settings!io.ox/core","io.ox/core/extensions","io.ox/metrics/util"],function(e,t,i){if(e.get("tracking/piwik/enabled",!1)){var o=t.point("io.ox/metrics/adapter"),n=e.get("tracking/piwik/url/lib"),a=e.get("tracking/piwik/url/api"),r=e.get("tracking/piwik/id",1);window._paq=window._paq||[],a&&n||console.log("Error: Matomo/Piwik is enabled but no backend URL was configured!"),o.extend({id:"piwik",setup:function(){_paq.push(["setTrackerUrl",a]),_paq.push(["setSiteId",ox.debug?2:r]),_paq.push(["setUserId",this.getUserHash()]),_paq.push(["enableLinkTracking"]),require([n])},trackVisit:function(e){var t=this,o=[];_.each(e,function(e){var t=String(e.value);if(!_.isArray(e.value)||t.length<=200)return o.push(e);var n=i.toChunks(e.value,200);_.each(n,function(t,i){o.push(_.extend({},e,{value:t,id:e.id+"-"+(i+1)}))})}),_.each(o,function(e,i){t.trackVariable(_.extend(e,{index:i+1}))})},trackEvent:function(e){var t=e.data;_paq.push(["trackEvent",t.app,e.id||t.target,t.action,t.detail||t.value])},trackPage:function(e){_paq.push(["trackPageView",e.data.trackingId||e.data.name||e.data.id])},trackVariable:function(e){e.index?_paq.push(["setCustomVariable",e.index,e.id,String(e.value),e.scope||"visit"]):ox.debug&&console.log("Missing/invalid index argument on trackVariable call")}})}}),define("io.ox/metrics/adapters/console",["settings!io.ox/core","io.ox/core/extensions"],function(e,t){function i(t,i){var o,n=(i=i||{}).id||t,a=i.data;switch(e.get("tracking/console/verbosity","DEBUG").toLowerCase()){case"debug":o=[t,n,JSON.stringify(a)];break;case"info":default:o=t+": "+n}return _.isString(o)?console.log("%c"+o,"color: white; background-color: grey"):console.log(o)}e.get("tracking/console/enabled",!1)&&t.point("io.ox/metrics/adapter").extend({id:"console",setup:function(){i("setup")},trackEvent:function(e){i("trackEvent",e)},trackVisit:function(e){i("trackVisit",e)},trackPage:function(e){i("trackPage",e)}})}),define("io.ox/core/collection",["io.ox/core/folder/api","io.ox/core/folder/util","io.ox/core/api/user"],function(e,t,i){function o(e){var t=_.compact([].concat(e)),i={},o=!1;this.getProperties=function(){return l(t).always(function(e){_.extend(i,e),o=!0})},this.getPromise=function(){return this.getProperties().pipe(_.identity.bind(null,this))},this.isResolved=function(){return o},this.isLarge=function(){return t.length>=100},this.toJSON=function(){return i},this.has=function(){return this.isResolved()||console.error("Using Collection.has before properties are resolved!",e,arguments),_(arguments).inject(function(e,t){return e&&!0===i[t]},!0)},this.matches=n(i)}function n(e){return _.memoize(function(t){var i=String(t||"").replace(/[a-z:]+/gi,function(t){return!!e[t.toLowerCase()]});try{return new Function("return !!("+i+")")()}catch(e){return console.error("Collection.matches",i,e),!1}})}var a=function(t,i,o){if(!t)return!1;var n=e.bits(t,o);return 0!==n&&(1!==n||i===ox.user_id)},r=function(e){return"standard_folder"in e||"folder"===e.folder_id},s=function(e){if(_.isObject(e))return r(e)?e.id:e.folder_id||e.folder},l=function(o){function n(e,t){return!1===e.group&&e.entity===ox.user_id||!0===e.group&&_(t.groups).contains(e.entity)}var l=o.length||0,d={read:!0,modify:!0,delete:!0,create:!0,"create:folder":!0,"rename:folder":!0,"delete:folder":!0,"change:seen":!0,none:0===l,some:l>0,one:1===l,multiple:l>1,items:!1,folders:!1,mixed:!1,guard:!1},c=_.chain(o).map(s).compact().uniq().value();return d.toplevel=_(o).reduce(function(e,t){return e&&"folder_id"in t&&!("filename"in t)},!0),0===c.length?(d.unknown=!0,"read modify delete create:folder rename:folder delete:folder change:seen".split(" ").forEach(function(e){d[e]=!1}),$.when(d)):$.when(e.multiple(c),i.me()).pipe(function(i,c){for(var u,p=0,f=null,h=null,g=_.toHash(i,"id"),m=!1,v=!1;p<l;p++)if(f=o[p],u=f&&f.object_permissions&&_(f.object_permissions).find(function(e){return n(e,c)}),h=g[s(f)],f.meta&&f.meta.Encrypted&&(d.guard=!0),r(f))void 0===f.own_rights&&(f=g[f.id]),m=!0,d["create:folder"]=d["create:folder"]&&e.can("create:folder",f),d["rename:folder"]=d["rename:folder"]&&e.can("rename:folder",f),d["delete:folder"]=d["delete:folder"]&&e.can("delete:folder",f),d["change:seen"]=d["change:seen"]&&e.can("change:seen",f),d.delete=d.delete&&e.can("delete:folder",f);else{if(!u&&!h){d.unknown=!0,d.read=d.modify=d.delete=d.create=d["change:seen"]=!1;break}v=!0;var x=f.createdBy&&f.createdBy.entity?f.createdBy.entity:f.created_by;d.read=d.read&&(u&&u.bits>=1||a(h,x,7)),d.modify=d.modify&&(u&&u.bits>=2||a(h,x,14)),d.delete=d.delete&&(u&&u.bits>=4||a(h,x,21)),h&&(d.create=d.create&&(127&h.own_rights)>=2),t.is("subscribed",h)&&(d.modify=d.delete=d.create=!1)}return m||"create:folder rename:folder".split(" ").forEach(function(e){d[e]=!1}),v||"create read modify".split(" ").forEach(function(e){d[e]=!1}),d.items=v&&!m,d.folders=m&&!v,d.mixed=m&&v,d})};return o.Simple=function(e){var t=e.length,i={none:0===t,some:t>0,one:1===t,multiple:t>1};this.matches=n(i),this.getPromise=function(){return $.when(this)},this.has=function(){return _(arguments).inject(function(e,t){return e&&!0===i[t]},!0)}},o}),define("io.ox/core/api/account",["settings!io.ox/mail","io.ox/core/http","io.ox/core/event"],function(e,t,i){function o(e,t){return e=$.trim(e||""),t=p.trimAddress(t),[e!==t?e:"",t]}function n(t){if(!t)return[];if(!t.addresses)return[o(t.personal,t.primary_address)];var i=_(String(t.addresses||"").toLowerCase().split(",")).map($.trim).sort();return _(i).map(function(i){return o(i!==t.primary_address&&e.get("features/anonymousAliases",!1)?"":t.personal,i)})}var a={},r={},s=e.get("defaultseparator","/"),l=""===e.get("namespace","INBOX/"),d=function(t){var i=_.isArray(t);t=i?t:[t];var o=/^default\d+/,n=function(t){var i,n="default"+this.id+s,a=t+"_fullname";if(this[a])o.test(this[a])||(this[a]=n+this[a]);else{if(0!==this.id)return;(i=e.get(["folder",t]))||(this[t]?(i=l?"default0":e.get("folder/inbox"),i+=s+this[t]):i=""),this[a]=i}};return _(t).each(function(e){_(["trash","sent","drafts","spam","archive","confirmed_spam","confirmed_ham"]).each(n,e)}),i?t:t[0]},c=new RegExp("^default\\d+"+s+"[^"+s+"]+"+s),u=new RegExp("^default\\d+"+s+"[^"+s+"]+$"),p={};i.extend(p),p.isUnified=function(t){/^\d+$/.test(t)&&(t="default"+t);var i=e.get("unifiedInboxIdentifier");if(!i||"null"===i)return!1;var o=String(t).match(/^(default\d+)/);return!!o&&i===o[1]+s+"INBOX"},p.isUnifiedFolder=function(e){return u.test(e)&&p.isUnified(e)},p.isUnifiedRoot=function(e){return p.isUnified(e)&&1===e.split(s).length},p.isAccount=function(e){if(_.isNumber(e))return e in a;var t=String(e).match(/^default(\d+)/);return t&&t[1]in a},p.isPrimary=function(e){return/^default0/.test(e)},p.isExternal=function(e){return p.isAccount(e)&&!p.isPrimary(e)},p.getUnifiedMailboxName=function(){return this.getUnifiedInbox().then(function(e){return null===e?null:e.split(s)[0]})},p.getUnifiedInbox=function(){var t=e.get("unifiedInboxIdentifier",null);return $.when("null"===t?null:t)},p.getInbox=function(){return e.get("folder/inbox")},p.is=function(){function e(e,i){if(p.isUnified(i)){var o=t[e];return Boolean(o&&o.test(i))}return"inbox"===e?r[i]===e:_(r).some(function(t,o){var n=0===i.indexOf(o+s);return t===e&&(o===i||n)})}var t={inbox:/^default\d+\DINBOX(?:\/|$)/,sent:/^default\d+\DSent(?:\/|$)/,trash:/^default\d+\DTrash(?:\/|$)/,drafts:/^default\d+\DDrafts(?:\/|$)/,spam:/^default\d+\DSpam(?:\/|$)/};return _.memoize(function(t,i){return t=String(t||"").split("|"),i=String(i||""),_(t).reduce(function(t,o){return t||e(o,i)},!1)},function(e,t){return e+":"+t})}(),p.getFoldersByType=function(e,t){return _(r).chain().map(function(i,o){return(void 0===t||-1!==o.indexOf("default"+t))&&(i===e&&o)}).compact().value()},p.getStandardFolders=function(){return _(r).keys()},p.isStandardFolder=function(e){return void 0!==r[e]},p.isMalicious=function(e,t){if(e)return!!p.is("spam",e)||(!!p.is("confirmed_spam",e)||_(t).some(function(t){return t===e||0===e.indexOf(t+s)}))},p.getType=function(e){return"virtual/all-unseen"===e?"unseen":r[e]},p.getTypes=function(){return r},p.inspect=function(){return{accounts:a,types:r}},p.parseAccountId=function(e,t){if("number"==typeof e)return e;if(/^default(\d+)/.test(String(e))){if(!p.isUnified(e))return parseInt(e.replace(/^default(\d+)(.*)$/,"$1"),10);var i=e.replace(c,"");if(i!==e&&/^default\d+/.test(i))return p.parseAccountId(i,t);if(!t)return 0;var o=e.match(/^default(\d+)/);return o&&o.length?parseInt(o[1],10):0}return 0},p.getPrimaryAddress=function(e){return p.get(e||0).then(f).then(function(t){return t?0===e||!t.transport_url||p.isUnified(e)?p.getDefaultAddress():[t.personal,t.primary_address]:$.Deferred().reject(t)}).then(function(e){return o(e[0],e[1])})},p.getDefaultAddress=function(){return p.get(0).then(f).then(function(t){var i=$.trim(e.get("defaultSendAddress",""));return[t.personal,i||t.primary_address]})},p.getValidAddress=function(e){return p.getAllSenderAddresses().then(function(t){if(!_.isEmpty(t))return _.isEmpty(e.from)||(e.from=t.filter(function(t){return t[1]===e.from[0][1].toLowerCase()})),_.isEmpty(e.from)?p.getPrimaryAddress().then(function(t){return _.extend(e,{from:[t]})}):e})},p.getPrimaryAddressFromFolder=function(e){var t=this.parseAccountId(e,!0),i=p.isUnified(t);return this.getPrimaryAddress(i?0:t)},p.getDefaultDisplayName=function(){return require(["io.ox/contacts/util","io.ox/core/api/user"]).then(function(e,t){return t.get({id:ox.user_id}).then(function(t){return e.getMailFullName(t)})})};var f=function(e){return!e||e.personal&&(" "===e.personal||""!==$.trim(e.personal))?$.Deferred().resolve(e):p.getDefaultDisplayName().then(function(t){return e.personal=t,e})};return p.trimAddress=function(e){return(e=$.trim(e)).indexOf("@")>-1?e.toLowerCase():e},p.getSenderAddresses=function(e){return this.get(e||0).then(f).then(n)},p.getAllSenderAddresses=function(e){return p.all(e).then(function(e){return _(e).filter(function(e){return 0===e.id||!!e.transport_url})}).then(function(e){return $.when.apply($,_(e).map(f))}).then(function(){return _(arguments).flatten(!0)}).then(function(e){return $.when.apply($,_(e).map(n))}).then(function(){return _(arguments).flatten(!0)}).then(function(e){return e})},p.cache={},ox.rampup&&ox.rampup.accounts&&_(ox.rampup.accounts).each(function(e){var i=d(t.makeObject(e,"account"));p.cache[i.id]=i}),p.all=function(e){var i=_.extend({useCache:!0},e);return(_(p.cache).size()>0&&i.useCache?$.Deferred().resolve(_(p.cache).values()):t.GET({module:"account",params:{action:"all"},appendColumns:!0,processResponse:!0}).then(function(e){return e=d(e),p.cache={},_(e).each(function(e){p.cache[e.id]=d(e)}),e})).done(function(e){a={},r={},_(e).each(function(e){a[e.id]=!0,r["default"+e.id+"/INBOX"]="inbox",_("drafts sent spam trash archive confirmed_spam".split(" ")).each(function(t){var i=e[t],o=e[t+"_fullname"]||i;r[o]||(r[o]=t)})})})},p.get=function(e){return p.cache[e]?$.Deferred().resolve(p.cache[e]):p.all().then(function(){return p.cache[e]})},p.create=function(e){return t.PUT({module:"account",params:{action:"new"},data:e,appendColumns:!1}).then(function(e){return p.reload().then(function(){return ox.trigger("account:create"),p.trigger("create:account",{id:e.id,email:e.primary_address,name:e.name}),require(["io.ox/core/folder/api"],function(e){e.propagate("account:create")}),e})})},p.remove=function(e){return t.PUT({module:"account",params:{action:"delete"},data:e,appendColumns:!1}).done(function(){var t=(p.cache[e]||{}).root_folder;delete p.cache[e],ox.trigger("account:delete",t),p.trigger("refresh.all"),p.trigger("delete"),require(["io.ox/core/folder/api"],function(e){e.propagate("account:delete")})})},p.validate=function(e,i){return i=_.extend({action:"validate"},i),t.PUT({module:"account",appendColumns:!1,params:i,data:e,processData:!1}).then(function(e){return $.Deferred().resolve(e.data,13===e.category?e:void 0)},function(e){return $.Deferred().resolve(e.data,e)})},p.update=function(e){return delete e.mail_url,delete e.transport_url,t.PUT({module:"account",params:{action:"update"},data:e,appendColumns:!1}).then(function(i){var o=i.id;if(p.cache[o]){var n=i.unified_inbox_enabled;p.cache[o].unified_inbox_enabled!==n&&require(["io.ox/core/folder/api"],function(e){e.propagate(n?"account:unified-enable":"account:unified-disable")})}return(_.isObject(i)?$.Deferred().resolve(i):t.GET({module:"account",params:{action:"get",id:e.id},appendColumns:!1})).done(function(e){e=d(e),p.cache[o]=e}).done(function(e){p.trigger("refresh.all"),p.trigger("update",e)})})},p.autoconfig=function(e){return t.POST({module:"autoconfig",data:_.extend({action:"get"},e)})},p.configtestAll=function(){return t.GET({module:"jslob",params:{action:"all"}})},p.configtestList=function(e){return t.PUT({module:"jslob",params:{action:"list"},data:e})},p.configtestUpdate=function(e,i){return t.PUT({module:"jslob",params:{action:"update",id:i},data:e})},p.configtestSet=function(e,i){return t.PUT({module:"jslob",params:{action:"set",id:i},data:e})},p.getStatus=function(e){var i={action:"status"};return e&&(i.id=e),t.GET({module:"account",params:i})},p.getPrimaryName=function(){if(!p.cache[0])return"";var e=p.cache[0].name;return/^(email|e-mail)$/i.test(e)?String(p.cache[0].primary_address).toLowerCase().split("@")[1]||"":e},p.reload=function(){return p.all({useCache:!1})},p.refresh=function(){return this.reload().done(function(){p.trigger("refresh.all")})},ox.on("refresh^",function(){p.refresh()}),p}),define("io.ox/core/tk/selection",["io.ox/core/event","io.ox/core/extensions","io.ox/core/collection","io.ox/core/notifications","gettext!io.ox/core","io.ox/core/tk/draghelper"],function(e,t,i,o,n){function a(e,t){return e=e.map(function(){return $.trim($(this).attr("title")||$(this).text())}),$.makeArray(e).join(t||"")}function r(e){return a(this.find(".selected .drag-title"),", ")||n.format(n.ngettext("1 item","%1$d items",e.length),e.length)}var s=function(o,n){n=_.extend({draggable:!1,dragMessage:r,dragCssClass:void 0,dragType:"",dropzone:!1,dropzoneSelector:".selectable",dropType:"",scrollpane:o,focus:"[tabindex]",markable:!1},n),this.classFocus="focussed",this.classSelected="selected",e.extend(this);var a,s,l,d,c,u,p,f,h,g,m,v,x,b,w,y,k,C,S,T,D,A,M,E,N,F,I,P,L,z,q,O,V,R,B=this,U=!0,j=!1,H=".vgrid-cell",W={},G=!0,J=[],K={},Y={},X=Y,Q=Y,Z=$.noop,ee=-1,te=0;if(C=function(e){return!$(e.target).hasClass("not-selectable")},S=function(e){var t=$(e.target).closest(H);return j&&t.length},T=function(e){return U&&e&&(e.metaKey||e.ctrlKey)},D=function(e){return e&&e.shiftKey&&U},V=function(){return _.size(W)>1},a=function(e){var t=B.get();B.trigger("change",t,e),0===t.length&&B.trigger("empty")},b=function(){var e=B.get();B.trigger("_m_change",e),0===e.length&&B.trigger("empty")},s=function(e,t,i){D(t)?(B.selectRange(Q,e),X=e):(Z(t)?L(e):k(e),X=Q=e,te=A(e)),i?S(t)||R?(t.preventDefault(),b()):s(e,t):a()},E=function(e){if(G&&J.length){var t=J[0].data;g(e),L(t);var i=B.serialize(t);M(i).focus()}},N=function(e,t){if(G&&J.length){var i=J[0];if(g(e),s(i.data,e),B.trigger("select:first",i.data),t){var o=B.serialize(i.data);M(o).focus()}}},F=function(e){if(G){var t,i=A(X)-1;i>=0&&(t=J[i],g(e),s(t.data,e),B.trigger("select:previous",t.data))}},I=function(e){if(G&&J.length){var t=J.length-1,i=J[t];g(e),s(i.data,e),B.trigger("select:last",i.data)}},P=function(e){if(G){var t,i=A(X)+1;i<J.length&&(t=J[i],g(e),s(t.data,e),B.trigger("select:next",t.data))}},O=function(e){switch(B.trigger("keyboard",e,e.which),e.which){case 38:if(e.preventDefault(),$(e.target).hasClass("folder-options-badge dropdown-opened"))return;e.metaKey?N(e):F(e);break;case 36:N(e);break;case 35:I(e);break;case 32:if(n.markable){if(e.preventDefault(),!$(e.target).hasClass("marked"))return;k(X),a()}break;case 40:if(e.preventDefault(),$(e.target).hasClass("folder-options-badge dropdown-opened"))return;e.metaKey?I(e):P(e);break;case 8:case 46:e.preventDefault(),B.trigger("selection:delete",B.get())}},l=function(e){var t,i;e.isDefaultPrevented()||(t=$(this).attr("data-obj-id"),void 0!==(i=G?(J[A(t)]||{}).data:t)&&S(e)&&C(e)&&s(i,e))},d=function(e){var t;e.isDefaultPrevented()||(t=$(this).attr("data-obj-id"),B.trigger("selection:doubleclick",t))},u=function(e){var t,i,o,a;e.isDefaultPrevented()||(i=(t=$(this)).attr("data-obj-id"),o=G?(J[A(i)]||{}).data:i,n.markable&&q(),a=function(){if(void 0!==o&&!S(e)){if(T(e))return void s(o,e);m(o)?V()&&t.addClass("pending-select"):(D(e)&&Q===Y&&(Q=B.get()[0]||Y),g(),s(o,e))}},_.device("!smartphone")?setTimeout(a,50):a())},c=function(e){var t,i,n,a;e.isDefaultPrevented()||(i=(t=$(this)).attr("data-obj-id"),n=G?(J[A(i)]||{}).data:i,a=function(){void 0!==n&&t.hasClass("pending-select")&&C(e)&&(g(),s(n,e)),o.find(".pending-select").removeClass("pending-select")},_.device("!smartphone")?setTimeout(a,50):a())},p=function(e){var t,i;e.isDefaultPrevented()||(t=$(this).attr("data-obj-id"),i=G?(J[A(t)]||{}).data:t,R&&s(i,e,!0))},A=function(e){return G?K[B.serialize(e)]:-1},M=function(e){return $('.selectable[data-obj-id="'+B.serialize(e).replace(/\\\./g,"\\\\.")+'"]',o)},m=function(e){return void 0!==W[B.serialize(e)]},v=function(e,t){var i=B.serialize(e);W[i]=e;var n=t||M(i);return o.has(document.activeElement).length&&n.focus(),h(),n.addClass(B.classSelected).attr({"aria-selected":"true",tabindex:0}).end()},x=function(e,t){e&&(v(e).intoViewport(n.scrollpane),X=e,ee=A(e),Q===Y&&(Q=e,te=ee),!0!==t&&B.trigger("select",B.serialize(e),e))},w=function(e){var t=B.serialize(e);delete W[t],M(t).removeClass(B.classSelected).attr({"aria-selected":"false",tabindex:-1}),B.trigger("deselect",t),n.markable&&o.find(".marked").length>0?o.find(".marked").attr({tabindex:0}):_.size(W)>0&&M(y()).attr({tabindex:0})},y=function(){return _.last(B.get())},k=function(e){if(m(e)){if(n.markable&&!V())return;w(e)}else x(e)},f=function(e){if(!o.is(":hidden")){(e=e||!1)&&B.clearIndex();var t=$(".selectable:visible",o),i=0,n=null;for(t.removeClass(B.classSelected);i<t.length;i++){var a=(n=t.eq(i)).attr("data-obj-id");e&&B.addToIndex(a),m(a)&&n.addClass(B.classSelected).attr({"aria-selected":"true"})}}},h=function(){o.find('.selectable[tabindex="0"]').attr({tabindex:-1})},g=function(){W={},o.find(".selectable."+B.classSelected).removeClass(B.classSelected).attr({"aria-selected":"false",tabindex:-1})},n.markable){var ie,oe=g;this.classMarked="marked",Z=function(e){return U&&e&&(38===e.which||40===e.which)&&e.ctrlKey},g=function(e){q(),Z(e)||oe(e)},z=function(e,t){var i=B.serialize(e);ie=e;var n=t||M(i);o.has(document.activeElement).length&&n.focus();var a=n.attr("id")||_.uniqueId("option-");return h(),n.addClass(B.classMarked).attr({tabindex:0,id:a}).parent('[role="listbox"]').attr("aria-activedescendant",a).end()},L=function(e,t){e&&(z(e).intoViewport(n.scrollpane),X=e,ee=A(e),Q===Y&&(Q=e,te=ee),!0!==t&&B.trigger("mark",B.serialize(e),e))},q=function(){if(ie){var e=B.serialize(ie);ie=void 0,M(e).removeClass(B.classMarked).attr("tabindex",-1).parent('[role="listbox"]').removeAttr("aria-activedescendant"),ie=void 0}}}this.serialize=function(e){return"object"==typeof e?void 0!==e.folder_id?_.cid(e):e.id:e},this.setSerializer=function(e){this.serialize=function(t){return"object"==typeof t?e(t):t}},this.init=function(e){var t=this.get(),i=_.clone(W);g(),J=new Array(e.length),K={},X=Q=Y,e.length>0&&(ee=-1);for(var n,r,s=0,l=e.length,d=!0;s<l;s++)n=e[s],r=this.serialize(n),J[s]={data:n,cid:r},K[r]=s,r in i&&d&&(te=ee=s,X=r,d=!1);return $(".selectable",o).each(function(){var e=$(this);e.attr("data-obj-id")in i?e.addClass(B.classSelected).attr({"aria-selected":"true",tabindex:0}):e.removeClass(B.classSelected).attr({"aria-selected":"false",tabindex:-1})}),W=i,_.isEqual(t,this.get())||a(),this},this.insertAt=function(e,t){var i=e.length,o=[];_(e).reduce(function(e,t){var i=B.serialize(t);return o.push({data:t,cid:i}),e||i in K},!1)||(J.splice.apply(J,[t,0].concat(o)),_(K).each(function(e,o){e>=t&&(K[o]+=i)}),_(e).each(function(e,i){K[B.serialize(e)]=t+i}))},this.remove=function(e){_(e).each(function(e){var t=B.serialize(e),i=K[t];void 0!==i&&J.splice(i,1,null)}),J=_(J).compact(),K={},_(J).each(function(e,t){K[e.cid]=t})},this.update=function(){return f(),this},this.updateIndex=function(){return f(!0),this},this.debug=function(){console.debug("selection",{selected:W,observed:J,index:K})},this.clearIndex=function(){return J=[],K={},this},this.addToIndex=function(e){var t=this.serialize(e);return void 0===K[t]&&(K[t]=J.length,J.push({data:e,cid:t})),this},this.removeFromIndex=function(e){var t={},i=0;_([].concat(e)).each(function(e){t[B.serialize(e)]=!0}),K={},J=_(J).filter(function(e){var o=e.cid;return!(o in t)&&(K[o]=i++,!0)})},this.hasIndex=function(e){return G=!!e,this},this.getObservedItems=function(){return K},this.setMultiple=function(e){return U=!!e,this},this.setEditable=function(e,t){return j=!!e,H=t||".vgrid-cell",X=Q=Y,ee=-1,this},this.get=function(){var e=[],t="";for(t in W)e.push(W[t]);return e},this.unique=function(e){e=e||this.get();var t={};return _(e).filter(function(e){var i=_.isString(e)?e:_.cid(e);return!(i in t)&&(t[i]=!0)})},this.unfold=this.get,this.clear=function(e){return g(),!0!==e&&(B.trigger("clear"),a()),this},this.focus=function(){if(!$.contains(o,document.activeElement)){if(0===this.get().length)return this.selectFirst(!0);var e=this.serialize(_.last(this.get()));M(e).focus()}},this.select=function(e){return x(e),a(),this},this.deselect=function(e){return w(e),a(),this},this.set=function(e,t){var i=this.get(),r=this,s={},l=!0;return g(),ee=-1,$(".selectable",o).each(function(){var e=$(this),t=e.attr("data-obj-id");s[t]=e}),_(!e||_.isArray(e)?e:[e]).each(function(e,t){var i,o,a=r.serialize(e);a in s?(o="string"==typeof e&&G&&void 0!==(i=J[A(e)])?v(i.data,s[a]):v(e,s[a]),0===t&&o.intoViewport(n.scrollpane)):W[a]=e,l&&(ee=A(a),X=a,l=!1)}),s=null,_.isEqual(_(i).map(r.serialize),_(this.get()).map(r.serialize))||!0===t||a(),this},this.equals=function(e){return _.isEqual(e,this.get())},this.selectRange=function(e,t){var i,o,n;if(G){for(n=(e=A(e))>(t=A(t)),i=e;n?i>=t:i<=t;n?i--:i++)o=J[i],i===t?x(o.data):W[o.cid]=o.data;this.update()}return this},this.markFirst=function(){return E(),this},this.selectFirst=function(e){return N(null,e),this},this.selectLast=function(){return I(),this},this.selectSmart=function(){return 0===this.get().length&&this.selectFirst(),this},this.selectNext=P,this.selectAll=function(){if(G&&J.length){for(var e,t=0,i=J.length;t<i;t++)e=J[t],0===t||t===i-1?x(e.data,!0):W[e.cid]=e.data;this.update(),R?b():a()}},this.resetLastIndex=function(){te=-1},this.setLastIndex=function(e){return Q=e,te=A(e),this},this.selectIndex=function(){var e=J[te];void 0!==e&&this.select(e.data)},this.selectLastIndex=function(){if(-1!==te){var e=J[te]||_.last(J);void 0!==e&&this.select(e.data)}},this.isSelected=function(e){return m(e)},this.getIndex=function(e){return A(e)},this.isEmpty=function(){return _.isEmpty(W)},this.contains=function(e){var t=[].concat(e);return!!t.length&&_(t).inject(function(e,t){return t=_.isObject(t)?B.serialize(t):t,e&&t in K},!0)},this.getLastIndex=function(){return te},this.keyboard=function(e,t){return $(e)[t?"on":"off"]("keydown",O),this},this.retrigger=function(e){if(e){var t=this.get();this.clear(),this.set(t)}else R?b():a()},this.retriggerUnlessEmpty=function(){this.get().length&&a({retriggerUnlessEmpty:!0})},this.destroy=function(){this.clear(),this.keyboard(!1),this.events.destroy(),o.off("mousedown mouseup contextmenu"),W=J=K=X=null},this.setMobileSelectMode=function(e){R=e},this.getMobileSelectMode=function(){return R},o.on("contextmenu",function(e){e.preventDefault()}).on("mousedown",".selectable",u).on("mouseup",".selectable",c).on("click",".selectable",l).on("dblclick",".selectable",d).on("tap",".selectable",p).on("focus",".selectable",function(){o.addClass("has-focus")}).on("blur",".selectable",function(){_.delay(function(){0===o.find(":focus").length&&(o.removeClass("has-focus"),n.markable&&(q(),M(y()).attr({tabindex:0}),y()&&(X=y())))},10)}),function(){function e(e){C=e.pageX+b,S=e.pageY+w,(T(y-C)>=5||T(k-S)>=5)&&(m.left=C+"px",m.top=S+"px",y=C,k=S)}function a(){o.trigger("selection:dragstart")}function r(){this.trigger("click")}function s(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(this).find(".folder-arrow");$(this).addClass("dnd-over"),t.length&&(clearTimeout(v),v=setTimeout(r.bind(t),1500))}}function l(){clearTimeout(v),$(this).removeClass("dnd-over")}function d(i){$(document).off("mousemove.dnd",d),x=$('<div class="drag-helper">'),t.point("io.ox/core/tk/draghelper").invoke("draw",x,new t.Baton({container:o,data:h,source:g,dragMessage:n.dragMessage})),m=x[0].style,y=k=C=S=0,e(i),x.appendTo(document.body),$(document).on("mousemove.dnd",e).one("mousemove.dnd",a).on("mouseover.dnd",".folder-tree",D.over).on("mouseout.dnd",".folder-tree",D.out).on("mousemove.dnd",".folder-tree",D.move).on("mouseover.dnd",".selectable",s).on("mouseout.dnd",".selectable",l)}function c(){null!==x&&(x.remove(),x=m=null)}function u(){D.out(),$(document).off("mousemove.dnd mouseup.dnd mouseover.dnd mouseout.dnd"),$(".dropzone").each(function(){var e=$(this),t=e.attr("data-dropzones");(t?e.find(t):e).off("mouseup.dnd")}),$(".dnd-over").removeClass("dnd-over"),o.trigger("selection:dragstop"),null!==x&&c()}function p(e){if(!e.isDefaultPrevented()){e.preventDefault(),clearTimeout(v);var i=$(this).attr("data-obj-id")||$(this).attr("data-cid")||$(this).attr("data-id"),o=new t.Baton({data:h,dragType:n.dragType,dropzone:this,target:i});$(this).trigger("selection:drop",[o])}}function f(e){var t=Math.abs(e.pageX-e.data.x),o=Math.abs(e.pageY-e.data.y);if(t>15||o>15){if(0===(h=B.unique(B.unfold())).length){var n=g.attr("data-obj-id");h=n?[_.cid(n)]:[]}var a=new i(h);a.getProperties(),a.isResolved()&&!a.has("delete")?$(document).off("mousemove.dnd mouseup.dnd"):($(".dropzone").each(function(){var e=$(this),t=e.attr("data-dropzones");(t?e.find(t):e).on("mouseup.dnd",p)}),$(document).off("mousemove.dnd").on("mousemove.dnd",d))}}var h,g,m,v,x=null,b=15,w=15,y=0,k=0,C=0,S=0,T=Math.abs,D=function(){var e=0,t=null;return{move:function(t){e=t.pageY-$(this).offset().top},out:function(){clearInterval(t),t=null},over:function(){if(!t){var i=this.clientHeight;t=setInterval(function(){var t=Math.round(e/i*10)-5,o=t<0?-1:1,n=Math.abs(t);n>2&&(this.scrollTop+=o*(n-2)*2)}.bind(this),5)}}}}();_.device("!touch")&&(n.draggable&&o.on("mousedown.dnd",".selectable",function(e){if(e.preventDefault(),g=$(this),$(document).on("mousemove.dnd",{x:e.pageX,y:e.pageY},f).on("mouseup.dnd",u),!_.browser.IE){var t=$(e.target).closest(n.focus);(n.focus&&t.length?t:o).focus()}}),n.dropzone&&o.addClass("dropzone").attr("data-dropzones",n.dropzoneSelector).on("drop",function(e,t){t.dropType=n.dropType,B.trigger("selection:drop",t)}))}()};return s.extend=function(e,t,i){return e.selection=new s(t,i||{})},s}),define("io.ox/core/tk/visibility-api-util",[],function(){var e,t,i={isHidden:!1,isSupported:!1,hiddenAttribute:"",visibilityChangeEvent:""};return void 0!==document.hidden?(e="hidden",t="visibilitychange"):void 0!==document.mozHidden?(e="mozHidden",t="mozvisibilitychange"):void 0!==document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),void 0!==document[e]&&(i.isSupported=!0,i.hiddenAttribute=e,i.visibilityChangeEvent=t,i.isHidden=!!document[e],$(document).on(t,function(){var e=i.isHidden;i.isHidden=!!document[i.hiddenAttribute],$(i).trigger("visibility-changed",{currentHiddenState:i.isHidden,oldState:e})})),i}),define("io.ox/core/desktopNotifications",["settings!io.ox/core","io.ox/core/tk/visibility-api-util"],function(e,t){function i(e){if(t.isHidden||e.ignoreVisibility||e.forceDisplay){var i,o=(e=_.extend({title:"",body:"",duration:"4000"},e)).title,n=e.duration,a=e.onclose,r=e.onshow,s=e.onclick,l=e.onerror;e=_(e).omit("title duration ignoreVisibility onclick onclose onshow onerror"),i=new Notification(o,e),a&&(i.onclose=a),r&&(i.onshow=r),s&&(i.onclick=s),l&&(i.onerror=l),n&&(_.device("firefox")&&n>=4e3||(i.onshow=function(){setTimeout(function(){$(i).trigger("close")},n),r&&r.call(arguments,this)}))}}var o=!_.device("smartphone")&&!!window.Notification;return{getPermissionStatus:function(){return o?Notification.permission:"unsupported"},isSupported:function(){return o},requestPermission:function(e){o?Notification.requestPermission(e):e("unsupported")},show:function(t){t&&o&&e.get("showDesktopNotifications",!0)&&(2===arguments.length?_.isString(arguments[0])&&_.isString(arguments[1])?t={title:t,body:arguments[1]}:(arguments[1].title=t,t=arguments[1]):_.isString(t)&&(t={title:t}),"granted"===this.getPermissionStatus()&&i(t))}}}),define("io.ox/core/main/addLauncher",[],function(){return function(e,t,i,o){var n=$('<li role="presentation" class="launcher">');return i&&n.on("click","a",function(e){e.preventDefault();var t,o=$(this),n=$(document.activeElement);t=o.contents().detach(),o.css("width",o.width()+"px").text(" ").busy(),(i.call(this)||$.when()).done(function(){o.idle().empty().append(t).css("width",""),$(document.activeElement).filter("body").length>0&&n.focus()})}),n.append(function(){return _.isString(t)?$('<a href="#" class="apptitle" tabindex="-1">').text(t):"I"===t[0].tagName?$('<a href="#" class="apptitle" role="button" tabindex="-1">').attr("aria-label",o?_.escape(o):null).append(t):t}),"left"===e&&n.hide(),n.appendTo($("#io-ox-toprightbar"))}}),define("io.ox/core/main/appcontrol",["io.ox/core/http","io.ox/core/upsell","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/main/icons","io.ox/backbone/mini-views/dropdown","settings!io.ox/core","gettext!io.ox/core","io.ox/core/main/autologout"],function(e,t,i,o,n,a,r,s){function l(e){$("#io-ox-appcontrol").toggleClass("open",e),$("#io-ox-launchgrid-overlay, #io-ox-launchgrid-overlay-inner").toggle(e)}function d(){function t(){if(0===i&&null===o)if($("#io-ox-refresh-icon .apptitle").attr("aria-label",s("Refresh")),n){if((r=r||$("#io-ox-refresh-icon").find("i")).hasClass("fa-spin")){r.addClass("fa-spin-paused");var e=!1;setTimeout(function(){e=!0},2546),r.on("animationiteration",function(t){e&&$(t.target).removeClass("fa-spin")})}}else $("#io-ox-refresh-icon").removeClass("io-ox-progress")}var i=0,o=null,n=_.device("webkit || firefox || ie > 9"),a=n?500:1500,r=null;e.on("start",function(e,l,d){0===i&&(null!==o||d.silent||($("#io-ox-refresh-icon .apptitle").attr("aria-label",s("Currently refreshing")),n?(r=r||$("#io-ox-refresh-icon").find("i")).hasClass("fa-spin")||r.addClass("fa-spin").removeClass("fa-spin-paused"):$("#io-ox-refresh-icon").addClass("io-ox-progress")),clearTimeout(o),o=setTimeout(function(){o=null,t()},a)),i++}),e.on("stop",function(){i=Math.max(0,i-1),t()})}var c=Backbone.View.extend({tagName:"a",className:"btn btn-link lcell",attributes:{href:"#",role:"menuitem",tabindex:-1},events:{click:"onClick","click .closer":"quitApp"},initialize:function(e){this.pos=e.pos,this.quicklaunch=e.quicklaunch,this.listenTo(this.model,"change:hasBadge",this.toggleBadge),this.listenTo(this.model,"change:tooltip",this.updateTooltip),this.listenTo(this.model,"change:title",this.updateTitle),this.listenTo(r,"change:coloredIcons",this.render)},addAccessKey:function(){this.pos<=9&&0!==this.pos&&this.$el.attr("accesskey",this.pos)},checkUpsell:function(){var e=this.model.get("requires");return!t.has(e)},drawUpsellIcon:function(e){this.checkUpsell()&&e.addClass("upsell").append(_(r.get("upsell/defaultIcon","fa-star").split(/ /)).map(function(e){return $('<i class="fa" aria-hidden="true">').addClass(e)}))},onClick:function(){if(this.checkUpsell()){var e=this.model.get("requires");t.trigger({type:"app",id:this.model.get("id"),missing:t.missing(e)})}else{if("running"===this.model.get("state")&&this.model.get("closable"))return void this.model.launch();if(ox.tabHandlingEnabled&&this.model.get("openInTab"))return void require("io.ox/core/api/tab").openChildTab(this.model.get("tabUrl"));ox.launch(this.model.get("path"))}},quitApp:function(e){e.preventDefault(),e.stopPropagation(),this.model.quit()},drawCloser:function(){var e=$('<a href="#" type="button" class="btn btn-link closer">').append($('<i class="fa fa-times" aria-hidden="true">'));this.$el.append(e),this.closer=e},drawDate:function(){this.$icon.find("tspan:first").text(moment().format("D"))},drawIcon:function(){var e=this.model.get("icon"),t=this.model.get("id"),i=this.model.get("title"),o=_.isString(i)?i[0]:"?";return e=/^<.*>$/.test(e)?e:"",this.model.get("closable")&&_.device("smartphone")&&(e=ox.ui.appIcons[this.model.options.name]),this.$icon=e?$(e):$(n.fallback).find("text > tspan").text(o).end(),this.$icon.attr("aria-hidden",!0),r.get("coloredIcons",!1)&&this.$icon.addClass("colored"),("io.ox/calendar"===t||/calendar/.test(this.model.getName()))&&this.drawDate(),this.$cell=$('<div class="lcell">').append(this.badge=$('<svg height="8" width="8" class="indicator" focusable="false"><circle cx="4" cy="4" r="4"></svg>').toggleClass("hidden",!this.model.get("hasBadge")),$('<div class="icon">').append(this.$icon),$('<div class="title">').text(this.model.get("title"))),this.drawUpsellIcon(this.$cell.find(".title")),this.$cell},toggleBadge:function(){this.badge.toggleClass("hidden",!this.model.get("hasBadge"))},updateTooltip:function(){if(this.quicklaunch){var e=this.model.get("tooltip");e=this.model.get("title")+(e?" ("+e+")":""),this.$el.attr("aria-label",e),this.$cell.attr({"aria-hidden":!0,title:e})}},updateTitle:function(e,t){var i=this.icon.find(".title");i.text(t),this.drawUpsellIcon(i)},render:function(){return this.$el.empty().attr({"data-id":this.model.get("id"),"data-app-name":this.model.get("name")}).toggleClass("active",ox.ui.App.isCurrent(this)).append(this.icon=this.drawIcon()),this.updateTooltip(),this.addAccessKey(),this}}),u={quickLaunchLimit:5,getQuickLauncherCount:function(){var e=r.get("apps/quickLaunchCount",3);return _.isNumber(e)?Math.min(this.quickLaunchLimit,ox.ui.apps.forLauncher().length,e):0},getQuickLauncherDefaults:function(){return"io.ox/mail/main,io.ox/calendar/main,io.ox/files/main"},getQuickLauncherItems:function(){var e=this.getQuickLauncherCount(),t=String(r.get("apps/quickLaunch",this.getQuickLauncherDefaults())).trim().split(/,\s*/);return(_.chain(t).filter(function(e){return ox.ui.apps.get(e.replace(/\/main$/,""))}).value().join(",")+new Array(e).join(",none")).split(",").slice(0,e)}},p=Backbone.Collection.extend({initialize:function(){this.reload(),r.on("change:apps/quickLaunch change:apps/quickLaunchCount",this.reload.bind(this)),this.listenTo(ox.ui.apps,"add reset",this.reload)},reload:function(){this.reset(this.fetch())},fetch:function(){var e=u.getQuickLauncherItems().map(function(e){return ox.ui.apps.get(e.replace(/\/main$/,""))});return _(e).compact()}}),f=Backbone.View.extend({attributes:{id:"io-ox-quicklaunch",role:"toolbar"},events:{"click button":"onClick",contextmenu:"onContextmenu"},initialize:function(){this.collection=new p,this.listenTo(this.collection,{reset:this.render})},onClick:function(){l(!1)},onContextmenu:function(e){e.preventDefault(),require(["io.ox/core/settings/dialogs/quickLauncherDialog"],function(e){e.openDialog()})},render:function(){return this.$el.empty().append(this.collection.map(function(e){return new c({tagName:"button",attributes:{tabindex:-1,type:"button"},model:e,quicklaunch:!0}).render().$el.attr("tabindex",-1)})),this.$el.find("button").first().removeAttr("tabindex"),this}}),h=a.extend({attributes:{role:"presentation",dontprocessonmobile:"true"},tagName:"li",options:{dontProcessOnMobile:!0},className:"launcher dropdown",id:"io-ox-launcher",$ul:$('<ul class="launcher-dropdown dropdown-menu dropdown-menu-right" role="menu">'),$toggle:$('<a href="#" class="launcher-btn btn btn-link dropdown-toggle" dontprocessonmobile="true">').attr("aria-label",s("Navigate to:")).append($(n.launcher).attr("title",s("All Applications"))),initialize:function(){a.prototype.initialize.apply(this,arguments),this.listenTo(this.collection,"add remove launcher:update launcher:sort",this.update),this.update()},update:function(){this.$ul.empty(),this.collection.forLauncher().forEach(function(e,t){this.append(new c({model:e,pos:t+1}).render().$el)}.bind(this)),_.device("smartphone")&&this.collection.where({closable:!0}).forEach(function(e){this.append(new c({model:e}).render().$el)}.bind(this))}});return ox.once("core:load",function(){ox.manifests.loadPluginsFor("io.ox/core/notifications").done(function(){i.point("io.ox/core/notifications/badge").invoke("register",self,{})})}),i.point("io.ox/core/appcontrol").extend({id:"init",index:100,draw:function(){var e;$("#io-ox-core").append(e=$('<div id="io-ox-launchgrid-overlay">').on("click",l)),_.device("smartphone")&&e.on("touchstart",function(e){e.preventDefault(),l()}),d(),ox.ui.apps.on("launch resume",function(e){e.get("floating")||($(".launcher-dropdown").find(".lcell[data-app-name]").removeClass("active").end().find('.lcell[data-app-name="'+e.get("name")+'"]').addClass("active"),$("#io-ox-quicklaunch").find(".lcell[data-id]").removeClass("active").end().find('.lcell[data-id="'+e.get("name")+'"]').addClass("active"),_.defer(function(){$(document).trigger("resize")}))})}}),i.point("io.ox/core/appcontrol").extend({id:"skiplinks",index:150,draw:function(){this.append($('<a class="skip-links sr-only sr-only-focusable" href="#">').append($("<span>").text(s("Skip to main content"))))}}),i.point("io.ox/core/appcontrol").extend({id:"logo",index:300,draw:function(){var e,t=r.get("logoFileName","logo.png"),i=r.get("logoAction",!1);if(this.append(e=$('<div id="io-ox-top-logo">').append($("<img>").attr({alt:ox.serverConfig.productName,src:ox.base+"/apps/themes/"+ox.theme+"/"+t}))),/^https?:/.test(i))e.wrap($('<a class="btn btn-link logo-btn">').attr({href:i,target:"_blank"}));else if(i&&!ox.openedInBrowserTab){var o=r.get("autoStart");if("autoStart"===i){if("none"===o)return;i=o}e.wrap($('<button type="button" class="logo-btn btn btn-link">').on("click",function(){ox.launch(i)}))}}}),i.point("io.ox/core/appcontrol").extend({id:"quicklauncher",index:400,draw:function(){if(!_.device("smartphone")){var e=window.quicklaunchers=new f;this.append(e.render().$el)}}}),i.point("io.ox/core/appcontrol/right").extend({id:"launcher",index:120,draw:function(){var e=window.launchers=new h({collection:ox.ui.apps,dontProcessOnMobile:!0});this.append(e.render().$el)}}),i.point("io.ox/core/appcontrol").extend({id:"search",index:500,draw:function(){var e=$('<div id="io-ox-topsearch">');this.append(e)}}),i.point("io.ox/core/appcontrol").extend({id:"right",index:600,draw:function(){var e=$('<ul class="taskbar list-unstyled" role="toolbar">');this.append($('<div id="io-ox-toprightbar">').append(e)),i.point("io.ox/core/appcontrol/right").invoke("draw",e)}}),i.point("io.ox/core/appcontrol").extend({id:"show",index:1e4,draw:function(){this.attr("role","banner").show()}}),_.extend(u,{LauncherView:c,LaunchersView:h})}),define("io.ox/core/main/autologout",["io.ox/core/main/logout","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i){!function(){var o,n=10,a=30,r=0,s=null,l=null,d=null,c=!1,u=!1,p=!1,f=function(){return Math.ceil((o+r-_.now())/1e3)},h=function(){return parseInt(t.get("autoLogout",0),10)},g=function(){clearTimeout(s),s=setTimeout(function(){e({autologout:!0})},r),o=_.now(),c=!1},m=function(){return null!==s&&null!==l},v=$.noop,x=function(){if(ox.tabHandlingEnabled&&p&&v(),c&&null===d)g();else{var t=f();t<=a&&null===d&&require(["io.ox/backbone/views/modal"],function(o){var n=t,a=function(e){return i.format(i.ngettext("You will be automatically signed out in %1$d second","You will be automatically signed out in %1$d seconds",e),e)},r=$("<span>").text(a(n)),l=setInterval(function(){n<=0?(clearInterval(l),e({autologout:!0})):(n--,r.text(a(n)))},1e3);clearTimeout(s),d&&(ox.off("logout:failed",d.logoutFailed),d.close()),(d=new o({async:!0,title:i("Automatic sign out"),backdrop:!0}).build(function(){this.$body.append(r),this.$el.addClass("auto-logout-dialog")}).addCancelButton().addButton({action:"retry",label:i("Retry"),className:"btn-default"}).addButton({action:"force",label:i("Sign out now")}).open()).on("close",function(){g(),clearInterval(l),d=null,ox.handleLogoutError=!1}),d.on("force",function(){if(g(),clearInterval(l),d.$el.hasClass("logout-failed")){d.pause();var t=new o({async:!0,title:i("Are you sure?"),backdrop:!0}).build(function(){this.$body.append($('<div class="alert alert-danger">').text(i("Forcing logout may cause data loss.")))}).addCancelButton().addButton({action:"force",label:i("Force sign out")}).open();t.on("cancel",function(){d.resume()}),t.on("force",function(){e({force:!0}),d.close(),this.close()})}else e()}),d.on("retry",function(){g(),clearInterval(l),e()}),d.logoutFailed=function(e){if(d){ox.handleLogoutError=!0;var t=e[0]&&e[0].error?e[0].error:e[0];d.idle(),d.$el.toggleClass("logout-failed",!0),d.$el.find('[data-action="force"]').text(i("Force sign out")),d.$body.empty().append($('<div class="alert alert-danger">').append($("<div>").text(i("Logout failed.")),_.isString(t)?$("<div>").text(t):""))}},ox.on("logout:failed",d.logoutFailed)})}},b=function(){c=!0},w=function(){(r=h())>0&&null===s&&($(document).on("mousedown mousemove scroll touchstart touchmove keydown",b),g(),l=setInterval(x,1e3*n))},y=function(){l&&s&&(clearTimeout(s),clearInterval(l),s=l=null,ox.tabHandlingEnabled&&(r=0),$(document).off("mousedown mousemove scroll touchstart touchmove keydown",b))},k=function(){y(),w()};ox.autoLogout={start:w,stop:y,restart:k,debug:function(){n=1,a=10,h=function(){return 12e3},k()},logout:e.bind(null,{autologout:!0})},ox.tabHandlingEnabled&&require(["io.ox/core/api/tab"],function(i){function n(){i.propagate("propagateLeaderChanged",{exceptWindow:i.getWindowName()})}function a(){i.propagate("propagateResetAutoLogoutTimeout",{exceptWindow:i.getWindowName()})}function l(){var e=_.first(_.filter(i.getWindowList(),function(e){return e.windowName!==i.getWindowName()}));return e?e.windowName:""}v=function(){i.propagate("propagatePause",{})},g=function(){clearTimeout(s),r<=0||(s=setTimeout(function(){e({autologout:!0})},r),o=_.now(),c=!1,u||(o=_.now()+1e3),u&&a())},t.on("change:autoLogout",function(e){i.propagate("propagateSettingsAutoLogout",{val:e,exceptWindow:i.getWindowName()})}),i.communicationEvents.listenTo(i.communicationEvents,"propagateResetAutoLogoutTimeout",function(){u=!1,d&&d.close(),m()&&g()}),i.communicationEvents.listenTo(i.communicationEvents,"propagateSettingsAutoLogout",function(e){var i=parseInt(e.val,10);t.set("autoLogout",i,{silent:!0}),0===i?y():w()}),i.communicationEvents.listenTo(i.communicationEvents,"nextWindowActive",function(){u=!0,n()}),i.communicationEvents.listenTo(i.communicationEvents,"propagatePause",function(){u&&g()}),i.communicationEvents.listenTo(i.communicationEvents,"propagateLeaderChanged",function(){u=!1,m()&&g()}),i.sessionEvents.listenTo(i.sessionEvents,"before:propagatedLogout",function(){d&&d.close(),y()}),require(["io.ox/core/tk/visibility-api-util"]).done(function(e){$(e).on("visibility-changed",function(e,t){!1===t.currentHiddenState&&(u=!0,n(),m()&&g())})}),i.communicationEvents.listenTo(i.communicationEvents,"beforeunload",function(e){if(!e){var t=l();t&&i.propagate("nextWindowActive",{targetWindow:t})}}),_.extend(ox.autoLogout,{start:function(){p=!1},stop:function(){p=!0}}),u=!0,n()}),t.on("change:autoLogout",function(e){if(0===parseInt(e,10))return y();w()}),w()}()}),define("io.ox/core/main/debug",[],function(){var e=$.noop;return/\bcore/.test(_.url.hash("debug"))&&(e=function(){var e=_(arguments).toArray(),t=_.now()-ox.t0;e.unshift("core ("+(t/1e3).toFixed(1)+"s): "),console.log.apply(console,e)}),e}),define("io.ox/core/main/apps",["io.ox/core/api/apps","io.ox/core/capabilities","io.ox/core/desktop","io.ox/core/main/icons","gettext!io.ox/core"],function(e,t,i,o,n){i.createApp({id:"io.ox/mail",name:"io.ox/mail",title:n.pgettext("app","Mail"),requires:"webmail",refreshable:!0,searchable:!0,settings:!0,icon:o["io.ox/mail"]}),i.createApp({name:"io.ox/mail/detail",requires:"webmail",refreshable:!0}),i.createApp({id:"io.ox/calendar",name:"io.ox/calendar",title:n.pgettext("app","Calendar"),searchable:!0,settings:!0,requires:"calendar",refreshable:!0,icon:o["io.ox/calendar"]}),i.createApp({name:"io.ox/calendar/detail",requires:"calendar",refreshable:!0}),i.createApp({name:"io.ox/calendar/edit",requires:"calendar",refreshable:!0}),i.createApp({id:"io.ox/contacts",name:"io.ox/contacts",title:n.pgettext("app","Address Book"),refreshable:!0,requires:"contacts",searchable:!0,settings:!0,icon:o["io.ox/contacts"]}),i.createApp({name:"io.ox/contacts/edit",requires:"contacts",refreshable:!0}),i.createApp({name:"io.ox/contacts/detail",requires:"contacts",refreshable:!0}),i.createApp({id:"io.ox/portal",name:"io.ox/portal",title:n.pgettext("app","Portal"),requires:"portal",refreshable:!0,settings:!0,icon:o["io.ox/portal"]}),i.createApp({id:"io.ox/files",name:"io.ox/files",title:n.pgettext("app","Drive"),requires:"infostore",refreshable:!0,searchable:!0,settings:t.has("!guest"),icon:o["io.ox/files"]}),i.createApp({name:"io.ox/files/detail",requires:"infostore",refreshable:!0}),i.createApp({id:"io.ox/tasks",name:"io.ox/tasks",title:n.pgettext("app","Tasks"),requires:"tasks",refreshable:!0,searchable:!0,settings:t.has("delegate_tasks"),icon:o["io.ox/tasks"]}),i.createApp({name:"io.ox/tasks/edit",requires:"tasks",refreshable:!0}),i.createApp({name:"io.ox/tasks/detail",requires:"tasks",refreshable:!0}),ox.debug&&i.createApp({id:"io.ox/notes",name:"io.ox/notes",title:n.pgettext("app","Notes"),requires:"notes && infostore",device:"!smartphone",refreshable:!0,searchable:!0}),i.createApp({id:"io.ox/editor",name:"io.ox/editor",title:n("Editor"),settings:!1,requires:"infostore",visible:!1,deeplink:!0}),i.createApp({id:"io.ox/search",name:"io.ox/search",title:n("Search"),requires:"search",settings:!1,visible:!1}),i.createApp({id:"io.ox/settings",name:"io.ox/settings",title:n("Settings"),refreshable:!0})}),define("io.ox/core/main/logout",["io.ox/core/session","io.ox/core/http","io.ox/core/extensions","io.ox/core/capabilities","io.ox/backbone/views/modal","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,o,n,a,r){function s(){var e=o.has("guest")?a.get("customLocations/guestLogout")||ox.serverConfig.guestLogoutLocation:a.get("customLocations/logout")||ox.serverConfig.logoutLocation;return _.url.vars(e||ox.logoutLocation||"")}function l(e){if(/#autologout=true/.test(e)){var t=document.createElement("a");return t.href=e,location.host===t.host&&location.pathname===t.pathname}}function d(e){var t=s();e.autologout&&(t=t+(t.indexOf("#")>-1?"&":"#")+"autologout=true"),_.url.redirect(_.url.vars(t)),l(t)&&_.defer(function(){location.reload(!0)})}i.point("io.ox/core/logout").extend({id:"tabLogoutFollower",index:"first",logout:function(e){function i(e,t){try{d(t)}finally{e.reject()}}if(!ox.tabHandlingEnabled)return $.when();var o=$.Deferred();return e.skipSessionLogout?require(["io.ox/core/api/tab"],function(n){try{n.setLoggingOutState(n.LOGGING_OUT_STATE.FOLLOWER),ox.trigger("logout"),t.disconnect(),ox.cache.clear().always(function(){i(o,e)})}catch(t){ox.debug&&console.warn("clear storage at logout did not work",t),i(o,e)}}):o.resolve(),o}}),i.point("io.ox/core/logout").extend({id:"confirmLogout",index:100,logout:function(e){if(!ox.tabHandlingEnabled||!e.manualLogout)return $.when();var t=$.Deferred();return require(["io.ox/core/api/tab"],function(e){e.otherTabsLiving().then(function(){require(["io.ox/backbone/views/modal"],function(e){var i=new e({async:!0,title:r("Sign out"),backdrop:!0}).build(function(){this.$body.append($("<div>").text(r("Are you sure you want to sign out from all related browser tabs?")))}).addCancelButton().addButton({action:"force",label:r("Sign out")}).open();i.on("close",function(){i=null,t.reject()}),i.on("force",function(){t.resolve()})})},function(){t.resolve()})}),t.promise()}}),i.point("io.ox/core/logout").extend({id:"tabLogoutLeader",index:150,logout:function(e){if(!ox.tabHandlingEnabled)return $.when();var t=$.Deferred();return require(["io.ox/core/api/tab"],function(i){try{i.setLoggingOutState(i.LOGGING_OUT_STATE.LEADER),i.propagate("propagateLogout",{autologout:e.autologout,exceptWindow:i.getWindowName(),storageKey:i.DEFAULT_STORAGE_KEYS.SESSION})}catch(e){ox.debug&&console.warn("propagate logout did not work",e)}finally{t.resolve()}}),t}}),i.point("io.ox/core/logout").extend({id:"hideUI",index:200,logout:function(){var e=$.Deferred();return $("#background-loader").fadeIn(250,function(){$("#io-ox-core").hide(),e.resolve()}),e}}),i.point("io.ox/core/logout").extend({id:"saveRestorePoint",index:300,logout:function(e){t.pause();var i=$.Deferred();return e.autologout||ox.online?$.when.apply($,ox.ui.apps.map(function(e){return e.saveRestorePoint()})).always(i.resolve):ox.ui.App.canRestore().then(function(e){e?($("#io-ox-core").show(),$("#background-loader").hide(),new n({title:r("Unsaved documents will be lost. Do you want to sign out now?")}).addButton({label:r("No"),action:"No"}).addButton({label:r("Yes"),action:"Yes"}).on("No",function(){i.reject()}).on("Yes",function(){$("#io-ox-core").hide(),$("#background-loader").show(),i.resolve()}).open()):i.resolve()}),a.save(),t.resume(),i}}),i.point("io.ox/core/logout").extend({id:"clearCache",logout:function(){return ox.cache.clear()}}),i.point("io.ox/core/logout").extend({id:"logout-button-hint",logout:function(){return t.pause(),a.set("features/logoutButtonHint/active",!1).save(),t.resume()}}),i.point("io.ox/core/logout").extend({id:"savePendingSettings",index:1e12,logout:function(){t.pause();var e=$.Deferred();return $.when.apply($,_(a.getAllPendingSettings()).map(function(e){return e.save(void 0,{force:!0})})).always(e.resolve),t.resume(),e}});return function(t){t=_.extend({autologout:!1},t||{});var o=i.point("io.ox/core/logout").list(),n=_.stepwiseInvoke(o,"logout",this,new i.Baton(t)).always(function(){if("rejected"===n.state()&&!t.force)return $("#io-ox-core").show(),$("#background-loader").fadeOut(250),ox.trigger("logout:failed",arguments);ox.tabHandlingEnabled&&t.skipSessionLogout||e.logout().always(function(){d(t)})})}}),define("io.ox/core/main/offline",["io.ox/core/notifications","gettext!io.ox/core"],function(e,t){function i(t){n||($("#io-ox-offline").text(t).stop().show().animate({bottom:"0px"},200,function(){n=!0}),e.yell("screenreader",t))}function o(){n&&$("#io-ox-offline").stop().animate({bottom:"-41px"},200,function(){$(this).hide(),n=!1})}var n=!1;ox.on({"connection:online":function(){o(),ox.online=!0},"connection:offline":function(){i(t("Offline")),ox.online=!1},"connection:up":function(){ox.online&&o()},"connection:down":function(){ox.online&&i(t("Server unreachable"))}}),ox.online||$(window).trigger("offline")}),define("io.ox/core/main/refresh",["io.ox/core/session","io.ox/core/http","io.ox/core/extensions","io.ox/core/capabilities","settings!io.ox/core"],function(e,t,i,o,n){var a;return function(){var e=_.now();i.point("io.ox/core/refresh").extend({action:_.throttle(function(){if(ox.online&&""!==ox.session)try{ox.trigger("refresh^")}catch(e){console.error("io.ox/core/refresh:default",e.message,e)}},1e4),reset:function(){e=_.now()+parseInt(n.get("refreshInterval",3e5),10)}}),a=function(){i.point("io.ox/core/refresh").invoke("action"),i.point("io.ox/core/refresh").invoke("reset")},n.on("change:refreshInterval",function(){i.point("io.ox/core/refresh").invoke("reset")}),i.point("io.ox/core/refresh").invoke("reset"),setInterval(function(){_.now()>e&&(i.point("io.ox/core/refresh").invoke("action"),i.point("io.ox/core/refresh").invoke("reset"))},1e4)}(),a}),define("io.ox/core/main/registry",["settings!io.ox/core"],function(e){!function(){var t={"mail-compose":"io.ox/mail/compose/main","client-onboarding":"io.ox/onboarding/clients/wizard"},i={};ox.registry={set:function(e,t){i[e]=t},get:function(o){return i[o]||e.get("registry/"+o)||t[o]},call:function(e,t){var i=this.get(e),o=_(arguments).toArray().slice(2);return ox.load([i]).then(function(e){if(e.run&&_.isFunction(e.run))return e.run.apply(e,o);if(e.reuse&&e.getApp&&!e.reuse(t,o[0]))return e.getApp().launch().then(function(){return this[t].apply(this,o)})})}}}()}),define("io.ox/core/main/stages",["io.ox/core/extensions","io.ox/core/notifications","io.ox/core/capabilities","io.ox/core/api/apps","io.ox/core/folder/api","io.ox/core/main/debug","settings!io.ox/core","settings!io.ox/contacts","gettext!io.ox/core"],function(e,t,i,o,n,a,r,s,l){var d=$("#io-ox-appcontrol"),c=function(e){var t=(e||"").split(/:/),i=t[0],o=t[1]||"";return{app:/\/main$/.test(i)?i:i+"/main",method:o,name:i.replace(/\/main$/,"")}},u=function(){var e=_([].concat(r.get("autoStartMobile","io.ox/mail"))).filter(function(e){return!_.isUndefined(e)&&!_.isNull(e)});return"io.ox/mail"!==e[0]&&e.push("io.ox/mail"),e},p=function(){var e=[];if("none"===r.get("autoStart"))e=[];else{var t=_.map(o.forLauncher(),function(e){return e.get("path")});e=_([].concat(r.get("autoStart"),t)).chain().filter(function(e){return!_.isUndefined(e)&&(!_.isNull(e)&&(!!/^io.ox\/settings(\/main)?$/.test(e)||t.indexOf(/main$/.test(e)?e:e+"/main")>=0))}).first(1).value()}return e};return e.point("io.ox/core/stages").extend({id:"first",index:100,run:function(){a('Stage "first"')}},{id:"app_register",index:105,run:function(){return require(["io.ox/core/main/apps","io.ox/core/main/warning"])}},{id:"appcheck",index:110,run:function(e){a('Stage "appcheck"');var t,o=_.url.hash(),n=!("!!"in o);if("infostore"===o.m&&(o.m="files"),n&&o.app&&o.folder&&o.id&&0!==o.folder.indexOf("virtual/")&&o.id.indexOf(",")<0){var r=/^\d+\./.test(o.id)?o.id.replace(/\./,"/"):o.id;t=/^io.ox\/(mail|contacts|calendar|tasks)$/.test(o.app),_.url.hash({app:t?o.app+"/detail":o.app,folder:o.folder,id:r}),e.isDeepLink=!0}else o.m&&o.f&&o.i?(t=/^(mail|contacts|calendar|tasks)$/.test(o.m),_.url.hash({app:"io.ox/"+(t?o.m+"/detail":o.m),folder:o.f,id:o.i}),e.isDeepLink=!0):o.m&&o.f&&(_.url.hash({app:"io.ox/"+o.m,folder:o.f}),e.isDeepLink=!0);_.url.hash({m:null,f:null,i:null,"!!":void 0,"!":null}),_.device("smartphone")&&u();var s=_.url.hash("app"),l=s&&ox.ui.apps.get(c(s).name),d=n&&l&&l.get("deeplink"),f=void 0!==_.url.hash("mailto")&&s===ox.registry.get("mail-compose")+":compose";l&&(l.get("refreshable")||d)?e.autoLaunch=s.split(/,/):i.has("webmail")&&f?e.autoLaunch=["io.ox/mail/main"]:(l&&_.url.hash({app:null,folder:null,id:null}),e.autoLaunch=p())}},{id:"autoLaunchApps",index:120,run:function(e){a('Stage "autoLaunchApps"'),e.autoLaunchApps=_(e.autoLaunch).chain().map(function(e){return c(e).app}).compact().value()}},{id:"startLoad",index:130,run:function(t){function i(e){return function(i){var o=i&&i.message||"";throw console.error("core: Failed to load:",e,o,i,t),i}}a('Stage "startLoad"'),t.loaded=$.when(e.loadPlugins().fail(i("loadPlugins")),require(t.autoLaunchApps).fail(i("autoLaunchApps")),require(["io.ox/core/api/account"]).then(function(e){var t=$.Deferred();return e.all().always(t.resolve),t},i("account")))}},{id:"secretCheck",index:250,run:function(){if(a('Stage "secretCheck"'),ox.online&&ox.rampup&&ox.rampup.oauth){var e=ox.rampup.oauth.secretCheck;e&&!e.secretWorks&&(require(["io.ox/keychain/secretRecoveryDialog"],function(e){e.show()}),ox.debug&&console.error("Couldn't decrypt accounts: ",e.diagnosis))}}},{id:"drawDesktop",index:500,run:function(){e.point("io.ox/core/desktop").invoke("draw",$("#io-ox-desktop"),{}),ox.ui.windowManager.on("empty",function(t,i,o){if(i){e.point("io.ox/core/desktop").invoke("draw",$("#io-ox-desktop"),{}),ox.ui.screens.show("desktop");var n=c(o||r.get("autoStart","io.ox/mail/main")).app;"none/main"!==n&&ox.launch(n)}else ox.ui.screens.show("windowmanager")})}},{id:"load",index:600,run:function(e){return a('Stage "load"',e),e.loaded}},{id:"topbars",index:610,run:function(){if(a('Stage "load" > loaded.done'),e.point("io.ox/core/appcontrol").invoke("draw",d),_.device("smartphone")&&e.point("io.ox/core/mobile").invoke("draw"),e.point("io.ox/core/topbar").isEnabled("default")||($("#io-ox-screens").css("top","0px"),d.hide()),e.point("io.ox/core/plugins").invoke("draw"),a('Stage "load" > autoLaunch ...'),!ox.tabHandlingEnabled)return ox.ui.App.restore();require(["io.ox/core/api/tab"],function(e){return!e.isParentTab()||ox.ui.App.restore()})}},{id:"restoreLaunch",index:620,run:function(e){var o=_.copy(_.url.hash()),r=e.autoLaunch.length>0;if(_(e.autoLaunch).chain().map(function(e){return c(e)}).each(function(e,l){if(0===l&&(r=!1),!(_.device("smartphone")&&l>0||_.device("smartphone")&&ox.ui.apps.where({restored:!0,name:e.name}).length)){var d,c,u=_(o).pick("folder","id");if(a("Auto launch:",e.app,u),/detail\/main$/.test(e.app)){var p=e.app.replace(/\/detail/,"");(d=ox.launch(p,u)).done(function(){_.delay(function(){ox.launch(e.app,{cid:_.cid(u)})},1e3)})}else d=ox.launch(e.app,u);c=e.method,"io.ox/files"===o.app&&void 0!==o.id&&require(["io.ox/core/viewer/main","io.ox/files/api"],function(e,i){n.get(o.folder).done(function(){i.get(o).done(function(t){(new e).launch({files:[t],folder:o.folder})})}).fail(function(e){_.url.hash("id",null),t.yell(e)})}),c&&d.done(function(){_.isFunction(this[c])&&this[c]()});var f=_.url.hash("reg"),h=_(_.url.hash()).reduce(function(e,t,i){return"showfeedbackdialog"===i.toLowerCase()?t:e});if(f&&ox.registry.get(f)){var g,m=(_.url.hash("regopt")||"").split(","),v={};_.each(m,function(e){g=e.split(":"),v[g[0]]=g[1]}),d.done(function(){ox.registry.call(f,"client-onboarding",{data:v})})}"true"===h&&i.has("feedback")&&d.done(function(){require(["plugins/core/feedback/register"],function(e){e.show()})}),s.get("features/furigana",!1)&&require(["l10n/ja_JP/io.ox/register"])}}),r||ox.rampup&&ox.rampup.errors){var d=_.pluck(ox.rampup.errors,"error").join("\n\n");d=d||l("The requested application is not available at this moment."),t.yell({type:"error",error:d,duration:-1})}}},{id:"curtain",index:700,run:function(){a('Stage "curtain"');var e=$.Deferred();return $("#background-loader").idle().fadeOut(250,e.resolve),e}},{id:"ready",index:1e12,run:function(){a("DONE!"),ox.trigger("core:ready")}}),{restore:function(e){return l.ngettext("The below item was open last time you exited %1$s.","The below items were open last time you exited %1$s.",e,ox.serverConfig.productName)+" "+l('Please click "Continue" if you\'d like to continue editing.')+" "+l.ngettext("If you do not wish to keep the item, please click on the trash icon.","If you do not wish to keep an item, please click on the trash icon.",e)}}}),define("io.ox/core/main/topbar_right",["io.ox/core/session","io.ox/core/http","io.ox/core/extensions","io.ox/core/capabilities","io.ox/core/notifications","io.ox/backbone/mini-views/helplink","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/upsell","io.ox/core/main/logout","io.ox/core/main/refresh","io.ox/core/main/addLauncher","io.ox/contacts/api","io.ox/core/api/user","settings!io.ox/core","gettext!io.ox/core"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f,h){function g(){var e=ox.ui.App.getCurrentFloatingApp()||ox.ui.App.getCurrentApp();return e&&e.getContextualHelp?e.getContextualHelp():_.extend({base:"help",target:"index.html"},e&&e.get("help"))}i.point("io.ox/core/appcontrol/right").extend({id:"upsell",index:50,draw:function(){if(!_.device("smartphone")){var e=new s({tagName:"li",className:"launcher",id:"secondary-launcher",requires:"active_sync || caldav || carddav",customize:function(){$("i",this.$el).addClass("launcher-icon")}});e.visible&&this.append(e.render().$el)}}}),i.point("io.ox/core/appcontrol/right").extend({id:"notifications",index:100,draw:function(){if(o.has("webmail")||o.has("calendar")||o.has("tasks")){var e=this;ox.online?e.append(n.attach(5e3)):ox.once("connection:online",function(){e.append(n.attach(5e3))})}}}),i.point("io.ox/core/appcontrol/right").extend({id:"search-mobile",index:150,draw:function(){o.has("search")&&_.device("smartphone")&&this.append(c("right",$('<i class="fa fa-search launcher-icon" aria-hidden="true">'),function(){require(["io.ox/search/main"],function(e){e.run({reset:!0})})},h("Search")).attr("id","io-ox-search-topbar-icon"))}}),i.point("io.ox/core/appcontrol/right").extend({id:"refresh",index:200,draw:function(){function e(){var e=parseInt(f.get("refreshInterval",3e5),10)/6e4;return t.attr("title",h("Refresh. Current interval (%1$s min) can be customized in settings.",e))}if(!_.device("smartphone")){var t=$('<i class="fa fa-refresh launcher-icon" aria-hidden="true">');this.append(c("right",t,function(){return d(),$.when()},h("Refresh")).attr("id","io-ox-refresh-icon")),e(),f.on("change:refreshInterval",e)}}}),i.point("io.ox/core/appcontrol/right").extend({id:"help",index:300,draw:function(){if(!_.device("smartphone")){var e=new a({iconClass:"fa-question launcher-icon",href:g});e.$el.hasClass("hidden")||this.append(c("right",e.render().$el.attr("tabindex",-1)).attr("id","io-ox-context-help-icon"))}}}),i.point("io.ox/core/appcontrol/right").extend({id:"settings",index:400,draw:function(){_.device("smartphone")||this.append(c("right",$('<i class="fa fa-cog launcher-icon" aria-hidden="true">').attr("title",h("Settings")),function(){ox.launch("io.ox/settings/main")},h("Settings")).attr("id","io-ox-settings-topbar-icon"))}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"upsell",index:50,extend:function(){var e=new s({tagName:"li",id:"topbar-dropdown",requires:"active_sync || caldav || carddav",title:h("Upgrade your account"),customize:function(){$("i",this.$el).css({width:"auto"})}});e.visible&&(this.append(e.render().$el),this.divider())}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"refreshMobile",index:80,extend:function(){_.device("smartphone")&&this.link("refresh-mobile",h("Refresh"),function(e){return e.preventDefault(),d(),$.when()})}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"settingsMobile",index:90,extend:function(){_.device("smartphone")&&this.link("settings-mobile",h("Settings"),function(e){return e.preventDefault(),ox.launch("io.ox/settings/main")})}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"onboarding",index:120,extend:function(){if(!o.has("!client-onboarding")){var e,t,i=this;_.device("android")&&(e=_.device("smartphone")?"android.phone":"android.tablet"),_.device("ios")&&(e=_.device("smartphone")?"apple.iphone":"apple.ipad"),i.append(t=$('<a href="#" data-app-name="io.ox/settings" data-action="client-onboarding" role="menuitem" tabindex="-1">').text(h(_.device("desktop")?"Connect your Device":"Connect this Device"))),require(["io.ox/onboarding/clients/api"],function(i){i.enabledDevices(e).then(function(i){var o=!!_.device("desktop")||(i[e]||!1);t.toggleClass("disabled ui-disabled",!o).attr("aria-disabled",!o).on("click",function(e){if(e.preventDefault(),!o)return e.stopPropagation();require(["io.ox/onboarding/clients/wizard"],function(e){e.run()})})})})}}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"change-user-data",index:150,extend:function(){!1!==f.get("user/internalUserEdit",!0)&&this.link("my-contact-data",h("My contact data"),function(e){e.preventDefault(),require(["io.ox/core/settings/user"],function(e){e.openModalDialog()})})}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"change-user-password",index:175,extend:function(){o.has("edit_password && guest")&&this.link("change-password",h(f.get("password/emptyCurrent")?"Add login password":"Change login password"),function(e){e.preventDefault(),require(["plugins/portal/userSettings/register"],function(e){e.changePassword()})})}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"app-specific-help",index:200,extend:function(){var e=new a({attributes:{role:"menuitem",tabindex:-1},content:h("Help"),href:g});this.divider(),e.$el.hasClass("hidden")||this.append(e.render().$el)}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"divider-before-about",index:290,extend:function(){this.divider()}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"about",index:400,extend:function(){this.link("about",h("About"),function(e){e.preventDefault(),require(["io.ox/core/about/about"],function(e){e.show()})})}}),i.point("io.ox/core/appcontrol/right/dropdown").extend({id:"logout",index:1e3,extend:function(){this.divider(),i.point("io.ox/core/appcontrol/right/dropdown/signouts").invoke("extend",this)}}),i.point("io.ox/core/appcontrol/right/dropdown/signouts").extend({id:"logout",index:100,extend:function(){this.link("logout",h("Sign out"),function(e){e.preventDefault(),l({manualLogout:!0})})}}),i.point("io.ox/core/appcontrol/right").extend({id:"dropdown",index:1e3,draw:function(){function e(){n.empty().append(u.pictureHalo($('<div class="contact-picture" aria-hidden="true">').attr("title",t).append(p.getTextNode(ox.user_id,{type:"initials"})),{internal_userid:ox.user_id},{width:40,height:40,fallback:!1}))}var t=h(ox.openedInBrowserTab?"Sign out":"Support"),o=$('<ul id="topbar-settings-dropdown" class="dropdown-menu dropdown-menu-right" role="menu">'),n=$('<a href="#" class="dropdown-toggle f6-target" data-toggle="dropdown" tabindex="-1">').attr("aria-label",t),a=new r({attributes:{role:"presentation"},tagName:"li",id:"io-ox-topbar-dropdown-icon",className:"launcher dropdown",$ul:o,$toggle:n});e(),i.point("io.ox/core/appcontrol/right/dropdown").invoke("extend",a),this.append(a.render().$el.find("a").attr("tabindex",-1).end()),u.on("reset:image update:image",e),p.on("reset:image:"+ox.user_id+" update:image:"+ox.user_id,e),p.on("update",e)}}),!0===f.get("features/dedicatedLogoutButton",!1)&&_.device("!small")&&i.point("io.ox/core/appcontrol/right").extend({id:"logout-button",index:2e3,draw:function(){var e=c("right",$('<i class="fa fa-sign-out launcher-icon" aria-hidden="true">'),function(){l({manualLogout:!0})},h("Sign out"));e.find("a").attr("data-action","sign-out").tooltip({title:h("Sign out"),placement:function(e,t){return $(window).width()-$(t).offset().left-t.offsetWidth<80?"left":"auto"}}),this.append(e)}}),function(){var t=_.clone(f.get("features/logoutButtonHint",{}));t.enabled&&i.point("io.ox/core/appcontrol/right").extend({id:"logout-button-hint",index:2100,draw:function(){if(f.set("features/logoutButtonHint/active",!0).save(),_.isBoolean(t.active)&&t.active&&(!_.device("reload")||!e.isAutoLogin())){var i=this.find('[data-action="sign-out"], #io-ox-topbar-dropdown-icon > a').first();i.popover({content:t[ox.language]||h("You forgot to sign out last time. Always use the sign-out button when you finished your work."),template:'<div class="popover popover-signout" role="tooltip"><div class="arrow"></div><div class="popover-content popover-content-signout"></div></div>',placement:"bottom",container:"body"}),this.get(0).addEventListener("click",function(e){e.target.classList.contains("popover-content-signout")&&e.stopImmediatePropagation(),i.popover("destroy")},!0),$(document).one("click",i.popover.bind(i,"destroy")),_.defer(i.popover.bind(i,"show"))}}})}(),i.point("io.ox/core/appcontrol/right").extend({id:"client-onboarding-hint",index:2200,draw:function(){function t(){f.set("features/clientOnboardingHint/remaining",Math.max(0,i.remaining-1)).save(),n.popover("destroy"),document.body.removeEventListener("click",t,!0)}if(!o.has("!client-onboarding")&&_.device("smartphone")&&(!_.device("reload")||!e.isAutoLogin())){var i=_.extend({enabled:!0,remaining:2},f.get("features/clientOnboardingHint",{}));if(i.enabled&&i.remaining){var n=this.find("#io-ox-topbar-dropdown-icon > a");n.popover({content:h("Did you know that you can take %1$s with you? Just click this icon and choose 'Connect your device' from the menu.",ox.serverConfig.productName),template:'<div class="popover popover-onboarding" role="tooltip"><div class="arrow"></div><div class="popover-content popover-content-onboarding"></div></div>',placement:"bottom",container:"body"}),_.defer(n.popover.bind(n,"show")),document.body.addEventListener("click",t,!0)}}}})}),define("io.ox/core/main/warning",["io.ox/core/notifications","io.ox/core/folder/api","gettext!io.ox/core"],function(e,t,i){t.on("warn:hidden",function(t){t&&e.yell("info",i('Folder with name "%1$s" will be hidden. Enable setting "Show hidden files and folders" to access this folder again.',t.title))}),ox.on("http:error",function(t){switch(t.code){case"MSG-1000":case"MSG-1001":case"MSG-1036":case"MSG-1038":case"MSG-1039":case"MSG-1040":case"MSG-1031":case"MSG-0114":case"OAUTH-0013":case"OAUTH-0042":case"OAUTH-0043":case"OAUTH-0044":e.yell(t);break;case"LGI-0016":_.url.redirect(_.url.vars(t.error))}});var o=function(){var e=function(e,t){return t.test(e)},t=[/^SHR_NOT-\d{4}$/,/^RSS-0007/,/^MSG-1001/];return function(i){var o=_.partial(e,i);return!!_.find(t,o)}}();ox.on("http:warning",function(t){if(o(t.code))return e.yell("warning",t.error);ox.debug&&console.warn("server response: ",t.error)})}),define("io.ox/core/main",["io.ox/core/desktop","io.ox/core/extensions","io.ox/core/extPatterns/stage","io.ox/core/notifications","io.ox/core/commons","io.ox/core/upsell","io.ox/core/ping","io.ox/core/a11y","io.ox/core/main/logout","io.ox/core/main/refresh","io.ox/core/main/topbar_right","io.ox/core/main/debug","settings!io.ox/core","gettext!io.ox/core","io.ox/backbone/views/window","io.ox/core/main/registry","io.ox/core/main/offline","io.ox/core/relogin","io.ox/core/links","io.ox/core/http_errors","io.ox/backbone/views/disposable","io.ox/tours/get-started","io.ox/core/main/icons","io.ox/core/main/appcontrol","io.ox/core/main/stages","io.ox/core/main/designs"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f){return $("#io-ox-windowmanager").on("scroll",function(){this.scrollTop>0&&(this.scrollTop=0)}),u("core: Loaded"),ox.trigger("core:load"),_.stepwiseInvoke=function(e,t,i){function o(e){s.push(e)}function n(){if(0===e.length)return r.resolve(s);var l=e.shift();if(l&&_.isFunction(l[t])){var d=l[t].apply(i,a);if(d&&d.promise)return d.done(o).then(n,r.reject)}n()}if(!_.isArray(e))return $.when();var a=Array.prototype.slice.call(arguments,3),r=$.Deferred(),s=[];return n(),r.promise()},t.point("io.ox/core/mobile").extend({id:"i18n",draw:function(){$(document).trigger("dropdown:translate",f("Close"))}}),{logout:l,launch:function(){""===location.hash&&(location.hash="#!!");var e=t.Baton();u("core: launch > run stages"),i.run("io.ox/core/stages",e)}}}),define("io.ox/core/links",["io.ox/core/yell","io.ox/core/capabilities"],function(e,t){function i(t,i){require(["io.ox/core/folder/api"],function(o){o.get(i).then(function(){ox.launch(t,{folder:i}).done(function(){"io.ox/calendar/main"===t?this.folders.setOnly(i):this.folder.get()!==i&&this.folder.set(i)})},e)})}var o=function(e){e.preventDefault();var t=$(this).data(),i=/^io.ox\/office\//.test(t.app)?{action:"load",file:{folder_id:t.folder,id:t.id}}:_(t).pick("folder","folder_id","id","cid");ox.launch(t.app+"/main",i).done(function(){_.isFunction(this.setSettingsPane)?this.setSettingsPane(i):t.folder&&this.folder.get()!==t.folder&&this.folder.set(t.folder)})};$(document).on("click",".deep-link-app",o);var n=function(t){t.preventDefault();var o=$(this).data();o.id?require(["io.ox/core/viewer/main","io.ox/files/api"],function(t,i){i.get(_(o).pick("folder","id")).then(function(e){(new t).launch({files:[e]})},e)}):i("io.ox/files/main",o.folder)};$(document).on("click",".deep-link-files",n);var a=function(e){e.preventDefault();var t=$(this).data();ox.launch("io.ox/contacts/main",{folder:t.folder}).done(function(){var e=this,i=t.folder,o=String(t.id||"").replace(/\//,".");e.folder.get()===i?e.getGrid().selection.set(o):e.folder.set(i).done(function(){e.getGrid().selection.set(o)})})};$(document).on("click",".deep-link-contacts",a);var r=function(t){t.preventDefault();var o=$(this).data();o.id?ox.load(["io.ox/core/tk/dialogs","io.ox/calendar/api","io.ox/calendar/view-detail","io.ox/core/folder/api"]).done(function(i,n,a,r){var s=new i.SidePopup({arrow:!_.device("chrome"),tabTrap:!0});_.device("chrome")&&s.setTarget(document.body),s.show(t,function(t){t.busy(),/^\d+\/\d+.\d+$/.test(o.id)&&(o=n.cid(o.id.replace(/\//,"."))),n.get(o).then(function(e){r.get(e.get("folder")).always(function(i){t.idle().append(a.draw(e,{container:t,noFolderCheck:void 0!==i.error}))})},function(t){s.close(),e(t)})})}):i("io.ox/calendar/main",o.folder)};$(document).on("click",".deep-link-calendar",r);var s=function(e){e.preventDefault();var t=$(this).data();ox.launch("io.ox/tasks/main",{folder:t.folder}).done(function(){var e=this,i=t.folder,o=String(t.id||"").replace(/\//,"."),n=o.indexOf(".")>-1?o:_.cid({folder:i,id:o});$.when().then(function(){if(!e.folder.get()===i)return e.folder.set(i)}).then(function(){if(o)return e.getGrid().selection.set(n)})})};$(document).on("click",".deep-link-tasks",s);var l=function(e){e.preventDefault();var t,i,o,n=$(this),a=n.data(),r={};require(["io.ox/mail/sanitizer"],function(e){if(a.address)t=a.address,i=a.name||a.address;else{o=n.attr("href").substr(7).split(/\?/,2),t=o[0],i=n.text(),r=_.deserialize(o[1]);for(var s in r)r[s.toLowerCase()]=r[s]}ox.registry.call("mail-compose","open",{to:[[i,t]],subject:r.subject||"",content:e.sanitize({content:r.body||"",content_type:"text/html"},{WHOLE_DOCUMENT:!1}).content})})},d=function(e){e.preventDefault();var t=$(this).data();require(["io.ox/settings/personalData/api"],function(e){e.trigger("updateStatus")}),ox.launch("io.ox/settings/main",{folder:t.folder}).done(function(){this.setSettingsPane({folder:t.folder})})};$(document).on("click",".deep-link-gdpr",d),t.has("webmail")&&$(document).on("click",".mailto-link",l),ox.on("click:deep-link-mail",function(e,t){var i=e.currentTarget.className.split(" ");i.indexOf("deep-link-files")>=0?n.call(t,e):i.indexOf("deep-link-contacts")>=0?a.call(t,e):i.indexOf("deep-link-calendar")>=0?r.call(t,e):i.indexOf("deep-link-tasks")>=0?s.call(t,e):i.indexOf("deep-link-gdpr")>=0?d.call(t,e):i.indexOf("deep-link-app")>=0?o.call(t,e):i.indexOf("mailto-link")>=0&&l.call(t,e)})}),define("io.ox/core/tracker/api",["settings!io.ox/core"],function(e){var t=_.extend({queue:[],add:_.noop},Backbone.Events),i=e.get("tracker/url");if(!i||!1===e.get("tracker/enabled"))return t;var o=1e3*window.parseInt(e.get("tracker/delay",15),10),n=e.get("tracker/brand","Default");t.add=function(e,i){i=_.extend({stat:e,brand:n},i),t.trigger("add",i),t.queue.push(i)};var a=setInterval(function(){if(0!==t.queue.length){var e=t.queue;t.queue=[],t.trigger("sync",e),$.post({url:i,contentType:"application/json",data:JSON.stringify(e),timeout:1e4}).fail(function(i){if(403===i.status)return t.trigger("forbidden"),clearInterval(a);t.trigger("fail",e),[].push.apply(t.queue,e)})}},o);return t}),define("io.ox/core/tracker/duration",["io.ox/core/tracker/api","io.ox/core/uuids","settings!io.ox/core"],function(e,t,i){function o(){return ox.ui.App.getCurrentApp().get("name")}function n(t){e.add("duration",{uuid:d,app:t,timestamp:ox.t0})}function a(){if("hidden"!==document.visibilityState&&ox.ui.App.getCurrentApp()){var e=o();c&&(n(e),c=!1),l[e]=l[e]?l[e]+1:1,l[e]%(60*s)==0&&n(e)}}var r,s=i.get("tracker/eyeballInterval",1)||1,l={},d=t.randomUUID(),c=!0;return{start:function(){return r||(r=setInterval(a,1e3))},stop:function(){clearInterval(r)},getCount:function(){return l}}}),define("io.ox/core/tracker/main",["io.ox/core/tracker/api","io.ox/core/tracker/duration","settings!io.ox/core"],function(e,t,i){e.add("browser"),e.add("unique",{id:ox.context_id+"/"+ox.user_id}),i.get("tracker/eyeballtime",!0)&&t.start()}),define("io.ox/mail/util",["io.ox/core/extensions","io.ox/core/util","io.ox/core/api/account","io.ox/core/capabilities","settings!io.ox/mail","settings!io.ox/contacts","gettext!io.ox/core"],function(e,t,i,o,n,a,r){var s,l=[{label:"System",font:"-apple-system,BlinkMacSystemFont,helvetica,sans-serif"},{label:"Andale Mono",font:"andale mono,times"},{label:"Arial",font:"arial,helvetica,sans-serif"},{label:"Arial Black",font:"arial black,avant garde"},{label:"Book Antiqua",font:"book antiqua,palatino"},{label:"Comic Sans MS",font:"comic sans ms,sans-serif"},{label:"Courier New",font:"courier new,courier"},{label:"Georgia",font:"georgia,palatino"},{label:"Helvetica",font:"helvetica"},{label:"Impact",font:"impact,chicago"},{label:"Symbol",font:"symbol"},{label:"Tahoma",font:"tahoma,arial,helvetica,sans-serif"},{label:"Terminal",font:"terminal,monaco"},{label:"Times New Roman",font:"times new roman,times"},{label:"Trebuchet MS",font:"trebuchet ms,geneva"},{label:"Verdana",font:"verdana,geneva"},{label:"Webdings",font:"webdings"},{label:"Wingdings",font:"wingdings,zapf dingbats"}],d=ox.serverConfig.prefix||"/ajax",c=new RegExp('(<img[^>]+src=")'+d,"g"),u=function(e,t,i){return i>1?t:e},p=function(e,t){if(!_.isNumber(e))return r("unknown");var i=$.extend({fulldate:!1,filtertoday:!0},t||{}),o=moment(e),n=function(){return o.format("LT")};if(i.filtertoday&&moment().isSame(o,"day"))return n();if(i.smart){var a=moment().startOf("day").diff(moment(e).startOf("day"),"day");if(1===a)return r("Yesterday");if(a<=6)return o.format("dddd")}return o.format("l")+(i.fulldate?" "+n():"")},f=function(e){return(e=$.trim(e||"")).indexOf("@")>-1?e.toLowerCase():e},h=/([^,;"]+|"(\\.|[^"])+")+/,g=/^[,;\s]+/,m=/^("(\\.|[^"])+"\s|[^<]+)(<[^>]+>)$/,v=/(^<|>$)/g,x={};return i.getAllSenderAddresses().done(function(e){_(e).chain().pluck(1).each(function(e){x[e.toLowerCase()]=!0})}),s={replaceImagePrefix:function(e,t){return e=e||"",t=t||"$1"+ox.apiRoot,e.replace(c,t)},parseRecipient:function(e,i){var o,n,a,r=$.trim(e),s=_.extend({localpart:!0},i);return null!==(o=r.match(m))?(a=o[3].replace(v,"").toLowerCase(),n=t.unescapeDisplayName(o[1])):(n=(a=r.replace(v,"").toLowerCase()).split(/@/)[0],s.localpart||(n=null)),[n,a]},parseRecipients:function(e,t){var i,o,n=[],a=t;if(!e)return n;for(;null!==(i=e.match(h));)e=e.substr(i[0].length).replace(g,""),((o=this.parseRecipient(i[0],a))[0]===o[1]||o[1].indexOf("@")>-1)&&n.push(o);return n},serializeList:function(e,i){for(var o,n,a,r=e[i=i||"from"]||[["",""]],s=0,l=r.length,d=$("<div>");s<l;s++)o={display_name:this.getDisplayName(r[s])},"undisclosed-recipients:;"!==(n=String(r[s][1]||"").toLowerCase())&&(o.email=n),a=t.renderPersonalName(o),o.email&&a.addClass("person-link person-"+i),d.append(a),s<l-1&&d.append($('<span class="delimiter">').text(",   "));return d.contents()},serializeAttachments:function(e,t){for(var i=0,o=t.length,n=$(),a="",r="";i<o;i++)a=t[i].filename||"",r=ox.apiRoot+"/mail?"+$.param({action:"attachment",folder:e.folder_id,id:e.id,attachment:t[i].id,delivery:"download"}),n=n.add($('<a class="attachment-link" target="_blank">').attr("href",r).text(a)),i<o-1&&(n=n.add($('<span class="delimiter">').append($.txt(" • "))));return n},getFontFormats:function(){return n.get("tinyMCE/font_formats",l.map(function(e){return e.label+"="+e.font}).join(";"))},getDefaultStyle:function(){var e=_.device("smartphone")?{}:n.get("defaultFontStyle",{}),t={css:{},string:"",node:$()};return e.size&&"browser-default"!==e.size&&(t.css["font-size"]=e.size),e.family&&(t.css["font-family"]="browser-default"!==e.family?e.family:l[0].font),e.color&&"transparent"!==e.color&&(t.css.color=e.color),t.string=_.reduce(_.pairs(t.css),function(e,t){return e+t[0]+":"+t[1]+";"},""),t.node=$("<div>").css(t.css).attr("data-mce-style",t.string).append("<br>"),t},getDisplayName:function(e,i){if(!_.isArray(e))return"";i=_.extend({reorderDisplayName:!0,showDisplayName:!0,showMailAddress:!1,unescapeDisplayName:!0},i);var o=e[0],n=String(e[1]||"").toLowerCase(),a=o;return i.unescapeDisplayName&&(a=t.unescapeDisplayName(o)),i.showDisplayName?(i.reorderDisplayName&&(a=a.replace(/^([^,.()]+),\s([^,.()]+)$/,"$2 $1")),i.showMailAddress&&a&&n&&(a+=" <"+n+">"),a||n):n},getSender:function(e,t){var i=e[1];if(!t)return[null,i];var o=n.get(["customDisplayNames",i],{});return[(o.overwrite?o.name:e[0]||o.defaultName)||"",i]},hasFrom:function(e){return e&&_.isArray(e.from)&&e.from.length>0&&!!e.from[0][1]},getFrom:function(e,i){e=e||{},i=_.extend({field:"from"},i);var o=_(e[i.field]).chain().map(function(e){return s.getDisplayName(e,i)}).filter(function(e){return""!==e}).value();return 0===o.length?$().add($.txt(r("from"===i.field?"Unknown sender":"No recipients"))):(o=_(o).reduce(function(e,i){return e.add(t.renderPersonalName({name:i}).addClass("person")).add($.txt(", "))},$())).slice(0,-1)},formatSender:function(e,i,o){var n=_(arguments).toArray();return _.isArray(n[0])&&(o=i,e=n[0][0],i=n[0][1]),e=t.unescapeDisplayName(e),i=f(i),""===e?i:(!1===o?e:'"'+e+'"')+" <"+i+">"},getSubject:function(e,t){var i=$.trim(_.isString(e)?e:e.subject);return""===i?r("No subject"):(n.get("features/cleanSubjects",!1)&&(i=i.replace(/\[[^[]*\]\s*/g,"")),t?i:i.replace(/^((re|ref|aw|fwd|wg|rv|tr)(\[\d+\])?:\s?)+/i,""))},getPriority:function(e){return e&&3===e.priority?$():e&&e.priority<3?$('<span class="high"><i class="fa fa-exclamation" aria-hidden="true"></i></span>').attr("title",r.pgettext("E-Mail","High priority")):$('<span class="low"><i class="fa fa-minus" aria-hidden="true"></i></span>').attr("title",r.pgettext("E-Mail","Low priority"))},getAccountName:function(e){var t=window.unescape(e?e.id:"");return/^default0/.test(t)?r("Primary account"):e&&e.account_name||"N/A"},getTime:function(e,t){return p(e,t)},getDateTime:function(e,t){return t=_.extend({fulldate:!0},t),p(e,t)},getFullDate:function(e){return _.isNumber(e)?moment(e).format("l LT"):r("unknown")},getSmartTime:function(e){var t=_.printf;if(console.warn("This method is deprecated and will be removed with 7.6.0 or at any random date later"),!_.isNumber(e))return r("unknown");var i=new Date,o=i.getTimezoneOffset(),n=i.getTime()-60*o*1e3-e,a=new Date(e),s=0;return a.getDate()===i.getDate()?n<36e5?(s=Math.ceil(n/6e4),String(t(u("%d minute ago","%d minutes ago",s),s))):(s=Math.ceil(n/36e5),String(t(u("%d hour ago","%d hours ago",s),s))):a.getDate()===i.getDate()-1?"Yesterday":a.getDate()+"."+(a.getMonth()+1)+"."+a.getFullYear()},threadFileSize:function(e){return e.reduce(function(e,t){return e+(t.size||0)},0)},count:function(e){return _(e).reduce(function(e,t){return e+(t.thread?t.thread.length:1)},0)},isToplevel:function(e){return _.isObject(e)&&"folder_id"in e&&!("filename"in e)},isUnseen:function(e){return e=_.isObject(e)?e.flags:e,_.isNumber(e)?32!=(32&e):void 0},isFlagged:function(e){return e=_.isObject(e)?e.flags:e,_.isNumber(e)?8==(8&e):void 0},isDeleted:function(e){return e&&_.isNumber(e.flags)?2==(2&e.flags):void 0},isSpam:function(e){return e&&_.isNumber(e.flags)?128==(128&e.flags):void 0},isAnswered:function(){return _.chain(arguments||[]).flatten().compact().reduce(function(e,t){return e||1==(1&t.flags)},!1).value()},isDecrypted:function(e){return e&&e.security&&e.security.decrypted},isForwarded:function(){return _.chain(arguments||[]).flatten().compact().reduce(function(e,t){return e||256==(256&t.flags)},!1).value()},isAttachment:function(e){return void 0!==(e||{}).parent},isEmbedded:function(e){return!!_.isObject(e)&&(void 0===e.folder_id&&void 0!==e.filename)},asList:_.memoize(function(e){return(e||"").replace(/[\s\n]+/g,",").replace(/(,+),/g,",").replace(/^,|,$/g,"").toLowerCase().split(",")}),isWhiteListed:function(e,t){var i=[].concat(s.asList(n.get("features/trusted/user",t||"")),s.asList(n.get("features/trusted/admin",""))),o=_.isObject(e)?e.from&&e.from.length&&String(e.from[0][1]||""):e||"";return i=_.compact(i),o=(o||"").trim().toLowerCase(),_.some(i,function(e){var t=e.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return o.match(new RegExp(t+"$"))})},authenticity:function(){function e(){return n.get("features/authenticity",!1)?n.get("authenticity/level","none"):"none"}function t(e){if(_.isObject(e))return _.isObject(e.authenticity)?e.authenticity.status:e.status}function i(e,t,i){return e.test(t)&&i.indexOf(t)>-1}function o(e,t,o){switch(e){case"image":return i(/(fail|suspicious)/,o,t);case"icon":return i(/(fail|suspicious|pass|trusted)/,o,t);case"via":return!0;case"box":return i(/(fail|suspicious|trusted)/,o,t);case"block":return i(/(fail|suspicious)/,o,t);default:return!1}}return function(i,n){n.authenticity_preview&&(n=_.extend({},{authenticity:n.authenticity_preview},n));var a=t(n),r=e();if(("none"!==r||"trusted"===a)&&/^(fail|suspicious|neutral|none|pass|trusted)$/.test(a))return o(i,r,a)?a:void 0}}(),getAuthenticityMessage:function(e,t){switch(e){case"suspicious":return r("Be careful with this message. It might be spam or a phishing mail.");case"fail":return r("This is a dangerous email containing spam or malware.");case"neutral":return r("We could not verify that this email is from %1$s.",t);case"pass":case"trusted":return r("We could verify that this email is from %1$s.",t);default:return""}},isMalicious:function(){if(!n.get("maliciousCheck"))return _.constant(!1);var e=n.get("maliciousFolders");return _.isArray(e)?function(t){return!!_.isObject(t)&&i.isMalicious(t.folder_id||t.parent&&t.parent.folder_id,e)}:_.constant(!1)}(),byMyself:function(e){return(e=e||{}).from&&e.from.length&&String(e.from[0][1]||"").toLowerCase()in x},hasUnsendReadReceipt:function(e){return!(_.isNumber(e.flags)?512==(512&e.flags):void 0)&&!!e.disp_notification_to},hasOtherRecipients:function(e){e=e||{};var t=[].concat(e.to||[],e.cc||[],e.bcc||[]);return _(t).reduce(function(e,t){var i=String(t[1]||"").toLowerCase();return e+(!i||i in x?0:1)},0)>0},getDefaultSignature:function(e){var t=n.get("defaultSignature")||"",i=n.get("defaultReplyForwardSignature");return/(new|edit)/.test(e)?t:_.isBoolean(i)?t:i},getInitialDefaultSender:function(){return _(n.get("defaultSendAddress",[]))._wrapped[0]},fixInlineImages:function(e){return e.replace(new RegExp('(<img[^>]+src=")'+ox.abs+ox.apiRoot),"$1"+d).replace(new RegExp('(<img[^>]+src=")'+ox.apiRoot,"g"),"$1"+d).replace(/on(mousedown|contextmenu)="return false;"\s?/g,"").replace(/data-mce-src="[^"]+"\s?/,"")},parseMsgref:function(e,t){var i=_(t.toString().split(e)),o=i.last();return{folder_id:i.without(o).join(e),id:o}},getAttachments:function(){var e=function(e){return!("filename"in e)&&e.attachments&&1===e.attachments.length&&null===e.attachments[0].content},t=function(e,t){if(e.parent&&e.parent.needsfix){var i=t.id.split(".");t.id=t.id.split(".").length>1?i.splice(1,i.length).join("."):t.id}};return function(i){var o,n,a,s,l=[],d={id:(i=i||{}).id,folder_id:i.folder_id};for(o=0,n=(i.nested_msgs||[]).length;o<n;o++)a=i.nested_msgs[o],e(a)?(s=a.attachments[0],l.push(_.extend({},s,{mail:d,title:a.filename||"",parent:i.parent||d}))):(t(i,a),l.push({id:a.id,content_type:"message/rfc822",filename:a.filename||(a.subject||r("message")).replace(/\s+/g," ")+".eml",title:a.filename||a.subject||"",mail:d,parent:i.parent||d,nested_message:_.extend({},a,{parent:d})}));for(i.parent&&d&&void 0===d.folder_id&&(d.id=i.parent.id,d.folder_id=i.parent.folder_id),o=0,n=(i.attachments||[]).length;o<n;o++)("attachment"===(a=i.attachments[o]).disp||/^image/.test(a.content_type.toLowerCase()))&&(t(i,a),l.push(_.extend({},a,{cid:null,mail:d,title:a.filename||"",parent:i.parent||d})));return l}}()}}),define("io.ox/mail/api",["io.ox/mail/api-legacy","io.ox/core/http","settings!io.ox/core","io.ox/core/api/factory","io.ox/core/folder/api","io.ox/core/api/account","io.ox/mail/util","io.ox/core/api/collection-pool","io.ox/core/api/collection-loader","io.ox/core/tk/visibility-api-util","settings!io.ox/mail","gettext!io.ox/mail","io.ox/core/capabilities","io.ox/mail/sanitizer"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f){function h(e){q.threads.touch(e.toJSON())}function g(){return c.get("allowHtmlMessages",!0)?"html":"text"}function m(e){var t=g();if("text"===t)return"text";if(r.authenticity("block",e))return"noimg";var i="trusted"===r.authenticity("box",e),o=r.isWhiteListed(e);return i||o?t:c.get("allowHtmlImages",!1)?a.is("spam|confirmed_spam|trash",e.folder_id||e.folder)?"noimg":t:"noimg"}function v(e){return _.isArray(e)?e.map(function(e){return/^text\/(plain|html)/i.test(e.content_type)?(e.content_type=String(e.content_type).toLowerCase().split(";")[0],f.sanitize(e)):e}):[{content:"",content_type:"text/plain",disp:"inline",id:"1",sanitized:!0,size:0,truncated:!1}]}function x(e){return e.attachments=v(e.attachments),_.isArray(e.nested_msgs)&&(e.nested_msgs=e.nested_msgs.map(function(e){return e.attachments=v(e.attachments),e})),e}function b(e,t){var i=N.get("detail");1===(t=t||e).length&&(q.threads.remove(t[0]),q.threads.touch(t[0])),q.trigger("beforedelete",t),_(t).each(function(e){var t=_.cid(e),o=i.get(t);o&&(o.preserve=!1,i.remove(o))})}function w(e){return N.resetFolder(a.getFoldersByType(e))}function y(e,t){_(e).chain().pluck("folder_id").uniq().map(N.getBySorting.bind(N,t)).flatten().each(function(e){e.sorted=!1})}function k(e,i){return b(e),w(i?"spam":"inbox"),t.pause(),_(e).map(function(e){return t.PUT({module:"mail",params:{action:"update",id:e.id,folder:e.folder_id,timestamp:_.then()},data:{flags:q.FLAGS.SPAM,value:i},appendColumns:!1})}),n.reload(e[0].folder_id,a.getFoldersByType(i?"spam":"inbox")),t.resume()}function C(e,i,o){return N.resetFolder(o),t.wait(B(i,{folder_id:o},e).then(function(t){q.trigger(e,i,o),n.reload(o,i);var a=_(t.response).find(function(e){return!!e.error});return a?(q.trigger("refresh.all"),$.Deferred().reject(a.error)):"copy"===e?_(t.response).pluck("data"):i}))}function S(e){return e.id=e.original_id,e.folder_id=e.original_folder_id,32!=(32&e.flags)&&!a.is("spam|confirmed_spam|trash",e.folder_id)}function T(e){return!r.isDeleted(e)}function D(e){if(e.thread)return e.thread;var t=q.threads.get(_.cid(e))||{};return t&&t.length>1?t:[e]}function A(e){if(!e.authenticity)return e;e.authenticity_preview=e.authenticity,delete e.authenticity}var M=_("0 1 7 10 6 3 9 2 5 8 4".split(" ")).invert(),E=function(e,t){return M[t.color_label]-M[e.color_label]},N=window.mailpool=s.create("mail"),F=c.get("features/fixtoccbcc"),I=!c.get("features/ignoreDeleted",!1),P=f.isEnabled(),L=c.get("features/sandboxedCSS",!0),z=i.get("pdf/enablePreconversionOnMailFetch",!0);N.map=function(e){var t=_.cid(e),i=this.get(t);return i&&i.get("headers")&&(e.headers||(e.headers={}),e.headers=_.extend(e.headers,i.get("headers"))),_([e].concat(e.attachments)).each(function(e){e&&/^text\/(plain|html)/i.test(e.content_type)&&(e.content_type=String(e.content_type).toLowerCase().split(";")[0])}),i?(F&&["to","cc","bcc"].forEach(function(t){var o=i.get(t);_.isArray(o)&&o.length>0&&delete e[t]}),e):e};var q=o({module:"mail",keyGenerator:function(e){return e?(e.folder_id||e.folder)+"."+e.id+"."+(e.view||q.options.requests.get.view||""):""},requests:{all:{folder:"default0/INBOX",columns:"601,600,611,102",extendColumns:"io.ox/mail/api/all",sort:"610",order:"desc",deleted:I,cache:!1},list:{action:"list",columns:"102,600,601,602,603,604,605,606,607,608,610,611,614,652",extendColumns:"io.ox/mail/api/list"},get:{action:"get",embedded:String(!L),sanitize:String(!P)},getUnmodified:{action:"get",unseen:"true",view:"html",embedded:"true"},search:{action:"search",folder:"default0/INBOX",columns:"601,600,611",extendColumns:"io.ox/mail/api/all",sort:"610",order:"desc",getData:function(e,t){var i={from:603,to:604,cc:605,subject:607,text:-1},o=[];return _(t).each(function(t,n){n in i&&"on"===t&&o.push({col:i[n],pattern:e})}),o}}},cid:function(e){return(e.action||"all")+":"+e.folder+"//"+[e.sort,e.order,e.max||0,!!e.unseen,!!e.deleted].join(".")},filter:function(e){return void 0!==e.folder_id||void 0!==e.folder},pipe:{all:function(e,t){return"102"===t.sort&&(e.sort(E),"desc"===t.order&&e.reverse()),e},get:function(e,t){return _.isObject(e)&&(e.view=t.view),e}},params:{all:function(e){return"thread"===e.sort&&(e.sort=610),e}},simplify:function(e){return e.simplified.unseen=!0,e.simplified}});_.extend(q,e),q.updateViewSettings=function(){q.options.requests.get.view="text",c.get("allowHtmlMessages",!0)&&(q.options.requests.get.view=c.get("allowHtmlImages",!1)?"html":"noimg"),q.trigger("viewChanged")},q.separator=c.get("defaultseparator","/"),q.FLAGS={ANSWERD:1,DELETED:2,DRAFT:4,FLAGGED:8,RECENT:16,SEEN:32,USER:64,SPAM:128,FORWARDED:256},q.COLORS={NONE:0,RED:1,ORANGE:7,YELLOW:10,LIGHTGREEN:6,GREEN:3,LIGHTBLUE:9,BLUE:2,PURPLE:5,PINK:8,GRAY:4},N.get("detail").on("change:flags",function(e){var t=r.isUnseen(e.previous("flags")),i=r.isUnseen(e.get("flags"));t!==i&&n.changeUnseenCounter(e.get("folder_id"),i?1:-1)}),N.get("detail").on("remove",function(e){r.isUnseen(e.get("flags"))&&n.changeUnseenCounter(e.get("folder_id"),-1)});var O=q.get,V=q.getAll,R=q.search;q.get=function(e,t){var i,o=_.isObject(e)?_.cid(e):e,n=N.get("detail").get(o),a=!t||void 0===t.cache||t.cache,r="noimg"===e.view||!e.view;return n&&(i=!!n.get("attachments"),a&&!e.src&&i&&r)?$.when(n.toJSON()):(e.view||(e.view=m(_.extend({},e,n&&n.toJSON()))),e.max_size=c.get("maxSize/view",102400),e.process_plain_text=!1,e.pregenerate_previews=String(z),O.call(q,e,!1).done(function(t){e.src||"raw"===e.view||(delete t.cid,t=x(t),n?(n.set(t),h(n)):N.add("detail",t))}))},q.getAll=function(e,t){return e=e||{},/^default\d+$/.test(e.folder)?$.when([]):("from-to"===e.sort&&(e.sort=a.is("sent|drafts",e.folder)?604:603),V.call(this,e,t))},q.search=function(e,t){return"from-to"===t.sort&&(t.sort=a.is("sent|drafts",t.folder)?604:603),R.call(this,e,t)},q.remove=function(){function e(e,t){"MSG-0039"===t.code&&q.trigger("delete:fail:quota",t,e)}function i(e){return d=d.concat(e),c.promise()}function o(e){var t=[].concat(e);t.forEach(function(e){u[_.cid(e)]=!0}),setTimeout(function(){t.forEach(function(e){delete u[_.cid(e)]}),t=null},15e3)}function r(e,i){return l=!0,t.wait(_.wait(100).then(function(){return t.PUT({module:"mail",params:{action:"delete",harddelete:!!i,returnAffectedFolders:!0,timestamp:_.then()},data:t.simplify(e),appendColumns:!1}).done(function(t){_(t.folders).each(function(e,t){n.pool.getModel(t).set(e)}),q.trigger("delete"),q.trigger("deleted-mails",e),_(e).each(function(e){q.trigger("remove:"+_.ecid(e),e)}),a.is("trash",e[0].folder_id)?q.trigger("deleted-mails-from-trash"):i||w("trash")}).fail(function(){q.trigger("refresh.all")}).always(p)}))}function s(e,t,n){try{return o(e),l&&!n?i(e):r(e,n)}finally{b(e,t)}}var l=!1,d=[],c=$.Deferred(),u={},p=_.debounce(function(){d.length?(r(d).done(c.resolve).fail(c.reject).fail(e.bind(null,d)),d=[],c=$.Deferred()):l=!1},5e3);return s.getRecentlyDeleted=function(){return u},s.isRecentlyDeleted=function(e){return!!u[e]},s}(),q.archive=function(e){if(_.isArray(e)&&0!==e.length)return b(e),t.wait(t.PUT({module:"mail",params:{action:"archive",timestamp:_.then()},data:t.simplify(e)}).done(function(t){_(_(t).pluck("created")).contains(!0)?a.reload().then(function(){return c.reload()}).done(function(){n.refresh(),q.trigger("refresh.all")}):n.reload(_(t).pluck("id")),q.trigger("archive",e)}))},q.archiveFolder=function(e,i){return i=_.extend({action:"archive_folder",folder:e,days:90},i),t.PUT({module:"mail",params:i,appendColumns:!1}).done(function(){n.refresh(),q.trigger("refresh.all"),q.trigger("archive-folder",e)})},q.getAllThreads=function(e,t){return e=e||{},e=$.extend(e,{action:"threadedAll",columns:e.columns||"601,600,611,102",sort:e.sort||"610",sortKey:"threaded-"+(e.sort||"610"),konfetti:!0,order:e.order||"desc",includeSent:!a.is("sent|drafts",e.folder),cache:!1,deleted:I,max:e.max||500}),V.call(this,e,t,null,!1)};var B=function(e,i,o){var n=!1,a=i.folder_id||i.folder;return e=_.isArray(e)?e:[e],t.pause(),_(e).map(function(e){var r=e.folder||e.folder_id;return a&&a!==r&&(n=!0),t.PUT({module:"mail",params:{action:o||"update",id:e.id,folder:r,timestamp:_.then()},data:i,appendColumns:!1})}),t.resume().then(function(t){return _(e).each(function(e){q.trigger("update:"+_.ecid(e),e)}),n&&q.trigger("move"),"copy"===o||n?{list:e,response:t}:(q.trigger("update:after"),e)})};q.update=function(){console.error("Do not call this directly because mail is so special")},q.on("not-found",function(){q.trigger("refresh.list")}),q.expunge=function(e){var i=_(N.getByFolder(e)).chain().map(function(e){return e.filter(function(e){return r.isDeleted(e.attributes)})}).flatten().pluck("cid").compact().value();return q.trigger("beforeexpunge",i),_(N.getByFolder(e)).each(function(e){e.set(e.filter(function(e){return!r.isDeleted(e.toJSON())}))}),t.PUT({module:"mail",appendColumns:!1,params:{action:"expunge"},data:[e]}).done(function(){n.reload(e)})},n.on({"before:clear":function(e){_(N.getByFolder(e)).each(function(e){e.reset([])})},"clear remove:mail":function(){var e=a.getFoldersByType("trash");_(e).each(function(e){n.list(e,{cache:!1}),_(N.getByFolder(e)).invoke("expire")})},"changesAfterReloading:mail":function(e){(_(e.changed).has("unread")||_(e.changed).has("total"))&&(_(N.getByFolder(e.id)).invoke("expire"),q.trigger("changesAfterReloading"))}}),q.changeColor=function(e,i){return e=[].concat(e),i=String(i),_(e).each(function(e){e.color_label=i,N.propagate("change",{id:e.id,folder_id:e.folder_id,color_label:parseInt(i,10)||0}),q.threads.touch(e),q.trigger("update:"+_.ecid(e),e)}),t.wait(B(e,{color_label:i})).done(function(){y(e,102)})},q.flag=function(e,t){return e=[].concat(e),_.isUndefined(t)&&(t=_(e).reduce(function(e,t){return!0===e||!r.isFlagged(t)},!1)),_(e).each(function(i){i.flags=t?8|i.flags:-9&i.flags,N.propagate("change",{id:i.id,folder_id:i.folder_id,flags:i.flags}),q.threads.touch(i),q.trigger("update:"+_.ecid(i),i),q.trigger("refresh.flag",e)}),B(e,{flags:q.FLAGS.FLAGGED,value:t}).done(function(){y(e,651),n.reload(e)})},q.markUnread=function(e){return e=[].concat(e),_(e).each(function(t){t.flags=-33&t.flags,N.propagate("change",{id:t.id,folder_id:t.folder_id,flags:t.flags}),q.threads.touch(t),q.trigger("update:"+_.ecid(t),t),q.trigger("refresh.unseen",e)}),B(e,{flags:q.FLAGS.SEEN,value:!1}).done(function(){y(e,651),n.reload(e),q.trigger("after:refresh.unseen",e)})},q.markRead=function(e){e=[].concat(e);var t=!a.is("spam|confirmed_spam|trash",e[0].folder_id);return _(e).each(function(t){t.flags=32|t.flags,N.propagate("change",{id:t.id,folder_id:t.folder_id,flags:t.flags,unseen:!1}),q.threads.touch(t),q.trigger("update:"+_.ecid(t),t),q.trigger("refresh.seen",e),q.trigger("update:set-seen",e)}),B(e,{flags:q.FLAGS.SEEN,value:!0,collect_addresses:t}).done(function(){y(e,651),n.reload(e),q.trigger("after:refresh.seen",e)})},q.allSeen=function(e){return N.get("detail").each(function(t){var i=t.toJSON();i.folder_id===e&&r.isUnseen(i)&&(N.propagate("change",{id:i.id,folder_id:i.folder_id,flags:32|i.flags}),q.threads.touch(i))}),q.trigger("update:set-seen",e),t.PUT({module:"mail",params:{action:"all_seen",folder:e},appendColumns:!1}).done(function(){q.trigger("after:all-seen",e),n.reload(e)})},q.markSpam=function(e){return k(e,!0)},q.noSpam=function(e){return k(e,!1)},q.move=function(e,t,i){try{return C("update",e,t)}finally{b(e,i)}},q.moveAll=function(e,i){return _(N.getByFolder(e)).each(function(e){e.reset([]),e.setComplete(!0)}),t.wait(t.PUT({module:"mail",appendColumns:!1,params:{action:"move_all"},data:{source:e,target:i}})).done(function(){n.reload([e,i])})},q.copy=function(e,t){return C("copy",e,t)},q.autosave=function(e){q.trigger("before:autosave",{data:e});try{var i={action:"autosave",lineWrapAfter:0};return e.security&&e.security.decrypted&&(i.decrypt=!0,e.security.authentication&&(i.authToken=e.security.authentication)),t.wait(t.PUT({module:"mail",params:i,data:e,appendColumns:!1}).then(function(e){var t=a.getFoldersByType("drafts");return N.resetFolder(t),n.reload(t),q.trigger("autosave"),e}))}finally{e.msgref&&b(r.parseMsgref(q.separator,e.msgref))}},q.keepalive=function(e){return t.GET({module:"file",params:{action:"keepalive",id:e}})},q.getUnmodified=function(e){if("folder_id"in e||"folder"in e)return this.get({action:"get",id:e.id,folder:e.folder||e.folder_id,view:"html",decrypt:e.security&&e.security.decrypted},!1).then(x);if("parent"in e){var t=e.id,i=e.parent;return this.get({action:"get",id:e.parent.id,folder:e.parent.folder||e.parent.folder_id,view:"html",decrypt:e.security&&e.security.decrypted},!1).then(function(e){return _.chain(e.nested_msgs).filter(function(e){return e.id===t&&(e.parent=i,!0)}).first().value()}).then(x)}return console.error("api.getUnmodified(). Invalid case.",e),$.Deferred().resolve(e)},q.getSource=function(e){return this.get({action:"get",id:e.id,src:!0,folder:e.folder||e.folder_id,view:"html",embedded:!1},!1)},q.fetchTextPreview=function(e){return t.fixList(e,t.PUT({module:"mail",params:{action:"list",columns:"600,601,663",timezone:"utc",deleted:I},data:t.simplify(e)})).then(function(e){var t={};return _(e).each(function(e){t[_.cid(e)]=e.text_preview||""}),t})},q.saveAttachments=function(e,o){return o=o||i.get("folder/infostore"),e=_.isArray(e)?e:[e],t.pause(),_(e).each(function(e){var i={action:"attachment",id:e.mail.id,folder:e.mail.folder_id,dest_folder:o,attachment:e.id,decrypt:e.security&&e.security.decrypted};e.security&&e.security.authentication&&(i.cryptoAuth=e.security.authentication),e.reEncrypt&&(i.encrypt=!0),t.PUT({module:"mail",params:i,data:{folder_id:o,description:u("Saved mail attachment")},appendColumns:!1})}),t.resume().done(function(){require(["io.ox/files/api"],function(e){e.pool.resetFolder(o),e.trigger("add:file")})})},q.getUrl=function(e,t,i){var o,n=_.extend({scaleType:"contain",session:!0},i),a=ox.apiRoot+"/mail";if("zip"===t)return o=_(e).first(),a+"?"+$.param({action:"zip_attachments",folder:(o.parent||o.mail).folder_id,id:(o.parent||o.mail).id,attachment:_(e).pluck("id").join(","),decrypt:o.security&&o.security.decrypted,session:ox.session});if("eml:reference"===t)return this.getUrl(_([].concat(e)).first().parent,"eml");if("eml"===t)return e=[].concat(e),o=_(e).first(),e.length>1?a+"?"+$.param({action:"zip_messages",folder:o.folder_id,id:_(e).pluck("id").join(","),session:ox.session}):a+=(o.subject?"/"+encodeURIComponent(o.subject.replace(/[\\:/]/g,"_")+".eml"):"")+"?"+$.param($.extend(q.reduce(o),{action:"get",src:1,save:1,session:ox.session}));if(e.space)return a=ox.apiRoot+"/mail/compose/"+e.space+"/attachments/"+e.id,n.session&&(a+="?session="+ox.session),a;var r=e.filename?e.filename.replace(/[\\:/]/g,"_").replace(/\(/g,"%28").replace(/\)/,"%29"):void 0,s=n.width&&n.height?"&scaleType="+n.scaleType+"&width="+n.width+"&height="+n.height:"";switch(a+=(e.filename?"/"+encodeURIComponent(r):"")+"?"+$.param({action:"attachment",folder:(e.parent||e.mail).folder_id,id:(e.parent||e.mail).id,attachment:e.id,user:ox.user_id,context:ox.context_id,sequence:1,session:ox.session}),e.security&&e.security.decrypted&&(a+="&decrypt=true",e.security.authentication&&(a+="&cryptoAuth="+encodeURIComponent(e.security.authentication))),t){case"view":case"open":a+="&delivery=view"+s;break;case"download":a+="&delivery=download"}return a},q.getNestedMail=function(e){return t.GET({module:"mail",params:{action:"attachment",folder:(e.parent||e.mail).folder_id,id:(e.parent||e.mail).id,attachment:e.id,as_json:!0}})};var U=0;return q.checkInbox=function(){if(!ox.openedInBrowserTab)return t.GET({module:"mail",params:{action:"all",folder:"default0/INBOX",columns:"610,600,601,611",unseen:"true",deleted:"false",sort:"610",order:"desc",limit:100,timezone:"utc"}}).then(function(e){var t=_(e).filter(function(e){return e.received_date>U&&2!=(2&e.flags)});return q.trigger("new-mail",t,e),t.length>0?(U=t[0].received_date,q.newMailTitle(!0)):U=(new moment).valueOf(),{unseen:e,recent:t||[]}})},q.refresh=function(){if(ox.online&&p.has("webmail")&&!ox.openedInBrowserTab)return q.checkInbox().always(function(){q.trigger("refresh.all")})},q.getDefaultFolder=function(){return n.getDefaultFolder("mail")},q.getAccountIDFromFolder=function(e){return/^default(\d*)\b/.exec(e)[1]},q.beautifyMailText=function(e,t){return t=t||500,e=String(e).replace(/(\r\n|\n|\r)/gm,"").substr(0,t).replace(/-{3,}/g,"---").replace(/<br\s?\/?>(&gt;)+/gi," ").replace(/<br\s?\/?>/gi," ").replace(/<[^>]+(>|$)/g,"").replace(/(http(s?):\/\/\S+)/i,'<a href="$1" target="_blank" rel="noopener">http$2://...</a>').replace(/&#160;/g," ").replace(/\s{2,}/g," "),$.trim(e)},q.importEML=function(e){var i=e.folder||q.getDefaultFolder(),o=new FormData;return o.append("file",e.file),t.UPLOAD({module:"mail",params:{action:"import",folder:i,force:!0},data:o,fixPost:!0}).done(function(){N.resetFolder(i),n.reload(i),q.trigger("refresh.all")})},q.ack=function(e){return a.getPrimaryAddressFromFolder(e.folder).then(function(i){var o=i[0],n=i[1],a=o?'"'+o+'" <'+n+">":n;return t.PUT({module:"mail",params:{action:"receipt_ack"},data:_.extend({from:a},e)})})},c.on("change:allowHtmlMessages change:allowHtmlImages change:isColorQuoted",function(){N.get("detail").each(function(e){e.unset("attachments",{silent:!0}),e.unset("security",{silent:!0})})}),c.on("change:allowHtmlMessages",function(e){q.options.requests.get.view=e?"noimg":"text"}),a.on("refresh.all create:account",function(){n.list("1",{cache:!1}).done(function(){n.pool.unfetch()})}),n.on("create",function(e){"mail"===e.module&&q.refresh()}),q.newMailTitle=function(){function e(){document.title=(n=!n)?u("New mail"):document.customTitle}function t(){o||(o=setInterval(e,1500))}function i(){document.customTitle&&(document.title=document.customTitle),o&&(clearInterval(o),o=null)}var o=null,n=!1;return $(d).on("visibility-changed",function(e,t){!1===t.currentHiddenState&&i()}),function(e){!_.device("smartphone")&&d.isHidden&&(!0===e?t():i())}}(),q.pool=N,q.resolve=function(){function e(e){return e=String(e).replace(/^thread\./,""),N.get("detail").get(e)}return function(t,i){return i?q.threads.resolve(t):_(t).chain().map(e).compact().invoke("toJSON").value()}}(),q.threads={hash:{},reverse:{},collection:{},contains:function(e){return!!this.hash[e]},getModels:function(e){if(!_.isString(e))return[];var t=this.hash[e]||[e];return _.isEmpty(this.collection)&&(this.collection=N.get("detail")),_(t).chain().map(this.collection.get,this.collection).compact().value()},get:function(e){return _(this.getModels(e)).chain().invoke("toJSON").map(function(e,t){return e.index=t,e}).value()},head:function(e){return e.head||e},touch:function(e){e=_.isString(e)?e:_.cid(e);var t=this.reverse[e];t&&t!==e&&N.propagate("change",_.extend({timestamp:_.now()},_.cid(t)))},resolve:function(e){return _(e).chain().map(function(e){e=String(e).replace(/^thread\.(.+)$/,"$1");var t=q.threads.get(e);return t.length>0&&t}).flatten().compact().value()},clear:function(){this.hash={},this.reverse={}},add:function(e){var t=_.cid(e);this.hash[t]=e.thread||[t],_(this.hash[t]).each(function(e){this.reverse[e]=t},this)},remove:function(e){e=_.isString(e)?e:_.cid(e);var t=this.reverse[e];t&&this.hash[t]&&(this.hash[t]=_(this.hash[t]).without(e))},size:function(e){e=_.isString(e)?e:_.cid(e);var t=this.reverse[e];return t?(this.hash[t]||[e]).length:1},subject:function(e){if(!this.collection.get)return"";e=_.isString(e)?e:_.cid(e);var t,i,o;return t=this.reverse[e],i=_(this.hash[t]).first(),(o=this.collection.get(i))&&o.get("subject")?o.get("subject"):(o=this.collection.get(t))?o.get("subject"):""},append:function(e,t){var i=this.reverse[e];i&&((this.hash[i]=this.hash[i]||[]).unshift(t),this.touch(i))}},q.pool.getDependentModels=function(e){return q.threads.getModels(e)},q.allMessagesFolder=c.get("allMessagesFolder","default0/virtual/all"),q.getAllUnseenMessages=function(){return t.GET({module:"mail",params:{action:"all",folder:q.allMessagesFolder,columns:"600,654,655",sort:"610",order:"desc",unseen:!0,deleted:!1,timezone:"utc"}})},q.collectionLoader=new l({module:"mail",getQueryParams:function(e){return"virtual/all-unseen"===e.folder?{action:"all",folder:q.allMessagesFolder,columns:t.defaultColumns.mail.unseen,sort:"610",order:"desc",unseen:!0,deleted:!1,timezone:"utc"}:!0===e.thread?{action:"threadedAll",folder:e.folder,categoryid:e.category_id||e.categoryid,columns:t.defaultColumns.mail.all,sort:e.sort||"610",order:e.order||"desc",includeSent:!a.is("sent|drafts",e.folder),max:(e.offset||0)+300,deleted:I,timezone:"utc"}:{action:"all",folder:e.folder,categoryid:e.category_id||e.categoryid,columns:t.defaultColumns.mail.all,sort:e.sort||"610",order:e.order||"desc",deleted:I,timezone:"utc"}},filter:function(e){return!q.remove.isRecentlyDeleted(_.cid(e))},fail:function(e){return q.trigger("error error:"+e.code,e),e},httpGet:function(e,i){var o=i.folder===q.allMessagesFolder&&!0===i.unseen;return o&&(i.limit="0,250"),t.GET({module:e,params:i}).then(function(e){return o?_(e).filter(S):e})},PRIMARY_PAGE_SIZE:c.get("listview/primaryPageSize",50),SECONDARY_PAGE_SIZE:c.get("listview/secondaryPageSize",200)}),q.processThreadMessage=function(e){var t,i=D(e);0===(i=_(t=i).filter(T)).length&&(i=t.slice(0,1)),_(i.concat(e)).each(A);var o=_(i).last(),n=i.length;e.head=_({threadSize:n}).chain().extend(e).omit("index").value(),_.extend(e,o),e.thread=_(i).map(_.cid),e.threadSize=n,o.thread=_(i).map(_.cid),q.threads.add(e),q.pool.add("detail",i)},q.collectionLoader.noSelect=function(e){return!!/^default\d+$/.test(e.folder)||e.folder!==q.allMessagesFolder&&!n.pool.getModel(e.folder).can("read")},q.collectionLoader.each=function(e,t,i,o){e["X-Open-Xchange-Share-URL"]&&!e.headers&&(e.headers={"X-Open-Xchange-Share-URL":e["X-Open-Xchange-Share-URL"]},delete e["X-Open-Xchange-Share-URL"]),"threadedAll"===o.action?q.processThreadMessage(e):q.pool.add("detail",e)},q.mailServerDownMessage=u("Unable to connect to mail server. Possible reasons: The mail server is (temporarily) down or there are network connection problems. Please try again in a few minutes."),q}),define("io.ox/mail/api-legacy",["io.ox/core/http","io.ox/core/folder/api","io.ox/contacts/api","io.ox/core/api/account","settings!io.ox/mail"],function(e,t,i,o,n){function a(t,i){var o=new FormData;return o.append("json_0",JSON.stringify(t)),_(i).each(function(e,t){e.name?o.append("file_"+t,e,e.name):o.append("file_"+t,e)}),e.UPLOAD({module:"mail",params:{action:"new",lineWrapAfter:0,force_json_response:!0},data:o,dataType:"json",fixPost:!0})}var r={};r.SENDTYPE={NORMAL:0,REPLY:1,FORWARD:2,EDIT_DRAFT:3,DRAFT:4},r.csid=function(){return _.uniqueId()+"."+_.now()};var s=function(t,i,o){var a=this,s="edit"===t;"alternative"===o&&(o="text/plain"===i.content_type?"text":"html"),"html"!==(o="text/html"===(o="text/plain"===(o=$.trim(o||"text").toLowerCase())?"text":o)?"html":o)||"text/plain"!==i.content_type||s||(o="text"),"text"===o&&"text/plain"===i.content_type&&s&&(o="raw");var l=i.attachOriginalMessage||"text"===o&&_.device("touch")&&!0===n.get("attachOriginalMessage",!1),d=r.csid();return e.PUT({module:"mail",params:$.extend({},{action:s?"get":t||"",attachOriginalMessage:l,view:o,setFrom:/reply|replyall|forward/.test(t),csid:d,embedded:i.embedded,max_size:i.max_size,decrypt:i.security&&i.security.decrypted,process_plain_text:!1}),data:_([].concat(i)).map(function(e){return a.reduce(e)}),appendColumns:!1}).then(function(e){var t="",i="";return e.csid=d,e.attachments&&e.attachments.length?""===e.attachments[0].content||("text/html"===e.attachments[0].content_type?((i=document.createElement("DIV")).innerHTML=e.attachments[0].content,_(i.getElementsByTagName("BLOCKQUOTE")).each(function(e){e.removeAttribute("style")}),t=i.innerHTML,i=null):t=$.trim(e.attachments[0].content)):e.attachments=e.attachments||[{}],e.attachments[0].content=t,e})};return r.replyall=function(e,t){return s.call(this,"replyall",e,t)},r.reply=function(e,t){return s.call(this,"reply",e,t)},r.forward=function(e,t){return s.call(this,"forward",e,t)},r.edit=function(e,t){return s.call(this,"edit",e,t)},r.send=function(e,n,s){var l,d=this,c=function(e){var t=$.trim(e[0]||"").replace(/^["']+|["']+$/g,""),i=String(e[1]||""),o=e[2]||"";return"/TYPE=PLMN"===o&&!/\/TYPE=PLMN$/.test(i)&&(t=null,i+=o),""!==t&&t!==i||(t=null),[t,i]};(e=_.clone(e)).from=_(e.from).map(c),e.to=_(e.to).map(c),e.cc=_(e.cc).map(c),e.bcc=_(e.bcc).map(c),e.share_attachments&&e.share_attachments.expiry_date&&(e.share_attachments=_.clone(e.share_attachments),e.share_attachments.expiry_date=_.now()+parseInt(e.share_attachments.expiry_date,10)),e.contacts_ids&&(e.datasources=_.chain(e.contacts_ids).map(function(e){return{args:[{"com.openexchange.groupware.contact.pairs":[{folder:e.folder_id,id:e.id}]}],identifier:"com.openexchange.contact"}}).value()),d.trigger("beforesend",{data:e,files:n,form:s}),ox.trigger("mail:send:start",e,n),l=a(e,n);var u=r.SEND_REFRESH_DELAY,p=e.flags===r.FLAGS.DRAFT,f=e.csid;return r.queue.add(f,l.abort),l.done(function(){i.trigger("maybeNewContact"),d.trigger("send",{data:e,files:n,form:s}),ox.trigger("mail:send:stop",e,n),e.share_attachments&&ox.trigger("please:refresh refresh^")}).fail(function(){ox.trigger("mail:send:fail")}).progress(function(e){p||r.queue.update(f,e.loaded,e.total)}).always(function(){r.queue.remove(f)}).then(function(e){if(setTimeout(function(){var e=_(["inbox","sent","drafts"]).chain().map(function(e){var t=o.getFoldersByType(e);return d.pool.resetFolder(t),t}).flatten().value();t.multiple(e,{cache:!1}),d.trigger("refresh.all")},u),_.isObject(e))return e;var i=e.indexOf("{"),n=e.lastIndexOf("}");return i>-1&&n>-1?JSON.parse(e.substr(i,n-i+1)):{}}).then(function(i){if(i.error)return $.Deferred().reject(i).promise();if(i.data){var n=_(i.data.toString().split(d.separator)),a=n.last(),r=n.without(a).join(d.separator);$.when(o.getUnifiedMailboxName(),o.getPrimaryAddress()).done(function(i,n){var a=!1;_.chain(_.union(e.to,e.cc,e.bcc)).each(function(e){e[1]!==n[1]||(a=!0)}),setTimeout(function(){null!==i?t.refresh():a?t.reload(r,o.getInbox()):t.reload(r)},u)})}return i})},r.SEND_REFRESH_DELAY=5e3,r.queue=function(){function e(e,t){return t?Math.max(0,Math.min(100,Math.round(e/t*100)))/100:0}return{collection:(new Backbone.Collection).on("add remove change:pct",function(){var t,i=0,o=0;this.each(function(e){i+=e.get("loaded"),o+=e.get("total"),t=e.get("abort")}),this.trigger("progress",{count:this.length,loaded:i,pct:e(i,o),total:o,abort:t})}),add:function(e,t){this.collection.add(new Backbone.Model({id:e,loaded:0,pct:0,total:0,abort:t}))},remove:function(e){var t=this.collection.get(e);this.collection.remove(t)},update:function(t,i,o){var n=this.collection.get(t);n&&n.set({loaded:i,pct:e(i,o),total:o})}}}(),r}),define("io.ox/mail/listview",["io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/util","io.ox/mail/api","io.ox/core/api/account","io.ox/core/tk/list","io.ox/core/tk/list-contextmenu","io.ox/core/folder/api","gettext!io.ox/mail","io.ox/mail/view-options","less!io.ox/mail/style"],function(e,t,i,o,n,a,r,s,l){function d(e){"threadSize"in e||(e.threadSize=Math.max(1,_(e.thread).reduce(function(e,t){return e+(i.isDeleted(t)?0:1)},0)))}function c(e){if(i.isDeleted(e)){var t=_(e.thread).findWhere(function(e){return!i.isDeleted(e)});t&&(e=_.extend(e,t))}}return t.point("io.ox/mail/listview/item").extend({id:"default",index:100,draw:function(e){if(d(e.data),c(e.data),e.app){var i=e.app.props.get("layout"),o="horizontal"===i||"list"===i;this.closest(".list-item").toggleClass("small",o),t.point("io.ox/mail/listview/item/"+(o?"small":"default")).invoke("draw",this,e)}else t.point("io.ox/mail/listview/item/default").invoke("draw",this,e)}},{id:"a11y",index:200,draw:e.a11yLabel}),t.point("io.ox/mail/listview/item/small").extend({id:"unread",index:110,draw:e.unreadClass},{id:"flagged",index:115,draw:e.flaggedClass},{id:"deleted",index:120,draw:e.deleted},{id:"col1",index:100,draw:function(t){var i=$('<div class="list-item-column column-1">');e.envelope.call(i,t),this.append(i)}},{id:"col2",index:200,draw:function(t){var i=$('<div class="list-item-column column-3">');e.paperClip.call(i,t),this.append(i)}},{id:"col3",index:300,draw:function(t){var i=$('<div class="list-item-column column-3">');e.priority.call(i,t),this.append(i)}},{id:"col4",index:400,draw:function(e){var i=$('<div class="list-item-column column-4">');t.point("io.ox/mail/listview/item/small/col4").invoke("draw",i,e),this.append(i)}},{id:"col5",index:500,draw:function(t){var i=$('<div class="list-item-column column-5">');e.answered.call(i,t),0===i.children().length&&e.forwarded.call(i,t),this.append(i)}},{id:"col6",index:600,draw:function(e){var i=$('<div class="list-item-column column-6">');t.point("io.ox/mail/listview/item/small/col6").invoke("draw",i,e),this.append(i)}},{id:"col7",index:700,draw:function(e){var i=$('<div class="list-item-column column-7">');t.point("io.ox/mail/listview/item/small/col7").invoke("draw",i,e),this.append(i)}}),t.point("io.ox/mail/listview/item/small/col4").extend({id:"from",index:100,draw:e.from}),t.point("io.ox/mail/listview/item/small/col6").extend({id:"account",index:100,draw:e.account},{id:"original-folder",index:150,draw:e.folder},{id:"flag",index:200,draw:e.flag},{id:"optionalSize",index:250,draw:e.size},{id:"thread-size",index:300,draw:e.threadSize},{id:"shared-attachement",index:450,draw:e.sharedAttachement},{id:"colorflag",index:200,draw:e.colorflag},{id:"pgp-encrypted",index:600,draw:e.pgp.encrypted},{id:"pgp-signed",index:600,draw:e.pgp.signed},{id:"subject",index:1e3,draw:e.subject},{id:"text-preview",index:1100,draw:function(e){this.append($('<span class="text-preview inline gray">').text(e.data.text_preview||""))}}),t.point("io.ox/mail/listview/item/small/col7").extend({id:"date",index:100,draw:e.date}),t.point("io.ox/mail/listview/item/default").extend({id:"picture",before:"row1",draw:function(t){t.app&&t.app.props.get("contactPictures")&&e.picture.call(this,t)}},{id:"row1",index:100,draw:function(e){var i=$('<div class="list-item-row">');t.point("io.ox/mail/listview/item/default/row1").invoke("draw",i,e),this.append(i)}},{id:"unread",index:110,draw:e.unreadClass},{id:"flagged",index:115,draw:e.flaggedClass},{id:"deleted",index:120,draw:e.deleted},{id:"row2",index:200,draw:function(e){var i=$('<div class="list-item-row">');t.point("io.ox/mail/listview/item/default/row2").invoke("draw",i,e),this.append(i)}},{id:"row3",index:300,draw:function(e){if(e.app&&e.app.useTextPreview){var i=$('<div class="list-item-row">');t.point("io.ox/mail/listview/item/default/row3").invoke("draw",i,e),this.append(i)}}}),t.point("io.ox/mail/listview/item/default/row1").extend({id:"date",index:100,draw:e.date},{id:"from",index:300,draw:e.from}),t.point("io.ox/mail/listview/item/default/row2").extend({id:"account",index:100,draw:e.account},{id:"original-folder",index:150,draw:e.folder},{id:"colorflag",index:200,draw:e.colorflag},{id:"flag",index:210,draw:e.flag},{id:"optionalSize",index:250,draw:e.size},{id:"thread-size",index:300,draw:e.threadSize},{id:"paper-clip",index:400,draw:e.paperClip},{id:"shared-attachement",index:350,draw:e.sharedAttachement},{id:"pgp-encrypted",index:450,draw:e.pgp.encrypted},{id:"pgp-signed",index:450,draw:e.pgp.signed},{id:"priority",index:500,draw:e.priority},{id:"subject",index:1e3,draw:function(t){e.subject.call(this,t);var i=this.find(".flags");e.unread.call(i,t),e.answered.call(i,t),e.forwarded.call(i,t)}}),t.point("io.ox/mail/listview/item/default/row3").extend({id:"text-preview",index:100,draw:function(e){this.append($('<div class="text-preview multiline gray">').text(e.data.text_preview||""))}}),t.point("io.ox/mail/listview/notification/empty").extend({id:"default",index:100,draw:e.empty}),t.point("io.ox/mail/listview/notification/error").extend({id:"default",index:100,draw:function(e){this.append($('<i class="fa fa-exclamation-triangle" aria-hidden="true">'),$.txt(l("Error: Failed to load messages")),$('<button type="button" class="btn btn-link">').text(l("Retry")).on("click",{baton:e},function(e){e.data.baton.listView.load()}))}}),a.extend(r).extend({ref:"io.ox/mail/listview",initialize:function(e){if(a.prototype.initialize.call(this,e),this.$el.addClass("mail-item"),this.on("collection:load",this.lookForUnseenMessage),this.$el.on("click mousedown",".selectable .seen-unseen-indicator",this.markRead.bind(this)),e&&e.app){var t=e.app.props;_.extend(this.options,t.pick("thread","sort")),this.listenTo(t,"change:sort",function(e,t){this.options.sort=t})}this.$el.on("scrollend",this.fetchTextPreview.bind(this)),this.on("collection:load collection:reload",this.fetchTextPreview),this.selection&&(this.selection.resolve=function(){return o.resolve(this.get(),this.view.app.isThreaded())})},fetchTextPreview:function(){if(this.app&&this.app.useTextPreview()){var e=this.el.scrollTop,t=e+this.el.offsetHeight,i=this.getItems().outerHeight(),n=Math.floor(0,e/i),a=Math.ceil(t/i),r=this.collection.slice(n,a),s=[];r=_(r).filter(function(e){var t=_(o.threads.get(e.cid)).first(),i=t&&!t.text_preview;return i&&!e.hasNoPreview&&s.push(_(t).pick("id","folder_id")),i}),s.length&&o.fetchTextPreview(s).done(function(e){_(r).each(function(t){var i=_(o.threads.get(t.cid)).first(),n=_.cid(i);t.set("text_preview",e[n]),""===e[n]&&(t.hasNoPreview=!0)})})}},lookForUnseenMessage:function(){if(this.collection.length){var e=this.collection.at(0).get("folder_id"),t=this.collection.reduce(function(e,t){return e+i.isUnseen(t.get("flags"))?1:0},0);s.setUnseenMinimum(e,t)}},markRead:function(e){var t=$(e.currentTarget).closest(".selectable").data("cid"),n=o.threads.get(t);_(n).reduce(function(e,t){return e||i.isUnseen(t)},!1)?o.markRead(n):o.markUnread(n),e.preventDefault(),e.stopPropagation()},reprocessThread:function(e){var t=o.threads.get(e.cid);if(t.length&&e.get("thread")&&t.length!==e.get("thread").length){_.each(t,function(e){delete e.head});var i=_.extend(e.toJSON(),t[0],{thread:t,threadSize:t.length});o.processThreadMessage(i),e.set(i,{silent:!0})}},map:function(e){if(!this.app||!this.app.isThreaded())return e.toJSON();this.reprocessThread(e);var t=o.threads.head(e.toJSON()),n=o.threads.get(e.cid),a=_(n).reduce(function(e,t){return e||i.isUnseen(t)},!1);t.flags=a?-33&t.flags:32|t.flags;var r=_(n).reduce(function(e,t){return e||i.isFlagged(t)},!1);t.flags=r?8|t.flags:-9&t.flags;var s=_(n).reduce(function(e,t){return e||parseInt(t.color_label||0,10)},0);return t.color_label=s,t.thread=n.map(function(e,i){return _(e).pick(_(t.thread[i]).keys())}),t.subject=o.threads.subject(t)||t.subject||"",t},getCompositeKey:function(e){return this.options.threaded?"thread."+e.cid:e.cid},getContextMenuData:function(e){return this.app.getContextualData(e)}})}),define("io.ox/core/tk/list-control",["io.ox/core/tk/list","io.ox/core/extensions"],function(e,t){function i(e,t,i){void 0===t?e.settings.remove("listview/"+i+"/"+_.display()):e.settings.set("listview/"+i+"/"+_.display(),t),e.settings.save()}function o(e,t){return"function"==typeof e&&(e=e()),e<0&&(e+=t),e}function n(){return _.chain(arguments).toArray().compact().min().value()}var a=Backbone.View.extend({className:"abs list-view-control",events:{"mousedown .resizebar:not(.vertical)":"onResize","mousedown .resizebar.vertical":"onVerticalResize"},applySizeConstraints:function(){if("list"!==this.listView.app.props.get("layout")&&this.$el.is(":visible")){var e=this.$el.parent(),t=e.siblings(".rightside"),r=e.parent(),s=this.$(".resizebar.vertical").is(":visible");if(0!==t.length){var l=s?n(e.height()+t.height(),r.height()):n(e.width()+t.width(),r.width()),d=o(s?a.minHeight:a.minWidth,l),c=o(s?a.maxHeight:a.maxWidth,l),u=s?e.height():e.width(),p=Math.max(d,Math.min(u,c));s&&e.height()===p||!s&&e.width()===p||(e.css(s?"height":"width",p),t.css(s?"top":"left",p),i(this.listView.app,p,s?"height":"width"))}}},onResize:function(e){e.preventDefault();var t,n=this.$el.parent(),r=n.siblings(".rightside"),s=e.pageX-n.width(),l=n.width()+r.width(),d=o(a.minWidth,l),c=o(a.maxWidth,l),u=this.listView.app;0!==r.length&&$(document).on({"mousemove.resize":function(e){t=Math.max(d,Math.min(e.pageX-s,c)),n.css("width",t),r.css("left",t)},"mouseup.resize":function(){$(this).off("mousemove.resize mouseup.resize").trigger("resize"),i(u,t,"width")}})},onVerticalResize:function(e){e.preventDefault();var t,n=this.$el.parent(),r=n.siblings(".rightside"),s=e.pageY-n.height(),l=n.height()+r.height(),d=o(a.minHeight,l),c=o(a.maxHeight,l),u=this.listView.app;0!==r.length&&$(document).on({"mousemove.resize":function(e){t=Math.max(d,Math.min(e.pageY-s,c)),n.css("height",t),r.css("top",t)},"mouseup.resize":function(){$(this).off("mousemove.resize mouseup.resize").trigger("resize"),i(u,t,"height")}})},resizable:function(){if(!_.device("touch")){this.$el.append('<div class="resizebar">'),this.$el.append('<div class="resizebar vertical">');var e=this.listView.app.getWindow();$(window).on("resize.list-control-"+e.id,_.debounce(this.applySizeConstraints.bind(this),100)),e.one("beforequit",function(){$(window).off("resize.list-control-"+e.id)})}},initialize:function(e){this.listView=e.listView,this.id=e.id||"default",this.options=e},render:function(){var e=$('<ul class="toolbar generic-toolbar top" role="toolbar">'),i=t.point(this.id+"/list-view/toolbar/top"),o=$('<ul class="toolbar generic-toolbar visual-focus bottom" role="toolbar">'),n=t.point(this.id+"/list-view/toolbar/bottom"),a=new t.Baton({view:this,app:this.options.app});return i.list().length&&(this.$el.addClass("toolbar-top-visible"),i.invoke("draw",e,a)),n.list().length&&_.device("!smartphone")&&(this.$el.addClass("toolbar-bottom-visible"),n.invoke("draw",o,a)),this.$el.attr({role:"navigation"}).append(e,this.listView.render().$el.addClass("abs"),o),this}});return a.minWidth=270,a.maxWidth=-250,a.minHeight=150,a.maxHeight=-100,a}),define("io.ox/mail/threadview",["io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/api/backbone","io.ox/mail/detail/view","io.ox/mail/detail/mobileView","io.ox/core/tk/list-dnd","io.ox/core/http","gettext!io.ox/mail","less!io.ox/mail/style","io.ox/mail/listview"],function(e,t,i,o,n,a,r,s,l,d){t.point("io.ox/mail/thread-view").extend({id:"navigation",index:100,draw:function(){this.$el.append($('<nav class="back-navigation generic-toolbar">').append($('<div class="button">').append($('<a href="#" role="button" class="back">').attr("aria-label",d("Back to list")).append($('<i class="fa fa-chevron-left" aria-hidden="true">'),$.txt(" "),$.txt(d("Back")))),$('<div class="position">'),$('<div class="prev-next">').append($('<a href="#" role="button" class="previous-mail">').attr("aria-label",d("Previous message")).append($('<i class="fa fa-chevron-up" aria-hidden="true">')),$('<a href="#" role="button" class="next-mail">').attr("aria-label",d("Next message")).append($('<i class="fa fa-chevron-down" aria-hidden="true">')))).attr("role","navigation"))}}),t.point("io.ox/mail/thread-view").extend({id:"thread-view-list",index:200,draw:function(){this.$el.append($('<div class="thread-view-list scrollable abs">').hide().append($('<div class="thread-view-header">').attr("aria-label",d("Conversation")),this.$messages=$('<div class="thread-view list-view" role="region">')).on("scroll",this.onScrollEnd.bind(this)))}}),t.point("io.ox/mail/thread-view/header").extend({id:"toggle-all",index:100,draw:function(e){e.view.collection.length<=1||this.append($('<a href="#" role="button" class="toggle-all">').append('<i class="fa fa-angle-double-down" aria-hidden="true">').attr("aria-label",d("Open all messages")).tooltip({animation:!1,container:"body",placement:"left",title:d("Open/close all messages")}))}}),t.point("io.ox/mail/thread-view/header").extend({id:"subject",index:200,draw:function(e){var t=1===e.view.collection.length,n=e.view.model.toJSON(),a=e.view.threaded?i.threads.subject(n)||n.subject:n.subject;this.append($('<h1 class="subject">').text(o.getSubject(a,t)))}});var c=Backbone.View.extend({tagName:"div",className:"thread-view-control abs",events:{"click .button a.back":"onBack","click .back-navigation .previous-mail":"onPrevious","click .back-navigation .next-mail":"onNext","click .toggle-all":"onToggleAll",keydown:"onKeydown"},empty:function(){this.$messages.empty(),this.$el.scrollTop(0),this.$el.find(".thread-view-list").hide(),this.model=null},updateHeader:function(){var e=new t.Baton({view:this}),i=this.$el.find(".thread-view-list > .thread-view-header").empty(),n=1===e.view.collection.length,a=o.getSubject(e.view.model.toJSON(),n);this.collection.length>0&&t.point("io.ox/mail/thread-view/header").invoke("draw",i,e),this.$el.find(".thread-view").toggleClass("multiple-messages",this.collection.length>1).attr("aria-label",a)},updatePosition:function(e){return this.$el.find(".position").text(e),this},togglePrevious:function(e){return this.$el.find(".previous-mail").toggleClass("disabled",!e),this},toggleNext:function(e){return this.$el.find(".next-mail").toggleClass("disabled",!e),this},toggleNavigation:function(e){return this.$el.toggleClass("back-navigation-visible",e),this},onToggle:_.debounce(function(e){var t=0===this.getItems().filter(".expanded").length,i=t?"fa-angle-double-down":"fa-angle-double-up",o=this.$el.find(".toggle-all");o.attr("aria-label",d(t?"Open all messages":"Close all messages")),o.find("i").attr("class","fa "+i),e&&$(e.target).hasClass("expanded")||this.onScrollEnd()},10),onToggleAll:function(e){e.preventDefault();var t=0===this.getItems().filter(".expanded").length;l.pause(),this.collection.each(function(e){this.toggleMail(e.cid,t)},this),l.resume()},toggleMail:function(e,t){var i=this.$messages.children('[data-cid="'+$.escape(e)+'"]').data("view");i&&i.toggle(t)},showMail:function(e){this.toggleMail(e,!0)},autoSelectMail:function(e){if(this.autoSelect){for(var t,i=0;t=this.collection.at(i);i++)if(i===this.collection.length-1||!o.isUnseen(t.toJSON())){if(e)return t.cid;this.showMail(t.cid);break}delete this.autoSelect}else for(var n,a=this.collection.length-1;n=this.collection.at(a);a--)if(0===a||o.isUnseen(n.toJSON())){if(e)return n.cid;this.showMail(n.cid);break}},onScrollEnd:_.debounce(function(){var e=this.$el.find(".thread-view-list");this.getItems().each(function(){if($(this).hasClass("placeholder")&&this.offsetTop+$(this).height()>e.scrollTop()&&this.offsetTop<e.scrollTop()+e.height()){var t=$(this).data("view");t&&(t.placeholder=!1,t.render())}})},100),show:function(e,t){if(e=String(e).replace(/^thread\./,""),!this.model||this.model.cid!==e){var o=i.pool.get("detail"),n=o.get(e);if(!n)return this.empty(),void console.error("ThreadView.show(): Mail not found in pool",e,o);this.model&&this.stopListening(this.model),this.model=n,this.threaded=!!t,this.threaded||delete this.autoSelect,this.listenTo(this.model,"change:thread",this.onChangeModel),this.collection.reset([],{silent:!0}),this.reset()}},reset:function(){if(this.model){var e=this.threaded?i.threads.get(this.model.cid):[this.model.toJSON()];if(e.length){var t=0===this.collection.length?"reset":"set";this.collection[t](e)}}},onReset:function(){0!==this.collection.length?(this.$messages.empty(),this.$el.scrollTop(0),clearTimeout(this.renderItemTimoutId),this.updateHeader(),this.$el.find(".thread-view-list").show(),this.nextAutoSelect=this.autoSelectMail(!0),this.$messages.append(this.collection.chain().map(this.renderListItem,this).value()),this.zIndex()):this.empty()},onAdd:function(e){var t=e.get("index"),i=this.getItems(),o=this.renderListItem(e),n=this.$el.data("open");t<i.length?i.eq(t).before(o):this.$messages.append(o),o.position().top<=0&&this.$messages.scrollTop(this.$el.scrollTop()+o.outerHeight(!0)),this.zIndex(),this.updateHeader(),n&&(this.showMail(n),this.$el.data("open",null))},onRemove:function(e){var t=this.getItems(),i=t.filter(function(){return $(this).attr("data-cid")===e.cid}),o=!!i.length&&(i.attr("data-cid")&&t.first().attr("data-cid")),n=this.$messages.scrollTop();0!==i.length&&(i.position().top<n&&this.$messages.scrollTop(n-i.outerHeight(!0)),i.remove(),1===t.length?this.empty():this.updateHeader(),t.length>1&&o&&this.autoSelectMail())},onPoolRemove:function(e){this.collection.remove(e)},onChangeModel:function(){this.reset()},onBack:function(e){e.preventDefault(),this.trigger("back")},onPrevious:function(e){e.preventDefault(),this.trigger("previous")},onNext:function(e){e.preventDefault(),this.trigger("next")},onClick:function(e){var t=$(e.currentTarget).attr("data-cid");this.showMail(t)},onKeydown:function(e){switch(e.which){case 38:e.shiftKey&&this.onNext(e),e.altKey&&this.focusMessage(e,-1);break;case 40:e.shiftKey&&this.onPrevious(e),e.altKey&&this.focusMessage(e,1)}},focusMessage:function(e,t){var i=this.getItems(),o=$(document.activeElement).closest(".list-item"),n=i.index(o);e.preventDefault(),(n+=t)<0||n>=i.length||(o.data("view").toggle(!1),i.eq(n).focus().data("view").toggle(!0),i.eq(n).get(0).scrollIntoView(!0))},initialize:function(e){this.model=null,this.threaded=!0,this.collection=new n.Collection,e=e||{},this.standalone=e.standalone||!1,this.app=e.app,this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset}),this.listenTo(i.pool.get("detail"),{remove:this.onPoolRemove}),this.$messages=$(),this.$el.data("view",this),this.$el.on("toggle",".list-item",this.onToggle.bind(this)),e.disableDrag||(s.enable({container:this.$el,draggable:!0,selectable:".detail-view-header .contact-picture",simple:!0}),this.$el.on("mouseup",".detail-view-header .contact-picture",function(e){$(e.target).closest("article").focus()}));var t=$.proxy(this.onScrollEnd,this);this.$el.one("remove",function(){$(window).off("resize",t)}),e.app&&this.listenTo(e.app.props,"change:textPreview",function(e,i){this.$el.toggleClass("hide-text-preview",!i),t()}),$(window).on("resize",t)},getItems:function(){return this.$messages.children(".list-item")},render:function(){return this.$el.toggleClass("hide-text-preview",!this.app||!this.app.useTextPreview()),t.point("io.ox/mail/thread-view").invoke("draw",this),this},renderListItem:function(e){var t=this,i=new a.View({supportsTextPreview:!!this.app&&this.app.supportsTextPreviewConfiguration(),tagName:"article",data:e.toJSON(),disable:{"io.ox/mail/detail":"subject"}});return i.on("mail:detail:body:render",function(e){t.trigger("mail:detail:body:render",e)}),i.render(),this.nextAutoSelect===e.cid&&(delete this.nextAutoSelect,i.expand()),i.$el.attr({tabindex:-1})},zIndex:function(){var e=this.getItems(),t=e.length;e.each(function(e){$(this).css("zIndex",t-e)}),this.onScrollEnd()}});return t.point("io.ox/mail/mobile/thread-view").extend({id:"thread-view-list",index:100,draw:function(){this.$el.append($('<div class="thread-view-list scrollable abs">').hide().append($('<div class="thread-view-header">').attr("aria-label",d("Conversation")),this.$messages=$('<ul class="thread-view list-view">')).on("scroll",this.onScrollEnd.bind(this)))}}),t.point("io.ox/mail/detail").extend({id:"remove-halo-link",index:"last",draw:function(){_.device("!smartphone")||this.find(".halo-link").removeClass("halo-link")}}),{Desktop:c,Mobile:c.extend({initialize:function(){this.model=null,this.threaded=!0,this.collection=new n.Collection,this.listenTo(this.collection,{add:this.onAdd,remove:this.onRemove,reset:this.onReset}),this.listenTo(i.pool.get("detail"),{remove:this.onPoolRemove}),this.$messages=$()},renderListItem:function(e){var t=new r.HeaderView({tagName:"li",data:e.toJSON(),disable:{"io.ox/mail/detail":["subject","actions"],"io.ox/mail/detail/header":["paper-clip"],"io.ox/mail/detail/header/row1":["color-picker","flag-toggle","security"]}});return t.render().$el.attr({role:"listitem",tabindex:"0"}),t.$el},renderMail:function(e){e=String(e).replace(/^thread\.(.+)$/,"$1");var t=i.pool.get("detail").get(e);if(t){var o=new r.DetailView({tagName:"li",data:t.toJSON()});return this.mail=t.toJSON(),o.render().toggle().$el.attr({role:"listitem",tabindex:"0"})}},render:function(){return t.point("io.ox/mail/thread-view/header").disable("toggle-all"),t.point("io.ox/mail/thread-view").invoke("draw",this),this}})}}),define("io.ox/mail/actions",["io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/mail/api","io.ox/mail/util","io.ox/files/api","io.ox/core/folder/api","io.ox/core/print","io.ox/core/api/account","io.ox/core/notifications","io.ox/core/viewer/views/types/typesutil","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,o,n,a,r,s,l,d,c,u){function p(e){if(!(e.selection.length>1)&&(!e.collection.has("multiple")||e.isThread)){var t=e.first();return o.hasFrom(t)&&!f(t)}}function f(e){return h(e.folder_id)||(4&e.flags)>0}function h(e){return _.contains(s.getFoldersByType("drafts"),e)}function g(e){return function(t){var i=t.first();require(["io.ox/mail/compose/checks"],function(t){t.replyToMailingList(_.cid(i),e,i).then(function(e){ox.registry.call("mail-compose","open",{type:e,original:{folderId:i.folder_id,id:i.id,security:i.security}})})})}}function m(e,t){return!1!==e&&(!!s.isPrimary(t.folder_id)&&(!s.isUnifiedFolder(t.folder_id)&&!s.is("archive",t.folder_id)))}function v(e,t,i){return function(o){require(["io.ox/mail/actions/copyMove"],function(n){n.multiple({list:o.array(),baton:o,type:e,label:t,success:i})})}}function x(e,t){return!1!==e&&(!!s.isPrimary(t.folder_id)&&(!s.is("spam|confirmed_spam|sent|drafts",t.folder_id)&&!o.isSpam(t)))}function b(e,t){return!1!==e&&(!!s.isPrimary(t.folder_id)&&(!(s.getFoldersByType("spam").concat(s.getFoldersByType("confirmed_spam")).indexOf(t.folder_id)<0)&&(s.is("spam|confirmed_spam",t.folder_id)||o.isSpam(t))))}var w=t.Action;new w("io.ox/mail/actions/compose",{device:"!guest",action:function(e){ox.registry.call("mail-compose","open",null,{folderId:e.app.folder.get()})}}),new w("io.ox/mail/actions/reply-all",{collection:"some && toplevel",matches:p,action:g("replyall")}),new w("io.ox/mail/actions/reply",{collection:"some && toplevel",matches:p,action:g("reply")}),new w("io.ox/mail/actions/forward",{device:"!guest",collection:"some && toplevel",action:function(e){var t=e.selection&&e.selection.length>1?e.selection.map(function(e){return _.cid(_.cid(e).replace(/^thread./,""))}):[e.first()];t=t.map(function(e){return{id:e.id,folderId:e.folder_id,security:e.security}}),ox.registry.call("mail-compose","open",{type:"forward",original:t})}}),new w("io.ox/mail/actions/delete",{collection:"toplevel && some && delete",action:"io.ox/mail/actions/delete"}),new w("io.ox/mail/actions/edit",{collection:"one && toplevel",matches:function(e){var t=e.first();return!(t&&t.security_info&&t.security_info.encrypted)&&(t&&f(t))},action:function(e){var t=e.first(),i=_(ox.ui.apps.models).find(function(e){return e.refId===t.id});if(i)return i.launch();ox.registry.call("mail-compose","open",{type:"edit",original:{folderId:t.folder_id,id:t.id,security:t.security}})}}),new w("io.ox/mail/actions/edit-copy",{collection:"one && toplevel",matches:function(e){var t=e.first();if(!(t&&t.security_info&&t.security_info.encrypted))return t&&f(t)},action:function(e){var t=e.first();ox.registry.call("mail-compose","open",{type:"copy",original:{folderId:t.folder_id,id:t.id}}).done(function(e){var t=e.app.model;t.set("subject",u("[Copy] %1$s",t.get("subject")))})}}),new w("io.ox/mail/actions/source",{collection:"some && toplevel",matches:function(e){if(!(e.selection&&e.selection.length>1))return!(e.collection.has("multiple")&&!e.isThread)},action:"io.ox/mail/actions/source"}),new w("io.ox/mail/actions/filter",{capabilities:"mailfilter_v2",collection:"some && toplevel",matches:function(e){return!(e.collection.has("multiple")&&!e.isThread)},action:function(t){require(["io.ox/mail/mailfilter/settings/filter"],function(i){i.initialize().then(function(i,o,n){var a={data:{obj:n.model.protectedMethods.buildFactory("io.ox/core/mailfilter/model",n.api).create(n.model.protectedMethods.provideEmptyModel())}},r={id:"allof",tests:[_.copy(n.filterDefaults.tests.subject),n.filterDefaults.tests.address?_.copy(n.filterDefaults.tests.address):_.copy(n.filterDefaults.tests.from)]};r.tests[0].values=[t.data.subject],r.tests[1].values=[t.data.from[0][1]],a.data.obj.set("test",r),e.point("io.ox/settings/mailfilter/filter/settings/detail").invoke("draw",void 0,a,o)})})}}),new w("io.ox/mail/actions/print",{device:"!smartphone",collection:"some && (read || !toplevel)",action:function(e){r.request("io.ox/mail/print",e.array())}}),new w("io.ox/mail/actions/flag",{toggle:c.get("features/flag/star"),collection:"some",matches:function(e){return!_(e.array()).every(o.isFlagged)},action:function(e){i.flag(e.data,!0)}}),new w("io.ox/mail/actions/unflag",{toggle:c.get("features/flag/star"),collection:"some",matches:function(e){return _(e.array()).any(o.isFlagged)},action:function(e){i.flag(e.data,!1)}}),new w("io.ox/mail/actions/archive",{capabilities:"archive_emails",collection:"some && delete",matches:function(e){return e.array().reduce(m,!0)},action:function(e){var t=_.isArray(e.data)?e.data:[e.data];i.archive(t)}}),new w("io.ox/mail/actions/triggerFlags",{collection:"some",action:function(e){console.log(e.e);var t=$(".dropdown.flag-picker").data();$(document).trigger("click.bs.dropdown.data-api"),_.delay(function(){t.view.open()},200)}}),new w("io.ox/mail/actions/move",{collection:"toplevel && some && delete",action:v("move",u("Move"),{single:u("Email has been moved"),multiple:u("Emails have been moved")})}),new w("io.ox/mail/actions/copy",{collection:"toplevel && some",action:v("copy",u("Copy"),{single:u("Email has been copied"),multiple:u("Emails have been copied")})}),new w("io.ox/mail/actions/mark-unread",{collection:"toplevel && change:seen",matches:function(e){return e.array().reduce(function(e,t){return e||!o.isUnseen(t)},!1)},action:function(e){var t=a.ignoreSentItems(e.array());i.markUnread(t)}}),new w("io.ox/mail/actions/mark-read",{collection:"toplevel && change:seen",matches:function(e){return e.array().reduce(function(e,t){return e||o.isUnseen(t)},!1)},action:function(e){var t=a.ignoreSentItems(e.array());i.markRead(t)}}),new w("io.ox/mail/actions/spam",{capabilities:"spam",collection:"some && delete && toplevel",matches:function(e){return e.array().reduce(x,!0)},action:function(e){i.markSpam(e.array()).done(function(e){var t=_(e).chain().pluck("error").compact().first().value();t&&l.yell(t)}).fail(function(e){l.yell(e),i.trigger("refresh.all")})}}),new w("io.ox/mail/actions/nospam",{capabilities:"spam",collection:"some && delete && toplevel",matches:function(e){return e.array().reduce(b,!0)},action:function(e){i.noSpam(e.array()).done(function(e){var t=_(e).chain().pluck("error").compact().first().value();t&&l.yell(t)})}}),new w("io.ox/mail/actions/save",{device:"!ios",collection:"some && read",action:function(e){require(["io.ox/mail/actions/save"],function(t){t.multiple(e.array())})}}),new w("io.ox/mail/actions/add-to-portal",{capabilities:"portal",collection:"one && toplevel",action:function(e){require(["io.ox/mail/actions/addToPortal"],function(t){t(e)})}}),new w("io.ox/mail/actions/sendmail",{collection:"some",action:function(e){require(["io.ox/core/api/user"],function(t){s.getAllSenderAddresses().done(function(i){t.getCurrentUser().done(function(t){var o=e.data,n=o.to.concat(o.cc).concat(o.bcc).concat(o.from),a=_.compact([t.get("email1"),t.get("email2"),t.get("email3")]);a=a.concat(_(i).pluck(1));var r=_(n).filter(function(e){return a.indexOf(e[1])<0});0===r.length&&(r=n),r=_(r).uniq(!1,function(e){return e[1]}),ox.registry.call("mail-compose","open",{to:r})})})})}}),new w("io.ox/mail/actions/createdistlist",{capabilities:"contacts",collection:"some",action:function(e){require(["io.ox/mail/actions/create"],function(t){t.createDistributionList(e)})}}),new w("io.ox/mail/actions/invite",{capabilities:"calendar",collection:"some",action:function(e){require(["io.ox/mail/actions/create"],function(t){t.createAppointment(e)})}}),new w("io.ox/mail/actions/reminder",{capabilities:"tasks",collection:"one && toplevel",action:function(e){require(["io.ox/mail/actions/reminder"],function(t){t(e)})}}),new w("io.ox/mail/attachment/actions/view",{collection:"some",matches:function(e){return e.array().some(function(e){var t=new n.Model(e);return d.canView(t)})},action:function(e){var t=e.list||e.array(),i=e.array()[0];ox.load(["io.ox/mail/actions/viewer"]).done(function(o){o({files:t,selection:i,restoreFocus:e.restoreFocus,openedBy:e.openedBy})})}}),new w("io.ox/mail/attachment/actions/download",{device:"!ios || ios >= 11",collection:"some",action:function(e){var t=e.array(),o=1===t.length?i.getUrl(_(t).first(),"download"):i.getUrl(t,"zip");require(["io.ox/core/download"],function(e){e[_.device("ios")?"window":"url"](o)})}}),new w("io.ox/mail/attachment/actions/save",{capabilities:"infostore",collection:"some",action:function(e){require(["io.ox/mail/actions/attachmentSave"],function(t){t.multiple(e.array())})}}),new w("io.ox/mail/attachment/actions/vcard",{capabilities:"contacts",collection:"one",matches:function(e){var t=e.first(),i=/\.vcf$/i.test(t.filename),o=/^text\/(x-)?vcard/i.test(t.content_type),n=/^text\/directory/i.test(t.content_type);return i&&n||o},action:function(e){require(["io.ox/mail/actions/vcard"],function(t){t(e)})}}),new w("io.ox/mail/attachment/actions/ical",{capabilities:"calendar",collection:"some",matches:function(e){var t=e.first(),o=t.filename&&!!t.filename.match(/\.ics$/i),n=t.content_type&&!!t.content_type.match(/^text\/calendar/i),a=t.content_type&&!!t.content_type.match(/^application\/ics/i);return!i.pool.get("detail").get(_.cid(t.mail)).get("imipMail")&&(o||n||a)},action:function(e){require(["io.ox/mail/actions/ical"],function(t){t(e)})}});var y=[{id:"reply",prio:"hi",mobile:"lo",title:u("Reply"),ref:"io.ox/mail/actions/reply",section:"standard"},{id:"reply-all",prio:"hi",mobile:"hi",title:u("Reply all"),ref:"io.ox/mail/actions/reply-all",section:"standard"},{id:"forward",prio:"hi",mobile:"hi",title:u("Forward"),ref:"io.ox/mail/actions/forward",section:"standard"},{id:"edit",prio:"hi",mobile:"lo",title:u("Edit"),ref:"io.ox/mail/actions/edit",section:"standard"},{id:"delete",prio:"hi",mobile:"lo",title:u("Delete"),ref:"io.ox/mail/actions/delete",section:"standard"},{id:"spam",prio:"lo",mobile:"lo",title:u("Mark as spam"),ref:"io.ox/mail/actions/spam",section:"flags"},{id:"nospam",prio:"lo",mobile:"lo",title:u("Not spam"),ref:"io.ox/mail/actions/nospam",section:"flags"},{id:"sendmail",prio:"lo",title:u("Send new email"),ref:"io.ox/mail/actions/sendmail",section:"recipients"},{id:"invite-to-appointment",prio:"lo",title:u("Invite to appointment"),ref:"io.ox/mail/actions/invite",section:"recipients"},{id:"save-as-distlist",prio:"lo",title:u("Save as distribution list"),ref:"io.ox/mail/actions/createdistlist",section:"recipients"},{id:"move",prio:"lo",title:u("Move"),ref:"io.ox/mail/actions/move",section:"file-op"},{id:"copy",prio:"lo",title:u("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"},{id:"archive",prio:"lo",title:u.pgettext("verb","Archive"),ref:"io.ox/mail/actions/archive",section:"file-op"},{id:"print",prio:"lo",mobile:"none",title:u("Print"),ref:"io.ox/mail/actions/print",section:"export"},{id:"save-as-eml",prio:"lo",mobile:"none",title:u("Save as file"),ref:"io.ox/mail/actions/save",section:"export"},{id:"source",prio:"lo",mobile:"lo",title:u("View source"),ref:"io.ox/mail/actions/source",section:"export"},{id:"filter",prio:"lo",mobile:"none",title:u("Create filter rule"),ref:"io.ox/mail/actions/filter",section:"file-op"},{id:"reminder",prio:"lo",mobile:"none",title:u("Reminder"),ref:"io.ox/mail/actions/reminder",section:"keep"},{id:"add-to-portal",prio:"lo",mobile:"none",title:u("Add to portal"),ref:"io.ox/mail/actions/add-to-portal",section:"keep"}];e.point("io.ox/mail/links/inline").extend(y.map(function(e,t){return e.index=100+100*t,e.mobile=e.mobile||e.prio||"none",e})),new w("io.ox/mail/actions/label",{id:"label",collection:"toplevel some",action:$.noop}),e.point("io.ox/mail/attachment/links").extend({id:"vcard",mobile:"hi",index:50,title:u("Add to address book"),ref:"io.ox/mail/attachment/actions/vcard"},{id:"ical",mobile:"hi",index:50,title:u("Add to calendar"),ref:"io.ox/mail/attachment/actions/ical"},{id:"view_new",index:100,mobile:"hi",title:u("View"),ref:"io.ox/mail/attachment/actions/view"},{id:"download",index:400,mobile:"hi",title:u("Download"),ref:"io.ox/mail/attachment/actions/download"},{id:"save",index:500,mobile:"hi",title:u("Save to %1$s",u.pgettext("app","Drive")),ref:"io.ox/mail/attachment/actions/save"},{id:"viewer",index:600,mobile:"hi",label:u("View"),ref:"io.ox/mail/actions/viewer"}),e.point("io.ox/mail/dnd/actions").extend({id:"importEML",index:10,label:u("Drop here to import this email"),action:function(e,t){t.queues.importEML.offer(e,{folder:t.folder.get()})}}),e.point("io.ox/mail/folderview/premium-area").extend({index:100,id:"inline-premium-links",draw:function(e){this.append(e.renderActions("io.ox/mail/links/premium-links",e))}})}),define("io.ox/mail/actions/attachmentQuota",["io.ox/core/tk/dialogs","io.ox/core/notifications","io.ox/core/strings","settings!io.ox/core","gettext!io.ox/mail"],function(e,t,i,o,n){return{checkQuota:function(e,a){var r,s,l=e,d=o.get("properties"),c=a||0,u=require("io.ox/core/capabilities").has("publish_mail_attachments"),p={};if(l.length)return r=u?-1:d.attachmentQuotaPerFile,s=u?-1:d.attachmentQuota,_.find(l,function(e){var t=e.filename||e.name||e.subject,o=e.file_size||e.size;if(o){if(c+=o,s>0&&c>s)return p.error=n('The file "%1$s" cannot be uploaded because it exceeds the total attachment size limit of %2$s',t,i.fileSize(s)),p.reason="filesize",!0;if(r>0&&o>r)return p.error=n('The file "%1$s" cannot be uploaded because it exceeds the maximum file size of %2$s',t,i.fileSize(r)),p.reason="filesize",!0;if(u){if(d.infostoreMaxUploadSize>0&&o>d.infostoreMaxUploadSize)return p.error=n('The file "%1$s" cannot be uploaded because it exceeds the attachment publication maximum file size of %2$s',t,i.fileSize(d.infostoreMaxUploadSize)),p.reason="filesizeAutoPublish",!0;if(d.infostoreQuota>0&&c>d.infostoreQuota-d.infostoreUsage)return p.error=n('The file "%1$s" cannot be uploaded because it exceeds the infostore quota limit of %2$s',t,i.fileSize(d.infostoreQuota)),p.reason="quotaAutoPublish",!0}}}),!p.error||(t.yell("error",p.error),!1)}}}),define.async("io.ox/mail/toolbar",["io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/core/tk/flag-picker","io.ox/mail/api","io.ox/core/capabilities","io.ox/backbone/mini-views/dropdown","io.ox/backbone/views/toolbar","io.ox/core/api/mailfilter","settings!io.ox/core","settings!io.ox/mail","gettext!io.ox/mail","io.ox/mail/actions","less!io.ox/mail/style","io.ox/mail/folderview-extensions"],function(e,t,i,o,n,a,r,s,l,d,c){function u(){if(this.model){var e=this.$el.find('[data-name="contactPictures"]').parent(),t=this.model.get("layout");"vertical"===t||"compact"===t?e.show():e.hide()}}function p(e,t){t.preventDefault(),require(["io.ox/mail/statistics"]).done(function(t){t.open(e)})}function f(e,t){t.preventDefault();var i=l.get("folder/mailattachments",{});ox.launch("io.ox/files/main",{folder:i.all}).done(function(){this.folder.set(i.all)})}function h(e){require(["io.ox/mail/categories/edit"],function(t){t.open(e)})}function g(e){e.preventDefault(),require(["io.ox/mail/mailfilter/vacationnotice/view"],function(e){e.open()})}var m=e.point("io.ox/mail/toolbar/links"),v=$.when(),x={compose:{prio:"hi",mobile:"hi",title:c("Compose"),tooltip:c("Compose new email"),drawDisabled:!0,ref:"io.ox/mail/actions/compose"},edit:{prio:"hi",mobile:"lo",title:c("Edit draft"),ref:"io.ox/mail/actions/edit"},"edit-copy":{prio:"hi",mobile:"lo",title:c("Edit copy"),ref:"io.ox/mail/actions/edit-copy"},reply:{prio:"hi",mobile:"lo",icon:"fa fa-reply",title:c("Reply to sender"),drawDisabled:!0,ref:"io.ox/mail/actions/reply"},"reply-all":{prio:"hi",mobile:"lo",icon:"fa fa-reply-all",title:c("Reply to all recipients"),drawDisabled:!0,ref:"io.ox/mail/actions/reply-all"},forward:{prio:"hi",mobile:"lo",icon:"fa fa-mail-forward",title:c("Forward"),drawDisabled:!0,ref:"io.ox/mail/actions/forward"},delete:{prio:"hi",mobile:"lo",icon:"fa fa-trash-o",title:c("Delete"),drawDisabled:!0,ref:"io.ox/mail/actions/delete"},spam:{prio:"hi",mobile:"lo",icon:"fa fa-ban",title:c("Mark as spam"),ref:"io.ox/mail/actions/spam"},nospam:{prio:"hi",mobile:"lo",icon:"fa fa-thumbs-up",title:c("Not spam"),ref:"io.ox/mail/actions/nospam"},category:{prio:"hi",mobile:"none",icon:"fa fa-folder-open-o",title:c("Set category"),ref:"io.ox/mail/actions/category",customize:function(e){d.get("categories/enabled")&&require(["io.ox/mail/categories/picker"],function(t){t.attach(this,{props:e.app.props,data:e.data})}.bind(this))}},color:{prio:"hi",mobile:"none",icon:"fa fa-bookmark-o",title:c("Set color"),ref:"io.ox/mail/actions/color",customize:function(e){d.get("features/flag/color")&&i.attach(this,{data:e.data})}},flag:{prio:"hi",mobile:"lo",icon:"fa fa-star",title:c.pgettext("verb","Flag"),ref:"io.ox/mail/actions/flag"},unflag:{prio:"hi",mobile:"lo",icon:"fa fa-star-o",title:c.pgettext("verb","Unflag"),ref:"io.ox/mail/actions/unflag"},archive:{prio:"hi",mobile:"lo",icon:"fa fa-archive",title:c.pgettext("verb","Archive"),ref:"io.ox/mail/actions/archive"},"mark-read":{prio:"lo",mobile:"lo",title:c("Mark as read"),ref:"io.ox/mail/actions/mark-read",section:"flags"},"mark-unread":{prio:"lo",mobile:"lo",title:c("Mark as unread"),ref:"io.ox/mail/actions/mark-unread",section:"flags"},move:{prio:"lo",mobile:"lo",title:c("Move"),ref:"io.ox/mail/actions/move",section:"file-op"},copy:{prio:"lo",mobile:"lo",title:c("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"},print:{prio:"lo",mobile:"lo",title:c("Print"),ref:"io.ox/mail/actions/print",section:"export"},"save-as-eml":{prio:"lo",mobile:"lo",title:c("Save as file"),ref:"io.ox/mail/actions/save",section:"export"},source:{prio:"lo",mobile:"none",title:c("View source"),ref:"io.ox/mail/actions/source",section:"export"},reminder:{prio:"lo",mobile:"none",title:c("Reminder"),ref:"io.ox/mail/actions/reminder",section:"keep"},"add-to-portal":{prio:"lo",mobile:"none",title:c("Add to portal"),ref:"io.ox/mail/actions/add-to-portal",section:"keep"}},b=0;_(x).each(function(e,t){m.extend(_.extend({id:t,index:b+=100},e))});var w=t.Action;return new w("io.ox/mail/actions/category",{capabilities:"mail_categories",collection:"some",matches:function(e){return!!e.app.props.get("categories")},action:$.noop}),new w("io.ox/mail/actions/color",{toggle:d.get("features/flag/color"),collection:"some",action:$.noop}),e.point("io.ox/mail/toolbar/links").extend({id:"view-dropdown",index:1e4,custom:!0,draw:function(t){if(!_.device("smartphone")){var i=new a({el:this,caret:!0,model:t.app.props,label:c("View")});i.render().$el.addClass("dropdown pull-right").attr("data-dropdown","view"),e.point("io.ox/mail/toolbar/links/view-dropdown").invoke("draw",i,t)}}}),e.point("io.ox/mail/toolbar/links/view-dropdown").extend({id:"layout",index:100,draw:function(){this.group(c("Layout")).option("layout","vertical",c("Vertical"),{radio:!0,group:!0}),_.device("desktop")&&this.option("layout","compact",c("Compact"),{radio:!0,group:!0}),this.option("layout","horizontal",c("Horizontal"),{radio:!0,group:!0}).option("layout","list",c("List"),{radio:!0,group:!0}).divider()}}),e.point("io.ox/mail/toolbar/links/view-dropdown").extend({id:"categories",index:200,draw:function(e){n.has("mail_categories")&&!_.device("smartphone")&&this.group(c("Inbox")).option("categories",!0,c("Use categories"),{group:!0}).link("categories-config",c("Configure")+" …",_.bind(h,this,e.app.props),{icon:!0,group:!0}).divider()}}),e.point("io.ox/mail/toolbar/links/view-dropdown").extend({id:"options",index:300,draw:function(e){function t(){i.$('[data-name="textPreview"]').toggle(e.app.supportsTextPreviewConfiguration())}var i=this;i.group(c("Options")).option("folderview",!0,c("Folder view"),{group:!0}),"alternative"!==l.get("selectionMode")&&i.option("checkboxes",!0,c("Checkboxes"),{group:!0}),e.app.supportsTextPreview()&&i.option("textPreview",!0,c("Text preview"),{group:!0}),i.option("contactPictures",!0,c("Contact pictures"),{group:!0}).option("exactDates",!0,c("Exact dates"),{group:!0}).option("alwaysShowSize",!0,c("Message size"),{group:!0}).divider(),i.listenTo(e.app.props,"change:layout",u),t(),e.app.on("folder:change",t),u.call(i)}}),e.point("io.ox/mail/toolbar/links/view-dropdown").extend({id:"vacation-notice",index:400,draw:function(){var e,t=s.getConfig().then(function(t){e=!!_(t.actioncmds).findWhere({id:"vacation"})},function(){e=!1});return v=v.then(function(){return t}),function(){n.has("mailfilter_v2")&&e&&this.link("vacation-notice",c("Vacation notice"),g)}}()}),e.point("io.ox/mail/toolbar/links/view-dropdown").extend({id:"mail-attachments",index:500,draw:function(e){l.get("folder/mailattachments",{}).all&&this.link("attachments",c("All attachments"),f.bind(null,e.app))}}),e.point("io.ox/mail/toolbar/links/view-dropdown").extend({id:"statistics",index:600,draw:function(e){this.link("statistics",c("Statistics"),p.bind(null,e.app))}}),e.point("io.ox/mail/mediator").extend({id:"toolbar",index:1e4,setup:function(e){if(!_.device("smartphone")){var t=new r({point:"io.ox/mail/toolbar/links",title:e.getTitle()});e.getWindow().nodes.body.addClass("classic-toolbar-visible").prepend(t.$el),e.updateToolbar=function(e){var i={data:[],folder_id:this.folder.get(),app:this,isThread:this.isThreaded()};t.setSelection(e.map(_.cid),function(){return i.data=o.resolve(e,i.isThread),i})},e.forceUpdateToolbar=function(e){t.selection=null,this.updateToolbar(e)}}}}),e.point("io.ox/mail/mediator").extend({id:"update-toolbar",index:10200,setup:function(e){_.device("smartphone")||(e.updateToolbar([]),e.listView.on("selection:change",function(){e.updateToolbar(e.listView.selection.get())}),e.listView.on("change",function(t){"flags"in t.changed&&e.forceUpdateToolbar(e.listView.selection.get())}))}}),v}),define("io.ox/mail/import",["io.ox/core/extensions","io.ox/mail/api","io.ox/core/api/account","io.ox/core/tk/upload","io.ox/core/dropzone","io.ox/core/notifications","gettext!io.ox/mail"],function(e,t,i,o,n,a,r){e.point("io.ox/mail/mediator").extend({id:"import-eml",index:1e12,setup:function(e){if(!1!==e.settings.get("features/importEML")){var s=e.getWindow();e.queues={importEML:o.createQueue({start:function(){s.busy()},progress:function(e){return t.importEML({file:e.file,folder:e.options.folder}).done(function(t){var i=_(t.data||[]).first()||{};e.response=i,"Error"in i?a.yell("error",i.Error):a.yell("success",r("Mail has been imported"))}).fail(a.yell)},stop:function(){s.idle()},type:"importEML"})};var l=new(n.Inplace.extend({isSupported:function(){return!i.isUnifiedFolder(e.folder.get())}}))({caption:r("Drop EML file here for import"),filter:/\.eml$/i});l.on({show:function(){e.right.removeClass("preview-visible"),e.listControl.$el.stop().hide()},hide:function(){e.listControl.$el.fadeIn("fast")},drop:function(t){e.queues.importEML.offer(t,{folder:e.folder.get()})},invalid:function(){a.yell("error",r("Mail was not imported. Only .eml files are supported."))}}),e.left.append(l.render().$el.addClass("abs"))}}})}),define("io.ox/mail/folderview-extensions",["io.ox/core/extensions","io.ox/core/capabilities","gettext!io.ox/mail"],function(e,t,i){function o(e){e.preventDefault(),require(["io.ox/mail/accounts/settings"],function(t){t.mailAutoconfigDialog(e)})}t.has("multiple_mail_accounts")&&e.point("io.ox/mail/folderview/sidepanel/links").extend({id:"add-account",index:300,draw:function(){_.device("!smartphone")&&this.append($("<div>").append($('<a href="#" data-action="add-mail-account" role="button">').text(i("Add mail account")).on("click",o)))}})}),define("io.ox/mail/mobile-navbar-extensions",["io.ox/core/extensions"],function(e){e.point("io.ox/mail/mobile/navbar").extend({id:"btn-left",index:100,draw:function(e){e.left&&this.$el.append($('<div class="navbar-action left">').append($("<a>").append($('<i class="fa fa-chevron-left" aria-hidden="true">'),e.left)))}}),e.point("io.ox/mail/mobile/navbar").extend({id:"header",index:200,draw:function(e){this.$el.append($('<div class="navbar-title">').text(e.title))}}),e.point("io.ox/mail/mobile/navbar").extend({id:"btn-right",index:300,draw:function(e){e.right&&this.$el.append($('<div class="navbar-action right">').append($("<a>").append(e.right)))}})}),define("io.ox/mail/mobile-toolbar-actions",["io.ox/core/extensions","io.ox/backbone/views/toolbar","io.ox/backbone/views/actions/mobile","io.ox/mail/api","io.ox/core/capabilities","gettext!io.ox/mail"],function(e,t,i,o,n,a){var r={compose:{prio:"hi",mobile:"hi",title:a("Compose"),icon:"fa fa-pencil",ref:"io.ox/mail/actions/compose",drawDisabled:!0},reply:{prio:"hi",mobile:"hi",icon:"fa fa-reply",title:a("Reply to sender"),ref:"io.ox/mail/actions/reply",drawDisabled:!0},"reply-all":{prio:"hi",mobile:"hi",icon:"fa fa-reply-all",title:a("Reply to all recipients"),ref:"io.ox/mail/actions/reply-all",drawDisabled:!0},forward:{prio:"hi",mobile:"hi",icon:"fa fa-mail-forward",title:a("Forward"),ref:"io.ox/mail/actions/forward",drawDisabled:!0},delete:{prio:"hi",mobile:"hi",icon:"fa fa-trash-o",title:a("Delete"),ref:"io.ox/mail/actions/delete",drawDisabled:!0},move:{prio:"hi",mobile:"lo",title:a("Move"),ref:"io.ox/mail/actions/move",section:"file-op",drawDisabled:!0},"mark-read":{prio:"hi",mobile:"lo",title:a("Mark as read"),ref:"io.ox/mail/actions/mark-read",section:"flags",drawDisabled:!0},"mark-unread":{prio:"hi",mobile:"lo",title:a("Mark as unread"),ref:"io.ox/mail/actions/mark-unread",section:"flags",drawDisabled:!0},copy:{prio:"hi",mobile:"lo",title:a("Copy"),ref:"io.ox/mail/actions/copy",section:"file-op"},archive:{prio:"hi",mobile:"lo",icon:"fa fa-archive",title:a.pgettext("verb","Archive")},spam:{prio:"hi",mobile:"lo",title:a("Mark as spam"),ref:"io.ox/mail/actions/spam"},nospam:{prio:"hi",mobile:"lo",title:a("Not spam"),ref:"io.ox/mail/actions/nospam"},flag:{prio:"hi",mobile:"lo",title:a("Flag"),ref:"io.ox/mail/actions/flag"},unflag:{prio:"hi",mobile:"lo",title:a("Unflag"),ref:"io.ox/mail/actions/unflag"},color:{prio:"hi",mobile:"lo",title:a("Set color..."),ref:"io.ox/mail/actions/triggerFlags"}},s={listView:"io.ox/mail/mobile/toolbar/listView",multiselect:"io.ox/mail/mobile/toolbar/listView/multiselect",threadView:"io.ox/mail/mobile/toolbar/threadView",detailView:"io.ox/mail/mobile/toolbar/detailView"};i.addAction(s.listView,r,["compose"]),i.addAction(s.multiselect,r,["compose","delete","forward","move","archive"]),i.addAction(s.threadView,r,["compose"]),i.addAction(s.detailView,r,["reply","reply-all","delete","forward","mark-read","mark-unread","spam","flag","unflag","nospam","copy","color"]),i.createToolbarExtensions(s);var l=_.debounce(function(t){if(t){var i=this.isThreaded(),n=o.resolve(t,i);0===n.length&&(i=!1),n=1===n.length?n[0]:n;var a=e.Baton({data:n,isThread:i,selection:t,app:this}),r=this.pages.getCurrentPage();r.navbar.setBaton(a),r.toolbar&&r.toolbar.setBaton(a),r.secondaryToolbar&&r.secondaryToolbar.setBaton(a)}},50);e.point(s.multiselect).extend({id:"update-button-states",index:1e4,draw:function(e){0===e.data.length?$("a.mobile-toolbar-action, .mobile-toolbar-action a",this).addClass("ui-disabled"):$("a.mobile-toolbar-action, .mobile-toolbar-action a",this).removeClass("ui-disabled")}}),e.point("io.ox/mail/mediator").extend({id:"toolbar-mobile",index:10100,setup:function(e){_.device("smartphone")&&(e.updateToolbar=l)}}),e.point("io.ox/mail/mediator").extend({id:"update-toolbar-mobile",index:10300,setup:function(t){_.device("smartphone")&&(t.updateToolbar(),t.listView.on("selection:change change selection:action",function(){var e=t.pages.getCurrentPage();"folderTree"!==e.name&&(e.toolbar&&e.toolbar.baton.threadMember||t.updateToolbar(t.listView.selection.get()))}),t.threadView.$el.on("showmail",function(){var i=e.Baton({threadMember:!0,data:t.threadView.mail,isThread:!1,app:t});t.pages.getPageObject("detailView").toolbar.setBaton(i)}))}}),e.point("io.ox/mail/mediator").extend({id:"change-mode-toolbar-mobile",index:10400,setup:function(e){_.device("smartphone")&&e.props.on("change:checkboxes",function(t,i){var o=e.pages.getCurrentPage();e.pages.toggleSecondaryToolbar(o.name,i)})}})}),define("io.ox/core/util",["io.ox/core/extensions","settings!io.ox/core","static/3rd.party/purify.min.js"],function(e,t,i){var o=ox.serverConfig.prefix||"/ajax",n=/(\S{30,})/g,a=/(\S{30})/g,r=/([^.,;:-=()]+[.,;:-=()])/,s=new RegExp("^"+o);e.point("io.ox/core/person").extend({id:"default",index:100,draw:function(e){!1!==e.html?this.append(e.html):this.text(e.halo.name)}});var l=/((https?|ftps?):\/\/[^\s"]+)/gim,d={replacePrefix:function(e,t){return e=e||"",t=t||"",e.replace(s,t)},renderPersonalName:function(t,i){var o={name:(t=_.extend({$el:void 0,html:!1,tagName:"span"},t)).full_name||t.display_name||t.name||t.cn||t.email,email:t.email,email1:t.email,user_id:t.user_id};t.contact&&(o.contact=t.contact),i&&i.nohalo&&(t.$el=$("<span>"));var n=new e.Baton({data:i||{},halo:o,html:t.html}),a=t.$el||(o.email||o.user_id?$('<a href="#" role="button" class="halo-link">').attr("title",o.email).data(o):$("<"+t.tagName+">"));return e.point("io.ox/core/person").invoke("draw",a.empty(),n),a},unescapeDisplayName:function(e){for(e=$.trim(e||"");e.length>1&&/^["'\\\s]/.test(e[0])&&e[0]===e.substr(-1);)e=$.trim(e.substr(1,e.length-2));return e=e.replace(/\\"/g,'"'),e=e.replace(/\\{2}/g,"\\")},fixUrlSuffix:function(e,t){return t=t||"",e=e.replace(/([.,;!?<>(){}[\]|]+)$/,function(e,i){return t=i+t,""}),{url:e,suffix:t}},removeQuotes:function(e){return $.trim(e).replace(/^["'\\]+|["'\\]+$/g,"").replace(/\\?"/g,"")},urlify:function(e){return e=(e||"").replace(l,function(e){var t=this.fixUrlSuffix(e);return $('<a target="_blank" rel="noopener">').attr("href",t.url).append(d.breakableHTML(t.url)).prop("outerHTML")+t.suffix}.bind(this)),e=i.sanitize(e,{ALLOW_DATA_ATTR:!1,ALLOWED_TAGS:["a","wbr"],ALLOWED_ATTR:["target","rel","href"],SAFE_FOR_JQUERY:!0}),e=d.injectAttribute(e,"a","rel","noopener")},injectAttribute:function(e,t,i,o){var n=document.createElement("div");return n.innerHTML=e,_(n.getElementsByTagName(t)).each(function(e){e.setAttribute(i,o)}),n.innerHTML},breakableHTML:function(e){var t=String(e||"").replace(n,function(e){return _(e.split(r)).map(function(e){return 0===e.length?"":e.length<30?e+"​":e.replace(a,"$1​")}).join("")});return _(t.split("​")).map(_.escape).join("<wbr>").replace(/\u00a0/g," <wbr>")},breakableText:function(e){var t=String(e||"").replace(/(\S{20})/g,"$1​");return"​"===t[t.length-1]&&(t=t.slice(0,-1)),t},isValidMailAddress:function(){function e(e){if(""===e)return!0;var d=e.lastIndexOf("@");if(d<=0)return!1;var c=e.substr(0,d),u=e.substr(d+1);return!(c.length>64&&c.length>0)&&(!(u.length>255)&&(!(!t.test(c)&&(i.test(c)||n.test(c)||a.test(c)||o.test(c)))&&!!(r.test(u)||s.test(u)||l.test(u))))}var t=/^"[^"]+"$/,i=/@/,o=/["\\,:; ]/,n=/^\./,a=/\.\./,r=/^\[(\d{1,3}\.){3}\d{1,3}\]$/,s=/^\[IPv6(:\w{0,4}){0,8}\]$/i,l=/[a-z0-9]$/i;return function(t){return e($.trim(t))}}(),isValidPhoneNumber:function(){function e(e){return""===e||!i.test(e)&&t.test(e)}var t=/^\+?[0-9 .,;\-/()*#]+$/,i=/^\+\d{0,2}$/;return function(t){return e($.trim(t))}}(),getDeepLink:function(e,t){var i,o="";return void 0===t.folder_id?i="&folder="+encodeURIComponent(t.id):(i="&folder="+encodeURIComponent(t.folder_id),o="&id="+(/^[\d/]+$/.test(t.id)?t.id:encodeURIComponent(t.id))),ox.abs+ox.root+"/#!&app="+e+i+o},getAddresses:function(e){return/^[^,;\s]+$/.test(e)?[e]:(String(e).match(/("[^"]+"|'[^']+'|\w[\w\u00C0-\u024F.!#$%&'*+-/=?^_`{|}~]*)@[^,;\x20\t\n]+|[\w\u00C0-\u024F][\w\u00C0-\u024F\-\x20]+\s<[^>]+>|("[^"]+"|'[^']+')\s<[^>]+>/g)||[]).map(function(e){return e.replace(/^([^"]+)\s</,'"$1" <')})},getShardingRoot:function(){function e(e){for(var t=e.length-1,i=0;t;t--)i+=e.charCodeAt(t);return i}var i=location.host+ox.apiRoot,o=[].concat(t.get("shardingSubdomains",i));return function(t){var n=0;return 0===t.indexOf("//"+i)&&(t=t.substr(i.length+2)),o.length>1&&(n=e(t)%o.length),/^\//.test(t)||(t="/"+t),ox.debug?"//"+i+t:"//"+o[n]+t}}(),getScrollBarWidth:_.memoize(function(){var e=$("<div>").css({visibility:"hidden",width:100,overflow:"scroll"}).appendTo("body"),t=$("<div>").css({width:"100%"}).appendTo(e).outerWidth();return e.remove(),100-t})};return d}),define("io.ox/core/api/factory",["io.ox/core/http","io.ox/core/cache","io.ox/core/event","io.ox/core/extensions","io.ox/core/api/backbone"],function(e,t,i,o,n){var a=function(e){var t=_.copy(e,!0);return t.folder=t.folder||t.folder_id,delete t.folder_id,t},r="id: folder_id:folder folder: recurrence_position:".split(" "),s=function(e){return _.isObject(e)?_(r).reduce(function(t,i){var o=i.split(":"),n=o[0],a=o[1]||o[0];return n in e&&(t[a]=e[n]),t},{}):e},l=function(o){(o=$.extend(!0,{id:null,keyGenerator:null,module:"",requests:{all:{action:"all",timezone:"utc"},list:{action:"list",timezone:"utc"},get:{action:"get",timezone:"utc"},search:{action:"search",timezone:"utc"},remove:{action:"delete"}},cid:function(e){return e.folder+"//"+(e.sortKey||e.sort)+"."+e.order+"."+(e.max||e.limit||0)},done:{},fail:{},pipe:{},params:{},filter:null},o||{})).id=o.id||o.module,_.each(o.requests,function(e){e.extendColumns&&(e.columns=l.extendColumns(e.extendColumns,o.module,e.columns),delete e.extendColumns)});var r={all:new t.SimpleCache(o.id+"-all"),list:new t.ObjectCache(o.id+"-list",!1,o.keyGenerator),get:new t.ObjectCache(o.id+"-get",!1,o.keyGenerator)},d={},c={},u={DELIM:"//",options:o,cid:o.cid,getAll:function(t,i,n,a){var s=$.extend({},o.requests.all,t||{}),l=o.cid(s);i=void 0===i||!!i,n=n||r.all;var p=function(){var t=o.params.all?o.params.all(_.copy(s,!0)):s;return e.GET({module:o.module,params:t,processResponse:void 0===a||a}).then(function(e){var i=$.when();return/(^5,|,5,|5$)/.test(t.columns)?$.when.apply($,_(e).map(function(e){var t=_.cid(e);return void 0===c[t]?(c[t]=e.last_modified,i):e.last_modified>c[t]?(c[t]=e.last_modified,$.when(u.caches.list.remove(t),u.caches.get.remove(t)).done(function(){u.trigger("update:"+_.ecid(e),e)})):void 0})).then(function(){return e}):e},function(e){throw u.trigger("error error:"+e.code,e),e}).then(function(e){return(o.pipe.all||_.identity)(e,s)}).then(function(e){return $.when(n.add(l,e)).then(function(){return e})})};return(i?n.get(l,p,function(){!1!==ox.serverConfig.persistence&&(l in d||(d[l]=!0,setTimeout(function(){u.refresh()},5e3)))}):p()).then(o.pipe.allPost).done(o.done.all||$.noop)},getList:function(t,i,n){t=t?[].concat(t):[],o.filter&&(t=_(t).filter(o.filter)),n=n||{},i=void 0===i||!!i;var a=function(){var i=_.extend({},o.requests.list);return n.allColumns&&(i.columns=e.getAllColumns(o.module,!0)),n.unseen&&(i.unseen=!0),e.fixList(t,e.PUT({module:o.module,params:i,data:e.simplify(t)})).then(function(e){return(o.pipe.list||_.identity)(e)}).then(function(e){var t=n.allColumns?"add":"merge";return $.when(r.list.add(e),r.get[t](e)).then(function(){return e})})};return 0===t.length?$.Deferred().resolve([]).done(o.done.list||$.noop):(i?r.list.get(t,a):a()).then(o.pipe.listPost).done(o.done.list||$.noop)},get:function(t,i){var n=$.extend({},o.requests.get,t),s=function(){return e.GET({module:o.module,params:a(n)}).then(function(e){return(o.pipe.get||_.identity)(e,n)},function(e){throw u.trigger("error error:"+e.code,e),e}).then(function(e){return i?$.when(r.get.add(e),r.list.merge(e).done(function(e){e&&u.trigger("refresh.list")})).then(function(){return e}):e}).fail(function(e){_.call(o.fail.get,e,n,o)})};return((i=void 0===i||!!i)?r.get.get(n,s,o.pipe.getCache):s()).then(o.pipe.getPost).done(o.done.get||$.noop)},localRemove:function(e,t,i){return _(e).filter(function(e){return!0!==t[i(e)]})},updateCaches:function(e,i){e=e||[],e=_.isArray(e)?e:[e];var o,n={},a={},r=t.defaultKeyGenerator;return _(e).each(function(e){n[r(e)]=a[e.folder_id]=!0}),e.length<100?(o=_(a).map(function(e,t){var i=u.caches.all;return i.grepKeys(t+"//").then(function(e){return $.when.apply($,_(e).map(function(e){return i.get(e).then(function(t){return t?("data"in t?t.data=u.localRemove(t.data,n,r):t=u.localRemove(t,n,r),i.add(e,t)):$.when()})}))})}),e.length&&(o.push(u.caches.list.remove(e)),o.push(u.caches.get.remove(e)))):(o=[u.caches.all.clear()],e.length&&(o.push(u.caches.list.clear()),o.push(u.caches.get.clear()))),u.resetTrashFolders&&o.push(u.resetTrashFolders()),$.when.apply($,o).done(function(){i||_(e).each(function(e){u.trigger("delete:"+_.ecid(e))}),n=a=o=e=null})},remove:function(t,i){t=t||[],t=_.isArray(t)?t:[t],i=_.extend({local:!1,force:!1},i||{});var n=$.extend({},o.requests.remove,{timestamp:_.then()}),a=e.simplify(t);i.force&&(n.harddelete=!0);var r=function(e){var i={};return _(t).each(function(e){i[e.folder_id]=e.folder_id}),$.when.apply($,_(i).map(function(e){return u.caches.all.grepRemove(e+"//")})).then(function(){return $.Deferred()[e.error?"reject":"resolve"](e)})},s=function(){u.trigger("refresh.all"),u.trigger("delete",t)};return u.trigger("beforedelete",t),u.updateCaches(t).then(function(){return u.trigger("refresh:all:local"),!0!==i.local?e.PUT({module:o.module,params:n,data:a,appendColumns:!1}).then(r,r).always(s):s()})},needsRefresh:function(e,t,i){return r.all.keys(e+"//"+t+"."+i).then(function(e){return null!==e})},reduce:s,caches:r};return o.requests.search&&(u.search=function(t,i){var n=$.extend({},o.requests.search,i||{}),a=n.getData;return i=i||{},o.requests.search.omitFolder&&!1!==i.omitFolder&&delete n.folder,delete n.omitFolder,delete n.getData,e.PUT({module:o.module,params:n,data:a(t,i)}).then(function(e){return(o.pipe.search||_.identity)(e)})}),o.requests.advancedsearch&&(u.advancedsearch=function(t,i){var n=$.extend({},o.requests.advancedsearch,i||{}),a=n.getData;return i=i||{},o.requests.advancedsearch.omitFolder&&!1!==i.omitFolder&&delete n.folder,delete n.omitFolder,delete n.getData,e.PUT({module:o.module,params:n,data:a(t,i)}).then(function(e){return e})}),i.extend(u),u.refresh=function(){return ox.online?$.when(u.caches.all.clear(),u.caches.list.clear()).done(function(){u.trigger("refresh.all")}):$.when()},ox.on("refresh^",function(){u.refresh()}),u.Model=n.Model,u.Collection=n.Collection,u};return l.reduce=s,l.extendColumns=function(t,i,n){var a={},r={},s=e.getColumnMapping(i);return _.each(s,function(e,t){r[e]=t}),_.each(n.split(","),function(e){a[e]=1}),_.chain(o.point(t).invoke("columns")).flatten(!0).each(function(e){a[r[e]||e]=1}),_.keys(a).join()},l}),define("io.ox/core/api/collection-pool",["io.ox/core/api/backbone"],function(e){function t(e,t){if(!s&&!l)try{_(r[e]).each(function(e){var i=e.collection.get(t.cid);i&&(i.preserve=t.preserve,s=!0,e.collection.remove(i))})}catch(e){ox.debug&&console.warn("error in collection pool propagateRemove",e)}finally{s=!1}}function i(e,t){if(!s)try{_(r[e]).each(function(e){var i,o=t.changed.cid?t.previous("cid"):t.cid,n=e.collection.get(o);n&&(s=!0,delete(i=t.toJSON()).index,n.set(i))})}catch(e){ox.debug&&console.warn("error in collection pool propagateChange",e)}finally{s=!1}}function o(e){var t={};_(e).each(function(i,o){"detail"!==o&&0!==o.indexOf("search")&&(i.collection.expired?(i.collection.reset(),delete e[o]):i.collection.each(function(e){t[e.cid]=!0,_(this.getDependentModels(e.cid)).each(function(e){t[e.cid]=!0})},this))},this);var i=this.get("detail").filter(function(e){return void 0===e["index/virtual/favorites/infostore"]&&(void 0===e["index/virtual/favoriteFiles/infostore"]&&!t[e.cid])});this.get("detail").remove(i,{silent:!0}),i=t=null,_(e).each(function(e,t){"detail"!==t&&!1!==e.collection.gc&&e.collection.expire()})}function n(n,a){var s=r[n]||(r[n]={});a=a||{},this.Collection=a.Collection||d,this.Model=a.Model||e.Model,this.getCollections=function(){return s},this.get=function(e){var o=s[e];if(o)return o.access=_.now(),o.collection;var a=new this.Collection;return s[e]={access:_.now(),collection:a},a.expired=!1,a.complete=!1,a.sorted=!0,a.expire=function(){this.expired=!0,this.trigger("expire")},a.setComplete=function(e){e!==this.complete&&(this.complete=e,this.trigger("complete",e))},a.cid=e,a.on({remove:t.bind(this,n),change:i.bind(this,n)})},this.getModule=function(){return n},this.gc=function(){o.call(this,s)},ox.on("refresh^",_.throttle(o.bind(this,s),5e3))}var a={},r={},s=!1,l=!1,d=e.Collection.extend({_removeModels:function(t,i){return t=_(t).filter(function(e){return!0!==e.preserve}),e.Collection.prototype._removeModels.call(this,t,i)}});return n.create=function(e,t){return a[e]||(a[e]=new n(e,t))},n.inspect=function(){_(a).each(function(e,t){var i=0,o=e.getCollections();_(o).each(function(e){i+=_(e.collection).size()}),console.debug("Pool:",t,"Model count:",i,"Collections:",o)})},n.preserve=function(e){l=!0,e&&e(),l=!1},_.extend(n.prototype,{getDefault:function(){return new this.Collection},propagate:function(e,t){"change"===e&&i.call(this,this.getModule(),new this.Model(t))},map:_.identity,add:function(e,t){1===arguments.length&&(t=e,e="detail");var i=this.get(e);return t=_([].concat(t)).map(this.map,i),i.add(t,{merge:!0,parse:!0}),i},resolve:function(e){var t=this.get("detail"),i=this.Model;return _([].concat(e)).map(function(e){return e instanceof i?e:t.get(_.cid(e))||{}})},getDetailModel:function(e){var t,i=_.cid(e),o=this.get("detail");return(t=o.get(i))?t:(t=new this.Model(e),void 0!==e.folder_id&&void 0===e.parent&&o.add(t),t)},grep:function(){function e(e,t){return e&&this.indexOf(t)>-1}var t=arguments;return _(this.getCollections()).chain().filter(function(i,o){return _(t).reduce(e.bind(o),!0)}).pluck("collection").value()},getByFolder:function(e){return this.grep("folder="+e+"&")},getBySorting:function(e,t){return this.grep("folder="+t+"&","sort="+e)},getDependentModels:function(){return[]},resetFolder:function(e){var t=this,i=_([].concat(e)).chain().map(function(e){return t.getByFolder(e)}).flatten().uniq();return i.invoke("expire"),i},preserveModel:function(e,t){_(this.getCollections()).each(function(i){var o=i.collection.get(e);o&&(o.preserve=!!t)})}}),n}),define("io.ox/core/api/collection-loader",["io.ox/core/api/collection-pool","io.ox/core/http"],function(e,t){function i(e){var t={};return _(e).each(function(e){t[e]=!0}),t}function o(t){function o(t,i,o,n,a){var s="load"===i?n.PRIMARY_PAGE_SIZE:n.SECONDARY_PAGE_SIZE;if("paginate"===i&&t.length>0){var l=_(a).first(),d=t.last().toJSON();if(d&&d.head&&(d=d.head),l&&l.head&&(l=l.head),_.cid(l)!==_.cid(d))return ox.debug&&console.warn("paginate compare fail",_.cid(l),_.cid(d),a),o.thread="threadedAll"===o.action,void n.reload(o,s)}e.preserve(function(){var e=r[i];t.preserve&&"reload"===i?t[e](a,{parse:!0,add:!0,remove:!1,sort:!1}):t[e](a,{parse:!0})}),"load"===i?t.setComplete(a.length<s):"paginate"===i&&t.setComplete(a.length<=1),t.trigger(i)}function n(e,t,i){e.trigger(t+":fail",i)}function a(e,t){var i="paginate"===t?Math.max(this.collection.length-1,0):0;this.collection.trigger("before:"+t);var a=_.lfo(o,this.collection,t,e,this),r=_.lfo(n,this.collection,t),s=this;return this.fetch(e).done(function(t){s.addIndex(i,e,t),s.done(),a(t)}).fail(function(e){s.done(),r(e),s.fail(e)})}_.extend(this,{columns:"1,20",module:"mail",ignore:"limit max"},t),this.pool=e.create(this.module),this.ignore=i(String(this.ignore).split(" ")),this.collection=null,this.loading=!1,this.load=function(e){var t;if(!1!==(e=this.getQueryParams(e||{}))){if(e.limit="0,"+this.PRIMARY_PAGE_SIZE,t=this.collection=this.getCollection(e),this.loading=!1,this.isBad(e.folder)||(t.length>0||t.complete)&&!t.expired&&t.sorted&&!t.preserve){var i=t.CUSTOM_PAGE_SIZE||this.PRIMARY_PAGE_SIZE;return t.length>i&&(t.reset(t.first(i),{silent:!0}),t.complete=!1),_.defer(function(){t.trigger(t.complete?"reset load cache complete":"reset load cache")}),t}return this.loading=!0,_.defer(a.bind(this),e,"load"),t}},this.paginate=function(e){var t=this.collection;if(this.loading)return t;var i=Math.max(0,t.length-1);return e=this.getQueryParams(_.extend({offset:i},e)),this.isBad(e.folder)?t:(e.limit=i+","+(t.length+this.SECONDARY_PAGE_SIZE),this.loading=!0,_.defer(a.bind(this),e,"paginate"),t)},this.reload=function(e,t){var i=this.collection;if(this.loading)return i;if(e=this.getQueryParams(_.extend({offset:0},e)),this.isBad(e.folder))return i;var o=Math.ceil((i.length-this.PRIMARY_PAGE_SIZE)/this.SECONDARY_PAGE_SIZE)*this.SECONDARY_PAGE_SIZE+this.PRIMARY_PAGE_SIZE,n=Math.max(i.length+(t||0),o);return e.limit="0,"+(0===n?this.PRIMARY_PAGE_SIZE:n),this.loading=!0,_.defer(a.bind(this),e,"reload"),i}}function n(e){return!this.ignore[e]}function a(e){var t=this[e];return e+"="+(_.isString(t)?t:JSON.stringify(t))}var r={load:"reset",paginate:"add",reload:"set"};return _.extend(o.prototype,{PRIMARY_PAGE_SIZE:50,SECONDARY_PAGE_SIZE:200,cid:function(e){return _(e||{}).chain().keys().filter(n,this).map(a,e).value().sort().join("&")||"default"},getDefaultCollection:function(){return this.pool.getDefault()},getCollection:function(e){var t=this.cid(e);return this.pool.get(t)},before:function(){},each:function(){},after:function(){},addIndex:function(e,t,i){this.before(e,t,i),_(i).each(function(i,o){i.index=e+o,this.each(i,o,e,t)},this),this.after(e,t,i)},noSelect:function(){return!1},virtual:function(){return!1},isBad:function(e){return!e&&0!==e},fetch:function(e){var i=this.module,o=i+"/"+_.cacheKey(_.extend({session:ox.session},e)),n=ox.rampup[o],a=this.noSelect(e),r=this.virtual(e),s=this;return n?(delete ox.rampup[o],$.when(n)):a?$.when([]):r?$.when(r):t.wait().then(function(){return s.httpGet(i,e).then(function(t){return s.filter&&(t=_(t).filter(s.filter)),s.useSlice?Array.prototype.slice.apply(t,e.limit.split(",")):t})})},httpGet:function(e,i){return this.useSlice&&(i=_(i).omit("limit")),t.GET({module:e,params:i})},getQueryParams:function(){return{}},done:function(){this.loading=!1},fail:function(){}}),o}),define("io.ox/mail/common-extensions",["io.ox/core/extensions","io.ox/mail/util","io.ox/mail/api","io.ox/core/api/account","io.ox/core/strings","io.ox/core/folder/api","io.ox/core/folder/title","io.ox/core/notifications","io.ox/contacts/api","io.ox/contacts/util","io.ox/core/api/user","io.ox/core/api/collection-pool","io.ox/core/tk/flag-picker","io.ox/core/capabilities","io.ox/backbone/views/toolbar","settings!io.ox/mail","io.ox/core/attachments/view","io.ox/backbone/views/action-dropdown","io.ox/backbone/views/actions/util","gettext!io.ox/mail"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f,h,g,m,v,x,b){function w(e){if(e.app&&e.app.listView&&e.app.listView.loader)return"search"===e.app.listView.loader.mode}function y(e,i,n){var a=n.data.thread?n.data.thread[0]||n.data:n.data,r=t.authenticity("image",a),s=o.is("spam",n.data.folder_id);if(r||s)return e.text("!");var d=k(n.data.from);e.text(d);var c=_.isArray(i)?i&&i[0]&&i[0][1]:i;return l.pictureHalo(e,{email:c},{width:40,height:40,effect:"fadeIn",fallback:!1})}function k(e){if(!_.isArray(e)||!e.length)return"";var i=t.getDisplayName(e[0]);return d.getInitials({display_name:i})}var C={a11yLabel:function(e){var o,n=e.data,a=i.threads.size(n),r=n.from||[["",""]],s=[];t.isUnseen(n)&&s.push(b("Unread")),t.isFlagged(n)&&s.push(b("Flagged")),e.data.color_label&&g.get("features/flag/color")&&s.push(b("Color %1$s",p.colorName(e.data.color_label))),s.push(t.getDisplayName(r[0]),n.subject,t.getTime(n.received_date)),a>1&&s.push(b.format("Thread contains %1$d messages",a)),n.attachment&&s.push(b("has attachments")),o=s.join(", ")+".",this.attr({"aria-hidden":!0}).parent().attr({"aria-label":o.replace(/["<]/g,function(e){return'"'===e?"&quot":"<"===e?"&lt;":e})})},authenticity:function(e){var i=t.authenticity("box",e&&e.model.toJSON());if(i){var o=$('<section class="authenticity">'),n=e.data.from||[],a=_.chain(n).map(function(e){return String(e[1]||"").toLowerCase()}).compact().value().join(", ");o.append($("<div>").addClass("message "+i.toLowerCase()).append($("<b>").text(/(fail|suspicious)/.test(i)?b("Warning:")+" ":b("Note:")+" "),$.txt(t.getAuthenticityMessage(i,a)))),this.append(o)}},picture:function(e){var t=e.data,n=i.threads.size(t)<=1&&!w(e)&&o.is("sent|drafts",t.folder_id)?t.to:t.from,a=$('<div class="contact-picture" aria-hidden="true">');this.append(w(e)&&t.picture?y(a,t.picture):y(a,n,e))},senderPicture:function(e){var t=e.data.from,i=$('<div class="contact-picture" aria-hidden="true">');this.append(y(i,t,e))},date:function(e,i){var o=e.data.received_date;i=_.extend({fulldate:e.app&&e.app.props.get("exactDates"),smart:!(e.app&&e.app.props.get("exactDates"))},i),_.isNumber(o)&&this.append($('<time class="date gray">').attr("datetime",moment(o).toISOString()).text(t.getDateTime(o,i)))},smartdate:function(e){C.date.call(this,e,{fulldate:!1,smart:!0})},fulldate:function(e){C.date.call(this,e,{fulldate:!0,smart:!1})},from:function(e){var i={folder:e.data.folder_id,field:"from",showDisplayName:!0};_.each(C.fromPipeline,function(t){t.call(this,e,i)}),this.append($('<div class="from">').attr("title",i.mailAddress).append($('<span class="flags">'),t.getFrom(e.data,_.pick(i,"field","reorderDisplayName","showDisplayName","unescapeDisplayName"))))},fromDetail:function(e){var i=$('<div class="from">'),n=e.data,a=n.from||[],r=a.length,s=t.authenticity("icon",n);_(a).each(function(e){var a,l=String(e[1]||"").toLowerCase(),d=t.getDisplayName(e);if(l){i.addClass(r>1||_.device("smartphone")?"no-max-height":"").append(a=$('<a href="#" role="button" class="halo-link">').data({email:l,email1:l}).append($('<span class="sr-only">').text(b("From:"))).append($('<span class="person-link person-from ellipsis">').text(d)).addClass(d===l&&s?"authenticity-sender "+s:""));var c=_.device("smartphone")&&!!d&&("pass"===s||o.is("sent",n.folder_id));d!==l&&!c&&a.append($('<span class="address">').text("<"+l+">").addClass(s?"authenticity-sender "+s:"")),s&&a.append($('<span data-toggle="popover" data-container="body" class="authenticity">').attr("aria-label",t.getAuthenticityMessage(s,l)).popover({placement:_.device("smartphone")?"auto":"right",trigger:"focus hover",content:t.getAuthenticityMessage(s,l)}).append($('<i class="fa" aria-hidden="true">').addClass(function(){return/(pass|trusted)/.test(s)?"fa-check":/(fail|suspicious)/.test(s)?"fa-exclamation-triangle":"fa-question"}).addClass(s?"authenticity-icon-"+s:""))),_.device("smartphone")&&d.indexOf("@")>-1&&i.addClass("show-address")}}),i.append('<div class="spacer">'),this.append(i)},fromPipeline:{field:function(e,t){e.data.threadSize>1||o.is("sent|drafts",t.folder)&&(t.field="to")},fieldSearch:function(e,t){if(w(e)){var i=e.app&&e.app.get("find");t.field=i&&o.is("sent|drafts",i.getFolderFacetValue())?"to":"from"}},displayName:function(e,t){if(t.reorderDisplayName=t.unescapeDisplayName="from-to"!==e.options.sort,"from-to"===e.options.sort){var i=a.pool.getModel(t.folder).get("capabilities")||0;t.showDisplayName=!!(4096&i)}},address:function(e,i){i.mailAddress=t.getFrom(e.data,{field:i.field,showDisplayName:!1}).text()}},size:function(e){if(!e.app||608===e.app.props.get("sort")||e.app.props.get("alwaysShowSize")){var i=e.data;if(_.isNumber(i.size)){var o=t.threadFileSize(i.thread||[i]);this.append($('<span class="size">').text(n.fileSize(o,1)))}}},unreadClass:function(e){var i=t.isUnseen(e.data);this.closest(".list-item").toggleClass("unread",i)},deleted:function(e){this.parent().toggleClass("deleted",t.isDeleted(e.data))},colorflag:function(e){if(g.get("features/flag/color")){var t=e.data.color_label,i="fa-bookmark";t<=0||((e.app&&e.app.isThreaded()||e.options.threaded)&&e.data.thread&&t!==e.data.thread[0].color_label&&(i="fa-bookmark-o",t=0),this.append($('<i class="color-flag fa" aria-hidden="true">').addClass(i).addClass(t>0?"flag_"+t:"multiple-colors")))}},flag:function(e){g.get("features/flag/star")&&t.isFlagged(e.data)&&this.append($('<span class="flag">').append(C.flagIcon.call(this).attr("title",b("Flagged"))))},flagIcon:function(){return $('<i class="fa" aria-hidden="true">')},flaggedClass:function(e){g.get("features/flag/star")&&this.closest(".list-item").toggleClass("flagged",t.isFlagged(e.data))},flagToggle:function(){function e(e,i,o){var n=b(t.isFlagged(e)?"Flagged":"Not flagged");$(o).attr("aria-label",n).find(".fa").attr("title",n)}function o(e){e.preventDefault();var o=e.data.model.toJSON();t.isFlagged(o)?i.flag(o,!1):i.flag(o,!0)}function n(t,i){var o=t.$("a.flag.io-ox-action-link");e(i.toJSON(),void 0,o)}return function(i){if(g.get("features/flag/star")&&!t.isEmbedded(i.data)){var r=this;i.view.listenTo(i.view.model,"change:flags",_.partial(n,i.view)),a.get(i.data.folder_id).done(function(t){a.can("write",t)&&!a.is("unifiedfolder",t)&&r.append($('<a href="#" role="button" class="flag io-ox-action-link" data-action="flag">').append(C.flagIcon.call(this)).each(_.partial(e,i.data)).on("click",{model:i.view.model},o))})}}}(),threadSize:function(e){if(e.app&&e.app.isThreaded()||e.options.threaded){var t=i.threads.size(e.data);t<=1||this.append($('<div class="thread-size" aria-hidden="true">').append($('<span class="number drag-count">').text(t)))}},paperClip:function(e){e.data.attachment&&this.append($('<i class="fa fa-paperclip has-attachments" aria-hidden="true">'))},sharedAttachement:function(e){e.model&&_.has(e.model.get("headers"),"X-Open-Xchange-Share-URL")&&this.append($('<i class="fa fa-cloud-download is-shared-attachement" aria-hidden="true">'))},pgp:{encrypted:function(e){(/^multipart\/encrypted/.test(e.data.content_type)||e.model.get("security")&&e.model.get("security").decrypted)&&this.append($('<i class="fa fa-lock encrypted" aria-hidden="true">'))},signed:function(e){(/^multipart\/signed/.test(e.data.content_type)||e.model.get("security")&&e.model.get("security").signatures)&&this.append($('<i class="fa fa-pencil-square-o signed" aria-hidden="true">'))}},priority:function(e){var i=t.getPriority(e.data);i.length&&this.append($('<span class="priority" aria-hidden="true">').append(i))},envelope:function(){return $('<i class="fa seen-unseen-indicator" aria-hidden="true">').appendTo(this)},unread:function(e){t.isUnseen(e.data)&&C.envelope.call(this).attr("title",b("Unread"))},answered:function(e){var o=e.data,n=_.cid(o),a=i.threads.get(n);t.isAnswered(a,o)&&this.append('<i class="icon-answered fa fa-reply" aria-hidden="true">')},forwarded:function(e){var o=e.data,n=_.cid(o),a=i.threads.get(n);t.isForwarded(a,o)&&this.append('<i class="icon-forwarded fa fa-mail-forward" aria-hidden="true">')},subject:function(e){var i=e.data,o=1===e.data.threadSize,n=t.getSubject(i,o);this.append($('<div class="subject" role="presentation">').append($('<span class="flags" role="presentation">'),$('<span class="drag-title" role="presentation">').text(n).attr("title",n)))},title:function(e){var i=t.getSubject(e.data);this.closest(".list-item").attr("title",i)},account:function(e){o.isUnifiedFolder(e.data.folder_id)&&this.append($('<span class="account-name">').text(e.data.account_name||""))},empty:function(){this.attr("role","option").text(b("Empty"))},folder:function(e){if(e.data.original_folder_id){var t=e.app&&e.app.folder&&"virtual/all-unseen"===e.app.folder.get();(w(e)||t)&&this.append($('<span class="original-folder">').append(a.getTextNode(e.data.original_folder_id)))}},recipients:function(){var e=function(e){e.preventDefault(),$(this).parent().children().show(),$(this).hide()};return function(i){var o=i.data,n=o.cc&&o.cc.length>0,a=o.to&&o.to.length>0,r=o.bcc&&o.bcc.length>0,s=a||n||r,l=$('<div class="recipients">');if(s){a&&l.append($('<span class="io-ox-label">').append($.txt(b("To")),$.txt("  ")),t.serializeList(o,"to"),$.txt("   ")),n&&l.append($('<span class="io-ox-label">').append($.txt(b.pgettext("CC","Copy")),"  "),t.serializeList(o,"cc"),$.txt("   ")),r&&l.append($('<span class="io-ox-label">').append($.txt(b("Blind copy")),"  "),t.serializeList(o,"bcc"),$.txt("   ")),this.append(l);var d=l.find(".person-link");d.length>3&&(l.children().slice(4).hide(),l.append($('<a role="button" href="#" class="show-all-recipients">').text(b("and %1$d others",d.length-2)).on("click",e)))}else this.append(l.append($.txt(" ")))}}(),attachmentList:function(){var t,o=function(){var e,t,o=this.model.toJSON();new v({backdrop:!0,caret:!1,data:o,el:this.$(".file"),point:"io.ox/mail/attachment/links",title:this.model.getShortTitle(),list:this.model.collection.toJSON()}),e=i.getUrl(o,"download"),t=(this.model.get("content_type")||"unknown").split(/;/)[0],this.$el.attr({title:this.model.getTitle(),draggable:!0,"data-downloadurl":t+":"+this.model.getTitle().replace(/:/g,"")+":"+ox.abs+e}).on("dragstart",function(e){$(this).css({display:"inline-block"}),e.originalEvent.dataTransfer.setData("DownloadURL",this.dataset.downloadurl)}),t&&!/^image\//.test(t)&&this.$el.addClass("no-image")};return function(i){if(0===i.attachments.length)return $.when();(i.model?i.model.get("headers"):i.data.headers||{})["X-Open-Xchange-Share-Type"]&&this.hide();var n=this;_.once(function(){t=m.View.extend({renderContent:o})})();var a=i.attachments.map(function(e){return e.group="mail",e}),r=new m.Collection(a),s=!!n.data("view"),l=n.data("view")||new m.List({AttachmentView:t,collection:r,el:n,mode:g.get("attachments/layout/detail/"+_.display(),"list")});l.openByDefault=g.get("attachments/layout/detail/open",l.openByDefault),l.$header.empty(),l.render();var d=new h({el:l.$header.find(".links")[0],inline:!0,simple:!0,dropdown:!1,strict:!1,point:"io.ox/mail/attachment/links"});return l.renderInlineLinks=function(){var e=this.getValidModels();e.length&&d.setSelection(_(e).pluck("id"),{data:_(e).invoke("toJSON")})},l.listenTo(l.collection,"add remove reset",l.renderInlineLinks),l.listenTo(i.model,"change:imipMail",l.renderInlineLinks),l.renderInlineLinks(),s||(l.$el.on("click","li.item",function(t){var i,o,n,s=$(t.currentTarget),l=$(t.target);l.hasClass("dropdown-toggle")||(i=s.attr("data-id"),o=r.get(i).toJSON(),i=s.attr("data-id"),o=r.get(i).toJSON(),n=e.Baton({simple:!0,data:o,list:a,restoreFocus:l,openedBy:"io.ox/mail/details"}),x.invoke("io.ox/mail/attachment/actions/view",n))}),l.on("change:layout",function(e){g.set("attachments/layout/detail/"+_.display(),e).save()})),l.$el.find('[role="toolbar"]').find('a[role="menuitem"]').attr("role","button"),l}}(),flagPicker:function(e){g.get("features/flag/color")&&p.draw(this,e)},unreadToggle:function(){function e(e,i,o){var n=b(t.isUnseen(e)?"Mark as read":"Mark as unread");$(o).attr({"aria-label":n}).find(".fa").attr("title",n)}function o(e){e.preventDefault();var o=e.data.model.toJSON();t.isUnseen(o)?i.markRead(o):i.markUnread(o)}function n(t,i){var o=t.$("a.unread-toggle");e(i.toJSON(),void 0,o)}return function(i){if(!t.isEmbedded(i.data)){var r=this;i.view.listenTo(i.view.model,"change:flags",_.partial(n,i.view)),a.get(i.data.folder_id).done(function(t){(a.can("write",t)||a.is("unifiedfolder",t))&&r.append($('<a href="#" role="button" class="unread-toggle io-ox-action-link" data-action="unread-toggle">').append('<i class="fa" aria-hidden="true">').each(_.partial(e,i.data)).on("click",{model:i.view.model},o))})}}}(),disabledLinks:function(){function e(e,t,i){e.options.disable=e.options.disable||{};var o=e.options.disable[t];_.isString(o)&&(e.options.disable[t]=[].concat(o)),e.options.disable[t]=(e.options.disable[t]||[]).concat(i)}function i(t){t.preventDefault();var i=t.data.view;i.trigger("load"),i.$el.find(".disabled-links").remove(),e(i,"io.ox/mail/detail/source","disable-links"),e(i,"io.ox/mail/detail/content-general","disable-links"),e(i,"io.ox/mail/detail/notifications","disabled-links"),i.redraw()}function o(){this.append($('<div class="notification-item disabled-links">').append($('<button type="button" class="btn btn-default btn-sm">').text(b("Enable Links")),$('<div class="comment">').text(b("Links have been disabled to protect you against potential spam!")),$('<button type="button" class="close">').attr("title",b("Close")).append('<i class="fa fa-times" aria-hidden="true">')))}return function(e){t.authenticity("block",e.data)&&!t.isMalicious(e.data)&&(o.call(this,e.model),this.on("click",".disabled-links > .btn-default",{view:e.view},i),this.on("click",".disabled-links > .close",function(e){$(e.target).closest(".disabled-links").remove()}))}}(),externalImages:function(){function t(e){e.preventDefault();var t=e.data.view;return t.trigger("load"),t.$el.find(".external-images").remove(),i.getUnmodified(t.model.pick("id","folder","folder_id","parent","security")).done(function(e){t.trigger("load:done"),t.model.set(e)}),!1}function o(e){if(1!==e.get("modified"))return this.find(".external-images").remove();this.append($('<div class="notification-item external-images">').append($('<button type="button" class="btn btn-default btn-sm">').text(b("Show images")),$('<div class="comment">').text(b("External images have been blocked to protect you against potential spam!")),$('<button type="button" class="close">').attr("title",b("Close")).append('<i class="fa fa-times" aria-hidden="true">')))}return function(i){o.call(this,i.model),this.on("click",".external-images > .btn-default",{view:i.view},function(o){e.point("io.ox/mail/externalImages").cascade(this,i).then(function(){t(o)})}),this.on("click",".external-images > .close",function(e){$(e.target).closest(".external-images").remove()}),i.view.listenTo(i.model,"change:modified",o.bind(this))}}(),phishing:function(){function e(e){this.find(".phishing").length||_(e.get("headers")).find(function(e,i){if(t.contains(i))return this.append($('<div class="alert alert-error phishing">').text(b("Warning: This message might be a phishing or scam mail"))),!0},this)}var t=_(g.get("phishing/headers",["phishing-test"]));return function(t){e.call(this,t.model),t.view.listenTo(t.model,"change:headers",e.bind(this))}}(),plainTextFallback:function(){function e(e){this.find(".warnings").length||e.get("warnings")&&this.append($('<div class="alert alert-error warnings">').text(e.get("warnings").error))}return function(t){e.call(this,t.model),t.view.listenTo(t.model,"change:warnings",e.bind(this))}}(),dispositionNotification:function(){function e(e){e.preventDefault();var t=e.data.view,o=_.cid(t.model.cid);t.model.set("disp_notification_to",""),r[t.model.cid]=!0,i.ack({folder:o.folder_id,id:o.id}).done(function(){s.yell("success",b("A read receipt has been sent"))})}function n(e){e.preventDefault();var t=e.data.view;r[t.model.cid]=!0}function a(e){this.find(".disposition-notification").remove(),r[e.cid]||t.hasUnsendReadReceipt(e.toJSON())&&g.get("sendDispositionNotification",!1)&&(o.is("drafts",e.get("folder_id"))||this.append($('<div class="alert alert-info disposition-notification notification-item">').append($('<button type="button" class="btn btn-primary btn-sm">').text(b("Send a read receipt")),$('<div class="comment">').text(b("The sender wants to get notified when you have read this email")),$('<button type="button" class="close" data-dismiss="alert">').attr("title",b("Close")).append('<i class="fa fa-times" aria-hidden="true">'))))}var r={};return function(t){a.call(this,t.model),this.on("click",".disposition-notification .btn",{view:t.view},e),this.on("click",".disposition-notification .close",{view:t.view},n),t.view.listenTo(t.model,"change:disp_notification_to",a.bind(this))}}()};return C}),define("io.ox/core/tk/list",["io.ox/backbone/views/disposable","io.ox/backbone/mini-views/contextmenu-utils","io.ox/core/tk/list-selection","io.ox/core/tk/list-dnd","io.ox/core/extensions"],function(e,t,i,o,n){function a(){return $.when()}var r={13:"enter",27:"escape",32:"space",37:"cursor:left",38:"cursor:up",39:"cursor:right",40:"cursor:down"};return e.extend({tagName:"ul",className:"list-view",scaffold:$('<li class="list-item"><div class="list-item-checkmark"><i class="fa fa-checkmark" aria-hidden="true"></i></div><div class="list-item-content"></div><div class="list-item-swipe-conent"></div></li>'),busyIndicator:$('<li class="busy-indicator" role="presentation"><i class="fa fa-chevron-down" aria-hidden="true"></i></li>'),notification:$('<li class="abs notification hidden" role="presentation"></li>'),pullToRefreshIndicator:$('<div class="pull-to-refresh" style="transform: translate3d(0, -70px,0)"><div class="spinner slight-drop-shadow" style="opacity: 1"><i id="ptr-spinner" class="fa fa-refresh" aria-hidden="true"></i></div></div>'),onItemFocus:function(){this.toggleFocus(!0)},onItemBlur:function(){this.mousedown||this.toggleFocus(!1)},onKeepFocus:function(e){e.target===this.el&&e.pageX&&this.restoreFocus()},onContextMenu:function(){},restoreFocus:function(e){var t=this.getItems(),i=t.filter(".selected");0!==i.length?1===i.length?i.focus():1===i.filter(document.activeElement).length?i.filter(document.activeElement).focus():i.last().focus():e&&this.selection.select(0,t)},onItemKeydown:function(e){r[e.which]&&this.trigger(r[e.which],e),t.macOSKeyboardHandler(e),e.isKeyboardEvent&&this.onContextMenu(e)},onScroll:_.throttle(function(){if(!this.disposed&&!this.isBusy&&this.loader.collection&&!this.collection.complete&&this.$el.is(":visible")){var e=this.$el.outerHeight();(this.el.scrollTop+e)/this.el.scrollHeight<.8||(this.addBusyIndicator(),this.processPaginate())}},20),onLoad:function(){this.idle(),this.isComplete()||this.onScroll()},onComplete:function(e){this.toggleComplete(!1!==e)},processPaginate:function(){!this.options.pagination||this.isBusy||this.isComplete()||this.paginate()},getCompositeKey:function(e){return e.isFolder&&e.isFolder()?"folder."+e.get("id"):e.cid},onModelChange:function(){this.load()},empty:function(){this.idle(),this.toggleComplete(!1),this.getItems().remove(),delete this.currentLabel,this.$(".list-item-label").remove(),this.selection&&this.selection.reset(),this.$el.scrollTop(0)},renderNotification:function(e){var t=n.Baton({app:this.app,options:this.options,listView:this}),i=n.point(this.ref+"/notification/"+e),o=!this.collection.length,a=this.$(".notification").attr("role","error"===e?"alert":"presentation").empty();o&&i.keys().length&&i.invoke("draw",a,t),a.toggleClass("hidden",!o)},renderEmpty:function(){this.renderNotification("empty")},renderError:function(){this.idle(),this.renderNotification("error")},onReset:function(){var e=this;this.empty(),this.collection.each(function(t){e.$el.append(e.renderListItem(t,!0))}),this.trigger("reset",this.collection,this.firstReset),this.firstReset&&(this.trigger("first-reset",this.collection),this.firstReset=!1),this.firstContent&&this.collection.length&&(this.trigger("first-content",this.collection),this.firstContent=!1),this.trigger("listview:reset")},onAdd:function(e){this.queue.add(e).render()},lastElementOfLabel:function(e){var t=e.prev(),i=e.next(),o=e.attr("data-label");return t.attr("data-label")!==o&&i.attr("data-label")!==o},onRemove:function(e){var t=this.getItems(),i=this.getCompositeKey(e),o=t.filter('[data-cid="'+$.escape(i)+'"]'),n=o.hasClass("selected");0!==o.length&&(o[0].offsetTop<this.el.scrollTop&&(this.el.scrollTop-=o.outerHeight(!0)),this.selection&&this.selection.remove(i,o),this.options.labels&&this.lastElementOfLabel(o)&&o.prev().remove(),o.remove(),this.trigger("remove-mobile"),n&&this.selection.triggerChange(),t.length>1&&_.defer(function(){this.$el.trigger("scroll")}.bind(this)),this.trigger("remove",e))},onBatchRemove:function(e){var t={};_(e).each(function(e){if(_.isObject(e)){var i=e.cid||_.cid(e);t[i]=!0}else t[e]=!0});var i=this.getItems();if(0!==i.length){var o=i.filter(".selected")[0];if(i.filter(function(){var e=$(this).attr("data-cid");return!!t[e]}).remove(),this.renderEmpty(),o){var n=$(o).position().top;(n<0||n>this.el.offsetHeight)&&o.scrollIntoView()}}},onSort:function(){function e(e){return e&&parseInt(e.getAttribute("data-index"),10)}return function(){if(!this.queue.list.length){var t,i,o,n,a,r,s,l,d,c={};for(t=this.getItems().toArray(),o=0,n=0,a=(i=_(t).sortBy(e)).length;o<a;o++)if(r=i[o],s=t[n],c[o]=!0,this.options.labels&&(d=this.getLabel(this.collection.get($(r).attr("data-cid"))),$(r).attr("data-label",d)),r===s)do{l=e(t[++n])}while(c[l]);else s&&this.el.insertBefore(r,s);this.options.labels&&_.defer(function(){var e,t,i=this;this.$el.find(".list-item").toArray().forEach(function(o){if($(o).hasClass("list-item-label"))e=$(o).text(),$(o).next().hasClass("appointment")&&$(o).next().attr("data-label")===e&&t!==e?t=e:$(o).remove();else{var n=$(o).attr("data-label");n!==t&&(t=e=n,i.el.insertBefore(i.renderListLabel(n)[0],o))}})}.bind(this))}}}(),onTouchStart:function(e){if(!this.options.noPullToRefresh){var t=0===this.$el.scrollTop(),i=e.originalEvent.touches[0],o=i.pageY,n=i.pageX;t&&(this.pullToRefreshStartY=o,this.pullToRefreshStartX=n)}},onTouchMove:function(e){var t=e.originalEvent.touches[0].pageY,i=t-this.pullToRefreshStartY;if(!this.pullToRefreshStartY||this.isPulling||this.isSwiping||t-this.pullToRefreshStartY>=5&&(e.preventDefault(),e.stopPropagation(),this.selection.isScrolling=!0,this.isPulling=!0,this.$el.prepend(this.pullToRefreshIndicator)),this.isPulling&&i<=300){this.pullToRefreshTriggerd=!1,e.preventDefault(),e.stopPropagation();var o=1.2*i,n=70/150*i-70;this.pullToRefreshIndicator.css("-webkit-transform","translate3d(0,"+n+"px,0)"),$("#ptr-spinner").css("-webkit-transform","rotateZ("+o+"deg)"),this.selection.isScrolling=!0,t-this.pullToRefreshStartY>=150&&(this.pullToRefreshTriggerd=!0)}else this.isPulling&&i>=300&&(e.preventDefault(),e.stopPropagation())},onTouchEnd:function(e){this.pullToRefreshTriggerd?(this.pullToRefreshIndicator.css({transition:"transform 50ms","-webkit-transform":"translate3d(0,0,0)"}),$("#ptr-spinner").addClass("fa-spin"),this.options.app.trigger("pull-to-refresh",this),e.preventDefault(),e.stopPropagation()):this.isPulling&&(this.removePullToRefreshIndicator(!0),e.preventDefault(),e.stopPropagation()),this.selection.isScrolling=!1,this.pullToRefreshStartY=null,this.isPulling=!1,this.pullToRefreshTriggerd=!1,this.pullToRefreshStartY=null},removePullToRefreshIndicator:function(e){var t=this;e?(t.pullToRefreshIndicator.css({transition:"transform 50ms","-webkit-transform":"translate3d(0,-70px,0)"}),setTimeout(function(){t.pullToRefreshIndicator.removeAttr("style").remove()},100)):setTimeout(function(){t.pullToRefreshIndicator.addClass("scale-down"),setTimeout(function(){t.pullToRefreshIndicator.removeAttr("style").removeClass("scale-down"),$("#ptr-spinner").removeClass("fa-spin"),t.pullToRefreshIndicator.remove()},100)},250)},onChange:function(e){var t=this.$el.find('li[data-cid="'+$.escape(this.getCompositeKey(e))+'"]'),i=this.getBaton(e),o=e.changed.index,a=_.keys(e.changed);void 0!==o&&t.attr("data-index",o),(void 0===o||a.length>1)&&n.point(this.ref+"/item").invoke("draw",t.children().eq(1).empty(),i),this.trigger("change",e)},onChangeCID:function(e){var t=e.clone();t.set(e.previousAttributes()),this.$el.find('li[data-cid="'+$.escape(this.getCompositeKey(t))+'"]').attr("data-cid",this.getCompositeKey(e))},initialize:function(e){this.options=_.extend({pagination:!0,draggable:!1,selection:!0,scrollable:!0,swipe:!1,labels:!1},e),this.toggleFocus=_.debounce(function(e){this.disposed||(this.$el.attr("tabindex",e?-1:0),this.$el.toggleClass("has-focus",e))},10);var t={},n=!1,a=this;if(this.options.selection?(this.selection=new i(this,this.options.selection),t={"focus .list-item":"onItemFocus","blur .list-item":"onItemBlur",click:"onKeepFocus",contextmenu:"onContextMenu","keydown .list-item":"onItemKeydown"},_.device("smartphone")&&_.extend(t,{touchstart:"onTouchStart",touchend:"onTouchEnd",touchmove:"onTouchMove"}),_.device("!smartphone")&&this.$el.addClass("visible-selection"),o.enable({draggable:!0,container:this.$el,selection:this.selection}),n=!0,this.$el.addClass("f6-target")):this.toggleCheckboxes(!1),this.options.scrollable&&this.$el.addClass("scrollpane"),this.options.pagination&&(t.scroll="onScroll"),this.options.collection&&(this.setCollection(this.collection),this.collection.length&&this.onReset()),this.options.draggable&&!n&&o.enable({draggable:!0,container:this.$el,selection:this.selection}),this.options.labels&&(this.filter=function(){return!$(this).hasClass("list-item-label")}),this.ref=this.ref||e.ref,this.app=e.app,this.model=new Backbone.Model,this.isBusy=!1,this.firstReset=!0,this.firstContent=!0,this.delegateEvents(t),this.model.on("change",_.debounce(this.onModelChange,10),this),_.bindAll(this,"busy","idle"),_.device("!smartphone")&&this.$el.addClass("visible-selection"),_.device("smartphone")){var r,s=0;this.selection&&(this.selection.isScrolling=!1,this.$el.scroll(function(){a.$el.scrollTop()!==s&&(a.selection.isScrolling=!0,s=a.$el.scrollTop()),r&&clearTimeout(r),r=setTimeout(function(){a.selection.isScrolling=!1},500)}))}this.queue={list:[],add:function(e){return this.list.push(e),this},render:_.debounce(this.renderListItems.bind(this),10),iterate:function(e){try{this.list.forEach(e.bind(a))}catch(e){ox.debug&&console.error("ListView.iterate",e)}finally{this.list=[]}}}},forwardCollectionEvents:function(e){var t=_(arguments).toArray().slice(1);t.unshift("collection:"+e),this.trigger.apply(this,t)},setCollection:function(e){if(e)return this.collection&&this.stopListening(this.collection),this.collection=e,this.toggleComplete(this.collection.complete),this.toggleExpired(!1),this.listenTo(e,{all:this.forwardCollectionEvents,add:this.onAdd,change:this.onChange,"change:cid":this.onChangeCID,remove:this.onRemove,reset:this.onReset,sort:this.onSort,"before:load":this.busy,load:this.onLoad,"load:fail":this.renderError,"before:paginate":this.busy,paginate:this.idle,"paginate:fail":this.idle,complete:this.onComplete,reload:this.idle,expire:this.onExpire}),this.listenTo(e,{add:this.renderEmpty,remove:this.renderEmpty,reset:this.renderEmpty}),this.selection&&this.selection.reset(),this.trigger("collection:set"),this},onExpire:function(){this.toggleExpired(!1)},toggleExpired:function(e){this.collection.expired=e},toggleComplete:function(e){this.options.pagination||(e=!0),this.$el.toggleClass("complete",e)},isComplete:function(){return this.collection&&this.collection.complete},toggleCheckboxes:function(e){this.$el.toggleClass("hide-checkboxes",void 0===e?void 0:!e)},getItems:function(){var e=this.$el.find(".list-item");return this.filter&&(e=e.filter(this.filter)),e},setFilter:function(e){this.filter=e;var t=this.$el.find(".list-item");t.removeClass("hidden"),this.filter?(t.not(this.filter).addClass("hidden"),t.filter(this.filter).each(function(e){$(this).addClass(e%2?"even":"odd")})):t.removeClass("even odd")},connect:function(e){this.collection&&this.stopListening(this.collection),this.collection=e.getDefaultCollection(),this.options.pagination&&!this.loader&&(this.onScroll=this.onScroll.bind(this),this.listenToDOM(window,"resize",this.onScroll)),this.loader=e,this.load=function(t){this.empty(),e.load(_.extend(this.model.toJSON(),t)),this.setCollection(e.collection)},this.paginate=function(t){e.paginate(_.extend(this.model.toJSON(),t))},this.reload=function(t){e.reload(_.extend(this.model.toJSON(),t))}},load:a,paginate:a,reload:a,map:function(e){return e.toJSON()},render:function(){return this.options.selection&&this.$el.attr({"aria-multiselectable":!0,role:"listbox",tabindex:0}),this.$el.attr("data-ref",this.ref),this.addNotification(),_.device("phantomjs")&&this.$el.addClass("no-transition"),this},redraw:function(){var e=n.point(this.ref+"/item"),t=this.collection;this.getItems().each(function(i,o){if(!(i>=t.length)){var n=t.at(i),a=this.getBaton(n);e.invoke("draw",$(o).children().eq(1).empty(),a)}}.bind(this))},createListItem:function(){var e=this.scaffold.clone();return this.options.selection&&e.addClass("selectable").attr({"aria-selected":!1,role:"option",tabindex:"-1"}),e},getPreviousLabel:function(e){for(var t=e;t.length>0&&!t.hasClass("list-item-label");)t=t.prev();return t.text()},renderListLabel:function(e){return $('<li class="list-item list-item-label" role="presentation">').text(e)},renderListItem:function(e,t){var i=this.createListItem(),o=this.getBaton(e),a=i.children().eq(1);if(t&&this.options.labels){var r=this.getLabel(e);this.currentLabel!==r&&(this.$el.append(this.renderListLabel(r)),this.currentLabel=r)}return this.options.useButtonMarkup&&i.children().wrapAll('<button type="button" class="btn-unstyled">'),i.attr({"data-cid":this.getCompositeKey(e),"data-index":e.get("index")}),this.options.labels&&i.attr("data-label",this.getLabel(e)),n.point(this.ref+"/item").invoke("draw",a,o),i},renderListItems:function(){this.idle();var e=this.getItems();this.queue.iterate(function(t){var i,o,n=t.has("index")?t.get("index"):this.collection.indexOf(t),a=this.renderListItem(t,!1);if(n<e.length){var r=e.eq(n);this.options.labels&&(i=this.getLabel(t))!==(o=this.getPreviousLabel(r))&&(r=r.prev()),r.before(a),a[0].offsetTop<=this.el.scrollTop&&(this.el.scrollTop+=a.outerHeight(!0))}else this.$el.append(a);this.options.labels&&(o=this.getPreviousLabel(a),(i=this.getLabel(t))!==o&&a.before(this.renderListLabel(i))),this.trigger("add",t,n),this.trigger("add:"+t.cid,t,n)}),this.onSort()},getBaton:function(e){var t=this.map(e);return n.Baton({data:t,model:e,app:this.app,options:this.options})},getBusyIndicator:function(){return this.$el.find(".busy-indicator")},addNotification:function(){this.notification.clone().appendTo(this.$el)},addBusyIndicator:function(){var e=this.getBusyIndicator();return e.index()<this.$el.children().length&&e.appendTo(this.$el),e.length?e:this.busyIndicator.clone().appendTo(this.$el)},removeBusyIndicator:function(){this.getBusyIndicator().remove()},busy:function(){if(!this.isBusy)return this.$(".notification").css("display","none"),this.addBusyIndicator().addClass("io-ox-busy").find("i").remove(),this.isBusy=!0,this},idle:function(e){if(e&&e.error&&require(["io.ox/core/yell"],function(t){t(e)}),this.isBusy)return this.removeBusyIndicator(),this.isBusy=!1,this.$(".notification").css("display",""),this},getPosition:function(){return this.selection.getPosition()},hasNext:function(){return!!this.collection&&(this.getPosition()+1<this.collection.length||!this.isComplete())},next:function(){this.hasNext()?this.selection.next():this.processPaginate()},hasPrevious:function(){return!!this.collection&&this.getPosition()-1>=0},previous:function(){this.hasPrevious()?this.selection.previous():this.$el.scrollTop(0)},focus:function(){0===this.getItems().filter(".selected").focus().length&&this.$el.focus()}})}),define("io.ox/mail/view-options",["io.ox/core/extensions","io.ox/backbone/mini-views/dropdown","io.ox/backbone/mini-views/common","io.ox/core/api/account","gettext!io.ox/mail","io.ox/core/commons","io.ox/core/folder/contextmenu","io.ox/core/api/collection-loader","io.ox/core/http","io.ox/mail/api","io.ox/core/folder/api","settings!io.ox/mail"],function(e,t,i,o,n,a,r,s,l,d,c,u){function p(e,t){if("virtual/all-unseen"===e.folder.get())return t.hide();t.toggle(!e.props.get("find-result"))}function f(e){var t=!!e.data.state;if(e.data.app.folderView.forceOpen=t,e.data.app.props.set("folderview",t),e.data.state)e.data.app.folderView.tree.getNodeView(e.data.app.folder.get()).$el.focus();else{var i=e.data.app.listView,o=i.selection.get().reduce(function(e,t){return e||i.selection.getNode(t)},null);if(o)i.selection.focus(0,o);else{var n=require("io.ox/mail/util"),a=i.selection.view.collection,r=a.models.find(function(e){return!n.isUnseen(e.get("flags"))});if(r)return i.selection.select(a.indexOf(r));i.$el.focus()}}}function h(e){e.getWindow().nodes.sidepanel.show(),v?e.getWindow().nodes.main.find('.toolbar-item[data-action="open-folder-view"]').hide():e.getWindow().nodes.main.find(".list-view-control").removeClass("toolbar-bottom-visible")}function g(e){e.getWindow().nodes.sidepanel.hide(),v?e.getWindow().nodes.main.find('.toolbar-item[data-action="open-folder-view"]').show():e.getWindow().nodes.main.find(".list-view-control").addClass("toolbar-bottom-visible")}var m={id:"search",index:100,draw:function(e){var t=e.app.listView,i=new s({module:"mail",mode:"search",getQueryParams:function(t){var i,o,n=t.criteria,a=[],r=n.from||n.von||n.de,s=n.to||n.an||n.a||n.para,l=n.subject||n.betreff||n.sujet||n.asunto,c=n.year||n.y||n.jahr||n.ano;return r&&a.push(["=",{field:"from"},r]),s&&a.push(["or",["=",{field:"to"},s],["=",{field:"cc"},s],["=",{field:"bcc"},s]]),l&&a.push(["=",{field:"subject"},l]),c&&(i=Date.UTC(c,0,1),o=Date.UTC(c,11,31),a.push(["and",[">",{field:"received_date"},String(i)],["<",{field:"received_date"},String(o)]])),n.words&&_(n.words.split(" ")).each(function(e){a.push(["or",["=",{field:"content"},e],["=",{field:"subject"},e]])}),n.addresses&&_(n.addresses.split(" ")).each(function(e){a.push(["or",["=",{field:"to"},e],["=",{field:"cc"},e],["=",{field:"bcc"},e],["=",{field:"content"},e]])}),"true"===n.attachment&&a.push(["=",{field:"content_type"},"multipart/mixed"]),n.after&&a.push([">",{field:"received_date"},String(n.after)]),n.before&&a.push(["<",{field:"received_date"},String(n.before)]),{action:"search",folder:"all"===n.folder?d.allMessagesFolder:e.app.folder.get(),columns:"102,600,601,602,603,604,605,606,607,608,610,611,614,652,656,X-Open-Xchange-Share-URL",sort:t.sort||"610",order:t.order||"desc",timezone:"utc",data:{filter:["and"].concat(a)}}},fetch:function(e){return l.wait().then(function(){return l.PUT({module:"mail",params:_(e).omit("data"),data:e.data})})},each:function(e){d.pool.add("detail",e)},PRIMARY_PAGE_SIZE:100,SECONDARY_PAGE_SIZE:100}),o=$('<div class="_hurz">').appendTo(this);require(["io.ox/backbone/views/search"],function(n){new n({el:o[0],point:"io.ox/mail/search/dropdown"}).build(function(){var t=this;e.app.on("folder:change",function(){t.cancel()}),e.app.folderView.tree.$el.on("click",function(){t.cancel()})}).on("search",function(e){t.connect(i),t.model.set({criteria:e,thread:!1,sort:610,order:"desc"}),t.$el.parent().find('.grid-options [data-name="thread"]').addClass("disabled")}).on("cancel",function(){var e=t.$el.parent().find('.grid-options [data-name="thread"]');e.hasClass("disabled")&&(t.connect(d.collectionLoader),t.model.unset("criteria"),e.removeClass("disabled"))}).render()})}},v=_.device("desktop")&&!navigator.webdriver&&u.get("prototypes/search",!1);v&&e.point("io.ox/mail/list-view/toolbar/top").extend(m),e.point("io.ox/mail/search/dropdown").extend({id:"default",index:100,render:function(){this.model.set("folder","current"),this.$dropdown.append(this.select("folder",n("Search in"),[{value:"current",label:n("Current folder")},{value:"all",label:n("All folders")}]),this.input("subject",n("Subject")),this.input("from",n("From")),this.input("to",n("To")),this.input("words",n("Contains words")),this.dateRange(),this.checkbox("attachment",n("Has attachments")),this.button())}}),e.point("io.ox/mail/view-options").extend({id:"sort",index:100,draw:function(e){var t=this.data("view"),i=e.app.folder.get();t.listenTo(e.app,"folder:change",function(){var i=e.app.folder.get();t.$('a[data-value="from-to"]').contents().last().replaceWith(n(o.is("sent|drafts",i)?"To":"From")),t.$('a[data-value="602"]').toggleClass("hidden",!c.pool.getModel(i).supports("ATTACHMENT_MARKER"))}),t.option("sort",610,n("Date"),{radio:!0}).option("sort","from-to",n(o.is("sent|drafts",i)?"To":"From"),{radio:!0}).option("sort",651,n("Unread"),{radio:!0}).option("sort",608,n("Size"),{radio:!0}).option("sort",607,n("Subject"),{radio:!0}),c.pool.getModel(i).supports("ATTACHMENT_MARKER")&&t.option("sort",602,n("Attachments"),{radio:!0}),u.get("features/flag/color")&&this.data("view").option("sort",102,n("Color"),{radio:!0}),u.get("features/flag/star")&&this.data("view").option("sort",660,n("Flag"),{radio:!0})}}),e.point("io.ox/mail/view-options").extend({id:"order",index:200,draw:function(){this.data("view").divider().option("order","asc",n("Ascending"),{radio:!0}).option("order","desc",n("Descending"),{radio:!0})}}),e.point("io.ox/mail/view-options").extend({id:"thread",index:300,draw:function(e){!1!==e.app.settings.get("threadSupport",!0)&&this.data("view").divider().option("thread",!0,n("Conversations"))}}),e.point("io.ox/mail/list-view/toolbar/"+(v?"bottom":"top")).extend({id:"dropdown",index:1e3,draw:function(i){var o=i.app,a=o.props,r=new t({tagName:"li",className:"dropdown grid-options toolbar-item margin-auto",attributes:{role:"presentation"},caret:!0,label:n.pgettext("dropdown","Sort"),dataAction:"sort",model:a,tabindex:-1});e.point("io.ox/mail/view-options").invoke("draw",r.$el,i),this.append(r.render().$el.find(".dropdown-menu").addClass("dropdown-menu-right").end().on("dblclick",function(e){e.stopPropagation()}));var s=_.partial(p,o,r.$el);o.props.on("change:find-result",s),o.on("folder:change",s),s()}}),e.point("io.ox/mail/all-options").extend({id:"default",index:100,draw:function(t){var i=t.app,o=r.extensions,a=this.$ul,s=["markFolderSeen","moveAllMessages","archive","divider","empty"];"virtual/all-unseen"===i.folder.get()||i.props.get("find-result")||i.props.get("categories")?s=["selectAll"]:this.header(n("All messages in this folder")),i.folder.getData().done(function(t){var n=new e.Baton({data:t,module:"mail",listView:i.listView});s.forEach(function(e){o[e].call(a,n)})})}}),e.point("io.ox/mail/list-view/toolbar/"+(v?"bottom":"top")).extend({id:"all",index:200,draw:function(i){function o(){s.prepareReuse().render(),e.point("io.ox/mail/all-options").invoke("draw",s,i)}var a=i.app,r=a.props,s=new t({tagName:"li",attributes:{role:"presentation"},className:"dropdown grid-options toolbar-item",caret:!0,label:n.pgettext("dropdown","All"),dataAction:"all",model:r});e.point("io.ox/mail/all-options").invoke("draw",s,i),this.append(s.render().$el.on("dblclick",function(e){e.stopPropagation()})),a.props.on("change:find-result change:categories",o),a.on("folder:change",o)}}),e.point("io.ox/mail/list-view/toolbar/bottom").extend({id:"toggle-folderview",index:100,draw:function(e){this.append($('<button type="button" class="btn btn-link toolbar-item pull-left" data-action="open-folder-view">').attr("aria-label",n("Open folder view")).append($('<i class="fa fa-angle-double-right" aria-hidden="true">').attr("title",n("Open folder view"))).on("click",{app:e.app,state:!0},f)),v&&e.app.getWindow().nodes.main.find(".list-view-control").removeClass("toolbar-bottom-visible"),e.app.on({"folderview:open":h.bind(null,e.app),"folderview:close":g.bind(null,e.app)}),e.app.folderViewIsVisible()&&_.defer(h,e.app)}}),e.point("io.ox/mail/sidepanel").extend({id:"toggle-folderview",index:1e3,draw:function(e){var t=_.uniqueId("control");this.addClass("bottom-toolbar").append($('<div class="generic-toolbar bottom visual-focus" role="region">').attr("aria-labelledby",t).append($('<button type="button" class="btn btn-link toolbar-item" data-action="close-folder-view">').attr({id:t,"aria-label":n("Close folder view")}).append($('<i class="fa fa-angle-double-left" aria-hidden="true">').attr("title",n("Close folder view"))).on("click",{app:e.app,state:!1},f)))}}),e.point("io.ox/mail/sidepanel").extend({id:"help",index:1100,draw:a.help}),e.point("io.ox/mail/sidepanel").extend({id:"premium-area",index:1e4,draw:function(e){this.append(a.addPremiumFeatures(e.app,{append:!1,upsellId:"folderview/mail/bottom",upsellRequires:"active_sync"}))}})}),define("io.ox/core/api/backbone",[],function(){var e=Backbone.Model.extend({idAttribute:"cid",initialize:function(){this.cid=this.attributes.cid=_.cid(this.attributes),this.on("change:id",this.updateCID.bind(this))},updateCID:function(){this.set("cid",this.cid=_.cid(this.attributes))},toString:function(){return"Model("+this.cid+")"}});return{Model:e,Collection:Backbone.Collection.extend({comparator:"index",model:e,parse:function(e){_.isArray(e)||(e=[e]);var t=this.model;return _(e).map(function(e){return e instanceof t?e:new t(e)})}})}}),define("io.ox/mail/detail/view",["io.ox/backbone/views/disposable","io.ox/backbone/views/toolbar","io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/core/api/collection-pool","io.ox/mail/detail/content","io.ox/core/a11y","io.ox/core/capabilities","gettext!io.ox/mail","less!io.ox/mail/detail/content","less!io.ox/mail/detail/style","less!io.ox/mail/style","io.ox/mail/actions"],function(e,t,i,o,n,a,r,s,l,d,c,u){var p=0;o.point("io.ox/mail/detail").extend({id:"unread-class",index:p+=100,draw:i.unreadClass}),o.point("io.ox/mail/detail").extend({id:"flagged-class",index:p+=100,draw:i.flaggedClass}),o.point("io.ox/mail/detail").extend({id:"subject",index:p+=100,draw:function(e){var t=a.getSubject(e.data);this.append($('<h1 class="subject">').text(t))}}),o.point("io.ox/mail/detail").extend({id:"header",index:p+=100,draw:function(e){var t=$('<header class="detail-view-header">');o.point("io.ox/mail/detail/header").invoke("draw",t,e),this.append(t)}});var f=0;o.point("io.ox/mail/detail/header").extend({id:"threadcontrol",index:f+=100,draw:function(e){var t=e.data,i=a.getSubject(t),o=a.hasFrom(t)?c("Email from %1$s: %2$s",a.getDisplayName(t.from[0]),i):i;this.append($('<h2 class="toggle-mail-body">').append($('<button type="button" class="toggle-mail-body-btn">').attr("aria-expanded",e.view.$el.hasClass("expanded")).append($('<span class="sr-only">').text(o))))}}),o.point("io.ox/mail/detail/header").extend({id:"picture",index:f+=100,draw:i.senderPicture}),o.point("io.ox/mail/detail/header").extend({id:"drag-support",index:f+=100,draw:function(e){this.find(".contact-picture").attr({"data-drag-data":_.cid(e.data),"data-drag-message":a.getSubject(e.data)})}}),o.point("io.ox/mail/detail/header").extend({id:"unread-toggle",index:f+=100,draw:i.unreadToggle},{id:"paper-clip",index:f+=100,draw:i.paperClip},{id:"rows",index:f+=100,draw:function(e){for(var t,i=1;i<=5;i++)t=$('<div class="detail-view-row row-'+i+' clearfix">'),o.point("io.ox/mail/detail/header/row"+i).invoke("draw",t,e),this.append(t)}}),o.point("io.ox/mail/detail/header/row1").extend({id:"from",index:f+=100,draw:i.fromDetail},{id:"priority",index:f+=100,draw:i.priority},{id:"security",index:f+=100,draw:i.security},{id:"date",index:f+=100,draw:i.fulldate},{id:"flag-toggle",index:f+=100,draw:i.flagToggle},{id:"color-picker",index:f+=100,draw:i.flagPicker}),o.point("io.ox/mail/detail/header/row2").extend({id:"sender",index:100,draw:function(e){o.point("io.ox/mail/detail/header/sender").invoke("draw",this,e)}}),o.point("io.ox/mail/detail/header/sender").extend({id:"default",index:100,draw:function(e){var t=e.data,i=t.from||[];if(a.authenticity("via",t)&&e.data.authenticity&&e.data.authenticity.domain_mismatch&&e.data.authenticity.from_domain&&this.append($('<div class="sender">').append($('<span class="io-ox-label">').append($.txt(c("Via")),$.txt("  ")),$('<span class="address">').text(e.data.authenticity.from_domain))),"headers"in t&&"Sender"in t.headers){var o=a.parseRecipients(t.headers.Sender);i[0]&&i[0][1]===o[0][1]||this.append($('<div class="sender">').append($('<span class="io-ox-label">').append($.txt(c("Via")),$.txt("  ")),$('<span class="address">').text((o[0][0]||"")+" <"+o[0][1]+">")))}}}),o.point("io.ox/mail/detail/header/row3").extend({id:"recipients",index:100,draw:function(e){o.point("io.ox/mail/detail/header/recipients").invoke("draw",this,e)}}),o.point("io.ox/mail/detail/header/recipients").extend({id:"default",index:100,draw:i.recipients}),o.point("io.ox/mail/detail/header/row4").extend({id:"different-subject",index:100,draw:function(e){var t,i,o,r=e.data;1!==r.threadSize&&(t=n.threads.subject(r),i=a.getSubject(t,!1),o=a.getSubject(r,!1),""!==t&&i!==o&&this.append($('<span class="io-ox-label">').text(c("Subject")+"  "),$('<span class="different-subject">').text(o)))}}),o.point("io.ox/mail/detail/header/row5").extend({id:"inline-links",index:100,draw:function(e){if(e.view.$el.hasClass("expanded")&&!e.view.placeholder){var i=new t({el:this[0],point:"io.ox/mail/links/inline",inline:!0});i.$el.attr("data-toolbar","io.ox/mail/links/inline"),i.setSelection([_.cid(e.data)],{data:e.data})}}}),o.point("io.ox/mail/detail").extend({id:"notifications",index:p+=100,draw:function(e){var t=$('<section class="notifications">');o.point("io.ox/mail/detail/notifications").invoke("draw",t,e),this.append(t)}}),o.point("io.ox/mail/detail").extend({id:"warnings",index:p+=100,draw:function(e){var t=$('<section class="warnings">');o.point("io.ox/mail/detail/warnings").invoke("draw",t,e),this.append(t)}}),o.point("io.ox/mail/detail").extend({id:"preview-text",index:p+=100,draw:function(e){e.view.supportsTextPreview&&e.data.text_preview&&this.append($('<section class="text-preview">').text(e.data.text_preview+(e.data.text_preview.length>=100?"...":"")))}}),o.point("io.ox/mail/detail/warnings").extend({id:"plaintextfallback",index:100,draw:i.plainTextFallback});var h=0;o.point("io.ox/mail/detail/notifications").extend({id:"phishing",index:h+=100,draw:i.phishing}),o.point("io.ox/mail/detail/notifications").extend({id:"authenticity",index:h+=100,draw:i.authenticity}),o.point("io.ox/mail/detail/notifications").extend({id:"disposition-notification",index:h+=100,draw:i.dispositionNotification}),o.point("io.ox/mail/detail/notifications").extend({id:"external-images",index:h+=100,draw:i.externalImages}),o.point("io.ox/mail/detail/notifications").extend({id:"disabled-links",index:h+=100,draw:i.disabledLinks}),o.point("io.ox/mail/detail").extend({id:"error",index:p+=100,draw:function(){this.append($('<section class="error">').hide())}}),o.point("io.ox/mail/detail").extend({id:"body",index:p+=100,draw:function(){this.append($('<section class="attachments">'),$('<section class="body user-select-text focusable" tabindex="-1">'))}}),o.point("io.ox/mail/detail/body").extend({id:"iframe",index:100,draw:function(e){var t=$('<iframe src="" class="mail-detail-frame">').attr("title",c("Email content")).on("load",function(){t.contents().on("click",'a[rel="noopener"], area[target="_blank"]',function(e){_.device("noopener")||($(this).attr("class")||"").indexOf("deep-link")>-1||(e.preventDefault(),blankshield.open($(this).attr("href")))})});o.point("io.ox/mail/detail/body/iframe").invoke("draw",t,e),this.idle().append(t)}}),o.point("io.ox/mail/detail/body").extend({id:"content-flags",index:200,draw:function(e){if(e.content){var t=$(e.content);this.closest("article").toggleClass("content-links",!!t.find("a").length)}}}),o.point("io.ox/mail/detail/body/iframe").extend({id:"content",index:100,draw:function(e){function t(){r=0}function i(e){this.document.body&&e.data.iframe.parent().addBack().height(this.document.body.scrollHeight)}function o(e){r<=0&&(r=2,e.data.iframe.height(""),i.call(this,e),this.requestAnimationFrame(function(){r--}))}var n=s.get(e.data,{},e.flow),a=$(n.content),r=0,l=function(e){e.target=this[0],this.trigger(e)}.bind(this);e.content=n.content,n.isText&&(a=$("<body>").append(a)),this.on("load",function(){_.defer(function(){var e=$(this.contentDocument).find("html");e.attr("lang")||e.attr("lang",$("html").attr("lang")),e.on("keydown click",l),_.device("ios && smartphone")&&e.addClass("ios smartphone"),$(this.contentDocument).find("head").append("<style>"+u+"</style>"),$(this.contentDocument).find("body").replaceWith(a),a.find("table").each(function(){"100%"!==this.getAttribute("height")&&"100%"!==(this.style||{}).height||(this.setAttribute("height",""),$(this).css("height","initial"))}),$(this.contentWindow).on("complete toggle-blockquote",{iframe:$(this)},i).on("resize",{iframe:$(this)},o).on("dragover drop",!1).trigger("resize")}.bind(this))}),a.find("img").on("load error",function(){$(this).off().trigger("complete")}),$(window).on("resize",t),this.on("dispose",function(){$(window).off("resize",t),$(this.contentWindow).off()})}}),o.point("io.ox/mail/detail/body/iframe").extend({id:"events",index:200,draw:function(){this.on("load",function(){_.defer(function(){$(this.contentDocument).find("html").on("click",".mailto-link, .deep-link-tasks, .deep-link-contacts, .deep-link-calendar, .deep-link-files, .deep-link-gdpr, .deep-link-app",function(e){ox.trigger("click:deep-link-mail",e,this)})}.bind(this))})}}),o.point("io.ox/mail/detail/body/iframe").extend({id:"max-size",index:1200,after:"content",draw:function(e){this.on("load",function(){_.defer(function(){if(_(e.data.attachments).some(function(e){return e.truncated})){var t="api/mail?"+$.param({action:"get",view:"document",forceImages:!0,folder:e.data.folder_id,id:e.data.id,session:ox.session});$(this.contentDocument).find("body .mail-detail-content").append($('<div class="max-size-warning">').append($.txt(c("This message has been truncated due to size limitations.")),$.txt(" "),$('<a role="button" target="_blank">').attr("href",t).text(c(1!==e.model.get("modified")?"Show entire message":"Show entire message including all external images"))))}}.bind(this))})}}),o.point("io.ox/mail/detail/attachments").extend({id:"attachment-list",index:200,draw:function(e){0!==e.attachments.length&&i.attachmentList.call(this,e)}});var g=r.create("mail");return{View:e.extend({className:"list-item mail-item mail-detail f6-target focusable",events:{keydown:"onToggle","click .detail-view-header":"onToggle","click .text-preview":"onToggle","click .toggle-mail-body-btn":"onToggle",'click a[data-action="retry"]':"onRetry"},onChangeFlags:function(){this.$el.toggleClass("unread",a.isUnseen(this.model.get("flags"))),this.$el.toggleClass("flagged",a.isFlagged(this.model.get("flags")))},onChangeAttachments:function(){if(!this.model.changed.attachments||!_.isEqual(this.model.previous("attachments"),this.model.get("attachments"))){var e=this.model.toJSON(),t=o.Baton({view:this,model:this.model,data:e,attachments:a.getAttachments(e)}),i=this.$el.find("section.attachments").empty();o.point("io.ox/mail/detail/attachments").invoke("draw",i,t),ox.trigger("mail:detail:attachments:render",this),this.model.previous("attachments")&&this.model.get("attachments")&&this.model.previous("attachments")[0].content!==this.model.get("attachments")[0].content&&this.onChangeContent()}},getEmptyBodyNode:function(){return this.$el.find("section.body").empty()},onChangeSubject:function(){var e=this.$el.find("h1.subject");return e.text(a.getSubject(this.model.get("subject"))),e},onChangeContent:function(){var e=this.model.toJSON(),t=o.Baton({view:this,model:this.model,data:e,attachments:a.getAttachments(e)}),i=this.$el.find("section.body"),n=this.getEmptyBodyNode(),r=this;t.disable(this.options.disable),i.css("min-height",this.model.get("visualHeight")||null),_.delay(function(){o.point("io.ox/mail/detail/body").invoke("draw",n,t),ox.trigger("mail:detail:body:render",r),r.trigger("mail:detail:body:render",r),i=n=r=null},20)},onChangeRecipients:_.debounce(function(){var e=this.model.toJSON(),t=o.Baton({data:e,model:this.model,view:this}),i=this.$(".recipients").empty();o.point("io.ox/mail/detail/header/recipients").invoke("draw",i,t)},10),onToggle:function(e){if(("keydown"!==e.type||13===e.which||32===e.which)&&!$(e.target).closest("a").length){if(!$(e.currentTarget).hasClass("toggle-mail-body-btn")){var t=l.getTabbable(this.$el);if(t.index(e.target)>=0)return;if(t.find($(e.target)).length)return}$(e.target).hasClass("dropdown-menu")||$(e.target).hasClass("overlay")||0===this.$el.siblings().length&&this.$el.hasClass("expanded")||(this.$el.find(".collapsed-blockquote").hide(),this.$el.find(".blockquote-toggle").show(),this.toggle())}},onRetry:function(e){e.preventDefault(),this.$("section.error").hide(),this.$("section.body").show(),this.toggle(!0)},onUnseen:function(){var e=this.model.toJSON();this.model.cid!==n.setToUnread&&a.isToplevel(e)&&n.markRead(e)},onLoad:function(e){if(null!==this.model){e&&this.model.set(e);var t=this.model.get("unseen")||a.isUnseen(this.model.get("flags"));this.$el.find("section.body").removeClass("loading"),this.trigger("load:done"),this.$el.find(".detail-view-row.row-5").hasClass("inline-toolbar-container")||(this.$el.empty(),this.render()),this.onChangeSubject(),this.onChangeAttachments(),this.onChangeContent(),t?this.onUnseen():n.trigger("update:set-seen",[{id:this.model.get("id"),folder_id:this.model.get("folder_id")}])}},onLoadFail:function(e){this.$el&&(this.trigger("load:fail"),this.trigger("load:done"),this.$el.attr("data-loaded",!1),this.$("section.error").empty().show().append($('<i class="fa fa-exclamation-triangle" aria-hidden="true">'),$("<h4>").text(c("Error: Failed to load message content")),$("<p>").text(e.error),$('<a href="#" role="button" data-action="retry">').text(c("Retry"))))},toggle:function(e){this.placeholder=!1;var t=this.$el,i=t.find(".toggle-mail-body-btn");t.toggleClass("expanded",e);var o=t.hasClass("expanded");if(i.attr("aria-expanded",o),this.$el.trigger("toggle"),"false"===t.attr("data-loaded")&&o)if(t.attr("data-loaded",!0),t.find("section.body").addClass("loading"),this.trigger("load"),this.loaded)this.onLoad();else{var a=_.cid(this.model.cid);1===_(a).size()&&void 0!==a.id&&this.model.has("parent")?n.getNestedMail(this.model.attributes).pipe(this.onLoad.bind(this),this.onLoadFail.bind(this)):n.get(_.extend({},a,{unseen:this.model.cid===n.setToUnread})).pipe(this.onLoad.bind(this),this.onLoadFail.bind(this))}else o&&this.$el.find(".mail-detail-frame").contents().find(".mail-detail-content").trigger("resize");return this},expand:function(){return this.toggle(!0)},initialize:function(e){this.options=e||{},this.model=g.getDetailModel(e.data),this.loaded=e.loaded||!1,this.listenTo(this.model,"change:flags",this.onChangeFlags),this.listenTo(this.model,"change:attachments",this.onChangeAttachments),this.listenTo(this.model,"change:to change:cc change:bcc",this.onChangeRecipients),this.placeholder=!0,this.supportsTextPreview=e.supportsTextPreview,this.on({load:function(){this.$("section.body").empty().busy()},"load:done":function(){this.$("section.body").idle()},"load:fail":function(){this.$("section.body").hide()}})},redraw:function(){this.$el.empty(),this.render(),this.$el.hasClass("expanded")&&(this.onChangeAttachments(),this.onChangeContent())},render:function(){var e=this.model.toJSON(),t=o.Baton({data:e,model:this.model,view:this});return t.disable(this.options.disable),this.$el.attr({"data-cid":this.model.cid,"data-loaded":"false"}),this.$el.data({view:this,model:this.model}),this.placeholder||o.point("io.ox/mail/detail").invoke("draw",this.$el,t),this.$el.toggleClass("placeholder",this.placeholder),ox.trigger("mail:detail:render",this),this}})}}),define("io.ox/mail/detail/mobileView",["io.ox/mail/detail/view","io.ox/mail/common-extensions","io.ox/core/extensions","io.ox/mail/api","io.ox/mail/util","io.ox/mail/detail/content","gettext!io.ox/mail","less!io.ox/mail/style"],function(e,t,i,o,n,a,r){var s=0;i.point("io.ox/mail/mobile/detail").extend({id:"unread-class",index:s+=100,draw:t.unreadClass}),i.point("io.ox/mail/mobile/detail").extend({id:"flagged-class",index:s+=100,draw:t.flaggedClass}),i.point("io.ox/mail/mobile/detail").extend({id:"header",index:s+=100,draw:function(e){var t=$('<header class="mobile-detail-view-mail detail-view-header">');i.point("io.ox/mail/mobile/detail/header").invoke("draw",t,e),this.append(t)}});var l=0;return i.point("io.ox/mail/mobile/detail/header").extend({id:"drag-support",index:l+=100,draw:function(e){this.attr({"data-drag-data":_.cid(e.data),"data-drag-message":n.getSubject(e.data)})}}),i.point("io.ox/mail/mobile/detail/header").extend({id:"actions",index:l+=100,draw:t.actions}),i.point("io.ox/mail/mobile/detail/header").extend({id:"from",index:l+=100,draw:t.fromDetail}),i.point("io.ox/mail/mobile/detail/header").extend({id:"priority",index:l+=100,draw:t.priority}),i.point("io.ox/mail/mobile/detail/header").extend({id:"paper-clip",index:l+=100,draw:t.paperClip}),i.point("io.ox/mail/mobile/detail/header").extend({id:"recipients",index:l+=100,draw:t.recipients}),i.point("io.ox/mail/mobile/detail/header").extend({id:"subject",index:l+=100,draw:function(e){var t=n.getSubject(e.data);this.append($('<h1 class="subject">').text(t))}}),i.point("io.ox/mail/mobile/detail/header").extend({id:"date",index:l+=100,draw:t.fulldate}),i.point("io.ox/mail/mobile/detail/header").extend({id:"flags",index:l+=100,draw:function(e){var t=$('<span class="flags">').appendTo(this);i.point("io.ox/mail/mobile/detail/header/flags").invoke("draw",t,e)}}),i.point("io.ox/mail/mobile/detail/header/flags").extend({id:"security",index:l+=100,draw:t.security}),i.point("io.ox/mail/mobile/detail/header/flags").extend({id:"flag-toggle",index:l+=100,draw:t.flagToggle}),i.point("io.ox/mail/mobile/detail/header/flags").extend({id:"color-picker",index:l+=100,draw:function(e){t.flagPicker.call(this,e)}}),i.point("io.ox/mail/mobile/detail").extend({id:"notifications",index:s+=100,draw:function(e){var t=$('<section class="notifications">');i.point("io.ox/mail/detail/notifications").invoke("draw",t,e),this.append(t)}}),i.point("io.ox/mail/mobile/detail").extend({id:"body",index:s+=100,draw:function(){this.append($('<section class="attachments">'),$('<section class="body user-select-text">'))}}),i.point("io.ox/mail/mobile/detail/attachments").extend({id:"attachment-list",index:100,draw:function(e){0!==e.attachments.length&&t.attachmentList.call(this,e)}}),i.point("io.ox/mail/mobile/detail/attachments").extend({id:"attachment-preview",index:200,draw:t.attachmentPreview}),i.point("io.ox/mail/mobile/detail/body").extend({id:"iframe+content",index:100,draw:function(e){var t=this;i.point("io.ox/mail/detail/body").get("iframe",function(i){i.invoke("draw",t,e)}),i.point("io.ox/mail/detail/body").get("content",function(i){i.invoke("draw",t,e)})}}),i.point("io.ox/mail/mobile/detail/body").extend({id:"max-size",after:"content",draw:function(e){if(_(e.data.attachments).some(function(e){return e.truncated})){var t="api/mail?"+$.param({action:"get",view:"document",folder:e.data.folder_id,id:e.data.id,session:ox.session});this.append($('<div class="max-size-warning">').append($.txt(r("This message has been truncated due to size limitations.")),$.txt(" "),$('<a role="button" target="_blank">').attr("href",t).text(r("Show entire message"))))}}}),{HeaderView:e.View.extend({events:{"click .detail-view-header":"onClick"},onClick:function(e){$(e.target).hasClass("show-all-recipients")||this.$el.trigger("showmail")},toggle:function(){return this}}),DetailView:e.View.extend({onChangeAttachments:function(){var e=this.model.toJSON(),t=i.Baton({data:e,attachments:n.getAttachments(e),view:this}),o=this.$el.find("section.attachments").empty();i.point("io.ox/mail/mobile/detail/attachments").invoke("draw",o,t),this.model.previous("attachments")&&this.model.get("attachments")&&this.model.previous("attachments")[0].content!==this.model.get("attachments")[0].content&&this.onChangeContent()},onChangeContent:function(){var e=this.model.toJSON(),t=i.Baton({view:this,model:this.model,data:e,attachments:n.getAttachments(e)}),o=this.getEmptyBodyNode();t.disable(this.options.disable),i.point("io.ox/mail/mobile/detail/body").invoke("draw",o,t)},render:function(){var e=this.model.toJSON(),t=i.Baton({data:e,model:this.model,view:this}),o=n.getSubject(e),a=n.hasFrom(e)?r("Email from %1$s: %2$s",n.getDisplayName(e.from[0]),o):o;return _(this.options.disable).each(function(e,i){_.isArray(e)?_(e).each(function(e){t.disable(i,e)}):t.disable(i,e)}),this.$el.attr({"aria-label":a,"data-cid":this.cid,"data-loaded":"false"}),this.$el.data({view:this,model:this.model}),this.baton=t,i.point("io.ox/mail/mobile/detail").invoke("draw",this.$el,t),$('[data-page-id="io.ox/mail/detailView"]').trigger("header_ready"),this}})}}),define("io.ox/core/tk/list-dnd",["io.ox/core/extensions","io.ox/core/collection","gettext!io.ox/core","io.ox/core/tk/draghelper"],function(e,t,i){function o(e,t){return e=e.map(function(){return $.trim($(this).attr("title")||$(this).text())}),$.makeArray(e).join(t||"")}function n(e){return o(this.find(".selected .drag-title"),", ")||i.format(i.ngettext("1 item","%1$d items",e.length),e.length)}var a;return{enable:_.device("touch")?$.noop:function(i){function o(e){M=e.pageX+S,E=e.pageY+T,(N(D-M)>=5||N(A-E)>=5)&&(w.left=M+"px",w.top=E+"px",D=M,A=E)}function r(){y.trigger("selection:dragstart")}function s(){this.trigger("click")}function l(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(this).find(".folder-arrow:first");$(this).addClass("dnd-over"),t.length&&(clearTimeout(a),a=setTimeout(s.bind(t),1500))}}function d(){clearTimeout(a),$(this).removeClass("dnd-over")}function c(t){$("body").addClass("dragging"),$(document).off("mousemove.dnd",c);var n=b.reduce(function(e,t){var i=$(t).find(".drag-count");return e+(i.length?parseInt(i.text(),10):1)},0);C=$('<div class="drag-helper">'),e.point("io.ox/core/tk/draghelper").invoke("draw",C,new e.Baton({container:y,count:n||v.length,data:v,source:x,dragMessage:i.dragMessage})),w=C[0].style,D=A=M=E=0,o(t),C.appendTo(document.body),k=!0,$(document).one("mousemove.dnd",r).on("mousemove.dnd",o).on("mouseover.dnd",".folder-tree",F.over).on("mouseout.dnd",".folder-tree",F.out).on("mousemove.dnd",".folder-tree",F.move).on("mouseover.dnd",i.dropzoneSelector,l).on("mouseout.dnd",i.dropzoneSelector,d).on("keyup.dnd",p)}function u(){null!==C&&($("body").removeClass("dragging"),C.remove(),C=w=null)}function p(e){27===e.which&&f()}function f(){$("body").removeClass("dragging"),F.out(),$(document).off("mousemove.dnd mouseup.dnd mouseover.dnd mouseout.dnd keyup.dnd"),$(".dropzone").each(function(){var e=$(this),t=e.attr("data-dropzones");if(e.attr("data-delegate")&&t)return e.off("mouseup.dnd",t);(t?e.find(t):e).off("mouseup.dnd")}),$(".dnd-over").removeClass("dnd-over"),y.trigger("selection:dragstop"),null!==C&&u(),x=b=v=null}function h(t){if(!t.isDefaultPrevented()&&($("body").removeClass("dragging"),t.preventDefault(),clearTimeout(a),k)){var o=$(this).attr("data-model")||$(this).attr("data-id")||$(this).attr("data-cid")||$(this).attr("data-obj-id"),n=new e.Baton({data:v,dragType:i.dragType,dropzone:this,target:o});$(this).trigger("selection:drop",[n])}}function g(e){var t=Math.abs(e.pageX-e.data.x),i=Math.abs(e.pageY-e.data.y);(t>15||i>15)&&$(document).off("mousemove.dnd").on("mousemove.dnd",c)}function m(e){return 0===e.indexOf("folder.")?{folder_id:"folder",id:e.replace(/^folder./,"")}:_.cid(e.replace(/^thread./,""))}var v,x,b,w,y=(i=_.extend({container:$(),data:null,delegate:!1,draggable:!1,dragMessage:n,dragType:"",dropzone:!1,dropzoneSelector:".selectable",dropType:"",selection:null,selectable:".selectable",simple:!1},i)).container||$(),k=!1,C=null,S=15,T=15,D=0,A=0,M=0,E=0,N=Math.abs,F=function(){var e=0,t=null;return{move:function(t){e=t.pageY-$(this).offset().top},out:function(){clearInterval(t),t=null},over:function(){if(!t){var i,o,n,a=this.clientHeight;t=setInterval(function(){i=e<a/2?-1:1,(o=Math.min(e,a-e))>24||(n=o<8?3:1,this.scrollTop+=i*n)}.bind(this),5)}}}}();i.draggable&&y.on("mousedown.dnd",i.selectable,function(e){k=!1,x=$(this),b=_(y.find(".selected")),v=x.attr("data-drag-data")?[x.attr("data-drag-data")]:b.map(function(e){return $(e).attr("data-cid")});var i=new t(_(v).map(m));i.getProperties(),i.isResolved()&&!i.has("delete")||($(".dropzone").each(function(){var e=$(this),t=e.attr("data-dropzones");if(e.attr("data-delegate")&&t)return e.on("mouseup.dnd",t,h);(t?e.find(t):e).on("mouseup.dnd",h)}),$(document).on("mousemove.dnd",{x:e.pageX,y:e.pageY},g).on("mouseup.dnd",f),e.preventDefault())}),i.delegate&&y.attr("data-delegate",!0),i.dropzone&&(null===i.selection&&console.error("list-dnd: Selection required for dropzone!",i),y.addClass("dropzone").attr("data-dropzones",i.dropzoneSelector).on("drop",function(e,t){t.dropType=i.dropType,i.selection.trigger("selection:drop",t)}))}}}),define("io.ox/core/print",["io.ox/core/http","io.ox/core/notifications","gettext!io.ox/core"],function(e,t,i){function o(e){return(e||"").replace(/[#%&§/$*!`´'"=:@+^\\.+?{}|]/g,"_")}function n(e,t){var n="print_"+_.now();return window[n]=function(n){try{var a=e.selector||"script",r=$(n.body).find('[type="text/template"]').filter(a).html(),s=(e.title||"").trim();$(n.body).html('<div class="print-wrapper">'+$.trim(_.template(r)(t))+"</div>"),e.meta.classes&&$(n.body).addClass(e.meta.classes),n.title=o(ox.serverConfig.pageTitle||"")+o(s.length?" "+s:"")+" "+i("Printout")}catch(e){console.error(e)}},n}function a(){for(var e in s)s[e]&&s[e].closed&&(delete s[e],delete window[e])}var r={mail:"super-mail-template.tmpl",contacts:"super-contacts-template.tmpl",tasks:"super-tasks-template.tmpl"},s={},l={request:function(e,t){function o(){require([e]).then(function(i){_.isFunction(i.open)?i.open(t,n):console.error('Missing function "open" in:',e,i)},function(){console.error("Failed to load print manager")})}var n;return _.device("desktop")?(n=this.openURL(ox.base+"/busy.html"),o()):ox.load(["io.ox/backbone/views/modal"]).done(function(e){var t=$('<iframe frameborder="0" style="width:100%;height:100%;">').attr("src",ox.base+"/busy.html"),a=.9*window.innerHeight;new e({title:i("Print"),width:.9*window.innerWidth,height:a}).addCancelButton().addButton({label:i("Print"),action:"print"}).build(function(){a-=100,this.$body.css({height:a,maxHeight:a}).append(t)}).on("print",function(){n.print()}).open(),n=t[0].contentWindow,o()}),n},smart:function(o){(o=_.extend({get:$.noop,selection:[],i18n:{},file:ox.base+"/print.html",meta:{}},o)).selection=_.chain(o.selection).toArray().compact(),e.pause(),$.when.apply($,_.chain(o.selection).map(function(e){return _.isString(e)?e:_.cid(e)}).uniq().map(function(e,t){return o.get(_.cid(e)).then(function(e){return o.process?o.process(e,t,o):e})}).value()).done(function(){var e=_.chain(arguments).toArray(),t=e.value().length;o.filter&&(e=e.filter(o.filter)),o.sortBy&&(e=e.sortBy(o.sortBy)),e=e.value();var i=n(o,{data:e,i18n:o.i18n,meta:o.meta,length:e.length,filtered:t-e.length}),r=o.file+"?"+i;_.defer(function(){o.window?(o.window.location=r,s[i]=o.window):s[i]=l.openURL(r),a()})}).fail(function(){o.window&&o.window.close(),t.yell({type:"error",headline:i("Error"),message:i.ngettext("Cannot print this item","Cannot print these items",o.selection.length)})}),e.resume()},getWindowOptions:function(){var e={width:750,height:Math.min(screen.availHeight-100,1050),top:40};return e.left=(screen.availWidth-e.width)/2>>0,e.string="width="+e.width+",height="+e.height+",left="+e.left+",top="+e.top+",menubar=no,toolbar=no,location=no,scrollbars=yes,status=no",e},getWindow:function(e){var t="print_"+_.now(),i=this.getWindowOptions(e);return window.open(e,t,i.string)},open:function(e,t,i){var o,n={action:"get"};return"printCalendar"===e&&delete n.action,_.isArray(t)?n.data=JSON.stringify(t):_.isObject(t)&&(n.folder=t.folder_id||t.folder,n.id=t.id),n.format="template",n.template=r[e]||"default.tmpl",n.session=ox.session,o=ox.apiRoot+"/"+e+"?"+$.param(_.extend(n,i)),this.getWindow(o)},openURL:function(e){return this.getWindow(e||ox.base+"/blank.html")},interim:function(e){return console.warn("Temporary solution; replace by open()",e),this.openURL(e)}};return l}),define("io.ox/contacts/api",["io.ox/core/extensions","io.ox/core/http","io.ox/core/api/factory","io.ox/core/notifications","io.ox/core/cache","io.ox/contacts/util","io.ox/core/util","l10n/ja_JP/io.ox/collation","settings!io.ox/contacts","io.ox/core/capabilities"],function(e,t,i,o,n,a,r,s,l,d){function c(e){return require(["io.ox/core/api/user"]).then(function(t){return $.when(t.caches.get.remove({id:e.user_id}),t.caches.all.clear(),t.caches.list.remove({id:e.user_id}))})}function u(e,t){""!==e[t]&&void 0!==e[t]||delete e[t]}function p(e){return $.extend({},{width:_.device("retina")?2*e.width:e.width,height:_.device("retina")?2*e.height:e.height,scaleType:e.scaleType,user:ox.user_id,context:ox.context_id,sequence:!1!==e.sequence?e.sequence:void 0,uniq:!1!==e.uniq?x:void 0})}var f=function(e){return e.id?(e.birthday&&moment.utc(e.birthday).year()<=1&&(e.birthday=a.julianToGregorian(e.birthday)),e.anniversary&&moment.utc(e.anniversary).year()<=1&&(e.anniversary=a.julianToGregorian(e.anniversary)),e):(_(e).each(function(e){e.birthday&&moment.utc(e.birthday).year()<=1&&(e.birthday=a.julianToGregorian(e.birthday)),e.anniversary&&moment.utc(e.anniversary).year()<=1&&(e.anniversary=a.julianToGregorian(e.anniversary))}),e)},h=function(e,t){return t=t||{mode:"update"},_(e).each(function(i,o){""!==i&&void 0!==i||("update"===t.mode?e[o]=null:delete e[o])})},g=i({module:"contacts",requests:{all:{action:"all",folder:"6",columns:"ja_JP"===ox.locale?"20,1,101,555,556,557,607":"20,1,101,607",extendColumns:"io.ox/contacts/api/all",sort:"607",order:"asc",admin:function(){return l.get("showAdmin",!1)}},list:{action:"list",columns:"20,1,101,500,501,502,505,508,510,519,520,524,526,528,555,556,557,569,592,597,602,606,607,616,617,5,2",extendColumns:"io.ox/contacts/api/list"},get:{action:"get"},search:{action:"search",columns:"20,1,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607,616,617,5,2",extendColumns:"io.ox/contacts/api/list",sort:"609",getData:function(t,i){i=i||{},t+="*";var o={orSearch:!0,admin:l.get("showAdmin",!1),emailAutoComplete:!!i.emailAutoComplete},n=!0,a={names:{display_name:t,first_name:t,last_name:t,email1:t,email2:t,email3:t},addresses:{street_home:t,postal_code_home:t,city_home:t,state_home:t,country_home:t,street_business:t,postal_code_business:t,city_business:t,state_business:t,country_business:t,street_other:t,postal_code_other:t,city_other:t,state_other:t,country_other:t},phones:{telephone_business1:t,telephone_business2:t,telephone_home1:t,telephone_home2:t,telephone_other:t,fax_business:t,telephone_callback:t,telephone_car:t,telephone_company:t,fax_home:t,cellular_telephone1:t,cellular_telephone2:t,fax_other:t,telephone_isdn:t,telephone_pager:t,telephone_primary:t,telephone_radio:t,telephone_telex:t,telephone_ttytdd:t,telephone_ip:t,telephone_assistant:t}};return _(i).each(function(e,t){_(a).chain().keys().contains(t).value()&&"on"===e&&(o=_(o).extend(a[t]),n=!1)}),n&&(o=_(o).extend(a.names)),e.point("io.ox/contacts/api/search").invoke("getData",o,t,i),o}},advancedsearch:{action:"advancedSearch",columns:"20,1,101,500,501,502,505,520,524,555,556,557,569,592,602,606,607,616,617",extendColumns:"io.ox/contacts/api/list",sort:"607",getData:function(t,i){var o,n={names:"display_name first_name last_name yomiFirstName yomiLastName company yomiCompany email1 email2 email3".split(" "),addresses:"street_home postal_code_home city_home state_home country_home street_business postal_code_business city_business state_business country_business street_other postal_code_other city_other state_other country_other".split(" "),phones:"telephone_business1 telephone_business2 telephone_home1 telephone_home2 telephone_other fax_business telephone_callback telephone_car telephone_company fax_home cellular_telephone1 cellular_telephone2 fax_other telephone_isdn telephone_pager telephone_primary telephone_radio telephone_telex telephone_ttytdd telephone_ip telephone_assistant".split(" ")},a=["or"],r=!0;return i=i||{},t.indexOf("*")+t.indexOf("?")<-1&&(t="*"+t+"*"),_(i).each(function(e,i){_(n).chain().keys().contains(i).value()&&"on"===e&&(_(n[i]).each(function(e){a.push(["=",{field:e},t])}),r=!1)}),r&&_(n.names).each(function(e){a.push(["=",{field:e},t])}),o={filter:a},e.point("io.ox/contacts/api/search").invoke("getData",o,t,i),o}}},pipe:{get:function(e){return e.user_id&&(e.internal_userid=e.user_id),e&&e.distribution_list&&e.distribution_list.length&&"ja_JP"===ox.locale&&(_(e.distribution_list).each(function(e){e.email=e.mail,e.sort_name_without_mail=e.sort_name}),e.distribution_list.sort(s.sorterWithMail),_(e.distribution_list).each(function(e){_(e).omit("email","sort_name_without_mail")})),f(e)},all:function(e){if("ja_JP"===ox.locale)return _(e).each(function(e){e.email=e.email1||e.email2||e.email3||"",e.sort_name_without_mail=e.sort_name}),e.sort(s.sorterWithMail),_(e).each(function(e){_(e).omit("email","sort_name_without_mail")}),e;for(var t,i=0,o=0;t=e[i++];)""===t.sort_name&&o++;return o>0&&(e=e.slice(o).concat(e.slice(0,o))),e},list:function(e){return _(e).each(function(e){null===e.birthday&&delete e.birthday,null===e.distribution_list&&delete e.distribution_list}),e},listPost:function(e){return _(e).each(function(e){g.caches.get.dedust(e,"last_modified")}),g.trigger("list:ready"),e},search:f,advancedsearch:f}}),m=g.getList;g.getList=function(e,t,i){return!d.has("gab")&&i&&i.check&&_.isFunction(i.check)?_(e).any(function(e){return!i.check(e)})?(delete i.check,m.apply(this,arguments)):(new $.Deferred).resolve(e):m.apply(this,arguments)},g.create=function(e,i){u(e,"email1"),u(e,"email2"),u(e,"email3"),e.birthday&&moment.utc(e.birthday).local(!0).year()<=1&&(e.birthday=a.gregorianToJulian(e.birthday)),e.anniversary&&moment.utc(e.anniversary).local(!0).year()<=1&&(e.anniversary=a.gregorianToJulian(e.anniversary));var o,n={module:"contacts",data:e,appendColumns:!1,fixPost:!0};return e=h(e,{mode:"create"}),i?window.FormData&&i instanceof window.File?(o="UPLOAD",n.data=new FormData,n.data.append("file",i),n.data.append("json",JSON.stringify(e)),n.params={action:"new"}):(o="FORM",n.form=i,n.action="new"):(o="PUT",n.params={action:"new"}),t[o](n).then(function(t){return t=t.data||t,g.get({id:t.id,folder:e.folder_id})}).then(function(e){return $.when(g.caches.all.grepRemove(e.folder_id+g.DELIM),v.clear()).then(function(){return g.trigger("create",{id:e.id,folder:e.folder_id}),g.trigger("refresh.all"),e})})},g.update=function(e){var i=e.attachments,o=!1;return _.isEmpty(e.data)?i?$.when().then(function(){return g.trigger("update:"+_.ecid(e)),g.trigger("update",e),{folder_id:e.folder,id:e.id}}):$.when():(e.data.birthday&&moment.utc(e.data.birthday).local(!0).year()<=1&&(e.data.birthday=a.gregorianToJulian(e.data.birthday)),e.data.anniversary&&moment.utc(e.data.anniversary).local(!0).year()<=1&&(e.data.anniversary=a.gregorianToJulian(e.data.anniversary)),e.data=h(e.data,{mode:"update"}),(_(e.data).has("email1")||_(e.data).has("email2")||_(e.data).has("email3"))&&(o=!0),t.PUT({module:"contacts",params:{action:"update",id:e.id,folder:e.folder,timestamp:e.last_modified||_.then(),timezone:"UTC"},data:e.data,appendColumns:!1}).then(function(){return g.get({id:e.id,folder:e.folder},!1).then(function(t){return $.when(o?g.caches.get.clear():"",g.caches.get.add(t),o?g.caches.all.clear():g.caches.all.grepRemove(e.folder+g.DELIM),o?g.caches.list.clear():g.caches.list.remove({id:e.id,folder:e.folder}),v.clear(),t.user_id?c(t):"").done(function(){g.trigger("update:"+_.ecid(t),t),g.trigger("update",t),g.trigger("refresh.all"),""===e.data.image1&&(g.trigger("update:image",t),g.trigger("reset:image reset:image:"+_.ecid(t),t))})})}))},g.editNewImage=function(e,i,o){var n=function(t){return $.when(g.caches.get.clear(),g.caches.list.clear(),v.clear()).then(function(){g.trigger("refresh.list"),g.trigger("update:"+_.ecid(e)),g.trigger("update:image",{id:e.id,folder:e.folder_id})}),t};if("FormData"in window&&o instanceof window.File){var a=new FormData;return a.append("file",o),a.append("json",JSON.stringify(i)),t.UPLOAD({module:"contacts",params:{action:"update",id:e.id,folder:e.folder_id,timestamp:_.then()},data:a,fixPost:!0}).then(n)}return t.FORM({module:"contacts",action:"update",form:o,data:i,params:{id:e.id,folder:e.folder_id,timestamp:_.then()}}).then(n)},g.remove=function(e){return g.trigger("beforedelete",e),e=_.isArray(e)?e:[e],t.PUT({module:"contacts",params:{action:"delete",timestamp:_.then(),timezone:"UTC"},appendColumns:!1,data:_(e).map(function(e){return{folder:e.folder_id,id:e.id}})}).then(function(){return $.when(g.caches.all.clear(),g.caches.list.remove(e),v.clear())}).fail(function(e){o.yell("error",e.error)}).done(function(){_(e).map(function(e){g.trigger("delete:"+_.ecid(e),e),g.trigger("delete",e)}),g.trigger("refresh.all")})},g.on("refresh^",function(){g.caches.get.clear()}),g.on("refresh.all:import",function(){g.caches.list.clear(),v.clear(),g.caches.get.clear(),g.trigger("import"),g.trigger("refresh.all")});var v=new n.SimpleCache("contacts-fetching");g.clearFetchCache=function(){return v.clear()},g.getByEmailaddress=function(e){return e=e||"",v.get(e).then(function(i){return null!==i?i:""===e?{}:t.PUT({module:"contacts",params:{action:"search",admin:l.get("showAdmin",!1),columns:"20,1,500,501,502,505,520,555,556,557,569,602,606,524,592",timezone:"UTC"},sort:609,data:{email1:e,email2:e,email3:e,orSearch:!0,exactMatch:!0}}).then(function(t){return(t=t.filter(function(e){return!e.mark_as_distributionlist})).length?(t.sort(function(e,t){return t.image1_url?1:-1}),t.sort(function(e,t){return"6"===String(t.folder_id)?1:-1}),(t=t[0]).image1_url&&(t.image1_url=t.image1_url.replace(/^https?:\/\/[^/]+/i,""),t.image1_url=r.replacePrefix(t.image1_url),t.image1_url=r.getShardingRoot(t.image1_url)),v.add(e,t)):v.add(e,{})})})},g.getFallbackImage=function(e){return ox.base+"/apps/themes/"+ox.theme+"/fallback-image-"+(e||"contact")+".png"};var x=ox.t0;g.on("update:image",function(){x=_.now()}),g.pictureHalo=function(){function e(e,t){return g.looksLikeResource(e)?"resource":g.looksLikeGroup(e)||g.looksLikeDistributionList(e)?"group":_.isString(e.image1_url)&&""!==e.image1_url?"image_url":e.user_id||e.userid||e.userId||e.internal_userid?"user":(e.contact_id||e.id)&&(e.folder_id||e.folder)?"contact":e.mail||e.email||e.email1?"email":t.fallback?"fallback":void 0}function t(e,t,i){var o={};switch(i){case"user":o.user_id=e.user_id||e.userid||e.userId||e.internal_userid;break;case"contact":o.contact_id=e.contact_id||e.id,o.folder_id=e.folder_id||e.folder;break;case"email":o.email=e.email&&String(e.email).toLowerCase()||e.mail&&String(e.mail).toLowerCase()||e.email1&&String(e.email1).toLowerCase()}return o.sequence=e.last_modified||1,_.extend(o,p(t))}function i(e,t,i){return _.defer(function(){if(i.lazyload||i.container||_.first(e.closest(".scrollpane, .scrollable, .scrollpane-lazyload")))return i.fallback&&e.css("background-image","url("+n+")"),e.attr("data-original",t).on("load.lazyload error.lazyload",function(a,r){1===r.width||"error"===a.type?t=i.fallback?n:null:o[t]=t,t&&e.text("").attr("data-original",t).css("background-image","url("+t+")"),e=t=i=null,$(this).off(".lazyload")}).lazyload();$(new Image).on("load error",function(a){var r=1===this.width||"error"===a.type;r||(o[t]=t),r&&!i.fallback||e.text("").css("background-image","url("+(r?n:t)+")"),e=null,$(this).off()}).attr("src",t)}),e}var o={},n=g.getFallbackImage();return function(a,s,l){var d,c=_.extend({width:48,height:48,scaleType:"cover",lazyload:!1,effect:"show",urlOnly:!1,fallback:!0},l),u=e(s,_.pick(c,"fallback")),p=t(s,c,u);switch(s.facet&&s.facet.hasPersons()&&s.data.item&&(s.image1_url=s.data.item.image_url),u){case"resource":d=g.getFallbackImage("resource");break;case"group":d=g.getFallbackImage("group");break;case"image_url":d=s.image1_url=r.replacePrefix(s.image1_url)+"&"+$.param(p),d=r.getShardingRoot(d);break;case"fallback":d=n}if(d)return c.urlOnly?d:i(a,d,_.pick(c,"container","lazyload","fallback"));if(d=r.getShardingRoot("/contacts/picture?action=get&"+$.param(p)),o[d])return c.urlOnly?o[d]:a.text("").css("background-image","url("+o[d]+")");try{return c.urlOnly?d:i(a,d,c)}finally{s=a=c=p=null}}}(),g.getContactPhoto=function(e,t){t=_.extend({size:48,fallback:!1,initials:!0},t);var i=this.getContactPhotoUrl(e,t.size)||t.fallback&&g.getFallbackImage(),o=$('<div class="contact-photo" aria-hidden="true">');return!i&&t.initials&&o.text(a.getInitials(e)),i&&o.css("background-image","url("+i+")"),o.toggleClass("empty",!i),o},g.getContactPhotoUrl=function(e,t){var i={width:t,height:t,sequence:!1,uniq:!1};return e.image1_url?r.getShardingRoot(r.replacePrefix(e.image1_url)+"&"+$.param(p(i))):""},g.getDisplayName=function(e,t){t=_.extend({halo:!0,stringify:"getDisplayName",tagName:"a"},t);var i,o,n,r=e.display_name||"",s=$("<"+t.tagName+">").text(" "),l=e.email;return i=function(i){t.halo&&/@/.test(e.email)&&d.has("contacts")&&s.addClass("halo-link").attr("href","#").data({display_name:i,email1:l}),s.text(i+" ")},o=function(){_.defer(function(){s=i=o=n=t=null})},n=function(e){if(_.isArray(e)&&(e=e[0]),_.isString(e))return i(e);e&&(i(_.isEmpty(e)?r:a[t.stringify](e)),o())},e&&e.full_name?(n(e.full_name),o()):e&&(e.last_name||e.first_name)?(n(e),o()):g.getByEmailaddress(e.email).done(n).fail(o),s};var b=function(e,i,n){return e=_.isArray(e)?e:[e],t.pause(),_(e).map(function(e){return t.PUT({module:"contacts",params:{action:i||"update",id:e.id,folder:e.folder_id||e.folder,timezone:"UTC",timestamp:e.timestamp||_.then()},data:{folder_id:n},appendColumns:!1})}),t.resume().then(function(t){var i=$.Deferred();return _(t).each(function(e){e.error&&(o.yell(e.error),i.reject(e.error))}),"rejected"===i.state()?i:$.when.apply($,_(e).map(function(e){return $.when(g.caches.all.grepRemove(n+g.DELIM),g.caches.all.grepRemove(e.folder_id+g.DELIM),g.caches.list.remove({id:e.id,folder:e.folder_id}))}))}).done(function(){g.trigger("refresh.all")})};return g.move=function(e,t){return b(e,"update",t)},g.copy=function(e,t){return b(e,"copy",t)},g.birthdays=function(e){var i=_.now(),o=_.extend({action:"birthdays",start:i,end:i+6048e5,columns:"1,20,500,501,502,503,504,505,511",timezone:"UTC"},e||{});return t.GET({module:"contacts",params:o}).then(f)},g.looksLikeResource=function(e){return"mailaddress"in e&&"description"in e||"cuType"in e&&"RESOURCE"===e.cuType},g.looksLikeGroup=function(e){return"members"in e},g.looksLikeDistributionList=function(e){return!!e.mark_as_distributionlist},g.pendingAttachments={},g.autocomplete=function(){function e(e){return e.length>=s}function i(t){return(_(t.split(" ")).find(e)||"").substr(0,s)}function o(e){var t=i(e),o=r.cache[t],n=e.split(" ");if(o)return o.then(function(t){return _(t).filter(function(t){return _(n).every(function(i){var o=new RegExp("\\b"+a(i));return _(t.fulltext).some(function(t){return o.test(t)||t.indexOf(e)>-1})})})})}function n(e,t){var o=i(e);r.cache[o]=t.then(function(e){return _(e).map(function(e){return e.fulltext=_(d).map(function(t){return String(e[t]||"").toLowerCase()}),e.fulltext=_(e.fulltext).compact(),e})})}function a(e){return e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}function r(e,a){e=$.trim(e).toLowerCase();var r=(a=_.extend({admin:!1,email:!0,sort:"609",columns:"1,2,5,20,101,500,501,502,505,519,520,524,555,556,557,569,592,602,606,607",cache:!0,limit:0},a)).cache&&o(e);return r||(n(e,t.GET({module:"contacts",params:{action:"autocomplete",query:i(e),admin:a.admin,email:a.email,sort:a.sort,columns:a.columns,right_hand_limit:a.limit}})),o(e))}var s=Math.max(1,l.get("search/minimumQueryLength",3)),d=l.get("search/autocompleteFields","display_name,email1,email2,email3,first_name,last_name").split(",");return l.get("showDepartment")&&d.push("department"),r.cache={},r}(),g.on("create update delete",function(){g.trigger("maybeNewContact")}),g.on("maybeNewContact",function(){g.autocomplete.cache={}}),g}),define("io.ox/core/tk/flag-picker",["io.ox/mail/api","io.ox/core/folder/api","gettext!io.ox/mail","io.ox/backbone/mini-views/dropdown","less!io.ox/core/tk/flag-picker"],function(e,t,i,o){var n={NONE:i("None"),RED:i("Red"),BLUE:i("Blue"),GREEN:i("Green"),GRAY:i("Gray"),PURPLE:i("Purple"),LIGHTGREEN:i("Light green"),ORANGE:i("Orange"),PINK:i("Pink"),LIGHTBLUE:i("Light blue"),YELLOW:i("Yellow")},a={NONE:0,RED:1,BLUE:2,GREEN:3,GRAY:4,PURPLE:5,LIGHTGREEN:6,ORANGE:7,PINK:8,LIGHTBLUE:9,YELLOW:10},r={div:$("<div>"),list:$('<ul class="dropdown-menu" role="menu">'),listItem:$("<li>"),menuItemLink:$('<a href="#" role="menuitem" class="io-ox-action-link">'),flag:$('<span class="flag-example" aria-hidden="true">'),setColorLink:$('<a href="#">').attr("aria-label",i("Set color")),dropdownIcon:$('<i class="flag-dropdown-icon" aria-hidden="true">').attr("title",i("Set color"))},s={appendDropdown:function(e,t){e.addClass("dropdown-toggle"),e.parent().addClass("dropdown flag-picker");var i=r.list.clone().on("click","a",{data:t},s.change).append(_(a).map(function(e,t){return r.listItem.clone().append(r.menuItemLink.clone().append(e>0?r.flag.clone().addClass("flag_bg_"+e):$(),$.txt(n[t])).attr({"data-color":e,"data-action":"color-"+t.toLowerCase()}))}));new o({el:e.parent(),$toggle:e,$ul:i}).render()},draw:function(e,t){var o,n=t.data,a=Math.max(0,n.color_label||0);e.append(r.div.clone().append(o=r.setColorLink.clone().append(r.dropdownIcon.clone().attr({"data-color":a,title:i("Set color")}).addClass("flag_"+a+" "+(a?"fa fa-bookmark":"fa fa-bookmark-o"))))),this.appendDropdown(o,n),t.view&&t.view.listenTo(t.model,"change:color_label",this.update)},change:function(i){i.preventDefault();var o=i.data.data,n=$(i.currentTarget).attr("data-color")||"0",a=$(this).closest(".flag-picker");o=t.ignoreSentItems(o),e.changeColor(o,n),a.find(".dropdown-toggle").focus()},update:function(e){var t=Math.max(0,e.get("color_label")||0),i="flag-dropdown-icon ";i+=0===t?"fa fa-bookmark-o":"fa fa-bookmark",i+=" flag_"+t,this.$el.find(".flag-dropdown-icon").attr({class:i,"data-color":t})},attach:function(e,t){this.appendDropdown(e,t.data)},colorName:function(e){if(_.isNumber(e))return n[_.invert(a)[e]]}};return s}),define("io.ox/backbone/views/disposable",[],function(){var e=Backbone.View.extend({constructor:function(){Backbone.View.prototype.constructor.apply(this,arguments),this.$el.data("view",this),this.$el.on("dispose",function(){this.dispose(!0)}.bind(this))},dispose:function(e){e||this.$el.off().removeData(),this.trigger("dispose"),this.onDispose(),this.off().stopListening();for(var t in this)this.hasOwnProperty(t)&&(this[t]=null);this.disposed=!0},onDispose:function(){},listenToDOM:function(e,t,i){$(e).on(t,$.proxy(i,this)),this.on("dispose",function(){$(e).off(t,i)})}});return Backbone.DisposableView=e,e}),define("io.ox/backbone/views/extensible",["io.ox/backbone/views/disposable","io.ox/core/extensions"],function(e,t){function i(){return this.disableFormElements(),this.activeElement=this.activeElement||document.activeElement,this.$el.css("opacity",.5),this}function o(){return this.enableFormElements(),this.$el.css("opacity",""),$.contains(this.el,this.activeElement)&&$(this.activeElement).focus(),this.activeElement=null,this}var n={};return e.extend({constructor:function(n){this.options=n||{},this.point=t.point(this.point||this.options.point),e.prototype.constructor.apply(this,arguments),this.busy=i.bind(this),this.idle=o.bind(this),this.$el.attr("data-point",this.options.point),this.extensions&&this.extend(this.extensions)},extend:function(e){if(n[this.point.id])return this;ox.debug&&!this.point.id&&console.warn("Using extend on extensible view without point.id. Be sure this is what you want. Function will be called in every extensible view without point.id (most modal dialogs for example)");var t=100;return _(e).each(function(e,i){this.point.extend({id:i,index:t,render:e}),t+=100},this),this},invoke:function(e){var i=new t.Baton({view:this,model:this.model});return this.point.invoke(e||"render",this,i),n[this.point.id]=!0,this},inject:function(e){return _.extend(this,e)},build:function(e){return e.call(this),this},render:function(){return this.invoke("render")},disableFormElements:function(){this.$(":input").each(function(){"cancel"!==$(this).attr("data-action")&&$(this).toggleClass("disabled",$(this).prop("disabled")).prop("disabled",!0)})},enableFormElements:function(){this.$(":input").each(function(){$(this).prop("disabled",$(this).hasClass("disabled")).removeClass("disabled")})}})}),define("io.ox/backbone/mini-views/abstract",[],function(){return Backbone.View.extend({initialize:function(e){var t=this.options=e||{};void 0===t.validate&&(t.validate=!0),t.id&&!t.name&&(t.name=t.id),this.$el.on("dispose",function(e){this.dispose(e)}.bind(this)),this.$el.data("view",this),this.model&&t.name&&(this.name=t.name,this.listenTo(this.model,"valid:"+t.name,this.valid),this.listenTo(this.model,"invalid:"+t.name,this.invalid)),this.setup&&this.setup(t)},valid:function(){this.$el.trigger("valid")},invalid:function(e,t){this.$el.trigger("invalid",[e,t])},dispose:function(){this.stopListening(),this.model=null}})}),define("io.ox/backbone/mini-views/dropdown",["io.ox/backbone/mini-views/abstract","io.ox/core/a11y"],function(e,t){function i(e){return _.isFunction(e)?e():_.isObject(e)?e:$.txt(e)}function o(e,t){return e.addClass("checkbox-color color-flags-no-checkbox").css("background-color",t)}return e.extend({tagName:"div",className:"dropdown",events:{"shown.bs.dropdown":"onShown","hidden.bs.dropdown":"resetDropdownOverlay",'keydown *[data-toggle="dropdown"]':"onKeyDown",ready:"onReady",contextmenu:"onContextMenu"},onContextMenu:function(e){e.preventDefault()},onReady:function(){_.device("smartphone")&&!this.options.dontProcessOnMobile||(!1!==this.smart||this.$overlay)&&this.$el.hasClass("open")&&(this.$ul.css({width:"auto",height:"auto"}),this.adjustBounds())},resetDropdownOverlay:function(){$(document).trigger("click.bs.dropdown.data-api"),this.$overlay&&(this.$ul.removeAttr("data-original-id"),this.$placeholder.before(this.$ul).detach(),this.$el.removeClass("open"),this.$ul.attr("style",this.$ul.data("style")||"").removeData("style"),this.$overlay.remove(),this.$toggle.attr("aria-expanded",!1),delete this.$overlay,this.lastEvent&&9===this.lastEvent.which&&(this.lastEvent.shiftKey?t.getPreviousTabbable(this.$toggle).focus():t.getNextTabbable(this.$toggle).focus(),delete this.lastEvent))},setDropdownOverlay:function(){var e=this;this.$overlay=$('<div class="smart-dropdown-container dropdown open" role="navigation">',this.onReady.bind(this)).addClass(this.$el.prop("className")),this.$ul.data("style",this.$ul.attr("style")),this.adjustBounds(),this.$ul.attr("data-original-id",this.$placeholder.attr("id")),this.$ul.before(this.$placeholder).detach(),$("body").append(this.$overlay.append($('<div class="abs">').on("mousewheel touchmove",!1).on("click contextmenu",function(t){return t.stopPropagation(),e.resetDropdownOverlay(),!1}),this.$ul))},adjustBounds:function(){var e=this.$ul.get(0).getBoundingClientRect(),t={top:parseInt(this.$ul.css("margin-top")||0,10),left:parseInt(this.$ul.css("margin-left")||0,10)},i={top:e.top-t.top,left:e.left-t.left,width:e.width,height:"auto"},o=this.$toggle.offset(),n=this.$toggle.outerWidth(),a=$(window).width(),r=$(window).height(),s=$("#io-ox-appcontrol");e.top+e.height>r-this.margin?(o.left+n+e.width+this.margin<a?i.left=o.left+n+this.margin:i.left=o.left-e.width-this.margin,i.top=r-this.margin-e.height,i.top=Math.max(i.top,s.offset().top+s.height()+this.margin),i.height=e.height,i.height=Math.min(r-this.margin-i.top,i.height)):(11===_.browser.IE&&(i.bottom="auto"),i.left=Math.max(this.margin,i.left),i.left=Math.min(a-i.width-this.margin,i.left)),this.$toggle.data("fixed")&&(i.left=e.left),this.$ul.css(i)},onShown:function(){!1!==this.smart&&(_.device("smartphone")&&!this.options.dontProcessOnMobile||this.setDropdownOverlay())},onKeyDown:function(e){if(this.$el.hasClass("open")&&this.$overlay){var i=t.getTabbable(this.$ul);40===e.which&&i.first(":visible").focus(),38===e.which&&i.last(":visible").focus(),27===e.which&&(this.$toggle.trigger("click"),e.stopImmediatePropagation(),e.preventDefault())}},onKeyDownMenu:function(e){9===e.which&&(this.lastEvent=e)},open:function(){this.$el.hasClass("open")||this.$overlay||this.$toggle.trigger("click")},close:function(){(this.$el.hasClass("open")||this.$overlay)&&this.$toggle.trigger("click")},onClick:function(e){var t=$(e.currentTarget),i=t.attr("href"),o=t.attr("data-name"),n=t.data("value"),a=t.data("toggle-value"),r=t.data("toggle"),s=this.options.keep||"true"===t.attr("data-keep-open");if(!(i&&0!==i.length&&"#"!==i||(e.preventDefault(),s&&e.stopPropagation(),t.hasClass("disabled")))){if(!e.isPropagationStopped()&&this.$overlay&&this.$placeholder&&!this.options.noDetach){var l=$('<div class="hidden">');t.before(l).detach(),this.$placeholder.append(t),this.$el.trigger(_.extend({},e,{type:"mousedown"})),this.$el.trigger("track",e.currentTarget),this.$el.trigger(e),l.replaceWith(t)}if(this.trigger("click",t.data()),this.model&&(this.options.allowUndefined||void 0!==n)){var d=n;r&&(d=void 0===a?!this.model.get(o):this.model.get(o)===n?a:n),this.options.saveAsArray&&(d=[d]),this.model.set(o,d)}}},setup:function(){this.$ul=this.options.$ul||this.$ul||$('<ul class="dropdown-menu" role="menu">'),this.$placeholder=$('<div class="hidden">').attr("id",_.uniqueId("dropdown-placeholder-")),this.smart=this.options.smart,this.margin=this.options.margin||8,this.$ul.on("click","a",$.proxy(this.onClick,this)),this.$ul.on("keydown","a",$.proxy(this.onKeyDownMenu,this)),this.model&&this.listenTo(this.model,"change",this.options.update||this.update),this.options.dontProcessOnMobile&&(this.$el.attr("dontProcessOnMobile",!0),this.$ul.attr("dontProcessOnMobile",!0))},update:function(){var e=this.$ul;this.model&&(_(this.model.changed).each(function(t,i){var n=e.find('[data-name="'+i+'"]');n.children("i").each(function(e,t){var i=$(t),n=i.data("color");i.removeClass("fa-check").addClass("fa-none"),n&&o(i,n)}),n.each(function(){var e=$(this);e.filter("[role=menuitemcheckbox][aria-checked]").attr({"aria-checked":_.isEqual(e.data("value"),t)}),_.isEqual(e.data("value"),t)&&e.children("i").each(function(e,t){var i=$(t),n=i.data("color");i.removeClass("fa-none").addClass("fa-check"),n&&o(i,n)})})},this),this.label())},label:function(){},stringify:function(e){return _.isObject(e)?JSON.stringify(e):e},append:function(e,t){return(t&&t.group?this.$ul.find('[role="group"]:last'):this.$ul).append($('<li role="presentation">').append(e)),this},option:function(e,t,i,n){n=_.extend({prefix:"",toggleValue:void 0,radio:!1},n);var a=this.model?this.model.get(e):void 0,r=_.isEqual(a,t),s=n.radio?"menuitemradio":"menuitemcheckbox",l=_.isFunction(i)?$("<div>").append(i()).text():i,d=n.prefix?[n.prefix,l].join(" "):void 0,c=$('<i class="fa fa-fw" aria-hidden="true">').addClass(r?"fa-check":"fa-none"),u=$('<a href="#" draggable="false">').attr({role:s,"aria-checked":r,"data-keep-open":!!n.keepOpen||void 0,"data-name":e,"data-value":this.stringify(t),"data-toggle":_.isBoolean(t)||void 0!==n.toggleValue,"data-toggle-value":n.toggleValue,"aria-label":d,title:n.title,tabindex:"-1"});return n.color&&u.addClass("color-flag"),u.on("dragstart",!1).data("value",t).append(n.color?o(c,n.color).attr({"data-color":n.color,"data-color-label":n.color}):c,_.isFunction(i)?i():$.txt(i)),this.append(u,_.pick(n,"group"))},forceOpen:function(e){this.$el.attr("forceOpen",e)},link:function(e,t,i,o){o=o||{};var n=$('<a href="#" draggable="false" role="menuitem" tabindex="-1">').attr("data-name",e).on("dragstart",!1).append(o.icon?$('<i class="fa fa-fw" aria-hidden="true">'):$(),$.txt(t));return o.data&&n.data(o.data),i&&n.on("click",{},i),this.append(n)},header:function(e){return this.$ul.append($('<li class="dropdown-header" role="separator">').append($('<span aria-hidden="true">').text(e))),this},group:function(e,t){return this.header(e),this.$ul.append($('<div role="group">').attr("aria-label",e).append(t)),this},divider:function(){return this.$ul.append('<li class="divider" role="separator">'),this},render:function(){$(this.$el,function(){this.trigger("ready")}.bind(this));var e=i(this.options.label),t=this.options.aria?this.options.aria:null,o='<a href="#" draggable="false">';return _.isString(e)&&(t+=" "+e),this.options.buttonToggle&&(o='<button type="button" draggable="false" class="btn btn-link">'),this.$el.append(this.$toggle=this.options.$toggle||this.$toggle||$(o).attr({"aria-label":t,"data-action":this.options.dataAction,title:this.options.title||null,ondragstart:_.device("firefox")?"return false;":null}).append($('<span class="dropdown-label">').append(e),this.options.caret?$('<i class="fa fa-caret-down" aria-hidden="true">'):[]),this.$ul),this.label(),this.ensureA11y(),this},ensureA11y:function(){var e=this.$ul.children("li");this.$toggle.attr({"aria-haspopup":!0,"aria-expanded":!1,"data-toggle":"dropdown"}),this.$toggle.is("a")&&this.$toggle.attr("role","button"),this.options.tabindex&&this.$toggle.attr("tabindex",this.options.tabindex),this.$ul.not("[role]").attr({role:"menu"}),e.filter(":not([role])").attr({role:"presentation"}),e.find("a:not([role])").attr({role:"menuitem",tabindex:"-1"})},prepareReuse:function(){return this.$toggle&&this.$toggle.remove(),this.$ul&&this.$ul.empty(),this},dispose:function(){this.$overlay&&this.$overlay.remove(),e.prototype.dispose.call(this,arguments)}})}),define("io.ox/backbone/mini-views/toolbar",["io.ox/backbone/views/disposable","io.ox/core/a11y","gettext!io.ox/core"],function(e,t,i){return e.extend({className:"classic-toolbar-container",events:{"mousedown ul.classic-toolbar > li > a":"onMousedown"},initialize:function(e){this.options=_.extend({tabindex:0},e),this.$list=this.createToolbar()},createToolbar:function(){return $('<ul class="classic-toolbar" role="toolbar">').attr({"aria-label":this.options.title?i("%1$s toolbar. Use cursor keys to navigate.",this.options.title):i("Actions. Use cursor keys to navigate.")}).on("click","a",$.preventDefault)},render:function(){return this.$el.append(this.$list),this},getButtons:function(){return this.$el.find("ul.classic-toolbar > li > a").not(":hidden")},disableButtons:function(){return this.getButtons().off().tooltip("hide").tooltip("disable"),this},replaceToolbar:function(e){var t;if($.contains(this.el,document.activeElement)){var i=$(document.activeElement),o=i.data("action");t=o?'*[data-action="'+o+'"]':">> li:eq("+i.closest("li").index()+") "+i.prop("tagName")+":first"}return e.append(e.children(".pull-right")),this.$el.find("ul.classic-toolbar").tooltip("hide").replaceWith(e),t&&this.$(t).focus(),this},initButtons:function(){this.$links=this.getButtons().attr({role:"button",tabindex:-1}),this.$links.first().attr({tabindex:this.options.tabindex})},onMousedown:function(e){this.$links.attr("tabindex",-1),$(e.currentTarget).attr("tabindex",this.options.tabindex)}})}),define("io.ox/backbone/mini-views/helplink",["settings!io.ox/core","gettext!io.ox/core"],function(e,t){return Backbone.View.extend({tagName:"a",className:"io-ox-context-help",events:{click:"onClick"},onClick:function(e){e.preventDefault();var t=this.options.href,i=this.options;require(["io.ox/help/main"],function(e){i.simple?window.open(e.getAddress(i),"_blank"):e.reuse(i)||e.getApp(i).launch()}),!1!==i.metrics&&require(["io.ox/metrics/main"],function(e){e.isEnabled()&&(e.trackPage({id:"io.ox/help"}),e.trackEvent({app:"core",target:"toolbar",type:"click",action:"help",detail:t.substr(t.lastIndexOf("#")+1)}))})},initialize:function(i){this.options=_.extend({base:"help",content:$('<i class="fa" aria-hidden="true">').attr("title",t("Online help")),href:"index.html",iconClass:"fa-question-circle",modal:!1},i),_.isString(this.options.content)||this.options.content.addClass(this.options.iconClass),e.get("features/showHelpLinks",!0)||this.$el.addClass("hidden")},render:function(){return this.$el.hasClass("hidden")?this:(this.$el.append(this.options.content).attr({href:"#",target:"_blank","aria-label":t("Online help")}),this)}})}),define("io.ox/backbone/mini-views/upsell",["io.ox/core/upsell","settings!io.ox/core"],function(e,t){return Backbone.View.extend({tagName:"div",events:{"click a":"onClick"},onClick:function(t){t.preventDefault(),e.trigger({type:"custom",id:this.opt.id,missing:e.missing(this.opt.requires)})},initialize:function(i){this.opt=_.extend({icon:t.get("upsell/defaultIcon","fa-star"),enabled:!0},i,t.get("features/upsell/"+i.id),t.get("features/upsell/"+i.id+"/i18n/"+ox.language)),/^folderview\//.test(i.id)&&(this.setElement('<li role="presentation">'),this.$el.addClass(this.className)),this.$el.addClass("io-ox-upsell-link"),this.customize=this.opt.customize,this.icon=this.opt.icon,this.visible=this.opt.enabled&&!e.has(this.opt.requires)&&e.enabled(this.opt.requires)},render:function(){if(this.visible){var e=this,t=$('<a href="#">').css("color",this.opt.color).text(this.opt.title).append(_(this.icon.split(/ /)).map(function(t,i){if(""!==t)return $('<i class="fa" aria-hidden="true">').addClass(t).css({"margin-left":0===i&&e.opt.title&&e.opt.title.length>0?"0.5em":"",color:e.opt.color})}));/^folderview\//.test(this.opt.id)&&t.attr("role","treeitem"),this.$el.append(t),this.customize&&_.isFunction(this.customize)&&this.customize()}else this.$el.hide();return this}})}),define("io.ox/backbone/mini-views/quota",["gettext!io.ox/core","io.ox/core/api/quota","io.ox/core/strings","io.ox/backbone/mini-views/upsell","io.ox/core/capabilities","settings!io.ox/mail"],function(e,t,i,o,n,a){return Backbone.View.extend({tagName:"div",initialize:function(e){this.options=_.extend({module:"mail",quotaField:"quota",usageField:"use",renderUnlimited:!0,sizeFunction:function(e){return i.fileSize(e,"smart")},upsellLimit:-1},e),this.$el.addClass("io-ox-quota-view"),t.mailQuota.on("change",this.updateQuota.bind(this)),t.fileQuota.on("change",this.updateQuota.bind(this)),this.$el.hide()},close:function(){t.mailQuota.off("change",this.updateQuota),t.fileQuota.off("change",this.updateQuota)},getQuota:function(e){var i=this.options,o=i.module,n=i.quotaField,a=i.usageField;return!e&&i.quota&&i.usage?$.when({quota:i.quota,usage:i.usage}):(e&&("file"===i.module&&t.requestFileQuotaUpdates(),t.reload()),t.load().then(function(e){return{quota:e[o][n],usage:e[o][a]}}))},updateQuota:function(){var e=this.options,i=t.getModel(e.module).toJSON();void 0!==i[e.quotaField]&&void 0!==i[e.usageField]&&(e.quota=i[e.quotaField],e.usage=i[e.usageField],this.render())},renderTitle:function(t){var i;this.$el.append($('<div class="quota-description">').append($('<div class="title">').text(this.options.title),i=$('<div class="numbers">'))),t.quota<=0?i.text(e("mail"!==this.options.module||a.get("folder/inbox")?"unlimited":"unknown")):i.text(t.usage<t.quota?e("%1$s of %2$s",this.options.sizeFunction(t.usage),this.options.sizeFunction(t.quota)):e("100%"))},renderBar:function(e){if(!(e.quota<=0)){var t=Math.max(5,Math.min(100,Math.round(e.usage/e.quota*100)));e.quota||(t=100),e.usage||(t=0),this.$el.append($('<div class="progress">').append($('<div class="progress-bar">').css("width",t+"%").addClass(t<90?"default":"bar-danger")))}},renderUpsell:function(e){if(this.options.upsell){var t=new o(this.options.upsell),i=t.opt.upsellLimit||this.options.upsellLimit;i<=0||e.quota>=i||this.$el.append(t.render().$el)}},render:function(){return n.has("guest")?this:(this.getQuota().done(function(e){_.isUndefined(e.quota)||_.isUndefined(e.usage)||!this.options.renderUnlimited&&e.quota<=0||(this.$el.empty(),this.renderTitle(e),this.renderBar(e),this.renderUpsell(e),this.$el.show())}.bind(this)),this)}})}),define("io.ox/core/tk/upload",["io.ox/core/event","io.ox/core/extensions","io.ox/core/notifications","io.ox/core/folder/api","io.ox/core/api/filestorage","gettext!io.ox/core","less!io.ox/core/tk/upload.less"],function(e,t,i,o,n,a){function r(e){return e.originalEvent&&e.originalEvent.dataTransfer&&(_.browser.Firefox&&"dragleave"!==e.type?"none"!==e.originalEvent.dataTransfer.dropEffect:"none"===e.originalEvent.dataTransfer.dropEffect)&&(_(e.originalEvent.dataTransfer.types).contains("Files")||_(e.originalEvent.dataTransfer.types).contains("application/x-moz-file"))}function s(t){require(["less!io.ox/core/tk/upload"]);var o,n,s=this,l=$('<div class="abs io-ox-dropzone-multiple-overlay">').on("click",c),d=function(e){if(r(e)&&!($("body > .io-ox-dialog-wrapper").length>0))return clearTimeout(n),$("body").addClass("io-ox-dropzone-active").append(l),!1},c=function(){return $("body").removeClass("io-ox-dropzone-active"),l.detach(),!1},u=function(){var e=$('<div class="io-ox-dropzone-action">');return l.append(e),e};e.extend(this),_(t.actions||[]).each(function(e){var n=u();n.append($('<div class="dropzone">').on({dragenter:function(){o&&o.removeClass("io-ox-dropzone-hover"),o=n,n.addClass("io-ox-dropzone-hover")},dragleave:function(e){_.browser.IE?$(e.target).hasClass("dropzone")||$(e.target).hasClass("dndignore")||n.removeClass("io-ox-dropzone-hover"):n.removeClass("io-ox-dropzone-hover")},drop:function(n){var r,l=(n=n.originalEvent||n).dataTransfer.files;if(o&&o.removeClass("io-ox-dropzone-hover"),_.browser.Chrome&&_.browser.Chrome>21){var d=n.dataTransfer.items;for(r=0;r<d.length;r++)if(d[r].webkitGetAsEntry().isDirectory)return i.yell("error",a("Uploading folders is not supported.")),c(n),!1}if("importEML"===t.actions[0].id)for(r=0;r<l.length;r++)if(!/(\.eml)$/i.test(l[r].name))return i.yell("error",a("Mail was not imported. Only .eml files are supported.")),c(n),!1;for(r=0;r<l.length;r++)"mailAttachment"===t.actions[0].id?s.trigger("drop",l[r]):s.trigger("drop",e.id,l[r],e);return s.trigger("drop-multiple",e,$.makeArray(l)),c(n),!1}}).append($('<span class="dndignore">').html(e.label)))});var p=!1;this.remove=function(){p&&(p=!1,$(document).off("dragenter",d).off("drop",c),l.off("dragenter dragover dragend dragleave drop"))},this.include=function(){p||(p=!0,$(document).on("dragenter",d),l.on({dragenter:function(){return clearTimeout(n),!1},dragover:function(e){return clearTimeout(n),e.preventDefault(),!1},dragleave:function(e){n=setTimeout(function(){c(e)},200),e.stopPropagation()},drop:function(e){return e.preventDefault(),c(e),!1}}))}}function l(){this.enabled=!1,this.bind=$.noop,this.unbind=$.noop,this.remove=$.noop,this.include=$.noop}function d(t){t?t.progress||console.warn('The delegate to a queue should implement a "progress" method!'):console.warn("No delegate supplied to file processing queue."),t=_.extend({start:$.noop,stop:$.noop,changed:$.noop,progress:function(){return $.when()},type:!1},t||{}),e.extend(this);var n=[],a=0,r=!1;this.next=function(){if(!r){if(0===n.length||n.length<=a)return this.stop();r=!0;var e=this;0===a&&this.start(),this.progress().always(function(t){t&&t.error&&(/^(FLS-0024|OX-0023|OX-0507)$/.test(t.code)||t.error_params&&t.error_params.length&&/^429 /.test(t.error_params[0]))?e.stop():(r=!1,a++,e.queueChanged())})}},this.validateFiles=function(e,n){return n.folder&&"importEML"!==t.type?o.get(n.folder).then(function(t){return o.is("infostore",t)?require(["io.ox/core/api/quota"]).then(function(i){return i.checkQuota(t,e)}):$.when([])}).then(function(t){return 0===t.length?[]:require(["io.ox/core/tk/upload-problems"]).then(function(i){return i.report(e,t)})},function(e){return i.yell(e),$.Deferred().reject([e])}):$.when([])},this.offer=function(e,t){var i=this,o=[].concat(e);this.validateFiles(o,t).then(function(){_(o).each(function(e){n.push({file:e,options:t})}),i.queueChanged()})},this.length=0,this.remove=function(e){n.splice(e,1),e===a&&a--},this.queueChanged=function(){this.length=n.length,t.changed(n[a],a,n),this.trigger("changed",n[a],a,n),this.next()},this.dump=function(){console.info("this",this,"file",n[a],"position",a,"files",n)},this.start=function(){ox.autoLogout.stop(),t.start(n[a],a,n),this.trigger("start",n[a],a,n)},this.progress=function(){var e=t.progress(n[a],a,n);return this.trigger("progress",e,n[a],a,n),e},this.stop=function(){ox.autoLogout.start(),t.stop(n[a],a,n),this.trigger("stop",n[a],a,n),n=[],a=0,r=!1}}var c=Backbone.DisposableView.extend({className:"abs dropzone-overlay",initialize:function(e){require(["less!io.ox/core/tk/upload"]),this.options=_.extend({point:"",app:void 0,scrollable:".scrollable"},e),this.actions=[];var i=t.point(e.point);i.each(function(e){i.isEnabled(e.id)&&this.actions.push(e)}.bind(this)),this.listenToDOM(document,"dragover",this.toggleOverlay.bind(this,!0)),this.listenToDOM(document,"dragleave drop mouseout",this.toggleOverlay.bind(this,!1))},events:{dragenter:"onDragEnter",dragover:"onDragOver",dragleave:"onDragLeave",drop:"onDrop"},toggleOverlay:function(e,t){"mouseout"!==t.type&&this.$el.hasClass("locked")||(r(t)||this.$el.hasClass("visible"))&&this.$el.toggleClass("visible",e).css(this.getDimensions())},getDimensions:function(){var e=this.$el.closest(this.options.scrollable),t=e.scrollTop(),i=e.outerHeight(),o=e.children().outerHeight();return{top:t,bottom:Math.max(0,o-i-t)}},show:function(){this.$(".dropzone-floating").addClass("visible"),this.$el.closest(this.options.scrollable).addClass("scrollable-disabled")},hide:function(){this.$el.removeClass("locked"),this.$(".dropzone-floating").removeClass("visible"),this.$el.closest(this.options.scrollable).removeClass("scrollable-disabled")},render:function(){return this.$el.append($('<div class="abs dropzone-floating">').append(_.map(this.actions,function(e){return $('<div class="dropzone-floating-action dropzone">').attr({"data-id":e.id}).append($('<span class="dndignore">').html(e.label))}))),this},onDragEnter:function(e){if(($(e.target).hasClass("dndignore")?$(e.target).parent():$(e.target)).addClass("hover"),$(e.target).hasClass("dropzone-overlay")){if(!r(e))return;return $(e.target).addClass("locked"),this.show()}$(e.target).hasClass("dropzone-floating")&&(!r(e)||$("body > .io-ox-dialog-wrapper").length>0||this.show())},onDragLeave:function(e){($(e.target).hasClass("dndignore")?$(e.target).parent():$(e.target)).removeClass("hover"),_.defer(function(){this.$(".hover").length||this.$el.hasClass("hover")||this.hide()}.bind(this))},onDrop:function(e){var t,o=(e=e.originalEvent||e).dataTransfer.files,n=$(e.target).closest(".dropzone-floating-action").attr("data-id"),r=_.findWhere(this.actions,{id:n});if(!r)return this.hide();if(_.browser.Chrome){var s=e.dataTransfer.items;for(t=0;t<s.length;t++)if(s[t].webkitGetAsEntry().isDirectory)return i.yell("error",a("Uploading folders is not supported.")),!1}return r.action&&_.each(o,function(e){r.action.apply(r.extension,[e].concat(this.options.app))}.bind(this)),r.multiple&&r.multiple.apply(r.extension,[o].concat(this.options.app)),this.hide(),!1},onDragOver:function(e){return e.preventDefault(),!1}});return{dnd:{enabled:_.device("!touch"),createDropZone:function(e){return e=e||{},this.enabled?new s(e):new l(e.node)},FloatingDropzone:c},createQueue:function(e){return new d(e)}}}),define("io.ox/core/dropzone",[],function(){var e="dragenter dragover dragleave drop",t=_.throttle(function(t){if($("html").hasClass("dndmask-enabled")!==t){if($("html").toggleClass("dndmask-enabled",t),!t)return $(".dndmask").remove();$("iframe:visible").each(function(){var t=_.uniqueId("overlay-"),i=$(this).attr("data-overlay",t).before($('<div id="'+t+'" class="dndmask">').on(e,function(e){var t=$.Event(e.type,{offsetX:e.offsetX,offsetY:e.offsetY});$("body",i.contents()).trigger(t)}))})}},100);ox.on("drag:start",_.partial(t,!0)),ox.on("drag:stop",_.partial(t,!1));var i=Backbone.View.extend({className:"inplace-dropzone",events:{drop:"onDrop","dragenter .dropzone-overlay":"onDragenter","dragover .dropzone-overlay":"onDragover","dragleave .dropzone-overlay":"onDragleave"},onLeave:function(e){this.leaving&&(ox.trigger("drag:stop",this.cid),this.hide(e))},onDrag:function(e){if(this.$el.parent().is(":visible")&&this.isSupported())switch(e.type){case"dragenter":case"dragover":if(ox.trigger("drag:start",this.cid),this.stop(e),this.leaving=!1,this.checked)return;if(this.checked=!0,!this.isValid(e))return;return this.visible||this.show(),!1;case"dragleave":this.leaving=!0,clearTimeout(this.timeout),this.timeout=setTimeout(this.onLeave.bind(this),100,e);break;case"drop":return ox.trigger("drag:stop",this.cid),this.stop(e),this.hide(),!1}},isSupported:_.constant(!0),stop:function(e){e.preventDefault(),e.stopPropagation()},show:function(){this.visible=!0,this.$el.show(),this.trigger("show"),$(window).trigger("resize")},hide:function(){this.visible=this.checked=!1,this.$el.hide().removeClass("dragover"),this.trigger("hide")},initialize:function(t){this.options=t,this.checked=!1,this.visible=!1,this.leaving=!1,this.timeout=-1,this.eventTarget=t.eventTarget,this.onDrag=this.onDrag.bind(this),$(document).on(e,this.onDrag),_.device("firefox")&&(this.onMouseenter=this.onMouseenter.bind(this),$(document).on("mouseenter",this.onMouseenter)),this.eventTarget&&(this.eventTargetDocument="#document"===this.eventTarget.prop("nodeName")?this.eventTarget.get(0):this.eventTarget.prop("ownerDocument"),this.eventTargetDocument!==document&&$(this.eventTargetDocument).on(e,this.onDrag),this.onDrop=this.onDrop.bind(this),this.onDragenter=this.onDragenter.bind(this),this.onDragover=this.onDragover.bind(this),this.onDragleave=this.onDragleave.bind(this),this.eventTarget.on("drop",this.onDrop).on("dragenter",this.onDragenter).on("dragover",this.onDragover).on("dragleave",this.onDragleave)),this.$el.on("dispose",function(e){this.dispose(e)}.bind(this))},isValid:function(e){return _.isFunction(this.isEnabled)?this.isEnabled(e)&&this.isFile(e):this.isFile(e)},isEnabled:!0,isFile:function(e){var t=e.originalEvent.dataTransfer;return _(t.types).contains("Files")||_(t.types).contains("application/x-moz-file")},filterDirectories:function(e){var t=new $.Deferred,i=_(e.files).toArray();if(_.browser.Chrome&&_.browser.Chrome>21||_.browser.firefox&&_.browser.firefox>=50||_.browser.edge){var o=e.items;t.resolve(_(i).filter(function(e,t){return!o[t].webkitGetAsEntry().isDirectory}))}else $.when.apply(this,_(i).map(function(e){if(!e.type&&e.size<=16384){var t=new $.Deferred,i=new FileReader;return i.onloadend=function(){t.resolve(i.error)},i.readAsDataURL(e),t}return $.when()})).done(function(){var e=arguments;t.resolve(_(i).filter(function(t,i){return!e[i]}))});return t},getFiles:function(e){var t=e.originalEvent.dataTransfer,i=t.files.length,o=this.options.filter;return this.filterDirectories(t).then(function(e){return e.length&&i===e.length||0===i||require(["io.ox/core/yell","gettext!io.ox/core"],function(e,t){e("error",t("Uploading folders is not supported."))}),_.isRegExp(o)?_(e).filter(function(e){return o.test(e.name)}):e})},onDragenter:function(e){$(e.currentTarget).parent().addClass("dragover")},onDragover:function(e){e.originalEvent.dataTransfer.dropEffect="copy"},onDragleave:function(e){$(e.currentTarget).parent().removeClass("dragover")},onMouseenter:function(e){this.visible&&(e.relatedTarget||e.toElement||_.delay(function(){this.leaving=!0,clearTimeout(this.timeout),this.onLeave(e)}.bind(this),50))},onDrop:function(e){var t=this;this.getFiles(e).then(function(i){t.trigger(i.length>0?"drop":"invalid",i,e)},function(){t.trigger("invalid",[],e)})},render:function(){return this.$el.hide().append($('<div class="abs dropzone-caption">').text(this.options.caption||""),$('<div class="abs dropzone-dragover"><i class="fa fa-check" aria-hidden="true"></i></div>'),$('<div class="abs dropzone-overlay">')),this},dispose:function(){this.stopListening(),$(document).off(e,this.onDrag),_.device("firefox")&&$(document).off("mouseenter",this.onMouseenter),this.eventTarget&&(this.eventTargetDocument!==document&&$(this.eventTargetDocument).off(e,this.onDrag),this.eventTarget.off("drop",this.onDrop).off("dragenter",this.onDragenter).off("dragover",this.onDragover).off("dragleave",this.onDragleave))}});return $(document).on("dragover drop",!1),{Inplace:i}}),define("io.ox/core/strings",["io.ox/core/locale","gettext!io.ox/core"],function(e,t){function i(){o=[t("B"),t("KB"),t("MB"),t("GB"),t("TB"),t("PB"),t("EB"),t("ZB"),t("YB")]}var o;return{shortenUri:function(e,t){var i=(e=void 0!==e&&null!==e?e:"").replace(/^https?:\/\//,""),o=i.length-t;if(o<=0)return i;var n=i.length/2,a=n-o/2-1,r=n+o/2+1;return i.substring(0,a)+"..."+i.substring(r,i.length)},fileSize:function(n,a){o||i();var r=0,s=o.length,l=!1;a>10&&(a=10),"smart"===a&&(a=3,l=!0);for(var d=Math.pow(10,a||0);n>=1024&&r<s;)n/=1024,r++;return 1024===(n=Math.round(n*d)/d)&&(n/=1024,r++),l&&r<3&&(a=0),t("%1$d %2$s",l?e.number(n,0,a):e.number(n,a),o[r])},size:function(e,t){var i=encodeURI(e).split(/%(?:u[0-9A-F]{2})?[0-9A-F]{2}|./).length-1;return t?(i/1024).toFixed():i}}}),define("io.ox/core/attachments/backbone",["io.ox/core/folder/title","io.ox/core/capabilities","io.ox/contacts/api","settings!io.ox/mail"],function(e,t,i,o){var n=function(){var e,t=0,i=$.Deferred(),o=function(){t=Math.floor(t+e/10),i.notify({loaded:t,total:e}),t/e>=1?i.resolve({data:["133713371337"]}):_.delay(o,1e3)};this.upload=function(t){return e=t.size,o(),i}},a=/\.((?:doc|dot|pot|pps|ppt|xls|xlt)[mx]?|o[dt][cfgipst]|odm|pdf|ppam?|rtf|txt|xlam?|xlsb)$/i,r=/\.(gif|bmp|jpe?g|gmp|png|psd|tif?f|heic?f?)$/i,s={localFile:function(e){var t=2*(_.device("retina")?240:120);return require(["io.ox/contacts/widgets/canvasresize"]).then(function(i){return i(e.fileObj||e.get("originalFile"),{width:t,height:t,crop:!1,quality:80})}).then(function(t){var i=_.clone(e.get("meta"));return i.previewUrl=t,e.set("meta",i),t})},contact:function(e){var t=_.clone(e.get("meta"));return t.previewUrl=e.get("image1_url")||i.getFallbackImage(),e.set("meta",t),$.Deferred().resolve(t.previewUrl)},file:function(e){var t=$.Deferred(),i=_.device("retina")?240:120;return require(["io.ox/files/api"],function(o){var n=_.clone(e.get("meta"));n.previewUrl=o.getUrl(e.toJSON(),"view")+"&scaleType=cover&width="+i+"&height="+i,r.test(e.get("filename"))||(n.previewUrl+="&format=preview_image&session="+ox.session),t.resolve(n.previewUrl),e.set("meta",n)},t.reject),t},mail:function(e){var t=$.Deferred(),i=_.device("retina")?240:120;return require(["io.ox/mail/api"],function(o){var n=_.clone(e.get("meta"));n.previewUrl=o.getUrl(e.toJSON(),"view")+"&scaleType=cover&width="+i+"&height="+i;var a=e.get("security");a&&a.authentication&&(n.previewUrl+="&decrypt=true&cryptoAuth="+encodeURIComponent(a.authentication)),r.test(e.get("filename")||e.get("name"))||(n.previewUrl+="&format=preview_image&session="+ox.session),t.resolve(n.previewUrl),e.set("meta",n)},t.reject),t}},l=Backbone.Model.extend({defaults:function(){return{filename:"",disp:"attachment",uploaded:1,meta:{}}},initialize:function(e){if(e instanceof window.Blob&&(this.fileObj=e,this.set("filename",e.name,{silent:!0}),this.set("uploaded",0,{silent:!0}),this.set("file_size",e.size,{silent:!0})),this.isContact()){var t=(this.get("display_name")||this.get("sort_name")||"vcard").replace(/\s/,"_").concat(".vcf");this.set("filename",t,{silent:!0})}},getTitle:function(){return this.get("com.openexchange.file.sanitizedFilename")||this.get("filename")||this.get("name")},getShortTitle:function(t){return e(this.getTitle(),t||30)},getSize:function(){return this.get("file_size")||this.get("size")||0},getExtension:function(){var e=String(this.get("filename")||this.get("name")||"").split(".");return 1===e.length?"":e.pop().toLowerCase()},isFileAttachment:function(){return("attachment"===this.get("disp")||"ATTACHMENT"===this.get("contentDisposition")||"inline"===this.get("disp"))&&"INLINE"!==this.get("contentDisposition")&&!!this.getTitle()},isContact:function(){return"contact"===this.get("group")},isLocalFile:function(){return"localFile"===this.get("group")},needsUpload:function(){return 0===this.get("uploaded")},previewUrl:function(e){e=e||{};var i,n=t.has("document_preview"),l=this.get("filename")||this.get("name"),d=this.fileObj||this.get("originalFile");if(this.isLocalFile()&&l.match(/psd|tif/))return null;if(!this.isFileAttachment())return null;if(!r.test(l)&&!(n&&a.test(l)||this.isContact()))return null;if("localFile"===this.get("group")&&n&&a.test(l))return null;if("localFile"===this.get("group")&&d.size>=o.get("features/imageResize/fileSizeMax",10485760))return null;if(i=!!this.get("meta")&&this.get("meta").previewUrl)return i;var c=s[this.get("group")];return c?e.delayExecution?c.bind(this,this):c(this):null},upload:function(){if("FormData"in window){(new FormData).append("file",this.fileObj);var e=this;(new n).upload(this.fileObj).then(function(){var t=i.getFallbackImage(),o=_.clone(e.get("meta"));o.previewUrl=o.previewUrl||t,e.set("meta",o),e.trigger("upload:complete")},function(){},function(t){e.set("uploaded",t.loaded/t.total)})}}});return{Model:l,Collection:Backbone.Collection.extend({model:l,fileAttachments:function(){return this.filter(function(e){return e.isFileAttachment()})},mailAttachments:function(){return this.filter(function(e){return"inline"===e.get("disp")||"attachment"===e.get("disp")}).map(function(e,t){var i;return 0===t&&"text/plain"===e.attributes.content_type?(i=e.pick("content_type","content")).raw=!0:i=e.attributes,i})},getSize:function(){return this.reduce(function(e,t){return e+t.getSize()},0)},isValidModel:function(e){return e.isFileAttachment()},getValidModels:function(){return this.filter(this.isValidModel,this)}})}}),define("io.ox/core/attachments/view",["io.ox/core/extensions","io.ox/core/attachments/backbone","io.ox/core/strings","gettext!io.ox/core","io.ox/backbone/views/extensible","less!io.ox/core/attachments/style"],function(e,t,i,o,n){var a=n.extend({scrollStep:120,openByDefault:!1,events:{"click .toggle-details":"onToggleDetails","click .toggle-mode":"onToggleMode","click .scroll-left":"scrollLeft","click .scroll-right":"scrollRight"},initialize:function(e){this.options=_.extend({AttachmentView:s,editable:!1,mode:"list"},e),this.listenTo(this.collection,"add",this.addAttachment),this.$el.addClass("mail-attachment-list").addClass(_.device("touch")?"touch":""),this.options.editable&&this.$el.addClass("editable"),"preview"===this.options.mode&&this.$el.addClass("show-preview"),this.$header=$('<div class="header">'),this.$list=$('<ul class="inline-items">'),this.$preview=$('<ul class="inline-items preview">'),this.$footer=$("<footer>"),this.isListRendered=!1,this.listenTo(this.collection,"add remove reset",function(){var e=this.getValidModels().length;this.$el.toggleClass("empty",0===e),this.updateScrollControls(),this.renderSummary(e),this.openByDefault&&this.toggleDetails(!0)}),this.listenTo(this.collection,"remove",function(){this.$preview.trigger("scroll")}),this.$el.toggleClass("empty",0===this.getValidModels().length)},render:function(){var e=_.uniqueId("list-container-"),t=_.uniqueId("preview-container-");return this.renderHeader(),this.$el.append(this.$header,$('<div class="list-container">').attr("id",e).append(this.$list),$('<div class="preview-container">').attr("id",t).append($('<button type="button" class="scroll-left"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>'),this.$preview,$('<button type="button" class="scroll-right"><i class="fa fa-chevron-right" aria-hidden="true"></i></button>')),this.$footer),this.openByDefault&&this.toggleDetails(!0),this.updateScrollControls(),this.updateAriaControls(),this.$header.find(".toggle-mode").attr("aria-controls",[e,t].join(" ")),this},renderHeader:function(){this.$header.append($('<a href="#" class="toggle-details" aria-expanded="false" role="button">').append($('<i class="fa fa-paperclip" aria-hidden="true">'),$('<span class="summary">'),$('<i class="fa toggle-caret" aria-hidden="true">')),$('<span class="links" role="presentation">'),$('<a href="#" class="pull-right toggle-mode" role="button">').attr("title",o("Toggle preview")).append('<i class="fa" aria-hidden="true">')),this.renderSummary()},renderSummary:function(e){e=e||this.getValidModels().length,this.$header.find(".summary").text(o.format(o.ngettext("%1$d attachment","%1$d attachments",e),e))},renderList:function(){function e(e,t,i){t.append(e.map(this.renderAttachment.bind(this,i)))}var t=this.getValidModels();e.call(this,t,this.$list,"list"),e.call(this,t,this.$preview,"preview"),this.isListRendered=!0},renderAttachment:function(e,t){return new this.options.AttachmentView({point:this.options.point,mode:e,model:t}).render().$el},addAttachment:function(e){this.isListRendered&&this.collection.isValidModel(e)&&(this.$list.append(this.renderAttachment("list",e)),this.$preview.append(this.renderAttachment("preview",e)))},getValidModels:function(){return this.collection.getValidModels()},updateAriaControls:function(){var e;e=this.$el.hasClass("show-preview")?this.$(".preview-container").attr("id"):this.$(".list-container").attr("id"),this.$header.find(".toggle-details").attr("aria-controls",e),this.$header.find(".toggle-mode").attr("aria-pressed",this.$el.hasClass("show-preview"))},toggleDetails:function(e){this.$el.toggleClass("open",!0===e||void 0),this.$header.find(".toggle-details").attr("aria-expanded",this.$el.hasClass("open")),this.trigger("change:expanded",this.$el.hasClass("open")),this.isListRendered||this.renderList()},onToggleDetails:function(e){e.preventDefault(),this.toggleDetails(),this.updateScrollControls()},onToggleMode:function(e){e.preventDefault(),this.$el.toggleClass("show-preview"),this.trigger("change:layout",this.$el.hasClass("show-preview")?"preview":"list"),this.$preview.trigger("scroll"),this.updateScrollControls(),this.updateAriaControls(),$(window).trigger("resize")},scrollLeft:function(){this.scrollList(-1)},scrollRight:function(){this.scrollList(1)},scrollList:function(e){var t=this.getScrollIndex()+e,i=this.getMaxScrollIndex();t<0||t>i||(this.updateScrollControls(t),this.$preview.stop(!0,!1).animate({scrollLeft:t*this.scrollStep},"fast"))},getScrollIndex:function(){return Math.ceil(this.$preview.scrollLeft()/this.scrollStep)},getMaxScrollIndex:function(){var e=this.$preview.width(),t=this.$preview.prop("scrollWidth");return Math.max(0,Math.ceil((t-e)/this.scrollStep))},updateScrollControls:function(e){void 0===e&&(e=this.getScrollIndex());var t=this.getMaxScrollIndex();this.$(".scroll-left").prop("disabled",e<=0),this.$(".scroll-right").prop("disabled",e>=t)}}),r=Backbone.View.extend({className:"preview",events:{keydown:"onKeydown"},initialize:function(){this.listenTo(this.model,"change:id",this.render),this.$el.on("error.lazyload",this.fallback.bind(this))},lazyload:function(e){_.defer(function(){this.$el.lazyload({container:this.$el.closest("ul"),effect:"fadeIn",previewUrl:e})}.bind(this))},getColor:function(e){return/^do[ct]x?$/.test(e)?"#2C5897":/^xlsx?|o[dt]s$/.test(e)?"#1D7047":/^p[po]tx?$/.test(e)?"#D04423":/^pdf$/.test(e)?"#C01E07":/^(zip|gz|gzip|tgz)$/.test(e)?"#FF940A":void 0},fallback:function(){var e,t=this.model.getExtension();t&&(e=this.getColor(t),this.$el.append($('<div class="abs fallback ellipsis">').css({color:e&&"white",backgroundColor:e}).text(t)))},render:function(){var e=this.model.previewUrl({delayExecution:!0});return _.isString(e)?(this.$el.addClass("lazy").attr("data-original",e),this.lazyload()):null!==e?(this.$el.addClass("lazy"),this.lazyload(e)):this.fallback(),this.$el.attr("tabindex","0"),this},onKeydown:function(e){13!==e.which&&32!==e.which||($(e.target).trigger("click"),e.preventDefault(),e.stopPropagation())}}),s=Backbone.View.extend({tagName:"li",className:"item",events:{"click .remove":"onRemove"},attributes:function(){return{"data-id":this.model.get("id")||this.model.cid}},initialize:function(t){this.options=_.extend({mode:"list"},t),this.preview="preview"===this.options.mode&&new r({model:this.model,el:this.el}),this.listenTo(this.model,{"change:uploaded":function(e){var t=100*e.get("uploaded");0===t&&this.render(),this.$(".progress").width(t+"%")},"change:file_size change:size":this.render,"upload:complete":function(){this.render()},remove:this.onRemoveModel});var i=this.options.point?this.options.point+"/view":"io.ox/core/attachment/view";e.point(i).invoke("initialize",this)},onRemove:function(e){e.preventDefault(),this.model.collection.remove(this.model)},onRemoveModel:function(){this.remove()},render:function(){return this.$el.empty().append($('<span class="file">'),$('<span class="filesize">'),this.model.needsUpload()?$('<div class="progress-container">').append($('<div class="progress">')):$()),this.preview&&this.preview.render(),this.preview||this.renderFileSize(),this.renderContent(),this.renderControls(),this},renderFileSize:function(){var e=this.model.getSize();e&&this.$(".filesize").text(" ("+i.fileSize(e,1)+")")},renderContent:function(){this.$(".file").attr("title",this.model.getTitle()).text(this.model.getShortTitle(_.device("smartphone")?23:50))},renderControls:function(){this.$el.append($('<a href="#" class="control remove">').attr("title",o("Remove attachment")).append($('<i class="fa fa-trash-o" aria-hidden="true">')))}});return{List:a,View:s,Preview:r,Model:t.Model,Collection:t.Collection}}),define("io.ox/core/api/user",["io.ox/core/http","io.ox/core/api/factory","io.ox/contacts/util","io.ox/core/capabilities"],function(e,t,i,o){var n=function(e){return e.id?(e.birthday&&moment.utc(e.birthday).local(!0).year()<=1&&(e.birthday=i.julianToGregorian(e.birthday)),e.anniversary&&moment.utc(e.anniversary).local(!0).year()<=1&&(e.anniversary=i.julianToGregorian(e.anniversary)),e):(_(e).each(function(t){t.birthday&&moment.utc(t.birthday).local(!0).year()<=1&&(t.birthday=i.julianToGregorian(t.birthday)),e.anniversary&&moment.utc(e.anniversary).local(!0).year()<=1&&(e.anniversary=i.julianToGregorian(e.anniversary))}),e)},a=t({module:"user",keyGenerator:function(e){return"string"==typeof e||"number"==typeof e?e:String(e.id)},requests:{all:{columns:"1,20,500",extendColumns:"io.ox/core/api/user/all",sort:"500",order:"asc"},list:{action:"list",columns:"1,20,500,501,502,505,524,555,606,614,616",extendColumns:"io.ox/core/api/user/list"},get:{action:"get"},search:{action:"search",columns:"1,20,500,524",extendColumns:"io.ox/core/api/user/search",sort:"500",order:"asc",getData:function(e){return{pattern:e}}}},pipe:{get:n,search:n}});ox.rampup.user&&ox.rampup.user.id===ox.user_id&&(a.caches.get.add(ox.rampup.user),a.caches.list.add(ox.rampup.user)),a.update=function(t){return _.isEmpty(t.data)?$.when():require(["io.ox/contacts/api"]).then(function(n){return t.data.birthday&&moment.utc(t.data.birthday).local(!0).year()<=1&&(t.data.birthday=i.gregorianToJulian(t.data.birthday)),t.data.anniversary&&moment.utc(t.data.anniversary).local(!0).year()<=1&&(t.data.anniversary=i.gregorianToJulian(t.data.anniversary)),t.data=_(t.data).each(function(e,i){""!==e&&void 0!==e||(t.data[i]=null)}),e.PUT({module:"user",params:{action:"update",id:t.id,folder:t.folder,timestamp:t.timestamp||_.then()},data:t.data,appendColumns:!1}).then(function(){return a.get({id:t.id},!1).then(function(e){return $.when(a.caches.get.add(e),a.caches.all.clear(),a.caches.list.remove({id:t.id}),n.caches.get.remove({folder_id:e.folder_id,id:e.contact_id}),n.caches.all.grepRemove(t.folder+n.DELIM),n.caches.list.remove({id:e.contact_id,folder:t.folder}),n.clearFetchCache()).then(function(){return e}).done(function(){a.trigger("update:"+_.ecid(e),e),a.trigger("update",e),a.trigger("refresh.list"),null===t.data.image1&&(n.trigger("update:image",e),a.trigger("reset:image reset:image:"+t.id,{id:t.id})),6===e.folder_id&&o.has("!gab")||n.get({folder_id:e.folder_id,id:e.contact_id}).done(function(e){n.trigger("update:"+_.ecid(e),e),n.trigger("update",e)})})})})})},a.editNewImage=function(t,i,o){var n=function(e){return $.when(a.caches.get.clear(),a.caches.all.clear(),a.caches.list.clear()).then(function(){a.trigger("refresh.list"),require(["io.ox/contacts/api"]).then(function(e){e.trigger("update:image",{id:t.id}),a.trigger("update update:image update:image:"+t.id,{id:t.id})})}),e};if("FormData"in window&&o instanceof window.File){var r=new FormData;return r.append("file",o),r.append("json",JSON.stringify(i)),e.UPLOAD({module:"user",params:{action:"update",id:t.id,timestamp:t.timestamp||_.then()},data:r,fixPost:!0}).then(n)}return e.FORM({module:"user",action:"update",form:o,data:i,params:{id:t.id,folder:t.folder_id,timestamp:t.timestamp||_.then()}}).then(n)},a.getName=function(e){return a.get({id:e}).then(function(e){return e.display_name||e.email1||""})},a.getGreeting=function(e){return a.get({id:e}).then(function(e){return e.first_name||e.display_name||e.email1||""})},a.getTextNode=function(e,t){var o=_.extend({type:"name"},t),n=document.createTextNode("");return a.get({id:e}).done(function(e){var t="";"name"===o.type?t=e.display_name||e.email1:"email"===o.type?t=e.email1||e.display_name:"initials"===o.type&&(t=i.getInitials(e)),n.nodeValue=t}).always(function(){_.defer(function(){n=null})}),n},a.getLink=function(e,t){return t=t?$.txt(t):a.getTextNode(e),$('<a href="#" class="halo-link">').append(t).data({internal_userid:e})},a.getCurrentUser=function(){return require(["io.ox/core/settings/user"]).then(function(e){return e.getCurrentUser()})};var r=a.get;return a.get=function(){return!arguments.length||_.isEmpty(arguments)||_.isObject(arguments[0])&&void 0===arguments[0].id?r({id:ox.user_id}):r.apply(this,arguments)},a.me=function(){return ox.rampup.user?$.when(ox.rampup.user):a.get()},a.on("update:"+_.ecid({folder_id:6,id:ox.user_id}),function(){require(["io.ox/core/api/account"],function(e){e.reload()})}),a}),define("io.ox/core/api/group",["io.ox/core/http","io.ox/core/api/factory"],function(e,t){function i(){o.caches.all.clear(),o.caches.list.clear(),o.caches.get.clear()}var o=t({module:"group",keyGenerator:function(e){return String(e.id)},requests:{all:{columns:"1,20",extendColumns:"io.ox/core/api/group/all",sort:"500",order:"asc"},list:{},get:{},search:{action:"search",columns:"1,20,500,524",extendColumns:"io.ox/core/api/group/search",getData:function(e){return{pattern:e}}}}}),n=Backbone.Model.extend({defaults:{display_name:"",members:[],name:""},initialize:function(){var e=this.get("members");_.isString(e)&&""!==e&&this.set("members",e.split(",").map(function(e){return parseInt(e,10)}),{silent:!0}),this.on("change:display_name",function(){this.set("name",this.getName())}),this.set("name",this.getName())},getName:function(){var e={"ä":"ae","ö":"oe","ü":"ue","ß":"ss"};return function(){return this.has("id")&&this.get("name")?this.get("name"):this.get("display_name").trim().toLowerCase().replace(/[äöüß]/g,function(t){return e[t]}).replace(/\W+/g,"_")}}()}),a=Backbone.Collection.extend({comparator:function(e){return(e.get("display_name")||"").toLowerCase()},model:n});return o.collection=new a,o.getModel=function(e){return o.collection.get(e)||new n},o.create=function(t){return e.PUT({module:"group",params:{action:"new"},data:t,appendColumns:!1}).then(function(e){return o.get({id:e.id}).done(function(e){o.collection.add(e,{parse:!0}),o.trigger("create",e),i()})})},o.update=function(t){return e.PUT({module:"group",params:{action:"update",id:t.id,timestamp:_.then()},data:_(t).pick("name","display_name","members"),appendColumns:!1}).done(function(){var e=o.collection.get(t.id);e&&e.set(t),o.trigger("update",t),i()})},o.refreshGroup=function(e){return o.collection.get(e)?o.get({id:e},!1).done(function(t){return o.collection.get(e).set(t)}):$.when()},o.remove=function(t){return o.trigger("before:remove",t),e.PUT({module:"group",params:{action:"delete",timestamp:_.then()},data:{id:t},appendColumns:!1}).done(function(){var e=o.collection.get(t);e&&o.collection.remove(e),o.trigger("remove",t),i()})},o.getName=function(e){return o.get({id:e}).then(function(e){return e.display_name||e.name||""})},o.getTextNode=function(e){var t=document.createTextNode("");return o.get({id:e}).done(function(e){t.nodeValue=e.display_name}).always(function(){_.defer(function(){t=null})}),t},o}),define("io.ox/core/api/resource",["io.ox/core/http","io.ox/core/api/factory"],function(e,t){function i(){o.caches.all.clear(),o.caches.list.clear(),o.caches.get.clear()}var o=t({module:"resource",keyGenerator:function(e){return String(e.id)},requests:{all:{},list:{},get:{},search:{action:"search",getData:function(e){return{pattern:e}}}}}),n=Backbone.Model.extend({defaults:{description:"",display_name:"",name:"",mailaddress:""},initialize:function(){this.on("change:display_name",function(){this.set("name",this.getName())}),this.set("name",this.getName())},getName:function(){var e={"ä":"ae","ö":"oe","ü":"ue","ß":"ss"};return function(){return this.has("id")&&this.get("name")?this.get("name"):this.get("display_name").trim().toLowerCase().replace(/[äöüß]/g,function(t){return e[t]}).replace(/\W+/g,"_")}}()}),a=Backbone.Collection.extend({comparator:function(e){return(e.get("display_name")||"").toLowerCase()},model:n});return o.collection=new a,o.getModel=function(e){return o.collection.get(e)||new n},o.create=function(t){return e.PUT({module:"resource",params:{action:"new"},data:t,appendColumns:!1}).then(function(e){return o.get({id:e.id}).done(function(e){o.collection.add(e,{parse:!0}),o.trigger("create",e),i()})})},o.update=function(t){return e.PUT({module:"resource",params:{action:"update",id:t.id,timestamp:_.then()},data:_(t).pick("description","display_name","mailaddress","name"),appendColumns:!1}).done(function(){var e=o.collection.get(t.id);e&&e.set(t),o.trigger("update",t),i()})},o.remove=function(t){return o.trigger("before:remove",t),e.PUT({module:"resource",params:{action:"delete",timestamp:_.then()},data:{id:t},appendColumns:!1}).done(function(){var e=o.collection.get(t);e&&o.collection.remove(e),o.trigger("remove",t),i()})},o}),define("io.ox/core/api/quota",["io.ox/core/http","io.ox/core/capabilities","settings!io.ox/core"],function(e,t,i){var o=Backbone.Model.extend({defaults:{quota:-1,use:0,countquota:-1,countuse:0},constructor:function(e){this.type=e,this.fetched=!1,Backbone.Model.apply(this,[])},fetch:function(){return this.fetched||"mail"===this.type&&!t.has("webmail")||"filestore"===this.type&&!t.has("infostore")?this.toJSON():e.GET({module:"quota",params:{action:"unified"===i.get("quotaMode","default")?"filestore":this.type}}).then(function(e){return this.fetched=!0,"filestore"===this.type&&i.get("properties/infostoreUsage")>0&&i.set("properties/infostoreUsage",e.use),this.set(e).toJSON()}.bind(this))}}),n=new o("mail"),a=new o("filestore"),r=!1,s={mailQuota:n,fileQuota:a,checkQuota:function(t,i){return"infostore"!==t.module?{}:e.PUT({module:"folders",params:{action:"checklimits",id:t.id,type:"filestorage"},appendColumns:!1,data:{files:i.map(function(e){return{size:e.size,name:e.name}})}}).then(function(e){return[].concat.apply(e&&e.errors||[])})},getModel:function(e){return"mail"===e?n:a},load:function(){return e.pause(),"unified"!==i.get("quotaMode","default")&&this.mailQuota.fetch(),this.fileQuota.fetch(),e.resume().then(function(){return"unified"===i.get("quotaMode","default")&&(n.fetched=!0,n.set(a.attributes)),{mail:n.toJSON(),file:a.toJSON()}})},reload:function(){n.fetched=!1,r&&(a.fetched=!1),this.load()},getAccountQuota:function(){var t=new Backbone.Collection;return function(i,o,n){var a=t.find({account_id:i.replace(/.*:\/\//,""),module:o});return a&&!1!==n?$.when(a):e.GET({module:"quota",params:{account:i,module:o}}).then(function(e){return e=e||{account_id:i.replace(/.*:\/\//,"")},e.module=o,t.add(e)})}}()};return ox.on("refresh^",function(){s.reload()}),s.requestFileQuotaUpdates=function(){r=!0},s}),define("io.ox/core/api/filestorage",["io.ox/core/http","io.ox/core/event","io.ox/core/extensions"],function(e,t,i){var o={},n=new Backbone.Collection,a=new Backbone.Collection,r=[],s=function(e){var t=["googledrive","dropbox","boxcom","onedrive"];i.point("io.ox/core/filestorage/service-list").invoke("customize",t),_(e).each(function(e){e=e.get?e.toJSON():e,-1!==_(t).indexOf(e.filestorageService)&&r.push(e.qualifiedId)}),r=_.uniq(r)},l={rampupDone:!1,rampupFailed:!1,rampup:function(){return l.rampupDone?$.Deferred().resolve():(l.rampupFailed&&$.Deferred().reject(),e.pause(),l.getAllServices(),l.getAllAccounts(),e.resume().done(function(e){var t=!1;_(e).each(function(e){e.error&&(t=!0)}),t?(l.rampupDone=!1,l.rampupFailed=!0):(l.rampupDone=!0,l.rampupFailed=!1)}).fail(function(e){return l.rampupFailed=!0,e}))},getAccountsCache:function(){return a},getAllServices:function(t,i){if((i=void 0===i||i)&&n.length)return $.Deferred().resolve(n);var a={action:"all"};return t&&(a.filestorageService=t),e.GET({module:"fileservice",params:a}).then(function(e){return n.reset(e),_(e).each(function(e){try{e.configuration&&e.configuration.length>0&&e.configuration[0].options&&(o[e.configuration[0].options.type]={filestorageService:e.id,configuration:{type:e.configuration[0].options.type}})}catch(e){console.error(e)}}),n})},getService:function(t,i){if(i=_.defaultValue(i,!0),!t)return $.Deferred().reject();if(i&&n.length){var o=n.get(t);if(o)return $.Deferred().resolve(o)}return e.GET({module:"fileservice",params:{action:"get",id:t}}).then(function(e){return new Backbone.Model(e)})},getAllAccounts:function(t){return(t=_.defaultValue(t,!0))&&a.length>0?$.Deferred().resolve(a):e.GET({module:"fileaccount",params:{action:"all"}}).then(function(e){return a.reset(e),s(e),a})},getAccount:function(t,i){if(i=_.defaultValue(i,!0),!t.id||!t.filestorageService)return $.Deferred().reject();if(i&&a.length>0){var o=a.get(t.id);if(o)return $.Deferred().resolve(o)}return e.GET({module:"fileaccount",params:{action:"get",id:t.id,filestorageService:t.filestorageService}}).then(function(e){return new Backbone.Model(e)})},createAccount:function(t){return e.PUT({module:"fileaccount",params:{action:"new"},data:t}).then(function(e){return l.getAccount({id:e,filestorageService:t.filestorageService}).then(function(e){return a.add(e),s([e]),l.trigger("create",a.get(e)),a.get(e)})})},createAccountFromOauth:function(e,t){if(t=t||{},!e)return $.Deferred().reject();if(l.getAccountForOauth(e))return $.Deferred().reject({code:"EEXISTS"});var i=_.copy(o[e.serviceId],!0);return i?(i.displayName=t.displayName||e.displayName,i.configuration.account=String(e.id),l.createAccount(i)):$.Deferred().reject()},deleteAccount:function(t,i){function o(e){return a.remove(t),r=_(r).without(t.qualifiedId),l.trigger("delete",n||t),require(["io.ox/core/folder/api"],function(e){ox.trigger("account:delete",t.qualifiedId),e.propagate("account:delete")}),e}var n,s=i||{};return t.attributes&&(n=t,t=t.attributes),(s.softDelete?$.Deferred().resolve():e.PUT({module:"fileaccount",params:{action:"delete",id:t.id,filestorageService:t.filestorageService}})).then(o,o)},remove:function(e,t){return l.deleteAccount(e,t)},getAccountForOauth:function(e){var t;return _(a.models).each(function(i){i.get("configuration")&&i.get("configuration").account===String(e.id)&&(t=i)}),t},updateAccount:function(t){return e.PUT({module:"fileaccount",params:{action:"update"},data:t}).then(function(){return l.getAccount({id:t.id,filestorageService:t.filestorageService},!1).then(function(e){return a.add(e,{merge:!0}),l.trigger("update",a.get(e)),a.get(e)})})},isStorageAvailable:function(e){return e?!!o[e]:_.keys(o)},consistencyCheck:function(){l.rampupDone&&!l.rampupFailed&&require(["io.ox/oauth/keychain"],function(e){try{var t={},i=e.accounts;_(a.models).each(function(e){if(("googledrive"===e.get("filestorageService")||"dropbox"===e.get("filestorageService")||"onedrive"===e.get("filestorageService")||"boxcom"===e.get("filestorageService"))&&e.get("configuration")&&e.get("configuration").account){var o=e.get("configuration").account;i.get(o)&&!t[o]?t[o]=!0:l.deleteAccount(e)}})}catch(e){ox.debug&&console.error(e)}})},isExternal:function(e,t){var i=!1,o=t||{};if(l.rampupDone&&e&&e.account_id&&(i=-1!==_(r).indexOf(e.account_id)),i&&(o.type||o.root)){var n=a.findWhere({qualifiedId:e.account_id});o.root&&(i=e.id===n.get("rootFolder")),i&&o.type&&(i=n.get("filestorageService"))}return i}};return t.extend(l),require(["io.ox/core/folder/api"],function(e){e.on("remove:infostore",function(e){var t=/.*:\/\/(\d+)/.exec(e.account_id);null!==t&&t[1]&&a.remove(t[1])})}),l}),define("io.ox/contacts/util",["io.ox/core/util","io.ox/core/extensions","settings!io.ox/contacts","gettext!io.ox/contacts"],function(e,t,i,o){function n(e,t){var i=new Array(e);return i[e-1]=t,{format:"%"+e+"$s",params:i}}function a(e){return/^(<span class="title">)?(dr\.?|prof\.?)/i.test(e)?e:""}function r(e){var t,i,o,n=moment.utc(e).local(!0);return t=n.month()<2?Math.floor((n.year()-1)/100):Math.floor(n.year()/100),i=Math.floor(t/4),o=t%4,Math.abs(864e5*(3*i+o-2))}function s(e,t,i){var o=e;return!0===i&&(o={},_(["title","first_name","last_name","company","display_name","cn"]).each(function(t){var i=$.trim(e[t]);if(!i)if("last_name"===t&&$.trim(e.yomiLastName))i=$.trim(e.yomiLastName);else if("first_name"===t&&$.trim(e.yomiFirstName))i=$.trim(e.yomiFirstName);else{if("company"!==t||!$.trim(e.yomiCompany))return;i=$.trim(e.yomiCompany)}var n="last_name"===t?"strong":"span";o[t]="<"+n+' class="'+t+'">'+_.escape(i)+"</"+n+">"})),t?l.getMailFullNameFormat(e):l.getFullNameFormat(o)}require(["settings!io.ox/contacts"]).then(function(e){e.get("showDepartment")&&($("html").addClass("showDepartment"),t.point("io.ox/core/person").extend({index:"last",id:"department",draw:function(e){6===e.data.folder_id&&e.data.department&&this.append($('<span class="department">').text(o.format(" (%1$s) ",e.data.department)))}}))});var l={getSortName:function(e){return e=_.pick(e,"first_name","last_name","display_name","cn"),this.getFullName(e).toLowerCase()},getFullNameFormat:function(t){var r=$.trim(t.first_name),s=$.trim(t.last_name),l=$.trim(t.display_name||t.cn),d=$.trim(t.company),c=$.trim(t.title);if(r&&s){var u,p=i.get("fullNameFormat","auto"),f=[r,s];return(c=a(c))&&f.push(c),u="firstname lastname"===p?c?"%3$s %1$s %2$s":"%1$s %2$s":"lastname, firstname"===p?c?"%3$s %2$s, %1$s":"%2$s, %1$s":o(c?"%3$s %2$s, %1$s":"%2$s, %1$s"),{format:u,params:f}}return s?n(2,s):r?n(1,r):d?n(1,d):l?n(4,e.unescapeDisplayName(l)):{format:"",params:[]}},getFullName:function(e,t){var i=s(e,!1,t);return o.format(i.format,i.params)},getFullNameWithFurigana:function(e){return this.getFullName(e,!0)},getDisplayName:function(t){return t.display_name?e.unescapeDisplayName(t.display_name):t.last_name&&t.first_name?t.last_name+", "+t.first_name:t.last_name||t.first_name||""},getMailFullNameFormat:function(t){var i=$.trim(t.first_name),a=$.trim(t.last_name),r=$.trim(t.display_name);return a&&i?{format:o.pgettext("mail address","%1$s %2$s"),params:[i,a]}:a?n(2,a):i?n(1,i):r?n(4,e.unescapeDisplayName(r)):{format:"",params:[]}},getMailFullName:function(e,t){var i=s(e,!0,t);return o.format(i.format,i.params)},getMailFormat:function(e){return e.email1?n(1,e.email1):e.email2?n(2,e.email2):e.email3?n(3,e.email3):{format:"",params:[]}},getMail:function(e){return e?(e.email1||e.email2||e.email3||e.mail||"").trim().toLowerCase():""},getJob:function(e){var t=_([e.company,e.position]).compact();return t.length?t.join(", "):e.email1||e.email2||e.email3||""},nameSort:function(e,t){var i,o;return i=void 0===e.display_name?e.mail:e.display_name.toLowerCase(),o=void 0===t.display_name?t.mail:t.display_name.toLowerCase(),i<o?-1:i>o?1:0},calcMailField:function(e,t){var i,o;return o=[e.email1,e.email2,e.email3],_.each(o,function(e,o){t===e&&(i=o+1)}),i},gregorianToJulian:function(e){return moment.utc(e-r(e)).valueOf()},julianToGregorian:function(e){return moment.utc(e+r(e)).valueOf()},getBirthday:function(e,t){return(e=moment.utc(e)).year()>1&&1604!==e.year()?e.format("l")+(t?" ("+o("Age: %1$d",moment().diff(e,"years"))+")":""):e.formatCLDR("Md")},getSummaryBusiness:function(e){var t=[e.position,e.company,e.department];return"6"===String(e.folder_id)&&t.splice(1,1),t.map($.trim).filter(Boolean).join(", ")},getSummaryLocation:function(e){return(e.city_business?[e.city_business,e.country_business]:[e.city_home,e.country_home]).map($.trim).filter(Boolean).join(", ")},getImage:function(t,i){if(_.isObject(t)&&(t=t.image1_url),!t)return"";i=_.extend({width:40,height:40,scaleType:"cover"},i),_.device("retina")&&(i.width*=2,i.height*=2);var o=t.replace(/^https?:\/\/[^/]+/i,"");return o=e.replacePrefix(o),e.getShardingRoot(o+"&"+$.param(i))},getInitials:function(){function e(e){var t=o.exec(e);return t&&t[1]||""}function t(e){var t=n.exec(e);return t&&t[1]||""}function i(i){var o=$.trim(i.first_name),n=$.trim(i.last_name),a=$.trim(i.display_name);if(o&&n)return e(o)+e(n);if(a)return e(a)+t(a);if(n)return e(n);if(o)return e(o);var r=$.trim(i.email1||i.email2||i.email3);return r?e(r):""}var o=/^.*?([a-z0-9\xC0-\xFF])/i,n=/\s.*?([a-z0-9\xC0-\xFF])\S*$/i;return function(e){return i(e).toUpperCase()}}(),getInitialsColor:function(){var e=["red","orange","yellow","green","cyan","blue","purple","pink"],t=e.length;return function(i){return i?e[i[0].charCodeAt()%t]:"gray"}}(),validateDistributionList:function(e){if(e&&_.isArray(e)&&e.length){var t=[];return e=_(e).filter(function(e){return(e=e.attributes||e).mail||e[e.field]||t.push(e),!!e.mail}),t.length&&require(["io.ox/core/yell"],function(e){1!==t.length?e("warning",o("Some contacts could not be added as they have no valid email field.")):e("warning",o("%1$s could not be added as the contact has no valid email field.",t[0].display_name))}),e}}};return l}),define("l10n/ja_JP/io.ox/collation",function(){var e,t,i,o="ﾞ ゙ ゛".split(" "),n="ﾟ ﾟ ゜".split(" "),a="ｳ ｴ ｵ ｶ ｷ ｸ ｹ ｺ ｻ ｼ ｽ ｾ ｿ ﾀ ﾁ ﾂ ｯ ﾃ ﾄ ﾊ ﾋ ﾌ ﾍ ﾎ ﾜ ｦ".split(" "),r=[["あ ぁ ア ｱ ァ","い ぃ イ ｲ ィ","う ぅ ウ ｳ ゥ ゔ ヴ ｳﾞ","え ぇ エ ｴ ェ","お ぉ オ ｵ ォ"],["か ゕ カ ｶ ヵ が ガ ｶﾞ","き キ ｷ ぎ ギ ｷﾞ","く ク ｸ ㇰ ぐ グ ㇰﾞ","け ゖ ケ ｹ ヶ げ ゲ ｹﾞ","こ コ ｺ ご ゴ ｺﾞ"],["さ サ ｻ ざ ザ ｻﾞ","し シ ｼ ㇱ じ ジ ｼﾞ","す ス ｽ ㇲ ず ズ ｽﾞ","せ セ ｾ ぜ ゼ ｾﾞ","そ ソ ｿ ぞ ゾ ｿﾞ"],["た タ ﾀ だ ダ ﾀﾞ","ち チ ﾁ ぢ ヂ ﾁﾞ","つ っ ツ ﾂ ッ ｯ づ ヅ ﾂﾞ ｯﾞ","て テ ﾃ で デ ﾃﾞ","と ト ﾄ ㇳ ど ド ﾄﾞ"],["な ナ ﾅ","に ニ ﾆ","ぬ ヌ ﾇ ㇴ","ね ネ ﾈ","の ノ ﾉ"],["は ハ ﾊ ㇵ ば バ ﾊﾞ ぱ パ ﾊﾟ","ひ ヒ ﾋ ㇶ び ビ ﾋﾞ ぴ ピ ﾋﾟ","ふ フ ﾌ ㇷ ぶ ブ ﾌﾞ ぷ プ ﾌﾟ","へ ヘ ﾍ ㇸ べ ベ ﾍﾞ ぺ ペ ﾍﾟ","ほ ホ ﾎ ㇹ ぼ ボ ﾎﾞ ぽ ポ ﾎﾟ"],["ま マ ﾏ","み ミ ﾐ","む ム ﾑ ㇺ","め メ ﾒ","も モ ﾓ"],["や ゃ ヤ ﾔ ャ","ゆ ゅ ユ ﾕ ュ","よ ょ ヨ ﾖ ョ"],["ら ラ ﾗ ㇻ","り リ ﾘ ㇼ","る ル ﾙ ㇽ","れ レ ﾚ ㇾ","ろ ロ ﾛ ㇿ"],["わ ゎ ワ ﾜ ヮ ヷ ﾜﾞ","ゐ ヰ ヸ","ゑ ヱ ヹ","を ヲ ｦ ヺ","ん ン ﾝ"]],s={},l={},d=0,c=[],u=/^[a-zäöü]/i;s[" "]=d,s["　"]=d++,_(r).each(function(e){c.push(e[0][0]),_(e).each(function(t){_(t.split(" ")).each(function(t){s[t]=d,l[t]=e[0][0]}),d++})}),i=_(l).keys();var p=function(e,t){return e&&t&&-1!==a.indexOf(e)&&(t[1]&&-1!==o.indexOf(t[1])&&(e+=o[0]),t[1]&&-1!==n.indexOf(t[1])&&(e+=n[0])),e};return e=function(t,o,n){var a=t.sort_name,r=o.sort_name,l=t.fullSortName||a,d=o.fullSortName||r;if(t=t.sort_name[0],o=o.sort_name[0],l===a&&d===r){if(void 0===t&&void 0===o)return 0;if(void 0===t)return 1;if(void 0===o)return-1;if(t!==o&&"_"===t&&o in s)return 1;if(t!==o&&"_"===o&&t in s)return-1}if(void 0===t&&void 0===o)return n||0;if(void 0===o||"_"===o&&"_"!==t&&void 0!==t)return 1;if(void 0===t||"_"===t&&"_"!==o&&void 0!==o)return-1;if(n&&("_"===t||"_"===o))return n;if(t in s&&o in s){var c=t,f=o;return t=p(t,a),o=p(o,r),s[t]===s[o]?(void 0===n&&t!==o&&(n=_(i).indexOf(t)<_(i).indexOf(o)?-1:1),t={sort_name:a.slice(c===t?1:2),fullSortName:l},o={sort_name:r.slice(f===o?1:2),fullSortName:d},e(t,o,n)):s[t]-s[o]==0?n||0:s[t]-s[o]}if(t in s)return-1;if(o in s)return 1;if(t=t.toUpperCase(),o=o.toUpperCase(),t===o)return t={sort_name:a.slice(1),fullSortName:l},o={sort_name:r.slice(1),fullSortName:d},e(t,o,n);var h;return u.test(t)||u.test(o)?u.test(t)?u.test(o)?0==(h=t<o?-1:t>o?1:0)?n||0:h:1:-1:0==(h=t<o?-1:t>o?1:0)?n||0:h},t=function(t,i){if(t&&t.email&&i&&i.email&&t.sort_name_without_mail&&i.sort_name_without_mail){var o=e({sort_name:t.sort_name_without_mail},{sort_name:i.sort_name_without_mail});return 0!==o?o:e({sort_name:t.email},{sort_name:i.email})}return e(t,i)},{sorter:e,sorterWithMail:t,index:c,isKana:function(e){return void 0!==l[e]},getKanaLabel:function(e){return l[e]||""}}}),define("io.ox/core/tk/list-selection",["settings!io.ox/core"],function(e){function t(e,t){switch(t=_.isObject(t)?t:{},this.view=e,this.behavior=t.behavior||r,this._direction="down",this._lastPosition=-1,this.behavior){case"normal":_.extend(this,d);break;case"alternative":_.extend(this,d,c);break;case"simple":_.extend(this,u);break;default:console.error("Unknown selection behavior",this.behavior)}this.registerEvents()}var i,o=".selectable",n=_.device("touch"),a=_.device("android")&&_.browser.android<"4.4",r=e.get("selectionMode","normal"),s=!1,l={get:function(){return _(this.view.$el.find(".selectable.selected")).map(function(e){return $(e).attr("data-cid")})},resolve:function(){var e=this.view;return this.get().map(function(t){return e.collection.get(t)})},getItems:function(e){var t=this.view.$el.find(o);return e?t.filter(e):t},getNode:function(e){return this.getItems().filter('[data-cid="'+e+'"]')},getPosition:function(e){var t=(e=e||this.getItems()).index(e.filter(".precursor"));return t!==this._lastPosition&&(this._direction=t<this._lastPosition?"up":"down"),this._lastPosition=t,t},getDirection:function(){return this._direction},check:function(e){e.addClass("selected").attr("aria-selected",!0),this.triggerSelectEvent("add",e)},uncheck:function(e){e.removeClass("selected no-checkbox").attr({"aria-selected":!1,tabindex:"-1"}),this.triggerSelectEvent("remove",e)},toggle:function(e){e.hasClass("selected")?this.uncheck(e):this.check(e)},triggerSelectEvent:function(e,t){var i=t.map(function(){return $(this).attr("data-cid")}).toArray();this.view.trigger("selection:"+e,i)},set:function(e,t){if(_.isArray(e)){var i=this.getItems(),o={};if(this.clear(),_(e).each(function(e){var t="string"==typeof e?e:_.cid(e);o[t]=!0}),i=i.filter(function(){return $(this).attr("data-cid")in o}),this.check(i),i.length){var n=i.last().attr("tabindex","0");t&&n.focus()}this.triggerChange()}},triggerAction:function(e){var t=$(e.currentTarget).attr("data-cid");this.view.trigger("selection:action",[t])},triggerDouble:function(e){var t=$(e.currentTarget).attr("data-cid");this.view.trigger("selection:doubleclick",[t])},triggerChange:function(e,t){e=e||this.getItems();var i=this.get(),o="selection:change";0===i.length?o+=" selection:empty":1===i.length?o+=" selection:one":i.length>1&&(o+=" selection:multiple"),e&&e.length>0&&e.length===i.length&&(1!==e.length||!$(e[0]).hasClass("no-checkbox"))?o+=" selection:all":o+=" selection:subset",this.view.trigger(o,i,t)},clear:function(e){e=e||this.getItems(),this.resetTabIndex(e),this.resetCheckmark(e),this.reset()},reset:function(){this.triggerChange()},remove:function(e,t){(t=t||this.getNode(e)).is(".selected")&&this.triggerChange()},isRange:function(e){return e&&e.shiftKey},isCheckmark:function(e){return e&&$(e.target).is(".list-item-checkmark, .fa.fa-checkmark")},isMultiple:function(e){return e&&(e.metaKey||e.ctrlKey||/35|36/.test(e.which)||this.isCheckmark(e))},isEmpty:function(){return _.isEmpty(this.get())},resetTabIndex:function(e,t){(e=e.filter('[tabindex="0"]')).not(t).attr("tabindex","-1")},resetCheckmark:function(e){e=e.filter(".selected").removeClass("selected no-checkbox").attr("aria-selected",!1),this.triggerSelectEvent("remove",e)},resetSwipe:function(e){var t=e.filter(".swipe-left");return t.removeClass("swipe-left").find(".swipe-left-content").remove(),!!t.length},focus:function(e,t,i){var o=(t=t||this.getItems()).eq(e).attr("tabindex","0");return!1!==i&&(_.device("ie")?_.defer(function(){o.focus()}):o.focus()),_.device("chrome < 48")&&o.hide(0,function(){$(this).show()}),o},pick:function(e,t,i,o){var n;t=t||this.getItems(),this.isRange(i)?this.pickRange(e,t):(t.removeClass("precursor"),n=this.focus(e,t,o).addClass("precursor"),this.isMultiple(i)?this.pickMultiple(n,t):this.pickSingle(n))},pickRange:function(e,t){var i=this.getPosition(t,e),o=Math.min(e,i),n=Math.max(e,i);$(t.slice(o,n+1)).removeClass("no-checkbox"),this.check(t.slice(o,n+1)),this.focus(e,t)},pickMultiple:function(e,t){e.hasClass("selected no-checkbox")?e.removeClass("no-checkbox"):(t.filter(".no-checkbox").removeClass("selected no-checkbox").attr("aria-selected",!1),this.toggle(e))},pickSingle:function(e){this.check(e)},select:function(e,t,i){e>=(t=t||this.getItems()).length||(this.resetCheckmark(t),this.resetTabIndex(t,t.eq(e)),this.pick(e,t,null,i),this.selectEvents(t))},selectEvents:function(e){this.triggerChange(e)},selectAll:function(e){var t=(e=_.isString(e)?this.getItems(e):e||this.getItems()).slice(0,e.length);t.removeClass("no-checkbox precursor"),t.first().addClass("precursor"),this.check(t),this.focus(0,e),this.triggerChange(e)},selectNone:function(){this.clear(),this.triggerChange()},move:function(e){var t=this.getItems(),i=this.getPosition()+e;i<0?i=0:i>=t.length&&(i=t.length-1),this.select(i,t)},previous:function(){this.move(-1),this.view.trigger("selection:action",this.get())},next:function(){this.move(1),this.view.trigger("selection:action",this.get())},dodge:function(){var e=this.getItems(),t=e.filter(".selected"),i=t.length,o=e.index(t.first()),n=e.index(t.last()),a=e.length-1,r=this.select.bind(this),s=this.getDirection(),l=$.contains(this.view.el,document.activeElement);return e.length===i?this.clear():"up"===s&&o>0?r(o-1,e,l):"down"===s&&n<a?r(n+1,e,l):void e.slice(o).each(function(t){if(!$(this).hasClass("selected"))return r(o+t,e,l),!1})},onCursor:function(e){var t=this.view.$el.hasClass("grid-layout"),i=/37|39/.test(e.which);if(t||!i){var o=this.getItems(),n=$(document.activeElement),a=o.index(n)||0,r=parseInt(this.view.$el.attr("grid-count")||1,10),s=a%r,l=/38|40|35|36/.test(e.which),d=/37|38|36/.test(e.which),c=t&&l?r:1;if(a+=d?-c:+c,c>1&&/40|35/.test(e.which)&&a>=o.length&&s>=o.length%r&&(a=o.length-1),!1!==(a=this.outOfBounds(a,o))){e.preventDefault(),this.isMultiple(e)&&(a=/38|36/.test(e.which)?0:-1);var u=o.eq(a);this.resetTabIndex(o,u),this.resetCheckmark(o),this.pick(a,o,e),this.getPosition(),this.isMultiple(e)||this.isRange(e)?this.triggerChange(o,u.attr("data-cid")):this.selectEvents(o)}}},outOfBounds:function(e,t){return!(e<0)&&(e>=t.length?(this.view.$el.scrollTop(16777215),!1):e)},onPageUpDown:function(e){e.preventDefault();var t,i=this.getItems().first().outerHeight();i&&(t=Math.floor(this.view.$el.height()/i),33===e.which?this.move(-t):this.move(t))},onKeydown:function(e){switch(e.which){case 13:case 32:this.triggerAction(e);break;case 65:case 97:e.ctrlKey||e.metaKey||s?(e.preventDefault(),this.selectAll()):65!==e.which||e.shiftKey||e.altKey||this.view.trigger("selection:archive",this.get());break;case 91:s=!0,setTimeout(function(){s=!1},2e3);break;case 8:case 46:if(e.ctrlKey||e.metaKey||e.altKey)return;e.preventDefault(),this.view.trigger("selection:delete",this.get(),e.shiftKey);break;case 35:case 36:case 37:case 38:case 39:case 40:this.onCursor(e);break;case 33:case 34:this.onPageUpDown(e)}},onMousedown:function(){this.view.mousedown=!0},onMouseup:function(){this.view.mousedown=!1},onClick:function(e,t){if(t=t||{},"tap"===e.type&&(e.preventDefault(),e.stopPropagation()),("mousedown"!==e.type||this.isMultiple(e)||!$(e.currentTarget).is(".selected"))&&("click"!==e.type||!this.isMultiple(e)||n)){var i=this.getItems(),o=$(e.currentTarget),a=i.index(o)||0,r=this.get();n&&this.resetSwipe(i)||e.isDefaultPrevented()&&"tap"!==e.type||(this.isMultiple(e)||this.resetCheckmark(i),this.resetTabIndex(i,i.eq(a)),this.pick(a,i,e),t.customEvents||_.isEqual(r,this.get())||this.triggerChange(i,$(e.currentTarget).attr("data-cid")))}},onSwipeDelete:function(e){e.preventDefault();var t=$(this.currentSelection).closest(o),i=t.attr("data-cid"),n=t.nextAll(),a=this,r=function(){this.removeAttr("style"),_(this).each(function(e){var t=$(e).data("velocity");t.transformCache={},$(e).data("velocity",t)}),a.view.off("remove-mobile",r)};n.length>0?n.velocity({translateY:"-84px"},{duration:200,complete:function(){a.view.on("remove-mobile",r,n),a.view.trigger("selection:delete",[i]),a.currentSelection.swipeCell.remove(),a.currentSelection.swipeCell=null,$(a.view).removeClass("unfolded"),a.currentSelection.unfolded=a.unfold=!1}}):(a.view.on("remove-mobile",r,n),a.view.trigger("selection:delete",[i]),a.currentSelection.swipeCell.remove(),a.currentSelection.swipeCell=null,$(a.view).removeClass("unfolded"),a.currentSelection.unfolded=a.unfold=!1)},onSwipeMore:function(e){e.preventDefault();var t=$(this.currentSelection).closest(o).attr("data-cid"),i=this;this.view.trigger("selection:more",[t],$(this.currentSelection.btnMore)),_.delay(function(){i.resetSwipeCell.call(i.currentSelection,i)},250)},isAnyCellUnfolded:function(){return!!this.unfold},resetSwipeCell:function(e,t,i){var o=this;try{e.startX=0,e.startY=0,e.unfold=!1,e.target=null,e.otherUnfolded=!1,i?($(o).removeAttr("style"),$(o).removeClass("unfolded"),o.swipeCell&&o.swipeCell.remove(),o.swipeCell=null):$(o).velocity({translateX:[0,t]},{duration:100,complete:function(){$(o).removeAttr("style"),$(o).removeClass("unfolded"),o.swipeCell&&o.swipeCell.remove(),o.swipeCell=null}})}catch(e){console.warn("something went wrong during reset",e)}},onTouchStart:function(e){var t=e.originalEvent.touches[0],i=t.pageX,o=t.pageY,n=$(this).css("transition","");this.startX=i,this.startY=o,this.distanceX=0,this.unfold=this.remove=this.scrolling=this.isMoving=!1,this.unfolded=n.hasClass("unfolded"),this.otherUnfolded=n.siblings().hasClass("unfolded"),!this.unfolded&&this.otherUnfolded&&e.data.resetSwipeCell.call(e.data.currentSelection,e.data,-190)},onTouchMove:function(e){var t=e.originalEvent.touches[0].pageX;if(!(e.originalEvent.touches.length>1||(this.distanceX=-1*(this.startX-t),this.scrolling=!1,t>this.startX&&!this.unfolded&&this.distanceX<=20)))if(e.data.isScrolling)this.scrolling=!0;else if(this.unfolded&&(this.distanceX+=-190),Math.abs(this.distanceX)>20||this.isMoving){if(e.preventDefault(),this.isMoving=!0,e.data.view.isSwiping=!0,this.target||(this.target=$(e.currentTarget)),this.swipeCell||(this.swipeCell=$('<div class="swipe-option-cell">').append(this.btnDelete=$('<div class="swipe-button delete">').append($('<i class="fa fa-trash" aria-hidden="true">')),this.btnMore=$('<div class="swipe-button more">').append(this.faBars=$('<i class="fa fa-bars" aria-hidden="true">'))).css("height",this.target.outerHeight()+"px"),this.target.before(this.swipeCell)),this.distanceX+20<=0||this.unfolded&&this.distanceX<=0){var i=this.unfolded?this.distanceX:this.distanceX+20;this.target.css({"-webkit-transform":"translate3d("+i+"px,0,0)",transform:"translate3d("+i+"px,0,0)"})}Math.abs(this.distanceX)>=250&&!this.expandDelete?(this.expandDelete=!0,this.btnDelete.css("width","100%"),this.btnMore.css("width",0),this.faBars.css("opacity",0)):this.expandDelete&&Math.abs(this.distanceX)<=250&&(this.expandDelete=!1,this.btnDelete.css("width","95px"),this.faBars.css("opacity",1),this.btnMore.removeAttr("style"))}},onTouchEnd:function(e){if(!this.scrolling)if(this.remove=this.unfold=e.data.view.isSwiping=!1,this.isMoving=!1,this.distanceX>0&&!this.unfolded)e.data.resetSwipeCell.call(this,e.data,0,!0);else{if(this.unfolded&&this.distanceX<=10)return e.data.resetSwipeCell.call(e.data.currentSelection,e.data,0===this.distanceX?-190:this.distanceX),!1;if(this.otherUnfolded&&Math.abs(this.distanceX)<=10)return!1;if(Math.abs(this.distanceX)>=40&&(this.unfold=!0),this.expandDelete&&(this.remove=!0,this.unfold=!1),i=$(this),this.unfold)this.expandDelete=!1,i.velocity({translateX:[-190,this.distanceX]},{duration:100,complete:function(){i.addClass("unfolded")}}),e.data.unfold=!0,e.data.currentSelection=this;else if(this.remove){var t=this,n=e.data.view,a=function(){this.removeAttr("style"),_(this).each(function(e){var t=$(e).data("velocity");t&&(t.transformCache={})}),n.off("remove-mobile",a)};$(this).velocity({translateX:["-100%",this.distanceX]},{duration:50,complete:function(){t.btnMore.remove(),t.startX=t.startY=0,i.data("velocity").transformCache={};var e=$(t).nextAll();if(e.length>0)e.velocity({translateY:"-84px"},{duration:200,complete:function(){var i=$(t).closest(o).attr("data-cid");n.on("remove-mobile",a,e),n.trigger("selection:delete",[i]),t.swipeCell.remove(),t.swipeCell=null,$(t).removeClass("unfolded"),t.unfolded=t.unfold=!1}});else{var r=$(t).closest(o).attr("data-cid");n.on("remove-mobile",a,e),n.trigger("selection:delete",[r]),t.swipeCell.remove(),t.swipeCell=null,$(t).removeClass("unfolded"),t.unfolded=t.unfold=!1}}})}else if(this.distanceX)return e.data.resetSwipeCell.call(this,e.data,Math.abs(this.distanceX)),!1;ox.off("delete:canceled").on("delete:canceled",function(){i.removeAttr("style"),i.nextAll().velocity({translateY:NaN})})}},onSwipeLeft:function(e){var t=$(e.currentTarget);t.hasClass("swipe-left")||(this.resetSwipe(this.getItems()),this.renderInplaceRemove(t),t.addClass("swipe-left"))},onSwipeRight:function(e){this.resetSwipe($(e.currentTarget))},inplaceRemoveScaffold:$('<div class="swipe-left-content"><i class="fa fa-trash-o" aria-hidden="true"></i></div>'),renderInplaceRemove:function(e){e.append(this.inplaceRemoveScaffold.clone())},onTapRemove:function(e){e.preventDefault(),e.stopImmediatePropagation();var t=$(e.currentTarget).closest(o).attr("data-cid");this.view.trigger("selection:delete",[t])},onFocus:function(){var e=this.getItems(),t=e.filter('[tabindex="0"]:first'),i=e.index(t);i=i<0?0:i,this.focus(i,e)},getBehavior:function(){return this.behavior}},d={registerEvents:function(){this.view.$el.on("mousedown",$.proxy(this.onMousedown,this)).on("mouseup",$.proxy(this.onMouseup,this)).on("keydown",o,$.proxy(this.onKeydown,this)).on(n?"tap":"mousedown click",o,$.proxy(this.onClick,this)).on("focus",$.proxy(function(){this.view.mousedown||this.onFocus()},this)).on(n?"tap":"click",o,$.proxy(function(e){this.isMultiple(e)||this.triggerAction(e)},this)).on("dblclick",o,$.proxy(function(e){e.ctrlKey||e.metaKey||this.triggerDouble(e)},this)).on("contextmenu",function(e){e.preventDefault()}),this.view.options.swipe&&(n&&_.device("android || ios")&&_.device("smartphone")&&!a?this.view.$el.on("touchstart",o,this,this.onTouchStart).on("touchmove",o,this,this.onTouchMove).on("touchend",o,this,this.onTouchEnd).on("tap",".swipe-button.delete",$.proxy(function(e){this.onSwipeDelete(e)},this)).on("tap",".swipe-button.more",$.proxy(function(e){this.onSwipeMore(e)},this)):n&&this.view.$el.on("swipeleft",o,$.proxy(this.onSwipeLeft,this)).on("swiperight",o,$.proxy(this.onSwipeRight,this)).on("tap",".swipe-left-content",$.proxy(this.onTapRemove,this)))}},c={pickSingle:function(e){e.addClass("selected no-checkbox").attr("aria-selected",!0),this.view.trigger("selection:subset")},onKeydown:function(e){if(32===e.which){e.preventDefault();var t=this.getItems().filter(".selected");1===t.length?t.find(".list-item-checkmark").trigger("mousedown"):0===t.length&&(t=$(this.getItems()[this.getItems().index($(document.activeElement))])).find(".list-item-checkmark").trigger("mousedown")}else l.onKeydown.call(this,e)},outOfBounds:function(e,t){return e<0?0:(e>=t.length&&(e=t.length-1,this.view.$el.scrollTop(16777215)),e)},onClick:function(e){var t=this.get(),i=$(e.currentTarget),o="mousedown"===e.type&&!this.isMultiple(e)&&!i.is(".selected");l.onClick.call(this,e,{customEvents:o}),o&&this.selectEvents(),_.isEqual(t,this.get())&&"mousedown"===e.type&&this.isMultiple(e)&&this.triggerChange(this.getItems(),i.attr("data-cid"))},selectEvents:function(e){if(e=e||this.getItems(),"list"===(this.view.app&&this.view.app.props.get("layout")||"list"))this.triggerChange(e);else{var t=this.get(),i="selection:change selection:action";e&&e.length>0&&e.length===t.length&&(1!==e.length||!$(e[0]).hasClass("no-checkbox"))?i+=" selection:all":i+=" selection:subset",t.length>1&&(i+=" selection:multiple"),this.view.trigger(i,t)}}},u={registerEvents:function(){this.view.$el.addClass("focus-indicator"),this.view.$el.on("click",o,$.proxy(this.onClick,this)).on("keydown",o,$.proxy(this.onKeydown,this)).on("focus",$.proxy(this.onFocus,this)).on("mousedown",$.proxy(this.onMousedown,this)).on("mouseup",$.proxy(this.onMouseup,this)),this.view.on("selection:empty",$.proxy(this.onSelectionEmpty,this))},isMultiple:function(){return!0},onSelectionEmpty:function(){this.getItems().parent().find("li:focus").length>0||(this._lastposition=-1)},onFocus:function(){if(!this.view.mousedown){var e=this.getItems(),t=e.filter('[tabindex="0"]:first'),i=e.index(t);this.focus(i>-1?i:0,e)}},onClick:function(e){var t=this.getItems(),i=$(e.currentTarget),o=t.index(i);this.resetTabIndex(t,t.eq(o)),this.pick(o,t,e),this.triggerChange(t,i.attr("data-cid")),this.setPosition(e)},onKeydown:function(e){switch(e.which){case 13:case 32:this.onSpace(e);break;case 38:case 40:this.onCursor(e);break;case 65:case 97:(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.selectAll());break;case 68:case 100:(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.selectNone(),this.focus(0))}},onSpace:function(e){this.onClick(e),e.preventDefault()},setPosition:function(e,t){this._lastposition=_.isUndefined(t)?this.getItems().index($(e.target).closest("li"))||0:t},getPosition:function(e,t){return this._lastposition>-1?this._lastposition:t},onCursor:function(e){var t=this.getItems(),i=$(document.activeElement),o=t.index(i)||0,n=40===e.which;if(e.preventDefault(),/^(40|38)$/.test(e.which)){if(o+=n?1:-1,o=this.outOfBounds(o,t),this.isRange(e))return this.setPosition(e),this.pickRange(o,t);this.triggerChange(t,i.attr("data-cid")),this.setPosition(e,o),this.focus(o,t)}}};return _.extend(t.prototype,l),t}),define("io.ox/mail/detail/content",["io.ox/mail/api","io.ox/mail/util","io.ox/core/util","io.ox/core/extensions","io.ox/core/capabilities","io.ox/mail/detail/links","io.ox/mail/sanitizer","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,o,n,a,r,s,l){function d(e){return/target="[^"]*"/.test(e)?e.replace(/(target="[^"]*")/i,'target="_blank"'):e.replace(">",' target="_blank" rel="noopener">')}function c(e,t){return/^[^:.#]+:/.test(t)?e:/^#/.test(t)?e:e.replace(t,"http://"+t)}function u(e,t,i){_(e.querySelectorAll(t)).each(i)}function p(e,t){for(;e;)if((e=e.parentNode)&&e.matches&&e.matches(t))return!0;return!1}function f(e,t){var i=3===e.nodeType&&String(e.nodeValue).trim()||"",o=i?i+" ":"";return _(e.childNodes).each(function(e){"STYLE"!==e.tagName&&(t&&"BLOCKQUOTE"===e.tagName||(o+=f(e,t)))}),o}function h(e){13!==e.which&&23!==e.which&&"click"!==e.type||(e.preventDefault(),e.stopPropagation(),$(this).hide().prev().show(),_.delay(function(){$(e.delegateTarget).trigger("resize").trigger("toggle-blockquote")},20),$(this).remove())}var g=/^text\/html$/i,m={empty:function(e){""===e.source&&(e.stopPropagation(),e.source=e.isHTML?'<div class="no-content">'+l("This mail has no content")+"</div>":l("This mail has no content"))},images:function(e){e.source=t.replaceImagePrefix(e.source)},plainTextLinks:function(e){e.isLarge||(e.source=e.source.replace(/(<a href="https?:\/\/[^"]+" target="_blank">https?:\/\/[^<]+<\/a>) &lt;<a href="https?:\/\/[^"]+" target="_blank">https?:\/\/[^<]+<\/a>&gt;/g,"$1"))},removeWBR:function(e){e.isLarge||(e.source=e.source.replace(/<wbr>/g,""))},linkTarget:function(e){e.source=e.source.replace(/<a[^>]*href=(?:"|')((?!https?:\/\/)[^'">]+)(?:"|')[^>]*>/g,c).replace(/<a[^>]*href\s*=\s*(?:"|')(https?:\/\/[^>]+)(?:"|')[^>]*>/g,d)},whitespace:function(e){e.isLarge||(e.source=e.source.replace(/^(<div[^>]+>)(\s|&nbsp;|\0x20|<br\/?>|<p[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/p>|<div[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/div>)+/g,"$1").replace(/\s*<\/html>\s*$/g,"").replace(/(\s|&nbsp;|\0x20|<br\/?>|<p[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/p>|<div[^>]*>(\s|<br\/?>|&nbsp;|&#160;|\0x20)*<\/div>)+<\/div>$/g,""))},linkDisable:function(e){return e.replace(/(<a[^>]*)>/g,'$1 disabled="disabled" aria-disabled="true">')},linkRemoveRef:function(e){return e.replace(/(<a[^>]+?href[\s]*=[\s]*["']).*?(["'][^>]*)>/g,"$1#$2>")},linkRemoveStyle:function(e){return e.replace(/(<a[^>]+?style[\s]*=[\s]*["'])(.*?)(["'][^>]*>)/g,function(e,t,i,o){return t+i.replace(/(^|;|\s)color:[^;]+?($|;)/g,"").replace(/text-decoration:[^;]+?($|;)/g,"")+o})},tableHeight:function(e){(_.browser.safari||e.isHTML)&&(e.source=e.source.replace(/(<table[^>]+?style[\s]*=[\s]*["'])(.*?)(["'][^>]*>)/g,function(e,t,i,o){return t+i.replace(/[^-]height:\s100%\s!important/,"height: auto")+o}))},anchorLinks:function(e){e.isHTML&&this.addEventListener("click",function(e){if($(e.target).is('a[href^="#"]')){e.preventDefault();var t=$.escape($(e.target).attr("href").substr(1)),i=$(this).find("#"+t+', [name="'+$.escape(t)+'"]');i.length&&i[0].scrollIntoView()}},!1)},disableLinks:function(e){(t.isMalicious(e.data)||t.authenticity("block",e.data))&&(t.isWhiteListed(e.data)||$(this).addClass("disable-links").on("click",function(){return!1}))},pseudoBlockquotes:function(e){e.isHTML&&u(this,'div[style*="none none none solid"][style*="1.5pt"]',function(e){$(e).replaceWith($('<blockquote type="cite">').append($(e).contents()))})},nested:function(t){if(t.isHTML){var i=t.data;!("folder_id"in i)&&"filename"in i&&u(this,'img[src^="cid:"]',function(o){var n,a="<"+String(o.getAttribute("src")||"").substr(4)+">",r=_.chain(t.data.attachments).filter(function(e){return e.cid===a}).first().value();r&&(n=e.getUrl(_.extend(r,{mail:i.parent}),"view"),o.setAttribute("src",n))})}},fixedWidth:function(e){e.isText&&s.get("useFixedWidthFont",!1)&&$(this).addClass("fixed-width-font")},colorQuotes:function(){s.get("isColorQuoted",!0)&&$(this).addClass("colorQuoted")},cleanBlockquotes:function(){u(this,"blockquote",function(e){var t=/border:\s*(none|0)/i.test(e.getAttribute("style"));e.removeAttribute("style"),e.removeAttribute("type"),t&&(e.style.border="0")})},checkLinks:function(e){var t=e.data.headers["X-Open-Xchange-Share-URL"];u(this,"a",function(e){var i,o,n=$(e),r=n.attr("href")||"";if(a.isInternalDeepLink(r))return i=a.parseDeepLink(r),/^(\d+)\.\1\/\d+$/.test(i.id)&&(i.id=i.id.replace(/^\d+\./,"")),/^\d+\./.test(i.id)&&(i.id=i.id.replace(/\./,"/")),n.addClass(i.className).data(i),void(t&&n.attr("href")===t&&n.addClass("deep-link-app"));n.removeClass("deep-link-files","deep-link-contacts","deep-link-calendar","deep-link-tasks","deep-link-gdpr","deep-link-app"),r.search(/^\s*mailto:/i)>-1?(n.addClass("mailto-link").attr("target","_blank"),(o=n.text()).search(/^mailto:/)>-1&&(o=(o=o.substring(7)).split(/\?/,2)[0],n.text(o))):n.attr("href")?(n.attr({rel:"noopener",target:"_blank"}),n.attr("href",n.attr("href").replace(/"/g,"%22"))):r||n.removeAttr("href")})},autoCollapse:function(e){!1!==e.options.autoCollapseBlockquotes&&!0===s.get("features/autoCollapseBlockquotes",!0)&&(u(this,"blockquote",function(e){if(!(p(e,"blockquote")||f(e).length<500)){var t=_.uniqueId("collapsed-blockquote-"),i=$('<button type="button" class="bqt">').attr("title",l("Show quoted text")).append($('<span aria-hidden="true">').text("..."));_.browser.Chrome||i.attr({"aria-controls":t,"aria-expanded":!1});var o=[i],n=f(e,!0).replace(/<\s/g,"<").replace(/\s>/g,">").replace(/("'\s?|\s?'")/g,"").replace(/[-_]{3,}/g,"");n.length>500?o.push($.txt(n.substr(0,210).replace(/\s\S{1,10}$/," ")+"…"),$("<br>"),$.txt("…"+n.substr(-210).replace(/^\S{1,10}\s/," "))):o.push($.txt(n)),$(e).addClass("collapsed-blockquote").hide().attr("id",t).after($('<div class="blockquote-toggle">').append(o))}}),$(this).on("click keydown",".blockquote-toggle",h))},checkSimple:function(){var e=$(this);0===e.find("table").length&&e.addClass("simple-mail")},formSubmit:function(){$(this).on("submit","form",function(e){e.preventDefault();var t=_.uniqueId("blank");blankshield.open("javascript:0",t),this.target=t,setTimeout(this.submit.bind(this))})}};o.point("io.ox/mail/detail/source").extend({id:"empty",index:100,process:m.empty}),o.point("io.ox/mail/detail/source").extend({id:"images",index:200,process:m.images}),o.point("io.ox/mail/detail/source").extend({id:"plain-text-links",index:300,process:m.plainTextLinks}),o.point("io.ox/mail/detail/source").extend({id:"remove-wbr",index:400,process:m.removeWBR}),o.point("io.ox/mail/detail/source").extend({id:"link-target",index:500,process:m.linkTarget}),o.point("io.ox/mail/detail/source").extend({id:"table-height",index:550,process:m.tableHeight}),o.point("io.ox/mail/detail/source").extend({id:"white-space",index:600,process:m.whitespace}),o.point("io.ox/mail/detail/source").extend({id:"disable-links",index:700,enabled:s.get("maliciousCheck"),process:function(e){(t.isMalicious(e.data)||t.authenticity("block",e.data))&&(t.isWhiteListed(e.data)||(e.source=e.source.replace(/.*/g,m.linkDisable).replace(/.*/g,m.linkRemoveRef).replace(/.*/g,m.linkRemoveStyle)))}}),o.point("io.ox/mail/detail/content-general").extend({id:"anchor-links",index:100,process:m.anchorLinks}),o.point("io.ox/mail/detail/content-general").extend({id:"disable-links",index:200,process:m.disableLinks}),o.point("io.ox/mail/detail/content").extend({id:"pseudo-blockquotes",index:100,process:m.pseudoBlockquotes}),o.point("io.ox/mail/detail/content").extend({id:"nested",index:500,process:m.nested}),o.point("io.ox/mail/detail/content").extend({id:"fixed-width",index:600,process:m.fixedWidth}),o.point("io.ox/mail/detail/content").extend({id:"color-quotes",index:700,process:m.colorQuotes}),o.point("io.ox/mail/detail/content").extend({id:"clean-blockquotes",index:800,process:m.cleanBlockquotes}),o.point("io.ox/mail/detail/content").extend({id:"check-links",index:900,process:m.checkLinks}),o.point("io.ox/mail/detail/content").extend({id:"auto-collapse",index:1e3,process:m.autoCollapse}),o.point("io.ox/mail/detail/content").extend({id:"check-simple",index:1100,process:m.checkSimple}),o.point("io.ox/mail/detail/content").extend({id:"form-submit",index:1200,process:m.formSubmit}),o.point("io.ox/mail/detail/content").extend({id:"image-load",index:1200,process:function(){var e=this;$(e).find('img[src!=""]').each(function(){$(this).on("load error",function(){$(e).trigger("imageload")})})}}),o.point("io.ox/mail/detail/beautify").extend({id:"no-ampersand",process:function(e){e.data=e.data.replace(/&/g,"&amp;")}},{id:"trim",process:function(e){e.data=e.data.trim()}},{id:"carriage-return",process:function(e){e.data=e.data.replace(/\r/g,"")}},{id:"multiple-empty-lines",process:function(e){s.get("transform/multipleEmptyLines",!0)&&(e.data=e.data.replace(/\n{4,}/g,"\n\n\n"))}},{id:"text-to-html",process:function(e){e.data=this.text2html(e.data,{blockquotes:!0,images:!0,links:!0})}},{id:"br",process:function(e){e.data=e.data.replace(/^\s*(<br\s*\/?>\s*)+/g,"")}},{id:"white-space",process:function(e){e.data=e.data.replace(/((>) |( ) )/g,"$1&nbsp;")}});var v={extensions:m,get:function(e,t,i){if(!e||!e.attachments)return{content:$(),isLarge:!1,type:"text/plain"};var n,a=new o.Baton(_({data:e,options:t||{},source:"",type:"text/plain",flow:i}).omit(function(e){return void 0===e})),l=/^text\/(plain|html)$/i,d=/^image\//i;try{_(e.attachments).find(function(e){return!("attachment"===e.disp||"none"===e.disp||!l.test(e.content_type))&&(a.type=e.content_type.toLowerCase(),!0)}),_(e.attachments).each(function(t){"inline"===t.disp&&(t.content_type===a.type?a.source+=t.content:"text/plain"===a.type&&d.test(t.content_type)&&s.get("allowHtmlMessages",!0)&&(a.source+="\n!(api/image/mail/picture?"+$.param({folder:e.folder_id,id:e.id,uid:t.filename,scaleType:"contain",width:1024})+")\n"))}),a.source=a.source.trim(),a.isHTML=g.test(a.type),a.isText=!a.isHTML,a.isLarge=a.source.length>1024*(_.device("chrome >= 30")?64:32),o.point("io.ox/mail/detail/source").invoke("process",$(),a),a.isHTML?(a.source=r.sanitize({content_type:"text/html",content:a.source}).content,(n=document.createElement("HTML")).innerHTML=a.source,(n=n.getElementsByTagName("body")[0]).className=n.className+" mail-detail-content noI18n",u(n,"script, base, meta",function(e){e.parentNode.removeChild(e)})):((n=document.createElement("DIV")).className="mail-detail-content plain-text noI18n",a.source=v.beautifyPlainText(a.source),n.innerHTML=a.source),o.point("io.ox/mail/detail/content-general").invoke("process",n,a),a.isLarge||o.point("io.ox/mail/detail/content").invoke("process",n,a)}catch(t){console.error("mail.getContent",t.message,t,e)}return{content:n,isLarge:a.isLarge,type:a.type,isText:a.isText}},beautifyPlainText:function(e){var t=o.Baton({data:e});return o.point("io.ox/mail/detail/beautify").invoke("process",this,t),r.simpleSanitize(t.data)},transformForHTMLEditor:function(e){return this.text2html(e,{blockquotes:!0,links:!0})},text2html:function(){function e(e,t){var i=e.exec(t);return i&&i[0]}function t(c,u){var p,f="";for(u=u||d;c;)if(u.blockquotes&&(p=e(o,c)))c=c.substr(p.length),f+='<blockquote type="cite">'+(p=t(p=p.replace(/^(>(>)|> |>$)/gm,"$2"),u).replace(/(<br>)?(<\/?blockquote[^>]*>)(<br>)?/g,"$2").replace(/<br>$/,""))+"</blockquote>";else if(p=e(n,c))c=c.substr(p.length),f+=p.replace(/\n/g,"<div><br></div>");else if(p=e(a,c))c=c.substr(p.length),p=p.replace(/</g,"\r&lt;"),u.images&&(p=p.replace(l,i)),u.links&&/(http|@)/i.test(p)&&(p=p.replace(r,function(e,t,i){return'<a href="'+(t=t.replace(/@/g,"&#64;"))+'" rel="noopener" target="_blank">'+t+"</a>"+i}).replace(s,function(e,t){return'<a href="mailto:'+t+'">'+t+"</a>"})),f+="<div>"+p.replace(/\r/g,"").replace(/\n+/g,function(e){return"</div>"+new Array(e.length).join("<div><br></div>")+"<div>"})+"</div>";else if(c){ox.debug&&console.error("Ooops",f+"\n\n"+c);break}return f=f.replace(/<div><\/div>/g,"")}function i(e){return'<img src="'+e.substr(2,e.length-3)+'" alt="">'}var o=/^>+( [^\n]*|)(\n>+( [^\n]*|))*\n?/,n=/^\n+/,a=/^[^\n]*(\n(?![ ]*(> ))[^\n]*)*\n?/,r=/(https?:\/\/.*?)([!?.,>()]\s|\s|[!?.,>()]$|$)/gi,s=/([^@"\s<,:;|()[\]\u0100-\uFFFF]+?@[^@\s]*?(\.[\w-]+)+)/g,l=/^!\([^)]+\)$/gm,d={blockquotes:!0,images:!0,links:!0};return t}()};return v}),define("io.ox/mail/detail/links",["io.ox/mail/api","io.ox/core/util","io.ox/core/extensions","settings!io.ox/mail","gettext!io.ox/mail"],function(e,t,i,o,n){function a(e){var t=e.match(/^https?:\/\/([^\/#]+)/i);return null!==t&&0!==t.length&&("test"===t[1]||_(ox.serverConfig.hosts).indexOf(t[1])>-1)}function r(e){var t=$();return e.prefix&&(t=t.add(s(e.prefix))),t=t.add(e.replacement),e.suffix&&(t=t.add(s(e.suffix))),$(e.node).replaceWith(t),t}function s(e){if(_.isString(e)&&(e=$.txt(e)),3===e.nodeType){var t,i,o;for(t in x)if((i=x[t]).test(e)&&(o=i.process(e)))return r(o);return e}}var l,d,c,u,p=/^(io.ox\/office\/|io.ox\/(contacts|calendar|tasks)\/detail$)/;!function(){var e="all prefix link app params param name suffix".split(" "),t="all prefix link suffix".split(" "),i={"io.ox/contacts":"contacts","io.ox/calendar":"calendar","io.ox/tasks":"tasks","io.ox/infostore":"files","io.ox/files":"files",infostore:"files"},o={contacts:n("Contact"),calendar:n("Appointment"),tasks:n("Task"),files:n("File"),infostore:n("File"),"io.ox/office/text":n("Document"),"io.ox/office/spreadsheet":n("Spreadsheet")},r={contacts:n("Address Book"),calendar:n("Calendar"),tasks:n("Tasks"),files:n("Folder"),"io.ox/settings":n("Download")},s=/^([\s\S]*)(http[^#]+#!{0,2}&?app=([^&]+)((&(folder|id|item|perspective)=[^&\s]+)+))([\s\S]*)$/i,f=/^([\s\S]*)(http[^#]+#m=(contacts|calendar|tasks|infostore)((&(f|i)=[^&\s]+)+))([\s\S]*)$/i,h=/^([\s\S]*)(https?:\/\/.*?)([!?.,>()]\s[\s\S]*|\s[\s\S]*|[!?.,>()]$|$)/i;l=function(e){return s.test(e)||f.test(e)},d=function(e){return l(e)&&a(e)},c=function(o){var n=String(o).match(s.test(o)?s:f),a=_.object(e,n),r=_.deserialize(a.params,"&");a.app=i[a.app]||a.app,/^(files|infostore)$/.test(a.app)?a.className="deep-link-files":/^(contacts|calendar|tasks)$/.test(a.app)?a.className="deep-link-"+a.app:/^io.ox\/settings$/.test(a.app)&&"virtual/settings/personaldata"===r.folder?a.className="deep-link-gdpr":p.test(a.app)&&(a.className="deep-link-app");var l=String(o).match(h),d=_.object(t,l),c=r.folder&&r.id&&_.cid({folder:r.folder,id:r.id});return $.extend(a,{folder:r.f,id:r.i},{cid:c,folder:r.folder,id:r.id||r.item,perspective:r.perspective},d)},u=function(e){var t=c(e.nodeValue),i=("id"in t?o[t.app]:r[t.app])||n("Link"),s=$('<a href="#" target="_blank" class="deep-link" role="button">').attr("href",t.link).text(i);return t.className?(a(t.link)&&s.addClass(t.className).data(t),$(e).parent().attr("href")===t.link&&(e=$(e).parent().get(0)),{node:e,prefix:t.prefix,replacement:s,suffix:t.suffix}):null}}();var f=/^([\s\S]*?)(((http|https|ftp|ftps)\:\/\/|www\.)\S+)([\s\S]*)$/i,h=/^([\s\S]*?)(((http|https|ftp|ftps)\:\/\/|www\.)\S+)([\s\S]*)$/i,g=/^([\s\S]*?)([^"\s<,:;\(\)\[\]\u0100-\uFFFF]+@([a-z0-9äöüß\-]+\.)+[a-z]{2,})([\s\S]*)$/i,m=/^([\s\S]*?)([^"\s<,:;\(\)\[\]\u0100-\uFFFF]+@([a-z0-9äöüß\-]+\.)+[a-z]{2,})([\s\S]*)$/i,v=/^([\s\S]*?)(?:&quot;([^&]+)&quot;|"([^"]+)"|'([^']+)')(?:\s|<br>)+(?:<|&#60;)([^@]+@[^&].*?)(?:>|&#62;)([\s\S]*)$/,x={deeplink:{test:function(e){return-1!==e.nodeValue.indexOf("http")&&l(e.nodeValue)},process:u},"mail-address-complex":{test:function(e){return-1!==e.nodeValue.indexOf("@")&&(v.test(e.nodeValue)&&0===$(e).closest("a").length)},process:function(e){var t=e.nodeValue.match(v);if(null===t||0===t.length)return e;var i=t[1],o=t[2]||t[3]||t[4],n=t[5],a=t[6];return{node:e,prefix:i,replacement:$('<a href="#" class="mailto-link" target="_blank">').attr("href","mailto:"+n).data({address:n,name:o}).text(o),suffix:a}}},"mail-address":{test:function(e){return-1!==e.nodeValue.indexOf("@")&&(g.test(e.nodeValue)&&0===$(e).closest("a").length)},process:function(e){var t=e.nodeValue.match(m);if(null===t||0===t.length)return e;var i=t[1],o=t[2],n=t[4];return!/(http:|https:)$/i.test(i)&&!/^www\./i.test(o)&&{node:e,prefix:i,replacement:$('<a href="#" class="mailto-link" target="_blank">').attr("href","mailto:"+o).data({address:o}).text(o),suffix:n}}},url:{test:function(e){return!!/(http|www\.)/.test(e.nodeValue)&&(f.test(e.nodeValue)&&0===$(e).closest("a").length)},process:function(e){var i=e.nodeValue.match(h);if(null===i||0===i.length)return e;var o=i[1],n=i[2],a=i[5],r=t.fixUrlSuffix(n,a),s=r.url;return/^http/i.test(s)||(s="http://"+s),{node:e,prefix:o,replacement:$('<a href="#" target="_blank" rel="noopener">').attr("href",s).text(r.url),suffix:r.suffix}}},"long-character-sequences":{test:function(e){var t=e.nodeValue;return t.length>=30&&/[\S\u00A0]{30}/.test(t)&&0===$(e).closest("a").length},process:function(e){return{node:e,replacement:$.parseHTML(t.breakableHTML(e.nodeValue))}}}};return o.get("features/recognizeDates",!1)&&function(){function e(){return moment(p)}function t(e,t){var i,o=a(null===e?t:e);return o.isValid()?(null!==e&&(i=n(t))&&i.isValid()&&o.hour(i.hour()).minute(i.minute()),'<a href="#" class="calendar-link" data-start-time="'+o+'" role="button">'+t+"</a>"):t}function i(e){var t=e.match(s.day);return t?t[0]:null}function o(e){return _.escape(e).replace(/(\w\w[.?!]\s|$)/g,"$1").replace(/\x1D$/,"").split(/\x1D/)}function n(e){for(var t in v){var i=v[t][0].exec(e);if(i)return v[t][1](e,i)}return 0}function a(e){for(var t in m){var i=m[t][0].exec(e);if(i)return m[t][1](e,i)}return e=e.toLowerCase(),w[e]&&(e=w[e]),b[e]?b[e]():(console.error('Unsupported date "'+e+'"'),moment())}var r,s={},l={},d=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],c=["sonntag","montag","dienstag","mittwoch","donnerstag","freitag","samstag"],u=moment().year();(r={names:"(((this|next|last|diesen|nächsten|letzten)\\s)?("+d.join("|")+"|"+c.join("|")+"))",relative:"(yesterday|today|tomorrow|day\\safter\\stomorrow|gestern|heute|morgen|übermorgen)",date:"(\\d{1,2}\\.\\d{1,2}\\.\\d{2,4}|\\d{1,2}\\.\\d{1,2}\\.|(cw|kw|week)\\s?\\d{1,2})",time:"(\\d{1,2}\\:\\d\\d)(\\s?(h|a|am|p|pm))?",range:"((from|von)s)?(\\d{1,2}\\:\\d\\d)s?(-|to|bis)s?(\\d{1,2}\\:\\d\\d)"}).day="("+r.names+"|"+r.relative+"|"+r.date+")",["day","name","date","time"].forEach(function(e){s[e]=new RegExp(r[e],"i"),l[e]=new RegExp(r[e],"ig")});var p=moment().hour(12).minute(0),f=" 12:00",h="DD.MM.YYYY HH:mm",g="MM/DD/YYYY HH:mm",m=[[/\d{1,2}\.\d{1,2}\.\d{2,4}/,function(e){return moment(e+f,h)}],[/\d{1,2}\.\d{1,2}\./,function(e){return moment(e+u+f,h)}],[/\d{1,2}\/\d{1,2}\/\d{2,4}/,function(e){return moment(e+f,g)}],[/\d{1,2}\/\d{1,2}/,function(e){return moment(e+u+f,g)}],[/(cw|kw|week)\s?(\d{1,2})/i,function(t,i){return e().week(i[2])}]],v=[[/(\d{1,2}):(\d\d)h?/,function(e,t){return moment(0).hour(t[1]).minute(t[2])}],[/(\d{1,2}):(\d\d)\s?(am|pm|a|p)/,function(t,i){return moment(0).hour(i[1]).minute(i[2]).add("p"===e[3][0]?12:0,"h")}]],b={yesterday:function(){return e().subtract(1,"d")},today:function(){return e()},tomorrow:function(){return e().add(1,"d")},"day after tomorrow":function(){return e().add(2,"d")}},w={gestern:"yesterday",heute:"today",morgen:"tomorrow","übermorgen":"day after tomorrow"};_.range(0,7).forEach(function(t){var i=d[t],o=c[t];b["this "+i]=function(){return e().day(t)},b["last "+i]=function(){return e().day(t-7)},b["next "+i]=b[i]=function(){return e().day(t+7)},w["diesen "+o]="this "+i,w["letzten "+o]="last "+i,w["nächsten "+o]=w[o]="next "+i}),$(document).on("click",".calendar-link",function(e){e.preventDefault();var t=$(this).data("startTime"),i=$(this).data("endTime")||t+36e5;ox.load(["io.ox/calendar/edit/main"]).done(function(e){e.getApp().launch().done(function(){this.create({start_date:t,end_date:i})})})}),x.dates={test:function(e){var t=e.nodeValue;return(s.day.test(t)||s.time.test(t))&&(!e.parentNode||"A"!==e.parentNode.tagName)},process:function(e){var n,a=o(e.nodeValue),r=_(a).reduce(function(e,o){return n=i(o)||n||"today",e+o.replace(l.day,t.bind(null,null)).replace(l.range,t.bind(null,n)).replace(l.time,t.bind(null,n))},"");return{node:e,replacement:$.parseHTML(r)}}}}(),i.point("io.ox/mail/detail/content").extend({id:"links",index:100,process:function(e){e.isLarge||($(this).contents().each(function(){s(this)}),$(this).find("*:not(style)").contents().each(function(){s(this)}))}}),{handlers:x,isValidHost:a,isDeepLink:l,isInternalDeepLink:d,parseDeepLink:c,processDeepLink:u,processTextNode:s}}),define("io.ox/core/download",["io.ox/files/api","io.ox/mail/api","io.ox/core/capabilities","io.ox/backbone/views/modal","gettext!io.ox/core","io.ox/core/extensions"],function(e,t,i,o,n,a){function r(e){return{id:e.id,folder_id:e.folder||e.folder_id}}function s(e){return JSON.stringify(_.map(e,function(e){return e.managedId?e.managedId:e.id}))}function l(e){e+=(-1===e.indexOf("?")?"?":"&")+"callback=antivirus",i.has("antivirus")&&(e+="&scan=true"),$("#tmp").append($("<iframe>",{src:e,class:"hidden download-frame"}))}function d(e){e=e||{},i.has("antivirus")&&(e.url+="&scan=true");var t=_.uniqueId("iframe"),o=$("<iframe>",{src:"blank.html",name:t,class:"hidden download-frame"}),n=$("<form>",{iframeName:t,action:e.url,method:"post",target:t}).append($('<input type="hidden" name="body" value="">').val(e.body));_.device("ios")||$("#tmp").append(o),$("#tmp").append(n),n.submit()}function c(e){e&&(0===e.code.indexOf("ANTI-VIRUS-SERVICE")?(_($("#tmp iframe.hidden.download-frame")).each(function(t){-1!==t.contentDocument.head.innerHTML.indexOf(e.error_id)&&(e.dlFrame=t)}),new o({title:n(e.code.match(/0011/)?"Malicious file detected":"Anti-Virus warning"),point:"io.ox/core/download/antiviruspopup",model:new Backbone.Model(e)}).on("ignore",function(){if(e.url){var t=blankshield.open("blank.html","_blank");return t.callback_antivirus=function(e){c(e),t.close()},void(t.location=e.url.replace("&scan=true",""))}if(-1!==e.dlFrame.src.indexOf("blank.html")){var i=$('#tmp form[iframeName="'+e.dlFrame.name+'"]');if(!i.length)return;return i[0].action=i[0].action.replace("&scan=true",""),void i.submit()}_.device("safari")||(e.dlFrame.src=e.dlFrame.src.replace("&scan=true",""))}).on("cancel",function(){e.dlFrame&&$(e.dlFrame).remove()}).open()):require(["io.ox/core/yell"],function(t){t(e)}))}window.callback_antivirus=c;var u=_(["0008","0009","0011"]).map(function(e){return"ANTI-VIRUS-SERVICE-"+e});return a.point("io.ox/core/download/antiviruspopup").extend({index:100,id:"buttonThreatFound",render:function(e){if("ANTI-VIRUS-SERVICE-0011"===e.model.get("code")){var t={action:"ignore",label:n("Download infected file"),className:"btn-default"};_.device("!ios && safari")?this.addDownloadButton(_.extend(t,{href:e.model.get("dlFrame").src.replace("&scan=true","")})):(this.addButton(t),this.addButton({action:"cancel",label:n("Cancel"),className:"btn-primary"}))}}}),a.point("io.ox/core/download/antiviruspopup").extend({index:200,id:"buttonNotScanned",render:function(e){if("ANTI-VIRUS-SERVICE-0011"!==e.model.get("code")){var t={action:"ignore",label:n("Download unscanned file"),className:"btn-default"};_.device("!ios && safari")?this.addDownloadButton(_.extend(t,{href:e.model.get("dlFrame").src.replace("&scan=true","")})):(this.addButton({action:"cancel",label:n("Cancel"),className:"btn-default"}),this.addButton(t))}}}),a.point("io.ox/core/download/antiviruspopup").extend({index:300,id:"message",render:function(e){var t=e.model.get("error"),i="ANTI-VIRUS-SERVICE-0011"===e.model.get("code")?"av-danger":"av-warning";-1===u.indexOf(e.model.get("code"))&&(t=n("Unable to perform Anti-Virus check for the requested file(s)")),this.$body.addClass("av-dialog").addClass(i).append($('<i class="fa fa-warning" aria-hidden="true">'),$("<div>").text(t))}}),{url:l,multiple:d,window:function(e,t){if((t=t||{}).antivirus){e+=(-1===e.indexOf("?")?"?":"&")+"callback=antivirus",i.has("antivirus")&&(e+="&scan=true");var o=blankshield.open(e,"_blank");return o.callback_antivirus=function(t){t.url=e,c(t),o.close()},o}return blankshield.open(e,"_blank")},file:function(t){var o=_.device("ios")&&this.window("blank.html");e.get(t).done(function(n){t.version&&(n=_.extend({},n,{version:t.version})),t.filename&&(n=_.extend(n,{filename:t.filename}));var a=e.getUrl(n,"download",{params:t.params});_.device("ios")?(a+=(-1===a.indexOf("?")?"?":"&")+"callback=antivirus",i.has("antivirus")&&(a+="&scan=true"),o.callback_antivirus=function(e){e.url=a,c(e),o.close()},o.location=a):l(a)})},exported:function(e){if(/^(VCARD|ICAL|CSV)$/i.test(e.format)){var t=_.extend({include:!0},e),i=!t.folder&&t.list;d({url:ox.apiRoot+"/export?action="+t.format.toUpperCase()+(i?"":"&folder="+t.folder)+"&export_dlists="+(t.include?"true":"false")+"&content_disposition=attachment"+(t.columns&&"CSV"===t.format.toUpperCase()?"&columns="+t.columns:"")+"&session="+ox.session,body:i?JSON.stringify(_.map(t.list,r)):""})}},files:function(e){d({url:ox.apiRoot+"/files?action=zipdocuments&callback=antivirus&session="+ox.session,body:JSON.stringify(_.map(e,r))})},pimAttachments:function(e,t){d({url:ox.apiRoot+"/attachment?action=zipDocuments&callback=antivirus&session="+ox.session+"&folder="+t.folder+"&attached="+t.attached+"&module="+t.module,body:s(e)})},mail:function(e){l(t.getUrl(e,"eml"))},composeAttachment:function(e){var t=e.space,i=e.id;l(ox.apiRoot+"/mail/compose/"+t+"/attachments/"+i+"?session="+ox.session)},mails:function(e){d({url:ox.apiRoot+"/mail?action=zip_messages&session="+ox.session,body:JSON.stringify(_.map(e,t.reduce))})}}}),define("io.ox/mail/main",["io.ox/mail/util","io.ox/mail/api","io.ox/mail/compose/api","io.ox/core/commons","io.ox/mail/listview","io.ox/core/tk/list-control","io.ox/mail/threadview","io.ox/core/extensions","io.ox/backbone/views/actions/util","io.ox/core/api/account","io.ox/core/notifications","io.ox/core/toolbars-mobile","io.ox/core/page-controller","io.ox/core/capabilities","io.ox/core/folder/tree","io.ox/core/folder/view","io.ox/core/folder/api","io.ox/backbone/mini-views/quota","io.ox/backbone/views/action-dropdown","io.ox/mail/categories/mediator","io.ox/core/api/account","gettext!io.ox/mail","settings!io.ox/mail","settings!io.ox/core","io.ox/core/api/certificate","io.ox/settings/security/certificates/settings/utils","io.ox/mail/actions","io.ox/mail/mobile-navbar-extensions","io.ox/mail/mobile-toolbar-actions","io.ox/mail/toolbar","io.ox/mail/import","less!io.ox/mail/style","io.ox/mail/folderview-extensions"],function(e,t,i,o,n,a,r,s,l,d,c,u,p,f,h,g,m,v,x,b,w,y,k,C,S,T){var D=ox.ui.createApp({name:"io.ox/mail",id:"io.ox/mail",title:"Mail"}),A=!1;return D.mediator({"pages-mobile":function(e){if(!_.device("!smartphone")){var t=e.getWindow(),i=$('<div class="mobile-navbar">'),o=$('<div class="mobile-toolbar">').on("hide",function(){t.nodes.body.removeClass("mobile-toolbar-visible")}).on("show",function(){t.nodes.body.addClass("mobile-toolbar-visible")}),n=s.Baton({app:e});e.navbar=i,e.toolbar=o,e.pages=new p({appname:e.options.name,toolbar:o,navbar:i,container:t.nodes.main}),t.nodes.body.addClass("classic-toolbar-visible").append(i,o),e.pages.addPage({name:"folderTree",navbar:new u.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"})}),e.pages.addPage({name:"listView",startPage:!0,navbar:new u.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"}),toolbar:new u.ToolbarView({baton:n,page:"listView",extension:"io.ox/mail/mobile/toolbar"}),secondaryToolbar:new u.ToolbarView({baton:n,page:"listView/multiselect",extension:"io.ox/mail/mobile/toolbar"})}),e.pages.addPage({name:"threadView",navbar:new u.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"}),toolbar:new u.ToolbarView({baton:n,page:"threadView",extension:"io.ox/mail/mobile/toolbar"})}),e.pages.addPage({name:"detailView",navbar:new u.NavbarView({baton:n,extension:"io.ox/mail/mobile/navbar"}),toolbar:new u.ToolbarView({baton:n,page:"detailView",extension:"io.ox/mail/mobile/toolbar"})}),e.pages.getPage("detailView").on("pagebeforehide",function(){$(this).find(".popover-open").popover("destroy")}),e.pages.setBackbuttonRules({listView:"folderTree",threadView:"listView"})}},"navbars-mobile":function(e){_.device("smartphone")&&(e.pages.getNavbar("listView").setLeft(y("Folders")).setRight(y("Edit")),e.pages.getNavbar("folderTree").setTitle(y("Folders")).setLeft(!1).setRight(y("Edit")),e.pages.getNavbar("detailView").setTitle("").setLeft(y("Back")),e.pages.getNavbar("threadView").setTitle(y("Thread")).setLeft(y("Back")),e.pages.showPage("listView"))},"toolbars-mobile":function(){_.device("smartphone")&&(D.pages.getNavbar("listView").on("leftAction",function(){D.pages.goBack()}),D.pages.getNavbar("threadView").on("leftAction",function(){D.pages.goBack(),D.listView.selection.selectNone()}),D.pages.getNavbar("detailView").on("leftAction",function(){D.pages.goBack(),D.listView.selection.selectNone()}),D.pages.getNavbar("listView").on("rightAction",function(){D.props.set("checkboxes",!D.props.get("checkboxes"))}))},"pages-desktop":function(e){_.device("smartphone")||(e.pages=new p(e),e.getWindow().nodes.main.addClass("vsplit"),e.pages.addPage({name:"listView",container:e.getWindow().nodes.main,classes:"leftside"}),e.pages.addPage({name:"detailView",container:e.getWindow().nodes.main,classes:"rightside"}))},"folder-view":function(e){_.device("smartphone")||(e.treeView=new h({app:e,module:"mail",contextmenu:!0}),g.initialize({app:e,tree:e.treeView}),e.folderView.resize.enable())},"folder-view-mobile":function(e){if(_.device("!smartphone"))return e;var t=e.pages.getNavbar("folderTree"),i=e.pages.getPage("folderTree");t.on("rightAction",function(){e.toggleFolders()});var o=new h({app:e,module:"mail",root:"1",contextmenu:!0});g.initialize({app:e,tree:o}),i.append(o.render().$el),e.treeView=o},"folder-view-ssl-events":function(e){!C.get("security/acceptUntrustedCertificates")&&C.get("security/manageCertificates")&&(e.treeView.on("accountlink:ssl",function(){ox.launch("io.ox/settings/main",{folder:"virtual/settings/io.ox/certificate"})}),e.treeView.on("accountlink:sslexamine",function(e){T.openExaminDialog(e)}))},"folder-view-account-ssl-error":function(e){function t(e,t){var i=[];return _.each(t,function(t){_(_.values(t)).contains(e)&&i.push(t)}),i}function i(i,o,n){w.all().done(function(a){var r=i?t(i,a):a;_.each(r,function(t){w.getStatus(t.id).done(function(i){var a=e.treeView.getNodeView(t.root_folder);if(a)if("invalid_ssl"===i[t.id].status){var r=o?"accountlink:sslexamine":"accountlink:ssl",s=o?n:a.options.model_id;a.showStatusIcon(i[t.id].message,r,s)}else a.hideStatusIcon(),a.render()})})})}ox.on("http:error SSL:remove",function(e){/^SSL/.test(e.code)&&S.get({fingerprint:e.error_params[0]}).done(function(t){_.isEmpty(t)?i(t.hostname,["accountlink:sslexamine"],e):i(t.hostname)})}),w.on("refresh:ssl",function(e,t){i(t)})},"mail-quota":function(e){if(!_.device("smartphone")){var i=new v({title:y("unified"===C.get("quotaMode","default")?"Quota":"Mail quota"),renderUnlimited:!1,upsell:{title:y("Need more space?"),requires:"active_sync || caldav || carddav",id:"mail-folderview-quota",icon:""},upsellLimit:5242880});m.on("cleared-trash",function(){i.getQuota(!0)}),t.on("deleted-mails-from-trash",function(){i.getQuota(!0)}),t.on("refresh.all",function(){i.getQuota(!0)}),e.treeView.$el.append(i.render().$el)}},"select-all-actions":function(){t.on("move deleted-mails archive",function(){D.listView.collection.length||D.listView.reload()})},props:function(e){e.props=new Backbone.Model({layout:function(){if(_.device("smartphone"))return"vertical";var t=e.settings.get("layout","vertical");return"compact"===t&&_.device("!desktop")&&(t="vertical"),t}(),checkboxes:!_.device("smartphone")&&e.settings.get("showCheckboxes",!1),contactPictures:!_.device("smartphone")&&e.settings.get("showContactPictures",!1),textPreview:e.settings.get("showTextPreview",!0),exactDates:e.settings.get("showExactDates",!1),alwaysShowSize:e.settings.get("alwaysShowSize",!1),categories:e.settings.get("categories/enabled",!1),category_id:b.getInitialCategoryId(),mobileFolderSelectMode:!1})},"toggle-folder-editmode":function(e){if(!_.device("!smartphone")){e.toggleFolders=function(){var t=e.pages.getPage("folderTree"),i=e.props.get("mobileFolderSelectMode"),o=y(i?"Edit":"Cancel");e.props.set("mobileFolderSelectMode",!i),e.pages.getNavbar("folderTree").setRight(o),t.toggleClass("mobile-edit-mode",!i)}}},"all-unseen":function(e){function i(){t.getAllUnseenMessages().done(function(e){var t=_(e).chain().filter(function(e){return e.id=e.original_id,e.folder_id=e.original_folder_id,!w.is("spam|confirmed_spam|trash",e.folder_id)}).pluck("folder_id").uniq().value();m.multiple(t)})}function o(){i(),ox.on("refresh^",i)}var n=t.collectionLoader,a=n.getQueryParams({folder:"virtual/all-unseen"}),r=n.getCollection(a);r.gc=!1,r.preserve=!0,r.CUSTOM_PAGE_SIZE=250,r.on("load reload",function(){this.setComplete(!0)});var s=m.pool.getModel("virtual/all-unseen");t.on("all-unseen",function(e,t){s.set("unread",t)}),k.get("features/unseenFolder")&&(k.get("unseenMessagesFolder")?o():k.once("change:features/unseenFolder",o)),e.folderView.tree.selection.addSelectableVirtualFolder("virtual/all-unseen")},"unselectable-folders":function(){if(w.cache[0]){var e=w.cache[0].root_folder+"/Shared";D.folderView.tree.selection.addUnselectableFolder(e)}},vsplit:function(e){var t=e.pages.getPage("listView"),i=e.pages.getPage("detailView");e.left=t.toggleClass("border-right",_.device("!smartphone")),e.right=i.addClass("mail-detail-pane")},"list-view":function(e){e.listView=new n({swipe:!0,app:e,draggable:!0,ignoreFocus:!0,selectionOptions:{mode:"special"}}),e.listView.model.set({folder:e.folder.get(),thread:e.settings.get("threadSupport",!0)}),window.list=e.listView},"list-view-checkboxes":function(e){_.device("smartphone")||e.listView.toggleCheckboxes(e.props.get("checkboxes"))},"list-view-checkboxes-mobile":function(e){_.device("smartphone")&&(e.props.set("checkboxes",!1),e.listView.toggleCheckboxes(!1))},"react to markunread":function(){t.on("after:refresh.unseen",function(e,i){1===i.length&&(t.setToUnread=i[0].cid)}),D.listView.on("selection:multiple selection:one",function(){delete t.setToUnread}),D.listView.on("selection:action",function(){"list"!==D.props.get("layout")&&delete t.setToUnread})},"auto-scroll":function(t){t.listView.on("add",function(i,o){if(0===o&&e.isUnseen(i.toJSON())){var n=t.listView.$el.height()/2;t.listView.$el.scrollTop()>n||t.listView.$el.scrollTop(0)}})},"get-view-options":function(e){e.getViewOptions=function(t){var i=e.settings.get(["viewOptions",t],{});return e.settings.get("threadSupport",!0)||(i.thread=!1),(!k.get("features/flag/color")&&102===i.sort||!k.get("features/flag/star")&&660===i.sort||602===i.sort&&!m.pool.getModel(t).supports("ATTACHMENT_MARKER"))&&delete i.sort,_.extend({sort:610,order:"desc",thread:!1},i)}},"prop-folderview":function(e){e.props.set("folderview",!_.device("smartphone")&&e.settings.get("folderview/visible/"+_.display(),!0))},"change:sort":function(e){e.props.on("change:sort",function(t,i){t=e.listView.model,"from-to"===i&&(i=d.is("sent|drafts",t.get("folder"))?604:603),e.changingFolders||(t.set("order",/^(610|608|102|660|651)$/.test(i)?"desc":"asc",{silent:!0}),e.props.set("order",t.get("order"))),t.set({sort:i})})},"change:order":function(e){e.props.on("change:order",function(t,i){e.listView.model.set("order",i)})},"change:thread":function(e){e.props.on("change:thread",function(t,i){if(!e.changingFolders&&e.listView.collection){var o=e.listView.collection;_.defer(function(){o.reset(),o.setComplete(!1)})}e.listView.model.set("thread",!!i)})},isThreaded:function(e){e.isThreaded=function(){return"search"!==e.listView.loader.mode&&e.props.get("thread")}},getContextualData:function(e){e.getContextualData=function(i){var o=e.isThreaded(),n=t.resolve(i,o);return{app:e,data:n,folder_id:e.folder.get(),isThread:o}}},"store-view-options":function(e){e.props.on("change",_.debounce(function(){if(!e.props.get("find-result")){var t=e.folder.get(),i=e.props.toJSON();e.settings.set(["viewOptions",t],{sort:i.sort,order:i.order,thread:i.thread}).set("showTextPreview",i.textPreview).set("showExactDates",i.exactDates).set("alwaysShowSize",i.alwaysShowSize).set("categories/enabled",i.categories),_.device("!smartphone")&&e.settings.set("layout",i.layout).set("showCheckboxes",i.checkboxes).set("showContactPictures",i.contactPictures),e.settings.save()}},500))},"restore-view-options":function(e){var t=e.getViewOptions(e.folder.get());e.changingFolders=!0,e.props.set(t),e.changingFolders=!1},"list-view-control":function(e){e.listControl=new a({id:"io.ox/mail",listView:e.listView,app:e}),e.left.append(e.listControl.render().$el.attr("aria-label",y("Messages")).find(".toolbar").attr("aria-label",y("Messages options")).end()),_.device("smartphone")&&(e.listControl.$(".toolbar.bottom").hide(),e.listControl.$(".toolbar.top").removeClass("top").addClass("bottom"),e.listControl.$el.removeClass("toolbar-top-visible")),e.listControl.resizable()},textPreview:function(e){var t=k.get("features/textPreview",!0);e.supportsTextPreview=function(){return t},e.supportsTextPreviewConfiguration=function(){var i=e.folder.get();return t&&(d.isPrimary(i)||"virtual/all-unseen"===i)},e.useTextPreview=function(){return e.supportsTextPreviewConfiguration()&&e.props.get("textPreview")},e.on("resume",function(){this.listView.fetchTextPreview()})},"thread-view":function(e){_.device("smartphone")||(e.threadView=new r.Desktop({app:e}),e.right.append(e.threadView.render().$el))},"thread-view-mobile":function(e){_.device("smartphone")&&(e.threadView=new r.Mobile,e.threadView.$el.on("showmail",function(t){var i=$(t.target).data().cid;e.showMail(i),e.pages.changePage("detailView")}),e.pages.getPage("threadView").append(e.threadView.render().$el))},"selection-message":function(e){e.right.append($('<div class="io-ox-center multi-selection-message"><div class="message"></div></div>'))},navigation:function(e){e.threadView.on({back:function(){e.right.removeClass("preview-visible"),e.listView.focus()},previous:function(){e.listView.previous()},next:function(){e.listView.next()}})},position:function(e){function t(){var t=e.listView;e.threadView.updatePosition(t.getPosition()+1).togglePrevious(t.hasPrevious()).toggleNext(t.hasNext())}e.listView.on("selection:action",t),t()},"folder:change":function(e){e.folderView.tree.on("selection:action",function(){"list"===e.props.get("layout")&&e.right.hasClass("preview-visible")&&e.threadView.trigger("back")}),e.on("folder:change",function(t){if(!e.props.get("mobileFolderSelectMode")){e.changingFolders=!0;var i=e.getViewOptions(t);e.props.set(_.pick(i,"sort","order","thread")),"from-to"===i.sort&&e.listView.model.set("sort",d.is("sent|drafts",t)?604:603),e.listView.model.set("folder",t),e.folder.getData(),e.changingFolders=!1}})},"auto-subscribe":function(e){function t(t){"mail"===t.module&&(t.subscribed?e.folderView.tree.select(t.id):m.update(t.id,{subscribed:!0},{silent:!0}).done(function(){m.refresh().done(function(){e.folderView.tree.select(t.id)})}))}e.folder.getData().done(t),e.on("folder:change",function(e,i){t(i)})},"folder:change-mobile":function(e){_.device("smartphone")&&e.on("folder:change",function(){e.props.get("mobileFolderSelectMode")||e.folder.getData().done(function(t){e.pages.getNavbar("listView").setTitle(t.title)})})},"show-mail":function(e){function i(){if(e.listView.collection.get(a)&&(e.threadView.autoSelect=e.autoSelect,delete e.autoSelect,e.threadView.show(a,e.isThreaded()),A||"list"===e.props.get("layout"))){A=!1;var t=e.threadView.$(".list-item"),i=t.index(t.filter(".expanded"));t.filter(".expanded:first").find(".body").visibleFocus(),0===i&&e.threadView.$(".scrollable").scrollTop(0)}}if(!_.device("smartphone")){var o,n,a,r=0;e.recentDelete=function(){return r>0},e.showMail=function(t){if(a=t,!r)return i();if(e.threadView.model&&e.threadView.model.cid===t)return i();e.threadView.empty(),clearTimeout(n);var o=1e3*(r-1);n=setTimeout(i,o)},t.on("beforedelete",function(){r<2&&r++,clearTimeout(o),o=setTimeout(function(){r=0},4e3)})}},"show-mail-mobile":function(e){_.device("smartphone")&&(e.showMail=function(t){e.pages.getPage("detailView").empty().append(e.threadView.renderMail(t))})},"mobile-show-thread-overview":function(e){e.showThreadOverview=function(t){e.threadView.show(t,e.isThreaded())}},"show-empty":function(e){e.showEmpty=function(){e.threadView.empty(),e.right.find(".multi-selection-message .message").empty().append(y("No message selected")).attr("id","mail-multi-selection-message")}},"show-multiple":function(e){_.device("smartphone")||(e.showMultiple=function(i){e.threadView.empty(),i=t.resolve(i,e.isThreaded());var o=e.folder.get(),n=m.pool.getModel(o).get("total"),a=e.get("find")&&e.get("find").isActive();_.defer(function(){var t=$('<span class="number">').text(i.length).prop("outerHTML");e.right.find(".multi-selection-message .message").empty().attr("id","mail-multi-selection-message").append($("<div>").append(y.format(y.ngettext("%1$d message selected","%1$d messages selected",t,t))),o&&n>i.length&&!a?$('<div class="inline-actions selection-message">').append(y("There are %1$d messages in this folder; not all messages are displayed in the list currently.",n)).hide():$())})},e.showSelectionMessage=function(){_.defer(function(){e.right.find(".selection-message").show()})})},"show-multiple-mobile":function(e){_.device("!smartphone")||(e.showMultiple=function(i){e.threadView.empty(),i?(i=t.resolve(i,e.isThreaded()),e.pages.getCurrentPage().navbar.setTitle(y("%1$d selected",i.length)),e.pages.getCurrentPage().secondaryToolbar.render()):e.folder.getData().done(function(t){e.pages.getCurrentPage().navbar.setTitle(t.title)})})},"page-change-detail-view-mobile":function(){D.pages.getPage("detailView").on("header_ready",function(){D.pages.changePage("detailView")})},"selection-mobile":function(e){_.device("smartphone")&&e.listView.on({"selection:empty":function(){e.props.get("checkboxes")&&e.showMultiple(!1)},"selection:one":function(t){e.props.get("checkboxes")&&e.showMultiple(t)},"selection:multiple":function(t){e.props.get("checkboxes")&&e.showMultiple(t)},"selection:action":function(t){var i=_.contains(d.getFoldersByType("drafts"),this.model.get("folder"));if(1===e.listView.selection.get().length&&!e.props.get("checkboxes")){var o=t[0],n=this.collection.get(o).get("threadSize")>1;if(i){var a=_.cid(o);ox.registry.call("mail-compose","open",{type:"copy",original:{folderId:a.folder_id,id:a.id}})}else n?(e.showThreadOverview(o),e.pages.changePage("threadView")):e.showMail(o)}}})},selection:function(e){function t(t){return e.right.removeClass("selection-empty selection-one selection-multiple preview-visible".replace(t,"")).addClass(t)}function i(t){return e.left.removeClass("selection-empty selection-one selection-multiple".replace(t,"")).addClass(t)}if(!_.device("smartphone")){var o=_.debounce(function(o,n){if("list"===e.props.get("layout")&&"action"===o)return t("selection-one preview-visible"),i("selection-one"),void e.showMail(n[0]);if("list"===e.props.get("layout")&&"one"===o)return t("selection-one"),void i("selection-one");switch(o){case"empty":t("selection-empty"),i("selection-empty"),e.showEmpty();break;case"one":case"action":t("selection-one"),i("selection-one"),e.showMail(n[0]);break;case"multiple":t("selection-multiple"),i("selection-multiple"),e.showMultiple(n)}},1);e.listView.on({"selection:empty":function(){e.right.find(".multi-selection-message div").attr("id",null),o("empty")},"selection:one":function(t){e.right.find(".multi-selection-message div").attr("id",null);var i="one";"alternative"===e.listView.selection.getBehavior()&&(i="multiple"),o(i,t)},"selection:multiple":function(o){e.right.find(".multi-selection-message div").attr("id",null),t("selection-multiple"),i("selection-multiple"),e.showMultiple(o)},"selection:action":function(t){e.right.find(".multi-selection-message div").attr("id",null),1===e.listView.selection.get().length&&o("action",t)},"selection:showHint":function(){e.showSelectionMessage()}})}},"preserve-selection":function(e){_.device("smartphone")||e.listView.on({"selection:add":function(i){651===e.props.get("sort")&&_(i).each(function(e){t.pool.preserveModel(e,!0)})},"selection:remove":function(e){_(e).each(function(e){t.pool.preserveModel(e,!1)})}})},"change:layout":function(e){e.props.on("change:layout",function(t,i){e.threadView.toggleNavigation("list"===i),ox.ui.apps.trigger("layout",e)}),e.threadView.toggleNavigation("list"===e.props.get("layout"))},"apply-layout":function(e){_.device("smartphone")||(e.applyLayout=function(){var t,i,o,n=e.props.get("layout"),a=e.getWindow().nodes,r=e.settings.get("listview/width/"+_.display()),s=e.settings.get("listview/height/"+_.display());e.left.css({width:"",height:""}),e.right.css({left:"",top:""}),"vertical"===n||"compact"===n?(a.main.addClass("preview-right").removeClass("preview-bottom preview-none"),_.device("touch")||function(t){var i=void 0===t?"":t+"px";e.right.css("left",i),e.left.css("width",i)}(r)):"horizontal"===n?(a.main.addClass("preview-bottom").removeClass("preview-right preview-none"),_.device("touch")||function(t){var i=void 0===t?"":t+"px";e.right.css("top",i),e.left.css("height",i)}(s)):"list"===n&&a.main.addClass("preview-none").removeClass("preview-right preview-bottom"),t=a.body.find(".classic-toolbar-container"),i=a.body.find(".categories-toolbar-container"),o="classic-toolbar-visible","compact"===n?(a.body.removeClass(o),e.right.addClass(o).prepend(t),i.length>0&&e.right.prepend(i)):(e.right.removeClass(o),a.body.addClass(o).prepend(t),i.length>0&&a.body.prepend(i)),"list"===n||"list"!==e.props.previousAttributes().layout||e.right.hasClass("preview-visible")||e.listView.selection.get().length>0&&e.listView.selection.selectEvents(e.listView.selection.getItems()),this.listControl.applySizeConstraints()},e.props.on("change:layout",function(){var t=e.getWindow().nodes.body,i=t.find('*[data-dropdown="view"] a:first').is(":focus");e.applyLayout(),e.listView.redraw(),i&&t.find('*[data-dropdown="view"] a:first').focus()}),e.getWindow().on("show:initial",function(){e.applyLayout()}))},refresh:function(e){t.on("refresh.all",function(){e.listView.reload()})},reloadOnFolderChange:function(e){t.on("changesAfterReloading",function(){e.listView.reload()})},"auto-select":function(t){if(k.get("autoselectMailOnStart",!0)&&!_.device("smartphone")){var i=function(){t.listView.collection.find(function(i,o){if(!e.isUnseen(i.get("flags")))return t.autoSelect=!0,t.listView.selection.select(o,!1,!1),t.listView.selection.getItems().eq(o).attr("tabindex","0").intoViewport(),!0})};t.listView.on("first-reset",function(){"list"!==t.props.get("layout")?_.defer(i):t.props.once("change:layout",function(){t.listView.selection.get().length||_.defer(i)})})}},"init-navbarlabel-mobile":function(e){_.device("smartphone")&&e.listView.on("first-reset",function(){e.folder.getData().done(function(t){e.pages.getNavbar("listView").setTitle(t.title)})})},prefetch:function(i){var o=k.get("prefetch/count",5);!_.isNumber(o)||o<=0||(i.prefetch=function(i){var n=require("io.ox/core/http");n.pause(),i.chain().filter(function(t){return!e.isDeleted(t)}).slice(0,o).each(function(i){var o,n,a=i.get("thread")||[i.toJSON()];for(o=a.length-1;n=a[o];o--)if(_.isString(n)&&(n=_.cid(n)),(0===o||e.isUnseen(n))&&!e.isDeleted(n)){t.get({folder:n.folder_id,id:n.id,unseen:!0});break}}),n.resume()},i.listView.on("first-reset",i.prefetch))},"prefetch-message":function(e){_.device("smartphone")||k.get("prefetch/next",!0)&&e.listView.on("selection:one",function(){if(!e.recentDelete()){var i,o=this.selection.getItems(),n=this.selection.getPosition(o),a=this.selection.getDirection(),r=o.length-1;"down"===a&&n<r?i=o.eq(n+1):"up"===a&&n>0&&(i=o.eq(n-1)),i&&((i=_.cid(i.attr("data-cid"))).unseen=!0,t.get(i))}})},"prefetch-compose":function(){_.device("smartphone")||setTimeout(function(){require(["io.ox/mail/compose/main","io.ox/mail/compose/bundle"],function(){require(["io.ox/core/api/snippets"],function(e){e.getAll()})})},3e3)},"connect-loader":function(e){e.listView.connect(t.collectionLoader)},"before-delete":function(e){function i(e,t){return 1===e.length&&(1===t.length&&_.cid(e[0])!==String(t[0]).replace(/^thread\./,""))}_.device("smartphone")||k.get("features/selectBeforeDelete",!0)&&t.on("beforedelete beforeexpunge",function(o,n){var a=e.listView.selection.get();if(!i(n,a)&&(n.length>0&&!_.isString(n[0])&&(n=_(n).map(_.cid)),_.intersection(n,a).length)){if(e.listView.selection.dodge(),e.isThreaded()&&t.one("deleted-mails",function(){e.listView.reload()}),1===n.length)return;e.listView.onBatchRemove(n.slice(1))}})},"before-delete-mobile":function(e){_.device("smartphone")&&t.on("beforedelete",function(){"detailView"===e.pages.getCurrentPage().name&&(e.isThreaded()&&1===e.threadView.collection.length?e.pages.changePage("listView",{animation:"slideright"}):e.pages.goBack()),e.listView.selection.selectNone()})},"drag-drop":function(){D.getWindow().nodes.outer.on("selection:drop",function(e,t){var i=s.Baton(D.getContextualData(t.data));i.target=t.target,l.invoke("io.ox/mail/actions/move",i)})},"selection-archive":function(){D.listView.on("selection:archive",function(e){var t=s.Baton(D.getContextualData(e));l.invoke("io.ox/mail/actions/archive",t)})},"selection-delete":function(){D.listView.on("selection:delete",function(e,t){var i=s.Baton(D.getContextualData(e));i.options.shiftDelete=t,l.invoke("io.ox/mail/actions/delete",i)})},"selection-doubleclick":function(e){_.device("smartphone")||e.listView.on("selection:doubleclick",function(i){e.isThreaded()&&(i=_(t.threads.get(i[0])).pluck("cid"));var o=i[0],n=_.cid(o);d.is("drafts",n.folder_id)?t.get(n).then(function(e){l.invoke("io.ox/mail/actions/edit",e)}):ox.launch("io.ox/mail/detail/main",{cid:o})})},"selection-mobile-swipe":function(e){_.device("!smartphone")||(s.point("io.ox/mail/mobile/swipeButtonMore").extend({draw:function(t){new x({el:this,point:"io.ox/mail/links/inline"}).setSelection(t.array(),{data:t.array(),app:e,isThread:t.isThread})}}),e.listView.on("selection:more",function(i,o){var n=s.Baton({data:i});n.isThread=1===n.data.length&&/^thread\./.test(n.data[0]),n.data=t.resolve(n.data,e.isThreaded()),s.point("io.ox/mail/mobile/swipeButtonMore").invoke("draw",o,n),o.find("a.dropdown-toggle").click()}))},"change:folderview":function(e){_.device("smartphone")||(e.props.on("change:folderview",function(t,i){e.folderView.toggle(i)}),e.on("folderview:close",function(){e.props.set("folderview",!1)}),e.on("folderview:open",function(){e.props.set("folderview",!0)}))},"change:checkboxes":function(e){_.device("smartphone")||("alternative"===e.listView.selection.getBehavior()?e.listView.toggleCheckboxes(!0):e.props.on("change:checkboxes",function(t,i){e.listView.toggleCheckboxes(i)}))},"change:checkboxes-mobile":function(e){_.device("!smartphone")||(e.listControl.$el.toggleClass("toolbar-bottom-visible",!1),e.props.on("change:checkboxes",function(t,i){e.listView.toggleCheckboxes(i),e.listControl.$el.toggleClass("toolbar-bottom-visible",i),i?e.pages.getNavbar("listView").setRight(y("Cancel")).hide(".left"):(e.pages.getNavbar("listView").setRight(y("Edit")).show(".left"),e.folder.getData().done(function(t){e.pages.getCurrentPage().navbar.setTitle(t.title)}),e.listView.selection.selectNone())}))},"change:viewOptions":function(e){function t(){e.listView.$el.toggleClass("show-contact-pictures",e.props.get("contactPictures")).toggleClass("show-text-preview",e.useTextPreview())}e.props.on("change:contactPictures change:exactDates change:alwaysShowSize change:textPreview",function(){e.listView.redraw(),e.listView.$el.trigger("scroll"),t()}),e.on("folder:change",t),t()},"fix-mobile-lazyload":function(e){_.device("!smartphone")||e.pages.getPage("detailView").on("pageshow",function(){$(this).scrollTop(0),$(this).find("li.lazy").trigger("scroll")})},"inplace-find":function(e){function i(e,i){i.on("collectionLoader:created",function(e){e.each=function(e){t.pool.add("detail",e)}})}if(!_.device("smartphone")&&f.has("search")&&e.isFindSupported())return e.initFind(),e.get("find")?i(0,e.get("find")):e.once("change:find",i)},"on:pull-to-refresh":function(e){_.device("!touch")||e.on("pull-to-refresh",function(){t.refresh().always(function(){e.listView.removePullToRefreshIndicator()})})},"contextual-help":function(e){e.getContextualHelp=function(){return"ox.appsuite.user.sect.email.gui.html"}},a11y:function(e){e.listView.$el.attr("aria-label",y("List view")),e.listView.$el.on("keydown",".list-item",function(t){if(13!==t.which)return 27===t.which?(e.folderView.tree.$(".folder.selected").focus(),!1):void 0;A=!0}),e.threadView.$el.on("keydown",function(t){27===t.which&&($(t.target).is(".dropdown-toggle, :input")||(e.right.removeClass("preview-visible"),e.listView.restoreFocus(!0)))}),e.folderView.tree.$el.on("keydown",".folder",function(t){$(t.target).hasClass("folder")&&13===t.which&&e.listView.restoreFocus(!0)})},"auto-expunge":function(e){function i(e){return 2==(2&e.get("flags"))}k.get("features/autoExpunge",!1)&&e.listView.on("collection:load collection:paginate collection:reload",function(){this.collection.any(i)&&t.expunge(e.folder.get())})},"folder-errors":function(e){m.on("error:MSG-0092",function(e){c.yell(e)}),e.folder.handleErrors()},"save-draft":function(e){i.on("before:send before:save",function(e,i){var o=i.meta.editFor;if(o){var n=_.cid({id:o.originalId,folder_id:o.originalFolderId}),a=d.getFoldersByType("drafts");_(a).each(function(e){_(t.pool.getByFolder(e)).each(function(e){e.remove(n)})})}}),i.on("after:send after:save",function(){var t=e.folder.get();d.is("drafts",t)&&e.listView.reload()})},"mail-progress":function(){_.device("smartphone")||s.point("io.ox/mail/sidepanel").extend({id:"progress",index:300,draw:function(){var e=$('<div class="generic-toolbar bottom mail-progress">').hide().append($('<div class="progress">').append($('<div class="progress-bar">')),$('<div class="caption">').append($("<span>"),$('<a href="#" class="close" data-action="close" role="button">').attr("aria-label",y("Close")).append($('<i class="fa fa-times" aria-hidden="true">').attr("title",y("Close")))));i.queue.collection.on("progress",function(t){if(!t.count)return _.device("safari")&&(e.closest(".window-sidepanel").find(".folder-tree")[0].scrollTop+=1),e.hide();var i=t.count,o=Math.round(100*t.pct),n=y.ngettext("Sending 1 message ... %2$d%","Sending %1$d messages ... %2$d%",i,i,o);e.find(".progress-bar").css("width",o+"%"),e.find(".caption span").text(n),e.find('[data-action="close"]').off().on("click",function(e){e.preventDefault(),t.abort()}).toggle(t.pct<1),e.show()}),this.append(e)}})},"refresh-folders":function(){function e(e,i){if(i.error)return $.Deferred().reject(i).promise();if(i.data){var o=_(i.data.toString().split(t.separator)),n=o.last(),a=o.without(n).join(t.separator);$.when(w.getUnifiedMailboxName(),w.getPrimaryAddress()).done(function(t,i){var o=!1;_.chain(_.union(e.to,e.cc,e.bcc)).each(function(e){e[1]!==i[1]||(o=!0)}),setTimeout(function(){null!==t?m.refresh():o?m.reload(a,w.getInbox()):m.reload(a)},5e3)})}}var o=_.throttle(function(){var e=_(["inbox","sent","drafts"]).chain().map(function(e){var i=w.getFoldersByType(e);return t.pool.resetFolder(i),i}).flatten().value();m.multiple(e,{cache:!1}),t.trigger("refresh.all")},5e3,{leading:!1});i.on("after:save after:send",function(t,i){o(),e(t,i)})},sidepanel:function(e){if(!_.device("smartphone")){s.point("io.ox/mail/sidepanel").extend({id:"tree",index:100,draw:function(e){this.addClass("border-right").append(e.app.treeView.$el)}});var t=e.getWindow().nodes.sidepanel;s.point("io.ox/mail/sidepanel").invoke("draw",t,s.Baton({app:e}))}},metrics:function(e){require(["io.ox/metrics/main"],function(t){function i(e,i){var o=!!(i=$(i)).attr("data-name");t.trackEvent({app:"mail",target:e,type:"click",action:o?i.attr("data-name"):i.attr("data-action"),detail:o?i.attr("data-value"):""})}if(t.isEnabled()){var o=e.getWindow().nodes,n=o.outer,a=o.sidepanel;t.watch({node:n,selector:'[data-action="add-mail-account"]',type:"click"},{app:"mail",target:"folder/account",type:"click",action:"add"}),o.body.on("mousedown",".categories-toolbar-container .category",function(e){t.trackEvent({app:"mail",target:"toolbar",type:"click",action:"select-tab",detail:$(e.currentTarget).attr("data-id")})}),o.body.on("track",".classic-toolbar-container",function(e,t){i("toolbar",t)}),o.body.on("track",".thread-view-control",function(e,t){i("detail/toolbar",t)}),o.main.find(".list-view-control .toolbar").on("mousedown","a[data-name], a[data-action]",function(e){i("list/toolbar",e.currentTarget)}),_.defer(function(){a.find(".context-dropdown").on("mousedown","a",function(e){t.trackEvent({app:"mail",target:"folder/context-menu",type:"click",action:$(e.currentTarget).attr("data-action")})})}),a.find(".bottom").on("mousedown","a[data-action]",function(e){$(e.currentTarget).attr("data-action")&&t.trackEvent({app:"mail",target:"folder/toolbar",type:"click",action:$(e.currentTarget).attr("data-action")})}),e.getWindow().nodes.outer.on("selection:drop",function(e,i){t.trackEvent({app:"mail",target:"folder",type:"click",action:"drop",detail:i.data.length?"single":"multiple"})}),e.on("folder:change folder-virtual:change",function(e,i){i=i||{},t.getFolderFlags(e).then(function(e){m.is("unifiedfolder",i)&&e.unshift("unfified"),e.unshift(m.is("external",i)?"external":"primary"),t.trackEvent({app:"mail",target:"folder",type:"click",action:"select",detail:e.join("/")})})}),e.listView.on({"selection:multiple selection:one":_.throttle(function(i){t.trackEvent({app:"mail",target:"list/"+e.props.get("layout"),type:"click",action:"select",detail:i.length>1?"multiple":"one"})},100,{trailing:!1})})}})},"unified-folder-support":function(){d.getUnifiedMailboxName().done(function(i){if(i){var o=function(e){var o=t.getAccountIDFromFolder(e.get("folder_id")),n={7:"INBOX",9:"Drafts",10:"Sent",11:"Spam",12:"Trash"};return d.get(o).then(function(t){var o,a,r,s;if(t){if(t.unified_inbox_enabled){o=m.pool.models[e.get("folder_id")];var l=n[o.get("standard_folder_type")];if(l)return r=i+"/"+l,s=r+"/"+o.get("id"),[{folder_id:r,id:e.get("folder_id")+"/"+e.get("id")},{folder_id:s,id:e.get("id")}]}}else{if((o=m.pool.models[e.get("folder_id")])&&o.is("unifiedfolder")){a=e.get("original_folder_id"),s=e.get("folder_id")+"/"+a;var d=e.get("original_id");return[{folder_id:a,id:d},{folder_id:s,id:d}]}if((o=m.pool.models[o.get("folder_id")])&&o.is("unifiedfolder"))return r=o.id,a=e.get("folder_id").replace(o.id+"/",""),[{folder_id:r,id:a+"/"+e.get("id")},{folder_id:a,id:e.get("id")}]}return $.Deferred().reject()})};t.pool.get("detail").on("change:flags",function(i,n,a){if(a=a||{},i&&!a.unifiedSync){var r=e.isUnseen(i.previous("flags")),s=e.isUnseen(i.get("flags"));r!==s&&o(i).done(function(e){_(e).each(function(e){var i=t.pool.get("detail").get(_.cid(e));if(i){var o={flags:s?-33&i.get("flags"):32|i.get("flags")};s||(o.unseen=!1),i.set(o,{unifiedSync:!0}),t.threads.touch(i.attributes),t.trigger("update:"+_.ecid(i.attributes),i.attributes)}else m.changeUnseenCounter(e.folder_id,s?1:-1);t.pool.resetFolder(e.folder_id)})})}}),t.pool.get("detail").on("remove",function(i){if(i){var n=e.isUnseen(i.get("flags"));o(i).done(function(e){_(e).each(function(e){n&&m.changeUnseenCounter(e.folder_id,-1),t.pool.resetFolder(e.folder_id)})})}})}})},sockets:function(e){ox.on("socket:mail:new",function(i){m.reload(i.folder),i.folder!==e.folder.get(i.folder)?_(t.pool.getByFolder(i.folder)).invoke("expire"):e.listView.reload()})},"vacation-notice":function(e){f.has("mailfilter_v2")&&require(["io.ox/mail/mailfilter/vacationnotice/indicator"],function(t){(new t).attachTo(e.listControl.$el)})},"autoforward-notice":function(e){f.has("mailfilter_v2")&&require(["io.ox/mail/mailfilter/autoforward/indicator"],function(t){(new t).attachTo(e.listControl.$el)})}}),D.setLauncher(function(){var e=ox.ui.createWindow({name:"io.ox/mail",title:"Inbox",chromeless:!0,find:f.has("search")});_.url.hash("mailto")&&ox.registry.call("mail-compose","open"),D.setWindow(e),D.settings=k,window.mailapp=D,o.addFolderSupport(D,null,"mail",D.options.folder).always(function(){D.mediate(),e.show()}).fail(function(e){var i=k.get("folder/inbox")&&e&&e.error?e.error+" "+y("Application may not work as expected until this problem is solved."):t.mailServerDownMessage;c.yell("error",i)})}),D.setResume(function(e){if(e&&e.folder&&e.folder!==this.folder.get()){var t=this.getWindow();return t.busy(),this.folder.set(e.folder).always(function(){t.idle()})}return $.when()}),{getApp:D.getInstance}})})});